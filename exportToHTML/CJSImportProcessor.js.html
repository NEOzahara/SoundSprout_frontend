<html>
<head>
<title>CJSImportProcessor.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #cf8e6d;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
.s7 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
CJSImportProcessor.js</font>
</center></td></tr></table>
<pre>


<span class="s1">import </span><span class="s2">{</span><span class="s0">isDeclaration</span><span class="s2">} </span><span class="s0">from </span><span class="s3">&quot;./parser/tokenizer&quot;</span><span class="s2">;</span>
<span class="s1">import </span><span class="s2">{</span><span class="s0">ContextualKeyword</span><span class="s2">} </span><span class="s0">from </span><span class="s3">&quot;./parser/tokenizer/keywords&quot;</span><span class="s2">;</span>
<span class="s1">import </span><span class="s2">{</span><span class="s0">TokenType </span><span class="s2">as </span><span class="s0">tt</span><span class="s2">} </span><span class="s0">from </span><span class="s3">&quot;./parser/tokenizer/types&quot;</span><span class="s2">;</span>

<span class="s1">import </span><span class="s0">getImportExportSpecifierInfo from </span><span class="s3">&quot;./util/getImportExportSpecifierInfo&quot;</span><span class="s2">;</span>
<span class="s1">import </span><span class="s2">{</span><span class="s0">getNonTypeIdentifiers</span><span class="s2">} </span><span class="s0">from </span><span class="s3">&quot;./util/getNonTypeIdentifiers&quot;</span><span class="s2">;</span>
















<span class="s4">/**</span>
 <span class="s4">* Class responsible for preprocessing and bookkeeping import and export declarations within the</span>
 <span class="s4">* file.</span>
 <span class="s4">*</span>
 <span class="s4">* TypeScript uses a simpler mechanism that does not use functions like interopRequireDefault and</span>
 <span class="s4">* interopRequireWildcard, so we also allow that mode for compatibility.</span>
 <span class="s4">*/</span>
<span class="s1">export default class </span><span class="s0">CJSImportProcessor </span><span class="s2">{</span>
   <span class="s0">__init</span><span class="s2">() {</span><span class="s1">this</span><span class="s2">.</span><span class="s0">nonTypeIdentifiers </span><span class="s2">= </span><span class="s1">new </span><span class="s0">Set</span><span class="s2">()}</span>
   <span class="s0">__init2</span><span class="s2">() {</span><span class="s1">this</span><span class="s2">.</span><span class="s0">importInfoByPath </span><span class="s2">= </span><span class="s1">new </span><span class="s0">Map</span><span class="s2">()}</span>
   <span class="s0">__init3</span><span class="s2">() {</span><span class="s1">this</span><span class="s2">.</span><span class="s0">importsToReplace </span><span class="s2">= </span><span class="s1">new </span><span class="s0">Map</span><span class="s2">()}</span>
   <span class="s0">__init4</span><span class="s2">() {</span><span class="s1">this</span><span class="s2">.</span><span class="s0">identifierReplacements </span><span class="s2">= </span><span class="s1">new </span><span class="s0">Map</span><span class="s2">()}</span>
   <span class="s0">__init5</span><span class="s2">() {</span><span class="s1">this</span><span class="s2">.</span><span class="s0">exportBindingsByLocalName </span><span class="s2">= </span><span class="s1">new </span><span class="s0">Map</span><span class="s2">()}</span>

  <span class="s0">constructor</span><span class="s2">(</span>
     <span class="s0">nameManager</span><span class="s2">,</span>
     <span class="s0">tokens</span><span class="s2">,</span>
     <span class="s0">enableLegacyTypeScriptModuleInterop</span><span class="s2">,</span>
     <span class="s0">options</span><span class="s2">,</span>
     <span class="s0">isTypeScriptTransformEnabled</span><span class="s2">,</span>
     <span class="s0">keepUnusedImports</span><span class="s2">,</span>
     <span class="s0">helperManager</span><span class="s2">,</span>
  <span class="s2">) {;</span><span class="s1">this</span><span class="s2">.</span><span class="s0">nameManager </span><span class="s2">= </span><span class="s0">nameManager</span><span class="s2">;</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens </span><span class="s2">= </span><span class="s0">tokens</span><span class="s2">;</span><span class="s1">this</span><span class="s2">.</span><span class="s0">enableLegacyTypeScriptModuleInterop </span><span class="s2">= </span><span class="s0">enableLegacyTypeScriptModuleInterop</span><span class="s2">;</span><span class="s1">this</span><span class="s2">.</span><span class="s0">options </span><span class="s2">= </span><span class="s0">options</span><span class="s2">;</span><span class="s1">this</span><span class="s2">.</span><span class="s0">isTypeScriptTransformEnabled </span><span class="s2">= </span><span class="s0">isTypeScriptTransformEnabled</span><span class="s2">;</span><span class="s1">this</span><span class="s2">.</span><span class="s0">keepUnusedImports </span><span class="s2">= </span><span class="s0">keepUnusedImports</span><span class="s2">;</span><span class="s1">this</span><span class="s2">.</span><span class="s0">helperManager </span><span class="s2">= </span><span class="s0">helperManager</span><span class="s2">;</span><span class="s0">CJSImportProcessor</span><span class="s2">.</span><span class="s0">prototype</span><span class="s2">.</span><span class="s0">__init</span><span class="s2">.</span><span class="s0">call</span><span class="s2">(</span><span class="s1">this</span><span class="s2">);</span><span class="s0">CJSImportProcessor</span><span class="s2">.</span><span class="s0">prototype</span><span class="s2">.</span><span class="s0">__init2</span><span class="s2">.</span><span class="s0">call</span><span class="s2">(</span><span class="s1">this</span><span class="s2">);</span><span class="s0">CJSImportProcessor</span><span class="s2">.</span><span class="s0">prototype</span><span class="s2">.</span><span class="s0">__init3</span><span class="s2">.</span><span class="s0">call</span><span class="s2">(</span><span class="s1">this</span><span class="s2">);</span><span class="s0">CJSImportProcessor</span><span class="s2">.</span><span class="s0">prototype</span><span class="s2">.</span><span class="s0">__init4</span><span class="s2">.</span><span class="s0">call</span><span class="s2">(</span><span class="s1">this</span><span class="s2">);</span><span class="s0">CJSImportProcessor</span><span class="s2">.</span><span class="s0">prototype</span><span class="s2">.</span><span class="s0">__init5</span><span class="s2">.</span><span class="s0">call</span><span class="s2">(</span><span class="s1">this</span><span class="s2">);}</span>

  <span class="s0">preprocessTokens</span><span class="s2">() {</span>
    <span class="s1">for </span><span class="s2">(</span><span class="s1">let </span><span class="s0">i </span><span class="s2">= </span><span class="s5">0</span><span class="s2">; </span><span class="s0">i </span><span class="s2">&lt; </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">length</span><span class="s2">; </span><span class="s0">i</span><span class="s2">++) {</span>
      <span class="s1">if </span><span class="s2">(</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_import</span><span class="s2">) &amp;&amp;</span>
        <span class="s2">!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches3AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_import</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">name</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">eq</span><span class="s2">)</span>
      <span class="s2">) {</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">preprocessImportAtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s1">if </span><span class="s2">(</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">) &amp;&amp;</span>
        <span class="s2">!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches2AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">eq</span><span class="s2">)</span>
      <span class="s2">) {</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">preprocessExportAtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
    <span class="s1">this</span><span class="s2">.</span><span class="s0">generateImportReplacements</span><span class="s2">();</span>
  <span class="s2">}</span>

  <span class="s4">/**</span>
   <span class="s4">* In TypeScript, import statements that only import types should be removed.</span>
   <span class="s4">* This includes `import {} from 'foo';`, but not `import 'foo';`.</span>
   <span class="s4">*/</span>
  <span class="s0">pruneTypeOnlyImports</span><span class="s2">() {</span>
    <span class="s1">this</span><span class="s2">.</span><span class="s0">nonTypeIdentifiers </span><span class="s2">= </span><span class="s0">getNonTypeIdentifiers</span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">, </span><span class="s1">this</span><span class="s2">.</span><span class="s0">options</span><span class="s2">);</span>
    <span class="s1">for </span><span class="s2">(</span><span class="s1">const </span><span class="s2">[</span><span class="s0">path</span><span class="s2">, </span><span class="s0">importInfo</span><span class="s2">] </span><span class="s0">of </span><span class="s1">this</span><span class="s2">.</span><span class="s0">importInfoByPath</span><span class="s2">.</span><span class="s0">entries</span><span class="s2">()) {</span>
      <span class="s1">if </span><span class="s2">(</span>
        <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">hasBareImport </span><span class="s2">||</span>
        <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">hasStarExport </span><span class="s2">||</span>
        <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">exportStarNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s2">||</span>
        <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">namedExports</span><span class="s2">.</span><span class="s0">length </span><span class="s2">&gt; </span><span class="s5">0</span>
      <span class="s2">) {</span>
        <span class="s1">continue</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s1">const </span><span class="s0">names </span><span class="s2">= [</span>
        <span class="s0">...importInfo</span><span class="s2">.</span><span class="s0">defaultNames</span><span class="s2">,</span>
        <span class="s0">...importInfo</span><span class="s2">.</span><span class="s0">wildcardNames</span><span class="s2">,</span>
        <span class="s0">...importInfo</span><span class="s2">.</span><span class="s0">namedImports</span><span class="s2">.</span><span class="s0">map</span><span class="s2">(({</span><span class="s0">localName</span><span class="s2">}) =&gt; </span><span class="s0">localName</span><span class="s2">),</span>
      <span class="s2">];</span>
      <span class="s1">if </span><span class="s2">(</span><span class="s0">names</span><span class="s2">.</span><span class="s0">every</span><span class="s2">((</span><span class="s0">name</span><span class="s2">) =&gt; </span><span class="s1">this</span><span class="s2">.</span><span class="s0">shouldAutomaticallyElideImportedName</span><span class="s2">(</span><span class="s0">name</span><span class="s2">))) {</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">importsToReplace</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s0">path</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s0">shouldAutomaticallyElideImportedName</span><span class="s2">(</span><span class="s0">name</span><span class="s2">) {</span>
    <span class="s1">return </span><span class="s2">(</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">isTypeScriptTransformEnabled </span><span class="s2">&amp;&amp;</span>
      <span class="s2">!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">keepUnusedImports </span><span class="s2">&amp;&amp;</span>
      <span class="s2">!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">nonTypeIdentifiers</span><span class="s2">.</span><span class="s0">has</span><span class="s2">(</span><span class="s0">name</span><span class="s2">)</span>
    <span class="s2">);</span>
  <span class="s2">}</span>

   <span class="s0">generateImportReplacements</span><span class="s2">() {</span>
    <span class="s1">for </span><span class="s2">(</span><span class="s1">const </span><span class="s2">[</span><span class="s0">path</span><span class="s2">, </span><span class="s0">importInfo</span><span class="s2">] </span><span class="s0">of </span><span class="s1">this</span><span class="s2">.</span><span class="s0">importInfoByPath</span><span class="s2">.</span><span class="s0">entries</span><span class="s2">()) {</span>
      <span class="s1">const </span><span class="s2">{</span>
        <span class="s0">defaultNames</span><span class="s2">,</span>
        <span class="s0">wildcardNames</span><span class="s2">,</span>
        <span class="s0">namedImports</span><span class="s2">,</span>
        <span class="s0">namedExports</span><span class="s2">,</span>
        <span class="s0">exportStarNames</span><span class="s2">,</span>
        <span class="s0">hasStarExport</span><span class="s2">,</span>
      <span class="s2">} = </span><span class="s0">importInfo</span><span class="s2">;</span>

      <span class="s1">if </span><span class="s2">(</span>
        <span class="s0">defaultNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">=== </span><span class="s5">0 </span><span class="s2">&amp;&amp;</span>
        <span class="s0">wildcardNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">=== </span><span class="s5">0 </span><span class="s2">&amp;&amp;</span>
        <span class="s0">namedImports</span><span class="s2">.</span><span class="s0">length </span><span class="s2">=== </span><span class="s5">0 </span><span class="s2">&amp;&amp;</span>
        <span class="s0">namedExports</span><span class="s2">.</span><span class="s0">length </span><span class="s2">=== </span><span class="s5">0 </span><span class="s2">&amp;&amp;</span>
        <span class="s0">exportStarNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">=== </span><span class="s5">0 </span><span class="s2">&amp;&amp;</span>
        <span class="s2">!</span><span class="s0">hasStarExport</span>
      <span class="s2">) {</span>
        <span class="s6">// Import is never used, so don't even assign a name.</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">importsToReplace</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s0">path</span><span class="s2">, </span><span class="s3">`require('</span><span class="s0">$</span><span class="s2">{</span><span class="s0">path</span><span class="s2">}</span><span class="s3">');`</span><span class="s2">);</span>
        <span class="s1">continue</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s1">const </span><span class="s0">primaryImportName </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">getFreeIdentifierForPath</span><span class="s2">(</span><span class="s0">path</span><span class="s2">);</span>
      <span class="s1">let </span><span class="s0">secondaryImportName</span><span class="s2">;</span>
      <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">enableLegacyTypeScriptModuleInterop</span><span class="s2">) {</span>
        <span class="s0">secondaryImportName </span><span class="s2">= </span><span class="s0">primaryImportName</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s1">else </span><span class="s2">{</span>
        <span class="s0">secondaryImportName </span><span class="s2">=</span>
          <span class="s0">wildcardNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s2">? </span><span class="s0">wildcardNames</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] : </span><span class="s1">this</span><span class="s2">.</span><span class="s0">getFreeIdentifierForPath</span><span class="s2">(</span><span class="s0">path</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s1">let </span><span class="s0">requireCode </span><span class="s2">= </span><span class="s3">`var </span><span class="s0">$</span><span class="s2">{</span><span class="s0">primaryImportName</span><span class="s2">} </span><span class="s3">= require('</span><span class="s0">$</span><span class="s2">{</span><span class="s0">path</span><span class="s2">}</span><span class="s3">');`</span><span class="s2">;</span>
      <span class="s1">if </span><span class="s2">(</span><span class="s0">wildcardNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">) {</span>
        <span class="s1">for </span><span class="s2">(</span><span class="s1">const </span><span class="s0">wildcardName of wildcardNames</span><span class="s2">) {</span>
          <span class="s1">const </span><span class="s0">moduleExpr </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">enableLegacyTypeScriptModuleInterop</span>
            <span class="s2">? </span><span class="s0">primaryImportName</span>
            <span class="s2">: </span><span class="s3">`</span><span class="s0">$</span><span class="s2">{</span><span class="s1">this</span><span class="s2">.</span><span class="s0">helperManager</span><span class="s2">.</span><span class="s0">getHelperName</span><span class="s2">(</span><span class="s3">&quot;interopRequireWildcard&quot;</span><span class="s2">)}</span><span class="s3">(</span><span class="s0">$</span><span class="s2">{</span><span class="s0">primaryImportName</span><span class="s2">}</span><span class="s3">)`</span><span class="s2">;</span>
          <span class="s0">requireCode </span><span class="s2">+= </span><span class="s3">` var </span><span class="s0">$</span><span class="s2">{</span><span class="s0">wildcardName</span><span class="s2">} </span><span class="s3">= </span><span class="s0">$</span><span class="s2">{</span><span class="s0">moduleExpr</span><span class="s2">}</span><span class="s3">;`</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span><span class="s0">exportStarNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s2">&amp;&amp; </span><span class="s0">secondaryImportName </span><span class="s2">!== </span><span class="s0">primaryImportName</span><span class="s2">) {</span>
        <span class="s0">requireCode </span><span class="s2">+= </span><span class="s3">` var </span><span class="s0">$</span><span class="s2">{</span><span class="s0">secondaryImportName</span><span class="s2">} </span><span class="s3">= </span><span class="s0">$</span><span class="s2">{</span><span class="s1">this</span><span class="s2">.</span><span class="s0">helperManager</span><span class="s2">.</span><span class="s0">getHelperName</span><span class="s2">(</span>
          <span class="s3">&quot;interopRequireWildcard&quot;</span><span class="s2">,</span>
        <span class="s2">)}</span><span class="s3">(</span><span class="s0">$</span><span class="s2">{</span><span class="s0">primaryImportName</span><span class="s2">}</span><span class="s3">);`</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span><span class="s0">defaultNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s2">&amp;&amp; </span><span class="s0">secondaryImportName </span><span class="s2">!== </span><span class="s0">primaryImportName</span><span class="s2">) {</span>
        <span class="s0">requireCode </span><span class="s2">+= </span><span class="s3">` var </span><span class="s0">$</span><span class="s2">{</span><span class="s0">secondaryImportName</span><span class="s2">} </span><span class="s3">= </span><span class="s0">$</span><span class="s2">{</span><span class="s1">this</span><span class="s2">.</span><span class="s0">helperManager</span><span class="s2">.</span><span class="s0">getHelperName</span><span class="s2">(</span>
          <span class="s3">&quot;interopRequireDefault&quot;</span><span class="s2">,</span>
        <span class="s2">)}</span><span class="s3">(</span><span class="s0">$</span><span class="s2">{</span><span class="s0">primaryImportName</span><span class="s2">}</span><span class="s3">);`</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s1">for </span><span class="s2">(</span><span class="s1">const </span><span class="s2">{</span><span class="s0">importedName</span><span class="s2">, </span><span class="s0">localName</span><span class="s2">} </span><span class="s0">of namedExports</span><span class="s2">) {</span>
        <span class="s0">requireCode </span><span class="s2">+= </span><span class="s3">` </span><span class="s0">$</span><span class="s2">{</span><span class="s1">this</span><span class="s2">.</span><span class="s0">helperManager</span><span class="s2">.</span><span class="s0">getHelperName</span><span class="s2">(</span>
          <span class="s3">&quot;createNamedExportFrom&quot;</span><span class="s2">,</span>
        <span class="s2">)}</span><span class="s3">(</span><span class="s0">$</span><span class="s2">{</span><span class="s0">primaryImportName</span><span class="s2">}</span><span class="s3">, '</span><span class="s0">$</span><span class="s2">{</span><span class="s0">localName</span><span class="s2">}</span><span class="s3">', '</span><span class="s0">$</span><span class="s2">{</span><span class="s0">importedName</span><span class="s2">}</span><span class="s3">');`</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s1">for </span><span class="s2">(</span><span class="s1">const </span><span class="s0">exportStarName of exportStarNames</span><span class="s2">) {</span>
        <span class="s0">requireCode </span><span class="s2">+= </span><span class="s3">` exports.</span><span class="s0">$</span><span class="s2">{</span><span class="s0">exportStarName</span><span class="s2">} </span><span class="s3">= </span><span class="s0">$</span><span class="s2">{</span><span class="s0">secondaryImportName</span><span class="s2">}</span><span class="s3">;`</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s1">if </span><span class="s2">(</span><span class="s0">hasStarExport</span><span class="s2">) {</span>
        <span class="s0">requireCode </span><span class="s2">+= </span><span class="s3">` </span><span class="s0">$</span><span class="s2">{</span><span class="s1">this</span><span class="s2">.</span><span class="s0">helperManager</span><span class="s2">.</span><span class="s0">getHelperName</span><span class="s2">(</span>
          <span class="s3">&quot;createStarExport&quot;</span><span class="s2">,</span>
        <span class="s2">)}</span><span class="s3">(</span><span class="s0">$</span><span class="s2">{</span><span class="s0">primaryImportName</span><span class="s2">}</span><span class="s3">);`</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s1">this</span><span class="s2">.</span><span class="s0">importsToReplace</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s0">path</span><span class="s2">, </span><span class="s0">requireCode</span><span class="s2">);</span>

      <span class="s1">for </span><span class="s2">(</span><span class="s1">const </span><span class="s0">defaultName of defaultNames</span><span class="s2">) {</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">identifierReplacements</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s0">defaultName</span><span class="s2">, </span><span class="s3">`</span><span class="s0">$</span><span class="s2">{</span><span class="s0">secondaryImportName</span><span class="s2">}</span><span class="s3">.default`</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s1">for </span><span class="s2">(</span><span class="s1">const </span><span class="s2">{</span><span class="s0">importedName</span><span class="s2">, </span><span class="s0">localName</span><span class="s2">} </span><span class="s0">of namedImports</span><span class="s2">) {</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">identifierReplacements</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s0">localName</span><span class="s2">, </span><span class="s3">`</span><span class="s0">$</span><span class="s2">{</span><span class="s0">primaryImportName</span><span class="s2">}</span><span class="s3">.</span><span class="s0">$</span><span class="s2">{</span><span class="s0">importedName</span><span class="s2">}</span><span class="s3">`</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s0">getFreeIdentifierForPath</span><span class="s2">(</span><span class="s0">path</span><span class="s2">) {</span>
    <span class="s1">const </span><span class="s0">components </span><span class="s2">= </span><span class="s0">path</span><span class="s2">.</span><span class="s0">split</span><span class="s2">(</span><span class="s3">&quot;/&quot;</span><span class="s2">);</span>
    <span class="s1">const </span><span class="s0">lastComponent </span><span class="s2">= </span><span class="s0">components</span><span class="s2">[</span><span class="s0">components</span><span class="s2">.</span><span class="s0">length </span><span class="s2">- </span><span class="s5">1</span><span class="s2">];</span>
    <span class="s1">const </span><span class="s0">baseName </span><span class="s2">= </span><span class="s0">lastComponent</span><span class="s2">.</span><span class="s0">replace</span><span class="s2">(</span><span class="s7">/\W/g</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">);</span>
    <span class="s1">return this</span><span class="s2">.</span><span class="s0">nameManager</span><span class="s2">.</span><span class="s0">claimFreeName</span><span class="s2">(</span><span class="s3">`_</span><span class="s0">$</span><span class="s2">{</span><span class="s0">baseName</span><span class="s2">}</span><span class="s3">`</span><span class="s2">);</span>
  <span class="s2">}</span>

   <span class="s0">preprocessImportAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">) {</span>
    <span class="s1">const </span><span class="s0">defaultNames </span><span class="s2">= [];</span>
    <span class="s1">const </span><span class="s0">wildcardNames </span><span class="s2">= [];</span>
    <span class="s1">const </span><span class="s0">namedImports </span><span class="s2">= [];</span>

    <span class="s0">index</span><span class="s2">++;</span>
    <span class="s1">if </span><span class="s2">(</span>
      <span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matchesContextualAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">ContextualKeyword</span><span class="s2">.</span><span class="s0">_type</span><span class="s2">) ||</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_typeof</span><span class="s2">)) &amp;&amp;</span>
      <span class="s2">!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">comma</span><span class="s2">) &amp;&amp;</span>
      <span class="s2">!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matchesContextualAtIndex</span><span class="s2">(</span><span class="s0">index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s0">ContextualKeyword</span><span class="s2">.</span><span class="s0">_from</span><span class="s2">)</span>
    <span class="s2">) {</span>
      <span class="s6">// import type declaration, so no need to process anything.</span>
      <span class="s1">return</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">parenL</span><span class="s2">)) {</span>
      <span class="s6">// Dynamic import, so nothing to do</span>
      <span class="s1">return</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">name</span><span class="s2">)) {</span>
      <span class="s0">defaultNames</span><span class="s2">.</span><span class="s0">push</span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">identifierNameAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">));</span>
      <span class="s0">index</span><span class="s2">++;</span>
      <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">comma</span><span class="s2">)) {</span>
        <span class="s0">index</span><span class="s2">++;</span>
      <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">star</span><span class="s2">)) {</span>
      <span class="s6">// * as</span>
      <span class="s0">index </span><span class="s2">+= </span><span class="s5">2</span><span class="s2">;</span>
      <span class="s0">wildcardNames</span><span class="s2">.</span><span class="s0">push</span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">identifierNameAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">));</span>
      <span class="s0">index</span><span class="s2">++;</span>
    <span class="s2">}</span>

    <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">braceL</span><span class="s2">)) {</span>
      <span class="s1">const </span><span class="s0">result </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">getNamedImports</span><span class="s2">(</span><span class="s0">index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">);</span>
      <span class="s0">index </span><span class="s2">= </span><span class="s0">result</span><span class="s2">.</span><span class="s0">newIndex</span><span class="s2">;</span>

      <span class="s1">for </span><span class="s2">(</span><span class="s1">const </span><span class="s0">namedImport of result</span><span class="s2">.</span><span class="s0">namedImports</span><span class="s2">) {</span>
        <span class="s6">// Treat {default as X} as a default import to ensure usage of require interop helper</span>
        <span class="s1">if </span><span class="s2">(</span><span class="s0">namedImport</span><span class="s2">.</span><span class="s0">importedName </span><span class="s2">=== </span><span class="s3">&quot;default&quot;</span><span class="s2">) {</span>
          <span class="s0">defaultNames</span><span class="s2">.</span><span class="s0">push</span><span class="s2">(</span><span class="s0">namedImport</span><span class="s2">.</span><span class="s0">localName</span><span class="s2">);</span>
        <span class="s2">} </span><span class="s1">else </span><span class="s2">{</span>
          <span class="s0">namedImports</span><span class="s2">.</span><span class="s0">push</span><span class="s2">(</span><span class="s0">namedImport</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matchesContextualAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">ContextualKeyword</span><span class="s2">.</span><span class="s0">_from</span><span class="s2">)) {</span>
      <span class="s0">index</span><span class="s2">++;</span>
    <span class="s2">}</span>

    <span class="s1">if </span><span class="s2">(!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">string</span><span class="s2">)) {</span>
      <span class="s1">throw new </span><span class="s0">Error</span><span class="s2">(</span><span class="s3">&quot;Expected string token at the end of import statement.&quot;</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s1">const </span><span class="s0">path </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">stringValueAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">);</span>
    <span class="s1">const </span><span class="s0">importInfo </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">getImportInfo</span><span class="s2">(</span><span class="s0">path</span><span class="s2">);</span>
    <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">defaultNames</span><span class="s2">.</span><span class="s0">push</span><span class="s2">(</span><span class="s0">...defaultNames</span><span class="s2">);</span>
    <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">wildcardNames</span><span class="s2">.</span><span class="s0">push</span><span class="s2">(</span><span class="s0">...wildcardNames</span><span class="s2">);</span>
    <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">namedImports</span><span class="s2">.</span><span class="s0">push</span><span class="s2">(</span><span class="s0">...namedImports</span><span class="s2">);</span>
    <span class="s1">if </span><span class="s2">(</span><span class="s0">defaultNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">=== </span><span class="s5">0 </span><span class="s2">&amp;&amp; </span><span class="s0">wildcardNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">=== </span><span class="s5">0 </span><span class="s2">&amp;&amp; </span><span class="s0">namedImports</span><span class="s2">.</span><span class="s0">length </span><span class="s2">=== </span><span class="s5">0</span><span class="s2">) {</span>
      <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">hasBareImport </span><span class="s2">= </span><span class="s1">true</span><span class="s2">;</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

   <span class="s0">preprocessExportAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">) {</span>
    <span class="s1">if </span><span class="s2">(</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches2AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_var</span><span class="s2">) ||</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches2AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_let</span><span class="s2">) ||</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches2AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_const</span><span class="s2">)</span>
    <span class="s2">) {</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">preprocessVarExportAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches2AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_function</span><span class="s2">) ||</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches2AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_class</span><span class="s2">)</span>
    <span class="s2">) {</span>
      <span class="s1">const </span><span class="s0">exportName </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">identifierNameAtIndex</span><span class="s2">(</span><span class="s0">index </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">);</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">addExportBinding</span><span class="s2">(</span><span class="s0">exportName</span><span class="s2">, </span><span class="s0">exportName</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches3AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">name</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_function</span><span class="s2">)) {</span>
      <span class="s1">const </span><span class="s0">exportName </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">identifierNameAtIndex</span><span class="s2">(</span><span class="s0">index </span><span class="s2">+ </span><span class="s5">3</span><span class="s2">);</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">addExportBinding</span><span class="s2">(</span><span class="s0">exportName</span><span class="s2">, </span><span class="s0">exportName</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches2AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">braceL</span><span class="s2">)) {</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">preprocessNamedExportAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches2AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">star</span><span class="s2">)) {</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">preprocessExportStarAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">);</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

   <span class="s0">preprocessVarExportAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">) {</span>
    <span class="s1">let </span><span class="s0">depth </span><span class="s2">= </span><span class="s5">0</span><span class="s2">;</span>
    <span class="s6">// Handle cases like `export let {x} = y;`, starting at the open-brace in that case.</span>
    <span class="s1">for </span><span class="s2">(</span><span class="s1">let </span><span class="s0">i </span><span class="s2">= </span><span class="s0">index </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">; ; </span><span class="s0">i</span><span class="s2">++) {</span>
      <span class="s1">if </span><span class="s2">(</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">braceL</span><span class="s2">) ||</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">dollarBraceL</span><span class="s2">) ||</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">bracketL</span><span class="s2">)</span>
      <span class="s2">) {</span>
        <span class="s0">depth</span><span class="s2">++;</span>
      <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">braceR</span><span class="s2">) ||</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">bracketR</span><span class="s2">)</span>
      <span class="s2">) {</span>
        <span class="s0">depth</span><span class="s2">--;</span>
      <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span><span class="s0">depth </span><span class="s2">=== </span><span class="s5">0 </span><span class="s2">&amp;&amp; !</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">name</span><span class="s2">)) {</span>
        <span class="s1">break</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">eq</span><span class="s2">)) {</span>
        <span class="s1">const </span><span class="s0">endIndex </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">currentToken</span><span class="s2">().</span><span class="s0">rhsEndIndex</span><span class="s2">;</span>
        <span class="s1">if </span><span class="s2">(</span><span class="s0">endIndex </span><span class="s2">== </span><span class="s1">null</span><span class="s2">) {</span>
          <span class="s1">throw new </span><span class="s0">Error</span><span class="s2">(</span><span class="s3">&quot;Expected = token with an end index.&quot;</span><span class="s2">);</span>
        <span class="s2">}</span>
        <span class="s0">i </span><span class="s2">= </span><span class="s0">endIndex </span><span class="s2">- </span><span class="s5">1</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s1">else </span><span class="s2">{</span>
        <span class="s1">const </span><span class="s0">token </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">[</span><span class="s0">i</span><span class="s2">];</span>
        <span class="s1">if </span><span class="s2">(</span><span class="s0">isDeclaration</span><span class="s2">(</span><span class="s0">token</span><span class="s2">)) {</span>
          <span class="s1">const </span><span class="s0">exportName </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">identifierNameAtIndex</span><span class="s2">(</span><span class="s0">i</span><span class="s2">);</span>
          <span class="s1">this</span><span class="s2">.</span><span class="s0">identifierReplacements</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s0">exportName</span><span class="s2">, </span><span class="s3">`exports.</span><span class="s0">$</span><span class="s2">{</span><span class="s0">exportName</span><span class="s2">}</span><span class="s3">`</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Walk this export statement just in case it's an export...from statement.</span>
   <span class="s4">* If it is, combine it into the import info for that path. Otherwise, just</span>
   <span class="s4">* bail out; it'll be handled later.</span>
   <span class="s4">*/</span>
   <span class="s0">preprocessNamedExportAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">) {</span>
    <span class="s6">// export {</span>
    <span class="s0">index </span><span class="s2">+= </span><span class="s5">2</span><span class="s2">;</span>
    <span class="s1">const </span><span class="s2">{</span><span class="s0">newIndex</span><span class="s2">, </span><span class="s0">namedImports</span><span class="s2">} = </span><span class="s1">this</span><span class="s2">.</span><span class="s0">getNamedImports</span><span class="s2">(</span><span class="s0">index</span><span class="s2">);</span>
    <span class="s0">index </span><span class="s2">= </span><span class="s0">newIndex</span><span class="s2">;</span>

    <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matchesContextualAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">ContextualKeyword</span><span class="s2">.</span><span class="s0">_from</span><span class="s2">)) {</span>
      <span class="s0">index</span><span class="s2">++;</span>
    <span class="s2">} </span><span class="s1">else </span><span class="s2">{</span>
      <span class="s6">// Reinterpret &quot;a as b&quot; to be local/exported rather than imported/local.</span>
      <span class="s1">for </span><span class="s2">(</span><span class="s1">const </span><span class="s2">{</span><span class="s0">importedName</span><span class="s2">: </span><span class="s0">localName</span><span class="s2">, </span><span class="s0">localName</span><span class="s2">: </span><span class="s0">exportedName</span><span class="s2">} </span><span class="s0">of namedImports</span><span class="s2">) {</span>
        <span class="s1">this</span><span class="s2">.</span><span class="s0">addExportBinding</span><span class="s2">(</span><span class="s0">localName</span><span class="s2">, </span><span class="s0">exportedName</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s1">return</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s1">if </span><span class="s2">(!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">string</span><span class="s2">)) {</span>
      <span class="s1">throw new </span><span class="s0">Error</span><span class="s2">(</span><span class="s3">&quot;Expected string token at the end of import statement.&quot;</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s1">const </span><span class="s0">path </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">stringValueAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">);</span>
    <span class="s1">const </span><span class="s0">importInfo </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">getImportInfo</span><span class="s2">(</span><span class="s0">path</span><span class="s2">);</span>
    <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">namedExports</span><span class="s2">.</span><span class="s0">push</span><span class="s2">(</span><span class="s0">...namedImports</span><span class="s2">);</span>
  <span class="s2">}</span>

   <span class="s0">preprocessExportStarAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">) {</span>
    <span class="s1">let </span><span class="s0">exportedName </span><span class="s2">= </span><span class="s1">null</span><span class="s2">;</span>
    <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches3AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_export</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">star</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">_as</span><span class="s2">)) {</span>
      <span class="s6">// export * as</span>
      <span class="s0">index </span><span class="s2">+= </span><span class="s5">3</span><span class="s2">;</span>
      <span class="s0">exportedName </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">identifierNameAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">);</span>
      <span class="s6">// foo from</span>
      <span class="s0">index </span><span class="s2">+= </span><span class="s5">2</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s1">else </span><span class="s2">{</span>
      <span class="s6">// export * from</span>
      <span class="s0">index </span><span class="s2">+= </span><span class="s5">3</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s1">if </span><span class="s2">(!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">string</span><span class="s2">)) {</span>
      <span class="s1">throw new </span><span class="s0">Error</span><span class="s2">(</span><span class="s3">&quot;Expected string token at the end of star export statement.&quot;</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s1">const </span><span class="s0">path </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">stringValueAtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">);</span>
    <span class="s1">const </span><span class="s0">importInfo </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">getImportInfo</span><span class="s2">(</span><span class="s0">path</span><span class="s2">);</span>
    <span class="s1">if </span><span class="s2">(</span><span class="s0">exportedName </span><span class="s2">!== </span><span class="s1">null</span><span class="s2">) {</span>
      <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">exportStarNames</span><span class="s2">.</span><span class="s0">push</span><span class="s2">(</span><span class="s0">exportedName</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s1">else </span><span class="s2">{</span>
      <span class="s0">importInfo</span><span class="s2">.</span><span class="s0">hasStarExport </span><span class="s2">= </span><span class="s1">true</span><span class="s2">;</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

   <span class="s0">getNamedImports</span><span class="s2">(</span><span class="s0">index</span><span class="s2">) {</span>
    <span class="s1">const </span><span class="s0">namedImports </span><span class="s2">= [];</span>
    <span class="s1">while </span><span class="s2">(</span><span class="s1">true</span><span class="s2">) {</span>
      <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">braceR</span><span class="s2">)) {</span>
        <span class="s0">index</span><span class="s2">++;</span>
        <span class="s1">break</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s1">const </span><span class="s0">specifierInfo </span><span class="s2">= </span><span class="s0">getImportExportSpecifierInfo</span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">, </span><span class="s0">index</span><span class="s2">);</span>
      <span class="s0">index </span><span class="s2">= </span><span class="s0">specifierInfo</span><span class="s2">.</span><span class="s0">endIndex</span><span class="s2">;</span>
      <span class="s1">if </span><span class="s2">(!</span><span class="s0">specifierInfo</span><span class="s2">.</span><span class="s0">isType</span><span class="s2">) {</span>
        <span class="s0">namedImports</span><span class="s2">.</span><span class="s0">push</span><span class="s2">({</span>
          <span class="s0">importedName</span><span class="s2">: </span><span class="s0">specifierInfo</span><span class="s2">.</span><span class="s0">leftName</span><span class="s2">,</span>
          <span class="s0">localName</span><span class="s2">: </span><span class="s0">specifierInfo</span><span class="s2">.</span><span class="s0">rightName</span><span class="s2">,</span>
        <span class="s2">});</span>
      <span class="s2">}</span>

      <span class="s1">if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches2AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">comma</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">braceR</span><span class="s2">)) {</span>
        <span class="s0">index </span><span class="s2">+= </span><span class="s5">2</span><span class="s2">;</span>
        <span class="s1">break</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">braceR</span><span class="s2">)) {</span>
        <span class="s0">index</span><span class="s2">++;</span>
        <span class="s1">break</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s1">else if </span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">matches1AtIndex</span><span class="s2">(</span><span class="s0">index</span><span class="s2">, </span><span class="s0">tt</span><span class="s2">.</span><span class="s0">comma</span><span class="s2">)) {</span>
        <span class="s0">index</span><span class="s2">++;</span>
      <span class="s2">} </span><span class="s1">else </span><span class="s2">{</span>
        <span class="s1">throw new </span><span class="s0">Error</span><span class="s2">(</span><span class="s3">`Unexpected token: </span><span class="s0">$</span><span class="s2">{</span><span class="s0">JSON</span><span class="s2">.</span><span class="s0">stringify</span><span class="s2">(</span><span class="s1">this</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">.</span><span class="s0">tokens</span><span class="s2">[</span><span class="s0">index</span><span class="s2">])}</span><span class="s3">`</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
    <span class="s1">return </span><span class="s2">{</span><span class="s0">newIndex</span><span class="s2">: </span><span class="s0">index</span><span class="s2">, </span><span class="s0">namedImports</span><span class="s2">};</span>
  <span class="s2">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Get a mutable import info object for this path, creating one if it doesn't</span>
   <span class="s4">* exist yet.</span>
   <span class="s4">*/</span>
   <span class="s0">getImportInfo</span><span class="s2">(</span><span class="s0">path</span><span class="s2">) {</span>
    <span class="s1">const </span><span class="s0">existingInfo </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">importInfoByPath</span><span class="s2">.</span><span class="s0">get</span><span class="s2">(</span><span class="s0">path</span><span class="s2">);</span>
    <span class="s1">if </span><span class="s2">(</span><span class="s0">existingInfo</span><span class="s2">) {</span>
      <span class="s1">return </span><span class="s0">existingInfo</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s1">const </span><span class="s0">newInfo </span><span class="s2">= {</span>
      <span class="s0">defaultNames</span><span class="s2">: [],</span>
      <span class="s0">wildcardNames</span><span class="s2">: [],</span>
      <span class="s0">namedImports</span><span class="s2">: [],</span>
      <span class="s0">namedExports</span><span class="s2">: [],</span>
      <span class="s0">hasBareImport</span><span class="s2">: </span><span class="s1">false</span><span class="s2">,</span>
      <span class="s0">exportStarNames</span><span class="s2">: [],</span>
      <span class="s0">hasStarExport</span><span class="s2">: </span><span class="s1">false</span><span class="s2">,</span>
    <span class="s2">};</span>
    <span class="s1">this</span><span class="s2">.</span><span class="s0">importInfoByPath</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s0">path</span><span class="s2">, </span><span class="s0">newInfo</span><span class="s2">);</span>
    <span class="s1">return </span><span class="s0">newInfo</span><span class="s2">;</span>
  <span class="s2">}</span>

   <span class="s0">addExportBinding</span><span class="s2">(</span><span class="s0">localName</span><span class="s2">, </span><span class="s0">exportedName</span><span class="s2">) {</span>
    <span class="s1">if </span><span class="s2">(!</span><span class="s1">this</span><span class="s2">.</span><span class="s0">exportBindingsByLocalName</span><span class="s2">.</span><span class="s0">has</span><span class="s2">(</span><span class="s0">localName</span><span class="s2">)) {</span>
      <span class="s1">this</span><span class="s2">.</span><span class="s0">exportBindingsByLocalName</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s0">localName</span><span class="s2">, []);</span>
    <span class="s2">}</span>
    <span class="s1">this</span><span class="s2">.</span><span class="s0">exportBindingsByLocalName</span><span class="s2">.</span><span class="s0">get</span><span class="s2">(</span><span class="s0">localName</span><span class="s2">).</span><span class="s0">push</span><span class="s2">(</span><span class="s0">exportedName</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Return the code to use for the import for this path, or the empty string if</span>
   <span class="s4">* the code has already been &quot;claimed&quot; by a previous import.</span>
   <span class="s4">*/</span>
  <span class="s0">claimImportCode</span><span class="s2">(</span><span class="s0">importPath</span><span class="s2">) {</span>
    <span class="s1">const </span><span class="s0">result </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">importsToReplace</span><span class="s2">.</span><span class="s0">get</span><span class="s2">(</span><span class="s0">importPath</span><span class="s2">);</span>
    <span class="s1">this</span><span class="s2">.</span><span class="s0">importsToReplace</span><span class="s2">.</span><span class="s0">set</span><span class="s2">(</span><span class="s0">importPath</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">);</span>
    <span class="s1">return </span><span class="s0">result </span><span class="s2">|| </span><span class="s3">&quot;&quot;</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s0">getIdentifierReplacement</span><span class="s2">(</span><span class="s0">identifierName</span><span class="s2">) {</span>
    <span class="s1">return this</span><span class="s2">.</span><span class="s0">identifierReplacements</span><span class="s2">.</span><span class="s0">get</span><span class="s2">(</span><span class="s0">identifierName</span><span class="s2">) || </span><span class="s1">null</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Return a string like `exports.foo = exports.bar`.</span>
   <span class="s4">*/</span>
  <span class="s0">resolveExportBinding</span><span class="s2">(</span><span class="s0">assignedName</span><span class="s2">) {</span>
    <span class="s1">const </span><span class="s0">exportedNames </span><span class="s2">= </span><span class="s1">this</span><span class="s2">.</span><span class="s0">exportBindingsByLocalName</span><span class="s2">.</span><span class="s0">get</span><span class="s2">(</span><span class="s0">assignedName</span><span class="s2">);</span>
    <span class="s1">if </span><span class="s2">(!</span><span class="s0">exportedNames </span><span class="s2">|| </span><span class="s0">exportedNames</span><span class="s2">.</span><span class="s0">length </span><span class="s2">=== </span><span class="s5">0</span><span class="s2">) {</span>
      <span class="s1">return null</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s1">return </span><span class="s0">exportedNames</span><span class="s2">.</span><span class="s0">map</span><span class="s2">((</span><span class="s0">exportedName</span><span class="s2">) =&gt; </span><span class="s3">`exports.</span><span class="s0">$</span><span class="s2">{</span><span class="s0">exportedName</span><span class="s2">}</span><span class="s3">`</span><span class="s2">).</span><span class="s0">join</span><span class="s2">(</span><span class="s3">&quot; = &quot;</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Return all imported/exported names where we might be interested in whether usages of those</span>
   <span class="s4">* names are shadowed.</span>
   <span class="s4">*/</span>
  <span class="s0">getGlobalNames</span><span class="s2">() {</span>
    <span class="s1">return new </span><span class="s0">Set</span><span class="s2">([</span>
      <span class="s0">...</span><span class="s1">this</span><span class="s2">.</span><span class="s0">identifierReplacements</span><span class="s2">.</span><span class="s0">keys</span><span class="s2">(),</span>
      <span class="s0">...</span><span class="s1">this</span><span class="s2">.</span><span class="s0">exportBindingsByLocalName</span><span class="s2">.</span><span class="s0">keys</span><span class="s2">(),</span>
    <span class="s2">]);</span>
  <span class="s2">}</span>
<span class="s2">}</span>
</pre>
</body>
</html>