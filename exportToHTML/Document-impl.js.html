<html>
<head>
<title>Document-impl.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Document-impl.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>

<span class="s3">const </span><span class="s1">{ </span><span class="s2">CookieJar </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;tough-cookie&quot;</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">NodeImpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./Node-impl&quot;</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">idlUtils </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/utils&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">NODE_TYPE </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../node-type&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">hasWeakRefs</span><span class="s1">, </span><span class="s2">mixin</span><span class="s1">, </span><span class="s2">memoizeQuery </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../../utils&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">firstChildWithLocalName</span><span class="s1">, </span><span class="s2">firstChildWithLocalNames</span><span class="s1">, </span><span class="s2">firstDescendantWithLocalName </span><span class="s1">} =</span>
  <span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/traversal&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">whatwgURL </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;whatwg-url&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">StyleSheetList </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/StyleSheetList.js&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">domSymbolTree </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/internal-constants&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">eventAccessors </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/create-event-accessor&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">asciiLowercase</span><span class="s1">, </span><span class="s2">stripAndCollapseASCIIWhitespace </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/strings&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">childTextContent </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/text&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">HTML_NS</span><span class="s1">, </span><span class="s2">SVG_NS </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/namespaces&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">DOMException </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;domexception/webidl2js-wrapper&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">parseIntoDocument </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../../browser/parser&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">History </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/History&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Location </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/Location&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">HTMLCollection </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/HTMLCollection&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">NodeList </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/NodeList&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">validateName </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/validate-names&quot;</span><span class="s1">).</span><span class="s2">name</span><span class="s1">;</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">validateAndExtract </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/validate-names&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">fireAnEvent </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/events&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">shadowIncludingInclusiveDescendantsIterator </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/shadow-dom&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">enqueueCECallbackReaction </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/custom-elements&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">createElement</span><span class="s1">, </span><span class="s2">internalCreateElementNSSteps </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/create-element&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">IterableWeakSet </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../helpers/iterable-weak-set&quot;</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">DocumentOrShadowRootImpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./DocumentOrShadowRoot-impl&quot;</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">GlobalEventHandlersImpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./GlobalEventHandlers-impl&quot;</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">NonElementParentNodeImpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./NonElementParentNode-impl&quot;</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">ParentNodeImpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./ParentNode-impl&quot;</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">;</span>

<span class="s3">const </span><span class="s1">{ </span><span class="s2">clone</span><span class="s1">, </span><span class="s2">listOfElementsWithQualifiedName</span><span class="s1">, </span><span class="s2">listOfElementsWithNamespaceAndLocalName</span><span class="s1">,</span>
  <span class="s2">listOfElementsWithClassNames </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../node&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">generatedAttr </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/Attr&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Comment </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/Comment&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">ProcessingInstruction </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/ProcessingInstruction&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">CDATASection </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/CDATASection&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Text </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/Text&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">DocumentFragment </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/DocumentFragment&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">DOMImplementation </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/DOMImplementation&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">TreeWalker </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/TreeWalker&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">NodeIterator </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/NodeIterator&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">ShadowRoot </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/ShadowRoot&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Range </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/Range&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">documents </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../documents.js&quot;</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">CustomEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/CustomEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">ErrorEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/ErrorEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Event </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/Event&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">FocusEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/FocusEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">HashChangeEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/HashChangeEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">KeyboardEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/KeyboardEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">MessageEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/MessageEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">MouseEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/MouseEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">PopStateEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/PopStateEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">ProgressEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/ProgressEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">TouchEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/TouchEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">UIEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/UIEvent&quot;</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">RequestManager </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../../browser/resources/request-manager&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">AsyncResourceQueue </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../../browser/resources/async-resource-queue&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">ResourceQueue </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../../browser/resources/resource-queue&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">PerDocumentResourceLoader </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../../browser/resources/per-document-resource-loader&quot;</span><span class="s1">);</span>

<span class="s3">function </span><span class="s2">clearChildNodes</span><span class="s1">(</span><span class="s2">node</span><span class="s1">) {</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">child </span><span class="s1">= </span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">firstChild</span><span class="s1">(</span><span class="s2">node</span><span class="s1">); </span><span class="s2">child</span><span class="s1">; </span><span class="s2">child </span><span class="s1">= </span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">firstChild</span><span class="s1">(</span><span class="s2">node</span><span class="s1">)) {</span>
    <span class="s2">node</span><span class="s1">.</span><span class="s2">removeChild</span><span class="s1">(</span><span class="s2">child</span><span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">pad</span><span class="s1">(</span><span class="s2">number</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">number </span><span class="s1">&lt; </span><span class="s4">10</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s0">&quot;0&quot; </span><span class="s1">+ </span><span class="s2">number</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">number</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">toLastModifiedString</span><span class="s1">(</span><span class="s2">date</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s2">pad</span><span class="s1">(</span><span class="s2">date</span><span class="s1">.</span><span class="s2">getMonth</span><span class="s1">() + </span><span class="s4">1</span><span class="s1">) +</span>
    <span class="s0">&quot;/&quot; </span><span class="s1">+ </span><span class="s2">pad</span><span class="s1">(</span><span class="s2">date</span><span class="s1">.</span><span class="s2">getDate</span><span class="s1">()) +</span>
    <span class="s0">&quot;/&quot; </span><span class="s1">+ </span><span class="s2">date</span><span class="s1">.</span><span class="s2">getFullYear</span><span class="s1">() +</span>
    <span class="s0">&quot; &quot; </span><span class="s1">+ </span><span class="s2">pad</span><span class="s1">(</span><span class="s2">date</span><span class="s1">.</span><span class="s2">getHours</span><span class="s1">()) +</span>
    <span class="s0">&quot;:&quot; </span><span class="s1">+ </span><span class="s2">pad</span><span class="s1">(</span><span class="s2">date</span><span class="s1">.</span><span class="s2">getMinutes</span><span class="s1">()) +</span>
    <span class="s0">&quot;:&quot; </span><span class="s1">+ </span><span class="s2">pad</span><span class="s1">(</span><span class="s2">date</span><span class="s1">.</span><span class="s2">getSeconds</span><span class="s1">());</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s2">eventInterfaceTable </span><span class="s1">= {</span>
  <span class="s2">customevent</span><span class="s1">: </span><span class="s2">CustomEvent</span><span class="s1">,</span>
  <span class="s2">errorevent</span><span class="s1">: </span><span class="s2">ErrorEvent</span><span class="s1">,</span>
  <span class="s2">event</span><span class="s1">: </span><span class="s2">Event</span><span class="s1">,</span>
  <span class="s2">events</span><span class="s1">: </span><span class="s2">Event</span><span class="s1">,</span>
  <span class="s2">focusevent</span><span class="s1">: </span><span class="s2">FocusEvent</span><span class="s1">,</span>
  <span class="s2">hashchangeevent</span><span class="s1">: </span><span class="s2">HashChangeEvent</span><span class="s1">,</span>
  <span class="s2">htmlevents</span><span class="s1">: </span><span class="s2">Event</span><span class="s1">,</span>
  <span class="s2">keyboardevent</span><span class="s1">: </span><span class="s2">KeyboardEvent</span><span class="s1">,</span>
  <span class="s2">messageevent</span><span class="s1">: </span><span class="s2">MessageEvent</span><span class="s1">,</span>
  <span class="s2">mouseevent</span><span class="s1">: </span><span class="s2">MouseEvent</span><span class="s1">,</span>
  <span class="s2">mouseevents</span><span class="s1">: </span><span class="s2">MouseEvent</span><span class="s1">,</span>
  <span class="s2">popstateevent</span><span class="s1">: </span><span class="s2">PopStateEvent</span><span class="s1">,</span>
  <span class="s2">progressevent</span><span class="s1">: </span><span class="s2">ProgressEvent</span><span class="s1">,</span>
  <span class="s2">svgevents</span><span class="s1">: </span><span class="s2">Event</span><span class="s1">,</span>
  <span class="s2">touchevent</span><span class="s1">: </span><span class="s2">TouchEvent</span><span class="s1">,</span>
  <span class="s2">uievent</span><span class="s1">: </span><span class="s2">UIEvent</span><span class="s1">,</span>
  <span class="s2">uievents</span><span class="s1">: </span><span class="s2">UIEvent</span>
<span class="s1">};</span>

<span class="s3">class </span><span class="s2">DocumentImpl </span><span class="s3">extends </span><span class="s2">NodeImpl </span><span class="s1">{</span>
  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">globalObject</span><span class="s1">, </span><span class="s2">args</span><span class="s1">, </span><span class="s2">privateData</span><span class="s1">) {</span>
    <span class="s3">super</span><span class="s1">(</span><span class="s2">globalObject</span><span class="s1">, </span><span class="s2">args</span><span class="s1">, </span><span class="s2">privateData</span><span class="s1">);</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_initGlobalEvents</span><span class="s1">();</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_ownerDocument </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">nodeType </span><span class="s1">= </span><span class="s2">NODE_TYPE</span><span class="s1">.</span><span class="s2">DOCUMENT_NODE</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
      <span class="s2">privateData</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= {};</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">parsingMode</span><span class="s1">) {</span>
      <span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">parsingMode </span><span class="s1">= </span><span class="s0">&quot;xml&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">) {</span>
      <span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding </span><span class="s1">= </span><span class="s0">&quot;UTF-8&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">contentType</span><span class="s1">) {</span>
      <span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">contentType </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">parsingMode </span><span class="s1">=== </span><span class="s0">&quot;xml&quot; </span><span class="s1">? </span><span class="s0">&quot;application/xml&quot; </span><span class="s1">: </span><span class="s0">&quot;text/html&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_parsingMode </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">parsingMode</span><span class="s1">;</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_implementation </span><span class="s1">= </span><span class="s2">DOMImplementation</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">ownerDocument</span><span class="s1">: </span><span class="s3">this</span>
    <span class="s1">});</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_defaultView </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">defaultView </span><span class="s1">|| </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_global </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">global</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_ids </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_attached </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_currentScript </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_pageShowingFlag </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_cookieJar </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">cookieJar</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_parseOptions </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">parseOptions </span><span class="s1">|| {};</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_scriptingDisabled </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">scriptingDisabled</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_cookieJar </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_cookieJar </span><span class="s1">= </span><span class="s3">new </span><span class="s2">CookieJar</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, { </span><span class="s2">looseMode</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_scriptingDisabled</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_parseOptions</span><span class="s1">.</span><span class="s2">scriptingEnabled </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">contentType </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">contentType</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_encoding </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">;</span>

    <span class="s3">const </span><span class="s2">urlOption </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">url </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s0">&quot;about:blank&quot; </span><span class="s1">: </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">url</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">parsed </span><span class="s1">= </span><span class="s2">whatwgURL</span><span class="s1">.</span><span class="s2">parseURL</span><span class="s1">(</span><span class="s2">urlOption</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">parsed </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
      <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">`Could not parse &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">urlOption</span><span class="s1">}</span><span class="s0">&quot; as a URL`</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_URL </span><span class="s1">= </span><span class="s2">parsed</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_origin </span><span class="s1">= </span><span class="s2">urlOption </span><span class="s1">=== </span><span class="s0">&quot;about:blank&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">parentOrigin </span><span class="s1">?</span>
      <span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">parentOrigin </span><span class="s1">:</span>
      <span class="s2">whatwgURL</span><span class="s1">.</span><span class="s2">serializeURLOrigin</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_URL</span><span class="s1">);</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_location </span><span class="s1">= </span><span class="s2">Location</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], { </span><span class="s2">relevantDocument</span><span class="s1">: </span><span class="s3">this </span><span class="s1">});</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_history </span><span class="s1">= </span><span class="s2">History</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">window</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_defaultView</span><span class="s1">,</span>
      <span class="s2">document</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">actAsIfLocationReloadCalled</span><span class="s1">: () =&gt; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_location</span><span class="s1">.</span><span class="s2">reload</span><span class="s1">()</span>
    <span class="s1">});</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">hasWeakRefs</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_workingNodeIterators </span><span class="s1">= </span><span class="s3">new </span><span class="s2">IterableWeakSet</span><span class="s1">();</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_workingNodeIterators </span><span class="s1">= [];</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_referrer </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">referrer </span><span class="s1">|| </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_lastModified </span><span class="s1">= </span><span class="s2">toLastModifiedString</span><span class="s1">(</span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">lastModified </span><span class="s1">|| </span><span class="s3">new </span><span class="s2">Date</span><span class="s1">());</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_asyncQueue </span><span class="s1">= </span><span class="s3">new </span><span class="s2">AsyncResourceQueue</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_queue </span><span class="s1">= </span><span class="s3">new </span><span class="s2">ResourceQueue</span><span class="s1">({ </span><span class="s2">asyncQueue</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_asyncQueue</span><span class="s1">, </span><span class="s2">paused</span><span class="s1">: </span><span class="s3">false </span><span class="s1">});</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_deferQueue </span><span class="s1">= </span><span class="s3">new </span><span class="s2">ResourceQueue</span><span class="s1">({ </span><span class="s2">paused</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_requestManager </span><span class="s1">= </span><span class="s3">new </span><span class="s2">RequestManager</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_currentDocumentReadiness </span><span class="s1">= </span><span class="s2">privateData</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">readyState </span><span class="s1">|| </span><span class="s0">&quot;loading&quot;</span><span class="s1">;</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_lastFocusedElement </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_resourceLoader </span><span class="s1">= </span><span class="s3">new </span><span class="s2">PerDocumentResourceLoader</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>

    <span class="s5">// Each Document in a browsing context can also have a latest entry. This is the entry for that Document</span>
    <span class="s5">// to which the browsing context's session history was most recently traversed. When a Document is created,</span>
    <span class="s5">// it initially has no latest entry.</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_latestEntry </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

    <span class="s5">// https://html.spec.whatwg.org/multipage/dynamic-markup-insertion.html#throw-on-dynamic-markup-insertion-counter</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_throwOnDynamicMarkupInsertionCounter </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">_getTheParent</span><span class="s1">(</span><span class="s2">event</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">event</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;load&quot; </span><span class="s1">|| !</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_defaultView</span><span class="s1">) {</span>
      <span class="s3">return null</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_defaultView</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">get compatMode</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_parsingMode </span><span class="s1">=== </span><span class="s0">&quot;xml&quot; </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.</span><span class="s2">doctype </span><span class="s1">? </span><span class="s0">&quot;CSS1Compat&quot; </span><span class="s1">: </span><span class="s0">&quot;BackCompat&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">get charset</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_encoding</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">get characterSet</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_encoding</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">get inputEncoding</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_encoding</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">get doctype</span><span class="s1">() {</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">childNode of domSymbolTree</span><span class="s1">.</span><span class="s2">childrenIterator</span><span class="s1">(</span><span class="s3">this</span><span class="s1">)) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">childNode</span><span class="s1">.</span><span class="s2">nodeType </span><span class="s1">=== </span><span class="s2">NODE_TYPE</span><span class="s1">.</span><span class="s2">DOCUMENT_TYPE_NODE</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s2">childNode</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">get URL</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">whatwgURL</span><span class="s1">.</span><span class="s2">serializeURL</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_URL</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s2">get documentURI</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">whatwgURL</span><span class="s1">.</span><span class="s2">serializeURL</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_URL</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s2">get location</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_defaultView </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_location </span><span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s5">// https://dom.spec.whatwg.org/#dom-document-documentelement</span>
  <span class="s2">get documentElement</span><span class="s1">() {</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">childNode of domSymbolTree</span><span class="s1">.</span><span class="s2">childrenIterator</span><span class="s1">(</span><span class="s3">this</span><span class="s1">)) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">childNode</span><span class="s1">.</span><span class="s2">nodeType </span><span class="s1">=== </span><span class="s2">NODE_TYPE</span><span class="s1">.</span><span class="s2">ELEMENT_NODE</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s2">childNode</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get implementation</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_implementation</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">set implementation</span><span class="s1">(</span><span class="s2">implementation</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_implementation </span><span class="s1">= </span><span class="s2">implementation</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get defaultView</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_defaultView</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get currentScript</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_currentScript</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get readyState</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_currentDocumentReadiness</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">set readyState</span><span class="s1">(</span><span class="s2">state</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_currentDocumentReadiness </span><span class="s1">= </span><span class="s2">state</span><span class="s1">;</span>
    <span class="s2">fireAnEvent</span><span class="s1">(</span><span class="s0">&quot;readystatechange&quot;</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">hasFocus</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">Boolean</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_lastFocusedElement</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">_descendantRemoved</span><span class="s1">(</span><span class="s2">parent</span><span class="s1">, </span><span class="s2">child</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">child</span><span class="s1">.</span><span class="s2">tagName </span><span class="s1">=== </span><span class="s0">&quot;STYLE&quot;</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">styleSheets</span><span class="s1">.</span><span class="s2">_remove</span><span class="s1">(</span><span class="s2">child</span><span class="s1">.</span><span class="s2">sheet</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">super</span><span class="s1">.</span><span class="s2">_descendantRemoved</span><span class="s1">(</span><span class="s2">parent</span><span class="s1">, </span><span class="s2">child</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">write</span><span class="s1">(</span><span class="s2">...args</span><span class="s1">) {</span>
    <span class="s3">let </span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">args</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
      <span class="s2">text </span><span class="s1">+= </span><span class="s2">args</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_parsingMode </span><span class="s1">=== </span><span class="s0">&quot;xml&quot;</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Cannot use document.write on XML documents&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;InvalidStateError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_throwOnDynamicMarkupInsertionCounter </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Cannot use document.write while a custom element upgrades&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;InvalidStateError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_writeAfterElement</span><span class="s1">) {</span>
      <span class="s5">// If called from an script element directly (during the first tick),</span>
      <span class="s5">// the new elements are inserted right after that element.</span>
      <span class="s3">const </span><span class="s2">tempDiv </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">createElement</span><span class="s1">(</span><span class="s0">&quot;div&quot;</span><span class="s1">);</span>
      <span class="s2">tempDiv</span><span class="s1">.</span><span class="s2">innerHTML </span><span class="s1">= </span><span class="s2">text</span><span class="s1">;</span>

      <span class="s3">let </span><span class="s2">child </span><span class="s1">= </span><span class="s2">tempDiv</span><span class="s1">.</span><span class="s2">firstChild</span><span class="s1">;</span>
      <span class="s3">let </span><span class="s2">previous </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_writeAfterElement</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">parent </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_writeAfterElement</span><span class="s1">.</span><span class="s2">parentNode</span><span class="s1">;</span>

      <span class="s3">while </span><span class="s1">(</span><span class="s2">child</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">node </span><span class="s1">= </span><span class="s2">child</span><span class="s1">;</span>
        <span class="s2">child </span><span class="s1">= </span><span class="s2">child</span><span class="s1">.</span><span class="s2">nextSibling</span><span class="s1">;</span>

        <span class="s2">node</span><span class="s1">.</span><span class="s2">_isMovingDueToDocumentWrite </span><span class="s1">= </span><span class="s3">true</span><span class="s1">; </span><span class="s5">// hack for script execution</span>
        <span class="s2">parent</span><span class="s1">.</span><span class="s2">insertBefore</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">previous</span><span class="s1">.</span><span class="s2">nextSibling</span><span class="s1">);</span>
        <span class="s2">node</span><span class="s1">.</span><span class="s2">_isMovingDueToDocumentWrite </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

        <span class="s2">previous </span><span class="s1">= </span><span class="s2">node</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">readyState </span><span class="s1">=== </span><span class="s0">&quot;loading&quot;</span><span class="s1">) {</span>
      <span class="s5">// During page loading, document.write appends to the current element</span>
      <span class="s5">// Find the last child that has been added to the document.</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">lastChild</span><span class="s1">) {</span>
        <span class="s3">let </span><span class="s2">node </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">lastChild </span><span class="s1">&amp;&amp; </span><span class="s2">node</span><span class="s1">.</span><span class="s2">lastChild</span><span class="s1">.</span><span class="s2">nodeType </span><span class="s1">=== </span><span class="s2">NODE_TYPE</span><span class="s1">.</span><span class="s2">ELEMENT_NODE</span><span class="s1">) {</span>
          <span class="s2">node </span><span class="s1">= </span><span class="s2">node</span><span class="s1">.</span><span class="s2">lastChild</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">node</span><span class="s1">.</span><span class="s2">innerHTML </span><span class="s1">= </span><span class="s2">text</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">clearChildNodes</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
        <span class="s2">parseIntoDocument</span><span class="s1">(</span><span class="s2">text</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">text</span><span class="s1">) {</span>
      <span class="s2">clearChildNodes</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
      <span class="s2">parseIntoDocument</span><span class="s1">(</span><span class="s2">text</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">writeln</span><span class="s1">(</span><span class="s2">...args</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s2">...args</span><span class="s1">, </span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s5">// This is implemented separately for Document (which has a _ids cache) and DocumentFragment (which does not).</span>
  <span class="s2">getElementById</span><span class="s1">(</span><span class="s2">id</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_ids</span><span class="s1">[</span><span class="s2">id</span><span class="s1">]) {</span>
      <span class="s3">return null</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s5">// Let's find the first element with where it's root is the document.</span>
    <span class="s3">const </span><span class="s2">matchElement </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_ids</span><span class="s1">[</span><span class="s2">id</span><span class="s1">].</span><span class="s2">find</span><span class="s1">(</span><span class="s2">candidate </span><span class="s1">=&gt; {</span>
      <span class="s3">let </span><span class="s2">root </span><span class="s1">= </span><span class="s2">candidate</span><span class="s1">;</span>
      <span class="s3">while </span><span class="s1">(</span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">(</span><span class="s2">root</span><span class="s1">)) {</span>
        <span class="s2">root </span><span class="s1">= </span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">(</span><span class="s2">root</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">return </span><span class="s2">root </span><span class="s1">=== </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s1">});</span>

    <span class="s3">return </span><span class="s2">matchElement </span><span class="s1">|| </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get referrer</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_referrer </span><span class="s1">|| </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">get lastModified</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_lastModified</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">get images</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">getElementsByTagName</span><span class="s1">(</span><span class="s0">&quot;IMG&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s2">get embeds</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">getElementsByTagName</span><span class="s1">(</span><span class="s0">&quot;EMBED&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s2">get plugins</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">embeds</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">get links</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">HTMLCollection</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">element</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">query</span><span class="s1">: () =&gt; </span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">treeToArray</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, {</span>
        <span class="s2">filter</span><span class="s1">: </span><span class="s2">node </span><span class="s1">=&gt; (</span><span class="s2">node</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">=== </span><span class="s0">&quot;a&quot; </span><span class="s1">|| </span><span class="s2">node</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">=== </span><span class="s0">&quot;area&quot;</span><span class="s1">) &amp;&amp;</span>
                        <span class="s2">node</span><span class="s1">.</span><span class="s2">hasAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;href&quot;</span><span class="s1">) &amp;&amp;</span>
                        <span class="s2">node</span><span class="s1">.</span><span class="s2">_namespaceURI </span><span class="s1">=== </span><span class="s2">HTML_NS</span>
      <span class="s1">})</span>
    <span class="s1">});</span>
  <span class="s1">}</span>
  <span class="s2">get forms</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">getElementsByTagName</span><span class="s1">(</span><span class="s0">&quot;FORM&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s2">get scripts</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">getElementsByTagName</span><span class="s1">(</span><span class="s0">&quot;SCRIPT&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s2">get anchors</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">HTMLCollection</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">element</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">query</span><span class="s1">: () =&gt; </span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">treeToArray</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, {</span>
        <span class="s2">filter</span><span class="s1">: </span><span class="s2">node </span><span class="s1">=&gt; </span><span class="s2">node</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">=== </span><span class="s0">&quot;a&quot; </span><span class="s1">&amp;&amp;</span>
                        <span class="s2">node</span><span class="s1">.</span><span class="s2">hasAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;name&quot;</span><span class="s1">) &amp;&amp;</span>
                        <span class="s2">node</span><span class="s1">.</span><span class="s2">_namespaceURI </span><span class="s1">=== </span><span class="s2">HTML_NS</span>
      <span class="s1">})</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s5">// The applets attribute must return an</span>
  <span class="s5">// HTMLCollection rooted at the Document node,</span>
  <span class="s5">// whose filter matches nothing.</span>
  <span class="s5">// (It exists for historical reasons.)</span>
  <span class="s2">get applets</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">HTMLCollection</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">element</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">query</span><span class="s1">: () =&gt; []</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">open</span><span class="s1">() {</span>
    <span class="s3">let </span><span class="s2">child </span><span class="s1">= </span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">firstChild</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
    <span class="s3">while </span><span class="s1">(</span><span class="s2">child</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">removeChild</span><span class="s1">(</span><span class="s2">child</span><span class="s1">);</span>
      <span class="s2">child </span><span class="s1">= </span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">firstChild</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_modified</span><span class="s1">();</span>
    <span class="s3">return this</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">close</span><span class="s1">(</span><span class="s2">noQueue</span><span class="s1">) {</span>
    <span class="s5">// In some cases like when creating an empty iframe, I want to emit the</span>
    <span class="s5">// events right away to avoid problems if later I asign the property src.</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">noQueue</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">readyState </span><span class="s1">= </span><span class="s0">&quot;complete&quot;</span><span class="s1">;</span>

      <span class="s2">fireAnEvent</span><span class="s1">(</span><span class="s0">&quot;DOMContentLoaded&quot;</span><span class="s1">, </span><span class="s3">this</span><span class="s1">, </span><span class="s2">undefined</span><span class="s1">, { </span><span class="s2">bubbles</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>
      <span class="s2">fireAnEvent</span><span class="s1">(</span><span class="s0">&quot;load&quot;</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>

      <span class="s3">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_queue</span><span class="s1">.</span><span class="s2">resume</span><span class="s1">();</span>

    <span class="s3">const </span><span class="s2">dummyPromise </span><span class="s1">= </span><span class="s2">Promise</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">();</span>

    <span class="s3">const </span><span class="s2">onDOMContentLoad </span><span class="s1">= () =&gt; {</span>
      <span class="s3">const </span><span class="s2">doc </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
      <span class="s3">function </span><span class="s2">dispatchEvent</span><span class="s1">() {</span>
        <span class="s5">// https://html.spec.whatwg.org/#the-end</span>
        <span class="s2">doc</span><span class="s1">.</span><span class="s2">readyState </span><span class="s1">= </span><span class="s0">&quot;interactive&quot;</span><span class="s1">;</span>
        <span class="s2">fireAnEvent</span><span class="s1">(</span><span class="s0">&quot;DOMContentLoaded&quot;</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">undefined</span><span class="s1">, { </span><span class="s2">bubbles</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>
      <span class="s1">}</span>

      <span class="s3">return new </span><span class="s2">Promise</span><span class="s1">(</span><span class="s2">resolve </span><span class="s1">=&gt; {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_deferQueue</span><span class="s1">.</span><span class="s2">tail</span><span class="s1">) {</span>
          <span class="s2">dispatchEvent</span><span class="s1">();</span>
          <span class="s2">resolve</span><span class="s1">();</span>
          <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">_deferQueue</span><span class="s1">.</span><span class="s2">setListener</span><span class="s1">(() =&gt; {</span>
          <span class="s2">dispatchEvent</span><span class="s1">();</span>
          <span class="s2">resolve</span><span class="s1">();</span>
        <span class="s1">});</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">_deferQueue</span><span class="s1">.</span><span class="s2">resume</span><span class="s1">();</span>
      <span class="s1">});</span>
    <span class="s1">};</span>

    <span class="s3">const </span><span class="s2">onLoad </span><span class="s1">= () =&gt; {</span>
      <span class="s3">const </span><span class="s2">doc </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
      <span class="s3">function </span><span class="s2">dispatchEvent</span><span class="s1">() {</span>
        <span class="s2">doc</span><span class="s1">.</span><span class="s2">readyState </span><span class="s1">= </span><span class="s0">&quot;complete&quot;</span><span class="s1">;</span>
        <span class="s2">fireAnEvent</span><span class="s1">(</span><span class="s0">&quot;load&quot;</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">return new </span><span class="s2">Promise</span><span class="s1">(</span><span class="s2">resolve </span><span class="s1">=&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_asyncQueue</span><span class="s1">.</span><span class="s2">count</span><span class="s1">() === </span><span class="s4">0</span><span class="s1">) {</span>
          <span class="s2">dispatchEvent</span><span class="s1">();</span>
          <span class="s2">resolve</span><span class="s1">();</span>
          <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">_asyncQueue</span><span class="s1">.</span><span class="s2">setListener</span><span class="s1">(() =&gt; {</span>
          <span class="s2">dispatchEvent</span><span class="s1">();</span>
          <span class="s2">resolve</span><span class="s1">();</span>
        <span class="s1">});</span>
      <span class="s1">});</span>
    <span class="s1">};</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_queue</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">dummyPromise</span><span class="s1">, </span><span class="s2">onDOMContentLoad</span><span class="s1">, </span><span class="s3">null</span><span class="s1">);</span>
    <span class="s5">// Set the readyState to 'complete' once all resources are loaded.</span>
    <span class="s5">// As a side-effect the document's load-event will be dispatched.</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_queue</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">dummyPromise</span><span class="s1">, </span><span class="s2">onLoad</span><span class="s1">, </span><span class="s3">null</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">getElementsByName</span><span class="s1">(</span><span class="s2">elementName</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">NodeList</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">element</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">query</span><span class="s1">: () =&gt; </span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">treeToArray</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, {</span>
        <span class="s2">filter</span><span class="s1">: </span><span class="s2">node </span><span class="s1">=&gt; </span><span class="s2">node</span><span class="s1">.</span><span class="s2">getAttributeNS </span><span class="s1">&amp;&amp; </span><span class="s2">node</span><span class="s1">.</span><span class="s2">getAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;name&quot;</span><span class="s1">) === </span><span class="s2">elementName</span>
      <span class="s1">})</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">get title</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">documentElement </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">value </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">documentElement </span><span class="s1">&amp;&amp; </span><span class="s2">documentElement</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">=== </span><span class="s0">&quot;svg&quot;</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">svgTitleElement </span><span class="s1">= </span><span class="s2">firstChildWithLocalName</span><span class="s1">(</span><span class="s2">documentElement</span><span class="s1">, </span><span class="s0">&quot;title&quot;</span><span class="s1">, </span><span class="s2">SVG_NS</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">svgTitleElement</span><span class="s1">) {</span>
        <span class="s2">value </span><span class="s1">= </span><span class="s2">childTextContent</span><span class="s1">(</span><span class="s2">svgTitleElement</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s2">titleElement </span><span class="s1">= </span><span class="s2">firstDescendantWithLocalName</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">&quot;title&quot;</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">titleElement</span><span class="s1">) {</span>
        <span class="s2">value </span><span class="s1">= </span><span class="s2">childTextContent</span><span class="s1">(</span><span class="s2">titleElement</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">value </span><span class="s1">= </span><span class="s2">stripAndCollapseASCIIWhitespace</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>

    <span class="s3">return </span><span class="s2">value</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">set title</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">documentElement </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">element</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">documentElement </span><span class="s1">&amp;&amp; </span><span class="s2">documentElement</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">=== </span><span class="s0">&quot;svg&quot;</span><span class="s1">) {</span>
      <span class="s2">element </span><span class="s1">= </span><span class="s2">firstChildWithLocalName</span><span class="s1">(</span><span class="s2">documentElement</span><span class="s1">, </span><span class="s0">&quot;title&quot;</span><span class="s1">, </span><span class="s2">SVG_NS</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(!</span><span class="s2">element</span><span class="s1">) {</span>
        <span class="s2">element </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">createElementNS</span><span class="s1">(</span><span class="s2">SVG_NS</span><span class="s1">, </span><span class="s0">&quot;title&quot;</span><span class="s1">);</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">_insert</span><span class="s1">(</span><span class="s2">element</span><span class="s1">, </span><span class="s2">documentElement</span><span class="s1">.</span><span class="s2">firstChild</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">element</span><span class="s1">.</span><span class="s2">textContent </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">documentElement </span><span class="s1">&amp;&amp; </span><span class="s2">documentElement</span><span class="s1">.</span><span class="s2">_namespaceURI </span><span class="s1">=== </span><span class="s2">HTML_NS</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">titleElement </span><span class="s1">= </span><span class="s2">firstDescendantWithLocalName</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">&quot;title&quot;</span><span class="s1">);</span>
      <span class="s3">const </span><span class="s2">headElement </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">head</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">titleElement </span><span class="s1">=== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">headElement </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
        <span class="s3">return</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">titleElement </span><span class="s1">!== </span><span class="s3">null</span><span class="s1">) {</span>
        <span class="s2">element </span><span class="s1">= </span><span class="s2">titleElement</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">element </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">createElement</span><span class="s1">(</span><span class="s0">&quot;title&quot;</span><span class="s1">);</span>
        <span class="s2">headElement</span><span class="s1">.</span><span class="s2">_append</span><span class="s1">(</span><span class="s2">element</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">element</span><span class="s1">.</span><span class="s2">textContent </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">get dir</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">documentElement </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">documentElement</span><span class="s1">.</span><span class="s2">dir </span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">set dir</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">documentElement</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">documentElement</span><span class="s1">.</span><span class="s2">dir </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">get head</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">documentElement </span><span class="s1">? </span><span class="s2">firstChildWithLocalName</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">documentElement</span><span class="s1">, </span><span class="s0">&quot;head&quot;</span><span class="s1">) : </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get body</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">documentElement </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">documentElement </span><span class="s1">|| </span><span class="s2">documentElement</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">!== </span><span class="s0">&quot;html&quot; </span><span class="s1">||</span>
        <span class="s2">documentElement</span><span class="s1">.</span><span class="s2">_namespaceURI </span><span class="s1">!== </span><span class="s2">HTML_NS</span><span class="s1">) {</span>
      <span class="s3">return null</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">firstChildWithLocalNames</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">documentElement</span><span class="s1">, </span><span class="s3">new </span><span class="s2">Set</span><span class="s1">([</span><span class="s0">&quot;body&quot;</span><span class="s1">, </span><span class="s0">&quot;frameset&quot;</span><span class="s1">]));</span>
  <span class="s1">}</span>

  <span class="s2">set body</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">value </span><span class="s1">=== </span><span class="s3">null </span><span class="s1">||</span>
        <span class="s2">value</span><span class="s1">.</span><span class="s2">_namespaceURI </span><span class="s1">!== </span><span class="s2">HTML_NS </span><span class="s1">||</span>
        <span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">!== </span><span class="s0">&quot;body&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">value</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">!== </span><span class="s0">&quot;frameset&quot;</span><span class="s1">)) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Cannot set the body to null or a non-body/frameset element&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;HierarchyRequestError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">bodyElement </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">body</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">value </span><span class="s1">=== </span><span class="s2">bodyElement</span><span class="s1">) {</span>
      <span class="s3">return</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">bodyElement </span><span class="s1">!== </span><span class="s3">null</span><span class="s1">) {</span>
      <span class="s2">bodyElement</span><span class="s1">.</span><span class="s2">parentNode</span><span class="s1">.</span><span class="s2">_replace</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">bodyElement</span><span class="s1">);</span>
      <span class="s3">return</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s1">{ </span><span class="s2">documentElement </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">documentElement </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Cannot set the body when there is no document element&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;HierarchyRequestError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s2">documentElement</span><span class="s1">.</span><span class="s2">_append</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">_runPreRemovingSteps</span><span class="s1">(</span><span class="s2">oldNode</span><span class="s1">) {</span>
    <span class="s5">// https://html.spec.whatwg.org/#focus-fixup-rule</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">oldNode </span><span class="s1">=== </span><span class="s3">this</span><span class="s1">.</span><span class="s2">activeElement</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_lastFocusedElement </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">body</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">activeNodeIterator of </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_workingNodeIterators</span><span class="s1">) {</span>
      <span class="s2">activeNodeIterator</span><span class="s1">.</span><span class="s2">_preRemovingSteps</span><span class="s1">(</span><span class="s2">oldNode</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">createEvent</span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">typeLower </span><span class="s1">= </span><span class="s2">type</span><span class="s1">.</span><span class="s2">toLowerCase</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s2">eventWrapper </span><span class="s1">= </span><span class="s2">eventInterfaceTable</span><span class="s1">[</span><span class="s2">typeLower</span><span class="s1">] || </span><span class="s3">null</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">eventWrapper</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;The provided event type (</span><span class="s3">\&quot;</span><span class="s0">&quot; </span><span class="s1">+ </span><span class="s2">type </span><span class="s1">+ </span><span class="s0">&quot;</span><span class="s3">\&quot;</span><span class="s0">) is invalid&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;NotSupportedError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">impl </span><span class="s1">= </span><span class="s2">eventWrapper</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span><span class="s0">&quot;&quot;</span><span class="s1">]);</span>
    <span class="s2">impl</span><span class="s1">.</span><span class="s2">_initializedFlag </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">impl</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">createRange</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">Range</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">start</span><span class="s1">: { </span><span class="s2">node</span><span class="s1">: </span><span class="s3">this</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">: </span><span class="s4">0 </span><span class="s1">},</span>
      <span class="s2">end</span><span class="s1">: { </span><span class="s2">node</span><span class="s1">: </span><span class="s3">this</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">: </span><span class="s4">0 </span><span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">createProcessingInstruction</span><span class="s1">(</span><span class="s2">target</span><span class="s1">, </span><span class="s2">data</span><span class="s1">) {</span>
    <span class="s2">validateName</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, </span><span class="s2">target</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">data</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">&quot;?&gt;&quot;</span><span class="s1">)) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Processing instruction data cannot contain the string </span><span class="s3">\&quot;</span><span class="s0">?&gt;</span><span class="s3">\&quot;</span><span class="s0">&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;InvalidCharacterError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">ProcessingInstruction</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">ownerDocument</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">target</span><span class="s1">,</span>
      <span class="s2">data</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s5">// https://dom.spec.whatwg.org/#dom-document-createcdatasection</span>
  <span class="s2">createCDATASection</span><span class="s1">(</span><span class="s2">data</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_parsingMode </span><span class="s1">=== </span><span class="s0">&quot;html&quot;</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Cannot create CDATA sections in HTML documents&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;NotSupportedError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">data</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">&quot;]]&gt;&quot;</span><span class="s1">)) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;CDATA section data cannot contain the string </span><span class="s3">\&quot;</span><span class="s0">]]&gt;</span><span class="s3">\&quot;</span><span class="s0">&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;InvalidCharacterError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">CDATASection</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">ownerDocument</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">data</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">createTextNode</span><span class="s1">(</span><span class="s2">data</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">Text</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">ownerDocument</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">data</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">createComment</span><span class="s1">(</span><span class="s2">data</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">Comment</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">ownerDocument</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">data</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s5">// https://dom.spec.whatwg.org/#dom-document-createelement</span>
  <span class="s2">createElement</span><span class="s1">(</span><span class="s2">localName</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s2">validateName</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, </span><span class="s2">localName</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_parsingMode </span><span class="s1">=== </span><span class="s0">&quot;html&quot;</span><span class="s1">) {</span>
      <span class="s2">localName </span><span class="s1">= </span><span class="s2">asciiLowercase</span><span class="s1">(</span><span class="s2">localName</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">let </span><span class="s2">isValue </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">is </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s2">isValue </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">is</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">namespace </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_parsingMode </span><span class="s1">=== </span><span class="s0">&quot;html&quot; </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contentType </span><span class="s1">=== </span><span class="s0">&quot;application/xhtml+xml&quot; </span><span class="s1">? </span><span class="s2">HTML_NS </span><span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>

    <span class="s3">return </span><span class="s2">createElement</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">localName</span><span class="s1">, </span><span class="s2">namespace</span><span class="s1">, </span><span class="s3">null</span><span class="s1">, </span><span class="s2">isValue</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s5">// https://dom.spec.whatwg.org/#dom-document-createelementns</span>
  <span class="s2">createElementNS</span><span class="s1">(</span><span class="s2">namespace</span><span class="s1">, </span><span class="s2">qualifiedName</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">internalCreateElementNSSteps</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">namespace</span><span class="s1">, </span><span class="s2">qualifiedName</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">createDocumentFragment</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">DocumentFragment</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], { </span><span class="s2">ownerDocument</span><span class="s1">: </span><span class="s3">this </span><span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">createAttribute</span><span class="s1">(</span><span class="s2">localName</span><span class="s1">) {</span>
    <span class="s2">validateName</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, </span><span class="s2">localName</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_parsingMode </span><span class="s1">=== </span><span class="s0">&quot;html&quot;</span><span class="s1">) {</span>
      <span class="s2">localName </span><span class="s1">= </span><span class="s2">asciiLowercase</span><span class="s1">(</span><span class="s2">localName</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_createAttribute</span><span class="s1">({ </span><span class="s2">localName </span><span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">createAttributeNS</span><span class="s1">(</span><span class="s2">namespace</span><span class="s1">, </span><span class="s2">name</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">namespace </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s2">namespace </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">namespace </span><span class="s1">= </span><span class="s2">namespace </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">? </span><span class="s2">String</span><span class="s1">(</span><span class="s2">namespace</span><span class="s1">) : </span><span class="s2">namespace</span><span class="s1">;</span>

    <span class="s3">const </span><span class="s2">extracted </span><span class="s1">= </span><span class="s2">validateAndExtract</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, </span><span class="s2">namespace</span><span class="s1">, </span><span class="s2">name</span><span class="s1">);</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_createAttribute</span><span class="s1">({</span>
      <span class="s2">namespace</span><span class="s1">: </span><span class="s2">extracted</span><span class="s1">.</span><span class="s2">namespace</span><span class="s1">,</span>
      <span class="s2">namespacePrefix</span><span class="s1">: </span><span class="s2">extracted</span><span class="s1">.</span><span class="s2">prefix</span><span class="s1">,</span>
      <span class="s2">localName</span><span class="s1">: </span><span class="s2">extracted</span><span class="s1">.</span><span class="s2">localName</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s5">// Using this helper function rather than directly calling generatedAttr.createImpl may be preferred in some files,</span>
  <span class="s5">// to avoid introducing a potentially cyclic dependency on generated/Attr.js.</span>
  <span class="s2">_createAttribute</span><span class="s1">({</span>
    <span class="s2">localName</span><span class="s1">,</span>
    <span class="s2">value</span><span class="s1">,</span>
    <span class="s2">namespace</span><span class="s1">,</span>
    <span class="s2">namespacePrefix</span>
  <span class="s1">}) {</span>
    <span class="s3">return </span><span class="s2">generatedAttr</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">localName</span><span class="s1">,</span>
      <span class="s2">value</span><span class="s1">,</span>
      <span class="s2">namespace</span><span class="s1">,</span>
      <span class="s2">namespacePrefix</span><span class="s1">,</span>
      <span class="s2">ownerDocument</span><span class="s1">: </span><span class="s3">this</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">createTreeWalker</span><span class="s1">(</span><span class="s2">root</span><span class="s1">, </span><span class="s2">whatToShow</span><span class="s1">, </span><span class="s2">filter</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">TreeWalker</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], { </span><span class="s2">root</span><span class="s1">, </span><span class="s2">whatToShow</span><span class="s1">, </span><span class="s2">filter </span><span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">createNodeIterator</span><span class="s1">(</span><span class="s2">root</span><span class="s1">, </span><span class="s2">whatToShow</span><span class="s1">, </span><span class="s2">filter</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">nodeIterator </span><span class="s1">= </span><span class="s2">NodeIterator</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], { </span><span class="s2">root</span><span class="s1">, </span><span class="s2">whatToShow</span><span class="s1">, </span><span class="s2">filter </span><span class="s1">});</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">hasWeakRefs</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_workingNodeIterators</span><span class="s1">.</span><span class="s2">add</span><span class="s1">(</span><span class="s2">nodeIterator</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_workingNodeIterators</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">nodeIterator</span><span class="s1">);</span>
      <span class="s3">while </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_workingNodeIterators</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">10</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">toInactivate </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_workingNodeIterators</span><span class="s1">.</span><span class="s2">shift</span><span class="s1">();</span>
        <span class="s2">toInactivate</span><span class="s1">.</span><span class="s2">_working </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">nodeIterator</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">importNode</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">deep</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">nodeType </span><span class="s1">=== </span><span class="s2">NODE_TYPE</span><span class="s1">.</span><span class="s2">DOCUMENT_NODE</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Cannot import a document node&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;NotSupportedError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">ShadowRoot</span><span class="s1">.</span><span class="s2">isImpl</span><span class="s1">(</span><span class="s2">node</span><span class="s1">)) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Cannot adopt a shadow root&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;NotSupportedError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">clone</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s3">this</span><span class="s1">, </span><span class="s2">deep</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s5">// https://dom.spec.whatwg.org/#dom-document-adoptnode</span>
  <span class="s2">adoptNode</span><span class="s1">(</span><span class="s2">node</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">nodeType </span><span class="s1">=== </span><span class="s2">NODE_TYPE</span><span class="s1">.</span><span class="s2">DOCUMENT_NODE</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Cannot adopt a document node&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;NotSupportedError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">ShadowRoot</span><span class="s1">.</span><span class="s2">isImpl</span><span class="s1">(</span><span class="s2">node</span><span class="s1">)) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [</span>
        <span class="s0">&quot;Cannot adopt a shadow root&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;HierarchyRequestError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">_adoptNode</span><span class="s1">(</span><span class="s2">node</span><span class="s1">);</span>

    <span class="s3">return </span><span class="s2">node</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s5">// https://dom.spec.whatwg.org/#concept-node-adopt</span>
  <span class="s2">_adoptNode</span><span class="s1">(</span><span class="s2">node</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">newDocument </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">oldDocument </span><span class="s1">= </span><span class="s2">node</span><span class="s1">.</span><span class="s2">_ownerDocument</span><span class="s1">;</span>

    <span class="s3">const </span><span class="s2">parent </span><span class="s1">= </span><span class="s2">domSymbolTree</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">(</span><span class="s2">node</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">parent</span><span class="s1">) {</span>
      <span class="s2">parent</span><span class="s1">.</span><span class="s2">_remove</span><span class="s1">(</span><span class="s2">node</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">oldDocument </span><span class="s1">!== </span><span class="s2">newDocument</span><span class="s1">) {</span>
      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">inclusiveDescendant of shadowIncludingInclusiveDescendantsIterator</span><span class="s1">(</span><span class="s2">node</span><span class="s1">)) {</span>
        <span class="s2">inclusiveDescendant</span><span class="s1">.</span><span class="s2">_ownerDocument </span><span class="s1">= </span><span class="s2">newDocument</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">inclusiveDescendant of shadowIncludingInclusiveDescendantsIterator</span><span class="s1">(</span><span class="s2">node</span><span class="s1">)) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">inclusiveDescendant</span><span class="s1">.</span><span class="s2">_ceState </span><span class="s1">=== </span><span class="s0">&quot;custom&quot;</span><span class="s1">) {</span>
          <span class="s2">enqueueCECallbackReaction</span><span class="s1">(</span><span class="s2">inclusiveDescendant</span><span class="s1">, </span><span class="s0">&quot;adoptedCallback&quot;</span><span class="s1">, [</span>
            <span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">wrapperForImpl</span><span class="s1">(</span><span class="s2">oldDocument</span><span class="s1">),</span>
            <span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">wrapperForImpl</span><span class="s1">(</span><span class="s2">newDocument</span><span class="s1">)</span>
          <span class="s1">]);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">inclusiveDescendant of shadowIncludingInclusiveDescendantsIterator</span><span class="s1">(</span><span class="s2">node</span><span class="s1">)) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">inclusiveDescendant</span><span class="s1">.</span><span class="s2">_adoptingSteps</span><span class="s1">) {</span>
          <span class="s2">inclusiveDescendant</span><span class="s1">.</span><span class="s2">_adoptingSteps</span><span class="s1">(</span><span class="s2">oldDocument</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">get cookie</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_cookieJar</span><span class="s1">.</span><span class="s2">getCookieStringSync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">URL</span><span class="s1">, { </span><span class="s2">http</span><span class="s1">: </span><span class="s3">false </span><span class="s1">});</span>
  <span class="s1">}</span>
  <span class="s2">set cookie</span><span class="s1">(</span><span class="s2">cookieStr</span><span class="s1">) {</span>
    <span class="s2">cookieStr </span><span class="s1">= </span><span class="s2">String</span><span class="s1">(</span><span class="s2">cookieStr</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_cookieJar</span><span class="s1">.</span><span class="s2">setCookieSync</span><span class="s1">(</span><span class="s2">cookieStr</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">URL</span><span class="s1">, {</span>
      <span class="s2">http</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
      <span class="s2">ignoreError</span><span class="s1">: </span><span class="s3">true</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s5">// The clear(), captureEvents(), and releaseEvents() methods must do nothing</span>
  <span class="s2">clear</span><span class="s1">() {}</span>

  <span class="s2">captureEvents</span><span class="s1">() {}</span>

  <span class="s2">releaseEvents</span><span class="s1">() {}</span>

  <span class="s2">get styleSheets</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_styleSheets</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_styleSheets </span><span class="s1">= </span><span class="s2">StyleSheetList</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s5">// TODO: each style and link element should register its sheet on creation</span>
    <span class="s5">// and remove it on removal.</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_styleSheets</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get hidden</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_defaultView </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_defaultView</span><span class="s1">.</span><span class="s2">_pretendToBeVisual</span><span class="s1">) {</span>
      <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return true</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get visibilityState</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_defaultView </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_defaultView</span><span class="s1">.</span><span class="s2">_pretendToBeVisual</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s0">&quot;visible&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s0">&quot;prerender&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s5">// https://w3c.github.io/selection-api/#extensions-to-document-interface</span>
  <span class="s2">getSelection</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">_defaultView </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_defaultView</span><span class="s1">.</span><span class="s2">_selection </span><span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s5">// Needed to ensure that the resulting document has the correct prototype chain:</span>
  <span class="s5">// https://dom.spec.whatwg.org/#concept-node-clone says &quot;that implements the same interfaces as node&quot;.</span>
  <span class="s2">_cloneDocument</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s2">copy </span><span class="s1">= </span><span class="s2">documents</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">,</span>
      <span class="s1">{</span>
        <span class="s2">contentType</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contentType</span><span class="s1">,</span>
        <span class="s2">encoding</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_encoding</span><span class="s1">,</span>
        <span class="s2">parsingMode</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_parsingMode</span>
      <span class="s1">}</span>
    <span class="s1">);</span>

    <span class="s2">copy</span><span class="s1">.</span><span class="s2">_URL </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_URL</span><span class="s1">;</span>
    <span class="s2">copy</span><span class="s1">.</span><span class="s2">_origin </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_origin</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">copy</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">eventAccessors</span><span class="s1">.</span><span class="s2">createEventAccessor</span><span class="s1">(</span><span class="s2">DocumentImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">, </span><span class="s0">&quot;readystatechange&quot;</span><span class="s1">);</span>
<span class="s2">mixin</span><span class="s1">(</span><span class="s2">DocumentImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">, </span><span class="s2">DocumentOrShadowRootImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">);</span>
<span class="s2">mixin</span><span class="s1">(</span><span class="s2">DocumentImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">, </span><span class="s2">GlobalEventHandlersImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">);</span>
<span class="s2">mixin</span><span class="s1">(</span><span class="s2">DocumentImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">, </span><span class="s2">NonElementParentNodeImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">);</span>
<span class="s2">mixin</span><span class="s1">(</span><span class="s2">DocumentImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">, </span><span class="s2">ParentNodeImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">);</span>

<span class="s2">DocumentImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getElementsByTagName </span><span class="s1">= </span><span class="s2">memoizeQuery</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">qualifiedName</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s2">listOfElementsWithQualifiedName</span><span class="s1">(</span><span class="s2">qualifiedName</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
<span class="s1">});</span>

<span class="s2">DocumentImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getElementsByTagNameNS </span><span class="s1">= </span><span class="s2">memoizeQuery</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">namespace</span><span class="s1">, </span><span class="s2">localName</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s2">listOfElementsWithNamespaceAndLocalName</span><span class="s1">(</span><span class="s2">namespace</span><span class="s1">, </span><span class="s2">localName</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
<span class="s1">});</span>

<span class="s2">DocumentImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getElementsByClassName </span><span class="s1">= </span><span class="s2">memoizeQuery</span><span class="s1">(</span><span class="s3">function </span><span class="s2">getElementsByClassName</span><span class="s1">(</span><span class="s2">classNames</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s2">listOfElementsWithClassNames</span><span class="s1">(</span><span class="s2">classNames</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
<span class="s1">});</span>

<span class="s2">module</span><span class="s1">.</span><span class="s2">exports </span><span class="s1">= {</span>
  <span class="s2">implementation</span><span class="s1">: </span><span class="s2">DocumentImpl</span>
<span class="s1">};</span>
</pre>
</body>
</html>