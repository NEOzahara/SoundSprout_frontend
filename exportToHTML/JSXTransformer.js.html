<html>
<head>
<title>JSXTransformer.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
JSXTransformer.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span><span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">exports</span><span class="s1">, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, {</span><span class="s2">value</span><span class="s1">: </span><span class="s3">true</span><span class="s1">}); </span><span class="s3">function </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">) { </span><span class="s3">return </span><span class="s2">obj </span><span class="s1">&amp;&amp; </span><span class="s2">obj</span><span class="s1">.</span><span class="s2">__esModule </span><span class="s1">? </span><span class="s2">obj </span><span class="s1">: { </span><span class="s3">default</span><span class="s1">: </span><span class="s2">obj </span><span class="s1">}; }</span>


<span class="s3">var </span><span class="s2">_xhtml </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../parser/plugins/jsx/xhtml'</span><span class="s1">); </span><span class="s3">var </span><span class="s2">_xhtml2 </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">_xhtml</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">_tokenizer </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../parser/tokenizer'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">_types </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../parser/tokenizer/types'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">_charcodes </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../parser/util/charcodes'</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">_getJSXPragmaInfo </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../util/getJSXPragmaInfo'</span><span class="s1">); </span><span class="s3">var </span><span class="s2">_getJSXPragmaInfo2 </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">_getJSXPragmaInfo</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">_Transformer </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./Transformer'</span><span class="s1">); </span><span class="s3">var </span><span class="s2">_Transformer2 </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">_Transformer</span><span class="s1">);</span>

 <span class="s3">class </span><span class="s2">JSXTransformer </span><span class="s3">extends </span><span class="s2">_Transformer2</span><span class="s1">.</span><span class="s2">default </span><span class="s1">{</span>
  
  
  

  <span class="s4">// State for calculating the line number of each JSX tag in development.</span>
  <span class="s2">__init</span><span class="s1">() {</span><span class="s3">this</span><span class="s1">.</span><span class="s2">lastLineNumber </span><span class="s1">= </span><span class="s5">1</span><span class="s1">}</span>
  <span class="s2">__init2</span><span class="s1">() {</span><span class="s3">this</span><span class="s1">.</span><span class="s2">lastIndex </span><span class="s1">= </span><span class="s5">0</span><span class="s1">}</span>

  <span class="s4">// In development, variable name holding the name of the current file.</span>
  <span class="s2">__init3</span><span class="s1">() {</span><span class="s3">this</span><span class="s1">.</span><span class="s2">filenameVarName </span><span class="s1">= </span><span class="s3">null</span><span class="s1">}</span>
  <span class="s4">// Mapping of claimed names for imports in the automatic transform, e,g.</span>
  <span class="s4">// {jsx: &quot;_jsx&quot;}. This determines which imports to generate in the prefix.</span>
  <span class="s2">__init4</span><span class="s1">() {</span><span class="s3">this</span><span class="s1">.</span><span class="s2">esmAutomaticImportNameResolutions </span><span class="s1">= {}}</span>
  <span class="s4">// When automatically adding imports in CJS mode, we store the variable name</span>
  <span class="s4">// holding the imported CJS module so we can require it in the prefix.</span>
  <span class="s2">__init5</span><span class="s1">() {</span><span class="s3">this</span><span class="s1">.</span><span class="s2">cjsAutomaticModuleNameResolutions </span><span class="s1">= {}}</span>

  <span class="s2">constructor</span><span class="s1">(</span>
     <span class="s2">rootTransformer</span><span class="s1">,</span>
     <span class="s2">tokens</span><span class="s1">,</span>
     <span class="s2">importProcessor</span><span class="s1">,</span>
     <span class="s2">nameManager</span><span class="s1">,</span>
     <span class="s2">options</span><span class="s1">,</span>
  <span class="s1">) {</span>
    <span class="s3">super</span><span class="s1">();</span><span class="s3">this</span><span class="s1">.</span><span class="s2">rootTransformer </span><span class="s1">= </span><span class="s2">rootTransformer</span><span class="s1">;</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens </span><span class="s1">= </span><span class="s2">tokens</span><span class="s1">;</span><span class="s3">this</span><span class="s1">.</span><span class="s2">importProcessor </span><span class="s1">= </span><span class="s2">importProcessor</span><span class="s1">;</span><span class="s3">this</span><span class="s1">.</span><span class="s2">nameManager </span><span class="s1">= </span><span class="s2">nameManager</span><span class="s1">;</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span><span class="s2">JSXTransformer</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">__init</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span><span class="s2">JSXTransformer</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">__init2</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span><span class="s2">JSXTransformer</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">__init3</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span><span class="s2">JSXTransformer</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">__init4</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span><span class="s2">JSXTransformer</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">__init5</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">jsxPragmaInfo </span><span class="s1">= </span><span class="s2">_getJSXPragmaInfo2</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">void </span><span class="s5">0</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">isAutomaticRuntime </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">jsxRuntime </span><span class="s1">=== </span><span class="s0">&quot;automatic&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">jsxImportSource </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">jsxImportSource </span><span class="s1">|| </span><span class="s0">&quot;react&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">process</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagStart</span><span class="s1">)) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processJSXTag</span><span class="s1">();</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">getPrefixCode</span><span class="s1">() {</span>
    <span class="s3">let </span><span class="s2">prefix </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">filenameVarName</span><span class="s1">) {</span>
      <span class="s2">prefix </span><span class="s1">+= </span><span class="s0">`const </span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">filenameVarName</span><span class="s1">} </span><span class="s0">= </span><span class="s2">$</span><span class="s1">{</span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filePath </span><span class="s1">|| </span><span class="s0">&quot;&quot;</span><span class="s1">)}</span><span class="s0">;`</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">isAutomaticRuntime</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">importProcessor</span><span class="s1">) {</span>
        <span class="s4">// CJS mode: emit require statements for all modules that were referenced.</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">[</span><span class="s2">path</span><span class="s1">, </span><span class="s2">resolvedName</span><span class="s1">] </span><span class="s2">of Object</span><span class="s1">.</span><span class="s2">entries</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">cjsAutomaticModuleNameResolutions</span><span class="s1">)) {</span>
          <span class="s2">prefix </span><span class="s1">+= </span><span class="s0">`var </span><span class="s2">$</span><span class="s1">{</span><span class="s2">resolvedName</span><span class="s1">} </span><span class="s0">= require(&quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">path</span><span class="s1">}</span><span class="s0">&quot;);`</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s4">// ESM mode: consolidate and emit import statements for referenced names.</span>
        <span class="s3">const </span><span class="s1">{</span><span class="s2">createElement</span><span class="s1">: </span><span class="s2">createElementResolution</span><span class="s1">, </span><span class="s2">...otherResolutions</span><span class="s1">} =</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">esmAutomaticImportNameResolutions</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">createElementResolution</span><span class="s1">) {</span>
          <span class="s2">prefix </span><span class="s1">+= </span><span class="s0">`import {createElement as </span><span class="s2">$</span><span class="s1">{</span><span class="s2">createElementResolution</span><span class="s1">}</span><span class="s0">} from &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">jsxImportSource</span><span class="s1">}</span><span class="s0">&quot;;`</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s2">importSpecifiers </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">entries</span><span class="s1">(</span><span class="s2">otherResolutions</span><span class="s1">)</span>
          <span class="s1">.</span><span class="s2">map</span><span class="s1">(([</span><span class="s2">name</span><span class="s1">, </span><span class="s2">resolvedName</span><span class="s1">]) =&gt; </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">} </span><span class="s0">as </span><span class="s2">$</span><span class="s1">{</span><span class="s2">resolvedName</span><span class="s1">}</span><span class="s0">`</span><span class="s1">)</span>
          <span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">&quot;, &quot;</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">importSpecifiers</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">importPath </span><span class="s1">=</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">jsxImportSource </span><span class="s1">+ (</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">production </span><span class="s1">? </span><span class="s0">&quot;/jsx-runtime&quot; </span><span class="s1">: </span><span class="s0">&quot;/jsx-dev-runtime&quot;</span><span class="s1">);</span>
          <span class="s2">prefix </span><span class="s1">+= </span><span class="s0">`import {</span><span class="s2">$</span><span class="s1">{</span><span class="s2">importSpecifiers</span><span class="s1">}</span><span class="s0">} from &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">importPath</span><span class="s1">}</span><span class="s0">&quot;;`</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">return </span><span class="s2">prefix</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">processJSXTag</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{</span><span class="s2">jsxRole</span><span class="s1">, </span><span class="s2">start</span><span class="s1">} = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">currentToken</span><span class="s1">();</span>
    <span class="s4">// Calculate line number information at the very start (if in development</span>
    <span class="s4">// mode) so that the information is guaranteed to be queried in token order.</span>
    <span class="s3">const </span><span class="s2">elementLocationCode </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">production </span><span class="s1">? </span><span class="s3">null </span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getElementLocationCode</span><span class="s1">(</span><span class="s2">start</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">isAutomaticRuntime </span><span class="s1">&amp;&amp; </span><span class="s2">jsxRole </span><span class="s1">!== </span><span class="s2">_tokenizer</span><span class="s1">.</span><span class="s2">JSXRole</span><span class="s1">.</span><span class="s2">KeyAfterPropSpread</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">transformTagToJSXFunc</span><span class="s1">(</span><span class="s2">elementLocationCode</span><span class="s1">, </span><span class="s2">jsxRole</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">transformTagToCreateElement</span><span class="s1">(</span><span class="s2">elementLocationCode</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">getElementLocationCode</span><span class="s1">(</span><span class="s2">firstTokenStart</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">lineNumber </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLineNumberForIndex</span><span class="s1">(</span><span class="s2">firstTokenStart</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s0">`lineNumber: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">lineNumber</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Get the line number for this source position. This is calculated lazily and</span>
   <span class="s6">* must be called in increasing order by index.</span>
   <span class="s6">*/</span>
  <span class="s2">getLineNumberForIndex</span><span class="s1">(</span><span class="s2">index</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">code </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">code</span><span class="s1">;</span>
    <span class="s3">while </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">lastIndex </span><span class="s1">&lt; </span><span class="s2">index </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">lastIndex </span><span class="s1">&lt; </span><span class="s2">code</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">code</span><span class="s1">[</span><span class="s3">this</span><span class="s1">.</span><span class="s2">lastIndex</span><span class="s1">] === </span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">lastLineNumber</span><span class="s1">++;</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">lastIndex</span><span class="s1">++;</span>
    <span class="s1">}</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">lastLineNumber</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Convert the current JSX element to a call to jsx, jsxs, or jsxDEV. This is</span>
   <span class="s6">* the primary transformation for the automatic transform.</span>
   <span class="s6">*</span>
   <span class="s6">* Example:</span>
   <span class="s6">* &lt;div a={1} key={2}&gt;Hello{x}&lt;/div&gt;</span>
   <span class="s6">* becomes</span>
   <span class="s6">* jsxs('div', {a: 1, children: [&quot;Hello&quot;, x]}, 2)</span>
   <span class="s6">*/</span>
  <span class="s2">transformTagToJSXFunc</span><span class="s1">(</span><span class="s2">elementLocationCode</span><span class="s1">, </span><span class="s2">jsxRole</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">isStatic </span><span class="s1">= </span><span class="s2">jsxRole </span><span class="s1">=== </span><span class="s2">_tokenizer</span><span class="s1">.</span><span class="s2">JSXRole</span><span class="s1">.</span><span class="s2">StaticChildren</span><span class="s1">;</span>
    <span class="s4">// First tag is always jsxTagStart.</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getJSXFuncInvocationCode</span><span class="s1">(</span><span class="s2">isStatic</span><span class="s1">));</span>

    <span class="s3">let </span><span class="s2">keyCode </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">)) {</span>
      <span class="s4">// Fragment syntax.</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFragmentCode</span><span class="s1">()}</span><span class="s0">, {`</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processAutomaticChildrenAndEndProps</span><span class="s1">(</span><span class="s2">jsxRole</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s4">// Normal open tag or self-closing tag.</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processTagIntro</span><span class="s1">();</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot;, {&quot;</span><span class="s1">);</span>
      <span class="s2">keyCode </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">processProps</span><span class="s1">(</span><span class="s3">true</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches2</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">slash</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">)) {</span>
        <span class="s4">// Self-closing tag, no children to add, so close the props.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot;}&quot;</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">)) {</span>
        <span class="s4">// Tag with children.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">removeToken</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">processAutomaticChildrenAndEndProps</span><span class="s1">(</span><span class="s2">jsxRole</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">&quot;Expected either /&gt; or &gt; at the end of the tag.&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s4">// If a key was present, move it to its own arg. Note that moving code</span>
      <span class="s4">// like this will cause line numbers to get out of sync within the JSX</span>
      <span class="s4">// element if the key expression has a newline in it. This is unfortunate,</span>
      <span class="s4">// but hopefully should be rare.</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">keyCode</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">`, </span><span class="s2">$</span><span class="s1">{</span><span class="s2">keyCode</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">production</span><span class="s1">) {</span>
      <span class="s4">// If the key wasn't already added, add it now so we can correctly set</span>
      <span class="s4">// positional args for jsxDEV.</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">keyCode </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot;, void 0&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">`, </span><span class="s2">$</span><span class="s1">{</span><span class="s2">isStatic</span><span class="s1">}</span><span class="s0">, </span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getDevSource</span><span class="s1">(</span><span class="s2">elementLocationCode</span><span class="s1">)}</span><span class="s0">, this`</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s4">// We're at the close-tag or the end of a self-closing tag, so remove</span>
    <span class="s4">// everything else and close the function call.</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">removeInitialToken</span><span class="s1">();</span>
    <span class="s3">while </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">)) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">removeToken</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;)&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Convert the current JSX element to a createElement call. In the classic</span>
   <span class="s6">* runtime, this is the only case. In the automatic runtime, this is called</span>
   <span class="s6">* as a fallback in some situations.</span>
   <span class="s6">*</span>
   <span class="s6">* Example:</span>
   <span class="s6">* &lt;div a={1} key={2}&gt;Hello{x}&lt;/div&gt;</span>
   <span class="s6">* becomes</span>
   <span class="s6">* React.createElement('div', {a: 1, key: 2}, &quot;Hello&quot;, x)</span>
   <span class="s6">*/</span>
  <span class="s2">transformTagToCreateElement</span><span class="s1">(</span><span class="s2">elementLocationCode</span><span class="s1">) {</span>
    <span class="s4">// First tag is always jsxTagStart.</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCreateElementInvocationCode</span><span class="s1">());</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">)) {</span>
      <span class="s4">// Fragment syntax.</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFragmentCode</span><span class="s1">()}</span><span class="s0">, null`</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processChildren</span><span class="s1">(</span><span class="s3">true</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s4">// Normal open tag or self-closing tag.</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processTagIntro</span><span class="s1">();</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processPropsObjectWithDevInfo</span><span class="s1">(</span><span class="s2">elementLocationCode</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches2</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">slash</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">)) {</span>
        <span class="s4">// Self-closing tag; no children to process.</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">)) {</span>
        <span class="s4">// Tag with children and a close-tag; process the children as args.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">removeToken</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">processChildren</span><span class="s1">(</span><span class="s3">true</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">&quot;Expected either /&gt; or &gt; at the end of the tag.&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">// We're at the close-tag or the end of a self-closing tag, so remove</span>
    <span class="s4">// everything else and close the function call.</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">removeInitialToken</span><span class="s1">();</span>
    <span class="s3">while </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">)) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">removeToken</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;)&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Get the code for the relevant function for this context: jsx, jsxs,</span>
   <span class="s6">* or jsxDEV. The following open-paren is included as well.</span>
   <span class="s6">*</span>
   <span class="s6">* These functions are only used for the automatic runtime, so they are always</span>
   <span class="s6">* auto-imported, but the auto-import will be either CJS or ESM based on the</span>
   <span class="s6">* target module format.</span>
   <span class="s6">*/</span>
  <span class="s2">getJSXFuncInvocationCode</span><span class="s1">(</span><span class="s2">isStatic</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">production</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">isStatic</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">claimAutoImportedFuncInvocation</span><span class="s1">(</span><span class="s0">&quot;jsxs&quot;</span><span class="s1">, </span><span class="s0">&quot;/jsx-runtime&quot;</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">claimAutoImportedFuncInvocation</span><span class="s1">(</span><span class="s0">&quot;jsx&quot;</span><span class="s1">, </span><span class="s0">&quot;/jsx-runtime&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">return this</span><span class="s1">.</span><span class="s2">claimAutoImportedFuncInvocation</span><span class="s1">(</span><span class="s0">&quot;jsxDEV&quot;</span><span class="s1">, </span><span class="s0">&quot;/jsx-dev-runtime&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Return the code to use for the createElement function, e.g.</span>
   <span class="s6">* `React.createElement`, including the following open-paren.</span>
   <span class="s6">*</span>
   <span class="s6">* This is the main function to use for the classic runtime. For the</span>
   <span class="s6">* automatic runtime, this function is used as a fallback function to</span>
   <span class="s6">* preserve behavior when there is a prop spread followed by an explicit</span>
   <span class="s6">* key. In that automatic runtime case, the function should be automatically</span>
   <span class="s6">* imported.</span>
   <span class="s6">*/</span>
  <span class="s2">getCreateElementInvocationCode</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">isAutomaticRuntime</span><span class="s1">) {</span>
      <span class="s3">return this</span><span class="s1">.</span><span class="s2">claimAutoImportedFuncInvocation</span><span class="s1">(</span><span class="s0">&quot;createElement&quot;</span><span class="s1">, </span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s1">{</span><span class="s2">jsxPragmaInfo</span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">resolvedPragmaBaseName </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">importProcessor</span>
        <span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">importProcessor</span><span class="s1">.</span><span class="s2">getIdentifierReplacement</span><span class="s1">(</span><span class="s2">jsxPragmaInfo</span><span class="s1">.</span><span class="s2">base</span><span class="s1">) || </span><span class="s2">jsxPragmaInfo</span><span class="s1">.</span><span class="s2">base</span>
        <span class="s1">: </span><span class="s2">jsxPragmaInfo</span><span class="s1">.</span><span class="s2">base</span><span class="s1">;</span>
      <span class="s3">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">resolvedPragmaBaseName</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">jsxPragmaInfo</span><span class="s1">.</span><span class="s2">suffix</span><span class="s1">}</span><span class="s0">(`</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Return the code to use as the component when compiling a shorthand</span>
   <span class="s6">* fragment, e.g. `React.Fragment`.</span>
   <span class="s6">*</span>
   <span class="s6">* This may be called from either the classic or automatic runtime, and</span>
   <span class="s6">* the value should be auto-imported for the automatic runtime.</span>
   <span class="s6">*/</span>
  <span class="s2">getFragmentCode</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">isAutomaticRuntime</span><span class="s1">) {</span>
      <span class="s3">return this</span><span class="s1">.</span><span class="s2">claimAutoImportedName</span><span class="s1">(</span>
        <span class="s0">&quot;Fragment&quot;</span><span class="s1">,</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">production </span><span class="s1">? </span><span class="s0">&quot;/jsx-runtime&quot; </span><span class="s1">: </span><span class="s0">&quot;/jsx-dev-runtime&quot;</span><span class="s1">,</span>
      <span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s1">{</span><span class="s2">jsxPragmaInfo</span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">resolvedFragmentPragmaBaseName </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">importProcessor</span>
        <span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">importProcessor</span><span class="s1">.</span><span class="s2">getIdentifierReplacement</span><span class="s1">(</span><span class="s2">jsxPragmaInfo</span><span class="s1">.</span><span class="s2">fragmentBase</span><span class="s1">) ||</span>
          <span class="s2">jsxPragmaInfo</span><span class="s1">.</span><span class="s2">fragmentBase</span>
        <span class="s1">: </span><span class="s2">jsxPragmaInfo</span><span class="s1">.</span><span class="s2">fragmentBase</span><span class="s1">;</span>
      <span class="s3">return </span><span class="s2">resolvedFragmentPragmaBaseName </span><span class="s1">+ </span><span class="s2">jsxPragmaInfo</span><span class="s1">.</span><span class="s2">fragmentSuffix</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Return code that invokes the given function.</span>
   <span class="s6">*</span>
   <span class="s6">* When the imports transform is enabled, use the CJSImportTransformer</span>
   <span class="s6">* strategy of using `.call(void 0, ...` to avoid passing a `this` value in a</span>
   <span class="s6">* situation that would otherwise look like a method call.</span>
   <span class="s6">*/</span>
  <span class="s2">claimAutoImportedFuncInvocation</span><span class="s1">(</span><span class="s2">funcName</span><span class="s1">, </span><span class="s2">importPathSuffix</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">funcCode </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">claimAutoImportedName</span><span class="s1">(</span><span class="s2">funcName</span><span class="s1">, </span><span class="s2">importPathSuffix</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">importProcessor</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">funcCode</span><span class="s1">}</span><span class="s0">.call(void 0, `</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">funcCode</span><span class="s1">}</span><span class="s0">(`</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">claimAutoImportedName</span><span class="s1">(</span><span class="s2">funcName</span><span class="s1">, </span><span class="s2">importPathSuffix</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">importProcessor</span><span class="s1">) {</span>
      <span class="s4">// CJS mode: claim a name for the module and mark it for import.</span>
      <span class="s3">const </span><span class="s2">path </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">jsxImportSource </span><span class="s1">+ </span><span class="s2">importPathSuffix</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">cjsAutomaticModuleNameResolutions</span><span class="s1">[</span><span class="s2">path</span><span class="s1">]) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">cjsAutomaticModuleNameResolutions</span><span class="s1">[</span><span class="s2">path</span><span class="s1">] =</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">importProcessor</span><span class="s1">.</span><span class="s2">getFreeIdentifierForPath</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s3">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">cjsAutomaticModuleNameResolutions</span><span class="s1">[</span><span class="s2">path</span><span class="s1">]}</span><span class="s0">.</span><span class="s2">$</span><span class="s1">{</span><span class="s2">funcName</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s4">// ESM mode: claim a name for this function and add it to the names that</span>
      <span class="s4">// should be auto-imported when the prefix is generated.</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">esmAutomaticImportNameResolutions</span><span class="s1">[</span><span class="s2">funcName</span><span class="s1">]) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">esmAutomaticImportNameResolutions</span><span class="s1">[</span><span class="s2">funcName</span><span class="s1">] = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">nameManager</span><span class="s1">.</span><span class="s2">claimFreeName</span><span class="s1">(</span>
          <span class="s0">`_</span><span class="s2">$</span><span class="s1">{</span><span class="s2">funcName</span><span class="s1">}</span><span class="s0">`</span><span class="s1">,</span>
        <span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s3">return this</span><span class="s1">.</span><span class="s2">esmAutomaticImportNameResolutions</span><span class="s1">[</span><span class="s2">funcName</span><span class="s1">];</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Process the first part of a tag, before any props.</span>
   <span class="s6">*/</span>
  <span class="s2">processTagIntro</span><span class="s1">() {</span>
    <span class="s4">// Walk forward until we see one of these patterns:</span>
    <span class="s4">// jsxName to start the first prop, preceded by another jsxName to end the tag name.</span>
    <span class="s4">// jsxName to start the first prop, preceded by greaterThan to end the type argument.</span>
    <span class="s4">// [open brace] to start the first prop.</span>
    <span class="s4">// [jsxTagEnd] to end the open-tag.</span>
    <span class="s4">// [slash, jsxTagEnd] to end the self-closing tag.</span>
    <span class="s3">let </span><span class="s2">introEnd </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">currentIndex</span><span class="s1">() + </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s3">while </span><span class="s1">(</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">[</span><span class="s2">introEnd</span><span class="s1">].</span><span class="s2">isType </span><span class="s1">||</span>
      <span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches2AtIndex</span><span class="s1">(</span><span class="s2">introEnd </span><span class="s1">- </span><span class="s5">1</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxName</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxName</span><span class="s1">) &amp;&amp;</span>
        <span class="s1">!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches2AtIndex</span><span class="s1">(</span><span class="s2">introEnd </span><span class="s1">- </span><span class="s5">1</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">greaterThan</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxName</span><span class="s1">) &amp;&amp;</span>
        <span class="s1">!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1AtIndex</span><span class="s1">(</span><span class="s2">introEnd</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">braceL</span><span class="s1">) &amp;&amp;</span>
        <span class="s1">!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1AtIndex</span><span class="s1">(</span><span class="s2">introEnd</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">) &amp;&amp;</span>
        <span class="s1">!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches2AtIndex</span><span class="s1">(</span><span class="s2">introEnd</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">slash</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagEnd</span><span class="s1">))</span>
    <span class="s1">) {</span>
      <span class="s2">introEnd</span><span class="s1">++;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">introEnd </span><span class="s1">=== </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">currentIndex</span><span class="s1">() + </span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">tagName </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">identifierName</span><span class="s1">();</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">startsWithLowerCase</span><span class="s1">(</span><span class="s2">tagName</span><span class="s1">)) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">`'</span><span class="s2">$</span><span class="s1">{</span><span class="s2">tagName</span><span class="s1">}</span><span class="s0">'`</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">while </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">currentIndex</span><span class="s1">() &lt; </span><span class="s2">introEnd</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">rootTransformer</span><span class="s1">.</span><span class="s2">processToken</span><span class="s1">();</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Starting at the beginning of the props, add the props argument to</span>
   <span class="s6">* React.createElement, including the comma before it.</span>
   <span class="s6">*/</span>
  <span class="s2">processPropsObjectWithDevInfo</span><span class="s1">(</span><span class="s2">elementLocationCode</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">devProps </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">production</span>
      <span class="s1">? </span><span class="s0">&quot;&quot;</span>
      <span class="s1">: </span><span class="s0">`__self: this, __source: </span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getDevSource</span><span class="s1">(</span><span class="s2">elementLocationCode</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxName</span><span class="s1">) &amp;&amp; !</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">braceL</span><span class="s1">)) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">devProps</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">`, {</span><span class="s2">$</span><span class="s1">{</span><span class="s2">devProps</span><span class="s1">}</span><span class="s0">}`</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">`, null`</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s3">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">`, {`</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">processProps</span><span class="s1">(</span><span class="s3">false</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">devProps</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">` </span><span class="s2">$</span><span class="s1">{</span><span class="s2">devProps</span><span class="s1">}</span><span class="s0">}`</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot;}&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Transform the core part of the props, assuming that a { has already been</span>
   <span class="s6">* inserted before us and that a } will be inserted after us.</span>
   <span class="s6">*</span>
   <span class="s6">* If extractKeyCode is true (i.e. when using any jsx... function), any prop</span>
   <span class="s6">* named &quot;key&quot; has its code captured and returned rather than being emitted to</span>
   <span class="s6">* the output code. This shifts line numbers, and emitting the code later will</span>
   <span class="s6">* correct line numbers again. If no key is found or if extractKeyCode is</span>
   <span class="s6">* false, this function returns null.</span>
   <span class="s6">*/</span>
  <span class="s2">processProps</span><span class="s1">(</span><span class="s2">extractKeyCode</span><span class="s1">) {</span>
    <span class="s3">let </span><span class="s2">keyCode </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches2</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxName</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">eq</span><span class="s1">)) {</span>
        <span class="s4">// This is a regular key={value} or key=&quot;value&quot; prop.</span>
        <span class="s3">const </span><span class="s2">propName </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">identifierName</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">extractKeyCode </span><span class="s1">&amp;&amp; </span><span class="s2">propName </span><span class="s1">=== </span><span class="s0">&quot;key&quot;</span><span class="s1">) {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">keyCode </span><span class="s1">!== </span><span class="s3">null</span><span class="s1">) {</span>
            <span class="s4">// The props list has multiple keys. Different implementations are</span>
            <span class="s4">// inconsistent about what to do here: as of this writing, Babel and</span>
            <span class="s4">// swc keep the *last* key and completely remove the rest, while</span>
            <span class="s4">// TypeScript uses the *first* key and leaves the others as regular</span>
            <span class="s4">// props. The React team collaborated with Babel on the</span>
            <span class="s4">// implementation of this behavior, so presumably the Babel behavior</span>
            <span class="s4">// is the one to use.</span>
            <span class="s4">// Since we won't ever be emitting the previous key code, we need to</span>
            <span class="s4">// at least emit its newlines here so that the line numbers match up</span>
            <span class="s4">// in the long run.</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s2">keyCode</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/[^\n]/g</span><span class="s1">, </span><span class="s0">&quot;&quot;</span><span class="s1">));</span>
          <span class="s1">}</span>
          <span class="s4">// key</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">removeToken</span><span class="s1">();</span>
          <span class="s4">// =</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">removeToken</span><span class="s1">();</span>
          <span class="s3">const </span><span class="s2">snapshot </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">snapshot</span><span class="s1">();</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">processPropValue</span><span class="s1">();</span>
          <span class="s2">keyCode </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">dangerouslyGetAndRemoveCodeSinceSnapshot</span><span class="s1">(</span><span class="s2">snapshot</span><span class="s1">);</span>
          <span class="s4">// Don't add a comma</span>
          <span class="s3">continue</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">processPropName</span><span class="s1">(</span><span class="s2">propName</span><span class="s1">);</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;: &quot;</span><span class="s1">);</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">processPropValue</span><span class="s1">();</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxName</span><span class="s1">)) {</span>
        <span class="s4">// This is a shorthand prop like &lt;input disabled /&gt;.</span>
        <span class="s3">const </span><span class="s2">propName </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">identifierName</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">processPropName</span><span class="s1">(</span><span class="s2">propName</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot;: true&quot;</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">braceL</span><span class="s1">)) {</span>
        <span class="s4">// This is prop spread, like &lt;div {...getProps()}&gt;, which we can pass</span>
        <span class="s4">// through fairly directly as an object spread.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">rootTransformer</span><span class="s1">.</span><span class="s2">processBalancedCode</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot;,&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">return </span><span class="s2">keyCode</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">processPropName</span><span class="s1">(</span><span class="s2">propName</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">propName</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">&quot;-&quot;</span><span class="s1">)) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">`'</span><span class="s2">$</span><span class="s1">{</span><span class="s2">propName</span><span class="s1">}</span><span class="s0">'`</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">copyToken</span><span class="s1">();</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">processPropValue</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">braceL</span><span class="s1">)) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">rootTransformer</span><span class="s1">.</span><span class="s2">processBalancedCode</span><span class="s1">();</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagStart</span><span class="s1">)) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processJSXTag</span><span class="s1">();</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processStringPropValue</span><span class="s1">();</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">processStringPropValue</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s2">token </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">currentToken</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s2">valueCode </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">code</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">token</span><span class="s1">.</span><span class="s2">start </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">, </span><span class="s2">token</span><span class="s1">.</span><span class="s2">end </span><span class="s1">- </span><span class="s5">1</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">replacementCode </span><span class="s1">= </span><span class="s2">formatJSXTextReplacement</span><span class="s1">(</span><span class="s2">valueCode</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">literalCode </span><span class="s1">= </span><span class="s2">formatJSXStringValueLiteral</span><span class="s1">(</span><span class="s2">valueCode</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s2">literalCode </span><span class="s1">+ </span><span class="s2">replacementCode</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Starting in the middle of the props object literal, produce an additional</span>
   <span class="s6">* prop for the children and close the object literal.</span>
   <span class="s6">*/</span>
  <span class="s2">processAutomaticChildrenAndEndProps</span><span class="s1">(</span><span class="s2">jsxRole</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">jsxRole </span><span class="s1">=== </span><span class="s2">_tokenizer</span><span class="s1">.</span><span class="s2">JSXRole</span><span class="s1">.</span><span class="s2">StaticChildren</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot; children: [&quot;</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processChildren</span><span class="s1">(</span><span class="s3">false</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot;]}&quot;</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s4">// The parser information tells us whether we will see a real child or if</span>
      <span class="s4">// all remaining children (if any) will resolve to empty. If there are no</span>
      <span class="s4">// non-empty children, don't emit a children prop at all, but still</span>
      <span class="s4">// process children so that we properly transform the code into nothing.</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">jsxRole </span><span class="s1">=== </span><span class="s2">_tokenizer</span><span class="s1">.</span><span class="s2">JSXRole</span><span class="s1">.</span><span class="s2">OneChild</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot; children: &quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">processChildren</span><span class="s1">(</span><span class="s3">false</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s0">&quot;}&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Transform children into a comma-separated list, which will be either</span>
   <span class="s6">* arguments to createElement or array elements of a children prop.</span>
   <span class="s6">*/</span>
  <span class="s2">processChildren</span><span class="s1">(</span><span class="s2">needsInitialComma</span><span class="s1">) {</span>
    <span class="s3">let </span><span class="s2">needsComma </span><span class="s1">= </span><span class="s2">needsInitialComma</span><span class="s1">;</span>
    <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches2</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagStart</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">slash</span><span class="s1">)) {</span>
        <span class="s4">// Closing tag, so no more children.</span>
        <span class="s3">return</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">let </span><span class="s2">didEmitElement </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">braceL</span><span class="s1">)) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches2</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">braceL</span><span class="s1">, </span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">braceR</span><span class="s1">)) {</span>
          <span class="s4">// Empty interpolations and comment-only interpolations are allowed</span>
          <span class="s4">// and don't create an extra child arg.</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s4">// Interpolated expression.</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s2">needsComma </span><span class="s1">? </span><span class="s0">&quot;, &quot; </span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">rootTransformer</span><span class="s1">.</span><span class="s2">processBalancedCode</span><span class="s1">();</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
          <span class="s2">didEmitElement </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxTagStart</span><span class="s1">)) {</span>
        <span class="s4">// Child JSX element</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">appendCode</span><span class="s1">(</span><span class="s2">needsComma </span><span class="s1">? </span><span class="s0">&quot;, &quot; </span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">processJSXTag</span><span class="s1">();</span>
        <span class="s2">didEmitElement </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxText</span><span class="s1">) || </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">matches1</span><span class="s1">(</span><span class="s2">_types</span><span class="s1">.</span><span class="s2">TokenType</span><span class="s1">.</span><span class="s2">jsxEmptyText</span><span class="s1">)) {</span>
        <span class="s2">didEmitElement </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">processChildTextElement</span><span class="s1">(</span><span class="s2">needsComma</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">&quot;Unexpected token when processing JSX children.&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">didEmitElement</span><span class="s1">) {</span>
        <span class="s2">needsComma </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s6">/**</span>
   <span class="s6">* Turn a JSX text element into a string literal, or nothing at all if the JSX</span>
   <span class="s6">* text resolves to the empty string.</span>
   <span class="s6">*</span>
   <span class="s6">* Returns true if a string literal is emitted, false otherwise.</span>
   <span class="s6">*/</span>
  <span class="s2">processChildTextElement</span><span class="s1">(</span><span class="s2">needsComma</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">token </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">currentToken</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s2">valueCode </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">code</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">token</span><span class="s1">.</span><span class="s2">start</span><span class="s1">, </span><span class="s2">token</span><span class="s1">.</span><span class="s2">end</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">replacementCode </span><span class="s1">= </span><span class="s2">formatJSXTextReplacement</span><span class="s1">(</span><span class="s2">valueCode</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">literalCode </span><span class="s1">= </span><span class="s2">formatJSXTextLiteral</span><span class="s1">(</span><span class="s2">valueCode</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">literalCode </span><span class="s1">=== </span><span class="s0">'&quot;&quot;'</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s2">replacementCode</span><span class="s1">);</span>
      <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tokens</span><span class="s1">.</span><span class="s2">replaceToken</span><span class="s1">(</span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">needsComma </span><span class="s1">? </span><span class="s0">&quot;, &quot; </span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">literalCode</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">replacementCode</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">getDevSource</span><span class="s1">(</span><span class="s2">elementLocationCode</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s0">`{fileName: </span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFilenameVarName</span><span class="s1">()}</span><span class="s0">, </span><span class="s2">$</span><span class="s1">{</span><span class="s2">elementLocationCode</span><span class="s1">}</span><span class="s0">}`</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">getFilenameVarName</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">filenameVarName</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">filenameVarName </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">nameManager</span><span class="s1">.</span><span class="s2">claimFreeName</span><span class="s1">(</span><span class="s0">&quot;_jsxFileName&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">filenameVarName</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">} </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">default </span><span class="s1">= </span><span class="s2">JSXTransformer</span><span class="s1">;</span>

<span class="s6">/**</span>
 <span class="s6">* Spec for identifiers: https://tc39.github.io/ecma262/#prod-IdentifierStart.</span>
 <span class="s6">*</span>
 <span class="s6">* Really only treat anything starting with a-z as tag names.  `_`, `$`, ``</span>
 <span class="s6">* should be treated as component names</span>
 <span class="s6">*/</span>
 <span class="s3">function </span><span class="s2">startsWithLowerCase</span><span class="s1">(</span><span class="s2">s</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">firstChar </span><span class="s1">= </span><span class="s2">s</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s5">0</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s2">firstChar </span><span class="s1">&gt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">lowercaseA </span><span class="s1">&amp;&amp; </span><span class="s2">firstChar </span><span class="s1">&lt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">lowercaseZ</span><span class="s1">;</span>
<span class="s1">} </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">startsWithLowerCase </span><span class="s1">= </span><span class="s2">startsWithLowerCase</span><span class="s1">;</span>

<span class="s6">/**</span>
 <span class="s6">* Turn the given jsxText string into a JS string literal. Leading and trailing</span>
 <span class="s6">* whitespace on lines is removed, except immediately after the open-tag and</span>
 <span class="s6">* before the close-tag. Empty lines are completely removed, and spaces are</span>
 <span class="s6">* added between lines after that.</span>
 <span class="s6">*</span>
 <span class="s6">* We use JSON.stringify to introduce escape characters as necessary, and trim</span>
 <span class="s6">* the start and end of each line and remove blank lines.</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">formatJSXTextLiteral</span><span class="s1">(</span><span class="s2">text</span><span class="s1">) {</span>
  <span class="s3">let </span><span class="s2">result </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">whitespace </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>

  <span class="s3">let </span><span class="s2">isInInitialLineWhitespace </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">seenNonWhitespace </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">text</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
    <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s2">text</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s0">&quot; &quot; </span><span class="s1">|| </span><span class="s2">c </span><span class="s1">=== </span><span class="s0">&quot;</span><span class="s3">\t</span><span class="s0">&quot; </span><span class="s1">|| </span><span class="s2">c </span><span class="s1">=== </span><span class="s0">&quot;</span><span class="s3">\r</span><span class="s0">&quot;</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">isInInitialLineWhitespace</span><span class="s1">) {</span>
        <span class="s2">whitespace </span><span class="s1">+= </span><span class="s2">c</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">) {</span>
      <span class="s2">whitespace </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s2">isInInitialLineWhitespace </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">seenNonWhitespace </span><span class="s1">&amp;&amp; </span><span class="s2">isInInitialLineWhitespace</span><span class="s1">) {</span>
        <span class="s2">result </span><span class="s1">+= </span><span class="s0">&quot; &quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">result </span><span class="s1">+= </span><span class="s2">whitespace</span><span class="s1">;</span>
      <span class="s2">whitespace </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s0">&quot;&amp;&quot;</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s1">{</span><span class="s2">entity</span><span class="s1">, </span><span class="s2">newI</span><span class="s1">} = </span><span class="s2">processEntity</span><span class="s1">(</span><span class="s2">text</span><span class="s1">, </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
        <span class="s2">i </span><span class="s1">= </span><span class="s2">newI </span><span class="s1">- </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s2">result </span><span class="s1">+= </span><span class="s2">entity</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">result </span><span class="s1">+= </span><span class="s2">c</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">seenNonWhitespace </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s2">isInInitialLineWhitespace </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">isInInitialLineWhitespace</span><span class="s1">) {</span>
    <span class="s2">result </span><span class="s1">+= </span><span class="s2">whitespace</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">result</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Produce the code that should be printed after the JSX text string literal,</span>
 <span class="s6">* with most content removed, but all newlines preserved and all spacing at the</span>
 <span class="s6">* end preserved.</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">formatJSXTextReplacement</span><span class="s1">(</span><span class="s2">text</span><span class="s1">) {</span>
  <span class="s3">let </span><span class="s2">numNewlines </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">numSpaces </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">c of text</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">) {</span>
      <span class="s2">numNewlines</span><span class="s1">++;</span>
      <span class="s2">numSpaces </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s0">&quot; &quot;</span><span class="s1">) {</span>
      <span class="s2">numSpaces</span><span class="s1">++;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">.</span><span class="s2">repeat</span><span class="s1">(</span><span class="s2">numNewlines</span><span class="s1">) + </span><span class="s0">&quot; &quot;</span><span class="s1">.</span><span class="s2">repeat</span><span class="s1">(</span><span class="s2">numSpaces</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Format a string in the value position of a JSX prop.</span>
 <span class="s6">*</span>
 <span class="s6">* Use the same implementation as convertAttribute from</span>
 <span class="s6">* babel-helper-builder-react-jsx.</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">formatJSXStringValueLiteral</span><span class="s1">(</span><span class="s2">text</span><span class="s1">) {</span>
  <span class="s3">let </span><span class="s2">result </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">text</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
    <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s2">text</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s7">/\s/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">text</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">])) {</span>
        <span class="s2">result </span><span class="s1">+= </span><span class="s0">&quot; &quot;</span><span class="s1">;</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s7">/\s/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">text</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">])) {</span>
          <span class="s2">i</span><span class="s1">++;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">result </span><span class="s1">+= </span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s0">&quot;&amp;&quot;</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s1">{</span><span class="s2">entity</span><span class="s1">, </span><span class="s2">newI</span><span class="s1">} = </span><span class="s2">processEntity</span><span class="s1">(</span><span class="s2">text</span><span class="s1">, </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
      <span class="s2">result </span><span class="s1">+= </span><span class="s2">entity</span><span class="s1">;</span>
      <span class="s2">i </span><span class="s1">= </span><span class="s2">newI </span><span class="s1">- </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">result </span><span class="s1">+= </span><span class="s2">c</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">result</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Starting at a &amp;, see if there's an HTML entity (specified by name, decimal</span>
 <span class="s6">* char code, or hex char code) and return it if so.</span>
 <span class="s6">*</span>
 <span class="s6">* Modified from jsxReadString in babel-parser.</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">processEntity</span><span class="s1">(</span><span class="s2">text</span><span class="s1">, </span><span class="s2">indexAfterAmpersand</span><span class="s1">) {</span>
  <span class="s3">let </span><span class="s2">str </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">count </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">entity</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">indexAfterAmpersand</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">text</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] === </span><span class="s0">&quot;#&quot;</span><span class="s1">) {</span>
    <span class="s3">let </span><span class="s2">radix </span><span class="s1">= </span><span class="s5">10</span><span class="s1">;</span>
    <span class="s2">i</span><span class="s1">++;</span>
    <span class="s3">let </span><span class="s2">numStart</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">text</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] === </span><span class="s0">&quot;x&quot;</span><span class="s1">) {</span>
      <span class="s2">radix </span><span class="s1">= </span><span class="s5">16</span><span class="s1">;</span>
      <span class="s2">i</span><span class="s1">++;</span>
      <span class="s2">numStart </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
      <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">isHexDigit</span><span class="s1">(</span><span class="s2">text</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">i</span><span class="s1">))) {</span>
        <span class="s2">i</span><span class="s1">++;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">numStart </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
      <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">isDecimalDigit</span><span class="s1">(</span><span class="s2">text</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">i</span><span class="s1">))) {</span>
        <span class="s2">i</span><span class="s1">++;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">text</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] === </span><span class="s0">&quot;;&quot;</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">numStr </span><span class="s1">= </span><span class="s2">text</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">numStart</span><span class="s1">, </span><span class="s2">i</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">numStr</span><span class="s1">) {</span>
        <span class="s2">i</span><span class="s1">++;</span>
        <span class="s2">entity </span><span class="s1">= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">numStr</span><span class="s1">, </span><span class="s2">radix</span><span class="s1">));</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">count</span><span class="s1">++ &lt; </span><span class="s5">10</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">ch </span><span class="s1">= </span><span class="s2">text</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
      <span class="s2">i</span><span class="s1">++;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">ch </span><span class="s1">=== </span><span class="s0">&quot;;&quot;</span><span class="s1">) {</span>
        <span class="s2">entity </span><span class="s1">= </span><span class="s2">_xhtml2</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">str</span><span class="s1">);</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">str </span><span class="s1">+= </span><span class="s2">ch</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">entity</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">{</span><span class="s2">entity</span><span class="s1">: </span><span class="s0">&quot;&amp;&quot;</span><span class="s1">, </span><span class="s2">newI</span><span class="s1">: </span><span class="s2">indexAfterAmpersand</span><span class="s1">};</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s1">{</span><span class="s2">entity</span><span class="s1">, </span><span class="s2">newI</span><span class="s1">: </span><span class="s2">i</span><span class="s1">};</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">isDecimalDigit</span><span class="s1">(</span><span class="s2">code</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s2">code </span><span class="s1">&gt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">digit0 </span><span class="s1">&amp;&amp; </span><span class="s2">code </span><span class="s1">&lt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">digit9</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">isHexDigit</span><span class="s1">(</span><span class="s2">code</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s1">(</span>
    <span class="s1">(</span><span class="s2">code </span><span class="s1">&gt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">digit0 </span><span class="s1">&amp;&amp; </span><span class="s2">code </span><span class="s1">&lt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">digit9</span><span class="s1">) ||</span>
    <span class="s1">(</span><span class="s2">code </span><span class="s1">&gt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">lowercaseA </span><span class="s1">&amp;&amp; </span><span class="s2">code </span><span class="s1">&lt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">lowercaseF</span><span class="s1">) ||</span>
    <span class="s1">(</span><span class="s2">code </span><span class="s1">&gt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">uppercaseA </span><span class="s1">&amp;&amp; </span><span class="s2">code </span><span class="s1">&lt;= </span><span class="s2">_charcodes</span><span class="s1">.</span><span class="s2">charCodes</span><span class="s1">.</span><span class="s2">uppercaseF</span><span class="s1">)</span>
  <span class="s1">);</span>
<span class="s1">}</span>
</pre>
</body>
</html>