<html>
<head>
<title>_path.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #67a37c; font-style: italic;}
.s5 { color: #cf8e6d;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_path.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@typedef </span><span class="s3">{import('../lib/types').XastElement} XastElement</span>
 <span class="s3">* </span><span class="s4">@typedef </span><span class="s3">{import('../lib/types').PathDataItem} PathDataItem</span>
 <span class="s3">*/</span>

<span class="s5">const </span><span class="s1">{ </span><span class="s2">parsePathData</span><span class="s1">, </span><span class="s2">stringifyPathData </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../lib/path.js'</span><span class="s1">);</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{[number, number]}</span>
 <span class="s3">*/</span>
<span class="s5">var </span><span class="s2">prevCtrlPoint</span><span class="s1">;</span>

<span class="s3">/**</span>
 <span class="s3">* Convert path string to JS representation.</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(path: XastElement) =&gt; Array&lt;PathDataItem&gt;}</span>
 <span class="s3">*/</span>
<span class="s5">const </span><span class="s2">path2js </span><span class="s1">= (</span><span class="s2">path</span><span class="s1">) =&gt; {</span>
  <span class="s6">// @ts-ignore legacy</span>
  <span class="s5">if </span><span class="s1">(</span><span class="s2">path</span><span class="s1">.</span><span class="s2">pathJS</span><span class="s1">) </span><span class="s5">return </span><span class="s2">path</span><span class="s1">.</span><span class="s2">pathJS</span><span class="s1">;</span>
  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{Array&lt;PathDataItem&gt;}</span>
   <span class="s3">*/</span>
  <span class="s5">const </span><span class="s2">pathData </span><span class="s1">= []; </span><span class="s6">// JS representation of the path data</span>
  <span class="s5">const </span><span class="s2">newPathData </span><span class="s1">= </span><span class="s2">parsePathData</span><span class="s1">(</span><span class="s2">path</span><span class="s1">.</span><span class="s2">attributes</span><span class="s1">.</span><span class="s2">d</span><span class="s1">);</span>
  <span class="s5">for </span><span class="s1">(</span><span class="s5">const </span><span class="s1">{ </span><span class="s2">command</span><span class="s1">, </span><span class="s2">args </span><span class="s1">} </span><span class="s2">of newPathData</span><span class="s1">) {</span>
    <span class="s2">pathData</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">command</span><span class="s1">, </span><span class="s2">args </span><span class="s1">});</span>
  <span class="s1">}</span>
  <span class="s6">// First moveto is actually absolute. Subsequent coordinates were separated above.</span>
  <span class="s5">if </span><span class="s1">(</span><span class="s2">pathData</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">pathData</span><span class="s1">[</span><span class="s7">0</span><span class="s1">].</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'m'</span><span class="s1">) {</span>
    <span class="s2">pathData</span><span class="s1">[</span><span class="s7">0</span><span class="s1">].</span><span class="s2">command </span><span class="s1">= </span><span class="s0">'M'</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s6">// @ts-ignore legacy</span>
  <span class="s2">path</span><span class="s1">.</span><span class="s2">pathJS </span><span class="s1">= </span><span class="s2">pathData</span><span class="s1">;</span>
  <span class="s5">return </span><span class="s2">pathData</span><span class="s1">;</span>
<span class="s1">};</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">path2js </span><span class="s1">= </span><span class="s2">path2js</span><span class="s1">;</span>

<span class="s3">/**</span>
 <span class="s3">* Convert relative Path data to absolute.</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(data: Array&lt;PathDataItem&gt;) =&gt; Array&lt;PathDataItem&gt;}</span>
 <span class="s3">*</span>
 <span class="s3">*/</span>
<span class="s5">const </span><span class="s2">convertRelativeToAbsolute </span><span class="s1">= (</span><span class="s2">data</span><span class="s1">) =&gt; {</span>
  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{Array&lt;PathDataItem&gt;}</span>
   <span class="s3">*/</span>
  <span class="s5">const </span><span class="s2">newData </span><span class="s1">= [];</span>
  <span class="s5">let </span><span class="s2">start </span><span class="s1">= [</span><span class="s7">0</span><span class="s1">, </span><span class="s7">0</span><span class="s1">];</span>
  <span class="s5">let </span><span class="s2">cursor </span><span class="s1">= [</span><span class="s7">0</span><span class="s1">, </span><span class="s7">0</span><span class="s1">];</span>

  <span class="s5">for </span><span class="s1">(</span><span class="s5">let </span><span class="s1">{ </span><span class="s2">command</span><span class="s1">, </span><span class="s2">args </span><span class="s1">} </span><span class="s2">of data</span><span class="s1">) {</span>
    <span class="s2">args </span><span class="s1">= </span><span class="s2">args</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">();</span>

    <span class="s6">// moveto (x y)</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'m'</span><span class="s1">) {</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'M'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'M'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">start</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">start</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s6">// horizontal lineto (x)</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'h'</span><span class="s1">) {</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'H'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'H'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s6">// vertical lineto (y)</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'v'</span><span class="s1">) {</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'V'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'V'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s6">// lineto (x y)</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'l'</span><span class="s1">) {</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'L'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'L'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s6">// curveto (x1 y1 x2 y2 x y)</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'c'</span><span class="s1">) {</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">4</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">5</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'C'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'C'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">4</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">5</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s6">// smooth curveto (x2 y2 x y)</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'s'</span><span class="s1">) {</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'S'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'S'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">2</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">3</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s6">// quadratic Bézier curveto (x1 y1 x y)</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'q'</span><span class="s1">) {</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'Q'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'Q'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">2</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">3</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s6">// smooth quadratic Bézier curveto (x y)</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'t'</span><span class="s1">) {</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'T'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'T'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s6">// elliptical arc (rx ry x-axis-rotation large-arc-flag sweep-flag x y)</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'a'</span><span class="s1">) {</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">5</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s7">6</span><span class="s1">] += </span><span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'A'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'A'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">5</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">args</span><span class="s1">[</span><span class="s7">6</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s6">// closepath</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'z' </span><span class="s1">|| </span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'Z'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">start</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">start</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'z'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">newData</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">command</span><span class="s1">, </span><span class="s2">args </span><span class="s1">});</span>
  <span class="s1">}</span>
  <span class="s5">return </span><span class="s2">newData</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@typedef </span><span class="s3">{{ floatPrecision?: number, noSpaceAfterFlags?: boolean }} Js2PathParams</span>
 <span class="s3">*/</span>

<span class="s3">/**</span>
 <span class="s3">* Convert path array to string.</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(path: XastElement, data: Array&lt;PathDataItem&gt;, params: Js2PathParams) =&gt; void}</span>
 <span class="s3">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">js2path </span><span class="s1">= </span><span class="s5">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">params</span><span class="s1">) {</span>
  <span class="s6">// @ts-ignore legacy</span>
  <span class="s2">path</span><span class="s1">.</span><span class="s2">pathJS </span><span class="s1">= </span><span class="s2">data</span><span class="s1">;</span>

  <span class="s5">const </span><span class="s2">pathData </span><span class="s1">= [];</span>
  <span class="s5">for </span><span class="s1">(</span><span class="s5">const </span><span class="s2">item of data</span><span class="s1">) {</span>
    <span class="s6">// remove moveto commands which are followed by moveto commands</span>
    <span class="s5">if </span><span class="s1">(</span>
      <span class="s2">pathData</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s7">0 </span><span class="s1">&amp;&amp;</span>
      <span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'M' </span><span class="s1">|| </span><span class="s2">item</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'m'</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s5">const </span><span class="s2">last </span><span class="s1">= </span><span class="s2">pathData</span><span class="s1">[</span><span class="s2">pathData</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">1</span><span class="s1">];</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">last</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'M' </span><span class="s1">|| </span><span class="s2">last</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'m'</span><span class="s1">) {</span>
        <span class="s2">pathData</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">pathData</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
      <span class="s2">command</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">command</span><span class="s1">,</span>
      <span class="s2">args</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">args</span><span class="s1">,</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">path</span><span class="s1">.</span><span class="s2">attributes</span><span class="s1">.</span><span class="s2">d </span><span class="s1">= </span><span class="s2">stringifyPathData</span><span class="s1">({</span>
    <span class="s2">pathData</span><span class="s1">,</span>
    <span class="s2">precision</span><span class="s1">: </span><span class="s2">params</span><span class="s1">.</span><span class="s2">floatPrecision</span><span class="s1">,</span>
    <span class="s2">disableSpaceAfterFlags</span><span class="s1">: </span><span class="s2">params</span><span class="s1">.</span><span class="s2">noSpaceAfterFlags</span><span class="s1">,</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(dest: Array&lt;number&gt;, source: Array&lt;number&gt;) =&gt; Array&lt;number&gt;}</span>
 <span class="s3">*/</span>
<span class="s5">function </span><span class="s2">set</span><span class="s1">(</span><span class="s2">dest</span><span class="s1">, </span><span class="s2">source</span><span class="s1">) {</span>
  <span class="s2">dest</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">source</span><span class="s1">[</span><span class="s2">source</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">2</span><span class="s1">];</span>
  <span class="s2">dest</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">source</span><span class="s1">[</span><span class="s2">source</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">1</span><span class="s1">];</span>
  <span class="s5">return </span><span class="s2">dest</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* Checks if two paths have an intersection by checking convex hulls</span>
 <span class="s3">* collision using Gilbert-Johnson-Keerthi distance algorithm</span>
 <span class="s3">* https://web.archive.org/web/20180822200027/http://entropyinteractive.com/2011/04/gjk-algorithm/</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(path1: Array&lt;PathDataItem&gt;, path2: Array&lt;PathDataItem&gt;) =&gt; boolean}</span>
 <span class="s3">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">intersects </span><span class="s1">= </span><span class="s5">function </span><span class="s1">(</span><span class="s2">path1</span><span class="s1">, </span><span class="s2">path2</span><span class="s1">) {</span>
  <span class="s6">// Collect points of every subpath.</span>
  <span class="s5">const </span><span class="s2">points1 </span><span class="s1">= </span><span class="s2">gatherPoints</span><span class="s1">(</span><span class="s2">convertRelativeToAbsolute</span><span class="s1">(</span><span class="s2">path1</span><span class="s1">));</span>
  <span class="s5">const </span><span class="s2">points2 </span><span class="s1">= </span><span class="s2">gatherPoints</span><span class="s1">(</span><span class="s2">convertRelativeToAbsolute</span><span class="s1">(</span><span class="s2">path2</span><span class="s1">));</span>

  <span class="s6">// Axis-aligned bounding box check.</span>
  <span class="s5">if </span><span class="s1">(</span>
    <span class="s2">points1</span><span class="s1">.</span><span class="s2">maxX </span><span class="s1">&lt;= </span><span class="s2">points2</span><span class="s1">.</span><span class="s2">minX </span><span class="s1">||</span>
    <span class="s2">points2</span><span class="s1">.</span><span class="s2">maxX </span><span class="s1">&lt;= </span><span class="s2">points1</span><span class="s1">.</span><span class="s2">minX </span><span class="s1">||</span>
    <span class="s2">points1</span><span class="s1">.</span><span class="s2">maxY </span><span class="s1">&lt;= </span><span class="s2">points2</span><span class="s1">.</span><span class="s2">minY </span><span class="s1">||</span>
    <span class="s2">points2</span><span class="s1">.</span><span class="s2">maxY </span><span class="s1">&lt;= </span><span class="s2">points1</span><span class="s1">.</span><span class="s2">minY </span><span class="s1">||</span>
    <span class="s2">points1</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">every</span><span class="s1">((</span><span class="s2">set1</span><span class="s1">) =&gt; {</span>
      <span class="s5">return </span><span class="s2">points2</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">every</span><span class="s1">((</span><span class="s2">set2</span><span class="s1">) =&gt; {</span>
        <span class="s5">return </span><span class="s1">(</span>
          <span class="s2">set1</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">set1</span><span class="s1">.</span><span class="s2">maxX</span><span class="s1">][</span><span class="s7">0</span><span class="s1">] &lt;= </span><span class="s2">set2</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">set2</span><span class="s1">.</span><span class="s2">minX</span><span class="s1">][</span><span class="s7">0</span><span class="s1">] ||</span>
          <span class="s2">set2</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">set2</span><span class="s1">.</span><span class="s2">maxX</span><span class="s1">][</span><span class="s7">0</span><span class="s1">] &lt;= </span><span class="s2">set1</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">set1</span><span class="s1">.</span><span class="s2">minX</span><span class="s1">][</span><span class="s7">0</span><span class="s1">] ||</span>
          <span class="s2">set1</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">set1</span><span class="s1">.</span><span class="s2">maxY</span><span class="s1">][</span><span class="s7">1</span><span class="s1">] &lt;= </span><span class="s2">set2</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">set2</span><span class="s1">.</span><span class="s2">minY</span><span class="s1">][</span><span class="s7">1</span><span class="s1">] ||</span>
          <span class="s2">set2</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">set2</span><span class="s1">.</span><span class="s2">maxY</span><span class="s1">][</span><span class="s7">1</span><span class="s1">] &lt;= </span><span class="s2">set1</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">set1</span><span class="s1">.</span><span class="s2">minY</span><span class="s1">][</span><span class="s7">1</span><span class="s1">]</span>
        <span class="s1">);</span>
      <span class="s1">});</span>
    <span class="s1">})</span>
  <span class="s1">)</span>
    <span class="s5">return false</span><span class="s1">;</span>

  <span class="s6">// Get a convex hull from points of each subpath. Has the most complexity O(n·log n).</span>
  <span class="s5">const </span><span class="s2">hullNest1 </span><span class="s1">= </span><span class="s2">points1</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">convexHull</span><span class="s1">);</span>
  <span class="s5">const </span><span class="s2">hullNest2 </span><span class="s1">= </span><span class="s2">points2</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">convexHull</span><span class="s1">);</span>

  <span class="s6">// Check intersection of every subpath of the first path with every subpath of the second.</span>
  <span class="s5">return </span><span class="s2">hullNest1</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span><span class="s5">function </span><span class="s1">(</span><span class="s2">hull1</span><span class="s1">) {</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">hull1</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s7">3</span><span class="s1">) </span><span class="s5">return false</span><span class="s1">;</span>

    <span class="s5">return </span><span class="s2">hullNest2</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span><span class="s5">function </span><span class="s1">(</span><span class="s2">hull2</span><span class="s1">) {</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">hull2</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s7">3</span><span class="s1">) </span><span class="s5">return false</span><span class="s1">;</span>

      <span class="s5">var </span><span class="s2">simplex </span><span class="s1">= [</span><span class="s2">getSupport</span><span class="s1">(</span><span class="s2">hull1</span><span class="s1">, </span><span class="s2">hull2</span><span class="s1">, [</span><span class="s7">1</span><span class="s1">, </span><span class="s7">0</span><span class="s1">])], </span><span class="s6">// create the initial simplex</span>
        <span class="s2">direction </span><span class="s1">= </span><span class="s2">minus</span><span class="s1">(</span><span class="s2">simplex</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]); </span><span class="s6">// set the direction to point towards the origin</span>

      <span class="s5">var </span><span class="s2">iterations </span><span class="s1">= </span><span class="s7">1e4</span><span class="s1">; </span><span class="s6">// infinite loop protection, 10 000 iterations is more than enough</span>
      <span class="s6">// eslint-disable-next-line no-constant-condition</span>
      <span class="s5">while </span><span class="s1">(</span><span class="s5">true</span><span class="s1">) {</span>
        <span class="s6">// eslint-disable-next-line no-constant-condition</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">iterations</span><span class="s1">-- == </span><span class="s7">0</span><span class="s1">) {</span>
          <span class="s2">console</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span>
            <span class="s0">'Error: infinite loop while processing mergePaths plugin.'</span>
          <span class="s1">);</span>
          <span class="s5">return true</span><span class="s1">; </span><span class="s6">// true is the safe value that means “do nothing with paths”</span>
        <span class="s1">}</span>
        <span class="s6">// add a new point</span>
        <span class="s2">simplex</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">getSupport</span><span class="s1">(</span><span class="s2">hull1</span><span class="s1">, </span><span class="s2">hull2</span><span class="s1">, </span><span class="s2">direction</span><span class="s1">));</span>
        <span class="s6">// see if the new point was on the correct side of the origin</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">dot</span><span class="s1">(</span><span class="s2">direction</span><span class="s1">, </span><span class="s2">simplex</span><span class="s1">[</span><span class="s2">simplex</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">1</span><span class="s1">]) &lt;= </span><span class="s7">0</span><span class="s1">) </span><span class="s5">return false</span><span class="s1">;</span>
        <span class="s6">// process the simplex</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">processSimplex</span><span class="s1">(</span><span class="s2">simplex</span><span class="s1">, </span><span class="s2">direction</span><span class="s1">)) </span><span class="s5">return true</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">});</span>

  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(a: Point, b: Point, direction: Array&lt;number&gt;) =&gt; Array&lt;number&gt;}</span>
   <span class="s3">*/</span>
  <span class="s5">function </span><span class="s2">getSupport</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">, </span><span class="s2">direction</span><span class="s1">) {</span>
    <span class="s5">return </span><span class="s2">sub</span><span class="s1">(</span><span class="s2">supportPoint</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">direction</span><span class="s1">), </span><span class="s2">supportPoint</span><span class="s1">(</span><span class="s2">b</span><span class="s1">, </span><span class="s2">minus</span><span class="s1">(</span><span class="s2">direction</span><span class="s1">)));</span>
  <span class="s1">}</span>

  <span class="s6">// Computes farthest polygon point in particular direction.</span>
  <span class="s6">// Thanks to knowledge of min/max x and y coordinates we can choose a quadrant to search in.</span>
  <span class="s6">// Since we're working on convex hull, the dot product is increasing until we find the farthest point.</span>
  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(polygon: Point, direction: Array&lt;number&gt;) =&gt; Array&lt;number&gt;}</span>
   <span class="s3">*/</span>
  <span class="s5">function </span><span class="s2">supportPoint</span><span class="s1">(</span><span class="s2">polygon</span><span class="s1">, </span><span class="s2">direction</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">index </span><span class="s1">=</span>
        <span class="s2">direction</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] &gt;= </span><span class="s7">0</span>
          <span class="s1">? </span><span class="s2">direction</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] &lt; </span><span class="s7">0</span>
            <span class="s1">? </span><span class="s2">polygon</span><span class="s1">.</span><span class="s2">maxY</span>
            <span class="s1">: </span><span class="s2">polygon</span><span class="s1">.</span><span class="s2">maxX</span>
          <span class="s1">: </span><span class="s2">direction</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] &lt; </span><span class="s7">0</span>
          <span class="s1">? </span><span class="s2">polygon</span><span class="s1">.</span><span class="s2">minX</span>
          <span class="s1">: </span><span class="s2">polygon</span><span class="s1">.</span><span class="s2">minY</span><span class="s1">,</span>
      <span class="s2">max </span><span class="s1">= -</span><span class="s2">Infinity</span><span class="s1">,</span>
      <span class="s2">value</span><span class="s1">;</span>
    <span class="s5">while </span><span class="s1">((</span><span class="s2">value </span><span class="s1">= </span><span class="s2">dot</span><span class="s1">(</span><span class="s2">polygon</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">index</span><span class="s1">], </span><span class="s2">direction</span><span class="s1">)) &gt; </span><span class="s2">max</span><span class="s1">) {</span>
      <span class="s2">max </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
      <span class="s2">index </span><span class="s1">= ++</span><span class="s2">index </span><span class="s1">% </span><span class="s2">polygon</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">return </span><span class="s2">polygon</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[(</span><span class="s2">index </span><span class="s1">|| </span><span class="s2">polygon</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) - </span><span class="s7">1</span><span class="s1">];</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(simplex: Array&lt;Array&lt;number&gt;&gt;, direction: Array&lt;number&gt;) =&gt; boolean}</span>
 <span class="s3">*/</span>
<span class="s5">function </span><span class="s2">processSimplex</span><span class="s1">(</span><span class="s2">simplex</span><span class="s1">, </span><span class="s2">direction</span><span class="s1">) {</span>
  <span class="s6">// we only need to handle to 1-simplex and 2-simplex</span>
  <span class="s5">if </span><span class="s1">(</span><span class="s2">simplex</span><span class="s1">.</span><span class="s2">length </span><span class="s1">== </span><span class="s7">2</span><span class="s1">) {</span>
    <span class="s6">// 1-simplex</span>
    <span class="s5">let </span><span class="s2">a </span><span class="s1">= </span><span class="s2">simplex</span><span class="s1">[</span><span class="s7">1</span><span class="s1">],</span>
      <span class="s2">b </span><span class="s1">= </span><span class="s2">simplex</span><span class="s1">[</span><span class="s7">0</span><span class="s1">],</span>
      <span class="s2">AO </span><span class="s1">= </span><span class="s2">minus</span><span class="s1">(</span><span class="s2">simplex</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]),</span>
      <span class="s2">AB </span><span class="s1">= </span><span class="s2">sub</span><span class="s1">(</span><span class="s2">b</span><span class="s1">, </span><span class="s2">a</span><span class="s1">);</span>
    <span class="s6">// AO is in the same direction as AB</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">dot</span><span class="s1">(</span><span class="s2">AO</span><span class="s1">, </span><span class="s2">AB</span><span class="s1">) &gt; </span><span class="s7">0</span><span class="s1">) {</span>
      <span class="s6">// get the vector perpendicular to AB facing O</span>
      <span class="s2">set</span><span class="s1">(</span><span class="s2">direction</span><span class="s1">, </span><span class="s2">orth</span><span class="s1">(</span><span class="s2">AB</span><span class="s1">, </span><span class="s2">a</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
      <span class="s2">set</span><span class="s1">(</span><span class="s2">direction</span><span class="s1">, </span><span class="s2">AO</span><span class="s1">);</span>
      <span class="s6">// only A remains in the simplex</span>
      <span class="s2">simplex</span><span class="s1">.</span><span class="s2">shift</span><span class="s1">();</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
    <span class="s6">// 2-simplex</span>
    <span class="s5">let </span><span class="s2">a </span><span class="s1">= </span><span class="s2">simplex</span><span class="s1">[</span><span class="s7">2</span><span class="s1">], </span><span class="s6">// [a, b, c] = simplex</span>
      <span class="s2">b </span><span class="s1">= </span><span class="s2">simplex</span><span class="s1">[</span><span class="s7">1</span><span class="s1">],</span>
      <span class="s2">c </span><span class="s1">= </span><span class="s2">simplex</span><span class="s1">[</span><span class="s7">0</span><span class="s1">],</span>
      <span class="s2">AB </span><span class="s1">= </span><span class="s2">sub</span><span class="s1">(</span><span class="s2">b</span><span class="s1">, </span><span class="s2">a</span><span class="s1">),</span>
      <span class="s2">AC </span><span class="s1">= </span><span class="s2">sub</span><span class="s1">(</span><span class="s2">c</span><span class="s1">, </span><span class="s2">a</span><span class="s1">),</span>
      <span class="s2">AO </span><span class="s1">= </span><span class="s2">minus</span><span class="s1">(</span><span class="s2">a</span><span class="s1">),</span>
      <span class="s2">ACB </span><span class="s1">= </span><span class="s2">orth</span><span class="s1">(</span><span class="s2">AB</span><span class="s1">, </span><span class="s2">AC</span><span class="s1">), </span><span class="s6">// the vector perpendicular to AB facing away from C</span>
      <span class="s2">ABC </span><span class="s1">= </span><span class="s2">orth</span><span class="s1">(</span><span class="s2">AC</span><span class="s1">, </span><span class="s2">AB</span><span class="s1">); </span><span class="s6">// the vector perpendicular to AC facing away from B</span>

    <span class="s5">if </span><span class="s1">(</span><span class="s2">dot</span><span class="s1">(</span><span class="s2">ACB</span><span class="s1">, </span><span class="s2">AO</span><span class="s1">) &gt; </span><span class="s7">0</span><span class="s1">) {</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">dot</span><span class="s1">(</span><span class="s2">AB</span><span class="s1">, </span><span class="s2">AO</span><span class="s1">) &gt; </span><span class="s7">0</span><span class="s1">) {</span>
        <span class="s6">// region 4</span>
        <span class="s2">set</span><span class="s1">(</span><span class="s2">direction</span><span class="s1">, </span><span class="s2">ACB</span><span class="s1">);</span>
        <span class="s2">simplex</span><span class="s1">.</span><span class="s2">shift</span><span class="s1">(); </span><span class="s6">// simplex = [b, a]</span>
      <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
        <span class="s6">// region 5</span>
        <span class="s2">set</span><span class="s1">(</span><span class="s2">direction</span><span class="s1">, </span><span class="s2">AO</span><span class="s1">);</span>
        <span class="s2">simplex</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s7">0</span><span class="s1">, </span><span class="s7">2</span><span class="s1">); </span><span class="s6">// simplex = [a]</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s5">else if </span><span class="s1">(</span><span class="s2">dot</span><span class="s1">(</span><span class="s2">ABC</span><span class="s1">, </span><span class="s2">AO</span><span class="s1">) &gt; </span><span class="s7">0</span><span class="s1">) {</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">dot</span><span class="s1">(</span><span class="s2">AC</span><span class="s1">, </span><span class="s2">AO</span><span class="s1">) &gt; </span><span class="s7">0</span><span class="s1">) {</span>
        <span class="s6">// region 6</span>
        <span class="s2">set</span><span class="s1">(</span><span class="s2">direction</span><span class="s1">, </span><span class="s2">ABC</span><span class="s1">);</span>
        <span class="s2">simplex</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s7">1</span><span class="s1">, </span><span class="s7">1</span><span class="s1">); </span><span class="s6">// simplex = [c, a]</span>
      <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
        <span class="s6">// region 5 (again)</span>
        <span class="s2">set</span><span class="s1">(</span><span class="s2">direction</span><span class="s1">, </span><span class="s2">AO</span><span class="s1">);</span>
        <span class="s2">simplex</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s7">0</span><span class="s1">, </span><span class="s7">2</span><span class="s1">); </span><span class="s6">// simplex = [a]</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s6">// region 7</span>
    <span class="s5">else return true</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s5">return false</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(v: Array&lt;number&gt;) =&gt; Array&lt;number&gt;}</span>
 <span class="s3">*/</span>
<span class="s5">function </span><span class="s2">minus</span><span class="s1">(</span><span class="s2">v</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s1">[-</span><span class="s2">v</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], -</span><span class="s2">v</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]];</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(v1: Array&lt;number&gt;, v2: Array&lt;number&gt;) =&gt; Array&lt;number&gt;}</span>
 <span class="s3">*/</span>
<span class="s5">function </span><span class="s2">sub</span><span class="s1">(</span><span class="s2">v1</span><span class="s1">, </span><span class="s2">v2</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s1">[</span><span class="s2">v1</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] - </span><span class="s2">v2</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">v1</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] - </span><span class="s2">v2</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]];</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(v1: Array&lt;number&gt;, v2: Array&lt;number&gt;) =&gt; number}</span>
 <span class="s3">*/</span>
<span class="s5">function </span><span class="s2">dot</span><span class="s1">(</span><span class="s2">v1</span><span class="s1">, </span><span class="s2">v2</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">v1</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] * </span><span class="s2">v2</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">v1</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] * </span><span class="s2">v2</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(v1: Array&lt;number&gt;, v2: Array&lt;number&gt;) =&gt; Array&lt;number&gt;}</span>
 <span class="s3">*/</span>
<span class="s5">function </span><span class="s2">orth</span><span class="s1">(</span><span class="s2">v</span><span class="s1">, </span><span class="s2">from</span><span class="s1">) {</span>
  <span class="s5">var </span><span class="s2">o </span><span class="s1">= [-</span><span class="s2">v</span><span class="s1">[</span><span class="s7">1</span><span class="s1">], </span><span class="s2">v</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]];</span>
  <span class="s5">return </span><span class="s2">dot</span><span class="s1">(</span><span class="s2">o</span><span class="s1">, </span><span class="s2">minus</span><span class="s1">(</span><span class="s2">from</span><span class="s1">)) &lt; </span><span class="s7">0 </span><span class="s1">? </span><span class="s2">minus</span><span class="s1">(</span><span class="s2">o</span><span class="s1">) : </span><span class="s2">o</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@typedef </span><span class="s3">{{</span>
 <span class="s3">*   list: Array&lt;Array&lt;number&gt;&gt;,</span>
 <span class="s3">*   minX: number,</span>
 <span class="s3">*   minY: number,</span>
 <span class="s3">*   maxX: number,</span>
 <span class="s3">*   maxY: number</span>
 <span class="s3">* }} Point</span>
 <span class="s3">*/</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@typedef </span><span class="s3">{{</span>
 <span class="s3">*   list: Array&lt;Point&gt;,</span>
 <span class="s3">*   minX: number,</span>
 <span class="s3">*   minY: number,</span>
 <span class="s3">*   maxX: number,</span>
 <span class="s3">*   maxY: number</span>
 <span class="s3">* }} Points</span>
 <span class="s3">*/</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(pathData: Array&lt;PathDataItem&gt;) =&gt; Points}</span>
 <span class="s3">*/</span>
<span class="s5">function </span><span class="s2">gatherPoints</span><span class="s1">(</span><span class="s2">pathData</span><span class="s1">) {</span>
  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{Points}</span>
   <span class="s3">*/</span>
  <span class="s5">const </span><span class="s2">points </span><span class="s1">= { </span><span class="s2">list</span><span class="s1">: [], </span><span class="s2">minX</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s2">minY</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s2">maxX</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s2">maxY</span><span class="s1">: </span><span class="s7">0 </span><span class="s1">};</span>

  <span class="s6">// Writes data about the extreme points on each axle</span>
  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(path: Point, point: Array&lt;number&gt;) =&gt; void}</span>
   <span class="s3">*/</span>
  <span class="s5">const </span><span class="s2">addPoint </span><span class="s1">= (</span><span class="s2">path</span><span class="s1">, </span><span class="s2">point</span><span class="s1">) =&gt; {</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">|| </span><span class="s2">point</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] &gt; </span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">path</span><span class="s1">.</span><span class="s2">maxY</span><span class="s1">][</span><span class="s7">1</span><span class="s1">]) {</span>
      <span class="s2">path</span><span class="s1">.</span><span class="s2">maxY </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
      <span class="s2">points</span><span class="s1">.</span><span class="s2">maxY </span><span class="s1">= </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span>
        <span class="s1">? </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s2">point</span><span class="s1">[</span><span class="s7">1</span><span class="s1">], </span><span class="s2">points</span><span class="s1">.</span><span class="s2">maxY</span><span class="s1">)</span>
        <span class="s1">: </span><span class="s2">point</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">|| </span><span class="s2">point</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] &gt; </span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">path</span><span class="s1">.</span><span class="s2">maxX</span><span class="s1">][</span><span class="s7">0</span><span class="s1">]) {</span>
      <span class="s2">path</span><span class="s1">.</span><span class="s2">maxX </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
      <span class="s2">points</span><span class="s1">.</span><span class="s2">maxX </span><span class="s1">= </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span>
        <span class="s1">? </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s2">point</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">points</span><span class="s1">.</span><span class="s2">maxX</span><span class="s1">)</span>
        <span class="s1">: </span><span class="s2">point</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">|| </span><span class="s2">point</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] &lt; </span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">path</span><span class="s1">.</span><span class="s2">minY</span><span class="s1">][</span><span class="s7">1</span><span class="s1">]) {</span>
      <span class="s2">path</span><span class="s1">.</span><span class="s2">minY </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
      <span class="s2">points</span><span class="s1">.</span><span class="s2">minY </span><span class="s1">= </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span>
        <span class="s1">? </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span><span class="s2">point</span><span class="s1">[</span><span class="s7">1</span><span class="s1">], </span><span class="s2">points</span><span class="s1">.</span><span class="s2">minY</span><span class="s1">)</span>
        <span class="s1">: </span><span class="s2">point</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">|| </span><span class="s2">point</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] &lt; </span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">path</span><span class="s1">.</span><span class="s2">minX</span><span class="s1">][</span><span class="s7">0</span><span class="s1">]) {</span>
      <span class="s2">path</span><span class="s1">.</span><span class="s2">minX </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
      <span class="s2">points</span><span class="s1">.</span><span class="s2">minX </span><span class="s1">= </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span>
        <span class="s1">? </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span><span class="s2">point</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">points</span><span class="s1">.</span><span class="s2">minX</span><span class="s1">)</span>
        <span class="s1">: </span><span class="s2">point</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s2">path</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">point</span><span class="s1">);</span>
  <span class="s1">};</span>

  <span class="s5">for </span><span class="s1">(</span><span class="s5">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">pathData</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i </span><span class="s1">+= </span><span class="s7">1</span><span class="s1">) {</span>
    <span class="s5">const </span><span class="s2">pathDataItem </span><span class="s1">= </span><span class="s2">pathData</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
    <span class="s5">let </span><span class="s2">subPath </span><span class="s1">=</span>
      <span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span>
        <span class="s1">? { </span><span class="s2">list</span><span class="s1">: [], </span><span class="s2">minX</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s2">minY</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s2">maxX</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s2">maxY</span><span class="s1">: </span><span class="s7">0 </span><span class="s1">}</span>
        <span class="s1">: </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">1</span><span class="s1">];</span>
    <span class="s5">let </span><span class="s2">prev </span><span class="s1">= </span><span class="s2">i </span><span class="s1">=== </span><span class="s7">0 </span><span class="s1">? </span><span class="s5">null </span><span class="s1">: </span><span class="s2">pathData</span><span class="s1">[</span><span class="s2">i </span><span class="s1">- </span><span class="s7">1</span><span class="s1">];</span>
    <span class="s5">let </span><span class="s2">basePoint </span><span class="s1">=</span>
      <span class="s2">subPath</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0 </span><span class="s1">? </span><span class="s5">null </span><span class="s1">: </span><span class="s2">subPath</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">subPath</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">1</span><span class="s1">];</span>
    <span class="s5">let </span><span class="s2">data </span><span class="s1">= </span><span class="s2">pathDataItem</span><span class="s1">.</span><span class="s2">args</span><span class="s1">;</span>
    <span class="s5">let </span><span class="s2">ctrlPoint </span><span class="s1">= </span><span class="s2">basePoint</span><span class="s1">;</span>

    <span class="s3">/**</span>
     <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(n: number, i: number) =&gt; number}</span>
     <span class="s3">* TODO fix null hack</span>
     <span class="s3">*/</span>
    <span class="s5">const </span><span class="s2">toAbsolute </span><span class="s1">= (</span><span class="s2">n</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt; </span><span class="s2">n </span><span class="s1">+ (</span><span class="s2">basePoint </span><span class="s1">== </span><span class="s5">null </span><span class="s1">? </span><span class="s7">0 </span><span class="s1">: </span><span class="s2">basePoint</span><span class="s1">[</span><span class="s2">i </span><span class="s1">% </span><span class="s7">2</span><span class="s1">]);</span>

    <span class="s5">switch </span><span class="s1">(</span><span class="s2">pathDataItem</span><span class="s1">.</span><span class="s2">command</span><span class="s1">) {</span>
      <span class="s5">case </span><span class="s0">'M'</span><span class="s1">:</span>
        <span class="s2">subPath </span><span class="s1">= { </span><span class="s2">list</span><span class="s1">: [], </span><span class="s2">minX</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s2">minY</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s2">maxX</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s2">maxY</span><span class="s1">: </span><span class="s7">0 </span><span class="s1">};</span>
        <span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">);</span>
        <span class="s5">break</span><span class="s1">;</span>

      <span class="s5">case </span><span class="s0">'H'</span><span class="s1">:</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">basePoint </span><span class="s1">!= </span><span class="s5">null</span><span class="s1">) {</span>
          <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span><span class="s2">data</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">basePoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]]);</span>
        <span class="s1">}</span>
        <span class="s5">break</span><span class="s1">;</span>

      <span class="s5">case </span><span class="s0">'V'</span><span class="s1">:</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">basePoint </span><span class="s1">!= </span><span class="s5">null</span><span class="s1">) {</span>
          <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span><span class="s2">basePoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">data</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]]);</span>
        <span class="s1">}</span>
        <span class="s5">break</span><span class="s1">;</span>

      <span class="s5">case </span><span class="s0">'Q'</span><span class="s1">:</span>
        <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s7">0</span><span class="s1">, </span><span class="s7">2</span><span class="s1">));</span>
        <span class="s2">prevCtrlPoint </span><span class="s1">= [</span><span class="s2">data</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] - </span><span class="s2">data</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">data</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] - </span><span class="s2">data</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]]; </span><span class="s6">// Save control point for shorthand</span>
        <span class="s5">break</span><span class="s1">;</span>

      <span class="s5">case </span><span class="s0">'T'</span><span class="s1">:</span>
        <span class="s5">if </span><span class="s1">(</span>
          <span class="s2">basePoint </span><span class="s1">!= </span><span class="s5">null </span><span class="s1">&amp;&amp;</span>
          <span class="s2">prev </span><span class="s1">!= </span><span class="s5">null </span><span class="s1">&amp;&amp;</span>
          <span class="s1">(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'Q' </span><span class="s1">|| </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'T'</span><span class="s1">)</span>
        <span class="s1">) {</span>
          <span class="s2">ctrlPoint </span><span class="s1">= [</span>
            <span class="s2">basePoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">prevCtrlPoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">],</span>
            <span class="s2">basePoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s2">prevCtrlPoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">],</span>
          <span class="s1">];</span>
          <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, </span><span class="s2">ctrlPoint</span><span class="s1">);</span>
          <span class="s2">prevCtrlPoint </span><span class="s1">= [</span><span class="s2">data</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] - </span><span class="s2">ctrlPoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">data</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] - </span><span class="s2">ctrlPoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]];</span>
        <span class="s1">}</span>
        <span class="s5">break</span><span class="s1">;</span>

      <span class="s5">case </span><span class="s0">'C'</span><span class="s1">:</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">basePoint </span><span class="s1">!= </span><span class="s5">null</span><span class="s1">) {</span>
          <span class="s6">// Approximate quibic Bezier curve with middle points between control points</span>
          <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span>
            <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">basePoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]),</span>
            <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">basePoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]),</span>
          <span class="s1">]);</span>
        <span class="s1">}</span>
        <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span>
          <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">data</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">2</span><span class="s1">]),</span>
          <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">data</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">3</span><span class="s1">]),</span>
        <span class="s1">]);</span>
        <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span>
          <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">data</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">4</span><span class="s1">]),</span>
          <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">data</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">5</span><span class="s1">]),</span>
        <span class="s1">]);</span>
        <span class="s2">prevCtrlPoint </span><span class="s1">= [</span><span class="s2">data</span><span class="s1">[</span><span class="s7">4</span><span class="s1">] - </span><span class="s2">data</span><span class="s1">[</span><span class="s7">2</span><span class="s1">], </span><span class="s2">data</span><span class="s1">[</span><span class="s7">5</span><span class="s1">] - </span><span class="s2">data</span><span class="s1">[</span><span class="s7">3</span><span class="s1">]]; </span><span class="s6">// Save control point for shorthand</span>
        <span class="s5">break</span><span class="s1">;</span>

      <span class="s5">case </span><span class="s0">'S'</span><span class="s1">:</span>
        <span class="s5">if </span><span class="s1">(</span>
          <span class="s2">basePoint </span><span class="s1">!= </span><span class="s5">null </span><span class="s1">&amp;&amp;</span>
          <span class="s2">prev </span><span class="s1">!= </span><span class="s5">null </span><span class="s1">&amp;&amp;</span>
          <span class="s1">(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'C' </span><span class="s1">|| </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'S'</span><span class="s1">)</span>
        <span class="s1">) {</span>
          <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span>
            <span class="s2">basePoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s7">0.5 </span><span class="s1">* </span><span class="s2">prevCtrlPoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">],</span>
            <span class="s2">basePoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s7">0.5 </span><span class="s1">* </span><span class="s2">prevCtrlPoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">],</span>
          <span class="s1">]);</span>
          <span class="s2">ctrlPoint </span><span class="s1">= [</span>
            <span class="s2">basePoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">prevCtrlPoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">],</span>
            <span class="s2">basePoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s2">prevCtrlPoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">],</span>
          <span class="s1">];</span>
        <span class="s1">}</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">ctrlPoint </span><span class="s1">!= </span><span class="s5">null</span><span class="s1">) {</span>
          <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span>
            <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">ctrlPoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]),</span>
            <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">ctrlPoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]),</span>
          <span class="s1">]);</span>
        <span class="s1">}</span>
        <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span>
          <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">data</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">2</span><span class="s1">]),</span>
          <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">data</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s2">data</span><span class="s1">[</span><span class="s7">3</span><span class="s1">]),</span>
        <span class="s1">]);</span>
        <span class="s2">prevCtrlPoint </span><span class="s1">= [</span><span class="s2">data</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] - </span><span class="s2">data</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">data</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] - </span><span class="s2">data</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]];</span>
        <span class="s5">break</span><span class="s1">;</span>

      <span class="s5">case </span><span class="s0">'A'</span><span class="s1">:</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">basePoint </span><span class="s1">!= </span><span class="s5">null</span><span class="s1">) {</span>
          <span class="s6">// Convert the arc to bezier curves and use the same approximation</span>
          <span class="s6">// @ts-ignore no idea what's going on here</span>
          <span class="s5">var </span><span class="s2">curves </span><span class="s1">= </span><span class="s2">a2c</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s7">0</span><span class="s1">, </span><span class="s2">basePoint</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">data</span><span class="s1">));</span>
          <span class="s5">for </span><span class="s1">(</span>
            <span class="s5">var </span><span class="s2">cData</span><span class="s1">;</span>
            <span class="s1">(</span><span class="s2">cData </span><span class="s1">= </span><span class="s2">curves</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s7">0</span><span class="s1">, </span><span class="s7">6</span><span class="s1">).</span><span class="s2">map</span><span class="s1">(</span><span class="s2">toAbsolute</span><span class="s1">)).</span><span class="s2">length</span><span class="s1">;</span>

          <span class="s1">) {</span>
            <span class="s5">if </span><span class="s1">(</span><span class="s2">basePoint </span><span class="s1">!= </span><span class="s5">null</span><span class="s1">) {</span>
              <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span>
                <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">basePoint</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">cData</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]),</span>
                <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">basePoint</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s2">cData</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]),</span>
              <span class="s1">]);</span>
            <span class="s1">}</span>
            <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span>
              <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">cData</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">cData</span><span class="s1">[</span><span class="s7">2</span><span class="s1">]),</span>
              <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">cData</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s2">cData</span><span class="s1">[</span><span class="s7">3</span><span class="s1">]),</span>
            <span class="s1">]);</span>
            <span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, [</span>
              <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">cData</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] + </span><span class="s2">cData</span><span class="s1">[</span><span class="s7">4</span><span class="s1">]),</span>
              <span class="s7">0.5 </span><span class="s1">* (</span><span class="s2">cData</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] + </span><span class="s2">cData</span><span class="s1">[</span><span class="s7">5</span><span class="s1">]),</span>
            <span class="s1">]);</span>
            <span class="s5">if </span><span class="s1">(</span><span class="s2">curves</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) </span><span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, (</span><span class="s2">basePoint </span><span class="s1">= </span><span class="s2">cData</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(-</span><span class="s7">2</span><span class="s1">)));</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s5">break</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s6">// Save final command coordinates</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">data</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt;= </span><span class="s7">2</span><span class="s1">) </span><span class="s2">addPoint</span><span class="s1">(</span><span class="s2">subPath</span><span class="s1">, </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(-</span><span class="s7">2</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s5">return </span><span class="s2">points</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* Forms a convex hull from set of points of every subpath using monotone chain convex hull algorithm.</span>
 <span class="s3">* https://en.wikibooks.org/wiki/Algorithm_Implementation/Geometry/Convex_hull/Monotone_chain</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(points: Point) =&gt; Point}</span>
 <span class="s3">*/</span>
<span class="s5">function </span><span class="s2">convexHull</span><span class="s1">(</span><span class="s2">points</span><span class="s1">) {</span>
  <span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">(</span><span class="s5">function </span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
    <span class="s5">return </span><span class="s2">a</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] == </span><span class="s2">b</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] ? </span><span class="s2">a</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] - </span><span class="s2">b</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] : </span><span class="s2">a</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] - </span><span class="s2">b</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
  <span class="s1">});</span>

  <span class="s5">var </span><span class="s2">lower </span><span class="s1">= [],</span>
    <span class="s2">minY </span><span class="s1">= </span><span class="s7">0</span><span class="s1">,</span>
    <span class="s2">bottom </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>
  <span class="s5">for </span><span class="s1">(</span><span class="s5">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
    <span class="s5">while </span><span class="s1">(</span>
      <span class="s2">lower</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt;= </span><span class="s7">2 </span><span class="s1">&amp;&amp;</span>
      <span class="s2">cross</span><span class="s1">(</span><span class="s2">lower</span><span class="s1">[</span><span class="s2">lower</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">2</span><span class="s1">], </span><span class="s2">lower</span><span class="s1">[</span><span class="s2">lower</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">1</span><span class="s1">], </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]) &lt;=</span>
        <span class="s7">0</span>
    <span class="s1">) {</span>
      <span class="s2">lower</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">i</span><span class="s1">][</span><span class="s7">1</span><span class="s1">] &lt; </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">minY</span><span class="s1">][</span><span class="s7">1</span><span class="s1">]) {</span>
      <span class="s2">minY </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
      <span class="s2">bottom </span><span class="s1">= </span><span class="s2">lower</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">lower</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]);</span>
  <span class="s1">}</span>

  <span class="s5">var </span><span class="s2">upper </span><span class="s1">= [],</span>
    <span class="s2">maxY </span><span class="s1">= </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">1</span><span class="s1">,</span>
    <span class="s2">top </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>
  <span class="s5">for </span><span class="s1">(</span><span class="s5">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">--; ) {</span>
    <span class="s5">while </span><span class="s1">(</span>
      <span class="s2">upper</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt;= </span><span class="s7">2 </span><span class="s1">&amp;&amp;</span>
      <span class="s2">cross</span><span class="s1">(</span><span class="s2">upper</span><span class="s1">[</span><span class="s2">upper</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">2</span><span class="s1">], </span><span class="s2">upper</span><span class="s1">[</span><span class="s2">upper</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s7">1</span><span class="s1">], </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]) &lt;=</span>
        <span class="s7">0</span>
    <span class="s1">) {</span>
      <span class="s2">upper</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">i</span><span class="s1">][</span><span class="s7">1</span><span class="s1">] &gt; </span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">maxY</span><span class="s1">][</span><span class="s7">1</span><span class="s1">]) {</span>
      <span class="s2">maxY </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
      <span class="s2">top </span><span class="s1">= </span><span class="s2">upper</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">upper</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">points</span><span class="s1">.</span><span class="s2">list</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]);</span>
  <span class="s1">}</span>

  <span class="s6">// last points are equal to starting points of the other part</span>
  <span class="s2">upper</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>
  <span class="s2">lower</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>

  <span class="s5">const </span><span class="s2">hullList </span><span class="s1">= </span><span class="s2">lower</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">upper</span><span class="s1">);</span>

  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{Point}</span>
   <span class="s3">*/</span>
  <span class="s5">const </span><span class="s2">hull </span><span class="s1">= {</span>
    <span class="s2">list</span><span class="s1">: </span><span class="s2">hullList</span><span class="s1">,</span>
    <span class="s2">minX</span><span class="s1">: </span><span class="s7">0</span><span class="s1">, </span><span class="s6">// by sorting</span>
    <span class="s2">maxX</span><span class="s1">: </span><span class="s2">lower</span><span class="s1">.</span><span class="s2">length</span><span class="s1">,</span>
    <span class="s2">minY</span><span class="s1">: </span><span class="s2">bottom</span><span class="s1">,</span>
    <span class="s2">maxY</span><span class="s1">: (</span><span class="s2">lower</span><span class="s1">.</span><span class="s2">length </span><span class="s1">+ </span><span class="s2">top</span><span class="s1">) % </span><span class="s2">hullList</span><span class="s1">.</span><span class="s2">length</span><span class="s1">,</span>
  <span class="s1">};</span>

  <span class="s5">return </span><span class="s2">hull</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(o: Array&lt;number&gt;, a: Array&lt;number&gt;, b: Array&lt;number&gt;) =&gt; number}</span>
 <span class="s3">*/</span>
<span class="s5">function </span><span class="s2">cross</span><span class="s1">(</span><span class="s2">o</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s1">(</span><span class="s2">a</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] - </span><span class="s2">o</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) * (</span><span class="s2">b</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] - </span><span class="s2">o</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]) - (</span><span class="s2">a</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] - </span><span class="s2">o</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]) * (</span><span class="s2">b</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] - </span><span class="s2">o</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]);</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* Based on code from Snap.svg (Apache 2 license). http://snapsvg.io/</span>
 <span class="s3">* Thanks to Dmitry Baranovskiy for his great work!</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(</span>
 <span class="s3">*  x1: number,</span>
 <span class="s3">*  y1: number,</span>
 <span class="s3">*  rx: number,</span>
 <span class="s3">*  ry: number,</span>
 <span class="s3">*  angle: number,</span>
 <span class="s3">*  large_arc_flag: number,</span>
 <span class="s3">*  sweep_flag: number,</span>
 <span class="s3">*  x2: number,</span>
 <span class="s3">*  y2: number,</span>
 <span class="s3">*  recursive: Array&lt;number&gt;</span>
 <span class="s3">* ) =&gt; Array&lt;number&gt;}</span>
 <span class="s3">*/</span>
<span class="s5">const </span><span class="s2">a2c </span><span class="s1">= (</span>
  <span class="s2">x1</span><span class="s1">,</span>
  <span class="s2">y1</span><span class="s1">,</span>
  <span class="s2">rx</span><span class="s1">,</span>
  <span class="s2">ry</span><span class="s1">,</span>
  <span class="s2">angle</span><span class="s1">,</span>
  <span class="s2">large_arc_flag</span><span class="s1">,</span>
  <span class="s2">sweep_flag</span><span class="s1">,</span>
  <span class="s2">x2</span><span class="s1">,</span>
  <span class="s2">y2</span><span class="s1">,</span>
  <span class="s2">recursive</span>
<span class="s1">) =&gt; {</span>
  <span class="s6">// for more information of where this Math came from visit:</span>
  <span class="s6">// https://www.w3.org/TR/SVG11/implnote.html#ArcImplementationNotes</span>
  <span class="s5">const </span><span class="s2">_120 </span><span class="s1">= (</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">* </span><span class="s7">120</span><span class="s1">) / </span><span class="s7">180</span><span class="s1">;</span>
  <span class="s5">const </span><span class="s2">rad </span><span class="s1">= (</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">/ </span><span class="s7">180</span><span class="s1">) * (+</span><span class="s2">angle </span><span class="s1">|| </span><span class="s7">0</span><span class="s1">);</span>
  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{Array&lt;number&gt;}</span>
   <span class="s3">*/</span>
  <span class="s5">let </span><span class="s2">res </span><span class="s1">= [];</span>
  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(x: number, y: number, rad: number) =&gt; number}</span>
   <span class="s3">*/</span>
  <span class="s5">const </span><span class="s2">rotateX </span><span class="s1">= (</span><span class="s2">x</span><span class="s1">, </span><span class="s2">y</span><span class="s1">, </span><span class="s2">rad</span><span class="s1">) =&gt; {</span>
    <span class="s5">return </span><span class="s2">x </span><span class="s1">* </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">cos</span><span class="s1">(</span><span class="s2">rad</span><span class="s1">) - </span><span class="s2">y </span><span class="s1">* </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">sin</span><span class="s1">(</span><span class="s2">rad</span><span class="s1">);</span>
  <span class="s1">};</span>
  <span class="s3">/**</span>
   <span class="s3">* </span><span class="s4">@type </span><span class="s3">{(x: number, y: number, rad: number) =&gt; number}</span>
   <span class="s3">*/</span>
  <span class="s5">const </span><span class="s2">rotateY </span><span class="s1">= (</span><span class="s2">x</span><span class="s1">, </span><span class="s2">y</span><span class="s1">, </span><span class="s2">rad</span><span class="s1">) =&gt; {</span>
    <span class="s5">return </span><span class="s2">x </span><span class="s1">* </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">sin</span><span class="s1">(</span><span class="s2">rad</span><span class="s1">) + </span><span class="s2">y </span><span class="s1">* </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">cos</span><span class="s1">(</span><span class="s2">rad</span><span class="s1">);</span>
  <span class="s1">};</span>
  <span class="s5">if </span><span class="s1">(!</span><span class="s2">recursive</span><span class="s1">) {</span>
    <span class="s2">x1 </span><span class="s1">= </span><span class="s2">rotateX</span><span class="s1">(</span><span class="s2">x1</span><span class="s1">, </span><span class="s2">y1</span><span class="s1">, -</span><span class="s2">rad</span><span class="s1">);</span>
    <span class="s2">y1 </span><span class="s1">= </span><span class="s2">rotateY</span><span class="s1">(</span><span class="s2">x1</span><span class="s1">, </span><span class="s2">y1</span><span class="s1">, -</span><span class="s2">rad</span><span class="s1">);</span>
    <span class="s2">x2 </span><span class="s1">= </span><span class="s2">rotateX</span><span class="s1">(</span><span class="s2">x2</span><span class="s1">, </span><span class="s2">y2</span><span class="s1">, -</span><span class="s2">rad</span><span class="s1">);</span>
    <span class="s2">y2 </span><span class="s1">= </span><span class="s2">rotateY</span><span class="s1">(</span><span class="s2">x2</span><span class="s1">, </span><span class="s2">y2</span><span class="s1">, -</span><span class="s2">rad</span><span class="s1">);</span>
    <span class="s5">var </span><span class="s2">x </span><span class="s1">= (</span><span class="s2">x1 </span><span class="s1">- </span><span class="s2">x2</span><span class="s1">) / </span><span class="s7">2</span><span class="s1">,</span>
      <span class="s2">y </span><span class="s1">= (</span><span class="s2">y1 </span><span class="s1">- </span><span class="s2">y2</span><span class="s1">) / </span><span class="s7">2</span><span class="s1">;</span>
    <span class="s5">var </span><span class="s2">h </span><span class="s1">= (</span><span class="s2">x </span><span class="s1">* </span><span class="s2">x</span><span class="s1">) / (</span><span class="s2">rx </span><span class="s1">* </span><span class="s2">rx</span><span class="s1">) + (</span><span class="s2">y </span><span class="s1">* </span><span class="s2">y</span><span class="s1">) / (</span><span class="s2">ry </span><span class="s1">* </span><span class="s2">ry</span><span class="s1">);</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">h </span><span class="s1">&gt; </span><span class="s7">1</span><span class="s1">) {</span>
      <span class="s2">h </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">sqrt</span><span class="s1">(</span><span class="s2">h</span><span class="s1">);</span>
      <span class="s2">rx </span><span class="s1">= </span><span class="s2">h </span><span class="s1">* </span><span class="s2">rx</span><span class="s1">;</span>
      <span class="s2">ry </span><span class="s1">= </span><span class="s2">h </span><span class="s1">* </span><span class="s2">ry</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">var </span><span class="s2">rx2 </span><span class="s1">= </span><span class="s2">rx </span><span class="s1">* </span><span class="s2">rx</span><span class="s1">;</span>
    <span class="s5">var </span><span class="s2">ry2 </span><span class="s1">= </span><span class="s2">ry </span><span class="s1">* </span><span class="s2">ry</span><span class="s1">;</span>
    <span class="s5">var </span><span class="s2">k </span><span class="s1">=</span>
      <span class="s1">(</span><span class="s2">large_arc_flag </span><span class="s1">== </span><span class="s2">sweep_flag </span><span class="s1">? -</span><span class="s7">1 </span><span class="s1">: </span><span class="s7">1</span><span class="s1">) *</span>
      <span class="s2">Math</span><span class="s1">.</span><span class="s2">sqrt</span><span class="s1">(</span>
        <span class="s2">Math</span><span class="s1">.</span><span class="s2">abs</span><span class="s1">(</span>
          <span class="s1">(</span><span class="s2">rx2 </span><span class="s1">* </span><span class="s2">ry2 </span><span class="s1">- </span><span class="s2">rx2 </span><span class="s1">* </span><span class="s2">y </span><span class="s1">* </span><span class="s2">y </span><span class="s1">- </span><span class="s2">ry2 </span><span class="s1">* </span><span class="s2">x </span><span class="s1">* </span><span class="s2">x</span><span class="s1">) / (</span><span class="s2">rx2 </span><span class="s1">* </span><span class="s2">y </span><span class="s1">* </span><span class="s2">y </span><span class="s1">+ </span><span class="s2">ry2 </span><span class="s1">* </span><span class="s2">x </span><span class="s1">* </span><span class="s2">x</span><span class="s1">)</span>
        <span class="s1">)</span>
      <span class="s1">);</span>
    <span class="s5">var </span><span class="s2">cx </span><span class="s1">= (</span><span class="s2">k </span><span class="s1">* </span><span class="s2">rx </span><span class="s1">* </span><span class="s2">y</span><span class="s1">) / </span><span class="s2">ry </span><span class="s1">+ (</span><span class="s2">x1 </span><span class="s1">+ </span><span class="s2">x2</span><span class="s1">) / </span><span class="s7">2</span><span class="s1">;</span>
    <span class="s5">var </span><span class="s2">cy </span><span class="s1">= (</span><span class="s2">k </span><span class="s1">* -</span><span class="s2">ry </span><span class="s1">* </span><span class="s2">x</span><span class="s1">) / </span><span class="s2">rx </span><span class="s1">+ (</span><span class="s2">y1 </span><span class="s1">+ </span><span class="s2">y2</span><span class="s1">) / </span><span class="s7">2</span><span class="s1">;</span>
    <span class="s5">var </span><span class="s2">f1 </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">asin</span><span class="s1">(</span><span class="s2">Number</span><span class="s1">(((</span><span class="s2">y1 </span><span class="s1">- </span><span class="s2">cy</span><span class="s1">) / </span><span class="s2">ry</span><span class="s1">).</span><span class="s2">toFixed</span><span class="s1">(</span><span class="s7">9</span><span class="s1">)));</span>
    <span class="s5">var </span><span class="s2">f2 </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">asin</span><span class="s1">(</span><span class="s2">Number</span><span class="s1">(((</span><span class="s2">y2 </span><span class="s1">- </span><span class="s2">cy</span><span class="s1">) / </span><span class="s2">ry</span><span class="s1">).</span><span class="s2">toFixed</span><span class="s1">(</span><span class="s7">9</span><span class="s1">)));</span>

    <span class="s2">f1 </span><span class="s1">= </span><span class="s2">x1 </span><span class="s1">&lt; </span><span class="s2">cx </span><span class="s1">? </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">- </span><span class="s2">f1 </span><span class="s1">: </span><span class="s2">f1</span><span class="s1">;</span>
    <span class="s2">f2 </span><span class="s1">= </span><span class="s2">x2 </span><span class="s1">&lt; </span><span class="s2">cx </span><span class="s1">? </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">- </span><span class="s2">f2 </span><span class="s1">: </span><span class="s2">f2</span><span class="s1">;</span>
    <span class="s2">f1 </span><span class="s1">&lt; </span><span class="s7">0 </span><span class="s1">&amp;&amp; (</span><span class="s2">f1 </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">* </span><span class="s7">2 </span><span class="s1">+ </span><span class="s2">f1</span><span class="s1">);</span>
    <span class="s2">f2 </span><span class="s1">&lt; </span><span class="s7">0 </span><span class="s1">&amp;&amp; (</span><span class="s2">f2 </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">* </span><span class="s7">2 </span><span class="s1">+ </span><span class="s2">f2</span><span class="s1">);</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">sweep_flag </span><span class="s1">&amp;&amp; </span><span class="s2">f1 </span><span class="s1">&gt; </span><span class="s2">f2</span><span class="s1">) {</span>
      <span class="s2">f1 </span><span class="s1">= </span><span class="s2">f1 </span><span class="s1">- </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">* </span><span class="s7">2</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">sweep_flag </span><span class="s1">&amp;&amp; </span><span class="s2">f2 </span><span class="s1">&gt; </span><span class="s2">f1</span><span class="s1">) {</span>
      <span class="s2">f2 </span><span class="s1">= </span><span class="s2">f2 </span><span class="s1">- </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">* </span><span class="s7">2</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
    <span class="s2">f1 </span><span class="s1">= </span><span class="s2">recursive</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
    <span class="s2">f2 </span><span class="s1">= </span><span class="s2">recursive</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
    <span class="s2">cx </span><span class="s1">= </span><span class="s2">recursive</span><span class="s1">[</span><span class="s7">2</span><span class="s1">];</span>
    <span class="s2">cy </span><span class="s1">= </span><span class="s2">recursive</span><span class="s1">[</span><span class="s7">3</span><span class="s1">];</span>
  <span class="s1">}</span>
  <span class="s5">var </span><span class="s2">df </span><span class="s1">= </span><span class="s2">f2 </span><span class="s1">- </span><span class="s2">f1</span><span class="s1">;</span>
  <span class="s5">if </span><span class="s1">(</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">abs</span><span class="s1">(</span><span class="s2">df</span><span class="s1">) &gt; </span><span class="s2">_120</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">f2old </span><span class="s1">= </span><span class="s2">f2</span><span class="s1">,</span>
      <span class="s2">x2old </span><span class="s1">= </span><span class="s2">x2</span><span class="s1">,</span>
      <span class="s2">y2old </span><span class="s1">= </span><span class="s2">y2</span><span class="s1">;</span>
    <span class="s2">f2 </span><span class="s1">= </span><span class="s2">f1 </span><span class="s1">+ </span><span class="s2">_120 </span><span class="s1">* (</span><span class="s2">sweep_flag </span><span class="s1">&amp;&amp; </span><span class="s2">f2 </span><span class="s1">&gt; </span><span class="s2">f1 </span><span class="s1">? </span><span class="s7">1 </span><span class="s1">: -</span><span class="s7">1</span><span class="s1">);</span>
    <span class="s2">x2 </span><span class="s1">= </span><span class="s2">cx </span><span class="s1">+ </span><span class="s2">rx </span><span class="s1">* </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">cos</span><span class="s1">(</span><span class="s2">f2</span><span class="s1">);</span>
    <span class="s2">y2 </span><span class="s1">= </span><span class="s2">cy </span><span class="s1">+ </span><span class="s2">ry </span><span class="s1">* </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">sin</span><span class="s1">(</span><span class="s2">f2</span><span class="s1">);</span>
    <span class="s2">res </span><span class="s1">= </span><span class="s2">a2c</span><span class="s1">(</span><span class="s2">x2</span><span class="s1">, </span><span class="s2">y2</span><span class="s1">, </span><span class="s2">rx</span><span class="s1">, </span><span class="s2">ry</span><span class="s1">, </span><span class="s2">angle</span><span class="s1">, </span><span class="s7">0</span><span class="s1">, </span><span class="s2">sweep_flag</span><span class="s1">, </span><span class="s2">x2old</span><span class="s1">, </span><span class="s2">y2old</span><span class="s1">, [</span>
      <span class="s2">f2</span><span class="s1">,</span>
      <span class="s2">f2old</span><span class="s1">,</span>
      <span class="s2">cx</span><span class="s1">,</span>
      <span class="s2">cy</span><span class="s1">,</span>
    <span class="s1">]);</span>
  <span class="s1">}</span>
  <span class="s2">df </span><span class="s1">= </span><span class="s2">f2 </span><span class="s1">- </span><span class="s2">f1</span><span class="s1">;</span>
  <span class="s5">var </span><span class="s2">c1 </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">cos</span><span class="s1">(</span><span class="s2">f1</span><span class="s1">),</span>
    <span class="s2">s1 </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">sin</span><span class="s1">(</span><span class="s2">f1</span><span class="s1">),</span>
    <span class="s2">c2 </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">cos</span><span class="s1">(</span><span class="s2">f2</span><span class="s1">),</span>
    <span class="s2">s2 </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">sin</span><span class="s1">(</span><span class="s2">f2</span><span class="s1">),</span>
    <span class="s2">t </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">tan</span><span class="s1">(</span><span class="s2">df </span><span class="s1">/ </span><span class="s7">4</span><span class="s1">),</span>
    <span class="s2">hx </span><span class="s1">= (</span><span class="s7">4 </span><span class="s1">/ </span><span class="s7">3</span><span class="s1">) * </span><span class="s2">rx </span><span class="s1">* </span><span class="s2">t</span><span class="s1">,</span>
    <span class="s2">hy </span><span class="s1">= (</span><span class="s7">4 </span><span class="s1">/ </span><span class="s7">3</span><span class="s1">) * </span><span class="s2">ry </span><span class="s1">* </span><span class="s2">t</span><span class="s1">,</span>
    <span class="s2">m </span><span class="s1">= [</span>
      <span class="s1">-</span><span class="s2">hx </span><span class="s1">* </span><span class="s2">s1</span><span class="s1">,</span>
      <span class="s2">hy </span><span class="s1">* </span><span class="s2">c1</span><span class="s1">,</span>
      <span class="s2">x2 </span><span class="s1">+ </span><span class="s2">hx </span><span class="s1">* </span><span class="s2">s2 </span><span class="s1">- </span><span class="s2">x1</span><span class="s1">,</span>
      <span class="s2">y2 </span><span class="s1">- </span><span class="s2">hy </span><span class="s1">* </span><span class="s2">c2 </span><span class="s1">- </span><span class="s2">y1</span><span class="s1">,</span>
      <span class="s2">x2 </span><span class="s1">- </span><span class="s2">x1</span><span class="s1">,</span>
      <span class="s2">y2 </span><span class="s1">- </span><span class="s2">y1</span><span class="s1">,</span>
    <span class="s1">];</span>
  <span class="s5">if </span><span class="s1">(</span><span class="s2">recursive</span><span class="s1">) {</span>
    <span class="s5">return </span><span class="s2">m</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
    <span class="s2">res </span><span class="s1">= </span><span class="s2">m</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
    <span class="s5">var </span><span class="s2">newres </span><span class="s1">= [];</span>
    <span class="s5">for </span><span class="s1">(</span><span class="s5">var </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">, </span><span class="s2">n </span><span class="s1">= </span><span class="s2">res</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">n</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
      <span class="s2">newres</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] =</span>
        <span class="s2">i </span><span class="s1">% </span><span class="s7">2</span>
          <span class="s1">? </span><span class="s2">rotateY</span><span class="s1">(</span><span class="s2">res</span><span class="s1">[</span><span class="s2">i </span><span class="s1">- </span><span class="s7">1</span><span class="s1">], </span><span class="s2">res</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">rad</span><span class="s1">)</span>
          <span class="s1">: </span><span class="s2">rotateX</span><span class="s1">(</span><span class="s2">res</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">res</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s7">1</span><span class="s1">], </span><span class="s2">rad</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s5">return </span><span class="s2">newres</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>
</pre>
</body>
</html>