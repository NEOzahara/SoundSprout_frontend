<html>
<head>
<title>argument_parser.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #bcbec4;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
.s7 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
argument_parser.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* class ArgumentParser</span>
 <span class="s0">*</span>
 <span class="s0">* Object for parsing command line strings into js objects.</span>
 <span class="s0">*</span>
 <span class="s0">* Inherited from [[ActionContainer]]</span>
 <span class="s0">**/</span>
<span class="s2">'use strict'</span><span class="s3">;</span>

<span class="s4">var </span><span class="s1">util    </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'util'</span><span class="s3">);</span>
<span class="s4">var </span><span class="s1">format  </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'util'</span><span class="s3">).</span><span class="s1">format</span><span class="s3">;</span>
<span class="s4">var </span><span class="s1">Path    </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'path'</span><span class="s3">);</span>
<span class="s4">var </span><span class="s1">sprintf </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'sprintf-js'</span><span class="s3">).</span><span class="s1">sprintf</span><span class="s3">;</span>

<span class="s5">// Constants</span>
<span class="s4">var </span><span class="s1">c </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./const'</span><span class="s3">);</span>

<span class="s4">var </span><span class="s1">$$ </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./utils'</span><span class="s3">);</span>

<span class="s4">var </span><span class="s1">ActionContainer </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./action_container'</span><span class="s3">);</span>

<span class="s5">// Errors</span>
<span class="s4">var </span><span class="s1">argumentErrorHelper </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./argument/error'</span><span class="s3">);</span>

<span class="s4">var </span><span class="s1">HelpFormatter </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./help/formatter'</span><span class="s3">);</span>

<span class="s4">var </span><span class="s1">Namespace </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./namespace'</span><span class="s3">);</span>


<span class="s0">/**</span>
 <span class="s0">* new ArgumentParser(options)</span>
 <span class="s0">*</span>
 <span class="s0">* Create a new ArgumentParser object.</span>
 <span class="s0">*</span>
 <span class="s0">* ##### Options:</span>
 <span class="s0">* - `prog`  The name of the program (default: Path.basename(process.argv[1]))</span>
 <span class="s0">* - `usage`  A usage message (default: auto-generated from arguments)</span>
 <span class="s0">* - `description`  A description of what the program does</span>
 <span class="s0">* - `epilog`  Text following the argument descriptions</span>
 <span class="s0">* - `parents`  Parsers whose arguments should be copied into this one</span>
 <span class="s0">* - `formatterClass`  HelpFormatter class for printing help messages</span>
 <span class="s0">* - `prefixChars`  Characters that prefix optional arguments</span>
 <span class="s0">* - `fromfilePrefixChars` Characters that prefix files containing additional arguments</span>
 <span class="s0">* - `argumentDefault`  The default value for all arguments</span>
 <span class="s0">* - `addHelp`  Add a -h/-help option</span>
 <span class="s0">* - `conflictHandler`  Specifies how to handle conflicting argument names</span>
 <span class="s0">* - `debug`  Enable debug mode. Argument errors throw exception in</span>
 <span class="s0">*   debug mode and process.exit in normal. Used for development and</span>
 <span class="s0">*   testing (default: false)</span>
 <span class="s0">*</span>
 <span class="s0">* See also [original guide][1]</span>
 <span class="s0">*</span>
 <span class="s0">* [1]:http://docs.python.org/dev/library/argparse.html#argumentparser-objects</span>
 <span class="s0">**/</span>
<span class="s4">function </span><span class="s1">ArgumentParser</span><span class="s3">(</span><span class="s1">options</span><span class="s3">) {</span>
  <span class="s4">if </span><span class="s3">(!(</span><span class="s4">this instanceof </span><span class="s1">ArgumentParser</span><span class="s3">)) {</span>
    <span class="s4">return new </span><span class="s1">ArgumentParser</span><span class="s3">(</span><span class="s1">options</span><span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s4">var </span><span class="s1">self </span><span class="s3">= </span><span class="s4">this</span><span class="s3">;</span>
  <span class="s1">options </span><span class="s3">= </span><span class="s1">options </span><span class="s3">|| {};</span>

  <span class="s1">options</span><span class="s3">.</span><span class="s1">description </span><span class="s3">= (</span><span class="s1">options</span><span class="s3">.</span><span class="s1">description </span><span class="s3">|| </span><span class="s4">null</span><span class="s3">);</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">argumentDefault </span><span class="s3">= (</span><span class="s1">options</span><span class="s3">.</span><span class="s1">argumentDefault </span><span class="s3">|| </span><span class="s4">null</span><span class="s3">);</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">prefixChars </span><span class="s3">= (</span><span class="s1">options</span><span class="s3">.</span><span class="s1">prefixChars </span><span class="s3">|| </span><span class="s2">'-'</span><span class="s3">);</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">conflictHandler </span><span class="s3">= (</span><span class="s1">options</span><span class="s3">.</span><span class="s1">conflictHandler </span><span class="s3">|| </span><span class="s2">'error'</span><span class="s3">);</span>
  <span class="s1">ActionContainer</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s4">this</span><span class="s3">, </span><span class="s1">options</span><span class="s3">);</span>

  <span class="s1">options</span><span class="s3">.</span><span class="s1">addHelp </span><span class="s3">= </span><span class="s4">typeof </span><span class="s1">options</span><span class="s3">.</span><span class="s1">addHelp </span><span class="s3">=== </span><span class="s2">'undefined' </span><span class="s3">|| !!</span><span class="s1">options</span><span class="s3">.</span><span class="s1">addHelp</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">parents </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">parents </span><span class="s3">|| [];</span>
  <span class="s5">// default program name</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">prog </span><span class="s3">= (</span><span class="s1">options</span><span class="s3">.</span><span class="s1">prog </span><span class="s3">|| </span><span class="s1">Path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">process</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]));</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">prog </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">prog</span><span class="s3">;</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">usage </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">usage</span><span class="s3">;</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">epilog </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">epilog</span><span class="s3">;</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">version </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">version</span><span class="s3">;</span>

  <span class="s4">this</span><span class="s3">.</span><span class="s1">debug </span><span class="s3">= (</span><span class="s1">options</span><span class="s3">.</span><span class="s1">debug </span><span class="s3">=== </span><span class="s4">true</span><span class="s3">);</span>

  <span class="s4">this</span><span class="s3">.</span><span class="s1">formatterClass </span><span class="s3">= (</span><span class="s1">options</span><span class="s3">.</span><span class="s1">formatterClass </span><span class="s3">|| </span><span class="s1">HelpFormatter</span><span class="s3">);</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">fromfilePrefixChars </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">fromfilePrefixChars </span><span class="s3">|| </span><span class="s4">null</span><span class="s3">;</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">_positionals </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">addArgumentGroup</span><span class="s3">({ </span><span class="s1">title</span><span class="s3">: </span><span class="s2">'Positional arguments' </span><span class="s3">});</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">_optionals </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">addArgumentGroup</span><span class="s3">({ </span><span class="s1">title</span><span class="s3">: </span><span class="s2">'Optional arguments' </span><span class="s3">});</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">_subparsers </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>

  <span class="s5">// register types</span>
  <span class="s4">function </span><span class="s1">FUNCTION_IDENTITY</span><span class="s3">(</span><span class="s1">o</span><span class="s3">) {</span>
    <span class="s4">return </span><span class="s1">o</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s2">'type'</span><span class="s3">, </span><span class="s2">'auto'</span><span class="s3">, </span><span class="s1">FUNCTION_IDENTITY</span><span class="s3">);</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s2">'type'</span><span class="s3">, </span><span class="s4">null</span><span class="s3">, </span><span class="s1">FUNCTION_IDENTITY</span><span class="s3">);</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s2">'type'</span><span class="s3">, </span><span class="s2">'int'</span><span class="s3">, </span><span class="s4">function </span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
    <span class="s4">var </span><span class="s1">result </span><span class="s3">= </span><span class="s1">parseInt</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s6">10</span><span class="s3">);</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">isNaN</span><span class="s3">(</span><span class="s1">result</span><span class="s3">)) {</span>
      <span class="s4">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s2">' is not a valid integer.'</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s4">return </span><span class="s1">result</span><span class="s3">;</span>
  <span class="s3">});</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s2">'type'</span><span class="s3">, </span><span class="s2">'float'</span><span class="s3">, </span><span class="s4">function </span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
    <span class="s4">var </span><span class="s1">result </span><span class="s3">= </span><span class="s1">parseFloat</span><span class="s3">(</span><span class="s1">x</span><span class="s3">);</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">isNaN</span><span class="s3">(</span><span class="s1">result</span><span class="s3">)) {</span>
      <span class="s4">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s2">' is not a valid float.'</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s4">return </span><span class="s1">result</span><span class="s3">;</span>
  <span class="s3">});</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s2">'type'</span><span class="s3">, </span><span class="s2">'string'</span><span class="s3">, </span><span class="s4">function </span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
    <span class="s4">return </span><span class="s2">'' </span><span class="s3">+ </span><span class="s1">x</span><span class="s3">;</span>
  <span class="s3">});</span>

  <span class="s5">// add help and version arguments if necessary</span>
  <span class="s4">var </span><span class="s1">defaultPrefix </span><span class="s3">= (</span><span class="s4">this</span><span class="s3">.</span><span class="s1">prefixChars</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'-'</span><span class="s3">) &gt; -</span><span class="s6">1</span><span class="s3">) ? </span><span class="s2">'-' </span><span class="s3">: </span><span class="s4">this</span><span class="s3">.</span><span class="s1">prefixChars</span><span class="s3">[</span><span class="s6">0</span><span class="s3">];</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">addHelp</span><span class="s3">) {</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">addArgument</span><span class="s3">(</span>
      <span class="s3">[ </span><span class="s1">defaultPrefix </span><span class="s3">+ </span><span class="s2">'h'</span><span class="s3">, </span><span class="s1">defaultPrefix </span><span class="s3">+ </span><span class="s1">defaultPrefix </span><span class="s3">+ </span><span class="s2">'help' </span><span class="s3">],</span>
      <span class="s3">{</span>
        <span class="s1">action</span><span class="s3">: </span><span class="s2">'help'</span><span class="s3">,</span>
        <span class="s1">defaultValue</span><span class="s3">: </span><span class="s1">c</span><span class="s3">.</span><span class="s1">SUPPRESS</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">: </span><span class="s2">'Show this help message and exit.'</span>
      <span class="s3">}</span>
    <span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof this</span><span class="s3">.</span><span class="s1">version </span><span class="s3">!== </span><span class="s2">'undefined'</span><span class="s3">) {</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">addArgument</span><span class="s3">(</span>
      <span class="s3">[ </span><span class="s1">defaultPrefix </span><span class="s3">+ </span><span class="s2">'v'</span><span class="s3">, </span><span class="s1">defaultPrefix </span><span class="s3">+ </span><span class="s1">defaultPrefix </span><span class="s3">+ </span><span class="s2">'version' </span><span class="s3">],</span>
      <span class="s3">{</span>
        <span class="s1">action</span><span class="s3">: </span><span class="s2">'version'</span><span class="s3">,</span>
        <span class="s1">version</span><span class="s3">: </span><span class="s4">this</span><span class="s3">.</span><span class="s1">version</span><span class="s3">,</span>
        <span class="s1">defaultValue</span><span class="s3">: </span><span class="s1">c</span><span class="s3">.</span><span class="s1">SUPPRESS</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">: </span><span class="s2">&quot;Show program's version number and exit.&quot;</span>
      <span class="s3">}</span>
    <span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s5">// add parent arguments and defaults</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">parents</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">parent</span><span class="s3">) {</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">_addContainerActions</span><span class="s3">(</span><span class="s1">parent</span><span class="s3">);</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">_defaults </span><span class="s3">!== </span><span class="s2">'undefined'</span><span class="s3">) {</span>
      <span class="s4">for </span><span class="s3">(</span><span class="s4">var </span><span class="s1">defaultKey </span><span class="s4">in </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">_defaults</span><span class="s3">) {</span>
        <span class="s4">if </span><span class="s3">(</span><span class="s1">parent</span><span class="s3">.</span><span class="s1">_defaults</span><span class="s3">.</span><span class="s1">hasOwnProperty</span><span class="s3">(</span><span class="s1">defaultKey</span><span class="s3">)) {</span>
          <span class="s1">self</span><span class="s3">.</span><span class="s1">_defaults</span><span class="s3">[</span><span class="s1">defaultKey</span><span class="s3">] = </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">_defaults</span><span class="s3">[</span><span class="s1">defaultKey</span><span class="s3">];</span>
        <span class="s3">}</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
  <span class="s3">});</span>
<span class="s3">}</span>

<span class="s1">util</span><span class="s3">.</span><span class="s1">inherits</span><span class="s3">(</span><span class="s1">ArgumentParser</span><span class="s3">, </span><span class="s1">ActionContainer</span><span class="s3">);</span>

<span class="s0">/**</span>
 <span class="s0">* ArgumentParser#addSubparsers(options) -&gt; [[ActionSubparsers]]</span>
 <span class="s0">* - options (object): hash of options see [[ActionSubparsers.new]]</span>
 <span class="s0">*</span>
 <span class="s0">* See also [subcommands][1]</span>
 <span class="s0">*</span>
 <span class="s0">* [1]:http://docs.python.org/dev/library/argparse.html#sub-commands</span>
 <span class="s0">**/</span>
<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">addSubparsers </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">options</span><span class="s3">) {</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_subparsers</span><span class="s3">) {</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s2">'Cannot have multiple subparser arguments.'</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s1">options </span><span class="s3">= </span><span class="s1">options </span><span class="s3">|| {};</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">debug </span><span class="s3">= (</span><span class="s4">this</span><span class="s3">.</span><span class="s1">debug </span><span class="s3">=== </span><span class="s4">true</span><span class="s3">);</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">optionStrings </span><span class="s3">= [];</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">parserClass </span><span class="s3">= (</span><span class="s1">options</span><span class="s3">.</span><span class="s1">parserClass </span><span class="s3">|| </span><span class="s1">ArgumentParser</span><span class="s3">);</span>


  <span class="s4">if </span><span class="s3">(!!</span><span class="s1">options</span><span class="s3">.</span><span class="s1">title </span><span class="s3">|| !!</span><span class="s1">options</span><span class="s3">.</span><span class="s1">description</span><span class="s3">) {</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_subparsers </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">addArgumentGroup</span><span class="s3">({</span>
      <span class="s1">title</span><span class="s3">: (</span><span class="s1">options</span><span class="s3">.</span><span class="s1">title </span><span class="s3">|| </span><span class="s2">'subcommands'</span><span class="s3">),</span>
      <span class="s1">description</span><span class="s3">: </span><span class="s1">options</span><span class="s3">.</span><span class="s1">description</span>
    <span class="s3">});</span>
    <span class="s4">delete </span><span class="s1">options</span><span class="s3">.</span><span class="s1">title</span><span class="s3">;</span>
    <span class="s4">delete </span><span class="s1">options</span><span class="s3">.</span><span class="s1">description</span><span class="s3">;</span>

  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_subparsers </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_positionals</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s5">// prog defaults to the usage message of this parser, skipping</span>
  <span class="s5">// optional arguments and with no &quot;usage:&quot; prefix</span>
  <span class="s4">if </span><span class="s3">(!</span><span class="s1">options</span><span class="s3">.</span><span class="s1">prog</span><span class="s3">) {</span>
    <span class="s4">var </span><span class="s1">formatter </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_getFormatter</span><span class="s3">();</span>
    <span class="s4">var </span><span class="s1">positionals </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_getPositionalActions</span><span class="s3">();</span>
    <span class="s4">var </span><span class="s1">groups </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_mutuallyExclusiveGroups</span><span class="s3">;</span>
    <span class="s1">formatter</span><span class="s3">.</span><span class="s1">addUsage</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">usage</span><span class="s3">, </span><span class="s1">positionals</span><span class="s3">, </span><span class="s1">groups</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
    <span class="s1">options</span><span class="s3">.</span><span class="s1">prog </span><span class="s3">= </span><span class="s1">formatter</span><span class="s3">.</span><span class="s1">formatHelp</span><span class="s3">().</span><span class="s1">trim</span><span class="s3">();</span>
  <span class="s3">}</span>

  <span class="s5">// create the parsers action and add it to the positionals list</span>
  <span class="s4">var </span><span class="s1">ParsersClass </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_popActionClass</span><span class="s3">(</span><span class="s1">options</span><span class="s3">, </span><span class="s2">'parsers'</span><span class="s3">);</span>
  <span class="s4">var </span><span class="s1">action </span><span class="s3">= </span><span class="s4">new </span><span class="s1">ParsersClass</span><span class="s3">(</span><span class="s1">options</span><span class="s3">);</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">_subparsers</span><span class="s3">.</span><span class="s1">_addAction</span><span class="s3">(</span><span class="s1">action</span><span class="s3">);</span>

  <span class="s5">// return the created parsers action</span>
  <span class="s4">return </span><span class="s1">action</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_addAction </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">) {</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">isOptional</span><span class="s3">()) {</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_optionals</span><span class="s3">.</span><span class="s1">_addAction</span><span class="s3">(</span><span class="s1">action</span><span class="s3">);</span>
  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_positionals</span><span class="s3">.</span><span class="s1">_addAction</span><span class="s3">(</span><span class="s1">action</span><span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s4">return </span><span class="s1">action</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_getOptionalActions </span><span class="s3">= </span><span class="s4">function </span><span class="s3">() {</span>
  <span class="s4">return this</span><span class="s3">.</span><span class="s1">_actions</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">) {</span>
    <span class="s4">return </span><span class="s1">action</span><span class="s3">.</span><span class="s1">isOptional</span><span class="s3">();</span>
  <span class="s3">});</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_getPositionalActions </span><span class="s3">= </span><span class="s4">function </span><span class="s3">() {</span>
  <span class="s4">return this</span><span class="s3">.</span><span class="s1">_actions</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">) {</span>
    <span class="s4">return </span><span class="s1">action</span><span class="s3">.</span><span class="s1">isPositional</span><span class="s3">();</span>
  <span class="s3">});</span>
<span class="s3">};</span>


<span class="s0">/**</span>
 <span class="s0">* ArgumentParser#parseArgs(args, namespace) -&gt; Namespace|Object</span>
 <span class="s0">* - args (array): input elements</span>
 <span class="s0">* - namespace (Namespace|Object): result object</span>
 <span class="s0">*</span>
 <span class="s0">* Parsed args and throws error if some arguments are not recognized</span>
 <span class="s0">*</span>
 <span class="s0">* See also [original guide][1]</span>
 <span class="s0">*</span>
 <span class="s0">* [1]:http://docs.python.org/dev/library/argparse.html#the-parse-args-method</span>
 <span class="s0">**/</span>
<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">parseArgs </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">) {</span>
  <span class="s4">var </span><span class="s1">argv</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">result </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">parseKnownArgs</span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">);</span>

  <span class="s1">args </span><span class="s3">= </span><span class="s1">result</span><span class="s3">[</span><span class="s6">0</span><span class="s3">];</span>
  <span class="s1">argv </span><span class="s3">= </span><span class="s1">result</span><span class="s3">[</span><span class="s6">1</span><span class="s3">];</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">argv </span><span class="s3">&amp;&amp; </span><span class="s1">argv</span><span class="s3">.</span><span class="s1">length </span><span class="s3">&gt; </span><span class="s6">0</span><span class="s3">) {</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
      <span class="s1">format</span><span class="s3">(</span><span class="s2">'Unrecognized arguments: %s.'</span><span class="s3">, </span><span class="s1">argv</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s2">' '</span><span class="s3">))</span>
    <span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s4">return </span><span class="s1">args</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s0">/**</span>
 <span class="s0">* ArgumentParser#parseKnownArgs(args, namespace) -&gt; array</span>
 <span class="s0">* - args (array): input options</span>
 <span class="s0">* - namespace (Namespace|Object): result object</span>
 <span class="s0">*</span>
 <span class="s0">* Parse known arguments and return tuple of result object</span>
 <span class="s0">* and unknown args</span>
 <span class="s0">*</span>
 <span class="s0">* See also [original guide][1]</span>
 <span class="s0">*</span>
 <span class="s0">* [1]:http://docs.python.org/dev/library/argparse.html#partial-parsing</span>
 <span class="s0">**/</span>
<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">parseKnownArgs </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">) {</span>
  <span class="s4">var </span><span class="s1">self </span><span class="s3">= </span><span class="s4">this</span><span class="s3">;</span>

  <span class="s5">// args default to the system args</span>
  <span class="s1">args </span><span class="s3">= </span><span class="s1">args </span><span class="s3">|| </span><span class="s1">process</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">2</span><span class="s3">);</span>

  <span class="s5">// default Namespace built from parser defaults</span>
  <span class="s1">namespace </span><span class="s3">= </span><span class="s1">namespace </span><span class="s3">|| </span><span class="s4">new </span><span class="s1">Namespace</span><span class="s3">();</span>

  <span class="s1">self</span><span class="s3">.</span><span class="s1">_actions</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">dest </span><span class="s3">!== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">SUPPRESS</span><span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(!</span><span class="s1">$$</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">namespace</span><span class="s3">, </span><span class="s1">action</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">)) {</span>
        <span class="s4">if </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">defaultValue </span><span class="s3">!== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">SUPPRESS</span><span class="s3">) {</span>
          <span class="s4">var </span><span class="s1">defaultValue </span><span class="s3">= </span><span class="s1">action</span><span class="s3">.</span><span class="s1">defaultValue</span><span class="s3">;</span>
          <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">action</span><span class="s3">.</span><span class="s1">defaultValue </span><span class="s3">=== </span><span class="s2">'string'</span><span class="s3">) {</span>
            <span class="s1">defaultValue </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">defaultValue</span><span class="s3">);</span>
          <span class="s3">}</span>
          <span class="s1">namespace</span><span class="s3">[</span><span class="s1">action</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">] = </span><span class="s1">defaultValue</span><span class="s3">;</span>
        <span class="s3">}</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
  <span class="s3">});</span>

  <span class="s1">Object</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_defaults</span><span class="s3">).</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">dest</span><span class="s3">) {</span>
    <span class="s1">namespace</span><span class="s3">[</span><span class="s1">dest</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_defaults</span><span class="s3">[</span><span class="s1">dest</span><span class="s3">];</span>
  <span class="s3">});</span>

  <span class="s5">// parse the arguments and exit if there are any errors</span>
  <span class="s4">try </span><span class="s3">{</span>
    <span class="s4">var </span><span class="s1">res </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_parseKnownArgs</span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">);</span>

    <span class="s1">namespace </span><span class="s3">= </span><span class="s1">res</span><span class="s3">[</span><span class="s6">0</span><span class="s3">];</span>
    <span class="s1">args </span><span class="s3">= </span><span class="s1">res</span><span class="s3">[</span><span class="s6">1</span><span class="s3">];</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">$$</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">namespace</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">_UNRECOGNIZED_ARGS_ATTR</span><span class="s3">)) {</span>
      <span class="s1">args </span><span class="s3">= </span><span class="s1">$$</span><span class="s3">.</span><span class="s1">arrayUnion</span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">[</span><span class="s1">c</span><span class="s3">.</span><span class="s1">_UNRECOGNIZED_ARGS_ATTR</span><span class="s3">]);</span>
      <span class="s4">delete </span><span class="s1">namespace</span><span class="s3">[</span><span class="s1">c</span><span class="s3">.</span><span class="s1">_UNRECOGNIZED_ARGS_ATTR</span><span class="s3">];</span>
    <span class="s3">}</span>
    <span class="s4">return </span><span class="s3">[ </span><span class="s1">namespace</span><span class="s3">, </span><span class="s1">args </span><span class="s3">];</span>
  <span class="s3">} </span><span class="s4">catch </span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">e</span><span class="s3">);</span>
  <span class="s3">}</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_parseKnownArgs </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">argStrings</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">) {</span>
  <span class="s4">var </span><span class="s1">self </span><span class="s3">= </span><span class="s4">this</span><span class="s3">;</span>

  <span class="s4">var </span><span class="s1">extras </span><span class="s3">= [];</span>

  <span class="s5">// replace arg strings that are file references</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">fromfilePrefixChars </span><span class="s3">!== </span><span class="s4">null</span><span class="s3">) {</span>
    <span class="s1">argStrings </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_readArgsFromFiles</span><span class="s3">(</span><span class="s1">argStrings</span><span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s5">// map all mutually exclusive arguments to the other arguments</span>
  <span class="s5">// they can't occur with</span>
  <span class="s5">// Python has 'conflicts = action_conflicts.setdefault(mutex_action, [])'</span>
  <span class="s5">// though I can't conceive of a way in which an action could be a member</span>
  <span class="s5">// of two different mutually exclusive groups.</span>

  <span class="s4">function </span><span class="s1">actionHash</span><span class="s3">(</span><span class="s1">action</span><span class="s3">) {</span>
    <span class="s5">// some sort of hashable key for this action</span>
    <span class="s5">// action itself cannot be a key in actionConflicts</span>
    <span class="s5">// I think getName() (join of optionStrings) is unique enough</span>
    <span class="s4">return </span><span class="s1">action</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">();</span>
  <span class="s3">}</span>

  <span class="s4">var </span><span class="s1">conflicts</span><span class="s3">, </span><span class="s1">key</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">actionConflicts </span><span class="s3">= {};</span>

  <span class="s4">this</span><span class="s3">.</span><span class="s1">_mutuallyExclusiveGroups</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">mutexGroup</span><span class="s3">) {</span>
    <span class="s1">mutexGroup</span><span class="s3">.</span><span class="s1">_groupActions</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">mutexAction</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">groupActions</span><span class="s3">) {</span>
      <span class="s1">key </span><span class="s3">= </span><span class="s1">actionHash</span><span class="s3">(</span><span class="s1">mutexAction</span><span class="s3">);</span>
      <span class="s4">if </span><span class="s3">(!</span><span class="s1">$$</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">actionConflicts</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)) {</span>
        <span class="s1">actionConflicts</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] = [];</span>
      <span class="s3">}</span>
      <span class="s1">conflicts </span><span class="s3">= </span><span class="s1">actionConflicts</span><span class="s3">[</span><span class="s1">key</span><span class="s3">];</span>
      <span class="s1">conflicts</span><span class="s3">.</span><span class="s1">push</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">conflicts</span><span class="s3">, </span><span class="s1">groupActions</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">i</span><span class="s3">));</span>
      <span class="s1">conflicts</span><span class="s3">.</span><span class="s1">push</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">conflicts</span><span class="s3">, </span><span class="s1">groupActions</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">i </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">));</span>
    <span class="s3">});</span>
  <span class="s3">});</span>

  <span class="s5">// find all option indices, and determine the arg_string_pattern</span>
  <span class="s5">// which has an 'O' if there is an option at an index,</span>
  <span class="s5">// an 'A' if there is an argument, or a '-' if there is a '--'</span>
  <span class="s4">var </span><span class="s1">optionStringIndices </span><span class="s3">= {};</span>

  <span class="s4">var </span><span class="s1">argStringPatternParts </span><span class="s3">= [];</span>

  <span class="s1">argStrings</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">argString</span><span class="s3">, </span><span class="s1">argStringIndex</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">argString </span><span class="s3">=== </span><span class="s2">'--'</span><span class="s3">) {</span>
      <span class="s1">argStringPatternParts</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s2">'-'</span><span class="s3">);</span>
      <span class="s4">while </span><span class="s3">(</span><span class="s1">argStringIndex </span><span class="s3">&lt; </span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) {</span>
        <span class="s1">argStringPatternParts</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s2">'A'</span><span class="s3">);</span>
        <span class="s1">argStringIndex</span><span class="s3">++;</span>
      <span class="s3">}</span>
    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
      <span class="s5">// otherwise, add the arg to the arg strings</span>
      <span class="s5">// and note the index if it was an option</span>
      <span class="s4">var </span><span class="s1">pattern</span><span class="s3">;</span>
      <span class="s4">var </span><span class="s1">optionTuple </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parseOptional</span><span class="s3">(</span><span class="s1">argString</span><span class="s3">);</span>
      <span class="s4">if </span><span class="s3">(!</span><span class="s1">optionTuple</span><span class="s3">) {</span>
        <span class="s1">pattern </span><span class="s3">= </span><span class="s2">'A'</span><span class="s3">;</span>
      <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
        <span class="s1">optionStringIndices</span><span class="s3">[</span><span class="s1">argStringIndex</span><span class="s3">] = </span><span class="s1">optionTuple</span><span class="s3">;</span>
        <span class="s1">pattern </span><span class="s3">= </span><span class="s2">'O'</span><span class="s3">;</span>
      <span class="s3">}</span>
      <span class="s1">argStringPatternParts</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">pattern</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">});</span>
  <span class="s4">var </span><span class="s1">argStringsPattern </span><span class="s3">= </span><span class="s1">argStringPatternParts</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s2">''</span><span class="s3">);</span>

  <span class="s4">var </span><span class="s1">seenActions </span><span class="s3">= [];</span>
  <span class="s4">var </span><span class="s1">seenNonDefaultActions </span><span class="s3">= [];</span>


  <span class="s4">function </span><span class="s1">takeAction</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">argumentStrings</span><span class="s3">, </span><span class="s1">optionString</span><span class="s3">) {</span>
    <span class="s1">seenActions</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">action</span><span class="s3">);</span>
    <span class="s4">var </span><span class="s1">argumentValues </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getValues</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">argumentStrings</span><span class="s3">);</span>

    <span class="s5">// error if this argument is not allowed with other previously</span>
    <span class="s5">// seen arguments, assuming that actions that use the default</span>
    <span class="s5">// value don't really count as &quot;present&quot;</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">argumentValues </span><span class="s3">!== </span><span class="s1">action</span><span class="s3">.</span><span class="s1">defaultValue</span><span class="s3">) {</span>
      <span class="s1">seenNonDefaultActions</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">action</span><span class="s3">);</span>
      <span class="s4">if </span><span class="s3">(</span><span class="s1">actionConflicts</span><span class="s3">[</span><span class="s1">actionHash</span><span class="s3">(</span><span class="s1">action</span><span class="s3">)]) {</span>
        <span class="s1">actionConflicts</span><span class="s3">[</span><span class="s1">actionHash</span><span class="s3">(</span><span class="s1">action</span><span class="s3">)].</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">actionConflict</span><span class="s3">) {</span>
          <span class="s4">if </span><span class="s3">(</span><span class="s1">seenNonDefaultActions</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">actionConflict</span><span class="s3">) &gt;= </span><span class="s6">0</span><span class="s3">) {</span>
            <span class="s4">throw </span><span class="s1">argumentErrorHelper</span><span class="s3">(</span>
              <span class="s1">action</span><span class="s3">,</span>
              <span class="s1">format</span><span class="s3">(</span><span class="s2">'Not allowed with argument &quot;%s&quot;.'</span><span class="s3">, </span><span class="s1">actionConflict</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">())</span>
            <span class="s3">);</span>
          <span class="s3">}</span>
        <span class="s3">});</span>
      <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">argumentValues </span><span class="s3">!== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">SUPPRESS</span><span class="s3">) {</span>
      <span class="s1">action</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">, </span><span class="s1">argumentValues</span><span class="s3">, </span><span class="s1">optionString</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">}</span>

  <span class="s4">function </span><span class="s1">consumeOptional</span><span class="s3">(</span><span class="s1">startIndex</span><span class="s3">) {</span>
    <span class="s5">// get the optional identified at this index</span>
    <span class="s4">var </span><span class="s1">optionTuple </span><span class="s3">= </span><span class="s1">optionStringIndices</span><span class="s3">[</span><span class="s1">startIndex</span><span class="s3">];</span>
    <span class="s4">var </span><span class="s1">action </span><span class="s3">= </span><span class="s1">optionTuple</span><span class="s3">[</span><span class="s6">0</span><span class="s3">];</span>
    <span class="s4">var </span><span class="s1">optionString </span><span class="s3">= </span><span class="s1">optionTuple</span><span class="s3">[</span><span class="s6">1</span><span class="s3">];</span>
    <span class="s4">var </span><span class="s1">explicitArg </span><span class="s3">= </span><span class="s1">optionTuple</span><span class="s3">[</span><span class="s6">2</span><span class="s3">];</span>

    <span class="s5">// identify additional optionals in the same arg string</span>
    <span class="s5">// (e.g. -xyz is the same as -x -y -z if no args are required)</span>
    <span class="s4">var </span><span class="s1">actionTuples </span><span class="s3">= [];</span>

    <span class="s4">var </span><span class="s1">args</span><span class="s3">, </span><span class="s1">argCount</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">;</span>

    <span class="s4">for </span><span class="s3">(;;) {</span>
      <span class="s4">if </span><span class="s3">(!</span><span class="s1">action</span><span class="s3">) {</span>
        <span class="s1">extras</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">argStrings</span><span class="s3">[</span><span class="s1">startIndex</span><span class="s3">]);</span>
        <span class="s4">return </span><span class="s1">startIndex </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">;</span>
      <span class="s3">}</span>
      <span class="s4">if </span><span class="s3">(</span><span class="s1">explicitArg</span><span class="s3">) {</span>
        <span class="s1">argCount </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_matchArgument</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s2">'A'</span><span class="s3">);</span>

        <span class="s5">// if the action is a single-dash option and takes no</span>
        <span class="s5">// arguments, try to parse more single-dash options out</span>
        <span class="s5">// of the tail of the option string</span>
        <span class="s4">var </span><span class="s1">chars </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">prefixChars</span><span class="s3">;</span>
        <span class="s4">if </span><span class="s3">(</span><span class="s1">argCount </span><span class="s3">=== </span><span class="s6">0 </span><span class="s3">&amp;&amp; </span><span class="s1">chars</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">optionString</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]) &lt; </span><span class="s6">0</span><span class="s3">) {</span>
          <span class="s1">actionTuples</span><span class="s3">.</span><span class="s1">push</span><span class="s3">([ </span><span class="s1">action</span><span class="s3">, [], </span><span class="s1">optionString </span><span class="s3">]);</span>
          <span class="s1">optionString </span><span class="s3">= </span><span class="s1">optionString</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s1">explicitArg</span><span class="s3">[</span><span class="s6">0</span><span class="s3">];</span>
          <span class="s4">var </span><span class="s1">newExplicitArg </span><span class="s3">= </span><span class="s1">explicitArg</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">) || </span><span class="s4">null</span><span class="s3">;</span>
          <span class="s4">var </span><span class="s1">optionalsMap </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">;</span>

          <span class="s4">if </span><span class="s3">(</span><span class="s1">Object</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(</span><span class="s1">optionalsMap</span><span class="s3">).</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">optionString</span><span class="s3">) &gt;= </span><span class="s6">0</span><span class="s3">) {</span>
            <span class="s1">action </span><span class="s3">= </span><span class="s1">optionalsMap</span><span class="s3">[</span><span class="s1">optionString</span><span class="s3">];</span>
            <span class="s1">explicitArg </span><span class="s3">= </span><span class="s1">newExplicitArg</span><span class="s3">;</span>
          <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
            <span class="s4">throw </span><span class="s1">argumentErrorHelper</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">sprintf</span><span class="s3">(</span><span class="s2">'ignored explicit argument %r'</span><span class="s3">, </span><span class="s1">explicitArg</span><span class="s3">));</span>
          <span class="s3">}</span>
        <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">argCount </span><span class="s3">=== </span><span class="s6">1</span><span class="s3">) {</span>
          <span class="s5">// if the action expect exactly one argument, we've</span>
          <span class="s5">// successfully matched the option; exit the loop</span>
          <span class="s1">stop </span><span class="s3">= </span><span class="s1">startIndex </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">;</span>
          <span class="s1">args </span><span class="s3">= [ </span><span class="s1">explicitArg </span><span class="s3">];</span>
          <span class="s1">actionTuples</span><span class="s3">.</span><span class="s1">push</span><span class="s3">([ </span><span class="s1">action</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">optionString </span><span class="s3">]);</span>
          <span class="s4">break</span><span class="s3">;</span>
        <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
          <span class="s5">// error if a double-dash option did not use the</span>
          <span class="s5">// explicit argument</span>
          <span class="s4">throw </span><span class="s1">argumentErrorHelper</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">sprintf</span><span class="s3">(</span><span class="s2">'ignored explicit argument %r'</span><span class="s3">, </span><span class="s1">explicitArg</span><span class="s3">));</span>
        <span class="s3">}</span>
      <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
        <span class="s5">// if there is no explicit argument, try to match the</span>
        <span class="s5">// optional's string arguments with the following strings</span>
        <span class="s5">// if successful, exit the loop</span>

        <span class="s1">start </span><span class="s3">= </span><span class="s1">startIndex </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">;</span>
        <span class="s4">var </span><span class="s1">selectedPatterns </span><span class="s3">= </span><span class="s1">argStringsPattern</span><span class="s3">.</span><span class="s1">substr</span><span class="s3">(</span><span class="s1">start</span><span class="s3">);</span>

        <span class="s1">argCount </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_matchArgument</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">selectedPatterns</span><span class="s3">);</span>
        <span class="s1">stop </span><span class="s3">= </span><span class="s1">start </span><span class="s3">+ </span><span class="s1">argCount</span><span class="s3">;</span>


        <span class="s1">args </span><span class="s3">= </span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">);</span>

        <span class="s1">actionTuples</span><span class="s3">.</span><span class="s1">push</span><span class="s3">([ </span><span class="s1">action</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">optionString </span><span class="s3">]);</span>
        <span class="s4">break</span><span class="s3">;</span>
      <span class="s3">}</span>

    <span class="s3">}</span>

    <span class="s5">// add the Optional to the list and return the index at which</span>
    <span class="s5">// the Optional's string args stopped</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">actionTuples</span><span class="s3">.</span><span class="s1">length </span><span class="s3">&lt; </span><span class="s6">1</span><span class="s3">) {</span>
      <span class="s4">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'length should be &gt; 0'</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s4">for </span><span class="s3">(</span><span class="s4">var </span><span class="s1">i </span><span class="s3">= </span><span class="s6">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">actionTuples</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++) {</span>
      <span class="s1">takeAction</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">actionTuples</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]);</span>
    <span class="s3">}</span>
    <span class="s4">return </span><span class="s1">stop</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s5">// the list of Positionals left to be parsed; this is modified</span>
  <span class="s5">// by consume_positionals()</span>
  <span class="s4">var </span><span class="s1">positionals </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getPositionalActions</span><span class="s3">();</span>

  <span class="s4">function </span><span class="s1">consumePositionals</span><span class="s3">(</span><span class="s1">startIndex</span><span class="s3">) {</span>
    <span class="s5">// match as many Positionals as possible</span>
    <span class="s4">var </span><span class="s1">selectedPattern </span><span class="s3">= </span><span class="s1">argStringsPattern</span><span class="s3">.</span><span class="s1">substr</span><span class="s3">(</span><span class="s1">startIndex</span><span class="s3">);</span>
    <span class="s4">var </span><span class="s1">argCounts </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_matchArgumentsPartial</span><span class="s3">(</span><span class="s1">positionals</span><span class="s3">, </span><span class="s1">selectedPattern</span><span class="s3">);</span>

    <span class="s5">// slice off the appropriate arg strings for each Positional</span>
    <span class="s5">// and add the Positional and its args to the list</span>
    <span class="s4">for </span><span class="s3">(</span><span class="s4">var </span><span class="s1">i </span><span class="s3">= </span><span class="s6">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">positionals</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++) {</span>
      <span class="s4">var </span><span class="s1">action </span><span class="s3">= </span><span class="s1">positionals</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
      <span class="s4">var </span><span class="s1">argCount </span><span class="s3">= </span><span class="s1">argCounts</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
      <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">argCount </span><span class="s3">=== </span><span class="s2">'undefined'</span><span class="s3">) {</span>
        <span class="s4">continue</span><span class="s3">;</span>
      <span class="s3">}</span>
      <span class="s4">var </span><span class="s1">args </span><span class="s3">= </span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">startIndex</span><span class="s3">, </span><span class="s1">startIndex </span><span class="s3">+ </span><span class="s1">argCount</span><span class="s3">);</span>

      <span class="s1">startIndex </span><span class="s3">+= </span><span class="s1">argCount</span><span class="s3">;</span>
      <span class="s1">takeAction</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">args</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s5">// slice off the Positionals that we just parsed and return the</span>
    <span class="s5">// index at which the Positionals' string args stopped</span>
    <span class="s1">positionals </span><span class="s3">= </span><span class="s1">positionals</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">argCounts</span><span class="s3">.</span><span class="s1">length</span><span class="s3">);</span>
    <span class="s4">return </span><span class="s1">startIndex</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s5">// consume Positionals and Optionals alternately, until we have</span>
  <span class="s5">// passed the last option string</span>
  <span class="s4">var </span><span class="s1">startIndex </span><span class="s3">= </span><span class="s6">0</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">position</span><span class="s3">;</span>

  <span class="s4">var </span><span class="s1">maxOptionStringIndex </span><span class="s3">= -</span><span class="s6">1</span><span class="s3">;</span>

  <span class="s1">Object</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(</span><span class="s1">optionStringIndices</span><span class="s3">).</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">position</span><span class="s3">) {</span>
    <span class="s1">maxOptionStringIndex </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">maxOptionStringIndex</span><span class="s3">, </span><span class="s1">parseInt</span><span class="s3">(</span><span class="s1">position</span><span class="s3">, </span><span class="s6">10</span><span class="s3">));</span>
  <span class="s3">});</span>

  <span class="s4">var </span><span class="s1">positionalsEndIndex</span><span class="s3">, </span><span class="s1">nextOptionStringIndex</span><span class="s3">;</span>

  <span class="s4">while </span><span class="s3">(</span><span class="s1">startIndex </span><span class="s3">&lt;= </span><span class="s1">maxOptionStringIndex</span><span class="s3">) {</span>
    <span class="s5">// consume any Positionals preceding the next option</span>
    <span class="s1">nextOptionStringIndex </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
    <span class="s4">for </span><span class="s3">(</span><span class="s1">position </span><span class="s4">in </span><span class="s1">optionStringIndices</span><span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(!</span><span class="s1">optionStringIndices</span><span class="s3">.</span><span class="s1">hasOwnProperty</span><span class="s3">(</span><span class="s1">position</span><span class="s3">)) { </span><span class="s4">continue</span><span class="s3">; }</span>

      <span class="s1">position </span><span class="s3">= </span><span class="s1">parseInt</span><span class="s3">(</span><span class="s1">position</span><span class="s3">, </span><span class="s6">10</span><span class="s3">);</span>
      <span class="s4">if </span><span class="s3">(</span><span class="s1">position </span><span class="s3">&gt;= </span><span class="s1">startIndex</span><span class="s3">) {</span>
        <span class="s4">if </span><span class="s3">(</span><span class="s1">nextOptionStringIndex </span><span class="s3">!== </span><span class="s4">null</span><span class="s3">) {</span>
          <span class="s1">nextOptionStringIndex </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">nextOptionStringIndex</span><span class="s3">, </span><span class="s1">position</span><span class="s3">);</span>
        <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
          <span class="s1">nextOptionStringIndex </span><span class="s3">= </span><span class="s1">position</span><span class="s3">;</span>
        <span class="s3">}</span>
      <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">startIndex </span><span class="s3">!== </span><span class="s1">nextOptionStringIndex</span><span class="s3">) {</span>
      <span class="s1">positionalsEndIndex </span><span class="s3">= </span><span class="s1">consumePositionals</span><span class="s3">(</span><span class="s1">startIndex</span><span class="s3">);</span>
      <span class="s5">// only try to parse the next optional if we didn't consume</span>
      <span class="s5">// the option string during the positionals parsing</span>
      <span class="s4">if </span><span class="s3">(</span><span class="s1">positionalsEndIndex </span><span class="s3">&gt; </span><span class="s1">startIndex</span><span class="s3">) {</span>
        <span class="s1">startIndex </span><span class="s3">= </span><span class="s1">positionalsEndIndex</span><span class="s3">;</span>
        <span class="s4">continue</span><span class="s3">;</span>
      <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
        <span class="s1">startIndex </span><span class="s3">= </span><span class="s1">positionalsEndIndex</span><span class="s3">;</span>
      <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s5">// if we consumed all the positionals we could and we're not</span>
    <span class="s5">// at the index of an option string, there were extra arguments</span>
    <span class="s4">if </span><span class="s3">(!</span><span class="s1">optionStringIndices</span><span class="s3">[</span><span class="s1">startIndex</span><span class="s3">]) {</span>
      <span class="s4">var </span><span class="s1">strings </span><span class="s3">= </span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">startIndex</span><span class="s3">, </span><span class="s1">nextOptionStringIndex</span><span class="s3">);</span>
      <span class="s1">extras </span><span class="s3">= </span><span class="s1">extras</span><span class="s3">.</span><span class="s1">concat</span><span class="s3">(</span><span class="s1">strings</span><span class="s3">);</span>
      <span class="s1">startIndex </span><span class="s3">= </span><span class="s1">nextOptionStringIndex</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s5">// consume the next optional and any arguments for it</span>
    <span class="s1">startIndex </span><span class="s3">= </span><span class="s1">consumeOptional</span><span class="s3">(</span><span class="s1">startIndex</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s5">// consume any positionals following the last Optional</span>
  <span class="s4">var </span><span class="s1">stopIndex </span><span class="s3">= </span><span class="s1">consumePositionals</span><span class="s3">(</span><span class="s1">startIndex</span><span class="s3">);</span>

  <span class="s5">// if we didn't consume all the argument strings, there were extras</span>
  <span class="s1">extras </span><span class="s3">= </span><span class="s1">extras</span><span class="s3">.</span><span class="s1">concat</span><span class="s3">(</span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">stopIndex</span><span class="s3">));</span>

  <span class="s5">// if we didn't use all the Positional objects, there were too few</span>
  <span class="s5">// arg strings supplied.</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">positionals</span><span class="s3">.</span><span class="s1">length </span><span class="s3">&gt; </span><span class="s6">0</span><span class="s3">) {</span>
    <span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s2">'too few arguments'</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s5">// make sure all required actions were present</span>
  <span class="s1">self</span><span class="s3">.</span><span class="s1">_actions</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">required</span><span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(</span><span class="s1">seenActions</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">action</span><span class="s3">) &lt; </span><span class="s6">0</span><span class="s3">) {</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">format</span><span class="s3">(</span><span class="s2">'Argument &quot;%s&quot; is required'</span><span class="s3">, </span><span class="s1">action</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">()));</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
  <span class="s3">});</span>

  <span class="s5">// make sure all required groups have one option present</span>
  <span class="s4">var </span><span class="s1">actionUsed </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
  <span class="s1">self</span><span class="s3">.</span><span class="s1">_mutuallyExclusiveGroups</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">group</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">group</span><span class="s3">.</span><span class="s1">required</span><span class="s3">) {</span>
      <span class="s1">actionUsed </span><span class="s3">= </span><span class="s1">group</span><span class="s3">.</span><span class="s1">_groupActions</span><span class="s3">.</span><span class="s1">some</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">) {</span>
        <span class="s4">return </span><span class="s1">seenNonDefaultActions</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">action</span><span class="s3">) !== -</span><span class="s6">1</span><span class="s3">;</span>
      <span class="s3">});</span>

      <span class="s5">// if no actions were used, report the error</span>
      <span class="s4">if </span><span class="s3">(!</span><span class="s1">actionUsed</span><span class="s3">) {</span>
        <span class="s4">var </span><span class="s1">names </span><span class="s3">= [];</span>
        <span class="s1">group</span><span class="s3">.</span><span class="s1">_groupActions</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">) {</span>
          <span class="s4">if </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">help </span><span class="s3">!== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">SUPPRESS</span><span class="s3">) {</span>
            <span class="s1">names</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">());</span>
          <span class="s3">}</span>
        <span class="s3">});</span>
        <span class="s1">names </span><span class="s3">= </span><span class="s1">names</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s2">' '</span><span class="s3">);</span>
        <span class="s4">var </span><span class="s1">msg </span><span class="s3">= </span><span class="s2">'one of the arguments ' </span><span class="s3">+ </span><span class="s1">names </span><span class="s3">+ </span><span class="s2">' is required'</span><span class="s3">;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">);</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
  <span class="s3">});</span>

  <span class="s5">// return the updated namespace and the extra arguments</span>
  <span class="s4">return </span><span class="s3">[ </span><span class="s1">namespace</span><span class="s3">, </span><span class="s1">extras </span><span class="s3">];</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_readArgsFromFiles </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">argStrings</span><span class="s3">) {</span>
  <span class="s5">// expand arguments referencing files</span>
  <span class="s4">var </span><span class="s1">self </span><span class="s3">= </span><span class="s4">this</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">fs </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'fs'</span><span class="s3">);</span>
  <span class="s4">var </span><span class="s1">newArgStrings </span><span class="s3">= [];</span>
  <span class="s1">argStrings</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">argString</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fromfilePrefixChars</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">argString</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]) &lt; </span><span class="s6">0</span><span class="s3">) {</span>
      <span class="s5">// for regular arguments, just add them back into the list</span>
      <span class="s1">newArgStrings</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">argString</span><span class="s3">);</span>
    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
      <span class="s5">// replace arguments referencing files with the file content</span>
      <span class="s4">try </span><span class="s3">{</span>
        <span class="s4">var </span><span class="s1">argstrs </span><span class="s3">= [];</span>
        <span class="s4">var </span><span class="s1">filename </span><span class="s3">= </span><span class="s1">argString</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">);</span>
        <span class="s4">var </span><span class="s1">content </span><span class="s3">= </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">readFileSync</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s2">'utf8'</span><span class="s3">);</span>
        <span class="s1">content </span><span class="s3">= </span><span class="s1">content</span><span class="s3">.</span><span class="s1">trim</span><span class="s3">().</span><span class="s1">split</span><span class="s3">(</span><span class="s2">'</span><span class="s4">\n</span><span class="s2">'</span><span class="s3">);</span>
        <span class="s1">content</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">argLine</span><span class="s3">) {</span>
          <span class="s1">self</span><span class="s3">.</span><span class="s1">convertArgLineToArgs</span><span class="s3">(</span><span class="s1">argLine</span><span class="s3">).</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">arg</span><span class="s3">) {</span>
            <span class="s1">argstrs</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">);</span>
          <span class="s3">});</span>
          <span class="s1">argstrs </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_readArgsFromFiles</span><span class="s3">(</span><span class="s1">argstrs</span><span class="s3">);</span>
        <span class="s3">});</span>
        <span class="s1">newArgStrings</span><span class="s3">.</span><span class="s1">push</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">newArgStrings</span><span class="s3">, </span><span class="s1">argstrs</span><span class="s3">);</span>
      <span class="s3">} </span><span class="s4">catch </span><span class="s3">(</span><span class="s1">error</span><span class="s3">) {</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">error</span><span class="s3">.</span><span class="s1">message</span><span class="s3">);</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
  <span class="s3">});</span>
  <span class="s4">return </span><span class="s1">newArgStrings</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">convertArgLineToArgs </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">argLine</span><span class="s3">) {</span>
  <span class="s4">return </span><span class="s3">[ </span><span class="s1">argLine </span><span class="s3">];</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_matchArgument </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">regexpArgStrings</span><span class="s3">) {</span>

  <span class="s5">// match the pattern for this action to the arg strings</span>
  <span class="s4">var </span><span class="s1">regexpNargs </span><span class="s3">= </span><span class="s4">new </span><span class="s1">RegExp</span><span class="s3">(</span><span class="s2">'^' </span><span class="s3">+ </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_getNargsPattern</span><span class="s3">(</span><span class="s1">action</span><span class="s3">));</span>
  <span class="s4">var </span><span class="s1">matches </span><span class="s3">= </span><span class="s1">regexpArgStrings</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">regexpNargs</span><span class="s3">);</span>
  <span class="s4">var </span><span class="s1">message</span><span class="s3">;</span>

  <span class="s5">// throw an exception if we weren't able to find a match</span>
  <span class="s4">if </span><span class="s3">(!</span><span class="s1">matches</span><span class="s3">) {</span>
    <span class="s4">switch </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs</span><span class="s3">) {</span>
      <span class="s5">/*eslint-disable no-undefined*/</span>
      <span class="s4">case </span><span class="s1">undefined</span><span class="s3">:</span>
      <span class="s4">case null</span><span class="s3">:</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s2">'Expected one argument.'</span><span class="s3">;</span>
        <span class="s4">break</span><span class="s3">;</span>
      <span class="s4">case </span><span class="s1">c</span><span class="s3">.</span><span class="s1">OPTIONAL</span><span class="s3">:</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s2">'Expected at most one argument.'</span><span class="s3">;</span>
        <span class="s4">break</span><span class="s3">;</span>
      <span class="s4">case </span><span class="s1">c</span><span class="s3">.</span><span class="s1">ONE_OR_MORE</span><span class="s3">:</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s2">'Expected at least one argument.'</span><span class="s3">;</span>
        <span class="s4">break</span><span class="s3">;</span>
      <span class="s4">default</span><span class="s3">:</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s2">'Expected %s argument(s)'</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">throw </span><span class="s1">argumentErrorHelper</span><span class="s3">(</span>
      <span class="s1">action</span><span class="s3">,</span>
      <span class="s1">format</span><span class="s3">(</span><span class="s1">message</span><span class="s3">, </span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs</span><span class="s3">)</span>
    <span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s5">// return the number of arguments matched</span>
  <span class="s4">return </span><span class="s1">matches</span><span class="s3">[</span><span class="s6">1</span><span class="s3">].</span><span class="s1">length</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_matchArgumentsPartial </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">actions</span><span class="s3">, </span><span class="s1">regexpArgStrings</span><span class="s3">) {</span>
  <span class="s5">// progressively shorten the actions list by slicing off the</span>
  <span class="s5">// final actions until we find a match</span>
  <span class="s4">var </span><span class="s1">self </span><span class="s3">= </span><span class="s4">this</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">result </span><span class="s3">= [];</span>
  <span class="s4">var </span><span class="s1">actionSlice</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">, </span><span class="s1">matches</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">;</span>

  <span class="s4">function </span><span class="s1">getLength</span><span class="s3">(</span><span class="s1">string</span><span class="s3">) {</span>
    <span class="s4">return </span><span class="s1">string</span><span class="s3">.</span><span class="s1">length</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s4">for </span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s1">actions</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&gt; </span><span class="s6">0</span><span class="s3">; </span><span class="s1">i</span><span class="s3">--) {</span>
    <span class="s1">pattern </span><span class="s3">= </span><span class="s2">''</span><span class="s3">;</span>
    <span class="s1">actionSlice </span><span class="s3">= </span><span class="s1">actions</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">i</span><span class="s3">);</span>
    <span class="s4">for </span><span class="s3">(</span><span class="s1">j </span><span class="s3">= </span><span class="s6">0</span><span class="s3">; </span><span class="s1">j </span><span class="s3">&lt; </span><span class="s1">actionSlice</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">j</span><span class="s3">++) {</span>
      <span class="s1">pattern </span><span class="s3">+= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getNargsPattern</span><span class="s3">(</span><span class="s1">actionSlice</span><span class="s3">[</span><span class="s1">j</span><span class="s3">]);</span>
    <span class="s3">}</span>

    <span class="s1">pattern </span><span class="s3">= </span><span class="s4">new </span><span class="s1">RegExp</span><span class="s3">(</span><span class="s2">'^' </span><span class="s3">+ </span><span class="s1">pattern</span><span class="s3">);</span>
    <span class="s1">matches </span><span class="s3">= </span><span class="s1">regexpArgStrings</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">pattern</span><span class="s3">);</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">matches </span><span class="s3">&amp;&amp; </span><span class="s1">matches</span><span class="s3">.</span><span class="s1">length </span><span class="s3">&gt; </span><span class="s6">0</span><span class="s3">) {</span>
      <span class="s5">// need only groups</span>
      <span class="s1">matches </span><span class="s3">= </span><span class="s1">matches</span><span class="s3">.</span><span class="s1">splice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">);</span>
      <span class="s1">result </span><span class="s3">= </span><span class="s1">result</span><span class="s3">.</span><span class="s1">concat</span><span class="s3">(</span><span class="s1">matches</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s1">getLength</span><span class="s3">));</span>
      <span class="s4">break</span><span class="s3">;</span>
    <span class="s3">}</span>
  <span class="s3">}</span>

  <span class="s5">// return the list of arg string counts</span>
  <span class="s4">return </span><span class="s1">result</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_parseOptional </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">argString</span><span class="s3">) {</span>
  <span class="s4">var </span><span class="s1">action</span><span class="s3">, </span><span class="s1">optionString</span><span class="s3">, </span><span class="s1">argExplicit</span><span class="s3">, </span><span class="s1">optionTuples</span><span class="s3">;</span>

  <span class="s5">// if it's an empty string, it was meant to be a positional</span>
  <span class="s4">if </span><span class="s3">(!</span><span class="s1">argString</span><span class="s3">) {</span>
    <span class="s4">return null</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s5">// if it doesn't start with a prefix, it was meant to be positional</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">prefixChars</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">argString</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]) &lt; </span><span class="s6">0</span><span class="s3">) {</span>
    <span class="s4">return null</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s5">// if the option string is present in the parser, return the action</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">[</span><span class="s1">argString</span><span class="s3">]) {</span>
    <span class="s4">return </span><span class="s3">[ </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">[</span><span class="s1">argString</span><span class="s3">], </span><span class="s1">argString</span><span class="s3">, </span><span class="s4">null </span><span class="s3">];</span>
  <span class="s3">}</span>

  <span class="s5">// if it's just a single character, it was meant to be positional</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">argString</span><span class="s3">.</span><span class="s1">length </span><span class="s3">=== </span><span class="s6">1</span><span class="s3">) {</span>
    <span class="s4">return null</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s5">// if the option string before the &quot;=&quot; is present, return the action</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">argString</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'='</span><span class="s3">) &gt;= </span><span class="s6">0</span><span class="s3">) {</span>
    <span class="s1">optionString </span><span class="s3">= </span><span class="s1">argString</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s2">'='</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">];</span>
    <span class="s1">argExplicit </span><span class="s3">= </span><span class="s1">argString</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">optionString</span><span class="s3">.</span><span class="s1">length </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">);</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">[</span><span class="s1">optionString</span><span class="s3">]) {</span>
      <span class="s1">action </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">[</span><span class="s1">optionString</span><span class="s3">];</span>
      <span class="s4">return </span><span class="s3">[ </span><span class="s1">action</span><span class="s3">, </span><span class="s1">optionString</span><span class="s3">, </span><span class="s1">argExplicit </span><span class="s3">];</span>
    <span class="s3">}</span>
  <span class="s3">}</span>

  <span class="s5">// search through all possible prefixes of the option string</span>
  <span class="s5">// and all actions in the parser for possible interpretations</span>
  <span class="s1">optionTuples </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_getOptionTuples</span><span class="s3">(</span><span class="s1">argString</span><span class="s3">);</span>

  <span class="s5">// if multiple actions match, the option string was ambiguous</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">optionTuples</span><span class="s3">.</span><span class="s1">length </span><span class="s3">&gt; </span><span class="s6">1</span><span class="s3">) {</span>
    <span class="s4">var </span><span class="s1">optionStrings </span><span class="s3">= </span><span class="s1">optionTuples</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">optionTuple</span><span class="s3">) {</span>
      <span class="s4">return </span><span class="s1">optionTuple</span><span class="s3">[</span><span class="s6">1</span><span class="s3">];</span>
    <span class="s3">});</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">format</span><span class="s3">(</span>
          <span class="s2">'Ambiguous option: &quot;%s&quot; could match %s.'</span><span class="s3">,</span>
          <span class="s1">argString</span><span class="s3">, </span><span class="s1">optionStrings</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s2">', '</span><span class="s3">)</span>
    <span class="s3">));</span>
  <span class="s5">// if exactly one action matched, this segmentation is good,</span>
  <span class="s5">// so return the parsed action</span>
  <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">optionTuples</span><span class="s3">.</span><span class="s1">length </span><span class="s3">=== </span><span class="s6">1</span><span class="s3">) {</span>
    <span class="s4">return </span><span class="s1">optionTuples</span><span class="s3">[</span><span class="s6">0</span><span class="s3">];</span>
  <span class="s3">}</span>

  <span class="s5">// if it was not found as an option, but it looks like a negative</span>
  <span class="s5">// number, it was meant to be positional</span>
  <span class="s5">// unless there are negative-number-like options</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">argString</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_regexpNegativeNumber</span><span class="s3">)) {</span>
    <span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_hasNegativeNumberOptionals</span><span class="s3">.</span><span class="s1">some</span><span class="s3">(</span><span class="s1">Boolean</span><span class="s3">)) {</span>
      <span class="s4">return null</span><span class="s3">;</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s5">// if it contains a space, it was meant to be a positional</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">argString</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s2">' '</span><span class="s3">) &gt;= </span><span class="s6">0</span><span class="s3">) {</span>
    <span class="s4">return null</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s5">// it was meant to be an optional but there is no such option</span>
  <span class="s5">// in this parser (though it might be a valid option in a subparser)</span>
  <span class="s4">return </span><span class="s3">[ </span><span class="s4">null</span><span class="s3">, </span><span class="s1">argString</span><span class="s3">, </span><span class="s4">null </span><span class="s3">];</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_getOptionTuples </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">optionString</span><span class="s3">) {</span>
  <span class="s4">var </span><span class="s1">result </span><span class="s3">= [];</span>
  <span class="s4">var </span><span class="s1">chars </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">prefixChars</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">optionPrefix</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">argExplicit</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">action</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">actionOptionString</span><span class="s3">;</span>

  <span class="s5">// option strings starting with two prefix characters are only split at</span>
  <span class="s5">// the '='</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">chars</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">optionString</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]) &gt;= </span><span class="s6">0 </span><span class="s3">&amp;&amp; </span><span class="s1">chars</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">optionString</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]) &gt;= </span><span class="s6">0</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">optionString</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'='</span><span class="s3">) &gt;= </span><span class="s6">0</span><span class="s3">) {</span>
      <span class="s4">var </span><span class="s1">optionStringSplit </span><span class="s3">= </span><span class="s1">optionString</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s2">'='</span><span class="s3">, </span><span class="s6">1</span><span class="s3">);</span>

      <span class="s1">optionPrefix </span><span class="s3">= </span><span class="s1">optionStringSplit</span><span class="s3">[</span><span class="s6">0</span><span class="s3">];</span>
      <span class="s1">argExplicit </span><span class="s3">= </span><span class="s1">optionStringSplit</span><span class="s3">[</span><span class="s6">1</span><span class="s3">];</span>
    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
      <span class="s1">optionPrefix </span><span class="s3">= </span><span class="s1">optionString</span><span class="s3">;</span>
      <span class="s1">argExplicit </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">for </span><span class="s3">(</span><span class="s1">actionOptionString </span><span class="s4">in this</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(</span><span class="s1">actionOptionString</span><span class="s3">.</span><span class="s1">substr</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">optionPrefix</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) === </span><span class="s1">optionPrefix</span><span class="s3">) {</span>
        <span class="s1">action </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">[</span><span class="s1">actionOptionString</span><span class="s3">];</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">push</span><span class="s3">([ </span><span class="s1">action</span><span class="s3">, </span><span class="s1">actionOptionString</span><span class="s3">, </span><span class="s1">argExplicit </span><span class="s3">]);</span>
      <span class="s3">}</span>
    <span class="s3">}</span>

  <span class="s5">// single character options can be concatenated with their arguments</span>
  <span class="s5">// but multiple character options always have to have their argument</span>
  <span class="s5">// separate</span>
  <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">chars</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">optionString</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]) &gt;= </span><span class="s6">0 </span><span class="s3">&amp;&amp; </span><span class="s1">chars</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">optionString</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]) &lt; </span><span class="s6">0</span><span class="s3">) {</span>
    <span class="s1">optionPrefix </span><span class="s3">= </span><span class="s1">optionString</span><span class="s3">;</span>
    <span class="s1">argExplicit </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
    <span class="s4">var </span><span class="s1">optionPrefixShort </span><span class="s3">= </span><span class="s1">optionString</span><span class="s3">.</span><span class="s1">substr</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">);</span>
    <span class="s4">var </span><span class="s1">argExplicitShort </span><span class="s3">= </span><span class="s1">optionString</span><span class="s3">.</span><span class="s1">substr</span><span class="s3">(</span><span class="s6">2</span><span class="s3">);</span>

    <span class="s4">for </span><span class="s3">(</span><span class="s1">actionOptionString </span><span class="s4">in this</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(!</span><span class="s1">$$</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">, </span><span class="s1">actionOptionString</span><span class="s3">)) </span><span class="s4">continue</span><span class="s3">;</span>

      <span class="s1">action </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_optionStringActions</span><span class="s3">[</span><span class="s1">actionOptionString</span><span class="s3">];</span>
      <span class="s4">if </span><span class="s3">(</span><span class="s1">actionOptionString </span><span class="s3">=== </span><span class="s1">optionPrefixShort</span><span class="s3">) {</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">push</span><span class="s3">([ </span><span class="s1">action</span><span class="s3">, </span><span class="s1">actionOptionString</span><span class="s3">, </span><span class="s1">argExplicitShort </span><span class="s3">]);</span>
      <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">actionOptionString</span><span class="s3">.</span><span class="s1">substr</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">optionPrefix</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) === </span><span class="s1">optionPrefix</span><span class="s3">) {</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">push</span><span class="s3">([ </span><span class="s1">action</span><span class="s3">, </span><span class="s1">actionOptionString</span><span class="s3">, </span><span class="s1">argExplicit </span><span class="s3">]);</span>
      <span class="s3">}</span>
    <span class="s3">}</span>

  <span class="s5">// shouldn't ever get here</span>
  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s4">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s1">format</span><span class="s3">(</span><span class="s2">'Unexpected option string: %s.'</span><span class="s3">, </span><span class="s1">optionString</span><span class="s3">));</span>
  <span class="s3">}</span>
  <span class="s5">// return the collected option tuples</span>
  <span class="s4">return </span><span class="s1">result</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_getNargsPattern </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">) {</span>
  <span class="s5">// in all examples below, we have to allow for '--' args</span>
  <span class="s5">// which are represented as '-' in the pattern</span>
  <span class="s4">var </span><span class="s1">regexpNargs</span><span class="s3">;</span>

  <span class="s4">switch </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs</span><span class="s3">) {</span>
    <span class="s5">// the default (null) is assumed to be a single argument</span>
    <span class="s4">case </span><span class="s1">undefined</span><span class="s3">:</span>
    <span class="s4">case null</span><span class="s3">:</span>
      <span class="s1">regexpNargs </span><span class="s3">= </span><span class="s2">'(-*A-*)'</span><span class="s3">;</span>
      <span class="s4">break</span><span class="s3">;</span>
    <span class="s5">// allow zero or more arguments</span>
    <span class="s4">case </span><span class="s1">c</span><span class="s3">.</span><span class="s1">OPTIONAL</span><span class="s3">:</span>
      <span class="s1">regexpNargs </span><span class="s3">= </span><span class="s2">'(-*A?-*)'</span><span class="s3">;</span>
      <span class="s4">break</span><span class="s3">;</span>
    <span class="s5">// allow zero or more arguments</span>
    <span class="s4">case </span><span class="s1">c</span><span class="s3">.</span><span class="s1">ZERO_OR_MORE</span><span class="s3">:</span>
      <span class="s1">regexpNargs </span><span class="s3">= </span><span class="s2">'(-*[A-]*)'</span><span class="s3">;</span>
      <span class="s4">break</span><span class="s3">;</span>
    <span class="s5">// allow one or more arguments</span>
    <span class="s4">case </span><span class="s1">c</span><span class="s3">.</span><span class="s1">ONE_OR_MORE</span><span class="s3">:</span>
      <span class="s1">regexpNargs </span><span class="s3">= </span><span class="s2">'(-*A[A-]*)'</span><span class="s3">;</span>
      <span class="s4">break</span><span class="s3">;</span>
    <span class="s5">// allow any number of options or arguments</span>
    <span class="s4">case </span><span class="s1">c</span><span class="s3">.</span><span class="s1">REMAINDER</span><span class="s3">:</span>
      <span class="s1">regexpNargs </span><span class="s3">= </span><span class="s2">'([-AO]*)'</span><span class="s3">;</span>
      <span class="s4">break</span><span class="s3">;</span>
    <span class="s5">// allow one argument followed by any number of options or arguments</span>
    <span class="s4">case </span><span class="s1">c</span><span class="s3">.</span><span class="s1">PARSER</span><span class="s3">:</span>
      <span class="s1">regexpNargs </span><span class="s3">= </span><span class="s2">'(-*A[-AO]*)'</span><span class="s3">;</span>
      <span class="s4">break</span><span class="s3">;</span>
    <span class="s5">// all others should be integers</span>
    <span class="s4">default</span><span class="s3">:</span>
      <span class="s1">regexpNargs </span><span class="s3">= </span><span class="s2">'(-*' </span><span class="s3">+ </span><span class="s1">$$</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s2">'-*A'</span><span class="s3">, </span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs</span><span class="s3">) + </span><span class="s2">'-*)'</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s5">// if this is an optional action, -- is not allowed</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">isOptional</span><span class="s3">()) {</span>
    <span class="s1">regexpNargs </span><span class="s3">= </span><span class="s1">regexpNargs</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/-\*/g</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
    <span class="s1">regexpNargs </span><span class="s3">= </span><span class="s1">regexpNargs</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/-/g</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s5">// return the pattern</span>
  <span class="s4">return </span><span class="s1">regexpNargs</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s5">//</span>
<span class="s5">// Value conversion methods</span>
<span class="s5">//</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_getValues </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">argStrings</span><span class="s3">) {</span>
  <span class="s4">var </span><span class="s1">self </span><span class="s3">= </span><span class="s4">this</span><span class="s3">;</span>

  <span class="s5">// for everything but PARSER args, strip out '--'</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs </span><span class="s3">!== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">PARSER </span><span class="s3">&amp;&amp; </span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs </span><span class="s3">!== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">REMAINDER</span><span class="s3">) {</span>
    <span class="s1">argStrings </span><span class="s3">= </span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">arrayElement</span><span class="s3">) {</span>
      <span class="s4">return </span><span class="s1">arrayElement </span><span class="s3">!== </span><span class="s2">'--'</span><span class="s3">;</span>
    <span class="s3">});</span>
  <span class="s3">}</span>

  <span class="s4">var </span><span class="s1">value</span><span class="s3">, </span><span class="s1">argString</span><span class="s3">;</span>

  <span class="s5">// optional argument produces a default when not present</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">length </span><span class="s3">=== </span><span class="s6">0 </span><span class="s3">&amp;&amp; </span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs </span><span class="s3">=== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">OPTIONAL</span><span class="s3">) {</span>

    <span class="s1">value </span><span class="s3">= (</span><span class="s1">action</span><span class="s3">.</span><span class="s1">isOptional</span><span class="s3">()) ? </span><span class="s1">action</span><span class="s3">.</span><span class="s1">constant </span><span class="s3">: </span><span class="s1">action</span><span class="s3">.</span><span class="s1">defaultValue</span><span class="s3">;</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s3">(</span><span class="s1">value</span><span class="s3">) === </span><span class="s2">'string'</span><span class="s3">) {</span>
      <span class="s1">value </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_getValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">value</span><span class="s3">);</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_checkValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">value</span><span class="s3">);</span>
    <span class="s3">}</span>

  <span class="s5">// when nargs='*' on a positional, if there were no command-line</span>
  <span class="s5">// args, use the default if it is anything other than None</span>
  <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">length </span><span class="s3">=== </span><span class="s6">0 </span><span class="s3">&amp;&amp; </span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs </span><span class="s3">=== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">ZERO_OR_MORE </span><span class="s3">&amp;&amp;</span>
    <span class="s1">action</span><span class="s3">.</span><span class="s1">optionStrings</span><span class="s3">.</span><span class="s1">length </span><span class="s3">=== </span><span class="s6">0</span><span class="s3">) {</span>

    <span class="s1">value </span><span class="s3">= (</span><span class="s1">action</span><span class="s3">.</span><span class="s1">defaultValue </span><span class="s3">|| </span><span class="s1">argStrings</span><span class="s3">);</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_checkValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">value</span><span class="s3">);</span>

  <span class="s5">// single argument or optional argument produces a single value</span>
  <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">length </span><span class="s3">=== </span><span class="s6">1 </span><span class="s3">&amp;&amp;</span>
        <span class="s3">(!</span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs </span><span class="s3">|| </span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs </span><span class="s3">=== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">OPTIONAL</span><span class="s3">)) {</span>

    <span class="s1">argString </span><span class="s3">= </span><span class="s1">argStrings</span><span class="s3">[</span><span class="s6">0</span><span class="s3">];</span>
    <span class="s1">value </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_getValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">argString</span><span class="s3">);</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_checkValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">value</span><span class="s3">);</span>

  <span class="s5">// REMAINDER arguments convert all values, checking none</span>
  <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs </span><span class="s3">=== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">REMAINDER</span><span class="s3">) {</span>
    <span class="s1">value </span><span class="s3">= </span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">v</span><span class="s3">) {</span>
      <span class="s4">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">v</span><span class="s3">);</span>
    <span class="s3">});</span>

  <span class="s5">// PARSER arguments convert all values, but check only the first</span>
  <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">action</span><span class="s3">.</span><span class="s1">nargs </span><span class="s3">=== </span><span class="s1">c</span><span class="s3">.</span><span class="s1">PARSER</span><span class="s3">) {</span>
    <span class="s1">value </span><span class="s3">= </span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">v</span><span class="s3">) {</span>
      <span class="s4">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">v</span><span class="s3">);</span>
    <span class="s3">});</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_checkValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">value</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]);</span>

  <span class="s5">// all other types of nargs produce a list</span>
  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s1">value </span><span class="s3">= </span><span class="s1">argStrings</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">v</span><span class="s3">) {</span>
      <span class="s4">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">v</span><span class="s3">);</span>
    <span class="s3">});</span>
    <span class="s1">value</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">v</span><span class="s3">) {</span>
      <span class="s1">self</span><span class="s3">.</span><span class="s1">_checkValue</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">v</span><span class="s3">);</span>
    <span class="s3">});</span>
  <span class="s3">}</span>

  <span class="s5">// return the converted value</span>
  <span class="s4">return </span><span class="s1">value</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_getValue </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">argString</span><span class="s3">) {</span>
  <span class="s4">var </span><span class="s1">result</span><span class="s3">;</span>

  <span class="s4">var </span><span class="s1">typeFunction </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_registryGet</span><span class="s3">(</span><span class="s2">'type'</span><span class="s3">, </span><span class="s1">action</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">action</span><span class="s3">.</span><span class="s1">type</span><span class="s3">);</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">typeFunction </span><span class="s3">!== </span><span class="s2">'function'</span><span class="s3">) {</span>
    <span class="s4">var </span><span class="s1">message </span><span class="s3">= </span><span class="s1">format</span><span class="s3">(</span><span class="s2">'%s is not callable'</span><span class="s3">, </span><span class="s1">typeFunction</span><span class="s3">);</span>
    <span class="s4">throw </span><span class="s1">argumentErrorHelper</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">message</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s5">// convert the value to the appropriate type</span>
  <span class="s4">try </span><span class="s3">{</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">typeFunction</span><span class="s3">(</span><span class="s1">argString</span><span class="s3">);</span>

    <span class="s5">// ArgumentTypeErrors indicate errors</span>
    <span class="s5">// If action.type is not a registered string, it is a function</span>
    <span class="s5">// Try to deduce its name for inclusion in the error message</span>
    <span class="s5">// Failing that, include the error message it raised.</span>
  <span class="s3">} </span><span class="s4">catch </span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
    <span class="s4">var </span><span class="s1">name </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">action</span><span class="s3">.</span><span class="s1">type </span><span class="s3">=== </span><span class="s2">'string'</span><span class="s3">) {</span>
      <span class="s1">name </span><span class="s3">= </span><span class="s1">action</span><span class="s3">.</span><span class="s1">type</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
      <span class="s1">name </span><span class="s3">= </span><span class="s1">action</span><span class="s3">.</span><span class="s1">type</span><span class="s3">.</span><span class="s1">name </span><span class="s3">|| </span><span class="s1">action</span><span class="s3">.</span><span class="s1">type</span><span class="s3">.</span><span class="s1">displayName </span><span class="s3">|| </span><span class="s2">'&lt;function&gt;'</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s4">var </span><span class="s1">msg </span><span class="s3">= </span><span class="s1">format</span><span class="s3">(</span><span class="s2">'Invalid %s value: %s'</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">argString</span><span class="s3">);</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">name </span><span class="s3">=== </span><span class="s2">'&lt;function&gt;'</span><span class="s3">) { </span><span class="s1">msg </span><span class="s3">+= </span><span class="s2">'</span><span class="s4">\n</span><span class="s2">' </span><span class="s3">+ </span><span class="s1">e</span><span class="s3">.</span><span class="s1">message</span><span class="s3">; }</span>
    <span class="s4">throw </span><span class="s1">argumentErrorHelper</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s5">// return the converted value</span>
  <span class="s4">return </span><span class="s1">result</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_checkValue </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">value</span><span class="s3">) {</span>
  <span class="s5">// converted value must be one of the choices (if specified)</span>
  <span class="s4">var </span><span class="s1">choices </span><span class="s3">= </span><span class="s1">action</span><span class="s3">.</span><span class="s1">choices</span><span class="s3">;</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">choices</span><span class="s3">) {</span>
    <span class="s5">// choise for argument can by array or string</span>
    <span class="s4">if </span><span class="s3">((</span><span class="s4">typeof </span><span class="s1">choices </span><span class="s3">=== </span><span class="s2">'string' </span><span class="s3">|| </span><span class="s1">Array</span><span class="s3">.</span><span class="s1">isArray</span><span class="s3">(</span><span class="s1">choices</span><span class="s3">)) &amp;&amp;</span>
        <span class="s1">choices</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">value</span><span class="s3">) !== -</span><span class="s6">1</span><span class="s3">) {</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s5">// choise for subparsers can by only hash</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">choices </span><span class="s3">=== </span><span class="s2">'object' </span><span class="s3">&amp;&amp; !</span><span class="s1">Array</span><span class="s3">.</span><span class="s1">isArray</span><span class="s3">(</span><span class="s1">choices</span><span class="s3">) &amp;&amp; </span><span class="s1">choices</span><span class="s3">[</span><span class="s1">value</span><span class="s3">]) {</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">choices </span><span class="s3">=== </span><span class="s2">'string'</span><span class="s3">) {</span>
      <span class="s1">choices </span><span class="s3">= </span><span class="s1">choices</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s2">''</span><span class="s3">).</span><span class="s1">join</span><span class="s3">(</span><span class="s2">', '</span><span class="s3">);</span>
    <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">Array</span><span class="s3">.</span><span class="s1">isArray</span><span class="s3">(</span><span class="s1">choices</span><span class="s3">)) {</span>
      <span class="s1">choices </span><span class="s3">=  </span><span class="s1">choices</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s2">', '</span><span class="s3">);</span>
    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
      <span class="s1">choices </span><span class="s3">=  </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(</span><span class="s1">choices</span><span class="s3">).</span><span class="s1">join</span><span class="s3">(</span><span class="s2">', '</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s4">var </span><span class="s1">message </span><span class="s3">= </span><span class="s1">format</span><span class="s3">(</span><span class="s2">'Invalid choice: %s (choose from [%s])'</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">choices</span><span class="s3">);</span>
    <span class="s4">throw </span><span class="s1">argumentErrorHelper</span><span class="s3">(</span><span class="s1">action</span><span class="s3">, </span><span class="s1">message</span><span class="s3">);</span>
  <span class="s3">}</span>
<span class="s3">};</span>

<span class="s5">//</span>
<span class="s5">// Help formatting methods</span>
<span class="s5">//</span>

<span class="s0">/**</span>
 <span class="s0">* ArgumentParser#formatUsage -&gt; string</span>
 <span class="s0">*</span>
 <span class="s0">* Return usage string</span>
 <span class="s0">*</span>
 <span class="s0">* See also [original guide][1]</span>
 <span class="s0">*</span>
 <span class="s0">* [1]:http://docs.python.org/dev/library/argparse.html#printing-help</span>
 <span class="s0">**/</span>
<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">formatUsage </span><span class="s3">= </span><span class="s4">function </span><span class="s3">() {</span>
  <span class="s4">var </span><span class="s1">formatter </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_getFormatter</span><span class="s3">();</span>
  <span class="s1">formatter</span><span class="s3">.</span><span class="s1">addUsage</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">usage</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_actions</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_mutuallyExclusiveGroups</span><span class="s3">);</span>
  <span class="s4">return </span><span class="s1">formatter</span><span class="s3">.</span><span class="s1">formatHelp</span><span class="s3">();</span>
<span class="s3">};</span>

<span class="s0">/**</span>
 <span class="s0">* ArgumentParser#formatHelp -&gt; string</span>
 <span class="s0">*</span>
 <span class="s0">* Return help</span>
 <span class="s0">*</span>
 <span class="s0">* See also [original guide][1]</span>
 <span class="s0">*</span>
 <span class="s0">* [1]:http://docs.python.org/dev/library/argparse.html#printing-help</span>
 <span class="s0">**/</span>
<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">formatHelp </span><span class="s3">= </span><span class="s4">function </span><span class="s3">() {</span>
  <span class="s4">var </span><span class="s1">formatter </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_getFormatter</span><span class="s3">();</span>

  <span class="s5">// usage</span>
  <span class="s1">formatter</span><span class="s3">.</span><span class="s1">addUsage</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">usage</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_actions</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_mutuallyExclusiveGroups</span><span class="s3">);</span>

  <span class="s5">// description</span>
  <span class="s1">formatter</span><span class="s3">.</span><span class="s1">addText</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">description</span><span class="s3">);</span>

  <span class="s5">// positionals, optionals and user-defined groups</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">_actionGroups</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s4">function </span><span class="s3">(</span><span class="s1">actionGroup</span><span class="s3">) {</span>
    <span class="s1">formatter</span><span class="s3">.</span><span class="s1">startSection</span><span class="s3">(</span><span class="s1">actionGroup</span><span class="s3">.</span><span class="s1">title</span><span class="s3">);</span>
    <span class="s1">formatter</span><span class="s3">.</span><span class="s1">addText</span><span class="s3">(</span><span class="s1">actionGroup</span><span class="s3">.</span><span class="s1">description</span><span class="s3">);</span>
    <span class="s1">formatter</span><span class="s3">.</span><span class="s1">addArguments</span><span class="s3">(</span><span class="s1">actionGroup</span><span class="s3">.</span><span class="s1">_groupActions</span><span class="s3">);</span>
    <span class="s1">formatter</span><span class="s3">.</span><span class="s1">endSection</span><span class="s3">();</span>
  <span class="s3">});</span>

  <span class="s5">// epilog</span>
  <span class="s1">formatter</span><span class="s3">.</span><span class="s1">addText</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">epilog</span><span class="s3">);</span>

  <span class="s5">// determine help from format above</span>
  <span class="s4">return </span><span class="s1">formatter</span><span class="s3">.</span><span class="s1">formatHelp</span><span class="s3">();</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_getFormatter </span><span class="s3">= </span><span class="s4">function </span><span class="s3">() {</span>
  <span class="s4">var </span><span class="s1">FormatterClass </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">formatterClass</span><span class="s3">;</span>
  <span class="s4">var </span><span class="s1">formatter </span><span class="s3">= </span><span class="s4">new </span><span class="s1">FormatterClass</span><span class="s3">({ </span><span class="s1">prog</span><span class="s3">: </span><span class="s4">this</span><span class="s3">.</span><span class="s1">prog </span><span class="s3">});</span>
  <span class="s4">return </span><span class="s1">formatter</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s5">//</span>
<span class="s5">//  Print functions</span>
<span class="s5">//</span>

<span class="s0">/**</span>
 <span class="s0">* ArgumentParser#printUsage() -&gt; Void</span>
 <span class="s0">*</span>
 <span class="s0">* Print usage</span>
 <span class="s0">*</span>
 <span class="s0">* See also [original guide][1]</span>
 <span class="s0">*</span>
 <span class="s0">* [1]:http://docs.python.org/dev/library/argparse.html#printing-help</span>
 <span class="s0">**/</span>
<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">printUsage </span><span class="s3">= </span><span class="s4">function </span><span class="s3">() {</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">_printMessage</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">formatUsage</span><span class="s3">());</span>
<span class="s3">};</span>

<span class="s0">/**</span>
 <span class="s0">* ArgumentParser#printHelp() -&gt; Void</span>
 <span class="s0">*</span>
 <span class="s0">* Print help</span>
 <span class="s0">*</span>
 <span class="s0">* See also [original guide][1]</span>
 <span class="s0">*</span>
 <span class="s0">* [1]:http://docs.python.org/dev/library/argparse.html#printing-help</span>
 <span class="s0">**/</span>
<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">printHelp </span><span class="s3">= </span><span class="s4">function </span><span class="s3">() {</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">_printMessage</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">formatHelp</span><span class="s3">());</span>
<span class="s3">};</span>

<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">_printMessage </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">message</span><span class="s3">, </span><span class="s1">stream</span><span class="s3">) {</span>
  <span class="s4">if </span><span class="s3">(!</span><span class="s1">stream</span><span class="s3">) {</span>
    <span class="s1">stream </span><span class="s3">= </span><span class="s1">process</span><span class="s3">.</span><span class="s1">stdout</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">message</span><span class="s3">) {</span>
    <span class="s1">stream</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s2">'' </span><span class="s3">+ </span><span class="s1">message</span><span class="s3">);</span>
  <span class="s3">}</span>
<span class="s3">};</span>

<span class="s5">//</span>
<span class="s5">//  Exit functions</span>
<span class="s5">//</span>

<span class="s0">/**</span>
 <span class="s0">* ArgumentParser#exit(status=0, message) -&gt; Void</span>
 <span class="s0">* - status (int): exit status</span>
 <span class="s0">* - message (string): message</span>
 <span class="s0">*</span>
 <span class="s0">* Print message in stderr/stdout and exit program</span>
 <span class="s0">**/</span>
<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">exit </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">status</span><span class="s3">, </span><span class="s1">message</span><span class="s3">) {</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">message</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">status </span><span class="s3">=== </span><span class="s6">0</span><span class="s3">) {</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_printMessage</span><span class="s3">(</span><span class="s1">message</span><span class="s3">);</span>
    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_printMessage</span><span class="s3">(</span><span class="s1">message</span><span class="s3">, </span><span class="s1">process</span><span class="s3">.</span><span class="s1">stderr</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">}</span>

  <span class="s1">process</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s1">status</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s0">/**</span>
 <span class="s0">* ArgumentParser#error(message) -&gt; Void</span>
 <span class="s0">* - err (Error|string): message</span>
 <span class="s0">*</span>
 <span class="s0">* Error method Prints a usage message incorporating the message to stderr and</span>
 <span class="s0">* exits. If you override this in a subclass,</span>
 <span class="s0">* it should not return -- it should</span>
 <span class="s0">* either exit or throw an exception.</span>
 <span class="s0">*</span>
 <span class="s0">**/</span>
<span class="s1">ArgumentParser</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">error </span><span class="s3">= </span><span class="s4">function </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
  <span class="s4">var </span><span class="s1">message</span><span class="s3">;</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">err </span><span class="s4">instanceof </span><span class="s1">Error</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">debug </span><span class="s3">=== </span><span class="s4">true</span><span class="s3">) {</span>
      <span class="s4">throw </span><span class="s1">err</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s1">message </span><span class="s3">= </span><span class="s1">err</span><span class="s3">.</span><span class="s1">message</span><span class="s3">;</span>
  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s1">message </span><span class="s3">= </span><span class="s1">err</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s4">var </span><span class="s1">msg </span><span class="s3">= </span><span class="s1">format</span><span class="s3">(</span><span class="s2">'%s: error: %s'</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">prog</span><span class="s3">, </span><span class="s1">message</span><span class="s3">) + </span><span class="s1">c</span><span class="s3">.</span><span class="s1">EOL</span><span class="s3">;</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">debug </span><span class="s3">=== </span><span class="s4">true</span><span class="s3">) {</span>
    <span class="s4">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s4">this</span><span class="s3">.</span><span class="s1">printUsage</span><span class="s3">(</span><span class="s1">process</span><span class="s3">.</span><span class="s1">stderr</span><span class="s3">);</span>

  <span class="s4">return this</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">module</span><span class="s3">.</span><span class="s1">exports </span><span class="s3">= </span><span class="s1">ArgumentParser</span><span class="s3">;</span>
</pre>
</body>
</html>