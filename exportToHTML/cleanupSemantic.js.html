<html>
<head>
<title>cleanupSemantic.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #67a37c; font-style: italic;}
.s7 { color: #7a7e85;}
.s8 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
cleanupSemantic.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>

<span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">exports</span><span class="s1">, </span><span class="s0">'__esModule'</span><span class="s1">, {</span>
  <span class="s2">value</span><span class="s1">: </span><span class="s3">true</span>
<span class="s1">});</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">cleanupSemantic </span><span class="s1">=</span>
  <span class="s2">exports</span><span class="s1">.</span><span class="s2">Diff </span><span class="s1">=</span>
  <span class="s2">exports</span><span class="s1">.</span><span class="s2">DIFF_INSERT </span><span class="s1">=</span>
  <span class="s2">exports</span><span class="s1">.</span><span class="s2">DIFF_EQUAL </span><span class="s1">=</span>
  <span class="s2">exports</span><span class="s1">.</span><span class="s2">DIFF_DELETE </span><span class="s1">=</span>
    <span class="s3">void </span><span class="s4">0</span><span class="s1">;</span>

<span class="s3">function </span><span class="s2">_defineProperty</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">, </span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s3">in </span><span class="s2">obj</span><span class="s1">) {</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">, </span><span class="s2">key</span><span class="s1">, {</span>
      <span class="s2">value</span><span class="s1">: </span><span class="s2">value</span><span class="s1">,</span>
      <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
      <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
      <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span>
    <span class="s1">});</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s2">obj</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">value</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">obj</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s5">/**</span>
 <span class="s5">* Diff Match and Patch</span>
 <span class="s5">* Copyright 2018 The diff-match-patch Authors.</span>
 <span class="s5">* https://github.com/google/diff-match-patch</span>
 <span class="s5">*</span>
 <span class="s5">* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
 <span class="s5">* you may not use this file except in compliance with the License.</span>
 <span class="s5">* You may obtain a copy of the License at</span>
 <span class="s5">*</span>
 <span class="s5">*   http://www.apache.org/licenses/LICENSE-2.0</span>
 <span class="s5">*</span>
 <span class="s5">* Unless required by applicable law or agreed to in writing, software</span>
 <span class="s5">* distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
 <span class="s5">* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
 <span class="s5">* See the License for the specific language governing permissions and</span>
 <span class="s5">* limitations under the License.</span>
 <span class="s5">*/</span>

<span class="s5">/**</span>
 <span class="s5">* </span><span class="s6">@fileoverview </span><span class="s5">Computes the difference between two texts to create a patch.</span>
 <span class="s5">* Applies the patch onto another text, allowing for errors.</span>
 <span class="s5">* </span><span class="s6">@author </span><span class="s5">fraser@google.com (Neil Fraser)</span>
 <span class="s5">*/</span>

<span class="s5">/**</span>
 <span class="s5">* CHANGES by pedrottimark to diff_match_patch_uncompressed.ts file:</span>
 <span class="s5">*</span>
 <span class="s5">* 1. Delete anything not needed to use diff_cleanupSemantic method</span>
 <span class="s5">* 2. Convert from prototype properties to var declarations</span>
 <span class="s5">* 3. Convert Diff to class from constructor and prototype</span>
 <span class="s5">* 4. Add type annotations for arguments and return values</span>
 <span class="s5">* 5. Add exports</span>
 <span class="s5">*/</span>

<span class="s5">/**</span>
 <span class="s5">* The data structure representing a diff is an array of tuples:</span>
 <span class="s5">* [[DIFF_DELETE, 'Hello'], [DIFF_INSERT, 'Goodbye'], [DIFF_EQUAL, ' world.']]</span>
 <span class="s5">* which means: delete 'Hello', add 'Goodbye' and keep ' world.'</span>
 <span class="s5">*/</span>
<span class="s3">var </span><span class="s2">DIFF_DELETE </span><span class="s1">= -</span><span class="s4">1</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">DIFF_DELETE </span><span class="s1">= </span><span class="s2">DIFF_DELETE</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">DIFF_INSERT </span><span class="s1">= </span><span class="s4">1</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">DIFF_INSERT </span><span class="s1">= </span><span class="s2">DIFF_INSERT</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">DIFF_EQUAL </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
<span class="s5">/**</span>
 <span class="s5">* Class representing one diff tuple.</span>
 <span class="s5">* Attempts to look like a two-element array (which is what this used to be).</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{number} op Operation, one of: DIFF_DELETE, DIFF_INSERT, DIFF_EQUAL.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} text Text to be deleted, inserted, or retained.</span>
 <span class="s5">* </span><span class="s6">@constructor</span>
 <span class="s5">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">DIFF_EQUAL </span><span class="s1">= </span><span class="s2">DIFF_EQUAL</span><span class="s1">;</span>

<span class="s3">class </span><span class="s2">Diff </span><span class="s1">{</span>
  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">op</span><span class="s1">, </span><span class="s2">text</span><span class="s1">) {</span>
    <span class="s2">_defineProperty</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s3">void </span><span class="s4">0</span><span class="s1">);</span>

    <span class="s2">_defineProperty</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s3">void </span><span class="s4">0</span><span class="s1">);</span>

    <span class="s3">this</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">op</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">text</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>
<span class="s5">/**</span>
 <span class="s5">* Determine the common prefix of two strings.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} text1 First string.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} text2 Second string.</span>
 <span class="s5">* </span><span class="s6">@return </span><span class="s5">{number} The number of characters common to the start of each</span>
 <span class="s5">*     string.</span>
 <span class="s5">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">Diff </span><span class="s1">= </span><span class="s2">Diff</span><span class="s1">;</span>

<span class="s3">var </span><span class="s2">diff_commonPrefix </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">text1</span><span class="s1">, </span><span class="s2">text2</span><span class="s1">) {</span>
  <span class="s7">// Quick check for common null cases.</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">text1 </span><span class="s1">|| !</span><span class="s2">text2 </span><span class="s1">|| </span><span class="s2">text1</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s4">0</span><span class="s1">) != </span><span class="s2">text2</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s4">0</span><span class="s1">)) {</span>
    <span class="s3">return </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s7">// Binary search.</span>
  <span class="s7">// Performance analysis: https://neil.fraser.name/news/2007/10/09/</span>

  <span class="s3">var </span><span class="s2">pointermin </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">pointermax </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span><span class="s2">text1</span><span class="s1">.</span><span class="s2">length</span><span class="s1">, </span><span class="s2">text2</span><span class="s1">.</span><span class="s2">length</span><span class="s1">);</span>
  <span class="s3">var </span><span class="s2">pointermid </span><span class="s1">= </span><span class="s2">pointermax</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">pointerstart </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s2">pointermin </span><span class="s1">&lt; </span><span class="s2">pointermid</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">text1</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">pointerstart</span><span class="s1">, </span><span class="s2">pointermid</span><span class="s1">) ==</span>
      <span class="s2">text2</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">pointerstart</span><span class="s1">, </span><span class="s2">pointermid</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s2">pointermin </span><span class="s1">= </span><span class="s2">pointermid</span><span class="s1">;</span>
      <span class="s2">pointerstart </span><span class="s1">= </span><span class="s2">pointermin</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">pointermax </span><span class="s1">= </span><span class="s2">pointermid</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">pointermid </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">floor</span><span class="s1">((</span><span class="s2">pointermax </span><span class="s1">- </span><span class="s2">pointermin</span><span class="s1">) / </span><span class="s4">2 </span><span class="s1">+ </span><span class="s2">pointermin</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">pointermid</span><span class="s1">;</span>
<span class="s1">};</span>
<span class="s5">/**</span>
 <span class="s5">* Determine the common suffix of two strings.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} text1 First string.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} text2 Second string.</span>
 <span class="s5">* </span><span class="s6">@return </span><span class="s5">{number} The number of characters common to the end of each string.</span>
 <span class="s5">*/</span>

<span class="s3">var </span><span class="s2">diff_commonSuffix </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">text1</span><span class="s1">, </span><span class="s2">text2</span><span class="s1">) {</span>
  <span class="s7">// Quick check for common null cases.</span>
  <span class="s3">if </span><span class="s1">(</span>
    <span class="s1">!</span><span class="s2">text1 </span><span class="s1">||</span>
    <span class="s1">!</span><span class="s2">text2 </span><span class="s1">||</span>
    <span class="s2">text1</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">text1</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">) != </span><span class="s2">text2</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">text2</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">)</span>
  <span class="s1">) {</span>
    <span class="s3">return </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s7">// Binary search.</span>
  <span class="s7">// Performance analysis: https://neil.fraser.name/news/2007/10/09/</span>

  <span class="s3">var </span><span class="s2">pointermin </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">pointermax </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span><span class="s2">text1</span><span class="s1">.</span><span class="s2">length</span><span class="s1">, </span><span class="s2">text2</span><span class="s1">.</span><span class="s2">length</span><span class="s1">);</span>
  <span class="s3">var </span><span class="s2">pointermid </span><span class="s1">= </span><span class="s2">pointermax</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">pointerend </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s2">pointermin </span><span class="s1">&lt; </span><span class="s2">pointermid</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">text1</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">text1</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">pointermid</span><span class="s1">, </span><span class="s2">text1</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">pointerend</span><span class="s1">) ==</span>
      <span class="s2">text2</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">text2</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">pointermid</span><span class="s1">, </span><span class="s2">text2</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">pointerend</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s2">pointermin </span><span class="s1">= </span><span class="s2">pointermid</span><span class="s1">;</span>
      <span class="s2">pointerend </span><span class="s1">= </span><span class="s2">pointermin</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">pointermax </span><span class="s1">= </span><span class="s2">pointermid</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">pointermid </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">floor</span><span class="s1">((</span><span class="s2">pointermax </span><span class="s1">- </span><span class="s2">pointermin</span><span class="s1">) / </span><span class="s4">2 </span><span class="s1">+ </span><span class="s2">pointermin</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">pointermid</span><span class="s1">;</span>
<span class="s1">};</span>
<span class="s5">/**</span>
 <span class="s5">* Determine if the suffix of one string is the prefix of another.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} text1 First string.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} text2 Second string.</span>
 <span class="s5">* </span><span class="s6">@return </span><span class="s5">{number} The number of characters common to the end of the first</span>
 <span class="s5">*     string and the start of the second string.</span>
 <span class="s5">* </span><span class="s6">@private</span>
 <span class="s5">*/</span>

<span class="s3">var </span><span class="s2">diff_commonOverlap_ </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">text1</span><span class="s1">, </span><span class="s2">text2</span><span class="s1">) {</span>
  <span class="s7">// Cache the text lengths to prevent multiple calls.</span>
  <span class="s3">var </span><span class="s2">text1_length </span><span class="s1">= </span><span class="s2">text1</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">text2_length </span><span class="s1">= </span><span class="s2">text2</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s7">// Eliminate the null case.</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">text1_length </span><span class="s1">== </span><span class="s4">0 </span><span class="s1">|| </span><span class="s2">text2_length </span><span class="s1">== </span><span class="s4">0</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s7">// Truncate the longer string.</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">text1_length </span><span class="s1">&gt; </span><span class="s2">text2_length</span><span class="s1">) {</span>
    <span class="s2">text1 </span><span class="s1">= </span><span class="s2">text1</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">text1_length </span><span class="s1">- </span><span class="s2">text2_length</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">text1_length </span><span class="s1">&lt; </span><span class="s2">text2_length</span><span class="s1">) {</span>
    <span class="s2">text2 </span><span class="s1">= </span><span class="s2">text2</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">text1_length</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">var </span><span class="s2">text_length </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span><span class="s2">text1_length</span><span class="s1">, </span><span class="s2">text2_length</span><span class="s1">); </span><span class="s7">// Quick check for the worst case.</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">text1 </span><span class="s1">== </span><span class="s2">text2</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">text_length</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s7">// Start by looking for a single character match</span>
  <span class="s7">// and increase length until no match is found.</span>
  <span class="s7">// Performance analysis: https://neil.fraser.name/news/2010/11/04/</span>

  <span class="s3">var </span><span class="s2">best </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s1">= </span><span class="s4">1</span><span class="s1">;</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">pattern </span><span class="s1">= </span><span class="s2">text1</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">text_length </span><span class="s1">- </span><span class="s2">length</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">found </span><span class="s1">= </span><span class="s2">text2</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s2">pattern</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">found </span><span class="s1">== -</span><span class="s4">1</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s2">best</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">length </span><span class="s1">+= </span><span class="s2">found</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">found </span><span class="s1">== </span><span class="s4">0 </span><span class="s1">||</span>
      <span class="s2">text1</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">text_length </span><span class="s1">- </span><span class="s2">length</span><span class="s1">) == </span><span class="s2">text2</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">length</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s2">best </span><span class="s1">= </span><span class="s2">length</span><span class="s1">;</span>
      <span class="s2">length</span><span class="s1">++;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">};</span>
<span class="s5">/**</span>
 <span class="s5">* Reduce the number of edits by eliminating semantically trivial equalities.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{!Array.&lt;!diff_match_patch.Diff&gt;} diffs Array of diff tuples.</span>
 <span class="s5">*/</span>

<span class="s3">var </span><span class="s2">diff_cleanupSemantic </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">) {</span>
  <span class="s3">var </span><span class="s2">changes </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">equalities </span><span class="s1">= []; </span><span class="s7">// Stack of indices where equalities are found.</span>

  <span class="s3">var </span><span class="s2">equalitiesLength </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s7">// Keeping our own length var is faster in JS.</span>

  <span class="s5">/** </span><span class="s6">@type </span><span class="s5">{?string} */</span>

  <span class="s3">var </span><span class="s2">lastEquality </span><span class="s1">= </span><span class="s3">null</span><span class="s1">; </span><span class="s7">// Always equal to diffs[equalities[equalitiesLength - 1]][1]</span>

  <span class="s3">var </span><span class="s2">pointer </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s7">// Index of current position.</span>
  <span class="s7">// Number of characters that changed prior to the equality.</span>

  <span class="s3">var </span><span class="s2">length_insertions1 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">length_deletions1 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s7">// Number of characters that changed after the equality.</span>

  <span class="s3">var </span><span class="s2">length_insertions2 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">length_deletions2 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">&lt; </span><span class="s2">diffs</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">DIFF_EQUAL</span><span class="s1">) {</span>
      <span class="s7">// Equality found.</span>
      <span class="s2">equalities</span><span class="s1">[</span><span class="s2">equalitiesLength</span><span class="s1">++] = </span><span class="s2">pointer</span><span class="s1">;</span>
      <span class="s2">length_insertions1 </span><span class="s1">= </span><span class="s2">length_insertions2</span><span class="s1">;</span>
      <span class="s2">length_deletions1 </span><span class="s1">= </span><span class="s2">length_deletions2</span><span class="s1">;</span>
      <span class="s2">length_insertions2 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
      <span class="s2">length_deletions2 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
      <span class="s2">lastEquality </span><span class="s1">= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s7">// An insertion or deletion.</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">DIFF_INSERT</span><span class="s1">) {</span>
        <span class="s2">length_insertions2 </span><span class="s1">+= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">length</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">length_deletions2 </span><span class="s1">+= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">length</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s7">// Eliminate an equality that is smaller or equal to the edits on both</span>
      <span class="s7">// sides of it.</span>

      <span class="s3">if </span><span class="s1">(</span>
        <span class="s2">lastEquality </span><span class="s1">&amp;&amp;</span>
        <span class="s2">lastEquality</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt;=</span>
          <span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s2">length_insertions1</span><span class="s1">, </span><span class="s2">length_deletions1</span><span class="s1">) &amp;&amp;</span>
        <span class="s2">lastEquality</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt;= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s2">length_insertions2</span><span class="s1">, </span><span class="s2">length_deletions2</span><span class="s1">)</span>
      <span class="s1">) {</span>
        <span class="s7">// Duplicate record.</span>
        <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span>
          <span class="s2">equalities</span><span class="s1">[</span><span class="s2">equalitiesLength </span><span class="s1">- </span><span class="s4">1</span><span class="s1">],</span>
          <span class="s4">0</span><span class="s1">,</span>
          <span class="s3">new </span><span class="s2">Diff</span><span class="s1">(</span><span class="s2">DIFF_DELETE</span><span class="s1">, </span><span class="s2">lastEquality</span><span class="s1">)</span>
        <span class="s1">); </span><span class="s7">// Change second copy to insert.</span>

        <span class="s2">diffs</span><span class="s1">[</span><span class="s2">equalities</span><span class="s1">[</span><span class="s2">equalitiesLength </span><span class="s1">- </span><span class="s4">1</span><span class="s1">] + </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">DIFF_INSERT</span><span class="s1">; </span><span class="s7">// Throw away the equality we just deleted.</span>

        <span class="s2">equalitiesLength</span><span class="s1">--; </span><span class="s7">// Throw away the previous equality (it needs to be reevaluated).</span>

        <span class="s2">equalitiesLength</span><span class="s1">--;</span>
        <span class="s2">pointer </span><span class="s1">= </span><span class="s2">equalitiesLength </span><span class="s1">&gt; </span><span class="s4">0 </span><span class="s1">? </span><span class="s2">equalities</span><span class="s1">[</span><span class="s2">equalitiesLength </span><span class="s1">- </span><span class="s4">1</span><span class="s1">] : -</span><span class="s4">1</span><span class="s1">;</span>
        <span class="s2">length_insertions1 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s7">// Reset the counters.</span>

        <span class="s2">length_deletions1 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s2">length_insertions2 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s2">length_deletions2 </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s2">lastEquality </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s2">changes </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">pointer</span><span class="s1">++;</span>
  <span class="s1">} </span><span class="s7">// Normalize the diff.</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">changes</span><span class="s1">) {</span>
    <span class="s2">diff_cleanupMerge</span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">diff_cleanupSemanticLossless</span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">); </span><span class="s7">// Find any overlaps between deletions and insertions.</span>
  <span class="s7">// e.g: &lt;del&gt;abcxxx&lt;/del&gt;&lt;ins&gt;xxxdef&lt;/ins&gt;</span>
  <span class="s7">//   -&gt; &lt;del&gt;abc&lt;/del&gt;xxx&lt;ins&gt;def&lt;/ins&gt;</span>
  <span class="s7">// e.g: &lt;del&gt;xxxabc&lt;/del&gt;&lt;ins&gt;defxxx&lt;/ins&gt;</span>
  <span class="s7">//   -&gt; &lt;ins&gt;def&lt;/ins&gt;xxx&lt;del&gt;abc&lt;/del&gt;</span>
  <span class="s7">// Only extract an overlap if it is as big as the edit ahead or behind it.</span>

  <span class="s2">pointer </span><span class="s1">= </span><span class="s4">1</span><span class="s1">;</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">&lt; </span><span class="s2">diffs</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">DIFF_DELETE </span><span class="s1">&amp;&amp;</span>
      <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">DIFF_INSERT</span>
    <span class="s1">) {</span>
      <span class="s3">var </span><span class="s2">deletion </span><span class="s1">= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s3">var </span><span class="s2">insertion </span><span class="s1">= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s3">var </span><span class="s2">overlap_length1 </span><span class="s1">= </span><span class="s2">diff_commonOverlap_</span><span class="s1">(</span><span class="s2">deletion</span><span class="s1">, </span><span class="s2">insertion</span><span class="s1">);</span>
      <span class="s3">var </span><span class="s2">overlap_length2 </span><span class="s1">= </span><span class="s2">diff_commonOverlap_</span><span class="s1">(</span><span class="s2">insertion</span><span class="s1">, </span><span class="s2">deletion</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">overlap_length1 </span><span class="s1">&gt;= </span><span class="s2">overlap_length2</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s2">overlap_length1 </span><span class="s1">&gt;= </span><span class="s2">deletion</span><span class="s1">.</span><span class="s2">length </span><span class="s1">/ </span><span class="s4">2 </span><span class="s1">||</span>
          <span class="s2">overlap_length1 </span><span class="s1">&gt;= </span><span class="s2">insertion</span><span class="s1">.</span><span class="s2">length </span><span class="s1">/ </span><span class="s4">2</span>
        <span class="s1">) {</span>
          <span class="s7">// Overlap found.  Insert an equality and trim the surrounding edits.</span>
          <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span>
            <span class="s2">pointer</span><span class="s1">,</span>
            <span class="s4">0</span><span class="s1">,</span>
            <span class="s3">new </span><span class="s2">Diff</span><span class="s1">(</span><span class="s2">DIFF_EQUAL</span><span class="s1">, </span><span class="s2">insertion</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">overlap_length1</span><span class="s1">))</span>
          <span class="s1">);</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">deletion</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span>
            <span class="s4">0</span><span class="s1">,</span>
            <span class="s2">deletion</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">overlap_length1</span>
          <span class="s1">);</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">insertion</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">overlap_length1</span><span class="s1">);</span>
          <span class="s2">pointer</span><span class="s1">++;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s2">overlap_length2 </span><span class="s1">&gt;= </span><span class="s2">deletion</span><span class="s1">.</span><span class="s2">length </span><span class="s1">/ </span><span class="s4">2 </span><span class="s1">||</span>
          <span class="s2">overlap_length2 </span><span class="s1">&gt;= </span><span class="s2">insertion</span><span class="s1">.</span><span class="s2">length </span><span class="s1">/ </span><span class="s4">2</span>
        <span class="s1">) {</span>
          <span class="s7">// Reverse overlap found.</span>
          <span class="s7">// Insert an equality and swap and trim the surrounding edits.</span>
          <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span>
            <span class="s2">pointer</span><span class="s1">,</span>
            <span class="s4">0</span><span class="s1">,</span>
            <span class="s3">new </span><span class="s2">Diff</span><span class="s1">(</span><span class="s2">DIFF_EQUAL</span><span class="s1">, </span><span class="s2">deletion</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">overlap_length2</span><span class="s1">))</span>
          <span class="s1">);</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">DIFF_INSERT</span><span class="s1">;</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">insertion</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span>
            <span class="s4">0</span><span class="s1">,</span>
            <span class="s2">insertion</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">overlap_length2</span>
          <span class="s1">);</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">DIFF_DELETE</span><span class="s1">;</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">deletion</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">overlap_length2</span><span class="s1">);</span>
          <span class="s2">pointer</span><span class="s1">++;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s2">pointer</span><span class="s1">++;</span>
    <span class="s1">}</span>

    <span class="s2">pointer</span><span class="s1">++;</span>
  <span class="s1">}</span>
<span class="s1">};</span>
<span class="s5">/**</span>
 <span class="s5">* Look for single edits surrounded on both sides by equalities</span>
 <span class="s5">* which can be shifted sideways to align the edit to a word boundary.</span>
 <span class="s5">* e.g: The c&lt;ins&gt;at c&lt;/ins&gt;ame. -&gt; The &lt;ins&gt;cat &lt;/ins&gt;came.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{!Array.&lt;!diff_match_patch.Diff&gt;} diffs Array of diff tuples.</span>
 <span class="s5">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">cleanupSemantic </span><span class="s1">= </span><span class="s2">diff_cleanupSemantic</span><span class="s1">;</span>

<span class="s3">var </span><span class="s2">diff_cleanupSemanticLossless </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">) {</span>
  <span class="s5">/**</span>
   <span class="s5">* Given two strings, compute a score representing whether the internal</span>
   <span class="s5">* boundary falls on logical boundaries.</span>
   <span class="s5">* Scores range from 6 (best) to 0 (worst).</span>
   <span class="s5">* Closure, but does not reference any external variables.</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} one First string.</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} two Second string.</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{number} The score.</span>
   <span class="s5">* </span><span class="s6">@private</span>
   <span class="s5">*/</span>
  <span class="s3">function </span><span class="s2">diff_cleanupSemanticScore_</span><span class="s1">(</span><span class="s2">one</span><span class="s1">, </span><span class="s2">two</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">one </span><span class="s1">|| !</span><span class="s2">two</span><span class="s1">) {</span>
      <span class="s7">// Edges are the best.</span>
      <span class="s3">return </span><span class="s4">6</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s7">// Each port of this function behaves slightly differently due to</span>
    <span class="s7">// subtle differences in each language's definition of things like</span>
    <span class="s7">// 'whitespace'.  Since this function's purpose is largely cosmetic,</span>
    <span class="s7">// the choice has been made to use each language's native features</span>
    <span class="s7">// rather than force total conformity.</span>

    <span class="s3">var </span><span class="s2">char1 </span><span class="s1">= </span><span class="s2">one</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">one</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">char2 </span><span class="s1">= </span><span class="s2">two</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s4">0</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">nonAlphaNumeric1 </span><span class="s1">= </span><span class="s2">char1</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">nonAlphaNumericRegex_</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">nonAlphaNumeric2 </span><span class="s1">= </span><span class="s2">char2</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">nonAlphaNumericRegex_</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">whitespace1 </span><span class="s1">= </span><span class="s2">nonAlphaNumeric1 </span><span class="s1">&amp;&amp; </span><span class="s2">char1</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">whitespaceRegex_</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">whitespace2 </span><span class="s1">= </span><span class="s2">nonAlphaNumeric2 </span><span class="s1">&amp;&amp; </span><span class="s2">char2</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">whitespaceRegex_</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">lineBreak1 </span><span class="s1">= </span><span class="s2">whitespace1 </span><span class="s1">&amp;&amp; </span><span class="s2">char1</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">linebreakRegex_</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">lineBreak2 </span><span class="s1">= </span><span class="s2">whitespace2 </span><span class="s1">&amp;&amp; </span><span class="s2">char2</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">linebreakRegex_</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">blankLine1 </span><span class="s1">= </span><span class="s2">lineBreak1 </span><span class="s1">&amp;&amp; </span><span class="s2">one</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">blanklineEndRegex_</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">blankLine2 </span><span class="s1">= </span><span class="s2">lineBreak2 </span><span class="s1">&amp;&amp; </span><span class="s2">two</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">blanklineStartRegex_</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">blankLine1 </span><span class="s1">|| </span><span class="s2">blankLine2</span><span class="s1">) {</span>
      <span class="s7">// Five points for blank lines.</span>
      <span class="s3">return </span><span class="s4">5</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">lineBreak1 </span><span class="s1">|| </span><span class="s2">lineBreak2</span><span class="s1">) {</span>
      <span class="s7">// Four points for line breaks.</span>
      <span class="s3">return </span><span class="s4">4</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">nonAlphaNumeric1 </span><span class="s1">&amp;&amp; !</span><span class="s2">whitespace1 </span><span class="s1">&amp;&amp; </span><span class="s2">whitespace2</span><span class="s1">) {</span>
      <span class="s7">// Three points for end of sentences.</span>
      <span class="s3">return </span><span class="s4">3</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">whitespace1 </span><span class="s1">|| </span><span class="s2">whitespace2</span><span class="s1">) {</span>
      <span class="s7">// Two points for whitespace.</span>
      <span class="s3">return </span><span class="s4">2</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">nonAlphaNumeric1 </span><span class="s1">|| </span><span class="s2">nonAlphaNumeric2</span><span class="s1">) {</span>
      <span class="s7">// One point for non-alphanumeric.</span>
      <span class="s3">return </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">var </span><span class="s2">pointer </span><span class="s1">= </span><span class="s4">1</span><span class="s1">; </span><span class="s7">// Intentionally ignore the first and last element (don't need checking).</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">&lt; </span><span class="s2">diffs</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">DIFF_EQUAL </span><span class="s1">&amp;&amp;</span>
      <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">DIFF_EQUAL</span>
    <span class="s1">) {</span>
      <span class="s7">// This is a single edit surrounded by equalities.</span>
      <span class="s3">var </span><span class="s2">equality1 </span><span class="s1">= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s3">var </span><span class="s2">edit </span><span class="s1">= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s3">var </span><span class="s2">equality2 </span><span class="s1">= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]; </span><span class="s7">// First, shift the edit as far left as possible.</span>

      <span class="s3">var </span><span class="s2">commonOffset </span><span class="s1">= </span><span class="s2">diff_commonSuffix</span><span class="s1">(</span><span class="s2">equality1</span><span class="s1">, </span><span class="s2">edit</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">commonOffset</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">commonString </span><span class="s1">= </span><span class="s2">edit</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">edit</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">commonOffset</span><span class="s1">);</span>
        <span class="s2">equality1 </span><span class="s1">= </span><span class="s2">equality1</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">equality1</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">commonOffset</span><span class="s1">);</span>
        <span class="s2">edit </span><span class="s1">= </span><span class="s2">commonString </span><span class="s1">+ </span><span class="s2">edit</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">edit</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">commonOffset</span><span class="s1">);</span>
        <span class="s2">equality2 </span><span class="s1">= </span><span class="s2">commonString </span><span class="s1">+ </span><span class="s2">equality2</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s7">// Second, step character by character right, looking for the best fit.</span>

      <span class="s3">var </span><span class="s2">bestEquality1 </span><span class="s1">= </span><span class="s2">equality1</span><span class="s1">;</span>
      <span class="s3">var </span><span class="s2">bestEdit </span><span class="s1">= </span><span class="s2">edit</span><span class="s1">;</span>
      <span class="s3">var </span><span class="s2">bestEquality2 </span><span class="s1">= </span><span class="s2">equality2</span><span class="s1">;</span>
      <span class="s3">var </span><span class="s2">bestScore </span><span class="s1">=</span>
        <span class="s2">diff_cleanupSemanticScore_</span><span class="s1">(</span><span class="s2">equality1</span><span class="s1">, </span><span class="s2">edit</span><span class="s1">) +</span>
        <span class="s2">diff_cleanupSemanticScore_</span><span class="s1">(</span><span class="s2">edit</span><span class="s1">, </span><span class="s2">equality2</span><span class="s1">);</span>

      <span class="s3">while </span><span class="s1">(</span><span class="s2">edit</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s4">0</span><span class="s1">) === </span><span class="s2">equality2</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s4">0</span><span class="s1">)) {</span>
        <span class="s2">equality1 </span><span class="s1">+= </span><span class="s2">edit</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s4">0</span><span class="s1">);</span>
        <span class="s2">edit </span><span class="s1">= </span><span class="s2">edit</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">1</span><span class="s1">) + </span><span class="s2">equality2</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">(</span><span class="s4">0</span><span class="s1">);</span>
        <span class="s2">equality2 </span><span class="s1">= </span><span class="s2">equality2</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">1</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">score </span><span class="s1">=</span>
          <span class="s2">diff_cleanupSemanticScore_</span><span class="s1">(</span><span class="s2">equality1</span><span class="s1">, </span><span class="s2">edit</span><span class="s1">) +</span>
          <span class="s2">diff_cleanupSemanticScore_</span><span class="s1">(</span><span class="s2">edit</span><span class="s1">, </span><span class="s2">equality2</span><span class="s1">); </span><span class="s7">// The &gt;= encourages trailing rather than leading whitespace on edits.</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">score </span><span class="s1">&gt;= </span><span class="s2">bestScore</span><span class="s1">) {</span>
          <span class="s2">bestScore </span><span class="s1">= </span><span class="s2">score</span><span class="s1">;</span>
          <span class="s2">bestEquality1 </span><span class="s1">= </span><span class="s2">equality1</span><span class="s1">;</span>
          <span class="s2">bestEdit </span><span class="s1">= </span><span class="s2">edit</span><span class="s1">;</span>
          <span class="s2">bestEquality2 </span><span class="s1">= </span><span class="s2">equality2</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] != </span><span class="s2">bestEquality1</span><span class="s1">) {</span>
        <span class="s7">// We have an improvement, save it back to the diff.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">bestEquality1</span><span class="s1">) {</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">bestEquality1</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">);</span>
          <span class="s2">pointer</span><span class="s1">--;</span>
        <span class="s1">}</span>

        <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">bestEdit</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">bestEquality2</span><span class="s1">) {</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">bestEquality2</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">);</span>
          <span class="s2">pointer</span><span class="s1">--;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">pointer</span><span class="s1">++;</span>
  <span class="s1">}</span>
<span class="s1">}; </span><span class="s7">// Define some regex patterns for matching boundaries.</span>

<span class="s3">var </span><span class="s2">nonAlphaNumericRegex_ </span><span class="s1">= </span><span class="s8">/[^a-zA-Z0-9]/</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">whitespaceRegex_ </span><span class="s1">= </span><span class="s8">/\s/</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">linebreakRegex_ </span><span class="s1">= </span><span class="s8">/[\r\n]/</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">blanklineEndRegex_ </span><span class="s1">= </span><span class="s8">/\n\r?\n$/</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">blanklineStartRegex_ </span><span class="s1">= </span><span class="s8">/^\r?\n\r?\n/</span><span class="s1">;</span>
<span class="s5">/**</span>
 <span class="s5">* Reorder and merge like edit sections.  Merge equalities.</span>
 <span class="s5">* Any edit section can move as long as it doesn't cross an equality.</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{!Array.&lt;!diff_match_patch.Diff&gt;} diffs Array of diff tuples.</span>
 <span class="s5">*/</span>

<span class="s3">var </span><span class="s2">diff_cleanupMerge </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">) {</span>
  <span class="s7">// Add a dummy entry at the end.</span>
  <span class="s2">diffs</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Diff</span><span class="s1">(</span><span class="s2">DIFF_EQUAL</span><span class="s1">, </span><span class="s0">''</span><span class="s1">));</span>
  <span class="s3">var </span><span class="s2">pointer </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">count_delete </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">count_insert </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">text_delete </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">text_insert </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">commonlength</span><span class="s1">;</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">&lt; </span><span class="s2">diffs</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
    <span class="s3">switch </span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]) {</span>
      <span class="s3">case </span><span class="s2">DIFF_INSERT</span><span class="s1">:</span>
        <span class="s2">count_insert</span><span class="s1">++;</span>
        <span class="s2">text_insert </span><span class="s1">+= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s2">pointer</span><span class="s1">++;</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s2">DIFF_DELETE</span><span class="s1">:</span>
        <span class="s2">count_delete</span><span class="s1">++;</span>
        <span class="s2">text_delete </span><span class="s1">+= </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s2">pointer</span><span class="s1">++;</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s2">DIFF_EQUAL</span><span class="s1">:</span>
        <span class="s7">// Upon reaching an equality, check for prior redundancies.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">count_delete </span><span class="s1">+ </span><span class="s2">count_insert </span><span class="s1">&gt; </span><span class="s4">1</span><span class="s1">) {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">count_delete </span><span class="s1">!== </span><span class="s4">0 </span><span class="s1">&amp;&amp; </span><span class="s2">count_insert </span><span class="s1">!== </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s7">// Factor out any common prefixies.</span>
            <span class="s2">commonlength </span><span class="s1">= </span><span class="s2">diff_commonPrefix</span><span class="s1">(</span><span class="s2">text_insert</span><span class="s1">, </span><span class="s2">text_delete</span><span class="s1">);</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">commonlength </span><span class="s1">!== </span><span class="s4">0</span><span class="s1">) {</span>
              <span class="s3">if </span><span class="s1">(</span>
                <span class="s2">pointer </span><span class="s1">- </span><span class="s2">count_delete </span><span class="s1">- </span><span class="s2">count_insert </span><span class="s1">&gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp;</span>
                <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s2">count_delete </span><span class="s1">- </span><span class="s2">count_insert </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] ==</span>
                  <span class="s2">DIFF_EQUAL</span>
              <span class="s1">) {</span>
                <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s2">count_delete </span><span class="s1">- </span><span class="s2">count_insert </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] +=</span>
                  <span class="s2">text_insert</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">commonlength</span><span class="s1">);</span>
              <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span>
                  <span class="s4">0</span><span class="s1">,</span>
                  <span class="s4">0</span><span class="s1">,</span>
                  <span class="s3">new </span><span class="s2">Diff</span><span class="s1">(</span><span class="s2">DIFF_EQUAL</span><span class="s1">, </span><span class="s2">text_insert</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">commonlength</span><span class="s1">))</span>
                <span class="s1">);</span>
                <span class="s2">pointer</span><span class="s1">++;</span>
              <span class="s1">}</span>

              <span class="s2">text_insert </span><span class="s1">= </span><span class="s2">text_insert</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">commonlength</span><span class="s1">);</span>
              <span class="s2">text_delete </span><span class="s1">= </span><span class="s2">text_delete</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">commonlength</span><span class="s1">);</span>
            <span class="s1">} </span><span class="s7">// Factor out any common suffixies.</span>

            <span class="s2">commonlength </span><span class="s1">= </span><span class="s2">diff_commonSuffix</span><span class="s1">(</span><span class="s2">text_insert</span><span class="s1">, </span><span class="s2">text_delete</span><span class="s1">);</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">commonlength </span><span class="s1">!== </span><span class="s4">0</span><span class="s1">) {</span>
              <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] =</span>
                <span class="s2">text_insert</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">text_insert</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">commonlength</span><span class="s1">) +</span>
                <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
              <span class="s2">text_insert </span><span class="s1">= </span><span class="s2">text_insert</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span>
                <span class="s4">0</span><span class="s1">,</span>
                <span class="s2">text_insert</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">commonlength</span>
              <span class="s1">);</span>
              <span class="s2">text_delete </span><span class="s1">= </span><span class="s2">text_delete</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span>
                <span class="s4">0</span><span class="s1">,</span>
                <span class="s2">text_delete</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">commonlength</span>
              <span class="s1">);</span>
            <span class="s1">}</span>
          <span class="s1">} </span><span class="s7">// Delete the offending records and add the merged ones.</span>

          <span class="s2">pointer </span><span class="s1">-= </span><span class="s2">count_delete </span><span class="s1">+ </span><span class="s2">count_insert</span><span class="s1">;</span>
          <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">pointer</span><span class="s1">, </span><span class="s2">count_delete </span><span class="s1">+ </span><span class="s2">count_insert</span><span class="s1">);</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">text_delete</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">pointer</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s3">new </span><span class="s2">Diff</span><span class="s1">(</span><span class="s2">DIFF_DELETE</span><span class="s1">, </span><span class="s2">text_delete</span><span class="s1">));</span>
            <span class="s2">pointer</span><span class="s1">++;</span>
          <span class="s1">}</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">text_insert</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">pointer</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s3">new </span><span class="s2">Diff</span><span class="s1">(</span><span class="s2">DIFF_INSERT</span><span class="s1">, </span><span class="s2">text_insert</span><span class="s1">));</span>
            <span class="s2">pointer</span><span class="s1">++;</span>
          <span class="s1">}</span>

          <span class="s2">pointer</span><span class="s1">++;</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">!== </span><span class="s4">0 </span><span class="s1">&amp;&amp; </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">DIFF_EQUAL</span><span class="s1">) {</span>
          <span class="s7">// Merge this equality with the previous one.</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
          <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">pointer</span><span class="s1">, </span><span class="s4">1</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">pointer</span><span class="s1">++;</span>
        <span class="s1">}</span>

        <span class="s2">count_insert </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s2">count_delete </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s2">text_delete </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
        <span class="s2">text_insert </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
        <span class="s3">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">diffs</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] === </span><span class="s0">''</span><span class="s1">) {</span>
    <span class="s2">diffs</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">(); </span><span class="s7">// Remove the dummy entry at the end.</span>
  <span class="s1">} </span><span class="s7">// Second pass: look for single edits surrounded on both sides by equalities</span>
  <span class="s7">// which can be shifted sideways to eliminate an equality.</span>
  <span class="s7">// e.g: A&lt;ins&gt;BA&lt;/ins&gt;C -&gt; &lt;ins&gt;AB&lt;/ins&gt;AC</span>

  <span class="s3">var </span><span class="s2">changes </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s2">pointer </span><span class="s1">= </span><span class="s4">1</span><span class="s1">; </span><span class="s7">// Intentionally ignore the first and last element (don't need checking).</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">&lt; </span><span class="s2">diffs</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">DIFF_EQUAL </span><span class="s1">&amp;&amp;</span>
      <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">DIFF_EQUAL</span>
    <span class="s1">) {</span>
      <span class="s7">// This is a single edit surrounded by equalities.</span>
      <span class="s3">if </span><span class="s1">(</span>
        <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">substring</span><span class="s1">(</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">length </span><span class="s1">- </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">length</span>
        <span class="s1">) == </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span>
      <span class="s1">) {</span>
        <span class="s7">// Shift the edit over the previous equality.</span>
        <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] =</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] +</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">substring</span><span class="s1">(</span>
            <span class="s4">0</span><span class="s1">,</span>
            <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">length </span><span class="s1">- </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">length</span>
          <span class="s1">);</span>
        <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] + </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">);</span>
        <span class="s2">changes </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span>
        <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">length</span><span class="s1">) ==</span>
        <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span>
      <span class="s1">) {</span>
        <span class="s7">// Shift the edit over the next equality.</span>
        <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">- </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] =</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">substring</span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">].</span><span class="s2">length</span><span class="s1">) +</span>
          <span class="s2">diffs</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s2">diffs</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">);</span>
        <span class="s2">changes </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">pointer</span><span class="s1">++;</span>
  <span class="s1">} </span><span class="s7">// If shifts were made, the diff needs reordering and another shift sweep.</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">changes</span><span class="s1">) {</span>
    <span class="s2">diff_cleanupMerge</span><span class="s1">(</span><span class="s2">diffs</span><span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">};</span>
</pre>
</body>
</html>