<html>
<head>
<title>command.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #67a37c; font-style: italic;}
.s7 { color: #42c3d4;}
.s8 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
command.js</font>
</center></td></tr></table>
<pre><span class="s0">const </span><span class="s1">EventEmitter </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'events'</span><span class="s2">).</span><span class="s1">EventEmitter</span><span class="s2">;</span>
<span class="s0">const </span><span class="s1">childProcess </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'child_process'</span><span class="s2">);</span>
<span class="s0">const </span><span class="s1">path </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'path'</span><span class="s2">);</span>
<span class="s0">const </span><span class="s1">fs </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'fs'</span><span class="s2">);</span>

<span class="s0">const </span><span class="s2">{ </span><span class="s1">Argument</span><span class="s2">, </span><span class="s1">humanReadableArgName </span><span class="s2">} = </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./argument.js'</span><span class="s2">);</span>
<span class="s0">const </span><span class="s2">{ </span><span class="s1">CommanderError </span><span class="s2">} = </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./error.js'</span><span class="s2">);</span>
<span class="s0">const </span><span class="s2">{ </span><span class="s1">Help </span><span class="s2">} = </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./help.js'</span><span class="s2">);</span>
<span class="s0">const </span><span class="s2">{ </span><span class="s1">Option</span><span class="s2">, </span><span class="s1">splitOptionFlags </span><span class="s2">} = </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./option.js'</span><span class="s2">);</span>
<span class="s0">const </span><span class="s2">{ </span><span class="s1">suggestSimilar </span><span class="s2">} = </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./suggestSimilar'</span><span class="s2">);</span>

<span class="s4">// @ts-check</span>

<span class="s0">class </span><span class="s1">Command </span><span class="s0">extends </span><span class="s1">EventEmitter </span><span class="s2">{</span>
  <span class="s5">/**</span>
   <span class="s5">* Initialize a new `Command`.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [name]</span>
   <span class="s5">*/</span>

  <span class="s1">constructor</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
    <span class="s0">super</span><span class="s2">();</span>
    <span class="s5">/** </span><span class="s6">@type </span><span class="s5">{Command[]} */</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">commands </span><span class="s2">= [];</span>
    <span class="s5">/** </span><span class="s6">@type </span><span class="s5">{Option[]} */</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">options </span><span class="s2">= [];</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_allowUnknownOption </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_allowExcessArguments </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s5">/** </span><span class="s6">@type </span><span class="s5">{Argument[]} */</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_args </span><span class="s2">= [];</span>
    <span class="s5">/** </span><span class="s6">@type </span><span class="s5">{string[]} */</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">args </span><span class="s2">= []; </span><span class="s4">// cli args with options removed</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">rawArgs </span><span class="s2">= [];</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">processedArgs </span><span class="s2">= []; </span><span class="s4">// like .args but after custom processing and collecting variadic</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_scriptPath </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_name </span><span class="s2">= </span><span class="s1">name </span><span class="s2">|| </span><span class="s3">''</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_optionValues </span><span class="s2">= {};</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_optionValueSources </span><span class="s2">= {}; </span><span class="s4">// default &lt; config &lt; env &lt; cli</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_storeOptionsAsProperties </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_actionHandler </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_executableHandler </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_executableFile </span><span class="s2">= </span><span class="s0">null</span><span class="s2">; </span><span class="s4">// custom name for executable</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_defaultCommandName </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_exitCallback </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_aliases </span><span class="s2">= [];</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_combineFlagAndOptionalValue </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_description </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_argsDescription </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">; </span><span class="s4">// legacy</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_enablePositionalOptions </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_passThroughOptions </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_lifeCycleHooks </span><span class="s2">= {}; </span><span class="s4">// a hash of arrays</span>
    <span class="s5">/** </span><span class="s6">@type </span><span class="s5">{boolean | string} */</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_showHelpAfterError </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_showSuggestionAfterError </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>

    <span class="s4">// see .configureOutput() for docs</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration </span><span class="s2">= {</span>
      <span class="s1">writeOut</span><span class="s2">: (</span><span class="s1">str</span><span class="s2">) =&gt; </span><span class="s1">process</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">str</span><span class="s2">),</span>
      <span class="s1">writeErr</span><span class="s2">: (</span><span class="s1">str</span><span class="s2">) =&gt; </span><span class="s1">process</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">str</span><span class="s2">),</span>
      <span class="s1">getOutHelpWidth</span><span class="s2">: () =&gt; </span><span class="s1">process</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">isTTY </span><span class="s2">? </span><span class="s1">process</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">: </span><span class="s1">undefined</span><span class="s2">,</span>
      <span class="s1">getErrHelpWidth</span><span class="s2">: () =&gt; </span><span class="s1">process</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">isTTY </span><span class="s2">? </span><span class="s1">process</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">: </span><span class="s1">undefined</span><span class="s2">,</span>
      <span class="s1">outputError</span><span class="s2">: (</span><span class="s1">str</span><span class="s2">, </span><span class="s1">write</span><span class="s2">) =&gt; </span><span class="s1">write</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)</span>
    <span class="s2">};</span>

    <span class="s0">this</span><span class="s2">.</span><span class="s1">_hidden </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_hasHelpOption </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpFlags </span><span class="s2">= </span><span class="s3">'-h, --help'</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpDescription </span><span class="s2">= </span><span class="s3">'display help for command'</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpShortFlag </span><span class="s2">= </span><span class="s3">'-h'</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpLongFlag </span><span class="s2">= </span><span class="s3">'--help'</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_addImplicitHelpCommand </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">; </span><span class="s4">// Deliberately undefined, not decided whether true or false</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandName </span><span class="s2">= </span><span class="s3">'help'</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandnameAndArgs </span><span class="s2">= </span><span class="s3">'help [command]'</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandDescription </span><span class="s2">= </span><span class="s3">'display help for command'</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpConfiguration </span><span class="s2">= {};</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Copy settings that are useful to have in common across root command and subcommands.</span>
   <span class="s5">*</span>
   <span class="s5">* (Used internally when adding a command using `.command()` so subcommands inherit parent settings.)</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Command} sourceCommand</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} returns `this` for executable command</span>
   <span class="s5">*/</span>
  <span class="s1">copyInheritedSettings</span><span class="s2">(</span><span class="s1">sourceCommand</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_hasHelpOption </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_hasHelpOption</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpFlags </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_helpFlags</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpDescription </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_helpDescription</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpShortFlag </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_helpShortFlag</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpLongFlag </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_helpLongFlag</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandName </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_helpCommandName</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandnameAndArgs </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_helpCommandnameAndArgs</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandDescription </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_helpCommandDescription</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpConfiguration </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_helpConfiguration</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_exitCallback </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_exitCallback</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_storeOptionsAsProperties </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_storeOptionsAsProperties</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_combineFlagAndOptionalValue </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_combineFlagAndOptionalValue</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_allowExcessArguments </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_allowExcessArguments</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_enablePositionalOptions </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_enablePositionalOptions</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_showHelpAfterError </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_showHelpAfterError</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_showSuggestionAfterError </span><span class="s2">= </span><span class="s1">sourceCommand</span><span class="s2">.</span><span class="s1">_showSuggestionAfterError</span><span class="s2">;</span>

    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Define a command.</span>
   <span class="s5">*</span>
   <span class="s5">* There are two styles of command: pay attention to where to put the description.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@example</span>
   <span class="s5">* // Command implemented using action handler (description is supplied separately to `.command`)</span>
   <span class="s5">* program</span>
   <span class="s5">*   .command('clone &lt;source&gt; [destination]')</span>
   <span class="s5">*   .description('clone a repository into a newly created directory')</span>
   <span class="s5">*   .action((source, destination) =&gt; {</span>
   <span class="s5">*     console.log('clone command called');</span>
   <span class="s5">*   });</span>
   <span class="s5">*</span>
   <span class="s5">* // Command implemented using separate executable file (description is second parameter to `.command`)</span>
   <span class="s5">* program</span>
   <span class="s5">*   .command('start &lt;service&gt;', 'start named service')</span>
   <span class="s5">*   .command('stop [service]', 'stop named service, or all if no name supplied');</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} nameAndArgs - command name and arguments, args are `&lt;required&gt;` or `[optional]` and last may also be `variadic...`</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|string} [actionOptsOrExecDesc] - configuration options (for action), or description (for executable)</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [execOpts] - configuration options (for executable)</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} returns new command for action handler, or `this` for executable command</span>
   <span class="s5">*/</span>

  <span class="s1">command</span><span class="s2">(</span><span class="s1">nameAndArgs</span><span class="s2">, </span><span class="s1">actionOptsOrExecDesc</span><span class="s2">, </span><span class="s1">execOpts</span><span class="s2">) {</span>
    <span class="s0">let </span><span class="s1">desc </span><span class="s2">= </span><span class="s1">actionOptsOrExecDesc</span><span class="s2">;</span>
    <span class="s0">let </span><span class="s1">opts </span><span class="s2">= </span><span class="s1">execOpts</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">desc </span><span class="s2">=== </span><span class="s3">'object' </span><span class="s2">&amp;&amp; </span><span class="s1">desc </span><span class="s2">!== </span><span class="s0">null</span><span class="s2">) {</span>
      <span class="s1">opts </span><span class="s2">= </span><span class="s1">desc</span><span class="s2">;</span>
      <span class="s1">desc </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s1">opts </span><span class="s2">= </span><span class="s1">opts </span><span class="s2">|| {};</span>
    <span class="s0">const </span><span class="s2">[, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">args</span><span class="s2">] = </span><span class="s1">nameAndArgs</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s7">/([^ ]+) *(.*)/</span><span class="s2">);</span>

    <span class="s0">const </span><span class="s1">cmd </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">createCommand</span><span class="s2">(</span><span class="s1">name</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">desc</span><span class="s2">) {</span>
      <span class="s1">cmd</span><span class="s2">.</span><span class="s1">description</span><span class="s2">(</span><span class="s1">desc</span><span class="s2">);</span>
      <span class="s1">cmd</span><span class="s2">.</span><span class="s1">_executableHandler </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">isDefault</span><span class="s2">) </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_defaultCommandName </span><span class="s2">= </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">;</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">_hidden </span><span class="s2">= !!(</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">noHelp </span><span class="s2">|| </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">hidden</span><span class="s2">); </span><span class="s4">// noHelp is deprecated old name for hidden</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">_executableFile </span><span class="s2">= </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">executableFile </span><span class="s2">|| </span><span class="s0">null</span><span class="s2">; </span><span class="s4">// Custom name for executable file, set missing to null to match constructor</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">args</span><span class="s2">) </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">arguments</span><span class="s2">(</span><span class="s1">args</span><span class="s2">);</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">);</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">copyInheritedSettings</span><span class="s2">(</span><span class="s0">this</span><span class="s2">);</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">desc</span><span class="s2">) </span><span class="s0">return this</span><span class="s2">;</span>
    <span class="s0">return </span><span class="s1">cmd</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Factory routine to create a new unattached command.</span>
   <span class="s5">*</span>
   <span class="s5">* See .command() for creating an attached subcommand, which uses this routine to</span>
   <span class="s5">* create the command. You can override createCommand to customise subcommands.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [name]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} new command</span>
   <span class="s5">*/</span>

  <span class="s1">createCommand</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
    <span class="s0">return new </span><span class="s1">Command</span><span class="s2">(</span><span class="s1">name</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* You can customise the help with a subclass of Help by overriding createHelp,</span>
   <span class="s5">* or by overriding Help properties using configureHelp().</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Help}</span>
   <span class="s5">*/</span>

  <span class="s1">createHelp</span><span class="s2">() {</span>
    <span class="s0">return </span><span class="s1">Object</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s0">new </span><span class="s1">Help</span><span class="s2">(), </span><span class="s0">this</span><span class="s2">.</span><span class="s1">configureHelp</span><span class="s2">());</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* You can customise the help by overriding Help properties using configureHelp(),</span>
   <span class="s5">* or with a subclass of Help by overriding createHelp().</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [configuration] - configuration options</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command|Object} `this` command for chaining, or stored configuration</span>
   <span class="s5">*/</span>

  <span class="s1">configureHelp</span><span class="s2">(</span><span class="s1">configuration</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">configuration </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">_helpConfiguration</span><span class="s2">;</span>

    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpConfiguration </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* The default output goes to stdout and stderr. You can customise this for special</span>
   <span class="s5">* applications. You can also customise the display of errors by overriding outputError.</span>
   <span class="s5">*</span>
   <span class="s5">* The configuration properties are all functions:</span>
   <span class="s5">*</span>
   <span class="s5">*     // functions to change where being written, stdout and stderr</span>
   <span class="s5">*     writeOut(str)</span>
   <span class="s5">*     writeErr(str)</span>
   <span class="s5">*     // matching functions to specify width for wrapping help</span>
   <span class="s5">*     getOutHelpWidth()</span>
   <span class="s5">*     getErrHelpWidth()</span>
   <span class="s5">*     // functions based on what is being written out</span>
   <span class="s5">*     outputError(str, write) // used for displaying errors, and not used for displaying help</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [configuration] - configuration options</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command|Object} `this` command for chaining, or stored configuration</span>
   <span class="s5">*/</span>

  <span class="s1">configureOutput</span><span class="s2">(</span><span class="s1">configuration</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">configuration </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">;</span>

    <span class="s1">Object</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">, </span><span class="s1">configuration</span><span class="s2">);</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Display the help or a custom message after an error occurs.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{boolean|string} [displayHelp]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>
  <span class="s1">showHelpAfterError</span><span class="s2">(</span><span class="s1">displayHelp </span><span class="s2">= </span><span class="s0">true</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">displayHelp </span><span class="s2">!== </span><span class="s3">'string'</span><span class="s2">) </span><span class="s1">displayHelp </span><span class="s2">= !!</span><span class="s1">displayHelp</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_showHelpAfterError </span><span class="s2">= </span><span class="s1">displayHelp</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Display suggestion of similar commands for unknown commands, or options for unknown options.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{boolean} [displaySuggestion]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>
  <span class="s1">showSuggestionAfterError</span><span class="s2">(</span><span class="s1">displaySuggestion </span><span class="s2">= </span><span class="s0">true</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_showSuggestionAfterError </span><span class="s2">= !!</span><span class="s1">displaySuggestion</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Add a prepared subcommand.</span>
   <span class="s5">*</span>
   <span class="s5">* See .command() for creating an attached subcommand which inherits settings from its parent.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Command} cmd - new subcommand</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [opts] - configuration options</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">addCommand</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">) </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'Command passed to .addCommand() must have a name'</span><span class="s2">);</span>

    <span class="s4">// To keep things simple, block automatic name generation for deeply nested executables.</span>
    <span class="s4">// Fail fast and detect when adding rather than later when parsing.</span>
    <span class="s0">function </span><span class="s1">checkExplicitNames</span><span class="s2">(</span><span class="s1">commandArray</span><span class="s2">) {</span>
      <span class="s1">commandArray</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">cmd</span><span class="s2">) =&gt; {</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_executableHandler </span><span class="s2">&amp;&amp; !</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_executableFile</span><span class="s2">) {</span>
          <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">`Must specify executableFile for deeply nested executable: </span><span class="s1">$</span><span class="s2">{</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">);</span>
        <span class="s2">}</span>
        <span class="s1">checkExplicitNames</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">);</span>
      <span class="s2">});</span>
    <span class="s2">}</span>
    <span class="s1">checkExplicitNames</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">);</span>

    <span class="s1">opts </span><span class="s2">= </span><span class="s1">opts </span><span class="s2">|| {};</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">isDefault</span><span class="s2">) </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_defaultCommandName </span><span class="s2">= </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">noHelp </span><span class="s2">|| </span><span class="s1">opts</span><span class="s2">.</span><span class="s1">hidden</span><span class="s2">) </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_hidden </span><span class="s2">= </span><span class="s0">true</span><span class="s2">; </span><span class="s4">// modifying passed command due to existing implementation</span>

    <span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">);</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Factory routine to create a new unattached argument.</span>
   <span class="s5">*</span>
   <span class="s5">* See .argument() for creating an attached argument, which uses this routine to</span>
   <span class="s5">* create the argument. You can override createArgument to return a custom argument.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} name</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [description]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Argument} new argument</span>
   <span class="s5">*/</span>

  <span class="s1">createArgument</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">description</span><span class="s2">) {</span>
    <span class="s0">return new </span><span class="s1">Argument</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">description</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Define argument syntax for command.</span>
   <span class="s5">*</span>
   <span class="s5">* The default is that the argument is required, and you can explicitly</span>
   <span class="s5">* indicate this with &lt;&gt; around the name. Put [] around the name for an optional argument.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@example</span>
   <span class="s5">* program.argument('&lt;input-file&gt;');</span>
   <span class="s5">* program.argument('[output-file]');</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} name</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [description]</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function|*} [fn] - custom argument processing function</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{*} [defaultValue]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>
  <span class="s1">argument</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">defaultValue</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">argument </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">createArgument</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">description</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">fn </span><span class="s2">=== </span><span class="s3">'function'</span><span class="s2">) {</span>
      <span class="s1">argument</span><span class="s2">.</span><span class="s1">default</span><span class="s2">(</span><span class="s1">defaultValue</span><span class="s2">).</span><span class="s1">argParser</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s1">argument</span><span class="s2">.</span><span class="s1">default</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">addArgument</span><span class="s2">(</span><span class="s1">argument</span><span class="s2">);</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Define argument syntax for command, adding multiple at once (without descriptions).</span>
   <span class="s5">*</span>
   <span class="s5">* See also .argument().</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@example</span>
   <span class="s5">* program.arguments('&lt;cmd&gt; [env]');</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} names</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">arguments</span><span class="s2">(</span><span class="s1">names</span><span class="s2">) {</span>
    <span class="s1">names</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s7">/ +/</span><span class="s2">).</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">detail</span><span class="s2">) =&gt; {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">argument</span><span class="s2">(</span><span class="s1">detail</span><span class="s2">);</span>
    <span class="s2">});</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Define argument syntax for command, adding a prepared argument.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Argument} argument</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>
  <span class="s1">addArgument</span><span class="s2">(</span><span class="s1">argument</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">previousArgument </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(-</span><span class="s8">1</span><span class="s2">)[</span><span class="s8">0</span><span class="s2">];</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">previousArgument </span><span class="s2">&amp;&amp; </span><span class="s1">previousArgument</span><span class="s2">.</span><span class="s1">variadic</span><span class="s2">) {</span>
      <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">`only the last argument can be variadic '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">previousArgument</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">'`</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">argument</span><span class="s2">.</span><span class="s1">required </span><span class="s2">&amp;&amp; </span><span class="s1">argument</span><span class="s2">.</span><span class="s1">defaultValue </span><span class="s2">!== </span><span class="s1">undefined </span><span class="s2">&amp;&amp; </span><span class="s1">argument</span><span class="s2">.</span><span class="s1">parseArg </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) {</span>
      <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">`a default value for a required argument is never used: '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">argument</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">'`</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">argument</span><span class="s2">);</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Override default decision whether to add implicit help command.</span>
   <span class="s5">*</span>
   <span class="s5">*    addHelpCommand() // force on</span>
   <span class="s5">*    addHelpCommand(false); // force off</span>
   <span class="s5">*    addHelpCommand('help [cmd]', 'display help for [cmd]'); // force on with custom details</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">addHelpCommand</span><span class="s2">(</span><span class="s1">enableOrNameAndArgs</span><span class="s2">, </span><span class="s1">description</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">enableOrNameAndArgs </span><span class="s2">=== </span><span class="s0">false</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_addImplicitHelpCommand </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_addImplicitHelpCommand </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">enableOrNameAndArgs </span><span class="s2">=== </span><span class="s3">'string'</span><span class="s2">) {</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandName </span><span class="s2">= </span><span class="s1">enableOrNameAndArgs</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">)[</span><span class="s8">0</span><span class="s2">];</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandnameAndArgs </span><span class="s2">= </span><span class="s1">enableOrNameAndArgs</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandDescription </span><span class="s2">= </span><span class="s1">description </span><span class="s2">|| </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandDescription</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{boolean}</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_hasImplicitHelpCommand</span><span class="s2">() {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_addImplicitHelpCommand </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) {</span>
      <span class="s0">return this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&amp;&amp; !</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_actionHandler </span><span class="s2">&amp;&amp; !</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_findCommand</span><span class="s2">(</span><span class="s3">'help'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">return this</span><span class="s2">.</span><span class="s1">_addImplicitHelpCommand</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Add hook for life cycle event.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} event</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} listener</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">hook</span><span class="s2">(</span><span class="s1">event</span><span class="s2">, </span><span class="s1">listener</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">allowedValues </span><span class="s2">= [</span><span class="s3">'preAction'</span><span class="s2">, </span><span class="s3">'postAction'</span><span class="s2">];</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">allowedValues</span><span class="s2">.</span><span class="s1">includes</span><span class="s2">(</span><span class="s1">event</span><span class="s2">)) {</span>
      <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">`Unexpected value for event passed to hook : '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">event</span><span class="s2">}</span><span class="s3">'. 
Expecting one of '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">allowedValues</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">&quot;', '&quot;</span><span class="s2">)}</span><span class="s3">'`</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_lifeCycleHooks</span><span class="s2">[</span><span class="s1">event</span><span class="s2">]) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_lifeCycleHooks</span><span class="s2">[</span><span class="s1">event</span><span class="s2">].</span><span class="s1">push</span><span class="s2">(</span><span class="s1">listener</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_lifeCycleHooks</span><span class="s2">[</span><span class="s1">event</span><span class="s2">] = [</span><span class="s1">listener</span><span class="s2">];</span>
    <span class="s2">}</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Register callback to use as replacement for calling process.exit.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} [fn] optional callback which will be passed a CommanderError, defaults to throwing</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">exitOverride</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">fn</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_exitCallback </span><span class="s2">= </span><span class="s1">fn</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_exitCallback </span><span class="s2">= (</span><span class="s1">err</span><span class="s2">) =&gt; {</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">code </span><span class="s2">!== </span><span class="s3">'commander.executeSubCommandAsync'</span><span class="s2">) {</span>
          <span class="s0">throw </span><span class="s1">err</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
          <span class="s4">// Async callback from spawn events, not useful to throw.</span>
        <span class="s2">}</span>
      <span class="s2">};</span>
    <span class="s2">}</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Call process.exit, and _exitCallback if defined.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{number} exitCode exit code for using with process.exit</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} code an id string representing the error</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} message human-readable description of the error</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">never</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_exit</span><span class="s2">(</span><span class="s1">exitCode</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">message</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_exitCallback</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_exitCallback</span><span class="s2">(</span><span class="s0">new </span><span class="s1">CommanderError</span><span class="s2">(</span><span class="s1">exitCode</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">message</span><span class="s2">));</span>
      <span class="s4">// Expecting this line is not reached.</span>
    <span class="s2">}</span>
    <span class="s1">process</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s1">exitCode</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Register callback `fn` for the command.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@example</span>
   <span class="s5">* program</span>
   <span class="s5">*   .command('serve')</span>
   <span class="s5">*   .description('start service')</span>
   <span class="s5">*   .action(function() {</span>
   <span class="s5">*      // do work here</span>
   <span class="s5">*   });</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} fn</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">action</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">listener </span><span class="s2">= (</span><span class="s1">args</span><span class="s2">) =&gt; {</span>
      <span class="s4">// The .action callback takes an extra parameter which is the command or options.</span>
      <span class="s0">const </span><span class="s1">expectedArgsCount </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
      <span class="s0">const </span><span class="s1">actionArgs </span><span class="s2">= </span><span class="s1">args</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s8">0</span><span class="s2">, </span><span class="s1">expectedArgsCount</span><span class="s2">);</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_storeOptionsAsProperties</span><span class="s2">) {</span>
        <span class="s1">actionArgs</span><span class="s2">[</span><span class="s1">expectedArgsCount</span><span class="s2">] = </span><span class="s0">this</span><span class="s2">; </span><span class="s4">// backwards compatible &quot;options&quot;</span>
      <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
        <span class="s1">actionArgs</span><span class="s2">[</span><span class="s1">expectedArgsCount</span><span class="s2">] = </span><span class="s0">this</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">();</span>
      <span class="s2">}</span>
      <span class="s1">actionArgs</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s0">this</span><span class="s2">);</span>

      <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, </span><span class="s1">actionArgs</span><span class="s2">);</span>
    <span class="s2">};</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_actionHandler </span><span class="s2">= </span><span class="s1">listener</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Factory routine to create a new unattached option.</span>
   <span class="s5">*</span>
   <span class="s5">* See .option() for creating an attached option, which uses this routine to</span>
   <span class="s5">* create the option. You can override createOption to return a custom option.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} flags</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [description]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Option} new option</span>
   <span class="s5">*/</span>

  <span class="s1">createOption</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">) {</span>
    <span class="s0">return new </span><span class="s1">Option</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Add an option.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Option} option</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>
  <span class="s1">addOption</span><span class="s2">(</span><span class="s1">option</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">oname </span><span class="s2">= </span><span class="s1">option</span><span class="s2">.</span><span class="s1">name</span><span class="s2">();</span>
    <span class="s0">const </span><span class="s1">name </span><span class="s2">= </span><span class="s1">option</span><span class="s2">.</span><span class="s1">attributeName</span><span class="s2">();</span>

    <span class="s0">let </span><span class="s1">defaultValue </span><span class="s2">= </span><span class="s1">option</span><span class="s2">.</span><span class="s1">defaultValue</span><span class="s2">;</span>

    <span class="s4">// preassign default value for --no-*, [optional], &lt;required&gt;, or plain flag if boolean value</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">.</span><span class="s1">negate </span><span class="s2">|| </span><span class="s1">option</span><span class="s2">.</span><span class="s1">optional </span><span class="s2">|| </span><span class="s1">option</span><span class="s2">.</span><span class="s1">required </span><span class="s2">|| </span><span class="s0">typeof </span><span class="s1">defaultValue </span><span class="s2">=== </span><span class="s3">'boolean'</span><span class="s2">) {</span>
      <span class="s4">// when --no-foo we make sure default is true, unless a --foo option is already defined</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">.</span><span class="s1">negate</span><span class="s2">) {</span>
        <span class="s0">const </span><span class="s1">positiveLongFlag </span><span class="s2">= </span><span class="s1">option</span><span class="s2">.</span><span class="s1">long</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s7">/^--no-/</span><span class="s2">, </span><span class="s3">'--'</span><span class="s2">);</span>
        <span class="s1">defaultValue </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_findOption</span><span class="s2">(</span><span class="s1">positiveLongFlag</span><span class="s2">) ? </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getOptionValue</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) : </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s4">// preassign only if we have a default</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">defaultValue </span><span class="s2">!== </span><span class="s1">undefined</span><span class="s2">) {</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">setOptionValueWithSource</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">defaultValue</span><span class="s2">, </span><span class="s3">'default'</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s4">// register the option</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">options</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">option</span><span class="s2">);</span>

    <span class="s4">// handler for cli and env supplied values</span>
    <span class="s0">const </span><span class="s1">handleOptionValue </span><span class="s2">= (</span><span class="s1">val</span><span class="s2">, </span><span class="s1">invalidValueMessage</span><span class="s2">, </span><span class="s1">valueSource</span><span class="s2">) =&gt; {</span>
      <span class="s4">// Note: using closure to access lots of lexical scoped variables.</span>
      <span class="s0">const </span><span class="s1">oldValue </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getOptionValue</span><span class="s2">(</span><span class="s1">name</span><span class="s2">);</span>

      <span class="s4">// custom processing</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">val </span><span class="s2">!== </span><span class="s0">null </span><span class="s2">&amp;&amp; </span><span class="s1">option</span><span class="s2">.</span><span class="s1">parseArg</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
          <span class="s1">val </span><span class="s2">= </span><span class="s1">option</span><span class="s2">.</span><span class="s1">parseArg</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">oldValue </span><span class="s2">=== </span><span class="s1">undefined </span><span class="s2">? </span><span class="s1">defaultValue </span><span class="s2">: </span><span class="s1">oldValue</span><span class="s2">);</span>
        <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
          <span class="s0">if </span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">code </span><span class="s2">=== </span><span class="s3">'commander.invalidArgument'</span><span class="s2">) {</span>
            <span class="s0">const </span><span class="s1">message </span><span class="s2">= </span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">invalidValueMessage</span><span class="s2">} </span><span class="s1">$</span><span class="s2">{</span><span class="s1">err</span><span class="s2">.</span><span class="s1">message</span><span class="s2">}</span><span class="s3">`</span><span class="s2">;</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">_displayError</span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">exitCode</span><span class="s2">, </span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s1">message</span><span class="s2">);</span>
          <span class="s2">}</span>
          <span class="s0">throw </span><span class="s1">err</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">val </span><span class="s2">!== </span><span class="s0">null </span><span class="s2">&amp;&amp; </span><span class="s1">option</span><span class="s2">.</span><span class="s1">variadic</span><span class="s2">) {</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">option</span><span class="s2">.</span><span class="s1">_concatValue</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">oldValue</span><span class="s2">);</span>
      <span class="s2">}</span>

      <span class="s4">// unassigned or boolean value</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">oldValue </span><span class="s2">=== </span><span class="s3">'boolean' </span><span class="s2">|| </span><span class="s0">typeof </span><span class="s1">oldValue </span><span class="s2">=== </span><span class="s3">'undefined'</span><span class="s2">) {</span>
        <span class="s4">// if no value, negate false, and we have a default, then use it!</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">val </span><span class="s2">== </span><span class="s0">null</span><span class="s2">) {</span>
          <span class="s0">this</span><span class="s2">.</span><span class="s1">setOptionValueWithSource</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">option</span><span class="s2">.</span><span class="s1">negate </span><span class="s2">? </span><span class="s0">false </span><span class="s2">: </span><span class="s1">defaultValue </span><span class="s2">|| </span><span class="s0">true</span><span class="s2">, </span><span class="s1">valueSource</span><span class="s2">);</span>
        <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
          <span class="s0">this</span><span class="s2">.</span><span class="s1">setOptionValueWithSource</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">valueSource</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">val </span><span class="s2">!== </span><span class="s0">null</span><span class="s2">) {</span>
        <span class="s4">// reassign</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">setOptionValueWithSource</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">option</span><span class="s2">.</span><span class="s1">negate </span><span class="s2">? </span><span class="s0">false </span><span class="s2">: </span><span class="s1">val</span><span class="s2">, </span><span class="s1">valueSource</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">};</span>

    <span class="s0">this</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s3">'option:' </span><span class="s2">+ </span><span class="s1">oname</span><span class="s2">, (</span><span class="s1">val</span><span class="s2">) =&gt; {</span>
      <span class="s0">const </span><span class="s1">invalidValueMessage </span><span class="s2">= </span><span class="s3">`error: option '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">}</span><span class="s3">' argument '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">val</span><span class="s2">}</span><span class="s3">' is invalid.`</span><span class="s2">;</span>
      <span class="s1">handleOptionValue</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">invalidValueMessage</span><span class="s2">, </span><span class="s3">'cli'</span><span class="s2">);</span>
    <span class="s2">});</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">.</span><span class="s1">envVar</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s3">'optionEnv:' </span><span class="s2">+ </span><span class="s1">oname</span><span class="s2">, (</span><span class="s1">val</span><span class="s2">) =&gt; {</span>
        <span class="s0">const </span><span class="s1">invalidValueMessage </span><span class="s2">= </span><span class="s3">`error: option '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">}</span><span class="s3">' value '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">val</span><span class="s2">}</span><span class="s3">' from env '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">envVar</span><span class="s2">}</span><span class="s3">' is invalid.`</span><span class="s2">;</span>
        <span class="s1">handleOptionValue</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">invalidValueMessage</span><span class="s2">, </span><span class="s3">'env'</span><span class="s2">);</span>
      <span class="s2">});</span>
    <span class="s2">}</span>

    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Internal implementation shared by .option() and .requiredOption()</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>
  <span class="s1">_optionEx</span><span class="s2">(</span><span class="s1">config</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">defaultValue</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">option </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">createOption</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">);</span>
    <span class="s1">option</span><span class="s2">.</span><span class="s1">makeOptionMandatory</span><span class="s2">(!!</span><span class="s1">config</span><span class="s2">.</span><span class="s1">mandatory</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">fn </span><span class="s2">=== </span><span class="s3">'function'</span><span class="s2">) {</span>
      <span class="s1">option</span><span class="s2">.</span><span class="s1">default</span><span class="s2">(</span><span class="s1">defaultValue</span><span class="s2">).</span><span class="s1">argParser</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">fn </span><span class="s0">instanceof </span><span class="s1">RegExp</span><span class="s2">) {</span>
      <span class="s4">// deprecated</span>
      <span class="s0">const </span><span class="s1">regex </span><span class="s2">= </span><span class="s1">fn</span><span class="s2">;</span>
      <span class="s1">fn </span><span class="s2">= (</span><span class="s1">val</span><span class="s2">, </span><span class="s1">def</span><span class="s2">) =&gt; {</span>
        <span class="s0">const </span><span class="s1">m </span><span class="s2">= </span><span class="s1">regex</span><span class="s2">.</span><span class="s1">exec</span><span class="s2">(</span><span class="s1">val</span><span class="s2">);</span>
        <span class="s0">return </span><span class="s1">m </span><span class="s2">? </span><span class="s1">m</span><span class="s2">[</span><span class="s8">0</span><span class="s2">] : </span><span class="s1">def</span><span class="s2">;</span>
      <span class="s2">};</span>
      <span class="s1">option</span><span class="s2">.</span><span class="s1">default</span><span class="s2">(</span><span class="s1">defaultValue</span><span class="s2">).</span><span class="s1">argParser</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s1">option</span><span class="s2">.</span><span class="s1">default</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">return this</span><span class="s2">.</span><span class="s1">addOption</span><span class="s2">(</span><span class="s1">option</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Define option with `flags`, `description` and optional</span>
   <span class="s5">* coercion `fn`.</span>
   <span class="s5">*</span>
   <span class="s5">* The `flags` string contains the short and/or long flags,</span>
   <span class="s5">* separated by comma, a pipe or space. The following are all valid</span>
   <span class="s5">* all will output this way when `--help` is used.</span>
   <span class="s5">*</span>
   <span class="s5">*     &quot;-p, --pepper&quot;</span>
   <span class="s5">*     &quot;-p|--pepper&quot;</span>
   <span class="s5">*     &quot;-p --pepper&quot;</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@example</span>
   <span class="s5">* // simple boolean defaulting to undefined</span>
   <span class="s5">* program.option('-p, --pepper', 'add pepper');</span>
   <span class="s5">*</span>
   <span class="s5">* program.pepper</span>
   <span class="s5">* // =&gt; undefined</span>
   <span class="s5">*</span>
   <span class="s5">* --pepper</span>
   <span class="s5">* program.pepper</span>
   <span class="s5">* // =&gt; true</span>
   <span class="s5">*</span>
   <span class="s5">* // simple boolean defaulting to true (unless non-negated option is also defined)</span>
   <span class="s5">* program.option('-C, --no-cheese', 'remove cheese');</span>
   <span class="s5">*</span>
   <span class="s5">* program.cheese</span>
   <span class="s5">* // =&gt; true</span>
   <span class="s5">*</span>
   <span class="s5">* --no-cheese</span>
   <span class="s5">* program.cheese</span>
   <span class="s5">* // =&gt; false</span>
   <span class="s5">*</span>
   <span class="s5">* // required argument</span>
   <span class="s5">* program.option('-C, --chdir &lt;path&gt;', 'change the working directory');</span>
   <span class="s5">*</span>
   <span class="s5">* --chdir /tmp</span>
   <span class="s5">* program.chdir</span>
   <span class="s5">* // =&gt; &quot;/tmp&quot;</span>
   <span class="s5">*</span>
   <span class="s5">* // optional argument</span>
   <span class="s5">* program.option('-c, --cheese [type]', 'add cheese [marble]');</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} flags</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [description]</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function|*} [fn] - custom option processing function or default value</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{*} [defaultValue]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">option</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">defaultValue</span><span class="s2">) {</span>
    <span class="s0">return this</span><span class="s2">.</span><span class="s1">_optionEx</span><span class="s2">({}, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">defaultValue</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
  <span class="s5">* Add a required option which must have a value after parsing. This usually means</span>
  <span class="s5">* the option must be specified on the command line. (Otherwise the same as .option().)</span>
  <span class="s5">*</span>
  <span class="s5">* The `flags` string contains the short and/or long flags, separated by comma, a pipe or space.</span>
  <span class="s5">*</span>
  <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} flags</span>
  <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [description]</span>
  <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function|*} [fn] - custom option processing function or default value</span>
  <span class="s5">* </span><span class="s6">@param </span><span class="s5">{*} [defaultValue]</span>
  <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
  <span class="s5">*/</span>

  <span class="s1">requiredOption</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">defaultValue</span><span class="s2">) {</span>
    <span class="s0">return this</span><span class="s2">.</span><span class="s1">_optionEx</span><span class="s2">({ </span><span class="s1">mandatory</span><span class="s2">: </span><span class="s0">true </span><span class="s2">}, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">defaultValue</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Alter parsing of short flags with optional values.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@example</span>
   <span class="s5">* // for `.option('-f,--flag [value]'):</span>
   <span class="s5">* program.combineFlagAndOptionalValue(true);  // `-f80` is treated like `--flag=80`, this is the default behaviour</span>
   <span class="s5">* program.combineFlagAndOptionalValue(false) // `-fb` is treated like `-f -b`</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [combine=true] - if `true` or omitted, an optional value can be specified directly after the flag.</span>
   <span class="s5">*/</span>
  <span class="s1">combineFlagAndOptionalValue</span><span class="s2">(</span><span class="s1">combine </span><span class="s2">= </span><span class="s0">true</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_combineFlagAndOptionalValue </span><span class="s2">= !!</span><span class="s1">combine</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Allow unknown options on the command line.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [allowUnknown=true] - if `true` or omitted, no error will be thrown</span>
   <span class="s5">* for unknown options.</span>
   <span class="s5">*/</span>
  <span class="s1">allowUnknownOption</span><span class="s2">(</span><span class="s1">allowUnknown </span><span class="s2">= </span><span class="s0">true</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_allowUnknownOption </span><span class="s2">= !!</span><span class="s1">allowUnknown</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Allow excess command-arguments on the command line. Pass false to make excess arguments an error.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [allowExcess=true] - if `true` or omitted, no error will be thrown</span>
   <span class="s5">* for excess arguments.</span>
   <span class="s5">*/</span>
  <span class="s1">allowExcessArguments</span><span class="s2">(</span><span class="s1">allowExcess </span><span class="s2">= </span><span class="s0">true</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_allowExcessArguments </span><span class="s2">= !!</span><span class="s1">allowExcess</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Enable positional options. Positional means global options are specified before subcommands which lets</span>
   <span class="s5">* subcommands reuse the same option names, and also enables subcommands to turn on passThroughOptions.</span>
   <span class="s5">* The default behaviour is non-positional and global options may appear anywhere on the command line.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [positional=true]</span>
   <span class="s5">*/</span>
  <span class="s1">enablePositionalOptions</span><span class="s2">(</span><span class="s1">positional </span><span class="s2">= </span><span class="s0">true</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_enablePositionalOptions </span><span class="s2">= !!</span><span class="s1">positional</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Pass through options that come after command-arguments rather than treat them as command-options,</span>
   <span class="s5">* so actual command-options come before command-arguments. Turning this on for a subcommand requires</span>
   <span class="s5">* positional options to have been enabled on the program (parent commands).</span>
   <span class="s5">* The default behaviour is non-positional and options may appear before or after command-arguments.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [passThrough=true]</span>
   <span class="s5">* for unknown options.</span>
   <span class="s5">*/</span>
  <span class="s1">passThroughOptions</span><span class="s2">(</span><span class="s1">passThrough </span><span class="s2">= </span><span class="s0">true</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_passThroughOptions </span><span class="s2">= !!</span><span class="s1">passThrough</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(!!</span><span class="s0">this</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">&amp;&amp; </span><span class="s1">passThrough </span><span class="s2">&amp;&amp; !</span><span class="s0">this</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">_enablePositionalOptions</span><span class="s2">) {</span>
      <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'passThroughOptions can not be used without turning on enablePositionalOptions for parent command(s)'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
    <span class="s5">* Whether to store option values as properties on command object,</span>
    <span class="s5">* or store separately (specify false). In both cases the option values can be accessed using .opts().</span>
    <span class="s5">*</span>
    <span class="s5">* </span><span class="s6">@param </span><span class="s5">{boolean} [storeAsProperties=true]</span>
    <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
    <span class="s5">*/</span>

  <span class="s1">storeOptionsAsProperties</span><span class="s2">(</span><span class="s1">storeAsProperties </span><span class="s2">= </span><span class="s0">true</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_storeOptionsAsProperties </span><span class="s2">= !!</span><span class="s1">storeAsProperties</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">options</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
      <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'call .storeOptionsAsProperties() before adding options'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Retrieve option value.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} key</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object} value</span>
   <span class="s5">*/</span>

  <span class="s1">getOptionValue</span><span class="s2">(</span><span class="s1">key</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_storeOptionsAsProperties</span><span class="s2">) {</span>
      <span class="s0">return this</span><span class="s2">[</span><span class="s1">key</span><span class="s2">];</span>
    <span class="s2">}</span>
    <span class="s0">return this</span><span class="s2">.</span><span class="s1">_optionValues</span><span class="s2">[</span><span class="s1">key</span><span class="s2">];</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Store option value.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} key</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} value</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">setOptionValue</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_storeOptionsAsProperties</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">value</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_optionValues</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">value</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Store option value and where the value came from.</span>
    <span class="s5">*</span>
    <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} key</span>
    <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} value</span>
    <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} source - expected values are default/config/env/cli</span>
    <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
    <span class="s5">*/</span>

  <span class="s1">setOptionValueWithSource</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">source</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">setOptionValue</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">);</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_optionValueSources</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">source</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
    <span class="s5">* Get source of option value.</span>
    <span class="s5">* Expected values are default | config | env | cli</span>
    <span class="s5">*</span>
    <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} key</span>
    <span class="s5">* </span><span class="s6">@return </span><span class="s5">{string}</span>
    <span class="s5">*/</span>

  <span class="s1">getOptionValueSource</span><span class="s2">(</span><span class="s1">key</span><span class="s2">) {</span>
    <span class="s0">return this</span><span class="s2">.</span><span class="s1">_optionValueSources</span><span class="s2">[</span><span class="s1">key</span><span class="s2">];</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Get user arguments implied or explicit arguments.</span>
   <span class="s5">* Side-effects: set _scriptPath if args included application, and use that to set implicit command name.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_prepareUserArgs</span><span class="s2">(</span><span class="s1">argv</span><span class="s2">, </span><span class="s1">parseOptions</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">argv </span><span class="s2">!== </span><span class="s1">undefined </span><span class="s2">&amp;&amp; !</span><span class="s1">Array</span><span class="s2">.</span><span class="s1">isArray</span><span class="s2">(</span><span class="s1">argv</span><span class="s2">)) {</span>
      <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'first parameter to parse must be array or undefined'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s1">parseOptions </span><span class="s2">= </span><span class="s1">parseOptions </span><span class="s2">|| {};</span>

    <span class="s4">// Default to using process.argv</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">argv </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) {</span>
      <span class="s1">argv </span><span class="s2">= </span><span class="s1">process</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">;</span>
      <span class="s4">// @ts-ignore: unknown property</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">versions </span><span class="s2">&amp;&amp; </span><span class="s1">process</span><span class="s2">.</span><span class="s1">versions</span><span class="s2">.</span><span class="s1">electron</span><span class="s2">) {</span>
        <span class="s1">parseOptions</span><span class="s2">.</span><span class="s1">from </span><span class="s2">= </span><span class="s3">'electron'</span><span class="s2">;</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">rawArgs </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">();</span>

    <span class="s4">// make it a little easier for callers by supporting various argv conventions</span>
    <span class="s0">let </span><span class="s1">userArgs</span><span class="s2">;</span>
    <span class="s0">switch </span><span class="s2">(</span><span class="s1">parseOptions</span><span class="s2">.</span><span class="s1">from</span><span class="s2">) {</span>
      <span class="s0">case </span><span class="s1">undefined</span><span class="s2">:</span>
      <span class="s0">case </span><span class="s3">'node'</span><span class="s2">:</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">_scriptPath </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">[</span><span class="s8">1</span><span class="s2">];</span>
        <span class="s1">userArgs </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s8">2</span><span class="s2">);</span>
        <span class="s0">break</span><span class="s2">;</span>
      <span class="s0">case </span><span class="s3">'electron'</span><span class="s2">:</span>
        <span class="s4">// @ts-ignore: unknown property</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">defaultApp</span><span class="s2">) {</span>
          <span class="s0">this</span><span class="s2">.</span><span class="s1">_scriptPath </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">[</span><span class="s8">1</span><span class="s2">];</span>
          <span class="s1">userArgs </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s8">2</span><span class="s2">);</span>
        <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
          <span class="s1">userArgs </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s8">1</span><span class="s2">);</span>
        <span class="s2">}</span>
        <span class="s0">break</span><span class="s2">;</span>
      <span class="s0">case </span><span class="s3">'user'</span><span class="s2">:</span>
        <span class="s1">userArgs </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s8">0</span><span class="s2">);</span>
        <span class="s0">break</span><span class="s2">;</span>
      <span class="s0">default</span><span class="s2">:</span>
        <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">`unexpected parse option { from: '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">parseOptions</span><span class="s2">.</span><span class="s1">from</span><span class="s2">}</span><span class="s3">' }`</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_scriptPath </span><span class="s2">&amp;&amp; </span><span class="s1">require</span><span class="s2">.</span><span class="s1">main</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_scriptPath </span><span class="s2">= </span><span class="s1">require</span><span class="s2">.</span><span class="s1">main</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s4">// Guess name, used in usage in help.</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_name </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_name </span><span class="s2">|| (</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_scriptPath </span><span class="s2">&amp;&amp; </span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_scriptPath</span><span class="s2">, </span><span class="s1">path</span><span class="s2">.</span><span class="s1">extname</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_scriptPath</span><span class="s2">)));</span>

    <span class="s0">return </span><span class="s1">userArgs</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Parse `argv`, setting options and invoking commands when defined.</span>
   <span class="s5">*</span>
   <span class="s5">* The default expectation is that the arguments are from node and have the application as argv[0]</span>
   <span class="s5">* and the script being run in argv[1], with user parameters after that.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@example</span>
   <span class="s5">* program.parse(process.argv);</span>
   <span class="s5">* program.parse(); // implicitly use process.argv and auto-detect node vs electron conventions</span>
   <span class="s5">* program.parse(my-args, { from: 'user' }); // just user supplied arguments, nothing special about argv[0]</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string[]} [argv] - optional, defaults to process.argv</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [parseOptions] - optionally specify style of options with from: node/user/electron</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [parseOptions.from] - where the args are from: 'node', 'user', 'electron'</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">parse</span><span class="s2">(</span><span class="s1">argv</span><span class="s2">, </span><span class="s1">parseOptions</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">userArgs </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_prepareUserArgs</span><span class="s2">(</span><span class="s1">argv</span><span class="s2">, </span><span class="s1">parseOptions</span><span class="s2">);</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_parseCommand</span><span class="s2">([], </span><span class="s1">userArgs</span><span class="s2">);</span>

    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Parse `argv`, setting options and invoking commands when defined.</span>
   <span class="s5">*</span>
   <span class="s5">* Use parseAsync instead of parse if any of your action handlers are async. Returns a Promise.</span>
   <span class="s5">*</span>
   <span class="s5">* The default expectation is that the arguments are from node and have the application as argv[0]</span>
   <span class="s5">* and the script being run in argv[1], with user parameters after that.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@example</span>
   <span class="s5">* await program.parseAsync(process.argv);</span>
   <span class="s5">* await program.parseAsync(); // implicitly use process.argv and auto-detect node vs electron conventions</span>
   <span class="s5">* await program.parseAsync(my-args, { from: 'user' }); // just user supplied arguments, nothing special about argv[0]</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string[]} [argv]</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [parseOptions]</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} parseOptions.from - where the args are from: 'node', 'user', 'electron'</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Promise}</span>
   <span class="s5">*/</span>

  <span class="s1">async parseAsync</span><span class="s2">(</span><span class="s1">argv</span><span class="s2">, </span><span class="s1">parseOptions</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">userArgs </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_prepareUserArgs</span><span class="s2">(</span><span class="s1">argv</span><span class="s2">, </span><span class="s1">parseOptions</span><span class="s2">);</span>
    <span class="s0">await this</span><span class="s2">.</span><span class="s1">_parseCommand</span><span class="s2">([], </span><span class="s1">userArgs</span><span class="s2">);</span>

    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Execute a sub-command executable.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_executeSubCommand</span><span class="s2">(</span><span class="s1">subcommand</span><span class="s2">, </span><span class="s1">args</span><span class="s2">) {</span>
    <span class="s1">args </span><span class="s2">= </span><span class="s1">args</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">();</span>
    <span class="s0">let </span><span class="s1">launchWithNode </span><span class="s2">= </span><span class="s0">false</span><span class="s2">; </span><span class="s4">// Use node for source targets so do not need to get permissions correct, and on Windows.</span>
    <span class="s0">const </span><span class="s1">sourceExt </span><span class="s2">= [</span><span class="s3">'.js'</span><span class="s2">, </span><span class="s3">'.ts'</span><span class="s2">, </span><span class="s3">'.tsx'</span><span class="s2">, </span><span class="s3">'.mjs'</span><span class="s2">, </span><span class="s3">'.cjs'</span><span class="s2">];</span>

    <span class="s4">// Not checking for help first. Unlikely to have mandatory and executable, and can't robustly test for help flags in external command.</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_checkForMissingMandatoryOptions</span><span class="s2">();</span>

    <span class="s4">// Want the entry script as the reference for command name and directory for searching for other files.</span>
    <span class="s0">let </span><span class="s1">scriptPath </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_scriptPath</span><span class="s2">;</span>
    <span class="s4">// Fallback in case not set, due to how Command created or called.</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">scriptPath </span><span class="s2">&amp;&amp; </span><span class="s1">require</span><span class="s2">.</span><span class="s1">main</span><span class="s2">) {</span>
      <span class="s1">scriptPath </span><span class="s2">= </span><span class="s1">require</span><span class="s2">.</span><span class="s1">main</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s0">let </span><span class="s1">baseDir</span><span class="s2">;</span>
    <span class="s0">try </span><span class="s2">{</span>
      <span class="s0">const </span><span class="s1">resolvedLink </span><span class="s2">= </span><span class="s1">fs</span><span class="s2">.</span><span class="s1">realpathSync</span><span class="s2">(</span><span class="s1">scriptPath</span><span class="s2">);</span>
      <span class="s1">baseDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">resolvedLink</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">e</span><span class="s2">) {</span>
      <span class="s1">baseDir </span><span class="s2">= </span><span class="s3">'.'</span><span class="s2">; </span><span class="s4">// dummy, probably not going to find executable!</span>
    <span class="s2">}</span>

    <span class="s4">// name of the subcommand, like `pm-install`</span>
    <span class="s0">let </span><span class="s1">bin </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">scriptPath</span><span class="s2">, </span><span class="s1">path</span><span class="s2">.</span><span class="s1">extname</span><span class="s2">(</span><span class="s1">scriptPath</span><span class="s2">)) + </span><span class="s3">'-' </span><span class="s2">+ </span><span class="s1">subcommand</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">subcommand</span><span class="s2">.</span><span class="s1">_executableFile</span><span class="s2">) {</span>
      <span class="s1">bin </span><span class="s2">= </span><span class="s1">subcommand</span><span class="s2">.</span><span class="s1">_executableFile</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s0">const </span><span class="s1">localBin </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">baseDir</span><span class="s2">, </span><span class="s1">bin</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">fs</span><span class="s2">.</span><span class="s1">existsSync</span><span class="s2">(</span><span class="s1">localBin</span><span class="s2">)) {</span>
      <span class="s4">// prefer local `./&lt;bin&gt;` to bin in the $PATH</span>
      <span class="s1">bin </span><span class="s2">= </span><span class="s1">localBin</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s4">// Look for source files.</span>
      <span class="s1">sourceExt</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">ext</span><span class="s2">) =&gt; {</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">fs</span><span class="s2">.</span><span class="s1">existsSync</span><span class="s2">(</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">localBin</span><span class="s2">}</span><span class="s1">$</span><span class="s2">{</span><span class="s1">ext</span><span class="s2">}</span><span class="s3">`</span><span class="s2">)) {</span>
          <span class="s1">bin </span><span class="s2">= </span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">localBin</span><span class="s2">}</span><span class="s1">$</span><span class="s2">{</span><span class="s1">ext</span><span class="s2">}</span><span class="s3">`</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">});</span>
    <span class="s2">}</span>
    <span class="s1">launchWithNode </span><span class="s2">= </span><span class="s1">sourceExt</span><span class="s2">.</span><span class="s1">includes</span><span class="s2">(</span><span class="s1">path</span><span class="s2">.</span><span class="s1">extname</span><span class="s2">(</span><span class="s1">bin</span><span class="s2">));</span>

    <span class="s0">let </span><span class="s1">proc</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!== </span><span class="s3">'win32'</span><span class="s2">) {</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">launchWithNode</span><span class="s2">) {</span>
        <span class="s1">args</span><span class="s2">.</span><span class="s1">unshift</span><span class="s2">(</span><span class="s1">bin</span><span class="s2">);</span>
        <span class="s4">// add executable arguments to spawn</span>
        <span class="s1">args </span><span class="s2">= </span><span class="s1">incrementNodeInspectorPort</span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">execArgv</span><span class="s2">).</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">args</span><span class="s2">);</span>

        <span class="s1">proc </span><span class="s2">= </span><span class="s1">childProcess</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s8">0</span><span class="s2">], </span><span class="s1">args</span><span class="s2">, { </span><span class="s1">stdio</span><span class="s2">: </span><span class="s3">'inherit' </span><span class="s2">});</span>
      <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
        <span class="s1">proc </span><span class="s2">= </span><span class="s1">childProcess</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s1">bin</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, { </span><span class="s1">stdio</span><span class="s2">: </span><span class="s3">'inherit' </span><span class="s2">});</span>
      <span class="s2">}</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s1">args</span><span class="s2">.</span><span class="s1">unshift</span><span class="s2">(</span><span class="s1">bin</span><span class="s2">);</span>
      <span class="s4">// add executable arguments to spawn</span>
      <span class="s1">args </span><span class="s2">= </span><span class="s1">incrementNodeInspectorPort</span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">execArgv</span><span class="s2">).</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">args</span><span class="s2">);</span>
      <span class="s1">proc </span><span class="s2">= </span><span class="s1">childProcess</span><span class="s2">.</span><span class="s1">spawn</span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">execPath</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, { </span><span class="s1">stdio</span><span class="s2">: </span><span class="s3">'inherit' </span><span class="s2">});</span>
    <span class="s2">}</span>

    <span class="s0">const </span><span class="s1">signals </span><span class="s2">= [</span><span class="s3">'SIGUSR1'</span><span class="s2">, </span><span class="s3">'SIGUSR2'</span><span class="s2">, </span><span class="s3">'SIGTERM'</span><span class="s2">, </span><span class="s3">'SIGINT'</span><span class="s2">, </span><span class="s3">'SIGHUP'</span><span class="s2">];</span>
    <span class="s1">signals</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">signal</span><span class="s2">) =&gt; {</span>
      <span class="s4">// @ts-ignore</span>
      <span class="s1">process</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">, () =&gt; {</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">proc</span><span class="s2">.</span><span class="s1">killed </span><span class="s2">=== </span><span class="s0">false </span><span class="s2">&amp;&amp; </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">exitCode </span><span class="s2">=== </span><span class="s0">null</span><span class="s2">) {</span>
          <span class="s1">proc</span><span class="s2">.</span><span class="s1">kill</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">});</span>
    <span class="s2">});</span>

    <span class="s4">// By default terminate process when spawned process terminates.</span>
    <span class="s4">// Suppressing the exit if exitCallback defined is a bit messy and of limited use, but does allow process to stay running!</span>
    <span class="s0">const </span><span class="s1">exitCallback </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_exitCallback</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">exitCallback</span><span class="s2">) {</span>
      <span class="s1">proc</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s3">'close'</span><span class="s2">, </span><span class="s1">process</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">process</span><span class="s2">));</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s1">proc</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s3">'close'</span><span class="s2">, () =&gt; {</span>
        <span class="s1">exitCallback</span><span class="s2">(</span><span class="s0">new </span><span class="s1">CommanderError</span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">exitCode </span><span class="s2">|| </span><span class="s8">0</span><span class="s2">, </span><span class="s3">'commander.executeSubCommandAsync'</span><span class="s2">, </span><span class="s3">'(close)'</span><span class="s2">));</span>
      <span class="s2">});</span>
    <span class="s2">}</span>
    <span class="s1">proc</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s3">'error'</span><span class="s2">, (</span><span class="s1">err</span><span class="s2">) =&gt; {</span>
      <span class="s4">// @ts-ignore</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">code </span><span class="s2">=== </span><span class="s3">'ENOENT'</span><span class="s2">) {</span>
        <span class="s0">const </span><span class="s1">executableMissing </span><span class="s2">= </span><span class="s3">`'</span><span class="s1">$</span><span class="s2">{</span><span class="s1">bin</span><span class="s2">}</span><span class="s3">' does not exist 
 - if '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">subcommand</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">}</span><span class="s3">' is not meant to be an executable command, remove description parameter from '.command()' and use '.description()' instead 
 - if the default executable name is not suitable, use the executableFile option to supply a custom name`</span><span class="s2">;</span>
        <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s1">executableMissing</span><span class="s2">);</span>
      <span class="s4">// @ts-ignore</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">code </span><span class="s2">=== </span><span class="s3">'EACCES'</span><span class="s2">) {</span>
        <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">`'</span><span class="s1">$</span><span class="s2">{</span><span class="s1">bin</span><span class="s2">}</span><span class="s3">' not executable`</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s0">if </span><span class="s2">(!</span><span class="s1">exitCallback</span><span class="s2">) {</span>
        <span class="s1">process</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s8">1</span><span class="s2">);</span>
      <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
        <span class="s0">const </span><span class="s1">wrappedError </span><span class="s2">= </span><span class="s0">new </span><span class="s1">CommanderError</span><span class="s2">(</span><span class="s8">1</span><span class="s2">, </span><span class="s3">'commander.executeSubCommandAsync'</span><span class="s2">, </span><span class="s3">'(error)'</span><span class="s2">);</span>
        <span class="s1">wrappedError</span><span class="s2">.</span><span class="s1">nestedError </span><span class="s2">= </span><span class="s1">err</span><span class="s2">;</span>
        <span class="s1">exitCallback</span><span class="s2">(</span><span class="s1">wrappedError</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">});</span>

    <span class="s4">// Store the reference to the child process</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">runningCommand </span><span class="s2">= </span><span class="s1">proc</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_dispatchSubcommand</span><span class="s2">(</span><span class="s1">commandName</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">subCommand </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_findCommand</span><span class="s2">(</span><span class="s1">commandName</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">subCommand</span><span class="s2">) </span><span class="s0">this</span><span class="s2">.</span><span class="s1">help</span><span class="s2">({ </span><span class="s1">error</span><span class="s2">: </span><span class="s0">true </span><span class="s2">});</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">subCommand</span><span class="s2">.</span><span class="s1">_executableHandler</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_executeSubCommand</span><span class="s2">(</span><span class="s1">subCommand</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">unknown</span><span class="s2">));</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s0">return </span><span class="s1">subCommand</span><span class="s2">.</span><span class="s1">_parseCommand</span><span class="s2">(</span><span class="s1">operands</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">);</span>
    <span class="s2">}</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Check this.args against expected this._args.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_checkNumberOfArguments</span><span class="s2">() {</span>
    <span class="s4">// too few</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">i</span><span class="s2">) =&gt; {</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">arg</span><span class="s2">.</span><span class="s1">required </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] == </span><span class="s0">null</span><span class="s2">) {</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">missingArgument</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">());</span>
      <span class="s2">}</span>
    <span class="s2">});</span>
    <span class="s4">// too many</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s8">0 </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">[</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s8">1</span><span class="s2">].</span><span class="s1">variadic</span><span class="s2">) {</span>
      <span class="s0">return</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_excessArguments</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">args</span><span class="s2">);</span>
    <span class="s2">}</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Process this.args using this._args and save as this.processedArgs!</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_processArguments</span><span class="s2">() {</span>
    <span class="s0">const </span><span class="s1">myParseArg </span><span class="s2">= (</span><span class="s1">argument</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">previous</span><span class="s2">) =&gt; {</span>
      <span class="s4">// Extra processing for nice error message on parsing failure.</span>
      <span class="s0">let </span><span class="s1">parsedValue </span><span class="s2">= </span><span class="s1">value</span><span class="s2">;</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">value </span><span class="s2">!== </span><span class="s0">null </span><span class="s2">&amp;&amp; </span><span class="s1">argument</span><span class="s2">.</span><span class="s1">parseArg</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
          <span class="s1">parsedValue </span><span class="s2">= </span><span class="s1">argument</span><span class="s2">.</span><span class="s1">parseArg</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">previous</span><span class="s2">);</span>
        <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
          <span class="s0">if </span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">code </span><span class="s2">=== </span><span class="s3">'commander.invalidArgument'</span><span class="s2">) {</span>
            <span class="s0">const </span><span class="s1">message </span><span class="s2">= </span><span class="s3">`error: command-argument value '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">value</span><span class="s2">}</span><span class="s3">' is invalid for argument '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">argument</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">'. </span><span class="s1">$</span><span class="s2">{</span><span class="s1">err</span><span class="s2">.</span><span class="s1">message</span><span class="s2">}</span><span class="s3">`</span><span class="s2">;</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">_displayError</span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">exitCode</span><span class="s2">, </span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s1">message</span><span class="s2">);</span>
          <span class="s2">}</span>
          <span class="s0">throw </span><span class="s1">err</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
      <span class="s0">return </span><span class="s1">parsedValue</span><span class="s2">;</span>
    <span class="s2">};</span>

    <span class="s0">this</span><span class="s2">.</span><span class="s1">_checkNumberOfArguments</span><span class="s2">();</span>

    <span class="s0">const </span><span class="s1">processedArgs </span><span class="s2">= [];</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">declaredArg</span><span class="s2">, </span><span class="s1">index</span><span class="s2">) =&gt; {</span>
      <span class="s0">let </span><span class="s1">value </span><span class="s2">= </span><span class="s1">declaredArg</span><span class="s2">.</span><span class="s1">defaultValue</span><span class="s2">;</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">declaredArg</span><span class="s2">.</span><span class="s1">variadic</span><span class="s2">) {</span>
        <span class="s4">// Collect together remaining arguments for passing together as an array.</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
          <span class="s1">value </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">args</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">index</span><span class="s2">);</span>
          <span class="s0">if </span><span class="s2">(</span><span class="s1">declaredArg</span><span class="s2">.</span><span class="s1">parseArg</span><span class="s2">) {</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">((</span><span class="s1">processed</span><span class="s2">, </span><span class="s1">v</span><span class="s2">) =&gt; {</span>
              <span class="s0">return </span><span class="s1">myParseArg</span><span class="s2">(</span><span class="s1">declaredArg</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">processed</span><span class="s2">);</span>
            <span class="s2">}, </span><span class="s1">declaredArg</span><span class="s2">.</span><span class="s1">defaultValue</span><span class="s2">);</span>
          <span class="s2">}</span>
        <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">value </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) {</span>
          <span class="s1">value </span><span class="s2">= [];</span>
        <span class="s2">}</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s1">index</span><span class="s2">];</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">declaredArg</span><span class="s2">.</span><span class="s1">parseArg</span><span class="s2">) {</span>
          <span class="s1">value </span><span class="s2">= </span><span class="s1">myParseArg</span><span class="s2">(</span><span class="s1">declaredArg</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">declaredArg</span><span class="s2">.</span><span class="s1">defaultValue</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
      <span class="s1">processedArgs</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">value</span><span class="s2">;</span>
    <span class="s2">});</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">processedArgs </span><span class="s2">= </span><span class="s1">processedArgs</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Once we have a promise we chain, but call synchronously until then.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Promise|undefined} promise</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} fn</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Promise|undefined}</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_chainOrCall</span><span class="s2">(</span><span class="s1">promise</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">) {</span>
    <span class="s4">// thenable</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">promise </span><span class="s2">&amp;&amp; </span><span class="s1">promise</span><span class="s2">.</span><span class="s1">then </span><span class="s2">&amp;&amp; </span><span class="s0">typeof </span><span class="s1">promise</span><span class="s2">.</span><span class="s1">then </span><span class="s2">=== </span><span class="s3">'function'</span><span class="s2">) {</span>
      <span class="s4">// already have a promise, chain callback</span>
      <span class="s0">return </span><span class="s1">promise</span><span class="s2">.</span><span class="s1">then</span><span class="s2">(() =&gt; </span><span class="s1">fn</span><span class="s2">());</span>
    <span class="s2">}</span>
    <span class="s4">// callback might return a promise</span>
    <span class="s0">return </span><span class="s1">fn</span><span class="s2">();</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Promise|undefined} promise</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} event</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Promise|undefined}</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_chainOrCallHooks</span><span class="s2">(</span><span class="s1">promise</span><span class="s2">, </span><span class="s1">event</span><span class="s2">) {</span>
    <span class="s0">let </span><span class="s1">result </span><span class="s2">= </span><span class="s1">promise</span><span class="s2">;</span>
    <span class="s0">const </span><span class="s1">hooks </span><span class="s2">= [];</span>
    <span class="s1">getCommandAndParents</span><span class="s2">(</span><span class="s0">this</span><span class="s2">)</span>
      <span class="s2">.</span><span class="s1">reverse</span><span class="s2">()</span>
      <span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">cmd </span><span class="s2">=&gt; </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_lifeCycleHooks</span><span class="s2">[</span><span class="s1">event</span><span class="s2">] !== </span><span class="s1">undefined</span><span class="s2">)</span>
      <span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s1">hookedCommand </span><span class="s2">=&gt; {</span>
        <span class="s1">hookedCommand</span><span class="s2">.</span><span class="s1">_lifeCycleHooks</span><span class="s2">[</span><span class="s1">event</span><span class="s2">].</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">callback</span><span class="s2">) =&gt; {</span>
          <span class="s1">hooks</span><span class="s2">.</span><span class="s1">push</span><span class="s2">({ </span><span class="s1">hookedCommand</span><span class="s2">, </span><span class="s1">callback </span><span class="s2">});</span>
        <span class="s2">});</span>
      <span class="s2">});</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">event </span><span class="s2">=== </span><span class="s3">'postAction'</span><span class="s2">) {</span>
      <span class="s1">hooks</span><span class="s2">.</span><span class="s1">reverse</span><span class="s2">();</span>
    <span class="s2">}</span>

    <span class="s1">hooks</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">hookDetail</span><span class="s2">) =&gt; {</span>
      <span class="s1">result </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_chainOrCall</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, () =&gt; {</span>
        <span class="s0">return </span><span class="s1">hookDetail</span><span class="s2">.</span><span class="s1">callback</span><span class="s2">(</span><span class="s1">hookDetail</span><span class="s2">.</span><span class="s1">hookedCommand</span><span class="s2">, </span><span class="s0">this</span><span class="s2">);</span>
      <span class="s2">});</span>
    <span class="s2">});</span>
    <span class="s0">return </span><span class="s1">result</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Process arguments in context of this command.</span>
   <span class="s5">* Returns action result, in case it is a promise.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_parseCommand</span><span class="s2">(</span><span class="s1">operands</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">parsed </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">parseOptions</span><span class="s2">(</span><span class="s1">unknown</span><span class="s2">);</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_parseOptionsEnv</span><span class="s2">(); </span><span class="s4">// after cli, so parseArg not called on both cli and env</span>
    <span class="s1">operands </span><span class="s2">= </span><span class="s1">operands</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">);</span>
    <span class="s1">unknown </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">unknown</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">args </span><span class="s2">= </span><span class="s1">operands</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">unknown</span><span class="s2">);</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">operands </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_findCommand</span><span class="s2">(</span><span class="s1">operands</span><span class="s2">[</span><span class="s8">0</span><span class="s2">])) {</span>
      <span class="s0">return this</span><span class="s2">.</span><span class="s1">_dispatchSubcommand</span><span class="s2">(</span><span class="s1">operands</span><span class="s2">[</span><span class="s8">0</span><span class="s2">], </span><span class="s1">operands</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s8">1</span><span class="s2">), </span><span class="s1">unknown</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_hasImplicitHelpCommand</span><span class="s2">() &amp;&amp; </span><span class="s1">operands</span><span class="s2">[</span><span class="s8">0</span><span class="s2">] === </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandName</span><span class="s2">) {</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">operands</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s8">1</span><span class="s2">) {</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">help</span><span class="s2">();</span>
      <span class="s2">}</span>
      <span class="s0">return this</span><span class="s2">.</span><span class="s1">_dispatchSubcommand</span><span class="s2">(</span><span class="s1">operands</span><span class="s2">[</span><span class="s8">1</span><span class="s2">], [], [</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_helpLongFlag</span><span class="s2">]);</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_defaultCommandName</span><span class="s2">) {</span>
      <span class="s1">outputHelpIfRequested</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">); </span><span class="s4">// Run the help for default command from parent rather than passing to default command</span>
      <span class="s0">return this</span><span class="s2">.</span><span class="s1">_dispatchSubcommand</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_defaultCommandName</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s8">0 </span><span class="s2">&amp;&amp; !</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_actionHandler </span><span class="s2">&amp;&amp; !</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_defaultCommandName</span><span class="s2">) {</span>
      <span class="s4">// probably missing subcommand and no handler, user needs help (and exit)</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">help</span><span class="s2">({ </span><span class="s1">error</span><span class="s2">: </span><span class="s0">true </span><span class="s2">});</span>
    <span class="s2">}</span>

    <span class="s1">outputHelpIfRequested</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">unknown</span><span class="s2">);</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_checkForMissingMandatoryOptions</span><span class="s2">();</span>

    <span class="s4">// We do not always call this check to avoid masking a &quot;better&quot; error, like unknown command.</span>
    <span class="s0">const </span><span class="s1">checkForUnknownOptions </span><span class="s2">= () =&gt; {</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">unknown</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s8">0</span><span class="s2">) {</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">unknownOption</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">unknown</span><span class="s2">[</span><span class="s8">0</span><span class="s2">]);</span>
      <span class="s2">}</span>
    <span class="s2">};</span>

    <span class="s0">const </span><span class="s1">commandEvent </span><span class="s2">= </span><span class="s3">`command:</span><span class="s1">$</span><span class="s2">{</span><span class="s0">this</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_actionHandler</span><span class="s2">) {</span>
      <span class="s1">checkForUnknownOptions</span><span class="s2">();</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_processArguments</span><span class="s2">();</span>

      <span class="s0">let </span><span class="s1">actionResult</span><span class="s2">;</span>
      <span class="s1">actionResult </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_chainOrCallHooks</span><span class="s2">(</span><span class="s1">actionResult</span><span class="s2">, </span><span class="s3">'preAction'</span><span class="s2">);</span>
      <span class="s1">actionResult </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_chainOrCall</span><span class="s2">(</span><span class="s1">actionResult</span><span class="s2">, () =&gt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_actionHandler</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">processedArgs</span><span class="s2">));</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">) </span><span class="s0">this</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s1">commandEvent</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">); </span><span class="s4">// legacy</span>
      <span class="s1">actionResult </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_chainOrCallHooks</span><span class="s2">(</span><span class="s1">actionResult</span><span class="s2">, </span><span class="s3">'postAction'</span><span class="s2">);</span>
      <span class="s0">return </span><span class="s1">actionResult</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">listenerCount</span><span class="s2">(</span><span class="s1">commandEvent</span><span class="s2">)) {</span>
      <span class="s1">checkForUnknownOptions</span><span class="s2">();</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_processArguments</span><span class="s2">();</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s1">commandEvent</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">); </span><span class="s4">// legacy</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">operands</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_findCommand</span><span class="s2">(</span><span class="s3">'*'</span><span class="s2">)) { </span><span class="s4">// legacy default command</span>
        <span class="s0">return this</span><span class="s2">.</span><span class="s1">_dispatchSubcommand</span><span class="s2">(</span><span class="s3">'*'</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">listenerCount</span><span class="s2">(</span><span class="s3">'command:*'</span><span class="s2">)) {</span>
        <span class="s4">// skip option check, emit event for possible misspelling suggestion</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">'command:*'</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">, </span><span class="s1">unknown</span><span class="s2">);</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">unknownCommand</span><span class="s2">();</span>
      <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
        <span class="s1">checkForUnknownOptions</span><span class="s2">();</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">_processArguments</span><span class="s2">();</span>
      <span class="s2">}</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
      <span class="s1">checkForUnknownOptions</span><span class="s2">();</span>
      <span class="s4">// This command has subcommands and nothing hooked up at this level, so display help (and exit).</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">help</span><span class="s2">({ </span><span class="s1">error</span><span class="s2">: </span><span class="s0">true </span><span class="s2">});</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s1">checkForUnknownOptions</span><span class="s2">();</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_processArguments</span><span class="s2">();</span>
      <span class="s4">// fall through for caller to handle after calling .parse()</span>
    <span class="s2">}</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Find matching command.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>
  <span class="s1">_findCommand</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">name</span><span class="s2">) </span><span class="s0">return </span><span class="s1">undefined</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s1">cmd </span><span class="s2">=&gt; </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_name </span><span class="s2">=== </span><span class="s1">name </span><span class="s2">|| </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_aliases</span><span class="s2">.</span><span class="s1">includes</span><span class="s2">(</span><span class="s1">name</span><span class="s2">));</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Return an option matching `arg` if any.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} arg</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Option}</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_findOption</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">) {</span>
    <span class="s0">return this</span><span class="s2">.</span><span class="s1">options</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s1">option </span><span class="s2">=&gt; </span><span class="s1">option</span><span class="s2">.</span><span class="s1">is</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">));</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Display an error message if a mandatory option does not have a value.</span>
   <span class="s5">* Lazy calling after checking for help flags from leaf subcommand.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_checkForMissingMandatoryOptions</span><span class="s2">() {</span>
    <span class="s4">// Walk up hierarchy so can call in subcommand after checking for displaying help.</span>
    <span class="s0">for </span><span class="s2">(</span><span class="s0">let </span><span class="s1">cmd </span><span class="s2">= </span><span class="s0">this</span><span class="s2">; </span><span class="s1">cmd</span><span class="s2">; </span><span class="s1">cmd </span><span class="s2">= </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">) {</span>
      <span class="s1">cmd</span><span class="s2">.</span><span class="s1">options</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">anOption</span><span class="s2">) =&gt; {</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">anOption</span><span class="s2">.</span><span class="s1">mandatory </span><span class="s2">&amp;&amp; (</span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">getOptionValue</span><span class="s2">(</span><span class="s1">anOption</span><span class="s2">.</span><span class="s1">attributeName</span><span class="s2">()) === </span><span class="s1">undefined</span><span class="s2">)) {</span>
          <span class="s1">cmd</span><span class="s2">.</span><span class="s1">missingMandatoryOptionValue</span><span class="s2">(</span><span class="s1">anOption</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">});</span>
    <span class="s2">}</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Parse options from `argv` removing known options,</span>
   <span class="s5">* and return argv split into operands and unknown arguments.</span>
   <span class="s5">*</span>
   <span class="s5">* Examples:</span>
   <span class="s5">*</span>
   <span class="s5">*     argv =&gt; operands, unknown</span>
   <span class="s5">*     --known kkk op =&gt; [op], []</span>
   <span class="s5">*     op --known kkk =&gt; [op], []</span>
   <span class="s5">*     sub --unknown uuu op =&gt; [sub], [--unknown uuu op]</span>
   <span class="s5">*     sub -- --unknown uuu op =&gt; [sub --unknown uuu op], []</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String[]} argv</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{{operands: String[], unknown: String[]}}</span>
   <span class="s5">*/</span>

  <span class="s1">parseOptions</span><span class="s2">(</span><span class="s1">argv</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">operands </span><span class="s2">= []; </span><span class="s4">// operands, not options or values</span>
    <span class="s0">const </span><span class="s1">unknown </span><span class="s2">= []; </span><span class="s4">// first unknown option and remaining unknown args</span>
    <span class="s0">let </span><span class="s1">dest </span><span class="s2">= </span><span class="s1">operands</span><span class="s2">;</span>
    <span class="s0">const </span><span class="s1">args </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">();</span>

    <span class="s0">function </span><span class="s1">maybeOption</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">) {</span>
      <span class="s0">return </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s8">1 </span><span class="s2">&amp;&amp; </span><span class="s1">arg</span><span class="s2">[</span><span class="s8">0</span><span class="s2">] === </span><span class="s3">'-'</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s4">// parse options</span>
    <span class="s0">let </span><span class="s1">activeVariadicOption </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s0">while </span><span class="s2">(</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
      <span class="s0">const </span><span class="s1">arg </span><span class="s2">= </span><span class="s1">args</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">();</span>

      <span class="s4">// literal</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">arg </span><span class="s2">=== </span><span class="s3">'--'</span><span class="s2">) {</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">dest </span><span class="s2">=== </span><span class="s1">unknown</span><span class="s2">) </span><span class="s1">dest</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
        <span class="s1">dest</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">...args</span><span class="s2">);</span>
        <span class="s0">break</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">activeVariadicOption </span><span class="s2">&amp;&amp; !</span><span class="s1">maybeOption</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)) {</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">`option:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">activeVariadicOption</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">, </span><span class="s1">arg</span><span class="s2">);</span>
        <span class="s0">continue</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s1">activeVariadicOption </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">maybeOption</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)) {</span>
        <span class="s0">const </span><span class="s1">option </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_findOption</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
        <span class="s4">// recognised option, call listener to assign value with possible custom processing</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">) {</span>
          <span class="s0">if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">.</span><span class="s1">required</span><span class="s2">) {</span>
            <span class="s0">const </span><span class="s1">value </span><span class="s2">= </span><span class="s1">args</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">();</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">value </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) </span><span class="s0">this</span><span class="s2">.</span><span class="s1">optionMissingArgument</span><span class="s2">(</span><span class="s1">option</span><span class="s2">);</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">`option:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">, </span><span class="s1">value</span><span class="s2">);</span>
          <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">.</span><span class="s1">optional</span><span class="s2">) {</span>
            <span class="s0">let </span><span class="s1">value </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
            <span class="s4">// historical behaviour is optional value is following arg unless an option</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s8">0 </span><span class="s2">&amp;&amp; !</span><span class="s1">maybeOption</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s8">0</span><span class="s2">])) {</span>
              <span class="s1">value </span><span class="s2">= </span><span class="s1">args</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">();</span>
            <span class="s2">}</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">`option:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">, </span><span class="s1">value</span><span class="s2">);</span>
          <span class="s2">} </span><span class="s0">else </span><span class="s2">{ </span><span class="s4">// boolean flag</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">`option:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">);</span>
          <span class="s2">}</span>
          <span class="s1">activeVariadicOption </span><span class="s2">= </span><span class="s1">option</span><span class="s2">.</span><span class="s1">variadic </span><span class="s2">? </span><span class="s1">option </span><span class="s2">: </span><span class="s0">null</span><span class="s2">;</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>

      <span class="s4">// Look for combo options following single dash, eat first one if known.</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">arg</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s8">2 </span><span class="s2">&amp;&amp; </span><span class="s1">arg</span><span class="s2">[</span><span class="s8">0</span><span class="s2">] === </span><span class="s3">'-' </span><span class="s2">&amp;&amp; </span><span class="s1">arg</span><span class="s2">[</span><span class="s8">1</span><span class="s2">] !== </span><span class="s3">'-'</span><span class="s2">) {</span>
        <span class="s0">const </span><span class="s1">option </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_findOption</span><span class="s2">(</span><span class="s3">`-</span><span class="s1">$</span><span class="s2">{</span><span class="s1">arg</span><span class="s2">[</span><span class="s8">1</span><span class="s2">]}</span><span class="s3">`</span><span class="s2">);</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">) {</span>
          <span class="s0">if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">.</span><span class="s1">required </span><span class="s2">|| (</span><span class="s1">option</span><span class="s2">.</span><span class="s1">optional </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_combineFlagAndOptionalValue</span><span class="s2">)) {</span>
            <span class="s4">// option with value following in same argument</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">`option:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">, </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s8">2</span><span class="s2">));</span>
          <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
            <span class="s4">// boolean option, emit and put back remainder of arg for further processing</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">`option:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">);</span>
            <span class="s1">args</span><span class="s2">.</span><span class="s1">unshift</span><span class="s2">(</span><span class="s3">`-</span><span class="s1">$</span><span class="s2">{</span><span class="s1">arg</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s8">2</span><span class="s2">)}</span><span class="s3">`</span><span class="s2">);</span>
          <span class="s2">}</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>

      <span class="s4">// Look for known long flag with value, like --foo=bar</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s7">/^--[^=]+=/</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)) {</span>
        <span class="s0">const </span><span class="s1">index </span><span class="s2">= </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">);</span>
        <span class="s0">const </span><span class="s1">option </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_findOption</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s8">0</span><span class="s2">, </span><span class="s1">index</span><span class="s2">));</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">option </span><span class="s2">&amp;&amp; (</span><span class="s1">option</span><span class="s2">.</span><span class="s1">required </span><span class="s2">|| </span><span class="s1">option</span><span class="s2">.</span><span class="s1">optional</span><span class="s2">)) {</span>
          <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">`option:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">, </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">index </span><span class="s2">+ </span><span class="s8">1</span><span class="s2">));</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>

      <span class="s4">// Not a recognised option by this command.</span>
      <span class="s4">// Might be a command-argument, or subcommand option, or unknown option, or help command or option.</span>

      <span class="s4">// An unknown option means further arguments also classified as unknown so can be reprocessed by subcommands.</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">maybeOption</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)) {</span>
        <span class="s1">dest </span><span class="s2">= </span><span class="s1">unknown</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s4">// If using positionalOptions, stop processing our options at subcommand.</span>
      <span class="s0">if </span><span class="s2">((</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_enablePositionalOptions </span><span class="s2">|| </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_passThroughOptions</span><span class="s2">) &amp;&amp; </span><span class="s1">operands</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s8">0 </span><span class="s2">&amp;&amp; </span><span class="s1">unknown</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s8">0</span><span class="s2">) {</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_findCommand</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)) {</span>
          <span class="s1">operands</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
          <span class="s0">if </span><span class="s2">(</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s8">0</span><span class="s2">) </span><span class="s1">unknown</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">...args</span><span class="s2">);</span>
          <span class="s0">break</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">arg </span><span class="s2">=== </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_helpCommandName </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_hasImplicitHelpCommand</span><span class="s2">()) {</span>
          <span class="s1">operands</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
          <span class="s0">if </span><span class="s2">(</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s8">0</span><span class="s2">) </span><span class="s1">operands</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">...args</span><span class="s2">);</span>
          <span class="s0">break</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_defaultCommandName</span><span class="s2">) {</span>
          <span class="s1">unknown</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
          <span class="s0">if </span><span class="s2">(</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s8">0</span><span class="s2">) </span><span class="s1">unknown</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">...args</span><span class="s2">);</span>
          <span class="s0">break</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>

      <span class="s4">// If using passThroughOptions, stop processing options at first command-argument.</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_passThroughOptions</span><span class="s2">) {</span>
        <span class="s1">dest</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s8">0</span><span class="s2">) </span><span class="s1">dest</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">...args</span><span class="s2">);</span>
        <span class="s0">break</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s4">// add arg</span>
      <span class="s1">dest</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">return </span><span class="s2">{ </span><span class="s1">operands</span><span class="s2">, </span><span class="s1">unknown </span><span class="s2">};</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Return an object containing options as key-value pairs</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object}</span>
   <span class="s5">*/</span>
  <span class="s1">opts</span><span class="s2">() {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_storeOptionsAsProperties</span><span class="s2">) {</span>
      <span class="s4">// Preserve original behaviour so backwards compatible when still using properties</span>
      <span class="s0">const </span><span class="s1">result </span><span class="s2">= {};</span>
      <span class="s0">const </span><span class="s1">len </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">options</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>

      <span class="s0">for </span><span class="s2">(</span><span class="s0">let </span><span class="s1">i </span><span class="s2">= </span><span class="s8">0</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
        <span class="s0">const </span><span class="s1">key </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">options</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">attributeName</span><span class="s2">();</span>
        <span class="s1">result</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">key </span><span class="s2">=== </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_versionOptionName </span><span class="s2">? </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_version </span><span class="s2">: </span><span class="s0">this</span><span class="s2">[</span><span class="s1">key</span><span class="s2">];</span>
      <span class="s2">}</span>
      <span class="s0">return </span><span class="s1">result</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s0">return this</span><span class="s2">.</span><span class="s1">_optionValues</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Internal bottleneck for handling of parsing errors.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>
  <span class="s1">_displayError</span><span class="s2">(</span><span class="s1">exitCode</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">message</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">.</span><span class="s1">outputError</span><span class="s2">(</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">message</span><span class="s2">}</span><span class="s0">\n</span><span class="s3">`</span><span class="s2">, </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">.</span><span class="s1">writeErr</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof this</span><span class="s2">.</span><span class="s1">_showHelpAfterError </span><span class="s2">=== </span><span class="s3">'string'</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">.</span><span class="s1">writeErr</span><span class="s2">(</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_showHelpAfterError</span><span class="s2">}</span><span class="s0">\n</span><span class="s3">`</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_showHelpAfterError</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">.</span><span class="s1">writeErr</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">);</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">outputHelp</span><span class="s2">({ </span><span class="s1">error</span><span class="s2">: </span><span class="s0">true </span><span class="s2">});</span>
    <span class="s2">}</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_exit</span><span class="s2">(</span><span class="s1">exitCode</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">message</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Apply any option related environment variables, if option does</span>
   <span class="s5">* not have a value from cli or client code.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>
  <span class="s1">_parseOptionsEnv</span><span class="s2">() {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">options</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">option</span><span class="s2">) =&gt; {</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">.</span><span class="s1">envVar </span><span class="s2">&amp;&amp; </span><span class="s1">option</span><span class="s2">.</span><span class="s1">envVar </span><span class="s0">in </span><span class="s1">process</span><span class="s2">.</span><span class="s1">env</span><span class="s2">) {</span>
        <span class="s0">const </span><span class="s1">optionKey </span><span class="s2">= </span><span class="s1">option</span><span class="s2">.</span><span class="s1">attributeName</span><span class="s2">();</span>
        <span class="s4">// Priority check. Do not overwrite cli or options from unknown source (client-code).</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">getOptionValue</span><span class="s2">(</span><span class="s1">optionKey</span><span class="s2">) === </span><span class="s1">undefined </span><span class="s2">|| [</span><span class="s3">'default'</span><span class="s2">, </span><span class="s3">'config'</span><span class="s2">, </span><span class="s3">'env'</span><span class="s2">].</span><span class="s1">includes</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">getOptionValueSource</span><span class="s2">(</span><span class="s1">optionKey</span><span class="s2">))) {</span>
          <span class="s0">if </span><span class="s2">(</span><span class="s1">option</span><span class="s2">.</span><span class="s1">required </span><span class="s2">|| </span><span class="s1">option</span><span class="s2">.</span><span class="s1">optional</span><span class="s2">) { </span><span class="s4">// option can take a value</span>
            <span class="s4">// keep very simple, optional always takes value</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">`optionEnv:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">, </span><span class="s1">process</span><span class="s2">.</span><span class="s1">env</span><span class="s2">[</span><span class="s1">option</span><span class="s2">.</span><span class="s1">envVar</span><span class="s2">]);</span>
          <span class="s2">} </span><span class="s0">else </span><span class="s2">{ </span><span class="s4">// boolean</span>
            <span class="s4">// keep very simple, only care that envVar defined and not the value</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">`optionEnv:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">`</span><span class="s2">);</span>
          <span class="s2">}</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
    <span class="s2">});</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Argument `name` is missing.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} name</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">missingArgument</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">message </span><span class="s2">= </span><span class="s3">`error: missing required argument '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s3">'`</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_displayError</span><span class="s2">(</span><span class="s8">1</span><span class="s2">, </span><span class="s3">'commander.missingArgument'</span><span class="s2">, </span><span class="s1">message</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* `Option` is missing an argument.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Option} option</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">optionMissingArgument</span><span class="s2">(</span><span class="s1">option</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">message </span><span class="s2">= </span><span class="s3">`error: option '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">}</span><span class="s3">' argument missing`</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_displayError</span><span class="s2">(</span><span class="s8">1</span><span class="s2">, </span><span class="s3">'commander.optionMissingArgument'</span><span class="s2">, </span><span class="s1">message</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* `Option` does not have a value, and is a mandatory option.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Option} option</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">missingMandatoryOptionValue</span><span class="s2">(</span><span class="s1">option</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">message </span><span class="s2">= </span><span class="s3">`error: required option '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">option</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">}</span><span class="s3">' not specified`</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_displayError</span><span class="s2">(</span><span class="s8">1</span><span class="s2">, </span><span class="s3">'commander.missingMandatoryOptionValue'</span><span class="s2">, </span><span class="s1">message</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Unknown option `flag`.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} flag</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">unknownOption</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_allowUnknownOption</span><span class="s2">) </span><span class="s0">return</span><span class="s2">;</span>
    <span class="s0">let </span><span class="s1">suggestion </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">flag</span><span class="s2">.</span><span class="s1">startsWith</span><span class="s2">(</span><span class="s3">'--'</span><span class="s2">) &amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_showSuggestionAfterError</span><span class="s2">) {</span>
      <span class="s4">// Looping to pick up the global options too</span>
      <span class="s0">let </span><span class="s1">candidateFlags </span><span class="s2">= [];</span>
      <span class="s0">let </span><span class="s1">command </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>
      <span class="s0">do </span><span class="s2">{</span>
        <span class="s0">const </span><span class="s1">moreFlags </span><span class="s2">= </span><span class="s1">command</span><span class="s2">.</span><span class="s1">createHelp</span><span class="s2">().</span><span class="s1">visibleOptions</span><span class="s2">(</span><span class="s1">command</span><span class="s2">)</span>
          <span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">option </span><span class="s2">=&gt; </span><span class="s1">option</span><span class="s2">.</span><span class="s1">long</span><span class="s2">)</span>
          <span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s1">option </span><span class="s2">=&gt; </span><span class="s1">option</span><span class="s2">.</span><span class="s1">long</span><span class="s2">);</span>
        <span class="s1">candidateFlags </span><span class="s2">= </span><span class="s1">candidateFlags</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">moreFlags</span><span class="s2">);</span>
        <span class="s1">command </span><span class="s2">= </span><span class="s1">command</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s0">while </span><span class="s2">(</span><span class="s1">command </span><span class="s2">&amp;&amp; !</span><span class="s1">command</span><span class="s2">.</span><span class="s1">_enablePositionalOptions</span><span class="s2">);</span>
      <span class="s1">suggestion </span><span class="s2">= </span><span class="s1">suggestSimilar</span><span class="s2">(</span><span class="s1">flag</span><span class="s2">, </span><span class="s1">candidateFlags</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">const </span><span class="s1">message </span><span class="s2">= </span><span class="s3">`error: unknown option '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">flag</span><span class="s2">}</span><span class="s3">'</span><span class="s1">$</span><span class="s2">{</span><span class="s1">suggestion</span><span class="s2">}</span><span class="s3">`</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_displayError</span><span class="s2">(</span><span class="s8">1</span><span class="s2">, </span><span class="s3">'commander.unknownOption'</span><span class="s2">, </span><span class="s1">message</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Excess arguments, more than expected.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string[]} receivedArgs</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_excessArguments</span><span class="s2">(</span><span class="s1">receivedArgs</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_allowExcessArguments</span><span class="s2">) </span><span class="s0">return</span><span class="s2">;</span>

    <span class="s0">const </span><span class="s1">expected </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
    <span class="s0">const </span><span class="s1">s </span><span class="s2">= (</span><span class="s1">expected </span><span class="s2">=== </span><span class="s8">1</span><span class="s2">) ? </span><span class="s3">'' </span><span class="s2">: </span><span class="s3">'s'</span><span class="s2">;</span>
    <span class="s0">const </span><span class="s1">forSubcommand </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">? </span><span class="s3">` for '</span><span class="s1">$</span><span class="s2">{</span><span class="s0">this</span><span class="s2">.</span><span class="s1">name</span><span class="s2">()}</span><span class="s3">'` </span><span class="s2">: </span><span class="s3">''</span><span class="s2">;</span>
    <span class="s0">const </span><span class="s1">message </span><span class="s2">= </span><span class="s3">`error: too many arguments</span><span class="s1">$</span><span class="s2">{</span><span class="s1">forSubcommand</span><span class="s2">}</span><span class="s3">. Expected </span><span class="s1">$</span><span class="s2">{</span><span class="s1">expected</span><span class="s2">} </span><span class="s3">argument</span><span class="s1">$</span><span class="s2">{</span><span class="s1">s</span><span class="s2">} </span><span class="s3">but got </span><span class="s1">$</span><span class="s2">{</span><span class="s1">receivedArgs</span><span class="s2">.</span><span class="s1">length</span><span class="s2">}</span><span class="s3">.`</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_displayError</span><span class="s2">(</span><span class="s8">1</span><span class="s2">, </span><span class="s3">'commander.excessArguments'</span><span class="s2">, </span><span class="s1">message</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Unknown command.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">unknownCommand</span><span class="s2">() {</span>
    <span class="s0">const </span><span class="s1">unknownName </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s8">0</span><span class="s2">];</span>
    <span class="s0">let </span><span class="s1">suggestion </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_showSuggestionAfterError</span><span class="s2">) {</span>
      <span class="s0">const </span><span class="s1">candidateNames </span><span class="s2">= [];</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">createHelp</span><span class="s2">().</span><span class="s1">visibleCommands</span><span class="s2">(</span><span class="s0">this</span><span class="s2">).</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">command</span><span class="s2">) =&gt; {</span>
        <span class="s1">candidateNames</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">command</span><span class="s2">.</span><span class="s1">name</span><span class="s2">());</span>
        <span class="s4">// just visible alias</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">command</span><span class="s2">.</span><span class="s1">alias</span><span class="s2">()) </span><span class="s1">candidateNames</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">command</span><span class="s2">.</span><span class="s1">alias</span><span class="s2">());</span>
      <span class="s2">});</span>
      <span class="s1">suggestion </span><span class="s2">= </span><span class="s1">suggestSimilar</span><span class="s2">(</span><span class="s1">unknownName</span><span class="s2">, </span><span class="s1">candidateNames</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">const </span><span class="s1">message </span><span class="s2">= </span><span class="s3">`error: unknown command '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">unknownName</span><span class="s2">}</span><span class="s3">'</span><span class="s1">$</span><span class="s2">{</span><span class="s1">suggestion</span><span class="s2">}</span><span class="s3">`</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_displayError</span><span class="s2">(</span><span class="s8">1</span><span class="s2">, </span><span class="s3">'commander.unknownCommand'</span><span class="s2">, </span><span class="s1">message</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Set the program version to `str`.</span>
   <span class="s5">*</span>
   <span class="s5">* This method auto-registers the &quot;-V, --version&quot; flag</span>
   <span class="s5">* which will print the version number when passed.</span>
   <span class="s5">*</span>
   <span class="s5">* You can optionally supply the  flags and description to override the defaults.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} str</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [flags]</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [description]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{this | string} `this` command for chaining, or version string if no arguments</span>
   <span class="s5">*/</span>

  <span class="s1">version</span><span class="s2">(</span><span class="s1">str</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">str </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">_version</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_version </span><span class="s2">= </span><span class="s1">str</span><span class="s2">;</span>
    <span class="s1">flags </span><span class="s2">= </span><span class="s1">flags </span><span class="s2">|| </span><span class="s3">'-V, --version'</span><span class="s2">;</span>
    <span class="s1">description </span><span class="s2">= </span><span class="s1">description </span><span class="s2">|| </span><span class="s3">'output the version number'</span><span class="s2">;</span>
    <span class="s0">const </span><span class="s1">versionOption </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">createOption</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">);</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_versionOptionName </span><span class="s2">= </span><span class="s1">versionOption</span><span class="s2">.</span><span class="s1">attributeName</span><span class="s2">();</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">options</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">versionOption</span><span class="s2">);</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s3">'option:' </span><span class="s2">+ </span><span class="s1">versionOption</span><span class="s2">.</span><span class="s1">name</span><span class="s2">(), () =&gt; {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">.</span><span class="s1">writeOut</span><span class="s2">(</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">str</span><span class="s2">}</span><span class="s0">\n</span><span class="s3">`</span><span class="s2">);</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_exit</span><span class="s2">(</span><span class="s8">0</span><span class="s2">, </span><span class="s3">'commander.version'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">);</span>
    <span class="s2">});</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Set the description to `str`.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [str]</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [argsDescription]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{string|Command}</span>
   <span class="s5">*/</span>
  <span class="s1">description</span><span class="s2">(</span><span class="s1">str</span><span class="s2">, </span><span class="s1">argsDescription</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">str </span><span class="s2">=== </span><span class="s1">undefined </span><span class="s2">&amp;&amp; </span><span class="s1">argsDescription </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">_description</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_description </span><span class="s2">= </span><span class="s1">str</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">argsDescription</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_argsDescription </span><span class="s2">= </span><span class="s1">argsDescription</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Set an alias for the command.</span>
   <span class="s5">*</span>
   <span class="s5">* You may call more than once to add multiple aliases. Only the first alias is shown in the auto-generated help.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [alias]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{string|Command}</span>
   <span class="s5">*/</span>

  <span class="s1">alias</span><span class="s2">(</span><span class="s1">alias</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">alias </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">_aliases</span><span class="s2">[</span><span class="s8">0</span><span class="s2">]; </span><span class="s4">// just return first, for backwards compatibility</span>

    <span class="s5">/** </span><span class="s6">@type </span><span class="s5">{Command} */</span>
    <span class="s0">let </span><span class="s1">command </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">length </span><span class="s2">!== </span><span class="s8">0 </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">[</span><span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s8">1</span><span class="s2">].</span><span class="s1">_executableHandler</span><span class="s2">) {</span>
      <span class="s4">// assume adding alias for last added executable subcommand, rather than this</span>
      <span class="s1">command </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">[</span><span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s8">1</span><span class="s2">];</span>
    <span class="s2">}</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">alias </span><span class="s2">=== </span><span class="s1">command</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">) </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'Command alias can</span><span class="s0">\'</span><span class="s3">t be the same as its name'</span><span class="s2">);</span>

    <span class="s1">command</span><span class="s2">.</span><span class="s1">_aliases</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">alias</span><span class="s2">);</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Set aliases for the command.</span>
   <span class="s5">*</span>
   <span class="s5">* Only the first alias is shown in the auto-generated help.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string[]} [aliases]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{string[]|Command}</span>
   <span class="s5">*/</span>

  <span class="s1">aliases</span><span class="s2">(</span><span class="s1">aliases</span><span class="s2">) {</span>
    <span class="s4">// Getter for the array of aliases is the main reason for having aliases() in addition to alias().</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">aliases </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">_aliases</span><span class="s2">;</span>

    <span class="s1">aliases</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">alias</span><span class="s2">) =&gt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">alias</span><span class="s2">(</span><span class="s1">alias</span><span class="s2">));</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Set / get the command usage `str`.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [str]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{String|Command}</span>
   <span class="s5">*/</span>

  <span class="s1">usage</span><span class="s2">(</span><span class="s1">str</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">str </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) {</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_usage</span><span class="s2">) </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">_usage</span><span class="s2">;</span>

      <span class="s0">const </span><span class="s1">args </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">map</span><span class="s2">((</span><span class="s1">arg</span><span class="s2">) =&gt; {</span>
        <span class="s0">return </span><span class="s1">humanReadableArgName</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
      <span class="s2">});</span>
      <span class="s0">return </span><span class="s2">[].</span><span class="s1">concat</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">options</span><span class="s2">.</span><span class="s1">length </span><span class="s2">|| </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_hasHelpOption </span><span class="s2">? </span><span class="s3">'[options]' </span><span class="s2">: []),</span>
        <span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">commands</span><span class="s2">.</span><span class="s1">length </span><span class="s2">? </span><span class="s3">'[command]' </span><span class="s2">: []),</span>
        <span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_args</span><span class="s2">.</span><span class="s1">length </span><span class="s2">? </span><span class="s1">args </span><span class="s2">: [])</span>
      <span class="s2">).</span><span class="s1">join</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">this</span><span class="s2">.</span><span class="s1">_usage </span><span class="s2">= </span><span class="s1">str</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Get or set the name of the command</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [str]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{string|Command}</span>
   <span class="s5">*/</span>

  <span class="s1">name</span><span class="s2">(</span><span class="s1">str</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">str </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_name </span><span class="s2">= </span><span class="s1">str</span><span class="s2">;</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Return program help documentation.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{{ error: boolean }} [contextOptions] - pass {error:true} to wrap for stderr instead of stdout</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{string}</span>
   <span class="s5">*/</span>

  <span class="s1">helpInformation</span><span class="s2">(</span><span class="s1">contextOptions</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">helper </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">createHelp</span><span class="s2">();</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">helper</span><span class="s2">.</span><span class="s1">helpWidth </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) {</span>
      <span class="s1">helper</span><span class="s2">.</span><span class="s1">helpWidth </span><span class="s2">= (</span><span class="s1">contextOptions </span><span class="s2">&amp;&amp; </span><span class="s1">contextOptions</span><span class="s2">.</span><span class="s1">error</span><span class="s2">) ? </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">.</span><span class="s1">getErrHelpWidth</span><span class="s2">() : </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">.</span><span class="s1">getOutHelpWidth</span><span class="s2">();</span>
    <span class="s2">}</span>
    <span class="s0">return </span><span class="s1">helper</span><span class="s2">.</span><span class="s1">formatHelp</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, </span><span class="s1">helper</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
   <span class="s5">*/</span>

  <span class="s1">_getHelpContext</span><span class="s2">(</span><span class="s1">contextOptions</span><span class="s2">) {</span>
    <span class="s1">contextOptions </span><span class="s2">= </span><span class="s1">contextOptions </span><span class="s2">|| {};</span>
    <span class="s0">const </span><span class="s1">context </span><span class="s2">= { </span><span class="s1">error</span><span class="s2">: !!</span><span class="s1">contextOptions</span><span class="s2">.</span><span class="s1">error </span><span class="s2">};</span>
    <span class="s0">let </span><span class="s1">write</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">context</span><span class="s2">.</span><span class="s1">error</span><span class="s2">) {</span>
      <span class="s1">write </span><span class="s2">= (</span><span class="s1">arg</span><span class="s2">) =&gt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">.</span><span class="s1">writeErr</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s1">write </span><span class="s2">= (</span><span class="s1">arg</span><span class="s2">) =&gt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_outputConfiguration</span><span class="s2">.</span><span class="s1">writeOut</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s1">context</span><span class="s2">.</span><span class="s1">write </span><span class="s2">= </span><span class="s1">contextOptions</span><span class="s2">.</span><span class="s1">write </span><span class="s2">|| </span><span class="s1">write</span><span class="s2">;</span>
    <span class="s1">context</span><span class="s2">.</span><span class="s1">command </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>
    <span class="s0">return </span><span class="s1">context</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Output help information for this command.</span>
   <span class="s5">*</span>
   <span class="s5">* Outputs built-in help, and custom text added using `.addHelpText()`.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{{ error: boolean } | Function} [contextOptions] - pass {error:true} to write to stderr instead of stdout</span>
   <span class="s5">*/</span>

  <span class="s1">outputHelp</span><span class="s2">(</span><span class="s1">contextOptions</span><span class="s2">) {</span>
    <span class="s0">let </span><span class="s1">deprecatedCallback</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">contextOptions </span><span class="s2">=== </span><span class="s3">'function'</span><span class="s2">) {</span>
      <span class="s1">deprecatedCallback </span><span class="s2">= </span><span class="s1">contextOptions</span><span class="s2">;</span>
      <span class="s1">contextOptions </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">const </span><span class="s1">context </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_getHelpContext</span><span class="s2">(</span><span class="s1">contextOptions</span><span class="s2">);</span>

    <span class="s1">getCommandAndParents</span><span class="s2">(</span><span class="s0">this</span><span class="s2">).</span><span class="s1">reverse</span><span class="s2">().</span><span class="s1">forEach</span><span class="s2">(</span><span class="s1">command </span><span class="s2">=&gt; </span><span class="s1">command</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">'beforeAllHelp'</span><span class="s2">, </span><span class="s1">context</span><span class="s2">));</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">'beforeHelp'</span><span class="s2">, </span><span class="s1">context</span><span class="s2">);</span>

    <span class="s0">let </span><span class="s1">helpInformation </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">helpInformation</span><span class="s2">(</span><span class="s1">context</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">deprecatedCallback</span><span class="s2">) {</span>
      <span class="s1">helpInformation </span><span class="s2">= </span><span class="s1">deprecatedCallback</span><span class="s2">(</span><span class="s1">helpInformation</span><span class="s2">);</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">helpInformation </span><span class="s2">!== </span><span class="s3">'string' </span><span class="s2">&amp;&amp; !</span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">isBuffer</span><span class="s2">(</span><span class="s1">helpInformation</span><span class="s2">)) {</span>
        <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'outputHelp callback must return a string or a Buffer'</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
    <span class="s1">context</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">helpInformation</span><span class="s2">);</span>

    <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_helpLongFlag</span><span class="s2">); </span><span class="s4">// deprecated</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">'afterHelp'</span><span class="s2">, </span><span class="s1">context</span><span class="s2">);</span>
    <span class="s1">getCommandAndParents</span><span class="s2">(</span><span class="s0">this</span><span class="s2">).</span><span class="s1">forEach</span><span class="s2">(</span><span class="s1">command </span><span class="s2">=&gt; </span><span class="s1">command</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">'afterAllHelp'</span><span class="s2">, </span><span class="s1">context</span><span class="s2">));</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* You can pass in flags and a description to override the help</span>
   <span class="s5">* flags and help description for your command. Pass in false to</span>
   <span class="s5">* disable the built-in help option.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string | boolean} [flags]</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} [description]</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>

  <span class="s1">helpOption</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">description</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">flags </span><span class="s2">=== </span><span class="s3">'boolean'</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_hasHelpOption </span><span class="s2">= </span><span class="s1">flags</span><span class="s2">;</span>
      <span class="s0">return this</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpFlags </span><span class="s2">= </span><span class="s1">flags </span><span class="s2">|| </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_helpFlags</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpDescription </span><span class="s2">= </span><span class="s1">description </span><span class="s2">|| </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_helpDescription</span><span class="s2">;</span>

    <span class="s0">const </span><span class="s1">helpFlags </span><span class="s2">= </span><span class="s1">splitOptionFlags</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_helpFlags</span><span class="s2">);</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpShortFlag </span><span class="s2">= </span><span class="s1">helpFlags</span><span class="s2">.</span><span class="s1">shortFlag</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_helpLongFlag </span><span class="s2">= </span><span class="s1">helpFlags</span><span class="s2">.</span><span class="s1">longFlag</span><span class="s2">;</span>

    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Output help information and exit.</span>
   <span class="s5">*</span>
   <span class="s5">* Outputs built-in help, and custom text added using `.addHelpText()`.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{{ error: boolean }} [contextOptions] - pass {error:true} to write to stderr instead of stdout</span>
   <span class="s5">*/</span>

  <span class="s1">help</span><span class="s2">(</span><span class="s1">contextOptions</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">outputHelp</span><span class="s2">(</span><span class="s1">contextOptions</span><span class="s2">);</span>
    <span class="s0">let </span><span class="s1">exitCode </span><span class="s2">= </span><span class="s1">process</span><span class="s2">.</span><span class="s1">exitCode </span><span class="s2">|| </span><span class="s8">0</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">exitCode </span><span class="s2">=== </span><span class="s8">0 </span><span class="s2">&amp;&amp; </span><span class="s1">contextOptions </span><span class="s2">&amp;&amp; </span><span class="s0">typeof </span><span class="s1">contextOptions </span><span class="s2">!== </span><span class="s3">'function' </span><span class="s2">&amp;&amp; </span><span class="s1">contextOptions</span><span class="s2">.</span><span class="s1">error</span><span class="s2">) {</span>
      <span class="s1">exitCode </span><span class="s2">= </span><span class="s8">1</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s4">// message: do not have all displayed text available so only passing placeholder.</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_exit</span><span class="s2">(</span><span class="s1">exitCode</span><span class="s2">, </span><span class="s3">'commander.help'</span><span class="s2">, </span><span class="s3">'(outputHelp)'</span><span class="s2">);</span>
  <span class="s2">};</span>

  <span class="s5">/**</span>
   <span class="s5">* Add additional text to be displayed with the built-in help.</span>
   <span class="s5">*</span>
   <span class="s5">* Position is 'before' or 'after' to affect just this command,</span>
   <span class="s5">* and 'beforeAll' or 'afterAll' to affect this command and all its subcommands.</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string} position - before or after built-in help</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string | Function} text - string to add, or a function returning a string</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Command} `this` command for chaining</span>
   <span class="s5">*/</span>
  <span class="s1">addHelpText</span><span class="s2">(</span><span class="s1">position</span><span class="s2">, </span><span class="s1">text</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">allowedValues </span><span class="s2">= [</span><span class="s3">'beforeAll'</span><span class="s2">, </span><span class="s3">'before'</span><span class="s2">, </span><span class="s3">'after'</span><span class="s2">, </span><span class="s3">'afterAll'</span><span class="s2">];</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">allowedValues</span><span class="s2">.</span><span class="s1">includes</span><span class="s2">(</span><span class="s1">position</span><span class="s2">)) {</span>
      <span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">`Unexpected value for position to addHelpText. 
Expecting one of '</span><span class="s1">$</span><span class="s2">{</span><span class="s1">allowedValues</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">&quot;', '&quot;</span><span class="s2">)}</span><span class="s3">'`</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">const </span><span class="s1">helpEvent </span><span class="s2">= </span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">position</span><span class="s2">}</span><span class="s3">Help`</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s1">helpEvent</span><span class="s2">, (</span><span class="s1">context</span><span class="s2">) =&gt; {</span>
      <span class="s0">let </span><span class="s1">helpStr</span><span class="s2">;</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">text </span><span class="s2">=== </span><span class="s3">'function'</span><span class="s2">) {</span>
        <span class="s1">helpStr </span><span class="s2">= </span><span class="s1">text</span><span class="s2">({ </span><span class="s1">error</span><span class="s2">: </span><span class="s1">context</span><span class="s2">.</span><span class="s1">error</span><span class="s2">, </span><span class="s1">command</span><span class="s2">: </span><span class="s1">context</span><span class="s2">.</span><span class="s1">command </span><span class="s2">});</span>
      <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
        <span class="s1">helpStr </span><span class="s2">= </span><span class="s1">text</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s4">// Ignore falsy value when nothing to output.</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s1">helpStr</span><span class="s2">) {</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">helpStr</span><span class="s2">}</span><span class="s0">\n</span><span class="s3">`</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">});</span>
    <span class="s0">return this</span><span class="s2">;</span>
  <span class="s2">}</span>
<span class="s2">};</span>

<span class="s5">/**</span>
 <span class="s5">* Output help information if help flags specified</span>
 <span class="s5">*</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Command} cmd - command to output help for</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} args - array of options to search for help flags</span>
 <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
 <span class="s5">*/</span>

<span class="s0">function </span><span class="s1">outputHelpIfRequested</span><span class="s2">(</span><span class="s1">cmd</span><span class="s2">, </span><span class="s1">args</span><span class="s2">) {</span>
  <span class="s0">const </span><span class="s1">helpOption </span><span class="s2">= </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_hasHelpOption </span><span class="s2">&amp;&amp; </span><span class="s1">args</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s1">arg </span><span class="s2">=&gt; </span><span class="s1">arg </span><span class="s2">=== </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_helpLongFlag </span><span class="s2">|| </span><span class="s1">arg </span><span class="s2">=== </span><span class="s1">cmd</span><span class="s2">.</span><span class="s1">_helpShortFlag</span><span class="s2">);</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">helpOption</span><span class="s2">) {</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">outputHelp</span><span class="s2">();</span>
    <span class="s4">// (Do not have all displayed text available so only passing placeholder.)</span>
    <span class="s1">cmd</span><span class="s2">.</span><span class="s1">_exit</span><span class="s2">(</span><span class="s8">0</span><span class="s2">, </span><span class="s3">'commander.helpDisplayed'</span><span class="s2">, </span><span class="s3">'(outputHelp)'</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s5">/**</span>
 <span class="s5">* Scan arguments and increment port number for inspect calls (to avoid conflicts when spawning new command).</span>
 <span class="s5">*</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{string[]} args - array of arguments from node.execArgv</span>
 <span class="s5">* </span><span class="s6">@returns </span><span class="s5">{string[]}</span>
 <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
 <span class="s5">*/</span>

<span class="s0">function </span><span class="s1">incrementNodeInspectorPort</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) {</span>
  <span class="s4">// Testing for these options:</span>
  <span class="s4">//  --inspect[=[host:]port]</span>
  <span class="s4">//  --inspect-brk[=[host:]port]</span>
  <span class="s4">//  --inspect-port=[host:]port</span>
  <span class="s0">return </span><span class="s1">args</span><span class="s2">.</span><span class="s1">map</span><span class="s2">((</span><span class="s1">arg</span><span class="s2">) =&gt; {</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">arg</span><span class="s2">.</span><span class="s1">startsWith</span><span class="s2">(</span><span class="s3">'--inspect'</span><span class="s2">)) {</span>
      <span class="s0">return </span><span class="s1">arg</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">let </span><span class="s1">debugOption</span><span class="s2">;</span>
    <span class="s0">let </span><span class="s1">debugHost </span><span class="s2">= </span><span class="s3">'127.0.0.1'</span><span class="s2">;</span>
    <span class="s0">let </span><span class="s1">debugPort </span><span class="s2">= </span><span class="s3">'9229'</span><span class="s2">;</span>
    <span class="s0">let </span><span class="s1">match</span><span class="s2">;</span>
    <span class="s0">if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s7">/^(--inspect(-brk)?)$/</span><span class="s2">)) !== </span><span class="s0">null</span><span class="s2">) {</span>
      <span class="s4">// e.g. --inspect</span>
      <span class="s1">debugOption </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s8">1</span><span class="s2">];</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s7">/^(--inspect(-brk|-port)?)=([^:]+)$/</span><span class="s2">)) !== </span><span class="s0">null</span><span class="s2">) {</span>
      <span class="s1">debugOption </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s8">1</span><span class="s2">];</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s7">/^\d+$/</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s8">3</span><span class="s2">])) {</span>
        <span class="s4">// e.g. --inspect=1234</span>
        <span class="s1">debugPort </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s8">3</span><span class="s2">];</span>
      <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
        <span class="s4">// e.g. --inspect=localhost</span>
        <span class="s1">debugHost </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s8">3</span><span class="s2">];</span>
      <span class="s2">}</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s7">/^(--inspect(-brk|-port)?)=([^:]+):(\d+)$/</span><span class="s2">)) !== </span><span class="s0">null</span><span class="s2">) {</span>
      <span class="s4">// e.g. --inspect=localhost:1234</span>
      <span class="s1">debugOption </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s8">1</span><span class="s2">];</span>
      <span class="s1">debugHost </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s8">3</span><span class="s2">];</span>
      <span class="s1">debugPort </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s8">4</span><span class="s2">];</span>
    <span class="s2">}</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">debugOption </span><span class="s2">&amp;&amp; </span><span class="s1">debugPort </span><span class="s2">!== </span><span class="s3">'0'</span><span class="s2">) {</span>
      <span class="s0">return </span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">debugOption</span><span class="s2">}</span><span class="s3">=</span><span class="s1">$</span><span class="s2">{</span><span class="s1">debugHost</span><span class="s2">}</span><span class="s3">:</span><span class="s1">$</span><span class="s2">{</span><span class="s1">parseInt</span><span class="s2">(</span><span class="s1">debugPort</span><span class="s2">) + </span><span class="s8">1</span><span class="s2">}</span><span class="s3">`</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s0">return </span><span class="s1">arg</span><span class="s2">;</span>
  <span class="s2">});</span>
<span class="s2">}</span>

<span class="s5">/**</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Command} startCommand</span>
 <span class="s5">* </span><span class="s6">@returns </span><span class="s5">{Command[]}</span>
 <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
 <span class="s5">*/</span>

<span class="s0">function </span><span class="s1">getCommandAndParents</span><span class="s2">(</span><span class="s1">startCommand</span><span class="s2">) {</span>
  <span class="s0">const </span><span class="s1">result </span><span class="s2">= [];</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">let </span><span class="s1">command </span><span class="s2">= </span><span class="s1">startCommand</span><span class="s2">; </span><span class="s1">command</span><span class="s2">; </span><span class="s1">command </span><span class="s2">= </span><span class="s1">command</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">) {</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">command</span><span class="s2">);</span>
  <span class="s2">}</span>
  <span class="s0">return </span><span class="s1">result</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s1">exports</span><span class="s2">.</span><span class="s1">Command </span><span class="s2">= </span><span class="s1">Command</span><span class="s2">;</span>
</pre>
</body>
</html>