<html>
<head>
<title>ejs.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #67a37c; font-style: italic;}
.s6 { color: #cf8e6d;}
.s7 { color: #42c3d4;}
.s8 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ejs.js</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * EJS Embedded JavaScript templates 
 * Copyright 2112 Matthew Eernisse (mde@fleegix.org) 
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); 
 * you may not use this file except in compliance with the License. 
 * You may obtain a copy of the License at 
 * 
 *         http://www.apache.org/licenses/LICENSE-2.0 
 * 
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, 
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
 * See the License for the specific language governing permissions and 
 * limitations under the License. 
 * 
*/</span>

<span class="s2">'use strict'</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@file </span><span class="s4">Embedded JavaScript templating engine. {</span><span class="s5">@link </span><span class="s4">http://ejs.co}</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Matthew Eernisse &lt;mde@fleegix.org&gt;</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Tiancheng &quot;Timothy&quot; Gu &lt;timothygu99@gmail.com&gt;</span>
 <span class="s4">* </span><span class="s5">@project </span><span class="s4">EJS</span>
 <span class="s4">* </span><span class="s5">@license </span><span class="s4">{</span><span class="s5">@link </span><span class="s4">http://www.apache.org/licenses/LICENSE-2.0 Apache License, Version 2.0}</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* EJS internal functions.</span>
 <span class="s4">*</span>
 <span class="s4">* Technically this &quot;module&quot; lies in the same file as {</span><span class="s5">@link </span><span class="s4">module:ejs}, for</span>
 <span class="s4">* the sake of organization all the private functions re grouped into this</span>
 <span class="s4">* module.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@module </span><span class="s4">ejs-internal</span>
 <span class="s4">* </span><span class="s5">@private</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* Embedded JavaScript templating engine.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@module </span><span class="s4">ejs</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>


<span class="s6">var </span><span class="s1">fs </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'fs'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">path </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'path'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">utils </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./utils'</span><span class="s3">);</span>

<span class="s6">var </span><span class="s1">scopeOptionWarned </span><span class="s3">= </span><span class="s6">false</span><span class="s3">;</span>
<span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */</span>
<span class="s6">var </span><span class="s1">_VERSION_STRING </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'../package.json'</span><span class="s3">).</span><span class="s1">version</span><span class="s3">;</span>
<span class="s6">var </span><span class="s1">_DEFAULT_OPEN_DELIMITER </span><span class="s3">= </span><span class="s2">'&lt;'</span><span class="s3">;</span>
<span class="s6">var </span><span class="s1">_DEFAULT_CLOSE_DELIMITER </span><span class="s3">= </span><span class="s2">'&gt;'</span><span class="s3">;</span>
<span class="s6">var </span><span class="s1">_DEFAULT_DELIMITER </span><span class="s3">= </span><span class="s2">'%'</span><span class="s3">;</span>
<span class="s6">var </span><span class="s1">_DEFAULT_LOCALS_NAME </span><span class="s3">= </span><span class="s2">'locals'</span><span class="s3">;</span>
<span class="s6">var </span><span class="s1">_NAME </span><span class="s3">= </span><span class="s2">'ejs'</span><span class="s3">;</span>
<span class="s6">var </span><span class="s1">_REGEX_STRING </span><span class="s3">= </span><span class="s2">'(&lt;%%|%%&gt;|&lt;%=|&lt;%-|&lt;%_|&lt;%#|&lt;%|%&gt;|-%&gt;|_%&gt;)'</span><span class="s3">;</span>
<span class="s6">var </span><span class="s1">_OPTS_PASSABLE_WITH_DATA </span><span class="s3">= [</span><span class="s2">'delimiter'</span><span class="s3">, </span><span class="s2">'scope'</span><span class="s3">, </span><span class="s2">'context'</span><span class="s3">, </span><span class="s2">'debug'</span><span class="s3">, </span><span class="s2">'compileDebug'</span><span class="s3">,</span>
  <span class="s2">'client'</span><span class="s3">, </span><span class="s2">'_with'</span><span class="s3">, </span><span class="s2">'rmWhitespace'</span><span class="s3">, </span><span class="s2">'strict'</span><span class="s3">, </span><span class="s2">'filename'</span><span class="s3">, </span><span class="s2">'async'</span><span class="s3">];</span>
<span class="s0">// We don't allow 'cache' option to be passed in the data obj for</span>
<span class="s0">// the normal `render` call, but this is where Express 2 &amp; 3 put it</span>
<span class="s0">// so we make an exception for `renderFile`</span>
<span class="s6">var </span><span class="s1">_OPTS_PASSABLE_WITH_DATA_EXPRESS </span><span class="s3">= </span><span class="s1">_OPTS_PASSABLE_WITH_DATA</span><span class="s3">.</span><span class="s1">concat</span><span class="s3">(</span><span class="s2">'cache'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">_BOM </span><span class="s3">= </span><span class="s7">/^\uFEFF/</span><span class="s3">;</span>
<span class="s6">var </span><span class="s1">_JS_IDENTIFIER </span><span class="s3">= </span><span class="s7">/^[a-zA-Z_$][0-9a-zA-Z_$]*$/</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* EJS template function cache. This can be a LRU object from lru-cache NPM</span>
 <span class="s4">* module. By default, it is {</span><span class="s5">@link </span><span class="s4">module:utils.cache}, a simple in-process</span>
 <span class="s4">* cache that grows continuously.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@type </span><span class="s4">{Cache}</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">cache </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">cache</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* Custom file loader. Useful for template preprocessing or restricting access</span>
 <span class="s4">* to a certain part of the filesystem.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@type </span><span class="s4">{fileLoader}</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">fileLoader </span><span class="s3">= </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">readFileSync</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* Name of the object containing the locals.</span>
 <span class="s4">*</span>
 <span class="s4">* This variable is overridden by {</span><span class="s5">@link </span><span class="s4">Options}`.localsName` if it is not</span>
 <span class="s4">* `undefined`.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@type </span><span class="s4">{String}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">localsName </span><span class="s3">= </span><span class="s1">_DEFAULT_LOCALS_NAME</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* Promise implementation -- defaults to the native implementation if available</span>
 <span class="s4">* This is mostly just for testability</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@type </span><span class="s4">{PromiseConstructorLike}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">promiseImpl </span><span class="s3">= (</span><span class="s6">new </span><span class="s1">Function</span><span class="s3">(</span><span class="s2">'return this;'</span><span class="s3">))().</span><span class="s1">Promise</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* Get the path to the included file from the parent file path and the</span>
 <span class="s4">* specified path.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String}  name     specified path</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String}  filename parent file path</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Boolean} [isDir=false] whether the parent file path is a directory</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String}</span>
 <span class="s4">*/</span>
<span class="s1">exports</span><span class="s3">.</span><span class="s1">resolveInclude </span><span class="s3">= </span><span class="s6">function</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s1">isDir</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">dirname </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">extname </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">extname</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">resolve </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">resolve</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">includePath </span><span class="s3">= </span><span class="s1">resolve</span><span class="s3">(</span><span class="s1">isDir </span><span class="s3">? </span><span class="s1">filename </span><span class="s3">: </span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">), </span><span class="s1">name</span><span class="s3">);</span>
  <span class="s6">var </span><span class="s1">ext </span><span class="s3">= </span><span class="s1">extname</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
  <span class="s6">if </span><span class="s3">(!</span><span class="s1">ext</span><span class="s3">) {</span>
    <span class="s1">includePath </span><span class="s3">+= </span><span class="s2">'.ejs'</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s6">return </span><span class="s1">includePath</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* Try to resolve file path on multiple directories</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param  </span><span class="s4">{String}        name  specified path</span>
 <span class="s4">* </span><span class="s5">@param  </span><span class="s4">{Array&lt;String&gt;} paths list of possible parent directory paths</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String}</span>
 <span class="s4">*/</span>
<span class="s6">function </span><span class="s1">resolvePaths</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">paths</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">filePath</span><span class="s3">;</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s1">paths</span><span class="s3">.</span><span class="s1">some</span><span class="s3">(</span><span class="s6">function </span><span class="s3">(</span><span class="s1">v</span><span class="s3">) {</span>
    <span class="s1">filePath </span><span class="s3">= </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">resolveInclude</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s6">true</span><span class="s3">);</span>
    <span class="s6">return </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">existsSync</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">);</span>
  <span class="s3">})) {</span>
    <span class="s6">return </span><span class="s1">filePath</span><span class="s3">;</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s4">/**</span>
 <span class="s4">* Get the path to the included file by Options</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param  </span><span class="s4">{String}  path    specified path</span>
 <span class="s4">* </span><span class="s5">@param  </span><span class="s4">{Options} options compilation options</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String}</span>
 <span class="s4">*/</span>
<span class="s6">function </span><span class="s1">getIncludePath</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">options</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">includePath</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">filePath</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">views </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">views</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">match </span><span class="s3">= </span><span class="s7">/^[A-Za-z]+:\\|^\//</span><span class="s3">.</span><span class="s1">exec</span><span class="s3">(</span><span class="s1">path</span><span class="s3">);</span>

  <span class="s0">// Abs path</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s1">match </span><span class="s3">&amp;&amp; </span><span class="s1">match</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) {</span>
    <span class="s1">path </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/^\/*/</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s1">Array</span><span class="s3">.</span><span class="s1">isArray</span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">root</span><span class="s3">)) {</span>
      <span class="s1">includePath </span><span class="s3">= </span><span class="s1">resolvePaths</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">options</span><span class="s3">.</span><span class="s1">root</span><span class="s3">);</span>
    <span class="s3">} </span><span class="s6">else </span><span class="s3">{</span>
      <span class="s1">includePath </span><span class="s3">= </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">resolveInclude</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">options</span><span class="s3">.</span><span class="s1">root </span><span class="s3">|| </span><span class="s2">'/'</span><span class="s3">, </span><span class="s6">true</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s0">// Relative paths</span>
  <span class="s6">else </span><span class="s3">{</span>
    <span class="s0">// Look relative to a passed filename first</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">) {</span>
      <span class="s1">filePath </span><span class="s3">= </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">resolveInclude</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">options</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">);</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">fs</span><span class="s3">.</span><span class="s1">existsSync</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">)) {</span>
        <span class="s1">includePath </span><span class="s3">= </span><span class="s1">filePath</span><span class="s3">;</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
    <span class="s0">// Then look in any views directories</span>
    <span class="s6">if </span><span class="s3">(!</span><span class="s1">includePath </span><span class="s3">&amp;&amp; </span><span class="s1">Array</span><span class="s3">.</span><span class="s1">isArray</span><span class="s3">(</span><span class="s1">views</span><span class="s3">)) {</span>
      <span class="s1">includePath </span><span class="s3">= </span><span class="s1">resolvePaths</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">views</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s6">if </span><span class="s3">(!</span><span class="s1">includePath </span><span class="s3">&amp;&amp; </span><span class="s6">typeof </span><span class="s1">options</span><span class="s3">.</span><span class="s1">includer </span><span class="s3">!== </span><span class="s2">'function'</span><span class="s3">) {</span>
      <span class="s6">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'Could not find the include file &quot;' </span><span class="s3">+</span>
          <span class="s1">options</span><span class="s3">.</span><span class="s1">escapeFunction</span><span class="s3">(</span><span class="s1">path</span><span class="s3">) + </span><span class="s2">'&quot;'</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s6">return </span><span class="s1">includePath</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s4">/**</span>
 <span class="s4">* Get the template from a string or a file, either compiled on-the-fly or</span>
 <span class="s4">* read from cache (if enabled), and cache the template if needed.</span>
 <span class="s4">*</span>
 <span class="s4">* If `template` is not set, the file specified in `options.filename` will be</span>
 <span class="s4">* read.</span>
 <span class="s4">*</span>
 <span class="s4">* If `options.cache` is true, this function reads the file from</span>
 <span class="s4">* `options.filename` so it must be set prior to calling this function.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@memberof </span><span class="s4">module:ejs-internal</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Options} options   compilation options</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} [template] template source</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{(TemplateFunction|ClientFunction)}</span>
 <span class="s4">* Depending on the value of `options.client`, either type might be returned.</span>
 <span class="s4">* </span><span class="s5">@static</span>
 <span class="s4">*/</span>

<span class="s6">function </span><span class="s1">handleCache</span><span class="s3">(</span><span class="s1">options</span><span class="s3">, </span><span class="s1">template</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">func</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">filename </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">hasTemplate </span><span class="s3">= </span><span class="s1">arguments</span><span class="s3">.</span><span class="s1">length </span><span class="s3">&gt; </span><span class="s8">1</span><span class="s3">;</span>

  <span class="s6">if </span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">cache</span><span class="s3">) {</span>
    <span class="s6">if </span><span class="s3">(!</span><span class="s1">filename</span><span class="s3">) {</span>
      <span class="s6">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'cache option requires a filename'</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s1">func </span><span class="s3">= </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">cache</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">);</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s1">func</span><span class="s3">) {</span>
      <span class="s6">return </span><span class="s1">func</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s6">if </span><span class="s3">(!</span><span class="s1">hasTemplate</span><span class="s3">) {</span>
      <span class="s1">template </span><span class="s3">= </span><span class="s1">fileLoader</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">).</span><span class="s1">toString</span><span class="s3">().</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">_BOM</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s6">else if </span><span class="s3">(!</span><span class="s1">hasTemplate</span><span class="s3">) {</span>
    <span class="s0">// istanbul ignore if: should not happen at all</span>
    <span class="s6">if </span><span class="s3">(!</span><span class="s1">filename</span><span class="s3">) {</span>
      <span class="s6">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'Internal EJS error: no file name or template '</span>
                    <span class="s3">+ </span><span class="s2">'provided'</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s1">template </span><span class="s3">= </span><span class="s1">fileLoader</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">).</span><span class="s1">toString</span><span class="s3">().</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">_BOM</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s1">func </span><span class="s3">= </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s1">template</span><span class="s3">, </span><span class="s1">options</span><span class="s3">);</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">cache</span><span class="s3">) {</span>
    <span class="s1">exports</span><span class="s3">.</span><span class="s1">cache</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">func</span><span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s6">return </span><span class="s1">func</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s4">/**</span>
 <span class="s4">* Try calling handleCache with the given options and data and call the</span>
 <span class="s4">* callback with the result. If an error occurs, call the callback with</span>
 <span class="s4">* the error. Used by renderFile().</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@memberof </span><span class="s4">module:ejs-internal</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Options} options    compilation options</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Object} data        template data</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{RenderFileCallback} cb callback</span>
 <span class="s4">* </span><span class="s5">@static</span>
 <span class="s4">*/</span>

<span class="s6">function </span><span class="s1">tryHandleCache</span><span class="s3">(</span><span class="s1">options</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">result</span><span class="s3">;</span>
  <span class="s6">if </span><span class="s3">(!</span><span class="s1">cb</span><span class="s3">) {</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s6">typeof </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">promiseImpl </span><span class="s3">== </span><span class="s2">'function'</span><span class="s3">) {</span>
      <span class="s6">return new </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">promiseImpl</span><span class="s3">(</span><span class="s6">function </span><span class="s3">(</span><span class="s1">resolve</span><span class="s3">, </span><span class="s1">reject</span><span class="s3">) {</span>
        <span class="s6">try </span><span class="s3">{</span>
          <span class="s1">result </span><span class="s3">= </span><span class="s1">handleCache</span><span class="s3">(</span><span class="s1">options</span><span class="s3">)(</span><span class="s1">data</span><span class="s3">);</span>
          <span class="s1">resolve</span><span class="s3">(</span><span class="s1">result</span><span class="s3">);</span>
        <span class="s3">}</span>
        <span class="s6">catch </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
          <span class="s1">reject</span><span class="s3">(</span><span class="s1">err</span><span class="s3">);</span>
        <span class="s3">}</span>
      <span class="s3">});</span>
    <span class="s3">}</span>
    <span class="s6">else </span><span class="s3">{</span>
      <span class="s6">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'Please provide a callback function'</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s6">else </span><span class="s3">{</span>
    <span class="s6">try </span><span class="s3">{</span>
      <span class="s1">result </span><span class="s3">= </span><span class="s1">handleCache</span><span class="s3">(</span><span class="s1">options</span><span class="s3">)(</span><span class="s1">data</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s6">catch </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
      <span class="s6">return </span><span class="s1">cb</span><span class="s3">(</span><span class="s1">err</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s1">cb</span><span class="s3">(</span><span class="s6">null</span><span class="s3">, </span><span class="s1">result</span><span class="s3">);</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s4">/**</span>
 <span class="s4">* fileLoader is independent</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} filePath ejs file path.</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String} The contents of the specified file.</span>
 <span class="s4">* </span><span class="s5">@static</span>
 <span class="s4">*/</span>

<span class="s6">function </span><span class="s1">fileLoader</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">){</span>
  <span class="s6">return </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">fileLoader</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s4">/**</span>
 <span class="s4">* Get the template function.</span>
 <span class="s4">*</span>
 <span class="s4">* If `options.cache` is `true`, then the template is cached.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@memberof </span><span class="s4">module:ejs-internal</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String}  path    path for the specified file</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Options} options compilation options</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{(TemplateFunction|ClientFunction)}</span>
 <span class="s4">* Depending on the value of `options.client`, either type might be returned</span>
 <span class="s4">* </span><span class="s5">@static</span>
 <span class="s4">*/</span>

<span class="s6">function </span><span class="s1">includeFile</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">options</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">opts </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">shallowCopy</span><span class="s3">(</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">createNullProtoObjWherePossible</span><span class="s3">(), </span><span class="s1">options</span><span class="s3">);</span>
  <span class="s1">opts</span><span class="s3">.</span><span class="s1">filename </span><span class="s3">= </span><span class="s1">getIncludePath</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">);</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s6">typeof </span><span class="s1">options</span><span class="s3">.</span><span class="s1">includer </span><span class="s3">=== </span><span class="s2">'function'</span><span class="s3">) {</span>
    <span class="s6">var </span><span class="s1">includerResult </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">includer</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">);</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s1">includerResult</span><span class="s3">) {</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">includerResult</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">) {</span>
        <span class="s1">opts</span><span class="s3">.</span><span class="s1">filename </span><span class="s3">= </span><span class="s1">includerResult</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">;</span>
      <span class="s3">}</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">includerResult</span><span class="s3">.</span><span class="s1">template</span><span class="s3">) {</span>
        <span class="s6">return </span><span class="s1">handleCache</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">, </span><span class="s1">includerResult</span><span class="s3">.</span><span class="s1">template</span><span class="s3">);</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s6">return </span><span class="s1">handleCache</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s4">/**</span>
 <span class="s4">* Re-throw the given `err` in context to the `str` of ejs, `filename`, and</span>
 <span class="s4">* `lineno`.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@implements </span><span class="s4">{RethrowCallback}</span>
 <span class="s4">* </span><span class="s5">@memberof </span><span class="s4">module:ejs-internal</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Error}  err      Error object</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} str      EJS source</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} flnm     file name of the EJS file</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Number} lineno   line number of the error</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{EscapeCallback} esc</span>
 <span class="s4">* </span><span class="s5">@static</span>
 <span class="s4">*/</span>

<span class="s6">function </span><span class="s1">rethrow</span><span class="s3">(</span><span class="s1">err</span><span class="s3">, </span><span class="s1">str</span><span class="s3">, </span><span class="s1">flnm</span><span class="s3">, </span><span class="s1">lineno</span><span class="s3">, </span><span class="s1">esc</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">lines </span><span class="s3">= </span><span class="s1">str</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">);</span>
  <span class="s6">var </span><span class="s1">start </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">lineno </span><span class="s3">- </span><span class="s8">3</span><span class="s3">, </span><span class="s8">0</span><span class="s3">);</span>
  <span class="s6">var </span><span class="s1">end </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">.</span><span class="s1">length</span><span class="s3">, </span><span class="s1">lineno </span><span class="s3">+ </span><span class="s8">3</span><span class="s3">);</span>
  <span class="s6">var </span><span class="s1">filename </span><span class="s3">= </span><span class="s1">esc</span><span class="s3">(</span><span class="s1">flnm</span><span class="s3">);</span>
  <span class="s0">// Error context</span>
  <span class="s6">var </span><span class="s1">context </span><span class="s3">= </span><span class="s1">lines</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">).</span><span class="s1">map</span><span class="s3">(</span><span class="s6">function </span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s1">i</span><span class="s3">){</span>
    <span class="s6">var </span><span class="s1">curr </span><span class="s3">= </span><span class="s1">i </span><span class="s3">+ </span><span class="s1">start </span><span class="s3">+ </span><span class="s8">1</span><span class="s3">;</span>
    <span class="s6">return </span><span class="s3">(</span><span class="s1">curr </span><span class="s3">== </span><span class="s1">lineno </span><span class="s3">? </span><span class="s2">' &gt;&gt; ' </span><span class="s3">: </span><span class="s2">'    '</span><span class="s3">)</span>
      <span class="s3">+ </span><span class="s1">curr</span>
      <span class="s3">+ </span><span class="s2">'| '</span>
      <span class="s3">+ </span><span class="s1">line</span><span class="s3">;</span>
  <span class="s3">}).</span><span class="s1">join</span><span class="s3">(</span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">);</span>

  <span class="s0">// Alter exception message</span>
  <span class="s1">err</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">filename</span><span class="s3">;</span>
  <span class="s1">err</span><span class="s3">.</span><span class="s1">message </span><span class="s3">= (</span><span class="s1">filename </span><span class="s3">|| </span><span class="s2">'ejs'</span><span class="s3">) + </span><span class="s2">':'</span>
    <span class="s3">+ </span><span class="s1">lineno </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
    <span class="s3">+ </span><span class="s1">context </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n\n</span><span class="s2">'</span>
    <span class="s3">+ </span><span class="s1">err</span><span class="s3">.</span><span class="s1">message</span><span class="s3">;</span>

  <span class="s6">throw </span><span class="s1">err</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s6">function </span><span class="s1">stripSemi</span><span class="s3">(</span><span class="s1">str</span><span class="s3">){</span>
  <span class="s6">return </span><span class="s1">str</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/;(\s*$)/</span><span class="s3">, </span><span class="s2">'$1'</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s4">/**</span>
 <span class="s4">* Compile the given `str` of ejs into a template function.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String}  template EJS template</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Options} [opts] compilation options</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{(TemplateFunction|ClientFunction)}</span>
 <span class="s4">* Depending on the value of `opts.client`, either type might be returned.</span>
 <span class="s4">* Note that the return type of the function also depends on the value of `opts.async`.</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">compile </span><span class="s3">= </span><span class="s6">function </span><span class="s1">compile</span><span class="s3">(</span><span class="s1">template</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">templ</span><span class="s3">;</span>

  <span class="s0">// v1 compat</span>
  <span class="s0">// 'scope' is 'context'</span>
  <span class="s0">// FIXME: Remove this in a future version</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s1">opts </span><span class="s3">&amp;&amp; </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">scope</span><span class="s3">) {</span>
    <span class="s6">if </span><span class="s3">(!</span><span class="s1">scopeOptionWarned</span><span class="s3">){</span>
      <span class="s1">console</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s2">'`scope` option is deprecated and will be removed in EJS 3'</span><span class="s3">);</span>
      <span class="s1">scopeOptionWarned </span><span class="s3">= </span><span class="s6">true</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s6">if </span><span class="s3">(!</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">context</span><span class="s3">) {</span>
      <span class="s1">opts</span><span class="s3">.</span><span class="s1">context </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">scope</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s6">delete </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">scope</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s1">templ </span><span class="s3">= </span><span class="s6">new </span><span class="s1">Template</span><span class="s3">(</span><span class="s1">template</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">);</span>
  <span class="s6">return </span><span class="s1">templ</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">();</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* Render the given `template` of ejs.</span>
 <span class="s4">*</span>
 <span class="s4">* If you would like to include options but not data, you need to explicitly</span>
 <span class="s4">* call this function with `data` being an empty object or `null`.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String}   template EJS template</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Object}  [data={}] template data</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Options} [opts={}] compilation and rendering options</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{(String|Promise&lt;String&gt;)}</span>
 <span class="s4">* Return value type depends on `opts.async`.</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">render </span><span class="s3">= </span><span class="s6">function </span><span class="s3">(</span><span class="s1">template</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">o</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">data </span><span class="s3">= </span><span class="s1">d </span><span class="s3">|| </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">createNullProtoObjWherePossible</span><span class="s3">();</span>
  <span class="s6">var </span><span class="s1">opts </span><span class="s3">= </span><span class="s1">o </span><span class="s3">|| </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">createNullProtoObjWherePossible</span><span class="s3">();</span>

  <span class="s0">// No options object -- if there are optiony names</span>
  <span class="s0">// in the data, copy them to options</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s1">arguments</span><span class="s3">.</span><span class="s1">length </span><span class="s3">== </span><span class="s8">2</span><span class="s3">) {</span>
    <span class="s1">utils</span><span class="s3">.</span><span class="s1">shallowCopyFromList</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">_OPTS_PASSABLE_WITH_DATA</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s6">return </span><span class="s1">handleCache</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">, </span><span class="s1">template</span><span class="s3">)(</span><span class="s1">data</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* Render an EJS file at the given `path` and callback `cb(err, str)`.</span>
 <span class="s4">*</span>
 <span class="s4">* If you would like to include options but not data, you need to explicitly</span>
 <span class="s4">* call this function with `data` being an empty object or `null`.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String}             path     path to the EJS file</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Object}            [data={}] template data</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Options}           [opts={}] compilation and rendering options</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{RenderFileCallback} cb callback</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">renderFile </span><span class="s3">= </span><span class="s6">function </span><span class="s3">() {</span>
  <span class="s6">var </span><span class="s1">args </span><span class="s3">= </span><span class="s1">Array</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">arguments</span><span class="s3">);</span>
  <span class="s6">var </span><span class="s1">filename </span><span class="s3">= </span><span class="s1">args</span><span class="s3">.</span><span class="s1">shift</span><span class="s3">();</span>
  <span class="s6">var </span><span class="s1">cb</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">opts </span><span class="s3">= {</span><span class="s1">filename</span><span class="s3">: </span><span class="s1">filename</span><span class="s3">};</span>
  <span class="s6">var </span><span class="s1">data</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">viewOpts</span><span class="s3">;</span>

  <span class="s0">// Do we have a callback?</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s6">typeof </span><span class="s1">arguments</span><span class="s3">[</span><span class="s1">arguments</span><span class="s3">.</span><span class="s1">length </span><span class="s3">- </span><span class="s8">1</span><span class="s3">] == </span><span class="s2">'function'</span><span class="s3">) {</span>
    <span class="s1">cb </span><span class="s3">= </span><span class="s1">args</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">();</span>
  <span class="s3">}</span>
  <span class="s0">// Do we have data/opts?</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s1">args</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) {</span>
    <span class="s0">// Should always have data obj</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s1">args</span><span class="s3">.</span><span class="s1">shift</span><span class="s3">();</span>
    <span class="s0">// Normal passed opts (data obj + opts obj)</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s1">args</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) {</span>
      <span class="s0">// Use shallowCopy so we don't pollute passed in opts obj with new vals</span>
      <span class="s1">utils</span><span class="s3">.</span><span class="s1">shallowCopy</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">, </span><span class="s1">args</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">());</span>
    <span class="s3">}</span>
    <span class="s0">// Special casing for Express (settings + opts-in-data)</span>
    <span class="s6">else </span><span class="s3">{</span>
      <span class="s0">// Express 3 and 4</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">) {</span>
        <span class="s0">// Pull a few things from known locations</span>
        <span class="s6">if </span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">.</span><span class="s1">views</span><span class="s3">) {</span>
          <span class="s1">opts</span><span class="s3">.</span><span class="s1">views </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">.</span><span class="s1">views</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s6">if </span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">[</span><span class="s2">'view cache'</span><span class="s3">]) {</span>
          <span class="s1">opts</span><span class="s3">.</span><span class="s1">cache </span><span class="s3">= </span><span class="s6">true</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s0">// Undocumented after Express 2, but still usable, esp. for</span>
        <span class="s0">// items that are unsafe to be passed along with data, like `root`</span>
        <span class="s1">viewOpts </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">[</span><span class="s2">'view options'</span><span class="s3">];</span>
        <span class="s6">if </span><span class="s3">(</span><span class="s1">viewOpts</span><span class="s3">) {</span>
          <span class="s1">utils</span><span class="s3">.</span><span class="s1">shallowCopy</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">, </span><span class="s1">viewOpts</span><span class="s3">);</span>
        <span class="s3">}</span>
      <span class="s3">}</span>
      <span class="s0">// Express 2 and lower, values set in app.locals, or people who just</span>
      <span class="s0">// want to pass options in their data. NOTE: These values will override</span>
      <span class="s0">// anything previously set in settings  or settings['view options']</span>
      <span class="s1">utils</span><span class="s3">.</span><span class="s1">shallowCopyFromList</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">_OPTS_PASSABLE_WITH_DATA_EXPRESS</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s1">opts</span><span class="s3">.</span><span class="s1">filename </span><span class="s3">= </span><span class="s1">filename</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s6">else </span><span class="s3">{</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">createNullProtoObjWherePossible</span><span class="s3">();</span>
  <span class="s3">}</span>

  <span class="s6">return </span><span class="s1">tryHandleCache</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* Clear intermediate JavaScript cache. Calls {</span><span class="s5">@link </span><span class="s4">Cache#reset}.</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* EJS template class</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>
<span class="s1">exports</span><span class="s3">.</span><span class="s1">Template </span><span class="s3">= </span><span class="s1">Template</span><span class="s3">;</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">clearCache </span><span class="s3">= </span><span class="s6">function </span><span class="s3">() {</span>
  <span class="s1">exports</span><span class="s3">.</span><span class="s1">cache</span><span class="s3">.</span><span class="s1">reset</span><span class="s3">();</span>
<span class="s3">};</span>

<span class="s6">function </span><span class="s1">Template</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">optsParam</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">opts </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">hasOwnOnlyObject</span><span class="s3">(</span><span class="s1">optsParam</span><span class="s3">);</span>
  <span class="s6">var </span><span class="s1">options </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">createNullProtoObjWherePossible</span><span class="s3">();</span>
  <span class="s6">this</span><span class="s3">.</span><span class="s1">templateText </span><span class="s3">= </span><span class="s1">text</span><span class="s3">;</span>
  <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string | null} */</span>
  <span class="s6">this</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s6">null</span><span class="s3">;</span>
  <span class="s6">this</span><span class="s3">.</span><span class="s1">truncate </span><span class="s3">= </span><span class="s6">false</span><span class="s3">;</span>
  <span class="s6">this</span><span class="s3">.</span><span class="s1">currentLine </span><span class="s3">= </span><span class="s8">1</span><span class="s3">;</span>
  <span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">= </span><span class="s2">''</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">client </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">client </span><span class="s3">|| </span><span class="s6">false</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">escapeFunction </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">escape </span><span class="s3">|| </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">escapeFunction </span><span class="s3">|| </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">escapeXML</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">compileDebug </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">compileDebug </span><span class="s3">!== </span><span class="s6">false</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">debug </span><span class="s3">= !!</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">filename </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">openDelimiter </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">openDelimiter </span><span class="s3">|| </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">openDelimiter </span><span class="s3">|| </span><span class="s1">_DEFAULT_OPEN_DELIMITER</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">closeDelimiter </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">closeDelimiter </span><span class="s3">|| </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">closeDelimiter </span><span class="s3">|| </span><span class="s1">_DEFAULT_CLOSE_DELIMITER</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">delimiter </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">delimiter </span><span class="s3">|| </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">delimiter </span><span class="s3">|| </span><span class="s1">_DEFAULT_DELIMITER</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">strict </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">strict </span><span class="s3">|| </span><span class="s6">false</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">context </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">context</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">cache </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">cache </span><span class="s3">|| </span><span class="s6">false</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">rmWhitespace </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">rmWhitespace</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">root </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">root</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">includer </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">includer</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">outputFunctionName </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">outputFunctionName</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">localsName </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">localsName </span><span class="s3">|| </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">localsName </span><span class="s3">|| </span><span class="s1">_DEFAULT_LOCALS_NAME</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">views </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">views</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">async </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">async</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">destructuredLocals </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">destructuredLocals</span><span class="s3">;</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">legacyInclude </span><span class="s3">= </span><span class="s6">typeof </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">legacyInclude </span><span class="s3">!= </span><span class="s2">'undefined' </span><span class="s3">? !!</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">legacyInclude </span><span class="s3">: </span><span class="s6">true</span><span class="s3">;</span>

  <span class="s6">if </span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">strict</span><span class="s3">) {</span>
    <span class="s1">options</span><span class="s3">.</span><span class="s1">_with </span><span class="s3">= </span><span class="s6">false</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s6">else </span><span class="s3">{</span>
    <span class="s1">options</span><span class="s3">.</span><span class="s1">_with </span><span class="s3">= </span><span class="s6">typeof </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">_with </span><span class="s3">!= </span><span class="s2">'undefined' </span><span class="s3">? </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">_with </span><span class="s3">: </span><span class="s6">true</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s6">this</span><span class="s3">.</span><span class="s1">opts </span><span class="s3">= </span><span class="s1">options</span><span class="s3">;</span>

  <span class="s6">this</span><span class="s3">.</span><span class="s1">regex </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">createRegex</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s1">Template</span><span class="s3">.</span><span class="s1">modes </span><span class="s3">= {</span>
  <span class="s1">EVAL</span><span class="s3">: </span><span class="s2">'eval'</span><span class="s3">,</span>
  <span class="s1">ESCAPED</span><span class="s3">: </span><span class="s2">'escaped'</span><span class="s3">,</span>
  <span class="s1">RAW</span><span class="s3">: </span><span class="s2">'raw'</span><span class="s3">,</span>
  <span class="s1">COMMENT</span><span class="s3">: </span><span class="s2">'comment'</span><span class="s3">,</span>
  <span class="s1">LITERAL</span><span class="s3">: </span><span class="s2">'literal'</span>
<span class="s3">};</span>

<span class="s1">Template</span><span class="s3">.</span><span class="s1">prototype </span><span class="s3">= {</span>
  <span class="s1">createRegex</span><span class="s3">: </span><span class="s6">function </span><span class="s3">() {</span>
    <span class="s6">var </span><span class="s1">str </span><span class="s3">= </span><span class="s1">_REGEX_STRING</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">delim </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">escapeRegExpChars</span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">delimiter</span><span class="s3">);</span>
    <span class="s6">var </span><span class="s1">open </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">escapeRegExpChars</span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">openDelimiter</span><span class="s3">);</span>
    <span class="s6">var </span><span class="s1">close </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">escapeRegExpChars</span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">closeDelimiter</span><span class="s3">);</span>
    <span class="s1">str </span><span class="s3">= </span><span class="s1">str</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/%/g</span><span class="s3">, </span><span class="s1">delim</span><span class="s3">)</span>
      <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/&lt;/g</span><span class="s3">, </span><span class="s1">open</span><span class="s3">)</span>
      <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/&gt;/g</span><span class="s3">, </span><span class="s1">close</span><span class="s3">);</span>
    <span class="s6">return new </span><span class="s1">RegExp</span><span class="s3">(</span><span class="s1">str</span><span class="s3">);</span>
  <span class="s3">},</span>

  <span class="s1">compile</span><span class="s3">: </span><span class="s6">function </span><span class="s3">() {</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */</span>
    <span class="s6">var </span><span class="s1">src</span><span class="s3">;</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientFunction} */</span>
    <span class="s6">var </span><span class="s1">fn</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">opts </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">prepended </span><span class="s3">= </span><span class="s2">''</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">appended </span><span class="s3">= </span><span class="s2">''</span><span class="s3">;</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{EscapeCallback} */</span>
    <span class="s6">var </span><span class="s1">escapeFn </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">escapeFunction</span><span class="s3">;</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{FunctionConstructor} */</span>
    <span class="s6">var </span><span class="s1">ctor</span><span class="s3">;</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */</span>
    <span class="s6">var </span><span class="s1">sanitizedFilename </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">filename </span><span class="s3">? </span><span class="s1">JSON</span><span class="s3">.</span><span class="s1">stringify</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">) : </span><span class="s2">'undefined'</span><span class="s3">;</span>

    <span class="s6">if </span><span class="s3">(!</span><span class="s6">this</span><span class="s3">.</span><span class="s1">source</span><span class="s3">) {</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">generateSource</span><span class="s3">();</span>
      <span class="s1">prepended </span><span class="s3">+=</span>
        <span class="s2">'  var __output = &quot;&quot;;</span><span class="s6">\n</span><span class="s2">' </span><span class="s3">+</span>
        <span class="s2">'  function __append(s) { if (s !== undefined &amp;&amp; s !== null) __output += s }</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">outputFunctionName</span><span class="s3">) {</span>
        <span class="s6">if </span><span class="s3">(!</span><span class="s1">_JS_IDENTIFIER</span><span class="s3">.</span><span class="s1">test</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">outputFunctionName</span><span class="s3">)) {</span>
          <span class="s6">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'outputFunctionName is not a valid JS identifier.'</span><span class="s3">);</span>
        <span class="s3">}</span>
        <span class="s1">prepended </span><span class="s3">+= </span><span class="s2">'  var ' </span><span class="s3">+ </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">outputFunctionName </span><span class="s3">+ </span><span class="s2">' = __append;' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
      <span class="s3">}</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">localsName </span><span class="s3">&amp;&amp; !</span><span class="s1">_JS_IDENTIFIER</span><span class="s3">.</span><span class="s1">test</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">localsName</span><span class="s3">)) {</span>
        <span class="s6">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'localsName is not a valid JS identifier.'</span><span class="s3">);</span>
      <span class="s3">}</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">destructuredLocals </span><span class="s3">&amp;&amp; </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">destructuredLocals</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) {</span>
        <span class="s6">var </span><span class="s1">destructuring </span><span class="s3">= </span><span class="s2">'  var __locals = (' </span><span class="s3">+ </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">localsName </span><span class="s3">+ </span><span class="s2">' || {}),</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
        <span class="s6">for </span><span class="s3">(</span><span class="s6">var </span><span class="s1">i </span><span class="s3">= </span><span class="s8">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">destructuredLocals</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++) {</span>
          <span class="s6">var </span><span class="s1">name </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">destructuredLocals</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
          <span class="s6">if </span><span class="s3">(!</span><span class="s1">_JS_IDENTIFIER</span><span class="s3">.</span><span class="s1">test</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)) {</span>
            <span class="s6">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'destructuredLocals[' </span><span class="s3">+ </span><span class="s1">i </span><span class="s3">+ </span><span class="s2">'] is not a valid JS identifier.'</span><span class="s3">);</span>
          <span class="s3">}</span>
          <span class="s6">if </span><span class="s3">(</span><span class="s1">i </span><span class="s3">&gt; </span><span class="s8">0</span><span class="s3">) {</span>
            <span class="s1">destructuring </span><span class="s3">+= </span><span class="s2">',</span><span class="s6">\n  </span><span class="s2">'</span><span class="s3">;</span>
          <span class="s3">}</span>
          <span class="s1">destructuring </span><span class="s3">+= </span><span class="s1">name </span><span class="s3">+ </span><span class="s2">' = __locals.' </span><span class="s3">+ </span><span class="s1">name</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s1">prepended </span><span class="s3">+= </span><span class="s1">destructuring </span><span class="s3">+ </span><span class="s2">';</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
      <span class="s3">}</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">_with </span><span class="s3">!== </span><span class="s6">false</span><span class="s3">) {</span>
        <span class="s1">prepended </span><span class="s3">+=  </span><span class="s2">'  with (' </span><span class="s3">+ </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">localsName </span><span class="s3">+ </span><span class="s2">' || {}) {' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
        <span class="s1">appended </span><span class="s3">+= </span><span class="s2">'  }' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
      <span class="s3">}</span>
      <span class="s1">appended </span><span class="s3">+= </span><span class="s2">'  return __output;' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">= </span><span class="s1">prepended </span><span class="s3">+ </span><span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">+ </span><span class="s1">appended</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">compileDebug</span><span class="s3">) {</span>
      <span class="s1">src </span><span class="s3">= </span><span class="s2">'var __line = 1' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
        <span class="s3">+ </span><span class="s2">'  , __lines = ' </span><span class="s3">+ </span><span class="s1">JSON</span><span class="s3">.</span><span class="s1">stringify</span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">templateText</span><span class="s3">) + </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
        <span class="s3">+ </span><span class="s2">'  , __filename = ' </span><span class="s3">+ </span><span class="s1">sanitizedFilename </span><span class="s3">+ </span><span class="s2">';' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
        <span class="s3">+ </span><span class="s2">'try {' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
        <span class="s3">+ </span><span class="s6">this</span><span class="s3">.</span><span class="s1">source</span>
        <span class="s3">+ </span><span class="s2">'} catch (e) {' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
        <span class="s3">+ </span><span class="s2">'  rethrow(e, __lines, __filename, __line, escapeFn);' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
        <span class="s3">+ </span><span class="s2">'}' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s6">else </span><span class="s3">{</span>
      <span class="s1">src </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">source</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">client</span><span class="s3">) {</span>
      <span class="s1">src </span><span class="s3">= </span><span class="s2">'escapeFn = escapeFn || ' </span><span class="s3">+ </span><span class="s1">escapeFn</span><span class="s3">.</span><span class="s1">toString</span><span class="s3">() + </span><span class="s2">';' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">' </span><span class="s3">+ </span><span class="s1">src</span><span class="s3">;</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">compileDebug</span><span class="s3">) {</span>
        <span class="s1">src </span><span class="s3">= </span><span class="s2">'rethrow = rethrow || ' </span><span class="s3">+ </span><span class="s1">rethrow</span><span class="s3">.</span><span class="s1">toString</span><span class="s3">() + </span><span class="s2">';' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">' </span><span class="s3">+ </span><span class="s1">src</span><span class="s3">;</span>
      <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">strict</span><span class="s3">) {</span>
      <span class="s1">src </span><span class="s3">= </span><span class="s2">'&quot;use strict&quot;;</span><span class="s6">\n</span><span class="s2">' </span><span class="s3">+ </span><span class="s1">src</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">) {</span>
      <span class="s1">console</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">src</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">compileDebug </span><span class="s3">&amp;&amp; </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">) {</span>
      <span class="s1">src </span><span class="s3">= </span><span class="s1">src </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
        <span class="s3">+ </span><span class="s2">'//# sourceURL=' </span><span class="s3">+ </span><span class="s1">sanitizedFilename </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s6">try </span><span class="s3">{</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">async</span><span class="s3">) {</span>
        <span class="s0">// Have to use generated function for this, since in envs without support,</span>
        <span class="s0">// it breaks in parsing</span>
        <span class="s6">try </span><span class="s3">{</span>
          <span class="s1">ctor </span><span class="s3">= (</span><span class="s6">new </span><span class="s1">Function</span><span class="s3">(</span><span class="s2">'return (async function(){}).constructor;'</span><span class="s3">))();</span>
        <span class="s3">}</span>
        <span class="s6">catch</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
          <span class="s6">if </span><span class="s3">(</span><span class="s1">e </span><span class="s6">instanceof </span><span class="s1">SyntaxError</span><span class="s3">) {</span>
            <span class="s6">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'This environment does not support async/await'</span><span class="s3">);</span>
          <span class="s3">}</span>
          <span class="s6">else </span><span class="s3">{</span>
            <span class="s6">throw </span><span class="s1">e</span><span class="s3">;</span>
          <span class="s3">}</span>
        <span class="s3">}</span>
      <span class="s3">}</span>
      <span class="s6">else </span><span class="s3">{</span>
        <span class="s1">ctor </span><span class="s3">= </span><span class="s1">Function</span><span class="s3">;</span>
      <span class="s3">}</span>
      <span class="s1">fn </span><span class="s3">= </span><span class="s6">new </span><span class="s1">ctor</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">localsName </span><span class="s3">+ </span><span class="s2">', escapeFn, include, rethrow'</span><span class="s3">, </span><span class="s1">src</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s6">catch</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
      <span class="s0">// istanbul ignore else</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s1">e </span><span class="s6">instanceof </span><span class="s1">SyntaxError</span><span class="s3">) {</span>
        <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">) {</span>
          <span class="s1">e</span><span class="s3">.</span><span class="s1">message </span><span class="s3">+= </span><span class="s2">' in ' </span><span class="s3">+ </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s1">e</span><span class="s3">.</span><span class="s1">message </span><span class="s3">+= </span><span class="s2">' while compiling ejs</span><span class="s6">\n\n</span><span class="s2">'</span><span class="s3">;</span>
        <span class="s1">e</span><span class="s3">.</span><span class="s1">message </span><span class="s3">+= </span><span class="s2">'If the above error is not helpful, you may want to try EJS-Lint:</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
        <span class="s1">e</span><span class="s3">.</span><span class="s1">message </span><span class="s3">+= </span><span class="s2">'https://github.com/RyanZim/EJS-Lint'</span><span class="s3">;</span>
        <span class="s6">if </span><span class="s3">(!</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">async</span><span class="s3">) {</span>
          <span class="s1">e</span><span class="s3">.</span><span class="s1">message </span><span class="s3">+= </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
          <span class="s1">e</span><span class="s3">.</span><span class="s1">message </span><span class="s3">+= </span><span class="s2">'Or, if you meant to create an async function, pass `async: true` as an option.'</span><span class="s3">;</span>
        <span class="s3">}</span>
      <span class="s3">}</span>
      <span class="s6">throw </span><span class="s1">e</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// Return a callable function which will execute the function</span>
    <span class="s0">// created by the source-code, with the passed data as locals</span>
    <span class="s0">// Adds a local `include` function which allows full recursive include</span>
    <span class="s6">var </span><span class="s1">returnedFn </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">client </span><span class="s3">? </span><span class="s1">fn </span><span class="s3">: </span><span class="s6">function </span><span class="s1">anonymous</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) {</span>
      <span class="s6">var </span><span class="s1">include </span><span class="s3">= </span><span class="s6">function </span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">includeData</span><span class="s3">) {</span>
        <span class="s6">var </span><span class="s1">d </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">shallowCopy</span><span class="s3">(</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">createNullProtoObjWherePossible</span><span class="s3">(), </span><span class="s1">data</span><span class="s3">);</span>
        <span class="s6">if </span><span class="s3">(</span><span class="s1">includeData</span><span class="s3">) {</span>
          <span class="s1">d </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">shallowCopy</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">includeData</span><span class="s3">);</span>
        <span class="s3">}</span>
        <span class="s6">return </span><span class="s1">includeFile</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">)(</span><span class="s1">d</span><span class="s3">);</span>
      <span class="s3">};</span>
      <span class="s6">return </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">context</span><span class="s3">,</span>
        <span class="s3">[</span><span class="s1">data </span><span class="s3">|| </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">createNullProtoObjWherePossible</span><span class="s3">(), </span><span class="s1">escapeFn</span><span class="s3">, </span><span class="s1">include</span><span class="s3">, </span><span class="s1">rethrow</span><span class="s3">]);</span>
    <span class="s3">};</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">filename </span><span class="s3">&amp;&amp; </span><span class="s6">typeof </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty </span><span class="s3">=== </span><span class="s2">'function'</span><span class="s3">) {</span>
      <span class="s6">var </span><span class="s1">filename </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">;</span>
      <span class="s6">var </span><span class="s1">basename </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">path</span><span class="s3">.</span><span class="s1">extname</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">));</span>
      <span class="s6">try </span><span class="s3">{</span>
        <span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">returnedFn</span><span class="s3">, </span><span class="s2">'name'</span><span class="s3">, {</span>
          <span class="s1">value</span><span class="s3">: </span><span class="s1">basename</span><span class="s3">,</span>
          <span class="s1">writable</span><span class="s3">: </span><span class="s6">false</span><span class="s3">,</span>
          <span class="s1">enumerable</span><span class="s3">: </span><span class="s6">false</span><span class="s3">,</span>
          <span class="s1">configurable</span><span class="s3">: </span><span class="s6">true</span>
        <span class="s3">});</span>
      <span class="s3">} </span><span class="s6">catch </span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span><span class="s0">/* ignore */</span><span class="s3">}</span>
    <span class="s3">}</span>
    <span class="s6">return </span><span class="s1">returnedFn</span><span class="s3">;</span>
  <span class="s3">},</span>

  <span class="s1">generateSource</span><span class="s3">: </span><span class="s6">function </span><span class="s3">() {</span>
    <span class="s6">var </span><span class="s1">opts </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">;</span>

    <span class="s6">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">rmWhitespace</span><span class="s3">) {</span>
      <span class="s0">// Have to use two separate replace here as `^` and `$` operators don't</span>
      <span class="s0">// work well with `\r` and empty lines don't work well with the `m` flag.</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">templateText </span><span class="s3">=</span>
        <span class="s6">this</span><span class="s3">.</span><span class="s1">templateText</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/[\r\n]+/g</span><span class="s3">, </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/^\s+|\s+$/gm</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s0">// Slurp spaces and tabs before &lt;%_ and after _%&gt;</span>
    <span class="s6">this</span><span class="s3">.</span><span class="s1">templateText </span><span class="s3">=</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">templateText</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/[ \t]*&lt;%_/gm</span><span class="s3">, </span><span class="s2">'&lt;%_'</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/_%&gt;[ \t]*/gm</span><span class="s3">, </span><span class="s2">'_%&gt;'</span><span class="s3">);</span>

    <span class="s6">var </span><span class="s1">self </span><span class="s3">= </span><span class="s6">this</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">matches </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">parseTemplateText</span><span class="s3">();</span>
    <span class="s6">var </span><span class="s1">d </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">delimiter</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">o </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">openDelimiter</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">c </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">closeDelimiter</span><span class="s3">;</span>

    <span class="s6">if </span><span class="s3">(</span><span class="s1">matches </span><span class="s3">&amp;&amp; </span><span class="s1">matches</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) {</span>
      <span class="s1">matches</span><span class="s3">.</span><span class="s1">forEach</span><span class="s3">(</span><span class="s6">function </span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s1">index</span><span class="s3">) {</span>
        <span class="s6">var </span><span class="s1">closing</span><span class="s3">;</span>
        <span class="s0">// If this is an opening tag, check for closing tags</span>
        <span class="s0">// FIXME: May end up with some false positives here</span>
        <span class="s0">// Better to store modes as k/v with openDelimiter + delimiter as key</span>
        <span class="s0">// Then this can simply check against the map</span>
        <span class="s6">if </span><span class="s3">( </span><span class="s1">line</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">) === </span><span class="s8">0        </span><span class="s0">// If it is a tag</span>
          <span class="s3">&amp;&amp; </span><span class="s1">line</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">) !== </span><span class="s8">0</span><span class="s3">) { </span><span class="s0">// and is not escaped</span>
          <span class="s1">closing </span><span class="s3">= </span><span class="s1">matches</span><span class="s3">[</span><span class="s1">index </span><span class="s3">+ </span><span class="s8">2</span><span class="s3">];</span>
          <span class="s6">if </span><span class="s3">(!(</span><span class="s1">closing </span><span class="s3">== </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">c </span><span class="s3">|| </span><span class="s1">closing </span><span class="s3">== </span><span class="s2">'-' </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">c </span><span class="s3">|| </span><span class="s1">closing </span><span class="s3">== </span><span class="s2">'_' </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">)) {</span>
            <span class="s6">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'Could not find matching close tag for &quot;' </span><span class="s3">+ </span><span class="s1">line </span><span class="s3">+ </span><span class="s2">'&quot;.'</span><span class="s3">);</span>
          <span class="s3">}</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scanLine</span><span class="s3">(</span><span class="s1">line</span><span class="s3">);</span>
      <span class="s3">});</span>
    <span class="s3">}</span>

  <span class="s3">},</span>

  <span class="s1">parseTemplateText</span><span class="s3">: </span><span class="s6">function </span><span class="s3">() {</span>
    <span class="s6">var </span><span class="s1">str </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">templateText</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">pat </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">regex</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">result </span><span class="s3">= </span><span class="s1">pat</span><span class="s3">.</span><span class="s1">exec</span><span class="s3">(</span><span class="s1">str</span><span class="s3">);</span>
    <span class="s6">var </span><span class="s1">arr </span><span class="s3">= [];</span>
    <span class="s6">var </span><span class="s1">firstPos</span><span class="s3">;</span>

    <span class="s6">while </span><span class="s3">(</span><span class="s1">result</span><span class="s3">) {</span>
      <span class="s1">firstPos </span><span class="s3">= </span><span class="s1">result</span><span class="s3">.</span><span class="s1">index</span><span class="s3">;</span>

      <span class="s6">if </span><span class="s3">(</span><span class="s1">firstPos </span><span class="s3">!== </span><span class="s8">0</span><span class="s3">) {</span>
        <span class="s1">arr</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">str</span><span class="s3">.</span><span class="s1">substring</span><span class="s3">(</span><span class="s8">0</span><span class="s3">, </span><span class="s1">firstPos</span><span class="s3">));</span>
        <span class="s1">str </span><span class="s3">= </span><span class="s1">str</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">firstPos</span><span class="s3">);</span>
      <span class="s3">}</span>

      <span class="s1">arr</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">result</span><span class="s3">[</span><span class="s8">0</span><span class="s3">]);</span>
      <span class="s1">str </span><span class="s3">= </span><span class="s1">str</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">result</span><span class="s3">[</span><span class="s8">0</span><span class="s3">].</span><span class="s1">length</span><span class="s3">);</span>
      <span class="s1">result </span><span class="s3">= </span><span class="s1">pat</span><span class="s3">.</span><span class="s1">exec</span><span class="s3">(</span><span class="s1">str</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s6">if </span><span class="s3">(</span><span class="s1">str</span><span class="s3">) {</span>
      <span class="s1">arr</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">str</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s6">return </span><span class="s1">arr</span><span class="s3">;</span>
  <span class="s3">},</span>

  <span class="s1">_addOutput</span><span class="s3">: </span><span class="s6">function </span><span class="s3">(</span><span class="s1">line</span><span class="s3">) {</span>
    <span class="s6">if </span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">truncate</span><span class="s3">) {</span>
      <span class="s0">// Only replace single leading linebreak in the line after</span>
      <span class="s0">// -%&gt; tag -- this is the single, trailing linebreak</span>
      <span class="s0">// after the tag that the truncation mode replaces</span>
      <span class="s0">// Handle Win / Unix / old Mac linebreaks -- do the \r\n</span>
      <span class="s0">// combo first in the regex-or</span>
      <span class="s1">line </span><span class="s3">= </span><span class="s1">line</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/^(?:\r\n|\r|\n)/</span><span class="s3">, </span><span class="s2">''</span><span class="s3">);</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">truncate </span><span class="s3">= </span><span class="s6">false</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s6">if </span><span class="s3">(!</span><span class="s1">line</span><span class="s3">) {</span>
      <span class="s6">return </span><span class="s1">line</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// Preserve literal slashes</span>
    <span class="s1">line </span><span class="s3">= </span><span class="s1">line</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/\\/g</span><span class="s3">, </span><span class="s2">'</span><span class="s6">\\\\</span><span class="s2">'</span><span class="s3">);</span>

    <span class="s0">// Convert linebreaks</span>
    <span class="s1">line </span><span class="s3">= </span><span class="s1">line</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/\n/g</span><span class="s3">, </span><span class="s2">'</span><span class="s6">\\</span><span class="s2">n'</span><span class="s3">);</span>
    <span class="s1">line </span><span class="s3">= </span><span class="s1">line</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/\r/g</span><span class="s3">, </span><span class="s2">'</span><span class="s6">\\</span><span class="s2">r'</span><span class="s3">);</span>

    <span class="s0">// Escape double-quotes</span>
    <span class="s0">// - this will be the delimiter during execution</span>
    <span class="s1">line </span><span class="s3">= </span><span class="s1">line</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s7">/&quot;/g</span><span class="s3">, </span><span class="s2">'</span><span class="s6">\\</span><span class="s2">&quot;'</span><span class="s3">);</span>
    <span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">+= </span><span class="s2">'    ; __append(&quot;' </span><span class="s3">+ </span><span class="s1">line </span><span class="s3">+ </span><span class="s2">'&quot;)' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
  <span class="s3">},</span>

  <span class="s1">scanLine</span><span class="s3">: </span><span class="s6">function </span><span class="s3">(</span><span class="s1">line</span><span class="s3">) {</span>
    <span class="s6">var </span><span class="s1">self </span><span class="s3">= </span><span class="s6">this</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">d </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">delimiter</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">o </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">openDelimiter</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">c </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">closeDelimiter</span><span class="s3">;</span>
    <span class="s6">var </span><span class="s1">newLineCount </span><span class="s3">= </span><span class="s8">0</span><span class="s3">;</span>

    <span class="s1">newLineCount </span><span class="s3">= (</span><span class="s1">line</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">).</span><span class="s1">length </span><span class="s3">- </span><span class="s8">1</span><span class="s3">);</span>

    <span class="s6">switch </span><span class="s3">(</span><span class="s1">line</span><span class="s3">) {</span>
    <span class="s6">case </span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">:</span>
    <span class="s6">case </span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s2">'_'</span><span class="s3">:</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">EVAL</span><span class="s3">;</span>
      <span class="s6">break</span><span class="s3">;</span>
    <span class="s6">case </span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s2">'='</span><span class="s3">:</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">ESCAPED</span><span class="s3">;</span>
      <span class="s6">break</span><span class="s3">;</span>
    <span class="s6">case </span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s2">'-'</span><span class="s3">:</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">RAW</span><span class="s3">;</span>
      <span class="s6">break</span><span class="s3">;</span>
    <span class="s6">case </span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s2">'#'</span><span class="s3">:</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">COMMENT</span><span class="s3">;</span>
      <span class="s6">break</span><span class="s3">;</span>
    <span class="s6">case </span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">:</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">LITERAL</span><span class="s3">;</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">+= </span><span class="s2">'    ; __append(&quot;' </span><span class="s3">+ </span><span class="s1">line</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">, </span><span class="s1">o </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">) + </span><span class="s2">'&quot;)' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
      <span class="s6">break</span><span class="s3">;</span>
    <span class="s6">case </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">:</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">LITERAL</span><span class="s3">;</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">+= </span><span class="s2">'    ; __append(&quot;' </span><span class="s3">+ </span><span class="s1">line</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">d </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">, </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">) + </span><span class="s2">'&quot;)' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
      <span class="s6">break</span><span class="s3">;</span>
    <span class="s6">case </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">:</span>
    <span class="s6">case </span><span class="s2">'-' </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">:</span>
    <span class="s6">case </span><span class="s2">'_' </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">:</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">LITERAL</span><span class="s3">) {</span>
        <span class="s6">this</span><span class="s3">.</span><span class="s1">_addOutput</span><span class="s3">(</span><span class="s1">line</span><span class="s3">);</span>
      <span class="s3">}</span>

      <span class="s6">this</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s6">null</span><span class="s3">;</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">truncate </span><span class="s3">= </span><span class="s1">line</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'-'</span><span class="s3">) === </span><span class="s8">0 </span><span class="s3">|| </span><span class="s1">line</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'_'</span><span class="s3">) === </span><span class="s8">0</span><span class="s3">;</span>
      <span class="s6">break</span><span class="s3">;</span>
    <span class="s6">default</span><span class="s3">:</span>
      <span class="s0">// In script mode, depends on type of tag</span>
      <span class="s6">if </span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">) {</span>
        <span class="s0">// If '//' is found without a line break, add a line break.</span>
        <span class="s6">switch </span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">) {</span>
        <span class="s6">case </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">EVAL</span><span class="s3">:</span>
        <span class="s6">case </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">ESCAPED</span><span class="s3">:</span>
        <span class="s6">case </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">RAW</span><span class="s3">:</span>
          <span class="s6">if </span><span class="s3">(</span><span class="s1">line</span><span class="s3">.</span><span class="s1">lastIndexOf</span><span class="s3">(</span><span class="s2">'//'</span><span class="s3">) &gt; </span><span class="s1">line</span><span class="s3">.</span><span class="s1">lastIndexOf</span><span class="s3">(</span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">)) {</span>
            <span class="s1">line </span><span class="s3">+= </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
          <span class="s3">}</span>
        <span class="s3">}</span>
        <span class="s6">switch </span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">) {</span>
        <span class="s0">// Just executing code</span>
        <span class="s6">case </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">EVAL</span><span class="s3">:</span>
          <span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">+= </span><span class="s2">'    ; ' </span><span class="s3">+ </span><span class="s1">line </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
          <span class="s6">break</span><span class="s3">;</span>
          <span class="s0">// Exec, esc, and output</span>
        <span class="s6">case </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">ESCAPED</span><span class="s3">:</span>
          <span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">+= </span><span class="s2">'    ; __append(escapeFn(' </span><span class="s3">+ </span><span class="s1">stripSemi</span><span class="s3">(</span><span class="s1">line</span><span class="s3">) + </span><span class="s2">'))' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
          <span class="s6">break</span><span class="s3">;</span>
          <span class="s0">// Exec and output</span>
        <span class="s6">case </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">RAW</span><span class="s3">:</span>
          <span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">+= </span><span class="s2">'    ; __append(' </span><span class="s3">+ </span><span class="s1">stripSemi</span><span class="s3">(</span><span class="s1">line</span><span class="s3">) + </span><span class="s2">')' </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
          <span class="s6">break</span><span class="s3">;</span>
        <span class="s6">case </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">COMMENT</span><span class="s3">:</span>
          <span class="s0">// Do nothing</span>
          <span class="s6">break</span><span class="s3">;</span>
          <span class="s0">// Literal &lt;%% mode, append as raw output</span>
        <span class="s6">case </span><span class="s1">Template</span><span class="s3">.</span><span class="s1">modes</span><span class="s3">.</span><span class="s1">LITERAL</span><span class="s3">:</span>
          <span class="s6">this</span><span class="s3">.</span><span class="s1">_addOutput</span><span class="s3">(</span><span class="s1">line</span><span class="s3">);</span>
          <span class="s6">break</span><span class="s3">;</span>
        <span class="s3">}</span>
      <span class="s3">}</span>
      <span class="s0">// In string mode, just add the output</span>
      <span class="s6">else </span><span class="s3">{</span>
        <span class="s6">this</span><span class="s3">.</span><span class="s1">_addOutput</span><span class="s3">(</span><span class="s1">line</span><span class="s3">);</span>
      <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s6">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">compileDebug </span><span class="s3">&amp;&amp; </span><span class="s1">newLineCount</span><span class="s3">) {</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">currentLine </span><span class="s3">+= </span><span class="s1">newLineCount</span><span class="s3">;</span>
      <span class="s6">this</span><span class="s3">.</span><span class="s1">source </span><span class="s3">+= </span><span class="s2">'    ; __line = ' </span><span class="s3">+ </span><span class="s6">this</span><span class="s3">.</span><span class="s1">currentLine </span><span class="s3">+ </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s3">;</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* Escape characters reserved in XML.</span>
 <span class="s4">*</span>
 <span class="s4">* This is simply an export of {</span><span class="s5">@link </span><span class="s4">module:utils.escapeXML}.</span>
 <span class="s4">*</span>
 <span class="s4">* If `markup` is `undefined` or `null`, the empty string is returned.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} markup Input string</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String} Escaped string</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">* </span><span class="s5">@func</span>
 <span class="s4">* */</span>
<span class="s1">exports</span><span class="s3">.</span><span class="s1">escapeXML </span><span class="s3">= </span><span class="s1">utils</span><span class="s3">.</span><span class="s1">escapeXML</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* Express.js support.</span>
 <span class="s4">*</span>
 <span class="s4">* This is an alias for {</span><span class="s5">@link </span><span class="s4">module:ejs.renderFile}, in order to support</span>
 <span class="s4">* Express.js out-of-the-box.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@func</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">__express </span><span class="s3">= </span><span class="s1">exports</span><span class="s3">.</span><span class="s1">renderFile</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* Version of EJS.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@readonly</span>
 <span class="s4">* </span><span class="s5">@type </span><span class="s4">{String}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">VERSION </span><span class="s3">= </span><span class="s1">_VERSION_STRING</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* Name for detection of EJS.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@readonly</span>
 <span class="s4">* </span><span class="s5">@type </span><span class="s4">{String}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">exports</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s1">_NAME</span><span class="s3">;</span>

<span class="s0">/* istanbul ignore if */</span>
<span class="s6">if </span><span class="s3">(</span><span class="s6">typeof </span><span class="s1">window </span><span class="s3">!= </span><span class="s2">'undefined'</span><span class="s3">) {</span>
  <span class="s1">window</span><span class="s3">.</span><span class="s1">ejs </span><span class="s3">= </span><span class="s1">exports</span><span class="s3">;</span>
<span class="s3">}</span>

</pre>
</body>
</html>