<html>
<head>
<title>fake-timers-src.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #67a37c; font-style: italic;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
.s8 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
fake-timers-src.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>

<span class="s3">const </span><span class="s2">globalObject </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;@sinonjs/commons&quot;</span><span class="s1">).</span><span class="s2">global</span><span class="s1">;</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{object} IdleDeadline</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} didTimeout - whether or not the callback was called before reaching the optional timeout</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function():number} timeRemaining - a floating-point value providing an estimate of the number of milliseconds remaining in the current idle period</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* Queues a function to be called during a browser's idle periods</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@callback </span><span class="s4">RequestIdleCallback</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{function(IdleDeadline)} callback</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{{timeout: number}} options - an options object</span>
 <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{number} the id</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@callback </span><span class="s4">NextTick</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{VoidVarArgsFunc} callback - the callback to run</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{...*} arguments - optional arguments to call the callback with</span>
 <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@callback </span><span class="s4">SetImmediate</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{VoidVarArgsFunc} callback - the callback to run</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{...*} arguments - optional arguments to call the callback with</span>
 <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{NodeImmediate}</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@callback </span><span class="s4">VoidVarArgsFunc</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{...*} callback - the callback to run</span>
 <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">RequestAnimationFrame</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(number):void} requestAnimationFrame</span>
 <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{number} - the id</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">Performance</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): number} now</span>
 <span class="s4">*/</span>

<span class="s6">/* eslint-disable jsdoc/require-property-description */</span>
<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{object} Clock</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number} now - the current time</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Date} Date - the Date constructor</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number} loopLimit - the maximum number of timers before assuming an infinite loop</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{RequestIdleCallback} requestIdleCallback</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(number):void} cancelIdleCallback</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{setTimeout} setTimeout</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{clearTimeout} clearTimeout</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{NextTick} nextTick</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{queueMicrotask} queueMicrotask</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{setInterval} setInterval</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{clearInterval} clearInterval</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{SetImmediate} setImmediate</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(NodeImmediate):void} clearImmediate</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function():number} countTimers</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{RequestAnimationFrame} requestAnimationFrame</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(number):void} cancelAnimationFrame</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function():void} runMicrotasks</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(string | number): number} tick</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(string | number): Promise&lt;number&gt;} tickAsync</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): number} next</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): Promise&lt;number&gt;} nextAsync</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): number} runAll</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): number} runToFrame</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): Promise&lt;number&gt;} runAllAsync</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): number} runToLast</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): Promise&lt;number&gt;} runToLastAsync</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): void} reset</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(number | Date): void} setSystemTime</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Performance} performance</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(number[]): number[]} hrtime - process.hrtime (legacy)</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): void} uninstall Uninstall the clock.</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Function[]} methods - the methods that are faked</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} [shouldClearNativeTimers] inherited from config</span>
 <span class="s4">*/</span>
<span class="s6">/* eslint-enable jsdoc/require-property-description */</span>

<span class="s4">/**</span>
 <span class="s4">* Configuration object for the `install` method.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{object} Config</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number|Date} [now] a number (in milliseconds) or a Date object (default epoch)</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string[]} [toFake] names of the methods that should be faked.</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number} [loopLimit] the maximum number of timers that will be run when calling runAll()</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} [shouldAdvanceTime] tells FakeTimers to increment mocked time automatically (default false)</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number} [advanceTimeDelta] increment mocked time every &lt;&lt;advanceTimeDelta&gt;&gt; ms (default: 20ms)</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} [shouldClearNativeTimers] forwards clear timer calls to native functions if they are not fakes (default: false)</span>
 <span class="s4">*/</span>

<span class="s6">/* eslint-disable jsdoc/require-property-description */</span>
<span class="s4">/**</span>
 <span class="s4">* The internal structure to describe a scheduled fake timer</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{object} Timer</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Function} func</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{*[]} args</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number} delay</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number} callAt</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number} createdAt</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} immediate</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number} id</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Error} [error]</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* A Node timer</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{object} NodeImmediate</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): boolean} hasRef</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): NodeImmediate} ref</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(): NodeImmediate} unref</span>
 <span class="s4">*/</span>
<span class="s6">/* eslint-enable jsdoc/require-property-description */</span>

<span class="s6">/* eslint-disable complexity */</span>

<span class="s4">/**</span>
 <span class="s4">* Mocks available features in the specified global namespace.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{*} _global Namespace to mock (e.g. `window`)</span>
 <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{FakeTimers}</span>
 <span class="s4">*/</span>
<span class="s3">function </span><span class="s2">withGlobal</span><span class="s1">(</span><span class="s2">_global</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">userAgent </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">navigator </span><span class="s1">&amp;&amp; </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">navigator</span><span class="s1">.</span><span class="s2">userAgent</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">isRunningInIE </span><span class="s1">= </span><span class="s2">userAgent </span><span class="s1">&amp;&amp; </span><span class="s2">userAgent</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">&quot;MSIE &quot;</span><span class="s1">) &gt; -</span><span class="s7">1</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">maxTimeout </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">pow</span><span class="s1">(</span><span class="s7">2</span><span class="s1">, </span><span class="s7">31</span><span class="s1">) - </span><span class="s7">1</span><span class="s1">; </span><span class="s6">//see https://heycam.github.io/webidl/#abstract-opdef-converttoint</span>
    <span class="s3">const </span><span class="s2">idCounterStart </span><span class="s1">= </span><span class="s7">1e12</span><span class="s1">; </span><span class="s6">// arbitrarily large number to avoid collisions with native timer IDs</span>
    <span class="s3">const </span><span class="s2">NOOP </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">return </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s3">const </span><span class="s2">NOOP_ARRAY </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">return </span><span class="s1">[];</span>
    <span class="s1">};</span>
    <span class="s3">const </span><span class="s2">timeoutResult </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setTimeout</span><span class="s1">(</span><span class="s2">NOOP</span><span class="s1">, </span><span class="s7">0</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">addTimerReturnsObject </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">timeoutResult </span><span class="s1">=== </span><span class="s0">&quot;object&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">hrtimePresent </span><span class="s1">=</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">process </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">.</span><span class="s2">hrtime </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">hrtimeBigintPresent </span><span class="s1">=</span>
        <span class="s2">hrtimePresent </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">.</span><span class="s2">hrtime</span><span class="s1">.</span><span class="s2">bigint </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">nextTickPresent </span><span class="s1">=</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">process </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">.</span><span class="s2">nextTick </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">utilPromisify </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process </span><span class="s1">&amp;&amp; </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;util&quot;</span><span class="s1">).</span><span class="s2">promisify</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">performancePresent </span><span class="s1">=</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">performance </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">performance</span><span class="s1">.</span><span class="s2">now </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">hasPerformancePrototype </span><span class="s1">=</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">Performance </span><span class="s1">&amp;&amp;</span>
        <span class="s1">(</span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Performance</span><span class="s1">).</span><span class="s2">match</span><span class="s1">(</span><span class="s8">/^(function|object)$/</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">queueMicrotaskPresent </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s0">&quot;queueMicrotask&quot;</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">requestAnimationFramePresent </span><span class="s1">=</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">requestAnimationFrame </span><span class="s1">&amp;&amp;</span>
        <span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">requestAnimationFrame </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">cancelAnimationFramePresent </span><span class="s1">=</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">cancelAnimationFrame </span><span class="s1">&amp;&amp;</span>
        <span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">cancelAnimationFrame </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">requestIdleCallbackPresent </span><span class="s1">=</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">requestIdleCallback </span><span class="s1">&amp;&amp;</span>
        <span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">requestIdleCallback </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">cancelIdleCallbackPresent </span><span class="s1">=</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">cancelIdleCallback </span><span class="s1">&amp;&amp;</span>
        <span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">cancelIdleCallback </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">setImmediatePresent </span><span class="s1">=</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">setImmediate </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setImmediate </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>

    <span class="s6">// Make properties writable in IE, as per</span>
    <span class="s6">// https://www.adequatelygood.com/Replacing-setTimeout-Globally.html</span>
    <span class="s6">/* eslint-disable no-self-assign */</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">isRunningInIE</span><span class="s1">) {</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">setTimeout </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setTimeout</span><span class="s1">;</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">clearTimeout </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">clearTimeout</span><span class="s1">;</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">setInterval </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setInterval</span><span class="s1">;</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">clearInterval </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">clearInterval</span><span class="s1">;</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">Date </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Date</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s6">// setImmediate is not a standard function</span>
    <span class="s6">// avoid adding the prop to the window object if not present</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">setImmediatePresent</span><span class="s1">) {</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">setImmediate </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setImmediate</span><span class="s1">;</span>
        <span class="s2">_global</span><span class="s1">.</span><span class="s2">clearImmediate </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">clearImmediate</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/* eslint-enable no-self-assign */</span>

    <span class="s2">_global</span><span class="s1">.</span><span class="s2">clearTimeout</span><span class="s1">(</span><span class="s2">timeoutResult</span><span class="s1">);</span>

    <span class="s3">const </span><span class="s2">NativeDate </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Date</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">uniqueTimerId </span><span class="s1">= </span><span class="s2">idCounterStart</span><span class="s1">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} num</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{boolean}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">isNumberFinite</span><span class="s1">(</span><span class="s2">num</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">Number</span><span class="s1">.</span><span class="s2">isFinite</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">Number</span><span class="s1">.</span><span class="s2">isFinite</span><span class="s1">(</span><span class="s2">num</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">isFinite</span><span class="s1">(</span><span class="s2">num</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">let </span><span class="s2">isNearInfiniteLimit </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} i</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">checkIsNearInfiniteLimit</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">loopLimit </span><span class="s1">&amp;&amp; </span><span class="s2">i </span><span class="s1">=== </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">loopLimit </span><span class="s1">- </span><span class="s7">1</span><span class="s1">) {</span>
            <span class="s2">isNearInfiniteLimit </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">*</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">resetIsNearInfiniteLimit</span><span class="s1">() {</span>
        <span class="s2">isNearInfiniteLimit </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Parse strings like &quot;01:10:00&quot; (meaning 1 hour, 10 minutes, 0 seconds) into</span>
     <span class="s4">* number of milliseconds. This is used to support human-readable strings passed</span>
     <span class="s4">* to clock.tick()</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} str</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{number}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">parseTime</span><span class="s1">(</span><span class="s2">str</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">str</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s7">0</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">const </span><span class="s2">strings </span><span class="s1">= </span><span class="s2">str</span><span class="s1">.</span><span class="s2">split</span><span class="s1">(</span><span class="s0">&quot;:&quot;</span><span class="s1">);</span>
        <span class="s3">const </span><span class="s2">l </span><span class="s1">= </span><span class="s2">strings</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">l</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">ms </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">parsed</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">l </span><span class="s1">&gt; </span><span class="s7">3 </span><span class="s1">|| !</span><span class="s8">/^(\d\d:){0,2}\d\d?$/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">str</span><span class="s1">)) {</span>
            <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span>
                <span class="s0">&quot;tick only understands numbers, 'm:s' and 'h:m:s'. Each part must be two digits&quot;</span>
            <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">while </span><span class="s1">(</span><span class="s2">i</span><span class="s1">--) {</span>
            <span class="s2">parsed </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">strings</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s7">10</span><span class="s1">);</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">parsed </span><span class="s1">&gt;= </span><span class="s7">60</span><span class="s1">) {</span>
                <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Invalid time </span><span class="s2">$</span><span class="s1">{</span><span class="s2">str</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s2">ms </span><span class="s1">+= </span><span class="s2">parsed </span><span class="s1">* </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">pow</span><span class="s1">(</span><span class="s7">60</span><span class="s1">, </span><span class="s2">l </span><span class="s1">- </span><span class="s2">i </span><span class="s1">- </span><span class="s7">1</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">ms </span><span class="s1">* </span><span class="s7">1000</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Get the decimal part of the millisecond value as nanoseconds</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} msFloat the number of milliseconds</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{number} an integer number of nanoseconds in the range [0,1e6)</span>
     <span class="s4">*</span>
     <span class="s4">* Example: nanoRemainer(123.456789) -&gt; 456789</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">nanoRemainder</span><span class="s1">(</span><span class="s2">msFloat</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">modulo </span><span class="s1">= </span><span class="s7">1e6</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">remainder </span><span class="s1">= (</span><span class="s2">msFloat </span><span class="s1">* </span><span class="s7">1e6</span><span class="s1">) % </span><span class="s2">modulo</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">positiveRemainder </span><span class="s1">=</span>
            <span class="s2">remainder </span><span class="s1">&lt; </span><span class="s7">0 </span><span class="s1">? </span><span class="s2">remainder </span><span class="s1">+ </span><span class="s2">modulo </span><span class="s1">: </span><span class="s2">remainder</span><span class="s1">;</span>

        <span class="s3">return </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">floor</span><span class="s1">(</span><span class="s2">positiveRemainder</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Used to grok the `now` parameter to createClock.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Date|number} epoch the system time</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{number}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">getEpoch</span><span class="s1">(</span><span class="s2">epoch</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">epoch</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s7">0</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">epoch</span><span class="s1">.</span><span class="s2">getTime </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">epoch</span><span class="s1">.</span><span class="s2">getTime</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">epoch </span><span class="s1">=== </span><span class="s0">&quot;number&quot;</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">epoch</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">&quot;now should be milliseconds since UNIX epoch&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} from</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} to</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Timer} timer</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{boolean}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">inRange</span><span class="s1">(</span><span class="s2">from</span><span class="s1">, </span><span class="s2">to</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s2">timer </span><span class="s1">&amp;&amp; </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt </span><span class="s1">&gt;= </span><span class="s2">from </span><span class="s1">&amp;&amp; </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt </span><span class="s1">&lt;= </span><span class="s2">to</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Timer} job</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">getInfiniteLoopError</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">job</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">infiniteLoopError </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s1">(</span>
            <span class="s0">`Aborting after running </span><span class="s2">$</span><span class="s1">{</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">loopLimit</span><span class="s1">} </span><span class="s0">timers, assuming an infinite loop!`</span>
        <span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(!</span><span class="s2">job</span><span class="s1">.</span><span class="s2">error</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">infiniteLoopError</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// pattern never matched in Node</span>
        <span class="s3">const </span><span class="s2">computedTargetPattern </span><span class="s1">= </span><span class="s8">/target\.*[&lt;|(|[].*?[&gt;|\]|)]\s*/</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">clockMethodPattern </span><span class="s1">= </span><span class="s3">new </span><span class="s2">RegExp</span><span class="s1">(</span>
            <span class="s2">String</span><span class="s1">(</span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">).</span><span class="s2">join</span><span class="s1">(</span><span class="s0">&quot;|&quot;</span><span class="s1">))</span>
        <span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">addTimerReturnsObject</span><span class="s1">) {</span>
            <span class="s6">// node.js environment</span>
            <span class="s2">clockMethodPattern </span><span class="s1">= </span><span class="s3">new </span><span class="s2">RegExp</span><span class="s1">(</span>
                <span class="s0">`</span><span class="s3">\\</span><span class="s0">s+at (Object</span><span class="s3">\\</span><span class="s0">.)?(?:</span><span class="s2">$</span><span class="s1">{</span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">).</span><span class="s2">join</span><span class="s1">(</span><span class="s0">&quot;|&quot;</span><span class="s1">)}</span><span class="s0">)</span><span class="s3">\\</span><span class="s0">s+`</span>
            <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">let </span><span class="s2">matchedLineIndex </span><span class="s1">= -</span><span class="s7">1</span><span class="s1">;</span>
        <span class="s2">job</span><span class="s1">.</span><span class="s2">error</span><span class="s1">.</span><span class="s2">stack</span><span class="s1">.</span><span class="s2">split</span><span class="s1">(</span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">).</span><span class="s2">some</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">line</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) {</span>
            <span class="s6">// If we've matched a computed target line (e.g. setTimeout) then we</span>
            <span class="s6">// don't need to look any further. Return true to stop iterating.</span>
            <span class="s3">const </span><span class="s2">matchedComputedTarget </span><span class="s1">= </span><span class="s2">line</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">computedTargetPattern</span><span class="s1">);</span>
            <span class="s6">/* istanbul ignore if */</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">matchedComputedTarget</span><span class="s1">) {</span>
                <span class="s2">matchedLineIndex </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
                <span class="s3">return true</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s6">// If we've matched a clock method line, then there may still be</span>
            <span class="s6">// others further down the trace. Return false to keep iterating.</span>
            <span class="s3">const </span><span class="s2">matchedClockMethod </span><span class="s1">= </span><span class="s2">line</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">clockMethodPattern</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">matchedClockMethod</span><span class="s1">) {</span>
                <span class="s2">matchedLineIndex </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
                <span class="s3">return false</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s6">// If we haven't matched anything on this line, but we matched</span>
            <span class="s6">// previously and set the matched line index, then we can stop.</span>
            <span class="s6">// If we haven't matched previously, then we should keep iterating.</span>
            <span class="s3">return </span><span class="s2">matchedLineIndex </span><span class="s1">&gt;= </span><span class="s7">0</span><span class="s1">;</span>
        <span class="s1">});</span>

        <span class="s3">const </span><span class="s2">stack </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">infiniteLoopError</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">job</span><span class="s1">.</span><span class="s2">type </span><span class="s1">|| </span><span class="s0">&quot;Microtask&quot;</span><span class="s1">} </span><span class="s0">- </span><span class="s2">$</span><span class="s1">{</span>
            <span class="s2">job</span><span class="s1">.</span><span class="s2">func</span><span class="s1">.</span><span class="s2">name </span><span class="s1">|| </span><span class="s0">&quot;anonymous&quot;</span>
        <span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">job</span><span class="s1">.</span><span class="s2">error</span><span class="s1">.</span><span class="s2">stack</span>
            <span class="s1">.</span><span class="s2">split</span><span class="s1">(</span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">)</span>
            <span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">matchedLineIndex </span><span class="s1">+ </span><span class="s7">1</span><span class="s1">)</span>
            <span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>

        <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">infiniteLoopError</span><span class="s1">, </span><span class="s0">&quot;stack&quot;</span><span class="s1">, {</span>
                <span class="s2">value</span><span class="s1">: </span><span class="s2">stack</span><span class="s1">,</span>
            <span class="s1">});</span>
        <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
            <span class="s6">// noop</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">infiniteLoopError</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Date} target</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Date} source</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Date} the target after modifications</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">mirrorDateProperties</span><span class="s1">(</span><span class="s2">target</span><span class="s1">, </span><span class="s2">source</span><span class="s1">) {</span>
        <span class="s3">let </span><span class="s2">prop</span><span class="s1">;</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s2">prop </span><span class="s3">in </span><span class="s2">source</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s2">prop</span><span class="s1">)) {</span>
                <span class="s2">target</span><span class="s1">[</span><span class="s2">prop</span><span class="s1">] = </span><span class="s2">source</span><span class="s1">[</span><span class="s2">prop</span><span class="s1">];</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s6">// set special now implementation</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">now</span><span class="s1">) {</span>
            <span class="s2">target</span><span class="s1">.</span><span class="s2">now </span><span class="s1">= </span><span class="s3">function </span><span class="s2">now</span><span class="s1">() {</span>
                <span class="s3">return </span><span class="s2">target</span><span class="s1">.</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
            <span class="s1">};</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s3">delete </span><span class="s2">target</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// set special toSource implementation</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">toSource</span><span class="s1">) {</span>
            <span class="s2">target</span><span class="s1">.</span><span class="s2">toSource </span><span class="s1">= </span><span class="s3">function </span><span class="s2">toSource</span><span class="s1">() {</span>
                <span class="s3">return </span><span class="s2">source</span><span class="s1">.</span><span class="s2">toSource</span><span class="s1">();</span>
            <span class="s1">};</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s3">delete </span><span class="s2">target</span><span class="s1">.</span><span class="s2">toSource</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// set special toString implementation</span>
        <span class="s2">target</span><span class="s1">.</span><span class="s2">toString </span><span class="s1">= </span><span class="s3">function </span><span class="s2">toString</span><span class="s1">() {</span>
            <span class="s3">return </span><span class="s2">source</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">();</span>
        <span class="s1">};</span>

        <span class="s2">target</span><span class="s1">.</span><span class="s2">prototype </span><span class="s1">= </span><span class="s2">source</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">;</span>
        <span class="s2">target</span><span class="s1">.</span><span class="s2">parse </span><span class="s1">= </span><span class="s2">source</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">;</span>
        <span class="s2">target</span><span class="s1">.</span><span class="s2">UTC </span><span class="s1">= </span><span class="s2">source</span><span class="s1">.</span><span class="s2">UTC</span><span class="s1">;</span>
        <span class="s2">target</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">toUTCString </span><span class="s1">= </span><span class="s2">source</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">toUTCString</span><span class="s1">;</span>

        <span class="s3">return </span><span class="s2">target</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s6">//eslint-disable-next-line jsdoc/require-jsdoc</span>
    <span class="s3">function </span><span class="s2">createDate</span><span class="s1">() {</span>
        <span class="s4">/**</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} year</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} month</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} date</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} hour</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} minute</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} second</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} ms</span>
         <span class="s4">*</span>
         <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Date}</span>
         <span class="s4">*/</span>
        <span class="s3">function </span><span class="s2">ClockDate</span><span class="s1">(</span><span class="s2">year</span><span class="s1">, </span><span class="s2">month</span><span class="s1">, </span><span class="s2">date</span><span class="s1">, </span><span class="s2">hour</span><span class="s1">, </span><span class="s2">minute</span><span class="s1">, </span><span class="s2">second</span><span class="s1">, </span><span class="s2">ms</span><span class="s1">) {</span>
            <span class="s6">// the Date constructor called as a function, ref Ecma-262 Edition 5.1, section 15.9.2.</span>
            <span class="s6">// This remains so in the 10th edition of 2019 as well.</span>
            <span class="s3">if </span><span class="s1">(!(</span><span class="s3">this instanceof </span><span class="s2">ClockDate</span><span class="s1">)) {</span>
                <span class="s3">return new </span><span class="s2">NativeDate</span><span class="s1">(</span><span class="s2">ClockDate</span><span class="s1">.</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">();</span>
            <span class="s1">}</span>

            <span class="s6">// if Date is called as a constructor with 'new' keyword</span>
            <span class="s6">// Defensive and verbose to avoid potential harm in passing</span>
            <span class="s6">// explicit undefined when user does not pass argument</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
                <span class="s3">case </span><span class="s7">0</span><span class="s1">:</span>
                    <span class="s3">return new </span><span class="s2">NativeDate</span><span class="s1">(</span><span class="s2">ClockDate</span><span class="s1">.</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">);</span>
                <span class="s3">case </span><span class="s7">1</span><span class="s1">:</span>
                    <span class="s3">return new </span><span class="s2">NativeDate</span><span class="s1">(</span><span class="s2">year</span><span class="s1">);</span>
                <span class="s3">case </span><span class="s7">2</span><span class="s1">:</span>
                    <span class="s3">return new </span><span class="s2">NativeDate</span><span class="s1">(</span><span class="s2">year</span><span class="s1">, </span><span class="s2">month</span><span class="s1">);</span>
                <span class="s3">case </span><span class="s7">3</span><span class="s1">:</span>
                    <span class="s3">return new </span><span class="s2">NativeDate</span><span class="s1">(</span><span class="s2">year</span><span class="s1">, </span><span class="s2">month</span><span class="s1">, </span><span class="s2">date</span><span class="s1">);</span>
                <span class="s3">case </span><span class="s7">4</span><span class="s1">:</span>
                    <span class="s3">return new </span><span class="s2">NativeDate</span><span class="s1">(</span><span class="s2">year</span><span class="s1">, </span><span class="s2">month</span><span class="s1">, </span><span class="s2">date</span><span class="s1">, </span><span class="s2">hour</span><span class="s1">);</span>
                <span class="s3">case </span><span class="s7">5</span><span class="s1">:</span>
                    <span class="s3">return new </span><span class="s2">NativeDate</span><span class="s1">(</span><span class="s2">year</span><span class="s1">, </span><span class="s2">month</span><span class="s1">, </span><span class="s2">date</span><span class="s1">, </span><span class="s2">hour</span><span class="s1">, </span><span class="s2">minute</span><span class="s1">);</span>
                <span class="s3">case </span><span class="s7">6</span><span class="s1">:</span>
                    <span class="s3">return new </span><span class="s2">NativeDate</span><span class="s1">(</span>
                        <span class="s2">year</span><span class="s1">,</span>
                        <span class="s2">month</span><span class="s1">,</span>
                        <span class="s2">date</span><span class="s1">,</span>
                        <span class="s2">hour</span><span class="s1">,</span>
                        <span class="s2">minute</span><span class="s1">,</span>
                        <span class="s2">second</span>
                    <span class="s1">);</span>
                <span class="s3">default</span><span class="s1">:</span>
                    <span class="s3">return new </span><span class="s2">NativeDate</span><span class="s1">(</span>
                        <span class="s2">year</span><span class="s1">,</span>
                        <span class="s2">month</span><span class="s1">,</span>
                        <span class="s2">date</span><span class="s1">,</span>
                        <span class="s2">hour</span><span class="s1">,</span>
                        <span class="s2">minute</span><span class="s1">,</span>
                        <span class="s2">second</span><span class="s1">,</span>
                        <span class="s2">ms</span>
                    <span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">mirrorDateProperties</span><span class="s1">(</span><span class="s2">ClockDate</span><span class="s1">, </span><span class="s2">NativeDate</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s6">//eslint-disable-next-line jsdoc/require-jsdoc</span>
    <span class="s3">function </span><span class="s2">enqueueJob</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">job</span><span class="s1">) {</span>
        <span class="s6">// enqueues a microtick-deferred task - ecma262/#sec-enqueuejob</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">jobs</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">jobs </span><span class="s1">= [];</span>
        <span class="s1">}</span>
        <span class="s2">clock</span><span class="s1">.</span><span class="s2">jobs</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">job</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s6">//eslint-disable-next-line jsdoc/require-jsdoc</span>
    <span class="s3">function </span><span class="s2">runJobs</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">) {</span>
        <span class="s6">// runs all microtick-deferred tasks - ecma262/#sec-runjobs</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">jobs</span><span class="s1">) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">jobs</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
            <span class="s3">const </span><span class="s2">job </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">jobs</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
            <span class="s2">job</span><span class="s1">.</span><span class="s2">func</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">job</span><span class="s1">.</span><span class="s2">args</span><span class="s1">);</span>

            <span class="s2">checkIsNearInfiniteLimit</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">i</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">loopLimit </span><span class="s1">&amp;&amp; </span><span class="s2">i </span><span class="s1">&gt; </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">loopLimit</span><span class="s1">) {</span>
                <span class="s3">throw </span><span class="s2">getInfiniteLoopError</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">job</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s2">resetIsNearInfiniteLimit</span><span class="s1">();</span>
        <span class="s2">clock</span><span class="s1">.</span><span class="s2">jobs </span><span class="s1">= [];</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Timer} timer</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{number} id of the created timer</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">addTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">func </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">&quot;Callback must be provided to timer calls&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">addTimerReturnsObject</span><span class="s1">) {</span>
            <span class="s6">// Node.js environment</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">func </span><span class="s1">!== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
                <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span>
                    <span class="s0">`[ERR_INVALID_CALLBACK]: Callback must be a function. Received </span><span class="s2">$</span><span class="s1">{</span>
                        <span class="s2">timer</span><span class="s1">.</span><span class="s2">func</span>
                    <span class="s1">} </span><span class="s0">of type </span><span class="s2">$</span><span class="s1">{</span><span class="s3">typeof </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">func</span><span class="s1">}</span><span class="s0">`</span>
                <span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">isNearInfiniteLimit</span><span class="s1">) {</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">error </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s1">();</span>
        <span class="s1">}</span>

        <span class="s2">timer</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">immediate </span><span class="s1">? </span><span class="s0">&quot;Immediate&quot; </span><span class="s1">: </span><span class="s0">&quot;Timeout&quot;</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s0">&quot;delay&quot;</span><span class="s1">)) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">delay </span><span class="s1">!== </span><span class="s0">&quot;number&quot;</span><span class="s1">) {</span>
                <span class="s2">timer</span><span class="s1">.</span><span class="s2">delay </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">delay</span><span class="s1">, </span><span class="s7">10</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s3">if </span><span class="s1">(!</span><span class="s2">isNumberFinite</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">delay</span><span class="s1">)) {</span>
                <span class="s2">timer</span><span class="s1">.</span><span class="s2">delay </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">delay </span><span class="s1">= </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">delay </span><span class="s1">&gt; </span><span class="s2">maxTimeout </span><span class="s1">? </span><span class="s7">1 </span><span class="s1">: </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">delay</span><span class="s1">;</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">delay </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s7">0</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">delay</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s0">&quot;interval&quot;</span><span class="s1">)) {</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s0">&quot;Interval&quot;</span><span class="s1">;</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">interval </span><span class="s1">= </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">interval </span><span class="s1">&gt; </span><span class="s2">maxTimeout </span><span class="s1">? </span><span class="s7">1 </span><span class="s1">: </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">interval</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s0">&quot;animation&quot;</span><span class="s1">)) {</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s0">&quot;AnimationFrame&quot;</span><span class="s1">;</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">animation </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s0">&quot;idleCallback&quot;</span><span class="s1">)) {</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s0">&quot;IdleCallback&quot;</span><span class="s1">;</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">idleCallback </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(!</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">timers </span><span class="s1">= {};</span>
        <span class="s1">}</span>

        <span class="s2">timer</span><span class="s1">.</span><span class="s2">id </span><span class="s1">= </span><span class="s2">uniqueTimerId</span><span class="s1">++;</span>
        <span class="s2">timer</span><span class="s1">.</span><span class="s2">createdAt </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
        <span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt </span><span class="s1">=</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">+ (</span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">delay</span><span class="s1">) || (</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">duringTick </span><span class="s1">? </span><span class="s7">1 </span><span class="s1">: </span><span class="s7">0</span><span class="s1">));</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">[</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">id</span><span class="s1">] = </span><span class="s2">timer</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">addTimerReturnsObject</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">res </span><span class="s1">= {</span>
                <span class="s2">ref</span><span class="s1">: </span><span class="s3">function </span><span class="s1">() {</span>
                    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
                <span class="s1">},</span>
                <span class="s2">unref</span><span class="s1">: </span><span class="s3">function </span><span class="s1">() {</span>
                    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
                <span class="s1">},</span>
                <span class="s2">refresh</span><span class="s1">: </span><span class="s3">function </span><span class="s1">() {</span>
                    <span class="s2">clearTimeout</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">id</span><span class="s1">);</span>
                    <span class="s3">const </span><span class="s2">args </span><span class="s1">= [</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">func</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">delay</span><span class="s1">].</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">args</span><span class="s1">);</span>
                    <span class="s3">return </span><span class="s2">setTimeout</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">args</span><span class="s1">);</span>
                <span class="s1">},</span>
                <span class="s1">[</span><span class="s2">Symbol</span><span class="s1">.</span><span class="s2">toPrimitive</span><span class="s1">]: </span><span class="s3">function </span><span class="s1">() {</span>
                    <span class="s3">return </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">id</span><span class="s1">;</span>
                <span class="s1">},</span>
            <span class="s1">};</span>
            <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">id</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s6">/* eslint consistent-return: &quot;off&quot; */</span>
    <span class="s4">/**</span>
     <span class="s4">* Timer comparitor</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Timer} a</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Timer} b</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{number}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">compareTimers</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s6">// Sort first by absolute timing</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">a</span><span class="s1">.</span><span class="s2">callAt </span><span class="s1">&lt; </span><span class="s2">b</span><span class="s1">.</span><span class="s2">callAt</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s1">-</span><span class="s7">1</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">a</span><span class="s1">.</span><span class="s2">callAt </span><span class="s1">&gt; </span><span class="s2">b</span><span class="s1">.</span><span class="s2">callAt</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s7">1</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// Sort next by immediate, immediate timers take precedence</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">a</span><span class="s1">.</span><span class="s2">immediate </span><span class="s1">&amp;&amp; !</span><span class="s2">b</span><span class="s1">.</span><span class="s2">immediate</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s1">-</span><span class="s7">1</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">a</span><span class="s1">.</span><span class="s2">immediate </span><span class="s1">&amp;&amp; </span><span class="s2">b</span><span class="s1">.</span><span class="s2">immediate</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s7">1</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// Sort next by creation time, earlier-created timers take precedence</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">a</span><span class="s1">.</span><span class="s2">createdAt </span><span class="s1">&lt; </span><span class="s2">b</span><span class="s1">.</span><span class="s2">createdAt</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s1">-</span><span class="s7">1</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">a</span><span class="s1">.</span><span class="s2">createdAt </span><span class="s1">&gt; </span><span class="s2">b</span><span class="s1">.</span><span class="s2">createdAt</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s7">1</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// Sort next by id, lower-id timers take precedence</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">a</span><span class="s1">.</span><span class="s2">id </span><span class="s1">&lt; </span><span class="s2">b</span><span class="s1">.</span><span class="s2">id</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s1">-</span><span class="s7">1</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">a</span><span class="s1">.</span><span class="s2">id </span><span class="s1">&gt; </span><span class="s2">b</span><span class="s1">.</span><span class="s2">id</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s7">1</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// As timer ids are unique, no fallback `0` is necessary</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} from</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} to</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Timer}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">firstTimerInRange</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">from</span><span class="s1">, </span><span class="s2">to</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">timers </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">timer </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">id</span><span class="s1">, </span><span class="s2">isInRange</span><span class="s1">;</span>

        <span class="s3">for </span><span class="s1">(</span><span class="s2">id </span><span class="s3">in </span><span class="s2">timers</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">timers</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s2">id</span><span class="s1">)) {</span>
                <span class="s2">isInRange </span><span class="s1">= </span><span class="s2">inRange</span><span class="s1">(</span><span class="s2">from</span><span class="s1">, </span><span class="s2">to</span><span class="s1">, </span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">]);</span>

                <span class="s3">if </span><span class="s1">(</span>
                    <span class="s2">isInRange </span><span class="s1">&amp;&amp;</span>
                    <span class="s1">(!</span><span class="s2">timer </span><span class="s1">|| </span><span class="s2">compareTimers</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">, </span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">]) === </span><span class="s7">1</span><span class="s1">)</span>
                <span class="s1">) {</span>
                    <span class="s2">timer </span><span class="s1">= </span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">];</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">timer</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Timer}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">firstTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">timers </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">timer </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">id</span><span class="s1">;</span>

        <span class="s3">for </span><span class="s1">(</span><span class="s2">id </span><span class="s3">in </span><span class="s2">timers</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">timers</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s2">id</span><span class="s1">)) {</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s2">timer </span><span class="s1">|| </span><span class="s2">compareTimers</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">, </span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">]) === </span><span class="s7">1</span><span class="s1">) {</span>
                    <span class="s2">timer </span><span class="s1">= </span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">];</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">timer</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Timer}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">lastTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">timers </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">timer </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">id</span><span class="s1">;</span>

        <span class="s3">for </span><span class="s1">(</span><span class="s2">id </span><span class="s3">in </span><span class="s2">timers</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">timers</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s2">id</span><span class="s1">)) {</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s2">timer </span><span class="s1">|| </span><span class="s2">compareTimers</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">, </span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">]) === -</span><span class="s7">1</span><span class="s1">) {</span>
                    <span class="s2">timer </span><span class="s1">= </span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">];</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">timer</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Timer} timer</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">callTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">interval </span><span class="s1">=== </span><span class="s0">&quot;number&quot;</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">[</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">id</span><span class="s1">].</span><span class="s2">callAt </span><span class="s1">+= </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">interval</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s3">delete </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">[</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">id</span><span class="s1">];</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">func </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
            <span class="s2">timer</span><span class="s1">.</span><span class="s2">func</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">args</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s6">/* eslint no-eval: &quot;off&quot; */</span>
            <span class="s3">const </span><span class="s2">eval2 </span><span class="s1">= </span><span class="s2">eval</span><span class="s1">;</span>
            <span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
                <span class="s2">eval2</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">func</span><span class="s1">);</span>
            <span class="s1">})();</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets clear handler name for a given timer type</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} ttype</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">getClearHandler</span><span class="s1">(</span><span class="s2">ttype</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">ttype </span><span class="s1">=== </span><span class="s0">&quot;IdleCallback&quot; </span><span class="s1">|| </span><span class="s2">ttype </span><span class="s1">=== </span><span class="s0">&quot;AnimationFrame&quot;</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s0">`cancel</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ttype</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s0">`clear</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ttype</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets schedule handler name for a given timer type</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} ttype</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">getScheduleHandler</span><span class="s1">(</span><span class="s2">ttype</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">ttype </span><span class="s1">=== </span><span class="s0">&quot;IdleCallback&quot; </span><span class="s1">|| </span><span class="s2">ttype </span><span class="s1">=== </span><span class="s0">&quot;AnimationFrame&quot;</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s0">`request</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ttype</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s0">`set</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ttype</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Creates an anonymous function to warn only once</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">createWarnOnce</span><span class="s1">() {</span>
        <span class="s3">let </span><span class="s2">calls </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>
        <span class="s3">return function </span><span class="s1">(</span><span class="s2">msg</span><span class="s1">) {</span>
            <span class="s6">// eslint-disable-next-line</span>
            <span class="s1">!</span><span class="s2">calls</span><span class="s1">++ &amp;&amp; </span><span class="s2">console</span><span class="s1">.</span><span class="s2">warn</span><span class="s1">(</span><span class="s2">msg</span><span class="s1">);</span>
        <span class="s1">};</span>
    <span class="s1">}</span>
    <span class="s3">const </span><span class="s2">warnOnce </span><span class="s1">= </span><span class="s2">createWarnOnce</span><span class="s1">();</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} timerId</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} ttype</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">clearTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timerId</span><span class="s1">, </span><span class="s2">ttype</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">timerId</span><span class="s1">) {</span>
            <span class="s6">// null appears to be allowed in most browsers, and appears to be</span>
            <span class="s6">// relied upon by some libraries, like Bootstrap carousel</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(!</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">timers </span><span class="s1">= {};</span>
        <span class="s1">}</span>

        <span class="s6">// in Node, the ID is stored as the primitive value for `Timeout` objects</span>
        <span class="s6">// for `Immediate` objects, no ID exists, so it gets coerced to NaN</span>
        <span class="s3">const </span><span class="s2">id </span><span class="s1">= </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">timerId</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">Number</span><span class="s1">.</span><span class="s2">isNaN</span><span class="s1">(</span><span class="s2">id</span><span class="s1">) || </span><span class="s2">id </span><span class="s1">&lt; </span><span class="s2">idCounterStart</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">handlerName </span><span class="s1">= </span><span class="s2">getClearHandler</span><span class="s1">(</span><span class="s2">ttype</span><span class="s1">);</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">shouldClearNativeTimers </span><span class="s1">=== </span><span class="s3">true</span><span class="s1">) {</span>
                <span class="s3">const </span><span class="s2">nativeHandler </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">[</span><span class="s0">`_</span><span class="s2">$</span><span class="s1">{</span><span class="s2">handlerName</span><span class="s1">}</span><span class="s0">`</span><span class="s1">];</span>
                <span class="s3">return typeof </span><span class="s2">nativeHandler </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span>
                    <span class="s1">? </span><span class="s2">nativeHandler</span><span class="s1">(</span><span class="s2">timerId</span><span class="s1">)</span>
                    <span class="s1">: </span><span class="s2">undefined</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">warnOnce</span><span class="s1">(</span>
                <span class="s0">`FakeTimers: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">handlerName</span><span class="s1">} </span><span class="s0">was invoked to clear a native timer instead of one created by this library.` </span><span class="s1">+</span>
                    <span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">To automatically clean-up native timers, use `shouldClearNativeTimers`.&quot;</span>
            <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s2">id</span><span class="s1">)) {</span>
            <span class="s6">// check that the ID matches a timer of the correct type</span>
            <span class="s3">const </span><span class="s2">timer </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">];</span>
            <span class="s3">if </span><span class="s1">(</span>
                <span class="s2">timer</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">ttype </span><span class="s1">||</span>
                <span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;Timeout&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">ttype </span><span class="s1">=== </span><span class="s0">&quot;Interval&quot;</span><span class="s1">) ||</span>
                <span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;Interval&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">ttype </span><span class="s1">=== </span><span class="s0">&quot;Timeout&quot;</span><span class="s1">)</span>
            <span class="s1">) {</span>
                <span class="s3">delete </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">];</span>
            <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                <span class="s3">const </span><span class="s2">clear </span><span class="s1">= </span><span class="s2">getClearHandler</span><span class="s1">(</span><span class="s2">ttype</span><span class="s1">);</span>
                <span class="s3">const </span><span class="s2">schedule </span><span class="s1">= </span><span class="s2">getScheduleHandler</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">type</span><span class="s1">);</span>
                <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span>
                    <span class="s0">`Cannot clear timer: timer created with </span><span class="s2">$</span><span class="s1">{</span><span class="s2">schedule</span><span class="s1">}</span><span class="s0">() but cleared with </span><span class="s2">$</span><span class="s1">{</span><span class="s2">clear</span><span class="s1">}</span><span class="s0">()`</span>
                <span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Config} config</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Timer[]}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">uninstall</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">config</span><span class="s1">) {</span>
        <span class="s3">let </span><span class="s2">method</span><span class="s1">, </span><span class="s2">i</span><span class="s1">, </span><span class="s2">l</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">installedHrTime </span><span class="s1">= </span><span class="s0">&quot;_hrtime&quot;</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">installedNextTick </span><span class="s1">= </span><span class="s0">&quot;_nextTick&quot;</span><span class="s1">;</span>

        <span class="s3">for </span><span class="s1">(</span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">, </span><span class="s2">l </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">methods</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">l</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
            <span class="s2">method </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">methods</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">method </span><span class="s1">=== </span><span class="s0">&quot;hrtime&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">) {</span>
                <span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">.</span><span class="s2">hrtime </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">[</span><span class="s2">installedHrTime</span><span class="s1">];</span>
            <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">method </span><span class="s1">=== </span><span class="s0">&quot;nextTick&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">) {</span>
                <span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">.</span><span class="s2">nextTick </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">[</span><span class="s2">installedNextTick</span><span class="s1">];</span>
            <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">method </span><span class="s1">=== </span><span class="s0">&quot;performance&quot;</span><span class="s1">) {</span>
                <span class="s3">const </span><span class="s2">originalPerfDescriptor </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">getOwnPropertyDescriptor</span><span class="s1">(</span>
                    <span class="s2">clock</span><span class="s1">,</span>
                    <span class="s0">`_</span><span class="s2">$</span><span class="s1">{</span><span class="s2">method</span><span class="s1">}</span><span class="s0">`</span>
                <span class="s1">);</span>
                <span class="s3">if </span><span class="s1">(</span>
                    <span class="s2">originalPerfDescriptor </span><span class="s1">&amp;&amp;</span>
                    <span class="s2">originalPerfDescriptor</span><span class="s1">.</span><span class="s2">get </span><span class="s1">&amp;&amp;</span>
                    <span class="s1">!</span><span class="s2">originalPerfDescriptor</span><span class="s1">.</span><span class="s2">set</span>
                <span class="s1">) {</span>
                    <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span>
                        <span class="s2">_global</span><span class="s1">,</span>
                        <span class="s2">method</span><span class="s1">,</span>
                        <span class="s2">originalPerfDescriptor</span>
                    <span class="s1">);</span>
                <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">originalPerfDescriptor</span><span class="s1">.</span><span class="s2">configurable</span><span class="s1">) {</span>
                    <span class="s2">_global</span><span class="s1">[</span><span class="s2">method</span><span class="s1">] = </span><span class="s2">clock</span><span class="s1">[</span><span class="s0">`_</span><span class="s2">$</span><span class="s1">{</span><span class="s2">method</span><span class="s1">}</span><span class="s0">`</span><span class="s1">];</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">_global</span><span class="s1">[</span><span class="s2">method</span><span class="s1">] &amp;&amp; </span><span class="s2">_global</span><span class="s1">[</span><span class="s2">method</span><span class="s1">].</span><span class="s2">hadOwnProperty</span><span class="s1">) {</span>
                    <span class="s2">_global</span><span class="s1">[</span><span class="s2">method</span><span class="s1">] = </span><span class="s2">clock</span><span class="s1">[</span><span class="s0">`_</span><span class="s2">$</span><span class="s1">{</span><span class="s2">method</span><span class="s1">}</span><span class="s0">`</span><span class="s1">];</span>
                <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                    <span class="s3">try </span><span class="s1">{</span>
                        <span class="s3">delete </span><span class="s2">_global</span><span class="s1">[</span><span class="s2">method</span><span class="s1">];</span>
                    <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">ignore</span><span class="s1">) {</span>
                        <span class="s6">/* eslint no-empty: &quot;off&quot; */</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">config</span><span class="s1">.</span><span class="s2">shouldAdvanceTime </span><span class="s1">=== </span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s2">_global</span><span class="s1">.</span><span class="s2">clearInterval</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">attachedInterval</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s6">// Prevent multiple executions which will completely remove these props</span>
        <span class="s2">clock</span><span class="s1">.</span><span class="s2">methods </span><span class="s1">= [];</span>

        <span class="s6">// return pending timers, to enable checking what timers remained on uninstall</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s1">[];</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">).</span><span class="s2">map</span><span class="s1">(</span><span class="s3">function </span><span class="s2">mapper</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
        <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{object} target the target containing the method to replace</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} method the keyname of the method on the target</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">hijackMethod</span><span class="s1">(</span><span class="s2">target</span><span class="s1">, </span><span class="s2">method</span><span class="s1">, </span><span class="s2">clock</span><span class="s1">) {</span>
        <span class="s2">clock</span><span class="s1">[</span><span class="s2">method</span><span class="s1">].</span><span class="s2">hadOwnProperty </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span>
            <span class="s2">target</span><span class="s1">,</span>
            <span class="s2">method</span>
        <span class="s1">);</span>
        <span class="s2">clock</span><span class="s1">[</span><span class="s0">`_</span><span class="s2">$</span><span class="s1">{</span><span class="s2">method</span><span class="s1">}</span><span class="s0">`</span><span class="s1">] = </span><span class="s2">target</span><span class="s1">[</span><span class="s2">method</span><span class="s1">];</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">method </span><span class="s1">=== </span><span class="s0">&quot;Date&quot;</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">date </span><span class="s1">= </span><span class="s2">mirrorDateProperties</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">[</span><span class="s2">method</span><span class="s1">], </span><span class="s2">target</span><span class="s1">[</span><span class="s2">method</span><span class="s1">]);</span>
            <span class="s2">target</span><span class="s1">[</span><span class="s2">method</span><span class="s1">] = </span><span class="s2">date</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">method </span><span class="s1">=== </span><span class="s0">&quot;performance&quot;</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">originalPerfDescriptor </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">getOwnPropertyDescriptor</span><span class="s1">(</span>
                <span class="s2">target</span><span class="s1">,</span>
                <span class="s2">method</span>
            <span class="s1">);</span>
            <span class="s6">// JSDOM has a read only performance field so we have to save/copy it differently</span>
            <span class="s3">if </span><span class="s1">(</span>
                <span class="s2">originalPerfDescriptor </span><span class="s1">&amp;&amp;</span>
                <span class="s2">originalPerfDescriptor</span><span class="s1">.</span><span class="s2">get </span><span class="s1">&amp;&amp;</span>
                <span class="s1">!</span><span class="s2">originalPerfDescriptor</span><span class="s1">.</span><span class="s2">set</span>
            <span class="s1">) {</span>
                <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span>
                    <span class="s2">clock</span><span class="s1">,</span>
                    <span class="s0">`_</span><span class="s2">$</span><span class="s1">{</span><span class="s2">method</span><span class="s1">}</span><span class="s0">`</span><span class="s1">,</span>
                    <span class="s2">originalPerfDescriptor</span>
                <span class="s1">);</span>

                <span class="s3">const </span><span class="s2">perfDescriptor </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">getOwnPropertyDescriptor</span><span class="s1">(</span>
                    <span class="s2">clock</span><span class="s1">,</span>
                    <span class="s2">method</span>
                <span class="s1">);</span>
                <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">target</span><span class="s1">, </span><span class="s2">method</span><span class="s1">, </span><span class="s2">perfDescriptor</span><span class="s1">);</span>
            <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                <span class="s2">target</span><span class="s1">[</span><span class="s2">method</span><span class="s1">] = </span><span class="s2">clock</span><span class="s1">[</span><span class="s2">method</span><span class="s1">];</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s2">target</span><span class="s1">[</span><span class="s2">method</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">() {</span>
                <span class="s3">return </span><span class="s2">clock</span><span class="s1">[</span><span class="s2">method</span><span class="s1">].</span><span class="s2">apply</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">arguments</span><span class="s1">);</span>
            <span class="s1">};</span>

            <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperties</span><span class="s1">(</span>
                <span class="s2">target</span><span class="s1">[</span><span class="s2">method</span><span class="s1">],</span>
                <span class="s2">Object</span><span class="s1">.</span><span class="s2">getOwnPropertyDescriptors</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">[</span><span class="s2">method</span><span class="s1">])</span>
            <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">target</span><span class="s1">[</span><span class="s2">method</span><span class="s1">].</span><span class="s2">clock </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Clock} clock</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} advanceTimeDelta</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">doIntervalTick</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">advanceTimeDelta</span><span class="s1">) {</span>
        <span class="s2">clock</span><span class="s1">.</span><span class="s2">tick</span><span class="s1">(</span><span class="s2">advanceTimeDelta</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{object} Timers</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{setTimeout} setTimeout</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{clearTimeout} clearTimeout</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{setInterval} setInterval</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{clearInterval} clearInterval</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Date} Date</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{SetImmediate=} setImmediate</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(NodeImmediate): void=} clearImmediate</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(number[]):number[]=} hrtime</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{NextTick=} nextTick</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Performance=} performance</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{RequestAnimationFrame=} requestAnimationFrame</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean=} queueMicrotask</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(number): void=} cancelAnimationFrame</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{RequestIdleCallback=} requestIdleCallback</span>
     <span class="s4">* </span><span class="s5">@property </span><span class="s4">{function(number): void=} cancelIdleCallback</span>
     <span class="s4">*/</span>

    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Timers} */</span>
    <span class="s3">const </span><span class="s2">timers </span><span class="s1">= {</span>
        <span class="s2">setTimeout</span><span class="s1">: </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setTimeout</span><span class="s1">,</span>
        <span class="s2">clearTimeout</span><span class="s1">: </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">clearTimeout</span><span class="s1">,</span>
        <span class="s2">setInterval</span><span class="s1">: </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setInterval</span><span class="s1">,</span>
        <span class="s2">clearInterval</span><span class="s1">: </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">clearInterval</span><span class="s1">,</span>
        <span class="s2">Date</span><span class="s1">: </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Date</span><span class="s1">,</span>
    <span class="s1">};</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">setImmediatePresent</span><span class="s1">) {</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">setImmediate </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setImmediate</span><span class="s1">;</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">clearImmediate </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">clearImmediate</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">hrtimePresent</span><span class="s1">) {</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">hrtime </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">.</span><span class="s2">hrtime</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">nextTickPresent</span><span class="s1">) {</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">nextTick </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">.</span><span class="s2">nextTick</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">performancePresent</span><span class="s1">) {</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">performance </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">performance</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">requestAnimationFramePresent</span><span class="s1">) {</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">requestAnimationFrame </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">requestAnimationFrame</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">queueMicrotaskPresent</span><span class="s1">) {</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">queueMicrotask </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">cancelAnimationFramePresent</span><span class="s1">) {</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">cancelAnimationFrame </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">cancelAnimationFrame</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">requestIdleCallbackPresent</span><span class="s1">) {</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">requestIdleCallback </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">requestIdleCallback</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">cancelIdleCallbackPresent</span><span class="s1">) {</span>
        <span class="s2">timers</span><span class="s1">.</span><span class="s2">cancelIdleCallback </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">cancelIdleCallback</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">originalSetTimeout </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setImmediate </span><span class="s1">|| </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setTimeout</span><span class="s1">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Date|number} [start] the system time - non-integer values are floored</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} [loopLimit] maximum number of timers that will be run when calling runAll()</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Clock}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">createClock</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s2">loopLimit</span><span class="s1">) {</span>
        <span class="s6">// eslint-disable-next-line no-param-reassign</span>
        <span class="s2">start </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">floor</span><span class="s1">(</span><span class="s2">getEpoch</span><span class="s1">(</span><span class="s2">start</span><span class="s1">));</span>
        <span class="s6">// eslint-disable-next-line no-param-reassign</span>
        <span class="s2">loopLimit </span><span class="s1">= </span><span class="s2">loopLimit </span><span class="s1">|| </span><span class="s7">1000</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">nanos </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">adjustedSystemTime </span><span class="s1">= [</span><span class="s7">0</span><span class="s1">, </span><span class="s7">0</span><span class="s1">]; </span><span class="s6">// [millis, nanoremainder]</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">NativeDate </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span>
                <span class="s0">&quot;The global scope doesn't have a `Date` object&quot; </span><span class="s1">+</span>
                    <span class="s0">&quot; (see https://github.com/sinonjs/sinon/issues/1852#issuecomment-419622780)&quot;</span>
            <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">const </span><span class="s2">clock </span><span class="s1">= {</span>
            <span class="s2">now</span><span class="s1">: </span><span class="s2">start</span><span class="s1">,</span>
            <span class="s2">Date</span><span class="s1">: </span><span class="s2">createDate</span><span class="s1">(),</span>
            <span class="s2">loopLimit</span><span class="s1">: </span><span class="s2">loopLimit</span><span class="s1">,</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">Date</span><span class="s1">.</span><span class="s2">clock </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">;</span>

        <span class="s6">//eslint-disable-next-line jsdoc/require-jsdoc</span>
        <span class="s3">function </span><span class="s2">getTimeToNextFrame</span><span class="s1">() {</span>
            <span class="s3">return </span><span class="s7">16 </span><span class="s1">- ((</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">- </span><span class="s2">start</span><span class="s1">) % </span><span class="s7">16</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s6">//eslint-disable-next-line jsdoc/require-jsdoc</span>
        <span class="s3">function </span><span class="s2">hrtime</span><span class="s1">(</span><span class="s2">prev</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">millisSinceStart </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">- </span><span class="s2">adjustedSystemTime</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] - </span><span class="s2">start</span><span class="s1">;</span>
            <span class="s3">const </span><span class="s2">secsSinceStart </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">floor</span><span class="s1">(</span><span class="s2">millisSinceStart </span><span class="s1">/ </span><span class="s7">1000</span><span class="s1">);</span>
            <span class="s3">const </span><span class="s2">remainderInNanos </span><span class="s1">=</span>
                <span class="s1">(</span><span class="s2">millisSinceStart </span><span class="s1">- </span><span class="s2">secsSinceStart </span><span class="s1">* </span><span class="s7">1e3</span><span class="s1">) * </span><span class="s7">1e6 </span><span class="s1">+</span>
                <span class="s2">nanos </span><span class="s1">-</span>
                <span class="s2">adjustedSystemTime</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">prev</span><span class="s1">)) {</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">prev</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] &gt; </span><span class="s7">1e9</span><span class="s1">) {</span>
                    <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span>
                        <span class="s0">&quot;Number of nanoseconds can't exceed a billion&quot;</span>
                    <span class="s1">);</span>
                <span class="s1">}</span>

                <span class="s3">const </span><span class="s2">oldSecs </span><span class="s1">= </span><span class="s2">prev</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
                <span class="s3">let </span><span class="s2">nanoDiff </span><span class="s1">= </span><span class="s2">remainderInNanos </span><span class="s1">- </span><span class="s2">prev</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
                <span class="s3">let </span><span class="s2">secDiff </span><span class="s1">= </span><span class="s2">secsSinceStart </span><span class="s1">- </span><span class="s2">oldSecs</span><span class="s1">;</span>

                <span class="s3">if </span><span class="s1">(</span><span class="s2">nanoDiff </span><span class="s1">&lt; </span><span class="s7">0</span><span class="s1">) {</span>
                    <span class="s2">nanoDiff </span><span class="s1">+= </span><span class="s7">1e9</span><span class="s1">;</span>
                    <span class="s2">secDiff </span><span class="s1">-= </span><span class="s7">1</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s3">return </span><span class="s1">[</span><span class="s2">secDiff</span><span class="s1">, </span><span class="s2">nanoDiff</span><span class="s1">];</span>
            <span class="s1">}</span>
            <span class="s3">return </span><span class="s1">[</span><span class="s2">secsSinceStart</span><span class="s1">, </span><span class="s2">remainderInNanos</span><span class="s1">];</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">hrtimeBigintPresent</span><span class="s1">) {</span>
            <span class="s2">hrtime</span><span class="s1">.</span><span class="s2">bigint </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
                <span class="s3">const </span><span class="s2">parts </span><span class="s1">= </span><span class="s2">hrtime</span><span class="s1">();</span>
                <span class="s3">return </span><span class="s2">BigInt</span><span class="s1">(</span><span class="s2">parts</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) * </span><span class="s2">BigInt</span><span class="s1">(</span><span class="s7">1e9</span><span class="s1">) + </span><span class="s2">BigInt</span><span class="s1">(</span><span class="s2">parts</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]); </span><span class="s6">// eslint-disable-line</span>
            <span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">requestIdleCallback </span><span class="s1">= </span><span class="s3">function </span><span class="s2">requestIdleCallback</span><span class="s1">(</span>
            <span class="s2">func</span><span class="s1">,</span>
            <span class="s2">timeout</span>
        <span class="s1">) {</span>
            <span class="s3">let </span><span class="s2">timeToNextIdlePeriod </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">countTimers</span><span class="s1">() &gt; </span><span class="s7">0</span><span class="s1">) {</span>
                <span class="s2">timeToNextIdlePeriod </span><span class="s1">= </span><span class="s7">50</span><span class="s1">; </span><span class="s6">// const for now</span>
            <span class="s1">}</span>

            <span class="s3">const </span><span class="s2">result </span><span class="s1">= </span><span class="s2">addTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, {</span>
                <span class="s2">func</span><span class="s1">: </span><span class="s2">func</span><span class="s1">,</span>
                <span class="s2">args</span><span class="s1">: </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">, </span><span class="s7">2</span><span class="s1">),</span>
                <span class="s2">delay</span><span class="s1">:</span>
                    <span class="s3">typeof </span><span class="s2">timeout </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span>
                        <span class="s1">? </span><span class="s2">timeToNextIdlePeriod</span>
                        <span class="s1">: </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span><span class="s2">timeout</span><span class="s1">, </span><span class="s2">timeToNextIdlePeriod</span><span class="s1">),</span>
                <span class="s2">idleCallback</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
            <span class="s1">});</span>

            <span class="s3">return </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">result</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">cancelIdleCallback </span><span class="s1">= </span><span class="s3">function </span><span class="s2">cancelIdleCallback</span><span class="s1">(</span><span class="s2">timerId</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">clearTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timerId</span><span class="s1">, </span><span class="s0">&quot;IdleCallback&quot;</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">setTimeout </span><span class="s1">= </span><span class="s3">function </span><span class="s2">setTimeout</span><span class="s1">(</span><span class="s2">func</span><span class="s1">, </span><span class="s2">timeout</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">addTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, {</span>
                <span class="s2">func</span><span class="s1">: </span><span class="s2">func</span><span class="s1">,</span>
                <span class="s2">args</span><span class="s1">: </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">, </span><span class="s7">2</span><span class="s1">),</span>
                <span class="s2">delay</span><span class="s1">: </span><span class="s2">timeout</span><span class="s1">,</span>
            <span class="s1">});</span>
        <span class="s1">};</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">utilPromisify</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">setTimeout</span><span class="s1">[</span>
                <span class="s2">utilPromisify</span><span class="s1">.</span><span class="s2">custom</span>
            <span class="s1">] = </span><span class="s3">function </span><span class="s2">promisifiedSetTimeout</span><span class="s1">(</span><span class="s2">timeout</span><span class="s1">, </span><span class="s2">arg</span><span class="s1">) {</span>
                <span class="s3">return new </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise</span><span class="s1">(</span><span class="s3">function </span><span class="s2">setTimeoutExecutor</span><span class="s1">(</span>
                    <span class="s2">resolve</span>
                <span class="s1">) {</span>
                    <span class="s2">addTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, {</span>
                        <span class="s2">func</span><span class="s1">: </span><span class="s2">resolve</span><span class="s1">,</span>
                        <span class="s2">args</span><span class="s1">: [</span><span class="s2">arg</span><span class="s1">],</span>
                        <span class="s2">delay</span><span class="s1">: </span><span class="s2">timeout</span><span class="s1">,</span>
                    <span class="s1">});</span>
                <span class="s1">});</span>
            <span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">clearTimeout </span><span class="s1">= </span><span class="s3">function </span><span class="s2">clearTimeout</span><span class="s1">(</span><span class="s2">timerId</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">clearTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timerId</span><span class="s1">, </span><span class="s0">&quot;Timeout&quot;</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">nextTick </span><span class="s1">= </span><span class="s3">function </span><span class="s2">nextTick</span><span class="s1">(</span><span class="s2">func</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">enqueueJob</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, {</span>
                <span class="s2">func</span><span class="s1">: </span><span class="s2">func</span><span class="s1">,</span>
                <span class="s2">args</span><span class="s1">: </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">, </span><span class="s7">1</span><span class="s1">),</span>
                <span class="s2">error</span><span class="s1">: </span><span class="s2">isNearInfiniteLimit </span><span class="s1">? </span><span class="s3">new </span><span class="s2">Error</span><span class="s1">() : </span><span class="s3">null</span><span class="s1">,</span>
            <span class="s1">});</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">queueMicrotask </span><span class="s1">= </span><span class="s3">function </span><span class="s2">queueMicrotask</span><span class="s1">(</span><span class="s2">func</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">nextTick</span><span class="s1">(</span><span class="s2">func</span><span class="s1">); </span><span class="s6">// explicitly drop additional arguments</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">setInterval </span><span class="s1">= </span><span class="s3">function </span><span class="s2">setInterval</span><span class="s1">(</span><span class="s2">func</span><span class="s1">, </span><span class="s2">timeout</span><span class="s1">) {</span>
            <span class="s6">// eslint-disable-next-line no-param-reassign</span>
            <span class="s2">timeout </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">timeout</span><span class="s1">, </span><span class="s7">10</span><span class="s1">);</span>
            <span class="s3">return </span><span class="s2">addTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, {</span>
                <span class="s2">func</span><span class="s1">: </span><span class="s2">func</span><span class="s1">,</span>
                <span class="s2">args</span><span class="s1">: </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">, </span><span class="s7">2</span><span class="s1">),</span>
                <span class="s2">delay</span><span class="s1">: </span><span class="s2">timeout</span><span class="s1">,</span>
                <span class="s2">interval</span><span class="s1">: </span><span class="s2">timeout</span><span class="s1">,</span>
            <span class="s1">});</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">clearInterval </span><span class="s1">= </span><span class="s3">function </span><span class="s2">clearInterval</span><span class="s1">(</span><span class="s2">timerId</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">clearTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timerId</span><span class="s1">, </span><span class="s0">&quot;Interval&quot;</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">setImmediatePresent</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">setImmediate </span><span class="s1">= </span><span class="s3">function </span><span class="s2">setImmediate</span><span class="s1">(</span><span class="s2">func</span><span class="s1">) {</span>
                <span class="s3">return </span><span class="s2">addTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, {</span>
                    <span class="s2">func</span><span class="s1">: </span><span class="s2">func</span><span class="s1">,</span>
                    <span class="s2">args</span><span class="s1">: </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">, </span><span class="s7">1</span><span class="s1">),</span>
                    <span class="s2">immediate</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s1">});</span>
            <span class="s1">};</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">utilPromisify</span><span class="s1">) {</span>
                <span class="s2">clock</span><span class="s1">.</span><span class="s2">setImmediate</span><span class="s1">[</span>
                    <span class="s2">utilPromisify</span><span class="s1">.</span><span class="s2">custom</span>
                <span class="s1">] = </span><span class="s3">function </span><span class="s2">promisifiedSetImmediate</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">) {</span>
                    <span class="s3">return new </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise</span><span class="s1">(</span><span class="s3">function </span><span class="s2">setImmediateExecutor</span><span class="s1">(</span>
                        <span class="s2">resolve</span>
                    <span class="s1">) {</span>
                        <span class="s2">addTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, {</span>
                            <span class="s2">func</span><span class="s1">: </span><span class="s2">resolve</span><span class="s1">,</span>
                            <span class="s2">args</span><span class="s1">: [</span><span class="s2">arg</span><span class="s1">],</span>
                            <span class="s2">immediate</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
                        <span class="s1">});</span>
                    <span class="s1">});</span>
                <span class="s1">};</span>
            <span class="s1">}</span>

            <span class="s2">clock</span><span class="s1">.</span><span class="s2">clearImmediate </span><span class="s1">= </span><span class="s3">function </span><span class="s2">clearImmediate</span><span class="s1">(</span><span class="s2">timerId</span><span class="s1">) {</span>
                <span class="s3">return </span><span class="s2">clearTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timerId</span><span class="s1">, </span><span class="s0">&quot;Immediate&quot;</span><span class="s1">);</span>
            <span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">countTimers </span><span class="s1">= </span><span class="s3">function </span><span class="s2">countTimers</span><span class="s1">() {</span>
            <span class="s3">return </span><span class="s1">(</span>
                <span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers </span><span class="s1">|| {}).</span><span class="s2">length </span><span class="s1">+</span>
                <span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">jobs </span><span class="s1">|| []).</span><span class="s2">length</span>
            <span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">requestAnimationFrame </span><span class="s1">= </span><span class="s3">function </span><span class="s2">requestAnimationFrame</span><span class="s1">(</span><span class="s2">func</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">result </span><span class="s1">= </span><span class="s2">addTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, {</span>
                <span class="s2">func</span><span class="s1">: </span><span class="s2">func</span><span class="s1">,</span>
                <span class="s2">delay</span><span class="s1">: </span><span class="s2">getTimeToNextFrame</span><span class="s1">(),</span>
                <span class="s2">args</span><span class="s1">: [</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">+ </span><span class="s2">getTimeToNextFrame</span><span class="s1">()],</span>
                <span class="s2">animation</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
            <span class="s1">});</span>

            <span class="s3">return </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">result</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">cancelAnimationFrame </span><span class="s1">= </span><span class="s3">function </span><span class="s2">cancelAnimationFrame</span><span class="s1">(</span><span class="s2">timerId</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">clearTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timerId</span><span class="s1">, </span><span class="s0">&quot;AnimationFrame&quot;</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">runMicrotasks </span><span class="s1">= </span><span class="s3">function </span><span class="s2">runMicrotasks</span><span class="s1">() {</span>
            <span class="s2">runJobs</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s4">/**</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number|string} tickValue milliseconds or a string parseable by parseTime</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{boolean} isAsync</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Function} resolve</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Function} reject</span>
         <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{number|undefined} will return the new `now` value or nothing for async</span>
         <span class="s4">*/</span>
        <span class="s3">function </span><span class="s2">doTick</span><span class="s1">(</span><span class="s2">tickValue</span><span class="s1">, </span><span class="s2">isAsync</span><span class="s1">, </span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">msFloat </span><span class="s1">=</span>
                <span class="s3">typeof </span><span class="s2">tickValue </span><span class="s1">=== </span><span class="s0">&quot;number&quot;</span>
                    <span class="s1">? </span><span class="s2">tickValue</span>
                    <span class="s1">: </span><span class="s2">parseTime</span><span class="s1">(</span><span class="s2">tickValue</span><span class="s1">);</span>
            <span class="s3">const </span><span class="s2">ms </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">floor</span><span class="s1">(</span><span class="s2">msFloat</span><span class="s1">);</span>
            <span class="s3">const </span><span class="s2">remainder </span><span class="s1">= </span><span class="s2">nanoRemainder</span><span class="s1">(</span><span class="s2">msFloat</span><span class="s1">);</span>
            <span class="s3">let </span><span class="s2">nanosTotal </span><span class="s1">= </span><span class="s2">nanos </span><span class="s1">+ </span><span class="s2">remainder</span><span class="s1">;</span>
            <span class="s3">let </span><span class="s2">tickTo </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">+ </span><span class="s2">ms</span><span class="s1">;</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">msFloat </span><span class="s1">&lt; </span><span class="s7">0</span><span class="s1">) {</span>
                <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">&quot;Negative ticks are not supported&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s6">// adjust for positive overflow</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">nanosTotal </span><span class="s1">&gt;= </span><span class="s7">1e6</span><span class="s1">) {</span>
                <span class="s2">tickTo </span><span class="s1">+= </span><span class="s7">1</span><span class="s1">;</span>
                <span class="s2">nanosTotal </span><span class="s1">-= </span><span class="s7">1e6</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">nanos </span><span class="s1">= </span><span class="s2">nanosTotal</span><span class="s1">;</span>
            <span class="s3">let </span><span class="s2">tickFrom </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
            <span class="s3">let </span><span class="s2">previous </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
            <span class="s6">// ESLint fails to detect this correctly</span>
            <span class="s6">/* eslint-disable prefer-const */</span>
            <span class="s3">let </span><span class="s2">timer</span><span class="s1">,</span>
                <span class="s2">firstException</span><span class="s1">,</span>
                <span class="s2">oldNow</span><span class="s1">,</span>
                <span class="s2">nextPromiseTick</span><span class="s1">,</span>
                <span class="s2">compensationCheck</span><span class="s1">,</span>
                <span class="s2">postTimerCall</span><span class="s1">;</span>
            <span class="s6">/* eslint-enable prefer-const */</span>

            <span class="s2">clock</span><span class="s1">.</span><span class="s2">duringTick </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>

            <span class="s6">// perform microtasks</span>
            <span class="s2">oldNow </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
            <span class="s2">runJobs</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">oldNow </span><span class="s1">!== </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">) {</span>
                <span class="s6">// compensate for any setSystemTime() call during microtask callback</span>
                <span class="s2">tickFrom </span><span class="s1">+= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">- </span><span class="s2">oldNow</span><span class="s1">;</span>
                <span class="s2">tickTo </span><span class="s1">+= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">- </span><span class="s2">oldNow</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s6">//eslint-disable-next-line jsdoc/require-jsdoc</span>
            <span class="s3">function </span><span class="s2">doTickInner</span><span class="s1">() {</span>
                <span class="s6">// perform each timer in the requested range</span>
                <span class="s2">timer </span><span class="s1">= </span><span class="s2">firstTimerInRange</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">tickFrom</span><span class="s1">, </span><span class="s2">tickTo</span><span class="s1">);</span>
                <span class="s6">// eslint-disable-next-line no-unmodified-loop-condition</span>
                <span class="s3">while </span><span class="s1">(</span><span class="s2">timer </span><span class="s1">&amp;&amp; </span><span class="s2">tickFrom </span><span class="s1">&lt;= </span><span class="s2">tickTo</span><span class="s1">) {</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">[</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">id</span><span class="s1">]) {</span>
                        <span class="s2">tickFrom </span><span class="s1">= </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt</span><span class="s1">;</span>
                        <span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">= </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt</span><span class="s1">;</span>
                        <span class="s2">oldNow </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
                        <span class="s3">try </span><span class="s1">{</span>
                            <span class="s2">runJobs</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
                            <span class="s2">callTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">);</span>
                        <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
                            <span class="s2">firstException </span><span class="s1">= </span><span class="s2">firstException </span><span class="s1">|| </span><span class="s2">e</span><span class="s1">;</span>
                        <span class="s1">}</span>

                        <span class="s3">if </span><span class="s1">(</span><span class="s2">isAsync</span><span class="s1">) {</span>
                            <span class="s6">// finish up after native setImmediate callback to allow</span>
                            <span class="s6">// all native es6 promises to process their callbacks after</span>
                            <span class="s6">// each timer fires.</span>
                            <span class="s2">originalSetTimeout</span><span class="s1">(</span><span class="s2">nextPromiseTick</span><span class="s1">);</span>
                            <span class="s3">return</span><span class="s1">;</span>
                        <span class="s1">}</span>

                        <span class="s2">compensationCheck</span><span class="s1">();</span>
                    <span class="s1">}</span>

                    <span class="s2">postTimerCall</span><span class="s1">();</span>
                <span class="s1">}</span>

                <span class="s6">// perform process.nextTick()s again</span>
                <span class="s2">oldNow </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
                <span class="s2">runJobs</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">oldNow </span><span class="s1">!== </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">) {</span>
                    <span class="s6">// compensate for any setSystemTime() call during process.nextTick() callback</span>
                    <span class="s2">tickFrom </span><span class="s1">+= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">- </span><span class="s2">oldNow</span><span class="s1">;</span>
                    <span class="s2">tickTo </span><span class="s1">+= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">- </span><span class="s2">oldNow</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s2">clock</span><span class="s1">.</span><span class="s2">duringTick </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

                <span class="s6">// corner case: during runJobs new timers were scheduled which could be in the range [clock.now, tickTo]</span>
                <span class="s2">timer </span><span class="s1">= </span><span class="s2">firstTimerInRange</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">tickFrom</span><span class="s1">, </span><span class="s2">tickTo</span><span class="s1">);</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">timer</span><span class="s1">) {</span>
                    <span class="s3">try </span><span class="s1">{</span>
                        <span class="s2">clock</span><span class="s1">.</span><span class="s2">tick</span><span class="s1">(</span><span class="s2">tickTo </span><span class="s1">- </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">); </span><span class="s6">// do it all again - for the remainder of the requested range</span>
                    <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
                        <span class="s2">firstException </span><span class="s1">= </span><span class="s2">firstException </span><span class="s1">|| </span><span class="s2">e</span><span class="s1">;</span>
                    <span class="s1">}</span>
                <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                    <span class="s6">// no timers remaining in the requested range: move the clock all the way to the end</span>
                    <span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">= </span><span class="s2">tickTo</span><span class="s1">;</span>

                    <span class="s6">// update nanos</span>
                    <span class="s2">nanos </span><span class="s1">= </span><span class="s2">nanosTotal</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">firstException</span><span class="s1">) {</span>
                    <span class="s3">throw </span><span class="s2">firstException</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s3">if </span><span class="s1">(</span><span class="s2">isAsync</span><span class="s1">) {</span>
                    <span class="s2">resolve</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">);</span>
                <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                    <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">nextPromiseTick </span><span class="s1">=</span>
                <span class="s2">isAsync </span><span class="s1">&amp;&amp;</span>
                <span class="s3">function </span><span class="s1">() {</span>
                    <span class="s3">try </span><span class="s1">{</span>
                        <span class="s2">compensationCheck</span><span class="s1">();</span>
                        <span class="s2">postTimerCall</span><span class="s1">();</span>
                        <span class="s2">doTickInner</span><span class="s1">();</span>
                    <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
                        <span class="s2">reject</span><span class="s1">(</span><span class="s2">e</span><span class="s1">);</span>
                    <span class="s1">}</span>
                <span class="s1">};</span>

            <span class="s2">compensationCheck </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
                <span class="s6">// compensate for any setSystemTime() call during timer callback</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">oldNow </span><span class="s1">!== </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">) {</span>
                    <span class="s2">tickFrom </span><span class="s1">+= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">- </span><span class="s2">oldNow</span><span class="s1">;</span>
                    <span class="s2">tickTo </span><span class="s1">+= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">- </span><span class="s2">oldNow</span><span class="s1">;</span>
                    <span class="s2">previous </span><span class="s1">+= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">- </span><span class="s2">oldNow</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">};</span>

            <span class="s2">postTimerCall </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
                <span class="s2">timer </span><span class="s1">= </span><span class="s2">firstTimerInRange</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">previous</span><span class="s1">, </span><span class="s2">tickTo</span><span class="s1">);</span>
                <span class="s2">previous </span><span class="s1">= </span><span class="s2">tickFrom</span><span class="s1">;</span>
            <span class="s1">};</span>

            <span class="s3">return </span><span class="s2">doTickInner</span><span class="s1">();</span>
        <span class="s1">}</span>

        <span class="s4">/**</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string|number} tickValue number of milliseconds or a human-readable value like &quot;01:11:15&quot;</span>
         <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{number} will return the new `now` value</span>
         <span class="s4">*/</span>
        <span class="s2">clock</span><span class="s1">.</span><span class="s2">tick </span><span class="s1">= </span><span class="s3">function </span><span class="s2">tick</span><span class="s1">(</span><span class="s2">tickValue</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">doTick</span><span class="s1">(</span><span class="s2">tickValue</span><span class="s1">, </span><span class="s3">false</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
            <span class="s4">/**</span>
             <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string|number} tickValue number of milliseconds or a human-readable value like &quot;01:11:15&quot;</span>
             <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Promise}</span>
             <span class="s4">*/</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">tickAsync </span><span class="s1">= </span><span class="s3">function </span><span class="s2">tickAsync</span><span class="s1">(</span><span class="s2">tickValue</span><span class="s1">) {</span>
                <span class="s3">return new </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) {</span>
                    <span class="s2">originalSetTimeout</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
                        <span class="s3">try </span><span class="s1">{</span>
                            <span class="s2">doTick</span><span class="s1">(</span><span class="s2">tickValue</span><span class="s1">, </span><span class="s3">true</span><span class="s1">, </span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">);</span>
                        <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
                            <span class="s2">reject</span><span class="s1">(</span><span class="s2">e</span><span class="s1">);</span>
                        <span class="s1">}</span>
                    <span class="s1">});</span>
                <span class="s1">});</span>
            <span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">next </span><span class="s1">= </span><span class="s3">function </span><span class="s2">next</span><span class="s1">() {</span>
            <span class="s2">runJobs</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
            <span class="s3">const </span><span class="s2">timer </span><span class="s1">= </span><span class="s2">firstTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">timer</span><span class="s1">) {</span>
                <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">clock</span><span class="s1">.</span><span class="s2">duringTick </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
            <span class="s3">try </span><span class="s1">{</span>
                <span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">= </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt</span><span class="s1">;</span>
                <span class="s2">callTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">);</span>
                <span class="s2">runJobs</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
                <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
            <span class="s1">} </span><span class="s3">finally </span><span class="s1">{</span>
                <span class="s2">clock</span><span class="s1">.</span><span class="s2">duringTick </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">};</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">nextAsync </span><span class="s1">= </span><span class="s3">function </span><span class="s2">nextAsync</span><span class="s1">() {</span>
                <span class="s3">return new </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) {</span>
                    <span class="s2">originalSetTimeout</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
                        <span class="s3">try </span><span class="s1">{</span>
                            <span class="s3">const </span><span class="s2">timer </span><span class="s1">= </span><span class="s2">firstTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
                            <span class="s3">if </span><span class="s1">(!</span><span class="s2">timer</span><span class="s1">) {</span>
                                <span class="s2">resolve</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">);</span>
                                <span class="s3">return</span><span class="s1">;</span>
                            <span class="s1">}</span>

                            <span class="s3">let </span><span class="s2">err</span><span class="s1">;</span>
                            <span class="s2">clock</span><span class="s1">.</span><span class="s2">duringTick </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
                            <span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">= </span><span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt</span><span class="s1">;</span>
                            <span class="s3">try </span><span class="s1">{</span>
                                <span class="s2">callTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">);</span>
                            <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
                                <span class="s2">err </span><span class="s1">= </span><span class="s2">e</span><span class="s1">;</span>
                            <span class="s1">}</span>
                            <span class="s2">clock</span><span class="s1">.</span><span class="s2">duringTick </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

                            <span class="s2">originalSetTimeout</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
                                <span class="s3">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
                                    <span class="s2">reject</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
                                <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                                    <span class="s2">resolve</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">);</span>
                                <span class="s1">}</span>
                            <span class="s1">});</span>
                        <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
                            <span class="s2">reject</span><span class="s1">(</span><span class="s2">e</span><span class="s1">);</span>
                        <span class="s1">}</span>
                    <span class="s1">});</span>
                <span class="s1">});</span>
            <span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">runAll </span><span class="s1">= </span><span class="s3">function </span><span class="s2">runAll</span><span class="s1">() {</span>
            <span class="s3">let </span><span class="s2">numTimers</span><span class="s1">, </span><span class="s2">i</span><span class="s1">;</span>
            <span class="s2">runJobs</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
            <span class="s3">for </span><span class="s1">(</span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">loopLimit</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">) {</span>
                    <span class="s2">resetIsNearInfiniteLimit</span><span class="s1">();</span>
                    <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s2">numTimers </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">).</span><span class="s2">length</span><span class="s1">;</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">numTimers </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
                    <span class="s2">resetIsNearInfiniteLimit</span><span class="s1">();</span>
                    <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s2">clock</span><span class="s1">.</span><span class="s2">next</span><span class="s1">();</span>
                <span class="s2">checkIsNearInfiniteLimit</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">i</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s3">const </span><span class="s2">excessJob </span><span class="s1">= </span><span class="s2">firstTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
            <span class="s3">throw </span><span class="s2">getInfiniteLoopError</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">excessJob</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">runToFrame </span><span class="s1">= </span><span class="s3">function </span><span class="s2">runToFrame</span><span class="s1">() {</span>
            <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">tick</span><span class="s1">(</span><span class="s2">getTimeToNextFrame</span><span class="s1">());</span>
        <span class="s1">};</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">runAllAsync </span><span class="s1">= </span><span class="s3">function </span><span class="s2">runAllAsync</span><span class="s1">() {</span>
                <span class="s3">return new </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) {</span>
                    <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>
                    <span class="s4">/**</span>
                     <span class="s4">*</span>
                     <span class="s4">*/</span>
                    <span class="s3">function </span><span class="s2">doRun</span><span class="s1">() {</span>
                        <span class="s2">originalSetTimeout</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
                            <span class="s3">try </span><span class="s1">{</span>
                                <span class="s3">let </span><span class="s2">numTimers</span><span class="s1">;</span>
                                <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">loopLimit</span><span class="s1">) {</span>
                                    <span class="s3">if </span><span class="s1">(!</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">) {</span>
                                        <span class="s2">resetIsNearInfiniteLimit</span><span class="s1">();</span>
                                        <span class="s2">resolve</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">);</span>
                                        <span class="s3">return</span><span class="s1">;</span>
                                    <span class="s1">}</span>

                                    <span class="s2">numTimers </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">)</span>
                                        <span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
                                    <span class="s3">if </span><span class="s1">(</span><span class="s2">numTimers </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
                                        <span class="s2">resetIsNearInfiniteLimit</span><span class="s1">();</span>
                                        <span class="s2">resolve</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">);</span>
                                        <span class="s3">return</span><span class="s1">;</span>
                                    <span class="s1">}</span>

                                    <span class="s2">clock</span><span class="s1">.</span><span class="s2">next</span><span class="s1">();</span>

                                    <span class="s2">i</span><span class="s1">++;</span>

                                    <span class="s2">doRun</span><span class="s1">();</span>
                                    <span class="s2">checkIsNearInfiniteLimit</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">i</span><span class="s1">);</span>
                                    <span class="s3">return</span><span class="s1">;</span>
                                <span class="s1">}</span>

                                <span class="s3">const </span><span class="s2">excessJob </span><span class="s1">= </span><span class="s2">firstTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
                                <span class="s2">reject</span><span class="s1">(</span><span class="s2">getInfiniteLoopError</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">excessJob</span><span class="s1">));</span>
                            <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
                                <span class="s2">reject</span><span class="s1">(</span><span class="s2">e</span><span class="s1">);</span>
                            <span class="s1">}</span>
                        <span class="s1">});</span>
                    <span class="s1">}</span>
                    <span class="s2">doRun</span><span class="s1">();</span>
                <span class="s1">});</span>
            <span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">runToLast </span><span class="s1">= </span><span class="s3">function </span><span class="s2">runToLast</span><span class="s1">() {</span>
            <span class="s3">const </span><span class="s2">timer </span><span class="s1">= </span><span class="s2">lastTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">timer</span><span class="s1">) {</span>
                <span class="s2">runJobs</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
                <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s3">return </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">tick</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt </span><span class="s1">- </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">runToLastAsync </span><span class="s1">= </span><span class="s3">function </span><span class="s2">runToLastAsync</span><span class="s1">() {</span>
                <span class="s3">return new </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Promise</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) {</span>
                    <span class="s2">originalSetTimeout</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
                        <span class="s3">try </span><span class="s1">{</span>
                            <span class="s3">const </span><span class="s2">timer </span><span class="s1">= </span><span class="s2">lastTimer</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">);</span>
                            <span class="s3">if </span><span class="s1">(!</span><span class="s2">timer</span><span class="s1">) {</span>
                                <span class="s2">resolve</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">);</span>
                            <span class="s1">}</span>

                            <span class="s2">resolve</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">tickAsync</span><span class="s1">(</span><span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt</span><span class="s1">));</span>
                        <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
                            <span class="s2">reject</span><span class="s1">(</span><span class="s2">e</span><span class="s1">);</span>
                        <span class="s1">}</span>
                    <span class="s1">});</span>
                <span class="s1">});</span>
            <span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">reset </span><span class="s1">= </span><span class="s3">function </span><span class="s2">reset</span><span class="s1">() {</span>
            <span class="s2">nanos </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">timers </span><span class="s1">= {};</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">jobs </span><span class="s1">= [];</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">= </span><span class="s2">start</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">setSystemTime </span><span class="s1">= </span><span class="s3">function </span><span class="s2">setSystemTime</span><span class="s1">(</span><span class="s2">systemTime</span><span class="s1">) {</span>
            <span class="s6">// determine time difference</span>
            <span class="s3">const </span><span class="s2">newNow </span><span class="s1">= </span><span class="s2">getEpoch</span><span class="s1">(</span><span class="s2">systemTime</span><span class="s1">);</span>
            <span class="s3">const </span><span class="s2">difference </span><span class="s1">= </span><span class="s2">newNow </span><span class="s1">- </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">now</span><span class="s1">;</span>
            <span class="s3">let </span><span class="s2">id</span><span class="s1">, </span><span class="s2">timer</span><span class="s1">;</span>

            <span class="s2">adjustedSystemTime</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] = </span><span class="s2">adjustedSystemTime</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] + </span><span class="s2">difference</span><span class="s1">;</span>
            <span class="s2">adjustedSystemTime</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] = </span><span class="s2">adjustedSystemTime</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] + </span><span class="s2">nanos</span><span class="s1">;</span>
            <span class="s6">// update 'system clock'</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">now </span><span class="s1">= </span><span class="s2">newNow</span><span class="s1">;</span>
            <span class="s2">nanos </span><span class="s1">= </span><span class="s7">0</span><span class="s1">;</span>

            <span class="s6">// update timers and intervals to keep them stable</span>
            <span class="s3">for </span><span class="s1">(</span><span class="s2">id </span><span class="s3">in </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">) {</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s2">id</span><span class="s1">)) {</span>
                    <span class="s2">timer </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">[</span><span class="s2">id</span><span class="s1">];</span>
                    <span class="s2">timer</span><span class="s1">.</span><span class="s2">createdAt </span><span class="s1">+= </span><span class="s2">difference</span><span class="s1">;</span>
                    <span class="s2">timer</span><span class="s1">.</span><span class="s2">callAt </span><span class="s1">+= </span><span class="s2">difference</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">};</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">performancePresent</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">performance </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">hasPerformancePrototype</span><span class="s1">) {</span>
                <span class="s3">const </span><span class="s2">proto </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">Performance</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">;</span>

                <span class="s2">Object</span><span class="s1">.</span><span class="s2">getOwnPropertyNames</span><span class="s1">(</span><span class="s2">proto</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">name</span><span class="s1">) {</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">name</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">&quot;getEntries&quot;</span><span class="s1">) === </span><span class="s7">0</span><span class="s1">) {</span>
                        <span class="s6">// match expected return type for getEntries functions</span>
                        <span class="s2">clock</span><span class="s1">.</span><span class="s2">performance</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] = </span><span class="s2">NOOP_ARRAY</span><span class="s1">;</span>
                    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                        <span class="s2">clock</span><span class="s1">.</span><span class="s2">performance</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] = </span><span class="s2">NOOP</span><span class="s1">;</span>
                    <span class="s1">}</span>
                <span class="s1">});</span>
            <span class="s1">}</span>

            <span class="s2">clock</span><span class="s1">.</span><span class="s2">performance</span><span class="s1">.</span><span class="s2">now </span><span class="s1">= </span><span class="s3">function </span><span class="s2">FakeTimersNow</span><span class="s1">() {</span>
                <span class="s3">const </span><span class="s2">hrt </span><span class="s1">= </span><span class="s2">hrtime</span><span class="s1">();</span>
                <span class="s3">const </span><span class="s2">millis </span><span class="s1">= </span><span class="s2">hrt</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] * </span><span class="s7">1000 </span><span class="s1">+ </span><span class="s2">hrt</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] / </span><span class="s7">1e6</span><span class="s1">;</span>
                <span class="s3">return </span><span class="s2">millis</span><span class="s1">;</span>
            <span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">hrtimePresent</span><span class="s1">) {</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">hrtime </span><span class="s1">= </span><span class="s2">hrtime</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">clock</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s6">/* eslint-disable complexity */</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Config=} [config] Optional config</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Clock}</span>
     <span class="s4">*/</span>
    <span class="s3">function </span><span class="s2">install</span><span class="s1">(</span><span class="s2">config</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span>
            <span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s7">1 </span><span class="s1">||</span>
            <span class="s2">config </span><span class="s3">instanceof </span><span class="s2">Date </span><span class="s1">||</span>
            <span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">config</span><span class="s1">) ||</span>
            <span class="s3">typeof </span><span class="s2">config </span><span class="s1">=== </span><span class="s0">&quot;number&quot;</span>
        <span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span>
                <span class="s0">`FakeTimers.install called with </span><span class="s2">$</span><span class="s1">{</span><span class="s2">String</span><span class="s1">(</span>
                    <span class="s2">config</span>
                <span class="s1">)} </span><span class="s0">install requires an object parameter`</span>
            <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s6">// eslint-disable-next-line no-param-reassign</span>
        <span class="s2">config </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">config </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">? </span><span class="s2">config </span><span class="s1">: {};</span>
        <span class="s2">config</span><span class="s1">.</span><span class="s2">shouldAdvanceTime </span><span class="s1">= </span><span class="s2">config</span><span class="s1">.</span><span class="s2">shouldAdvanceTime </span><span class="s1">|| </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s2">config</span><span class="s1">.</span><span class="s2">advanceTimeDelta </span><span class="s1">= </span><span class="s2">config</span><span class="s1">.</span><span class="s2">advanceTimeDelta </span><span class="s1">|| </span><span class="s7">20</span><span class="s1">;</span>
        <span class="s2">config</span><span class="s1">.</span><span class="s2">shouldClearNativeTimers </span><span class="s1">=</span>
            <span class="s2">config</span><span class="s1">.</span><span class="s2">shouldClearNativeTimers </span><span class="s1">|| </span><span class="s3">false</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">config</span><span class="s1">.</span><span class="s2">target</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span>
                <span class="s0">&quot;config.target is no longer supported. Use `withGlobal(target)` instead.&quot;</span>
            <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">let </span><span class="s2">i</span><span class="s1">, </span><span class="s2">l</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">clock </span><span class="s1">= </span><span class="s2">createClock</span><span class="s1">(</span><span class="s2">config</span><span class="s1">.</span><span class="s2">now</span><span class="s1">, </span><span class="s2">config</span><span class="s1">.</span><span class="s2">loopLimit</span><span class="s1">);</span>
        <span class="s2">clock</span><span class="s1">.</span><span class="s2">shouldClearNativeTimers </span><span class="s1">= </span><span class="s2">config</span><span class="s1">.</span><span class="s2">shouldClearNativeTimers</span><span class="s1">;</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">uninstall </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">return </span><span class="s2">uninstall</span><span class="s1">(</span><span class="s2">clock</span><span class="s1">, </span><span class="s2">config</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s2">clock</span><span class="s1">.</span><span class="s2">methods </span><span class="s1">= </span><span class="s2">config</span><span class="s1">.</span><span class="s2">toFake </span><span class="s1">|| [];</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">clock</span><span class="s1">.</span><span class="s2">methods</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
            <span class="s6">// do not fake nextTick by default - GitHub#126</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">methods </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">timers</span><span class="s1">).</span><span class="s2">filter</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
                <span class="s3">return </span><span class="s2">key </span><span class="s1">!== </span><span class="s0">&quot;nextTick&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">key </span><span class="s1">!== </span><span class="s0">&quot;queueMicrotask&quot;</span><span class="s1">;</span>
            <span class="s1">});</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">config</span><span class="s1">.</span><span class="s2">shouldAdvanceTime </span><span class="s1">=== </span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">intervalTick </span><span class="s1">= </span><span class="s2">doIntervalTick</span><span class="s1">.</span><span class="s2">bind</span><span class="s1">(</span>
                <span class="s3">null</span><span class="s1">,</span>
                <span class="s2">clock</span><span class="s1">,</span>
                <span class="s2">config</span><span class="s1">.</span><span class="s2">advanceTimeDelta</span>
            <span class="s1">);</span>
            <span class="s3">const </span><span class="s2">intervalId </span><span class="s1">= </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">setInterval</span><span class="s1">(</span>
                <span class="s2">intervalTick</span><span class="s1">,</span>
                <span class="s2">config</span><span class="s1">.</span><span class="s2">advanceTimeDelta</span>
            <span class="s1">);</span>
            <span class="s2">clock</span><span class="s1">.</span><span class="s2">attachedInterval </span><span class="s1">= </span><span class="s2">intervalId</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">for </span><span class="s1">(</span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">, </span><span class="s2">l </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">methods</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">l</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
            <span class="s3">const </span><span class="s2">nameOfMethodToReplace </span><span class="s1">= </span><span class="s2">clock</span><span class="s1">.</span><span class="s2">methods</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">nameOfMethodToReplace </span><span class="s1">=== </span><span class="s0">&quot;hrtime&quot;</span><span class="s1">) {</span>
                <span class="s3">if </span><span class="s1">(</span>
                    <span class="s2">_global</span><span class="s1">.</span><span class="s2">process </span><span class="s1">&amp;&amp;</span>
                    <span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">.</span><span class="s2">hrtime </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span>
                <span class="s1">) {</span>
                    <span class="s2">hijackMethod</span><span class="s1">(</span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">, </span><span class="s2">nameOfMethodToReplace</span><span class="s1">, </span><span class="s2">clock</span><span class="s1">);</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">nameOfMethodToReplace </span><span class="s1">=== </span><span class="s0">&quot;nextTick&quot;</span><span class="s1">) {</span>
                <span class="s3">if </span><span class="s1">(</span>
                    <span class="s2">_global</span><span class="s1">.</span><span class="s2">process </span><span class="s1">&amp;&amp;</span>
                    <span class="s3">typeof </span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">.</span><span class="s2">nextTick </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span>
                <span class="s1">) {</span>
                    <span class="s2">hijackMethod</span><span class="s1">(</span><span class="s2">_global</span><span class="s1">.</span><span class="s2">process</span><span class="s1">, </span><span class="s2">nameOfMethodToReplace</span><span class="s1">, </span><span class="s2">clock</span><span class="s1">);</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                <span class="s2">hijackMethod</span><span class="s1">(</span><span class="s2">_global</span><span class="s1">, </span><span class="s2">nameOfMethodToReplace</span><span class="s1">, </span><span class="s2">clock</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">clock</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s6">/* eslint-enable complexity */</span>

    <span class="s3">return </span><span class="s1">{</span>
        <span class="s2">timers</span><span class="s1">: </span><span class="s2">timers</span><span class="s1">,</span>
        <span class="s2">createClock</span><span class="s1">: </span><span class="s2">createClock</span><span class="s1">,</span>
        <span class="s2">install</span><span class="s1">: </span><span class="s2">install</span><span class="s1">,</span>
        <span class="s2">withGlobal</span><span class="s1">: </span><span class="s2">withGlobal</span><span class="s1">,</span>
    <span class="s1">};</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{object} FakeTimers</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Timers} timers</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{createClock} createClock</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Function} install</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{withGlobal} withGlobal</span>
 <span class="s4">*/</span>

<span class="s6">/* eslint-enable complexity */</span>

<span class="s4">/** </span><span class="s5">@type </span><span class="s4">{FakeTimers} */</span>
<span class="s3">const </span><span class="s2">defaultImplementation </span><span class="s1">= </span><span class="s2">withGlobal</span><span class="s1">(</span><span class="s2">globalObject</span><span class="s1">);</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">timers </span><span class="s1">= </span><span class="s2">defaultImplementation</span><span class="s1">.</span><span class="s2">timers</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">createClock </span><span class="s1">= </span><span class="s2">defaultImplementation</span><span class="s1">.</span><span class="s2">createClock</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">install </span><span class="s1">= </span><span class="s2">defaultImplementation</span><span class="s1">.</span><span class="s2">install</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">withGlobal </span><span class="s1">= </span><span class="s2">withGlobal</span><span class="s1">;</span>
</pre>
</body>
</html>