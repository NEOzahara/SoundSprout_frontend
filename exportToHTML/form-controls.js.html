<html>
<head>
<title>form-controls.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
form-controls.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>

<span class="s3">const </span><span class="s1">{</span>
  <span class="s2">isValidFloatingPointNumber</span><span class="s1">,</span>
  <span class="s2">isValidSimpleColor</span><span class="s1">,</span>
  <span class="s2">parseFloatingPointNumber</span><span class="s1">,</span>
  <span class="s2">stripLeadingAndTrailingASCIIWhitespace</span><span class="s1">,</span>
  <span class="s2">stripNewlines</span><span class="s1">,</span>
  <span class="s2">splitOnCommas</span>
<span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./strings&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{</span>
  <span class="s2">isValidDateString</span><span class="s1">,</span>
  <span class="s2">isValidMonthString</span><span class="s1">,</span>
  <span class="s2">isValidTimeString</span><span class="s1">,</span>
  <span class="s2">isValidWeekString</span><span class="s1">,</span>
  <span class="s2">parseLocalDateAndTimeString</span><span class="s1">,</span>
  <span class="s2">serializeNormalizedDateAndTime</span>
<span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./dates-and-times&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">whatwgURL </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;whatwg-url&quot;</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">NodeList </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../generated/NodeList&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">domSymbolTree </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./internal-constants&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">closest</span><span class="s1">, </span><span class="s2">firstChildWithLocalName </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./traversal&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">NODE_TYPE </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../node-type&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">HTML_NS </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./namespaces&quot;</span><span class="s1">);</span>

<span class="s4">// https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#concept-fe-disabled</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">isDisabled </span><span class="s1">= </span><span class="s2">formControl </span><span class="s1">=&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">localName </span><span class="s1">=== </span><span class="s0">&quot;button&quot; </span><span class="s1">|| </span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">localName </span><span class="s1">=== </span><span class="s0">&quot;input&quot; </span><span class="s1">|| </span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">localName </span><span class="s1">=== </span><span class="s0">&quot;select&quot; </span><span class="s1">||</span>
      <span class="s2">formControl</span><span class="s1">.</span><span class="s2">localName </span><span class="s1">=== </span><span class="s0">&quot;textarea&quot;</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">hasAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;disabled&quot;</span><span class="s1">)) {</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">let </span><span class="s2">e </span><span class="s1">= </span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">parentNode</span><span class="s1">;</span>
  <span class="s3">while </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">e</span><span class="s1">.</span><span class="s2">localName </span><span class="s1">=== </span><span class="s0">&quot;fieldset&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">e</span><span class="s1">.</span><span class="s2">hasAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;disabled&quot;</span><span class="s1">)) {</span>
      <span class="s3">const </span><span class="s2">firstLegendElementChild </span><span class="s1">= </span><span class="s2">firstChildWithLocalName</span><span class="s1">(</span><span class="s2">e</span><span class="s1">, </span><span class="s0">&quot;legend&quot;</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">firstLegendElementChild </span><span class="s1">|| !</span><span class="s2">firstLegendElementChild</span><span class="s1">.</span><span class="s2">contains</span><span class="s1">(</span><span class="s2">formControl</span><span class="s1">)) {</span>
        <span class="s3">return true</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">e </span><span class="s1">= </span><span class="s2">e</span><span class="s1">.</span><span class="s2">parentNode</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return false</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#category-listed</span>
<span class="s3">const </span><span class="s2">listedElements </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Set</span><span class="s1">([</span><span class="s0">&quot;button&quot;</span><span class="s1">, </span><span class="s0">&quot;fieldset&quot;</span><span class="s1">, </span><span class="s0">&quot;input&quot;</span><span class="s1">, </span><span class="s0">&quot;object&quot;</span><span class="s1">, </span><span class="s0">&quot;output&quot;</span><span class="s1">, </span><span class="s0">&quot;select&quot;</span><span class="s1">, </span><span class="s0">&quot;textarea&quot;</span><span class="s1">]);</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">isListed </span><span class="s1">= </span><span class="s2">formControl </span><span class="s1">=&gt; </span><span class="s2">listedElements</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">_localName</span><span class="s1">) &amp;&amp; </span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">namespaceURI </span><span class="s1">=== </span><span class="s2">HTML_NS</span><span class="s1">;</span>

<span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#category-submit</span>
<span class="s3">const </span><span class="s2">submittableElements </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Set</span><span class="s1">([</span><span class="s0">&quot;button&quot;</span><span class="s1">, </span><span class="s0">&quot;input&quot;</span><span class="s1">, </span><span class="s0">&quot;object&quot;</span><span class="s1">, </span><span class="s0">&quot;select&quot;</span><span class="s1">, </span><span class="s0">&quot;textarea&quot;</span><span class="s1">]);</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">isSubmittable </span><span class="s1">= </span><span class="s2">formControl </span><span class="s1">=&gt; {</span>
  <span class="s3">return </span><span class="s2">submittableElements</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">_localName</span><span class="s1">) &amp;&amp; </span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">namespaceURI </span><span class="s1">=== </span><span class="s2">HTML_NS</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#concept-submit-button</span>
<span class="s3">const </span><span class="s2">submitButtonInputTypes </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Set</span><span class="s1">([</span><span class="s0">&quot;submit&quot;</span><span class="s1">, </span><span class="s0">&quot;image&quot;</span><span class="s1">]);</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">isSubmitButton </span><span class="s1">= </span><span class="s2">formControl </span><span class="s1">=&gt; {</span>
  <span class="s3">return </span><span class="s1">((</span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">=== </span><span class="s0">&quot;input&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">submitButtonInputTypes</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">type</span><span class="s1">)) ||</span>
          <span class="s1">(</span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">=== </span><span class="s0">&quot;button&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;submit&quot;</span><span class="s1">)) &amp;&amp;</span>
         <span class="s2">formControl</span><span class="s1">.</span><span class="s2">namespaceURI </span><span class="s1">=== </span><span class="s2">HTML_NS</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#concept-button</span>
<span class="s3">const </span><span class="s2">buttonInputTypes </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Set</span><span class="s1">([</span><span class="s2">...submitButtonInputTypes</span><span class="s1">, </span><span class="s0">&quot;reset&quot;</span><span class="s1">, </span><span class="s0">&quot;button&quot;</span><span class="s1">]);</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">isButton </span><span class="s1">= </span><span class="s2">formControl </span><span class="s1">=&gt; {</span>
  <span class="s3">return </span><span class="s1">((</span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">=== </span><span class="s0">&quot;input&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">buttonInputTypes</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">type</span><span class="s1">)) ||</span>
          <span class="s2">formControl</span><span class="s1">.</span><span class="s2">_localName </span><span class="s1">=== </span><span class="s0">&quot;button&quot;</span><span class="s1">) &amp;&amp;</span>
         <span class="s2">formControl</span><span class="s1">.</span><span class="s2">namespaceURI </span><span class="s1">=== </span><span class="s2">HTML_NS</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">// https://html.spec.whatwg.org/multipage/dom.html#interactive-content-2</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">isInteractiveContent </span><span class="s1">= </span><span class="s2">node </span><span class="s1">=&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">nodeType </span><span class="s1">!== </span><span class="s2">NODE_TYPE</span><span class="s1">.</span><span class="s2">ELEMENT_NODE</span><span class="s1">) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">namespaceURI </span><span class="s1">!== </span><span class="s2">HTML_NS</span><span class="s1">) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">hasAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;tabindex&quot;</span><span class="s1">)) {</span>
    <span class="s3">return true</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">switch </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">localName</span><span class="s1">) {</span>
    <span class="s3">case </span><span class="s0">&quot;a&quot;</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">node</span><span class="s1">.</span><span class="s2">hasAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;href&quot;</span><span class="s1">);</span>

    <span class="s3">case </span><span class="s0">&quot;audio&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;video&quot;</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">node</span><span class="s1">.</span><span class="s2">hasAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;controls&quot;</span><span class="s1">);</span>

    <span class="s3">case </span><span class="s0">&quot;img&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;object&quot;</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">node</span><span class="s1">.</span><span class="s2">hasAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;usemap&quot;</span><span class="s1">);</span>

    <span class="s3">case </span><span class="s0">&quot;input&quot;</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">node</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s0">&quot;hidden&quot;</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;button&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;details&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;embed&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;iframe&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;label&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;select&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;textarea&quot;</span><span class="s1">:</span>
      <span class="s3">return true</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return false</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#category-label</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">isLabelable </span><span class="s1">= </span><span class="s2">node </span><span class="s1">=&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">nodeType </span><span class="s1">!== </span><span class="s2">NODE_TYPE</span><span class="s1">.</span><span class="s2">ELEMENT_NODE</span><span class="s1">) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">namespaceURI </span><span class="s1">!== </span><span class="s2">HTML_NS</span><span class="s1">) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">switch </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">localName</span><span class="s1">) {</span>
    <span class="s3">case </span><span class="s0">&quot;button&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;meter&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;output&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;progress&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;select&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;textarea&quot;</span><span class="s1">:</span>
      <span class="s3">return true</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;input&quot;</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">node</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s0">&quot;hidden&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return false</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">getLabelsForLabelable </span><span class="s1">= </span><span class="s2">labelable </span><span class="s1">=&gt; {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">exports</span><span class="s1">.</span><span class="s2">isLabelable</span><span class="s1">(</span><span class="s2">labelable</span><span class="s1">)) {</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">labelable</span><span class="s1">.</span><span class="s2">_labels</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">root </span><span class="s1">= </span><span class="s2">labelable</span><span class="s1">.</span><span class="s2">getRootNode</span><span class="s1">({});</span>
    <span class="s2">labelable</span><span class="s1">.</span><span class="s2">_labels </span><span class="s1">= </span><span class="s2">NodeList</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">root</span><span class="s1">.</span><span class="s2">_globalObject</span><span class="s1">, [], {</span>
      <span class="s2">element</span><span class="s1">: </span><span class="s2">root</span><span class="s1">,</span>
      <span class="s2">query</span><span class="s1">: () =&gt; {</span>
        <span class="s3">const </span><span class="s2">nodes </span><span class="s1">= [];</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">descendant of domSymbolTree</span><span class="s1">.</span><span class="s2">treeIterator</span><span class="s1">(</span><span class="s2">root</span><span class="s1">)) {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">descendant</span><span class="s1">.</span><span class="s2">control </span><span class="s1">=== </span><span class="s2">labelable</span><span class="s1">) {</span>
            <span class="s2">nodes</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">descendant</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">nodes</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">labelable</span><span class="s1">.</span><span class="s2">_labels</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#valid-e-mail-address</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">isValidEmailAddress </span><span class="s1">= (</span><span class="s2">emailAddress</span><span class="s1">, </span><span class="s2">multiple </span><span class="s1">= </span><span class="s3">false</span><span class="s1">) =&gt; {</span>
  <span class="s3">const </span><span class="s2">emailAddressRegExp </span><span class="s1">= </span><span class="s3">new </span><span class="s2">RegExp</span><span class="s1">(</span><span class="s0">&quot;^[a-zA-Z0-9.!#$%&amp;'*+</span><span class="s3">\\</span><span class="s0">/=?^_`{|}~-]+@[a-zA-Z0-9]&quot; </span><span class="s1">+</span>
    <span class="s0">&quot;(?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:</span><span class="s3">\\</span><span class="s0">.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}&quot; </span><span class="s1">+</span>
    <span class="s0">&quot;[a-zA-Z0-9])?)*$&quot;</span><span class="s1">);</span>
  <span class="s4">// A valid e-mail address list is a set of comma-separated tokens, where each token is itself</span>
  <span class="s4">// a valid e - mail address.To obtain the list of tokens from a valid e - mail address list,</span>
  <span class="s4">// an implementation must split the string on commas.</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">multiple</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">splitOnCommas</span><span class="s1">(</span><span class="s2">emailAddress</span><span class="s1">).</span><span class="s2">every</span><span class="s1">(</span><span class="s2">value </span><span class="s1">=&gt; </span><span class="s2">emailAddressRegExp</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">));</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">emailAddressRegExp</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">emailAddress</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">isValidAbsoluteURL </span><span class="s1">= </span><span class="s2">url </span><span class="s1">=&gt; {</span>
  <span class="s3">return </span><span class="s2">whatwgURL</span><span class="s1">.</span><span class="s2">parseURL</span><span class="s1">(</span><span class="s2">url</span><span class="s1">) !== </span><span class="s3">null</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">sanitizeValueByType </span><span class="s1">= (</span><span class="s2">input</span><span class="s1">, </span><span class="s2">val</span><span class="s1">) =&gt; {</span>
  <span class="s3">switch </span><span class="s1">(</span><span class="s2">input</span><span class="s1">.</span><span class="s2">type</span><span class="s1">.</span><span class="s2">toLowerCase</span><span class="s1">()) {</span>
    <span class="s3">case </span><span class="s0">&quot;password&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;search&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;tel&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;text&quot;</span><span class="s1">:</span>
      <span class="s2">val </span><span class="s1">= </span><span class="s2">stripNewlines</span><span class="s1">(</span><span class="s2">val</span><span class="s1">);</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;color&quot;</span><span class="s1">:</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#color-state-(type=color):value-sanitization-algorithm</span>
      <span class="s2">val </span><span class="s1">= </span><span class="s2">isValidSimpleColor</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) ? </span><span class="s2">val</span><span class="s1">.</span><span class="s2">toLowerCase</span><span class="s1">() : </span><span class="s0">&quot;#000000&quot;</span><span class="s1">;</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;date&quot;</span><span class="s1">:</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/input.html#date-state-(type=date):value-sanitization-algorithm</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">isValidDateString</span><span class="s1">(</span><span class="s2">val</span><span class="s1">)) {</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;datetime-local&quot;</span><span class="s1">: {</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/input.html#local-date-and-time-state-(type=datetime-local):value-sanitization-algorithm</span>
      <span class="s3">const </span><span class="s2">dateAndTime </span><span class="s1">= </span><span class="s2">parseLocalDateAndTimeString</span><span class="s1">(</span><span class="s2">val</span><span class="s1">);</span>
      <span class="s2">val </span><span class="s1">= </span><span class="s2">dateAndTime </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">? </span><span class="s2">serializeNormalizedDateAndTime</span><span class="s1">(</span><span class="s2">dateAndTime</span><span class="s1">) : </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">case </span><span class="s0">&quot;email&quot;</span><span class="s1">:</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#e-mail-state-(type=email):value-sanitization-algorithm</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#e-mail-state-(type=email):value-sanitization-algorithm-2</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">input</span><span class="s1">.</span><span class="s2">hasAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;multiple&quot;</span><span class="s1">)) {</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s2">val</span><span class="s1">.</span><span class="s2">split</span><span class="s1">(</span><span class="s0">&quot;,&quot;</span><span class="s1">).</span><span class="s2">map</span><span class="s1">(</span><span class="s2">token </span><span class="s1">=&gt; </span><span class="s2">stripLeadingAndTrailingASCIIWhitespace</span><span class="s1">(</span><span class="s2">token</span><span class="s1">)).</span><span class="s2">join</span><span class="s1">(</span><span class="s0">&quot;,&quot;</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s2">stripNewlines</span><span class="s1">(</span><span class="s2">val</span><span class="s1">);</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s2">stripLeadingAndTrailingASCIIWhitespace</span><span class="s1">(</span><span class="s2">val</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;month&quot;</span><span class="s1">:</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/input.html#month-state-(type=month):value-sanitization-algorithm</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">isValidMonthString</span><span class="s1">(</span><span class="s2">val</span><span class="s1">)) {</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;number&quot;</span><span class="s1">:</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/input.html#number-state-(type=number):value-sanitization-algorithm</span>
      <span class="s4">// TODO: using parseFloatingPointNumber in addition to isValidFloatingPointNumber to pass number.html WPT.</span>
      <span class="s4">// Possible spec bug.</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">isValidFloatingPointNumber</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) || </span><span class="s2">parseFloatingPointNumber</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) === </span><span class="s3">null</span><span class="s1">) {</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;range&quot;</span><span class="s1">:</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/input.html#range-state-(type=range):value-sanitization-algorithm</span>
      <span class="s4">// TODO: using parseFloatingPointNumber in addition to isValidFloatingPointNumber to pass number.html WPT.</span>
      <span class="s4">// Possible spec bug.</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">isValidFloatingPointNumber</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) || </span><span class="s2">parseFloatingPointNumber</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) === </span><span class="s3">null</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">minimum </span><span class="s1">= </span><span class="s2">input</span><span class="s1">.</span><span class="s2">_minimum</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">maximum </span><span class="s1">= </span><span class="s2">input</span><span class="s1">.</span><span class="s2">_maximum</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">defaultValue </span><span class="s1">= </span><span class="s2">maximum </span><span class="s1">&lt; </span><span class="s2">minimum </span><span class="s1">? </span><span class="s2">minimum </span><span class="s1">: (</span><span class="s2">minimum </span><span class="s1">+ </span><span class="s2">maximum</span><span class="s1">) / </span><span class="s5">2</span><span class="s1">;</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">defaultValue</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">val </span><span class="s1">&lt; </span><span class="s2">input</span><span class="s1">.</span><span class="s2">_minimum</span><span class="s1">) {</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">input</span><span class="s1">.</span><span class="s2">_minimum</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">val </span><span class="s1">&gt; </span><span class="s2">input</span><span class="s1">.</span><span class="s2">_maximum</span><span class="s1">) {</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">input</span><span class="s1">.</span><span class="s2">_maximum</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;time&quot;</span><span class="s1">:</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/input.html#time-state-(type=time):value-sanitization-algorithm</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">isValidTimeString</span><span class="s1">(</span><span class="s2">val</span><span class="s1">)) {</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;url&quot;</span><span class="s1">:</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/forms.html#url-state-(type=url):value-sanitization-algorithm</span>
      <span class="s2">val </span><span class="s1">= </span><span class="s2">stripNewlines</span><span class="s1">(</span><span class="s2">val</span><span class="s1">);</span>
      <span class="s2">val </span><span class="s1">= </span><span class="s2">stripLeadingAndTrailingASCIIWhitespace</span><span class="s1">(</span><span class="s2">val</span><span class="s1">);</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s0">&quot;week&quot;</span><span class="s1">:</span>
      <span class="s4">// https://html.spec.whatwg.org/multipage/input.html#week-state-(type=week):value-sanitization-algorithm</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">isValidWeekString</span><span class="s1">(</span><span class="s2">val</span><span class="s1">)) {</span>
        <span class="s2">val </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">val</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">// https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#form-owner</span>
<span class="s4">// TODO: The spec describes an imperative process for assigning/resetting an element's form</span>
<span class="s4">// owner based on activities involving form-associated elements. This simpler implementation</span>
<span class="s4">// instead calculates the current form owner only when the property is accessed. This is not</span>
<span class="s4">// sufficient to pass all the web platform tests, but is good enough for most purposes. We</span>
<span class="s4">// should eventually update it to use the correct version, though. See</span>
<span class="s4">// https://github.com/whatwg/html/issues/4050 for some discussion.</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">formOwner </span><span class="s1">= </span><span class="s2">formControl </span><span class="s1">=&gt; {</span>
  <span class="s3">const </span><span class="s2">formAttr </span><span class="s1">= </span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">getAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;form&quot;</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">formAttr </span><span class="s1">=== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">formAttr </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">closest</span><span class="s1">(</span><span class="s2">formControl</span><span class="s1">, </span><span class="s0">&quot;form&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">root </span><span class="s1">= </span><span class="s2">formControl</span><span class="s1">.</span><span class="s2">getRootNode</span><span class="s1">({});</span>
  <span class="s3">let </span><span class="s2">firstElementWithId</span><span class="s1">;</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">descendant of domSymbolTree</span><span class="s1">.</span><span class="s2">treeIterator</span><span class="s1">(</span><span class="s2">root</span><span class="s1">)) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">descendant</span><span class="s1">.</span><span class="s2">nodeType </span><span class="s1">=== </span><span class="s2">NODE_TYPE</span><span class="s1">.</span><span class="s2">ELEMENT_NODE </span><span class="s1">&amp;&amp;</span>
      <span class="s2">descendant</span><span class="s1">.</span><span class="s2">getAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;id&quot;</span><span class="s1">) === </span><span class="s2">formAttr</span><span class="s1">) {</span>
      <span class="s2">firstElementWithId </span><span class="s1">= </span><span class="s2">descendant</span><span class="s1">;</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">firstElementWithId </span><span class="s1">&amp;&amp;</span>
    <span class="s2">firstElementWithId</span><span class="s1">.</span><span class="s2">namespaceURI </span><span class="s1">=== </span><span class="s2">HTML_NS </span><span class="s1">&amp;&amp;</span>
    <span class="s2">firstElementWithId</span><span class="s1">.</span><span class="s2">localName </span><span class="s1">=== </span><span class="s0">&quot;form&quot;</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">firstElementWithId</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">return null</span><span class="s1">;</span>
<span class="s1">};</span>
</pre>
</body>
</html>