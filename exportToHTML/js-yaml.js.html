<html>
<head>
<title>js-yaml.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
js-yaml.js</font>
</center></td></tr></table>
<pre><span class="s0">/*! js-yaml 3.14.1 https://github.com/nodeca/js-yaml */</span><span class="s1">(</span><span class="s2">function</span><span class="s1">(</span><span class="s3">f</span><span class="s1">){</span><span class="s2">if</span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">exports</span><span class="s1">===</span><span class="s4">&quot;object&quot;</span><span class="s1">&amp;&amp;</span><span class="s2">typeof </span><span class="s3">module</span><span class="s1">!==</span><span class="s4">&quot;undefined&quot;</span><span class="s1">){</span><span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">=</span><span class="s3">f</span><span class="s1">()}</span><span class="s2">else if</span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">define</span><span class="s1">===</span><span class="s4">&quot;function&quot;</span><span class="s1">&amp;&amp;</span><span class="s3">define</span><span class="s1">.</span><span class="s3">amd</span><span class="s1">){</span><span class="s3">define</span><span class="s1">([],</span><span class="s3">f</span><span class="s1">)}</span><span class="s2">else</span><span class="s1">{</span><span class="s2">var </span><span class="s3">g</span><span class="s1">;</span><span class="s2">if</span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">window</span><span class="s1">!==</span><span class="s4">&quot;undefined&quot;</span><span class="s1">){</span><span class="s3">g</span><span class="s1">=</span><span class="s3">window</span><span class="s1">}</span><span class="s2">else if</span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">global</span><span class="s1">!==</span><span class="s4">&quot;undefined&quot;</span><span class="s1">){</span><span class="s3">g</span><span class="s1">=</span><span class="s3">global</span><span class="s1">}</span><span class="s2">else if</span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">self</span><span class="s1">!==</span><span class="s4">&quot;undefined&quot;</span><span class="s1">){</span><span class="s3">g</span><span class="s1">=</span><span class="s3">self</span><span class="s1">}</span><span class="s2">else</span><span class="s1">{</span><span class="s3">g</span><span class="s1">=</span><span class="s2">this</span><span class="s1">}</span><span class="s3">g</span><span class="s1">.</span><span class="s3">jsyaml </span><span class="s1">= </span><span class="s3">f</span><span class="s1">()}})(</span><span class="s2">function</span><span class="s1">(){</span><span class="s2">var </span><span class="s3">define</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">;</span><span class="s2">return </span><span class="s1">(</span><span class="s2">function</span><span class="s1">(){</span><span class="s2">function </span><span class="s3">r</span><span class="s1">(</span><span class="s3">e</span><span class="s1">,</span><span class="s3">n</span><span class="s1">,</span><span class="s3">t</span><span class="s1">){</span><span class="s2">function </span><span class="s3">o</span><span class="s1">(</span><span class="s3">i</span><span class="s1">,</span><span class="s3">f</span><span class="s1">){</span><span class="s2">if</span><span class="s1">(!</span><span class="s3">n</span><span class="s1">[</span><span class="s3">i</span><span class="s1">]){</span><span class="s2">if</span><span class="s1">(!</span><span class="s3">e</span><span class="s1">[</span><span class="s3">i</span><span class="s1">]){</span><span class="s2">var </span><span class="s3">c</span><span class="s1">=</span><span class="s4">&quot;function&quot;</span><span class="s1">==</span><span class="s2">typeof </span><span class="s3">require</span><span class="s1">&amp;&amp;</span><span class="s3">require</span><span class="s1">;</span><span class="s2">if</span><span class="s1">(!</span><span class="s3">f</span><span class="s1">&amp;&amp;</span><span class="s3">c</span><span class="s1">)</span><span class="s2">return </span><span class="s3">c</span><span class="s1">(</span><span class="s3">i</span><span class="s1">,!</span><span class="s5">0</span><span class="s1">);</span><span class="s2">if</span><span class="s1">(</span><span class="s3">u</span><span class="s1">)</span><span class="s2">return </span><span class="s3">u</span><span class="s1">(</span><span class="s3">i</span><span class="s1">,!</span><span class="s5">0</span><span class="s1">);</span><span class="s2">var </span><span class="s3">a</span><span class="s1">=</span><span class="s2">new </span><span class="s3">Error</span><span class="s1">(</span><span class="s4">&quot;Cannot find module '&quot;</span><span class="s1">+</span><span class="s3">i</span><span class="s1">+</span><span class="s4">&quot;'&quot;</span><span class="s1">);</span><span class="s2">throw </span><span class="s3">a</span><span class="s1">.</span><span class="s3">code</span><span class="s1">=</span><span class="s4">&quot;MODULE_NOT_FOUND&quot;</span><span class="s1">,</span><span class="s3">a</span><span class="s1">}</span><span class="s2">var </span><span class="s3">p</span><span class="s1">=</span><span class="s3">n</span><span class="s1">[</span><span class="s3">i</span><span class="s1">]={</span><span class="s3">exports</span><span class="s1">:{}};</span><span class="s3">e</span><span class="s1">[</span><span class="s3">i</span><span class="s1">][</span><span class="s5">0</span><span class="s1">].</span><span class="s3">call</span><span class="s1">(</span><span class="s3">p</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">,</span><span class="s2">function</span><span class="s1">(</span><span class="s3">r</span><span class="s1">){</span><span class="s2">var </span><span class="s3">n</span><span class="s1">=</span><span class="s3">e</span><span class="s1">[</span><span class="s3">i</span><span class="s1">][</span><span class="s5">1</span><span class="s1">][</span><span class="s3">r</span><span class="s1">];</span><span class="s2">return </span><span class="s3">o</span><span class="s1">(</span><span class="s3">n</span><span class="s1">||</span><span class="s3">r</span><span class="s1">)},</span><span class="s3">p</span><span class="s1">,</span><span class="s3">p</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">,</span><span class="s3">r</span><span class="s1">,</span><span class="s3">e</span><span class="s1">,</span><span class="s3">n</span><span class="s1">,</span><span class="s3">t</span><span class="s1">)}</span><span class="s2">return </span><span class="s3">n</span><span class="s1">[</span><span class="s3">i</span><span class="s1">].</span><span class="s3">exports</span><span class="s1">}</span><span class="s2">for</span><span class="s1">(</span><span class="s2">var </span><span class="s3">u</span><span class="s1">=</span><span class="s4">&quot;function&quot;</span><span class="s1">==</span><span class="s2">typeof </span><span class="s3">require</span><span class="s1">&amp;&amp;</span><span class="s3">require</span><span class="s1">,</span><span class="s3">i</span><span class="s1">=</span><span class="s5">0</span><span class="s1">;</span><span class="s3">i</span><span class="s1">&lt;</span><span class="s3">t</span><span class="s1">.</span><span class="s3">length</span><span class="s1">;</span><span class="s3">i</span><span class="s1">++)</span><span class="s3">o</span><span class="s1">(</span><span class="s3">t</span><span class="s1">[</span><span class="s3">i</span><span class="s1">]);</span><span class="s2">return </span><span class="s3">o</span><span class="s1">}</span><span class="s2">return </span><span class="s3">r</span><span class="s1">})()({</span><span class="s5">1</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">loader </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/loader'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">dumper </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/dumper'</span><span class="s1">);</span>


<span class="s2">function </span><span class="s3">deprecated</span><span class="s1">(</span><span class="s3">name</span><span class="s1">) {</span>
  <span class="s2">return function </span><span class="s1">() {</span>
    <span class="s2">throw new </span><span class="s3">Error</span><span class="s1">(</span><span class="s4">'Function ' </span><span class="s1">+ </span><span class="s3">name </span><span class="s1">+ </span><span class="s4">' is deprecated and cannot be used.'</span><span class="s1">);</span>
  <span class="s1">};</span>
<span class="s1">}</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">Type                </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/type'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">Schema              </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/schema'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">FAILSAFE_SCHEMA     </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/schema/failsafe'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">JSON_SCHEMA         </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/schema/json'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">CORE_SCHEMA         </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/schema/core'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">DEFAULT_SAFE_SCHEMA </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/schema/default_safe'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">DEFAULT_FULL_SCHEMA </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/schema/default_full'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">load                </span><span class="s1">= </span><span class="s3">loader</span><span class="s1">.</span><span class="s3">load</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">loadAll             </span><span class="s1">= </span><span class="s3">loader</span><span class="s1">.</span><span class="s3">loadAll</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">safeLoad            </span><span class="s1">= </span><span class="s3">loader</span><span class="s1">.</span><span class="s3">safeLoad</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">safeLoadAll         </span><span class="s1">= </span><span class="s3">loader</span><span class="s1">.</span><span class="s3">safeLoadAll</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">dump                </span><span class="s1">= </span><span class="s3">dumper</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">safeDump            </span><span class="s1">= </span><span class="s3">dumper</span><span class="s1">.</span><span class="s3">safeDump</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">YAMLException       </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/exception'</span><span class="s1">);</span>

<span class="s0">// Deprecated schema names from JS-YAML 2.0.x</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">MINIMAL_SCHEMA </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/schema/failsafe'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">SAFE_SCHEMA    </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/schema/default_safe'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">DEFAULT_SCHEMA </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./js-yaml/schema/default_full'</span><span class="s1">);</span>

<span class="s0">// Deprecated functions from JS-YAML 1.x.x</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">scan           </span><span class="s1">= </span><span class="s3">deprecated</span><span class="s1">(</span><span class="s4">'scan'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">parse          </span><span class="s1">= </span><span class="s3">deprecated</span><span class="s1">(</span><span class="s4">'parse'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">compose        </span><span class="s1">= </span><span class="s3">deprecated</span><span class="s1">(</span><span class="s4">'compose'</span><span class="s1">);</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">addConstructor </span><span class="s1">= </span><span class="s3">deprecated</span><span class="s1">(</span><span class="s4">'addConstructor'</span><span class="s1">);</span>

<span class="s1">},{</span><span class="s4">&quot;./js-yaml/dumper&quot;</span><span class="s1">:</span><span class="s5">3</span><span class="s1">,</span><span class="s4">&quot;./js-yaml/exception&quot;</span><span class="s1">:</span><span class="s5">4</span><span class="s1">,</span><span class="s4">&quot;./js-yaml/loader&quot;</span><span class="s1">:</span><span class="s5">5</span><span class="s1">,</span><span class="s4">&quot;./js-yaml/schema&quot;</span><span class="s1">:</span><span class="s5">7</span><span class="s1">,</span><span class="s4">&quot;./js-yaml/schema/core&quot;</span><span class="s1">:</span><span class="s5">8</span><span class="s1">,</span><span class="s4">&quot;./js-yaml/schema/default_full&quot;</span><span class="s1">:</span><span class="s5">9</span><span class="s1">,</span><span class="s4">&quot;./js-yaml/schema/default_safe&quot;</span><span class="s1">:</span><span class="s5">10</span><span class="s1">,</span><span class="s4">&quot;./js-yaml/schema/failsafe&quot;</span><span class="s1">:</span><span class="s5">11</span><span class="s1">,</span><span class="s4">&quot;./js-yaml/schema/json&quot;</span><span class="s1">:</span><span class="s5">12</span><span class="s1">,</span><span class="s4">&quot;./js-yaml/type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">2</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>


<span class="s2">function </span><span class="s3">isNothing</span><span class="s1">(</span><span class="s3">subject</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">subject </span><span class="s1">=== </span><span class="s4">'undefined'</span><span class="s1">) || (</span><span class="s3">subject </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">);</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">isObject</span><span class="s1">(</span><span class="s3">subject</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">subject </span><span class="s1">=== </span><span class="s4">'object'</span><span class="s1">) &amp;&amp; (</span><span class="s3">subject </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">);</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">toArray</span><span class="s1">(</span><span class="s3">sequence</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">Array</span><span class="s1">.</span><span class="s3">isArray</span><span class="s1">(</span><span class="s3">sequence</span><span class="s1">)) </span><span class="s2">return </span><span class="s3">sequence</span><span class="s1">;</span>
  <span class="s2">else if </span><span class="s1">(</span><span class="s3">isNothing</span><span class="s1">(</span><span class="s3">sequence</span><span class="s1">)) </span><span class="s2">return </span><span class="s1">[];</span>

  <span class="s2">return </span><span class="s1">[ </span><span class="s3">sequence </span><span class="s1">];</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">extend</span><span class="s1">(</span><span class="s3">target</span><span class="s1">, </span><span class="s3">source</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">index</span><span class="s1">, </span><span class="s3">length</span><span class="s1">, </span><span class="s3">key</span><span class="s1">, </span><span class="s3">sourceKeys</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">source</span><span class="s1">) {</span>
    <span class="s3">sourceKeys </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">source</span><span class="s1">);</span>

    <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">sourceKeys</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s3">key </span><span class="s1">= </span><span class="s3">sourceKeys</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>
      <span class="s3">target</span><span class="s1">[</span><span class="s3">key</span><span class="s1">] = </span><span class="s3">source</span><span class="s1">[</span><span class="s3">key</span><span class="s1">];</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">target</span><span class="s1">;</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">repeat</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">count</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">, </span><span class="s3">cycle</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">cycle </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s3">cycle </span><span class="s1">&lt; </span><span class="s3">count</span><span class="s1">; </span><span class="s3">cycle </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">string</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">isNegativeZero</span><span class="s1">(</span><span class="s3">number</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s3">number </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) &amp;&amp; (</span><span class="s3">Number</span><span class="s1">.</span><span class="s3">NEGATIVE_INFINITY </span><span class="s1">=== </span><span class="s5">1 </span><span class="s1">/ </span><span class="s3">number</span><span class="s1">);</span>
<span class="s1">}</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">isNothing      </span><span class="s1">= </span><span class="s3">isNothing</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">isObject       </span><span class="s1">= </span><span class="s3">isObject</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">toArray        </span><span class="s1">= </span><span class="s3">toArray</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">repeat         </span><span class="s1">= </span><span class="s3">repeat</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">isNegativeZero </span><span class="s1">= </span><span class="s3">isNegativeZero</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">extend         </span><span class="s1">= </span><span class="s3">extend</span><span class="s1">;</span>

<span class="s1">},{}],</span><span class="s5">3</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s0">/*eslint-disable no-use-before-define*/</span>

<span class="s2">var </span><span class="s3">common              </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./common'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">YAMLException       </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./exception'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">DEFAULT_FULL_SCHEMA </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./schema/default_full'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">DEFAULT_SAFE_SCHEMA </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./schema/default_safe'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s3">_toString       </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">_hasOwnProperty </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">hasOwnProperty</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">CHAR_TAB                  </span><span class="s1">= </span><span class="s5">0x09</span><span class="s1">; </span><span class="s0">/* Tab */</span>
<span class="s2">var </span><span class="s3">CHAR_LINE_FEED            </span><span class="s1">= </span><span class="s5">0x0A</span><span class="s1">; </span><span class="s0">/* LF */</span>
<span class="s2">var </span><span class="s3">CHAR_CARRIAGE_RETURN      </span><span class="s1">= </span><span class="s5">0x0D</span><span class="s1">; </span><span class="s0">/* CR */</span>
<span class="s2">var </span><span class="s3">CHAR_SPACE                </span><span class="s1">= </span><span class="s5">0x20</span><span class="s1">; </span><span class="s0">/* Space */</span>
<span class="s2">var </span><span class="s3">CHAR_EXCLAMATION          </span><span class="s1">= </span><span class="s5">0x21</span><span class="s1">; </span><span class="s0">/* ! */</span>
<span class="s2">var </span><span class="s3">CHAR_DOUBLE_QUOTE         </span><span class="s1">= </span><span class="s5">0x22</span><span class="s1">; </span><span class="s0">/* &quot; */</span>
<span class="s2">var </span><span class="s3">CHAR_SHARP                </span><span class="s1">= </span><span class="s5">0x23</span><span class="s1">; </span><span class="s0">/* # */</span>
<span class="s2">var </span><span class="s3">CHAR_PERCENT              </span><span class="s1">= </span><span class="s5">0x25</span><span class="s1">; </span><span class="s0">/* % */</span>
<span class="s2">var </span><span class="s3">CHAR_AMPERSAND            </span><span class="s1">= </span><span class="s5">0x26</span><span class="s1">; </span><span class="s0">/* &amp; */</span>
<span class="s2">var </span><span class="s3">CHAR_SINGLE_QUOTE         </span><span class="s1">= </span><span class="s5">0x27</span><span class="s1">; </span><span class="s0">/* ' */</span>
<span class="s2">var </span><span class="s3">CHAR_ASTERISK             </span><span class="s1">= </span><span class="s5">0x2A</span><span class="s1">; </span><span class="s0">/* * */</span>
<span class="s2">var </span><span class="s3">CHAR_COMMA                </span><span class="s1">= </span><span class="s5">0x2C</span><span class="s1">; </span><span class="s0">/* , */</span>
<span class="s2">var </span><span class="s3">CHAR_MINUS                </span><span class="s1">= </span><span class="s5">0x2D</span><span class="s1">; </span><span class="s0">/* - */</span>
<span class="s2">var </span><span class="s3">CHAR_COLON                </span><span class="s1">= </span><span class="s5">0x3A</span><span class="s1">; </span><span class="s0">/* : */</span>
<span class="s2">var </span><span class="s3">CHAR_EQUALS               </span><span class="s1">= </span><span class="s5">0x3D</span><span class="s1">; </span><span class="s0">/* = */</span>
<span class="s2">var </span><span class="s3">CHAR_GREATER_THAN         </span><span class="s1">= </span><span class="s5">0x3E</span><span class="s1">; </span><span class="s0">/* &gt; */</span>
<span class="s2">var </span><span class="s3">CHAR_QUESTION             </span><span class="s1">= </span><span class="s5">0x3F</span><span class="s1">; </span><span class="s0">/* ? */</span>
<span class="s2">var </span><span class="s3">CHAR_COMMERCIAL_AT        </span><span class="s1">= </span><span class="s5">0x40</span><span class="s1">; </span><span class="s0">/* @ */</span>
<span class="s2">var </span><span class="s3">CHAR_LEFT_SQUARE_BRACKET  </span><span class="s1">= </span><span class="s5">0x5B</span><span class="s1">; </span><span class="s0">/* [ */</span>
<span class="s2">var </span><span class="s3">CHAR_RIGHT_SQUARE_BRACKET </span><span class="s1">= </span><span class="s5">0x5D</span><span class="s1">; </span><span class="s0">/* ] */</span>
<span class="s2">var </span><span class="s3">CHAR_GRAVE_ACCENT         </span><span class="s1">= </span><span class="s5">0x60</span><span class="s1">; </span><span class="s0">/* ` */</span>
<span class="s2">var </span><span class="s3">CHAR_LEFT_CURLY_BRACKET   </span><span class="s1">= </span><span class="s5">0x7B</span><span class="s1">; </span><span class="s0">/* { */</span>
<span class="s2">var </span><span class="s3">CHAR_VERTICAL_LINE        </span><span class="s1">= </span><span class="s5">0x7C</span><span class="s1">; </span><span class="s0">/* | */</span>
<span class="s2">var </span><span class="s3">CHAR_RIGHT_CURLY_BRACKET  </span><span class="s1">= </span><span class="s5">0x7D</span><span class="s1">; </span><span class="s0">/* } */</span>

<span class="s2">var </span><span class="s3">ESCAPE_SEQUENCES </span><span class="s1">= {};</span>

<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x00</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">0'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x07</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">a'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x08</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">b'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x09</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">t'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x0A</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">n'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x0B</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">v'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x0C</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">f'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x0D</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">r'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x1B</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">e'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x22</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">&quot;'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x5C</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\\\</span><span class="s4">'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x85</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">N'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0xA0</span><span class="s1">]   = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">_'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x2028</span><span class="s1">] = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">L'</span><span class="s1">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s5">0x2029</span><span class="s1">] = </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">P'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">DEPRECATED_BOOLEANS_SYNTAX </span><span class="s1">= [</span>
  <span class="s4">'y'</span><span class="s1">, </span><span class="s4">'Y'</span><span class="s1">, </span><span class="s4">'yes'</span><span class="s1">, </span><span class="s4">'Yes'</span><span class="s1">, </span><span class="s4">'YES'</span><span class="s1">, </span><span class="s4">'on'</span><span class="s1">, </span><span class="s4">'On'</span><span class="s1">, </span><span class="s4">'ON'</span><span class="s1">,</span>
  <span class="s4">'n'</span><span class="s1">, </span><span class="s4">'N'</span><span class="s1">, </span><span class="s4">'no'</span><span class="s1">, </span><span class="s4">'No'</span><span class="s1">, </span><span class="s4">'NO'</span><span class="s1">, </span><span class="s4">'off'</span><span class="s1">, </span><span class="s4">'Off'</span><span class="s1">, </span><span class="s4">'OFF'</span>
<span class="s1">];</span>

<span class="s2">function </span><span class="s3">compileStyleMap</span><span class="s1">(</span><span class="s3">schema</span><span class="s1">, </span><span class="s3">map</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">result</span><span class="s1">, </span><span class="s3">keys</span><span class="s1">, </span><span class="s3">index</span><span class="s1">, </span><span class="s3">length</span><span class="s1">, </span><span class="s3">tag</span><span class="s1">, </span><span class="s3">style</span><span class="s1">, </span><span class="s3">type</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">map </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return </span><span class="s1">{};</span>

  <span class="s3">result </span><span class="s1">= {};</span>
  <span class="s3">keys </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">map</span><span class="s1">);</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">keys</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">tag </span><span class="s1">= </span><span class="s3">keys</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>
    <span class="s3">style </span><span class="s1">= </span><span class="s3">String</span><span class="s1">(</span><span class="s3">map</span><span class="s1">[</span><span class="s3">tag</span><span class="s1">]);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">tag</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s5">2</span><span class="s1">) === </span><span class="s4">'!!'</span><span class="s1">) {</span>
      <span class="s3">tag </span><span class="s1">= </span><span class="s4">'tag:yaml.org,2002:' </span><span class="s1">+ </span><span class="s3">tag</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">2</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">type </span><span class="s1">= </span><span class="s3">schema</span><span class="s1">.</span><span class="s3">compiledTypeMap</span><span class="s1">[</span><span class="s4">'fallback'</span><span class="s1">][</span><span class="s3">tag</span><span class="s1">];</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">type </span><span class="s1">&amp;&amp; </span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">type</span><span class="s1">.</span><span class="s3">styleAliases</span><span class="s1">, </span><span class="s3">style</span><span class="s1">)) {</span>
      <span class="s3">style </span><span class="s1">= </span><span class="s3">type</span><span class="s1">.</span><span class="s3">styleAliases</span><span class="s1">[</span><span class="s3">style</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s3">result</span><span class="s1">[</span><span class="s3">tag</span><span class="s1">] = </span><span class="s3">style</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">encodeHex</span><span class="s1">(</span><span class="s3">character</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">string</span><span class="s1">, </span><span class="s3">handle</span><span class="s1">, </span><span class="s3">length</span><span class="s1">;</span>

  <span class="s3">string </span><span class="s1">= </span><span class="s3">character</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">(</span><span class="s5">16</span><span class="s1">).</span><span class="s3">toUpperCase</span><span class="s1">();</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">character </span><span class="s1">&lt;= </span><span class="s5">0xFF</span><span class="s1">) {</span>
    <span class="s3">handle </span><span class="s1">= </span><span class="s4">'x'</span><span class="s1">;</span>
    <span class="s3">length </span><span class="s1">= </span><span class="s5">2</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">character </span><span class="s1">&lt;= </span><span class="s5">0xFFFF</span><span class="s1">) {</span>
    <span class="s3">handle </span><span class="s1">= </span><span class="s4">'u'</span><span class="s1">;</span>
    <span class="s3">length </span><span class="s1">= </span><span class="s5">4</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">character </span><span class="s1">&lt;= </span><span class="s5">0xFFFFFFFF</span><span class="s1">) {</span>
    <span class="s3">handle </span><span class="s1">= </span><span class="s4">'U'</span><span class="s1">;</span>
    <span class="s3">length </span><span class="s1">= </span><span class="s5">8</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'code point within a string may not be greater than 0xFFFFFFFF'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">' </span><span class="s1">+ </span><span class="s3">handle </span><span class="s1">+ </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">'0'</span><span class="s1">, </span><span class="s3">length </span><span class="s1">- </span><span class="s3">string</span><span class="s1">.</span><span class="s3">length</span><span class="s1">) + </span><span class="s3">string</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">State</span><span class="s1">(</span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">schema        </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'schema'</span><span class="s1">] || </span><span class="s3">DEFAULT_FULL_SCHEMA</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">indent        </span><span class="s1">= </span><span class="s3">Math</span><span class="s1">.</span><span class="s3">max</span><span class="s1">(</span><span class="s5">1</span><span class="s1">, (</span><span class="s3">options</span><span class="s1">[</span><span class="s4">'indent'</span><span class="s1">] || </span><span class="s5">2</span><span class="s1">));</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">noArrayIndent </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'noArrayIndent'</span><span class="s1">] || </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">skipInvalid   </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'skipInvalid'</span><span class="s1">] || </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">flowLevel     </span><span class="s1">= (</span><span class="s3">common</span><span class="s1">.</span><span class="s3">isNothing</span><span class="s1">(</span><span class="s3">options</span><span class="s1">[</span><span class="s4">'flowLevel'</span><span class="s1">]) ? -</span><span class="s5">1 </span><span class="s1">: </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'flowLevel'</span><span class="s1">]);</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">styleMap      </span><span class="s1">= </span><span class="s3">compileStyleMap</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s3">schema</span><span class="s1">, </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'styles'</span><span class="s1">] || </span><span class="s2">null</span><span class="s1">);</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">sortKeys      </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'sortKeys'</span><span class="s1">] || </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">lineWidth     </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'lineWidth'</span><span class="s1">] || </span><span class="s5">80</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">noRefs        </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'noRefs'</span><span class="s1">] || </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">noCompatMode  </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'noCompatMode'</span><span class="s1">] || </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">condenseFlow  </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'condenseFlow'</span><span class="s1">] || </span><span class="s2">false</span><span class="s1">;</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">implicitTypes </span><span class="s1">= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">schema</span><span class="s1">.</span><span class="s3">compiledImplicit</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">explicitTypes </span><span class="s1">= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">schema</span><span class="s1">.</span><span class="s3">compiledExplicit</span><span class="s1">;</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">duplicates </span><span class="s1">= [];</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">usedDuplicates </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// Indents every line in a string. Empty lines (\n only) are not indented.</span>
<span class="s2">function </span><span class="s3">indentString</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">spaces</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">ind </span><span class="s1">= </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">' '</span><span class="s1">, </span><span class="s3">spaces</span><span class="s1">),</span>
      <span class="s3">position </span><span class="s1">= </span><span class="s5">0</span><span class="s1">,</span>
      <span class="s3">next </span><span class="s1">= -</span><span class="s5">1</span><span class="s1">,</span>
      <span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">,</span>
      <span class="s3">line</span><span class="s1">,</span>
      <span class="s3">length </span><span class="s1">= </span><span class="s3">string</span><span class="s1">.</span><span class="s3">length</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">position </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">) {</span>
    <span class="s3">next </span><span class="s1">= </span><span class="s3">string</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">, </span><span class="s3">position</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">next </span><span class="s1">=== -</span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s3">line </span><span class="s1">= </span><span class="s3">string</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">position</span><span class="s1">);</span>
      <span class="s3">position </span><span class="s1">= </span><span class="s3">length</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">line </span><span class="s1">= </span><span class="s3">string</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">position</span><span class="s1">, </span><span class="s3">next </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
      <span class="s3">position </span><span class="s1">= </span><span class="s3">next </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">line</span><span class="s1">.</span><span class="s3">length </span><span class="s1">&amp;&amp; </span><span class="s3">line </span><span class="s1">!== </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">) </span><span class="s3">result </span><span class="s1">+= </span><span class="s3">ind</span><span class="s1">;</span>

    <span class="s3">result </span><span class="s1">+= </span><span class="s3">line</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">generateNextLine</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">+ </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">' '</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">indent </span><span class="s1">* </span><span class="s3">level</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">testImplicitResolving</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">str</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">index</span><span class="s1">, </span><span class="s3">length</span><span class="s1">, </span><span class="s3">type</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">implicitTypes</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">type </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">implicitTypes</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">type</span><span class="s1">.</span><span class="s3">resolve</span><span class="s1">(</span><span class="s3">str</span><span class="s1">)) {</span>
      <span class="s2">return true</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">return false</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// [33] s-white ::= s-space | s-tab</span>
<span class="s2">function </span><span class="s3">isWhitespace</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">c </span><span class="s1">=== </span><span class="s3">CHAR_SPACE </span><span class="s1">|| </span><span class="s3">c </span><span class="s1">=== </span><span class="s3">CHAR_TAB</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// Returns true if the character can be printed without escaping.</span>
<span class="s0">// From YAML 1.2: &quot;any allowed characters known to be non-printable</span>
<span class="s0">// should also be escaped. [However,] This isnt mandatory&quot;</span>
<span class="s0">// Derived from nb-char - \t - #x85 - #xA0 - #x2028 - #x2029.</span>
<span class="s2">function </span><span class="s3">isPrintable</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return  </span><span class="s1">(</span><span class="s5">0x00020 </span><span class="s1">&lt;= </span><span class="s3">c </span><span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x00007E</span><span class="s1">)</span>
      <span class="s1">|| ((</span><span class="s5">0x000A1 </span><span class="s1">&lt;= </span><span class="s3">c </span><span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x00D7FF</span><span class="s1">) &amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s5">0x2028 </span><span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s5">0x2029</span><span class="s1">)</span>
      <span class="s1">|| ((</span><span class="s5">0x0E000 </span><span class="s1">&lt;= </span><span class="s3">c </span><span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x00FFFD</span><span class="s1">) &amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s5">0xFEFF </span><span class="s0">/* BOM */</span><span class="s1">)</span>
      <span class="s1">||  (</span><span class="s5">0x10000 </span><span class="s1">&lt;= </span><span class="s3">c </span><span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x10FFFF</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s0">// [34] ns-char ::= nb-char - s-white</span>
<span class="s0">// [27] nb-char ::= c-printable - b-char - c-byte-order-mark</span>
<span class="s0">// [26] b-char  ::= b-line-feed | b-carriage-return</span>
<span class="s0">// [24] b-line-feed       ::=     #xA    /* LF */</span>
<span class="s0">// [25] b-carriage-return ::=     #xD    /* CR */</span>
<span class="s0">// [3]  c-byte-order-mark ::=     #xFEFF</span>
<span class="s2">function </span><span class="s3">isNsChar</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">isPrintable</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) &amp;&amp; !</span><span class="s3">isWhitespace</span><span class="s1">(</span><span class="s3">c</span><span class="s1">)</span>
    <span class="s0">// byte-order-mark</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s5">0xFEFF</span>
    <span class="s0">// b-char</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_CARRIAGE_RETURN</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_LINE_FEED</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// Simplified test for values allowed after the first character in plain style.</span>
<span class="s2">function </span><span class="s3">isPlainSafe</span><span class="s1">(</span><span class="s3">c</span><span class="s1">, </span><span class="s3">prev</span><span class="s1">) {</span>
  <span class="s0">// Uses a subset of nb-char - c-flow-indicator - &quot;:&quot; - &quot;#&quot;</span>
  <span class="s0">// where nb-char ::= c-printable - b-char - c-byte-order-mark.</span>
  <span class="s2">return </span><span class="s3">isPrintable</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) &amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s5">0xFEFF</span>
    <span class="s0">// - c-flow-indicator</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_COMMA</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_LEFT_SQUARE_BRACKET</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_RIGHT_SQUARE_BRACKET</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_LEFT_CURLY_BRACKET</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_RIGHT_CURLY_BRACKET</span>
    <span class="s0">// - &quot;:&quot; - &quot;#&quot;</span>
    <span class="s0">// /* An ns-char preceding */ &quot;#&quot;</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_COLON</span>
    <span class="s1">&amp;&amp; ((</span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_SHARP</span><span class="s1">) || (</span><span class="s3">prev </span><span class="s1">&amp;&amp; </span><span class="s3">isNsChar</span><span class="s1">(</span><span class="s3">prev</span><span class="s1">)));</span>
<span class="s1">}</span>

<span class="s0">// Simplified test for values allowed as the first character in plain style.</span>
<span class="s2">function </span><span class="s3">isPlainSafeFirst</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s0">// Uses a subset of ns-char - c-indicator</span>
  <span class="s0">// where ns-char = nb-char - s-white.</span>
  <span class="s2">return </span><span class="s3">isPrintable</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) &amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s5">0xFEFF</span>
    <span class="s1">&amp;&amp; !</span><span class="s3">isWhitespace</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) </span><span class="s0">// - s-white</span>
    <span class="s0">// - (c-indicator ::=</span>
    <span class="s0">// - | ? | : | , | [ | ] | { | }</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_MINUS</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_QUESTION</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_COLON</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_COMMA</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_LEFT_SQUARE_BRACKET</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_RIGHT_SQUARE_BRACKET</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_LEFT_CURLY_BRACKET</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_RIGHT_CURLY_BRACKET</span>
    <span class="s0">// | # | &amp; | * | ! | | | = | &gt; | ' | &quot;</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_SHARP</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_AMPERSAND</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_ASTERISK</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_EXCLAMATION</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_VERTICAL_LINE</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_EQUALS</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_GREATER_THAN</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_SINGLE_QUOTE</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_DOUBLE_QUOTE</span>
    <span class="s0">// | % | @ | `)</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_PERCENT</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_COMMERCIAL_AT</span>
    <span class="s1">&amp;&amp; </span><span class="s3">c </span><span class="s1">!== </span><span class="s3">CHAR_GRAVE_ACCENT</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// Determines whether block indentation indicator is required.</span>
<span class="s2">function </span><span class="s3">needIndentIndicator</span><span class="s1">(</span><span class="s3">string</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">leadingSpaceRe </span><span class="s1">= </span><span class="s6">/^\n* /</span><span class="s1">;</span>
  <span class="s2">return </span><span class="s3">leadingSpaceRe</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">string</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">var </span><span class="s3">STYLE_PLAIN   </span><span class="s1">= </span><span class="s5">1</span><span class="s1">,</span>
    <span class="s3">STYLE_SINGLE  </span><span class="s1">= </span><span class="s5">2</span><span class="s1">,</span>
    <span class="s3">STYLE_LITERAL </span><span class="s1">= </span><span class="s5">3</span><span class="s1">,</span>
    <span class="s3">STYLE_FOLDED  </span><span class="s1">= </span><span class="s5">4</span><span class="s1">,</span>
    <span class="s3">STYLE_DOUBLE  </span><span class="s1">= </span><span class="s5">5</span><span class="s1">;</span>

<span class="s0">// Determines which scalar styles are possible and returns the preferred style.</span>
<span class="s0">// lineWidth = -1 =&gt; no limit.</span>
<span class="s0">// Pre-conditions: str.length &gt; 0.</span>
<span class="s0">// Post-conditions:</span>
<span class="s0">//    STYLE_PLAIN or STYLE_SINGLE =&gt; no \n are in the string.</span>
<span class="s0">//    STYLE_LITERAL =&gt; no lines are suitable for folding (or lineWidth is -1).</span>
<span class="s0">//    STYLE_FOLDED =&gt; a line &gt; lineWidth and can be folded (and lineWidth != -1).</span>
<span class="s2">function </span><span class="s3">chooseScalarStyle</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">singleLineOnly</span><span class="s1">, </span><span class="s3">indentPerLevel</span><span class="s1">, </span><span class="s3">lineWidth</span><span class="s1">, </span><span class="s3">testAmbiguousType</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">i</span><span class="s1">;</span>
  <span class="s2">var </span><span class="s3">char</span><span class="s1">, </span><span class="s3">prev_char</span><span class="s1">;</span>
  <span class="s2">var </span><span class="s3">hasLineBreak </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s2">var </span><span class="s3">hasFoldableLine </span><span class="s1">= </span><span class="s2">false</span><span class="s1">; </span><span class="s0">// only checked if shouldTrackWidth</span>
  <span class="s2">var </span><span class="s3">shouldTrackWidth </span><span class="s1">= </span><span class="s3">lineWidth </span><span class="s1">!== -</span><span class="s5">1</span><span class="s1">;</span>
  <span class="s2">var </span><span class="s3">previousLineBreak </span><span class="s1">= -</span><span class="s5">1</span><span class="s1">; </span><span class="s0">// count the first line correctly</span>
  <span class="s2">var </span><span class="s3">plain </span><span class="s1">= </span><span class="s3">isPlainSafeFirst</span><span class="s1">(</span><span class="s3">string</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s5">0</span><span class="s1">))</span>
          <span class="s1">&amp;&amp; !</span><span class="s3">isWhitespace</span><span class="s1">(</span><span class="s3">string</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">string</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">));</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">singleLineOnly</span><span class="s1">) {</span>
    <span class="s0">// Case: no block styles.</span>
    <span class="s0">// Check for disallowed characters to rule out plain and single.</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s3">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s3">i </span><span class="s1">&lt; </span><span class="s3">string</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">i</span><span class="s1">++) {</span>
      <span class="s3">char </span><span class="s1">= </span><span class="s3">string</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">i</span><span class="s1">);</span>
      <span class="s2">if </span><span class="s1">(!</span><span class="s3">isPrintable</span><span class="s1">(</span><span class="s3">char</span><span class="s1">)) {</span>
        <span class="s2">return </span><span class="s3">STYLE_DOUBLE</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">prev_char </span><span class="s1">= </span><span class="s3">i </span><span class="s1">&gt; </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">string</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">i </span><span class="s1">- </span><span class="s5">1</span><span class="s1">) : </span><span class="s2">null</span><span class="s1">;</span>
      <span class="s3">plain </span><span class="s1">= </span><span class="s3">plain </span><span class="s1">&amp;&amp; </span><span class="s3">isPlainSafe</span><span class="s1">(</span><span class="s3">char</span><span class="s1">, </span><span class="s3">prev_char</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s0">// Case: block styles permitted.</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s3">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s3">i </span><span class="s1">&lt; </span><span class="s3">string</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">i</span><span class="s1">++) {</span>
      <span class="s3">char </span><span class="s1">= </span><span class="s3">string</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">i</span><span class="s1">);</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">char </span><span class="s1">=== </span><span class="s3">CHAR_LINE_FEED</span><span class="s1">) {</span>
        <span class="s3">hasLineBreak </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
        <span class="s0">// Check if any line can be folded.</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">shouldTrackWidth</span><span class="s1">) {</span>
          <span class="s3">hasFoldableLine </span><span class="s1">= </span><span class="s3">hasFoldableLine </span><span class="s1">||</span>
            <span class="s0">// Foldable line = too long, and not more-indented.</span>
            <span class="s1">(</span><span class="s3">i </span><span class="s1">- </span><span class="s3">previousLineBreak </span><span class="s1">- </span><span class="s5">1 </span><span class="s1">&gt; </span><span class="s3">lineWidth </span><span class="s1">&amp;&amp;</span>
             <span class="s3">string</span><span class="s1">[</span><span class="s3">previousLineBreak </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">] !== </span><span class="s4">' '</span><span class="s1">);</span>
          <span class="s3">previousLineBreak </span><span class="s1">= </span><span class="s3">i</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!</span><span class="s3">isPrintable</span><span class="s1">(</span><span class="s3">char</span><span class="s1">)) {</span>
        <span class="s2">return </span><span class="s3">STYLE_DOUBLE</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">prev_char </span><span class="s1">= </span><span class="s3">i </span><span class="s1">&gt; </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">string</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">i </span><span class="s1">- </span><span class="s5">1</span><span class="s1">) : </span><span class="s2">null</span><span class="s1">;</span>
      <span class="s3">plain </span><span class="s1">= </span><span class="s3">plain </span><span class="s1">&amp;&amp; </span><span class="s3">isPlainSafe</span><span class="s1">(</span><span class="s3">char</span><span class="s1">, </span><span class="s3">prev_char</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// in case the end is missing a \n</span>
    <span class="s3">hasFoldableLine </span><span class="s1">= </span><span class="s3">hasFoldableLine </span><span class="s1">|| (</span><span class="s3">shouldTrackWidth </span><span class="s1">&amp;&amp;</span>
      <span class="s1">(</span><span class="s3">i </span><span class="s1">- </span><span class="s3">previousLineBreak </span><span class="s1">- </span><span class="s5">1 </span><span class="s1">&gt; </span><span class="s3">lineWidth </span><span class="s1">&amp;&amp;</span>
       <span class="s3">string</span><span class="s1">[</span><span class="s3">previousLineBreak </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">] !== </span><span class="s4">' '</span><span class="s1">));</span>
  <span class="s1">}</span>
  <span class="s0">// Although every style can represent \n without escaping, prefer block styles</span>
  <span class="s0">// for multiline, since they're more readable and they don't add empty lines.</span>
  <span class="s0">// Also prefer folding a super-long line.</span>
  <span class="s2">if </span><span class="s1">(!</span><span class="s3">hasLineBreak </span><span class="s1">&amp;&amp; !</span><span class="s3">hasFoldableLine</span><span class="s1">) {</span>
    <span class="s0">// Strings interpretable as another type have to be quoted;</span>
    <span class="s0">// e.g. the string 'true' vs. the boolean true.</span>
    <span class="s2">return </span><span class="s3">plain </span><span class="s1">&amp;&amp; !</span><span class="s3">testAmbiguousType</span><span class="s1">(</span><span class="s3">string</span><span class="s1">)</span>
      <span class="s1">? </span><span class="s3">STYLE_PLAIN </span><span class="s1">: </span><span class="s3">STYLE_SINGLE</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s0">// Edge case: block indentation indicator can only have one digit.</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">indentPerLevel </span><span class="s1">&gt; </span><span class="s5">9 </span><span class="s1">&amp;&amp; </span><span class="s3">needIndentIndicator</span><span class="s1">(</span><span class="s3">string</span><span class="s1">)) {</span>
    <span class="s2">return </span><span class="s3">STYLE_DOUBLE</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s0">// At this point we know block styles are valid.</span>
  <span class="s0">// Prefer literal style unless we want to fold.</span>
  <span class="s2">return </span><span class="s3">hasFoldableLine </span><span class="s1">? </span><span class="s3">STYLE_FOLDED </span><span class="s1">: </span><span class="s3">STYLE_LITERAL</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// Note: line breaking/folding is implemented for only the folded style.</span>
<span class="s0">// NB. We drop the last trailing newline (if any) of a returned block scalar</span>
<span class="s0">//  since the dumper adds its own newline. This always works:</span>
<span class="s0">//     No ending newline =&gt; unaffected; already using strip &quot;-&quot; chomping.</span>
<span class="s0">//     Ending newline    =&gt; removed then restored.</span>
<span class="s0">//  Importantly, this keeps the &quot;+&quot; chomp indicator from gaining an extra line.</span>
<span class="s2">function </span><span class="s3">writeScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">string</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">iskey</span><span class="s1">) {</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= (</span><span class="s2">function </span><span class="s1">() {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">string</span><span class="s1">.</span><span class="s3">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s2">return </span><span class="s4">&quot;''&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(!</span><span class="s3">state</span><span class="s1">.</span><span class="s3">noCompatMode </span><span class="s1">&amp;&amp;</span>
        <span class="s3">DEPRECATED_BOOLEANS_SYNTAX</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">string</span><span class="s1">) !== -</span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s2">return </span><span class="s4">&quot;'&quot; </span><span class="s1">+ </span><span class="s3">string </span><span class="s1">+ </span><span class="s4">&quot;'&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">var </span><span class="s3">indent </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">indent </span><span class="s1">* </span><span class="s3">Math</span><span class="s1">.</span><span class="s3">max</span><span class="s1">(</span><span class="s5">1</span><span class="s1">, </span><span class="s3">level</span><span class="s1">); </span><span class="s0">// no 0-indent scalars</span>
    <span class="s0">// As indentation gets deeper, let the width decrease monotonically</span>
    <span class="s0">// to the lower bound min(state.lineWidth, 40).</span>
    <span class="s0">// Note that this implies</span>
    <span class="s0">//  state.lineWidth  40 + state.indent: width is fixed at the lower bound.</span>
    <span class="s0">//  state.lineWidth &gt; 40 + state.indent: width decreases until the lower bound.</span>
    <span class="s0">// This behaves better than a constant minimum width which disallows narrower options,</span>
    <span class="s0">// or an indent threshold which causes the width to suddenly increase.</span>
    <span class="s2">var </span><span class="s3">lineWidth </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineWidth </span><span class="s1">=== -</span><span class="s5">1</span>
      <span class="s1">? -</span><span class="s5">1 </span><span class="s1">: </span><span class="s3">Math</span><span class="s1">.</span><span class="s3">max</span><span class="s1">(</span><span class="s3">Math</span><span class="s1">.</span><span class="s3">min</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineWidth</span><span class="s1">, </span><span class="s5">40</span><span class="s1">), </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineWidth </span><span class="s1">- </span><span class="s3">indent</span><span class="s1">);</span>

    <span class="s0">// Without knowing if keys are implicit/explicit, assume implicit for safety.</span>
    <span class="s2">var </span><span class="s3">singleLineOnly </span><span class="s1">= </span><span class="s3">iskey</span>
      <span class="s0">// No block styles in flow mode.</span>
      <span class="s1">|| (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">flowLevel </span><span class="s1">&gt; -</span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s3">level </span><span class="s1">&gt;= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">flowLevel</span><span class="s1">);</span>
    <span class="s2">function </span><span class="s3">testAmbiguity</span><span class="s1">(</span><span class="s3">string</span><span class="s1">) {</span>
      <span class="s2">return </span><span class="s3">testImplicitResolving</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">string</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">switch </span><span class="s1">(</span><span class="s3">chooseScalarStyle</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">singleLineOnly</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">indent</span><span class="s1">, </span><span class="s3">lineWidth</span><span class="s1">, </span><span class="s3">testAmbiguity</span><span class="s1">)) {</span>
      <span class="s2">case </span><span class="s3">STYLE_PLAIN</span><span class="s1">:</span>
        <span class="s2">return </span><span class="s3">string</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s3">STYLE_SINGLE</span><span class="s1">:</span>
        <span class="s2">return </span><span class="s4">&quot;'&quot; </span><span class="s1">+ </span><span class="s3">string</span><span class="s1">.</span><span class="s3">replace</span><span class="s1">(</span><span class="s6">/'/g</span><span class="s1">, </span><span class="s4">&quot;''&quot;</span><span class="s1">) + </span><span class="s4">&quot;'&quot;</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s3">STYLE_LITERAL</span><span class="s1">:</span>
        <span class="s2">return </span><span class="s4">'|' </span><span class="s1">+ </span><span class="s3">blockHeader</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">indent</span><span class="s1">)</span>
          <span class="s1">+ </span><span class="s3">dropEndingNewline</span><span class="s1">(</span><span class="s3">indentString</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">indent</span><span class="s1">));</span>
      <span class="s2">case </span><span class="s3">STYLE_FOLDED</span><span class="s1">:</span>
        <span class="s2">return </span><span class="s4">'&gt;' </span><span class="s1">+ </span><span class="s3">blockHeader</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">indent</span><span class="s1">)</span>
          <span class="s1">+ </span><span class="s3">dropEndingNewline</span><span class="s1">(</span><span class="s3">indentString</span><span class="s1">(</span><span class="s3">foldString</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">lineWidth</span><span class="s1">), </span><span class="s3">indent</span><span class="s1">));</span>
      <span class="s2">case </span><span class="s3">STYLE_DOUBLE</span><span class="s1">:</span>
        <span class="s2">return </span><span class="s4">'&quot;' </span><span class="s1">+ </span><span class="s3">escapeString</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">lineWidth</span><span class="s1">) + </span><span class="s4">'&quot;'</span><span class="s1">;</span>
      <span class="s2">default</span><span class="s1">:</span>
        <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'impossible error: invalid scalar style'</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}());</span>
<span class="s1">}</span>

<span class="s0">// Pre-conditions: string is valid for a block scalar, 1 &lt;= indentPerLevel &lt;= 9.</span>
<span class="s2">function </span><span class="s3">blockHeader</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">indentPerLevel</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">indentIndicator </span><span class="s1">= </span><span class="s3">needIndentIndicator</span><span class="s1">(</span><span class="s3">string</span><span class="s1">) ? </span><span class="s3">String</span><span class="s1">(</span><span class="s3">indentPerLevel</span><span class="s1">) : </span><span class="s4">''</span><span class="s1">;</span>

  <span class="s0">// note the special case: the string '\n' counts as a &quot;trailing&quot; empty line.</span>
  <span class="s2">var </span><span class="s3">clip </span><span class="s1">=          </span><span class="s3">string</span><span class="s1">[</span><span class="s3">string</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">] === </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">;</span>
  <span class="s2">var </span><span class="s3">keep </span><span class="s1">= </span><span class="s3">clip </span><span class="s1">&amp;&amp; (</span><span class="s3">string</span><span class="s1">[</span><span class="s3">string</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">2</span><span class="s1">] === </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">|| </span><span class="s3">string </span><span class="s1">=== </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">);</span>
  <span class="s2">var </span><span class="s3">chomp </span><span class="s1">= </span><span class="s3">keep </span><span class="s1">? </span><span class="s4">'+' </span><span class="s1">: (</span><span class="s3">clip </span><span class="s1">? </span><span class="s4">'' </span><span class="s1">: </span><span class="s4">'-'</span><span class="s1">);</span>

  <span class="s2">return </span><span class="s3">indentIndicator </span><span class="s1">+ </span><span class="s3">chomp </span><span class="s1">+ </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// (See the note for writeScalar.)</span>
<span class="s2">function </span><span class="s3">dropEndingNewline</span><span class="s1">(</span><span class="s3">string</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">string</span><span class="s1">[</span><span class="s3">string</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">] === </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">? </span><span class="s3">string</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">) : </span><span class="s3">string</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// Note: a long line without a suitable break point will exceed the width limit.</span>
<span class="s0">// Pre-conditions: every char in str isPrintable, str.length &gt; 0, width &gt; 0.</span>
<span class="s2">function </span><span class="s3">foldString</span><span class="s1">(</span><span class="s3">string</span><span class="s1">, </span><span class="s3">width</span><span class="s1">) {</span>
  <span class="s0">// In folded style, $k$ consecutive newlines output as $k+1$ newlines</span>
  <span class="s0">// unless they're before or after a more-indented line, or at the very</span>
  <span class="s0">// beginning or end, in which case $k$ maps to $k$.</span>
  <span class="s0">// Therefore, parse each chunk as newline(s) followed by a content line.</span>
  <span class="s2">var </span><span class="s3">lineRe </span><span class="s1">= </span><span class="s6">/(\n+)([^\n]*)/g</span><span class="s1">;</span>

  <span class="s0">// first line (possibly an empty line)</span>
  <span class="s2">var </span><span class="s3">result </span><span class="s1">= (</span><span class="s2">function </span><span class="s1">() {</span>
    <span class="s2">var </span><span class="s3">nextLF </span><span class="s1">= </span><span class="s3">string</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">);</span>
    <span class="s3">nextLF </span><span class="s1">= </span><span class="s3">nextLF </span><span class="s1">!== -</span><span class="s5">1 </span><span class="s1">? </span><span class="s3">nextLF </span><span class="s1">: </span><span class="s3">string</span><span class="s1">.</span><span class="s3">length</span><span class="s1">;</span>
    <span class="s3">lineRe</span><span class="s1">.</span><span class="s3">lastIndex </span><span class="s1">= </span><span class="s3">nextLF</span><span class="s1">;</span>
    <span class="s2">return </span><span class="s3">foldLine</span><span class="s1">(</span><span class="s3">string</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s3">nextLF</span><span class="s1">), </span><span class="s3">width</span><span class="s1">);</span>
  <span class="s1">}());</span>
  <span class="s0">// If we haven't reached the first content line yet, don't add an extra \n.</span>
  <span class="s2">var </span><span class="s3">prevMoreIndented </span><span class="s1">= </span><span class="s3">string</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">|| </span><span class="s3">string</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s4">' '</span><span class="s1">;</span>
  <span class="s2">var </span><span class="s3">moreIndented</span><span class="s1">;</span>

  <span class="s0">// rest of the lines</span>
  <span class="s2">var </span><span class="s3">match</span><span class="s1">;</span>
  <span class="s2">while </span><span class="s1">((</span><span class="s3">match </span><span class="s1">= </span><span class="s3">lineRe</span><span class="s1">.</span><span class="s3">exec</span><span class="s1">(</span><span class="s3">string</span><span class="s1">))) {</span>
    <span class="s2">var </span><span class="s3">prefix </span><span class="s1">= </span><span class="s3">match</span><span class="s1">[</span><span class="s5">1</span><span class="s1">], </span><span class="s3">line </span><span class="s1">= </span><span class="s3">match</span><span class="s1">[</span><span class="s5">2</span><span class="s1">];</span>
    <span class="s3">moreIndented </span><span class="s1">= (</span><span class="s3">line</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s4">' '</span><span class="s1">);</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">prefix</span>
      <span class="s1">+ (!</span><span class="s3">prevMoreIndented </span><span class="s1">&amp;&amp; !</span><span class="s3">moreIndented </span><span class="s1">&amp;&amp; </span><span class="s3">line </span><span class="s1">!== </span><span class="s4">''</span>
        <span class="s1">? </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">: </span><span class="s4">''</span><span class="s1">)</span>
      <span class="s1">+ </span><span class="s3">foldLine</span><span class="s1">(</span><span class="s3">line</span><span class="s1">, </span><span class="s3">width</span><span class="s1">);</span>
    <span class="s3">prevMoreIndented </span><span class="s1">= </span><span class="s3">moreIndented</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// Greedy line breaking.</span>
<span class="s0">// Picks the longest line under the limit each time,</span>
<span class="s0">// otherwise settles for the shortest line over the limit.</span>
<span class="s0">// NB. More-indented lines *cannot* be folded, as that would add an extra \n.</span>
<span class="s2">function </span><span class="s3">foldLine</span><span class="s1">(</span><span class="s3">line</span><span class="s1">, </span><span class="s3">width</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">line </span><span class="s1">=== </span><span class="s4">'' </span><span class="s1">|| </span><span class="s3">line</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s4">' '</span><span class="s1">) </span><span class="s2">return </span><span class="s3">line</span><span class="s1">;</span>

  <span class="s0">// Since a more-indented line adds a \n, breaks can't be followed by a space.</span>
  <span class="s2">var </span><span class="s3">breakRe </span><span class="s1">= </span><span class="s6">/ [^ ]/g</span><span class="s1">; </span><span class="s0">// note: the match index will always be &lt;= length-2.</span>
  <span class="s2">var </span><span class="s3">match</span><span class="s1">;</span>
  <span class="s0">// start is an inclusive index. end, curr, and next are exclusive.</span>
  <span class="s2">var </span><span class="s3">start </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">end</span><span class="s1">, </span><span class="s3">curr </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">next </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s2">var </span><span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>

  <span class="s0">// Invariants: 0 &lt;= start &lt;= length-1.</span>
  <span class="s0">//   0 &lt;= curr &lt;= next &lt;= max(0, length-2). curr - start &lt;= width.</span>
  <span class="s0">// Inside the loop:</span>
  <span class="s0">//   A match implies length &gt;= 2, so curr and next are &lt;= length-2.</span>
  <span class="s2">while </span><span class="s1">((</span><span class="s3">match </span><span class="s1">= </span><span class="s3">breakRe</span><span class="s1">.</span><span class="s3">exec</span><span class="s1">(</span><span class="s3">line</span><span class="s1">))) {</span>
    <span class="s3">next </span><span class="s1">= </span><span class="s3">match</span><span class="s1">.</span><span class="s3">index</span><span class="s1">;</span>
    <span class="s0">// maintain invariant: curr - start &lt;= width</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">next </span><span class="s1">- </span><span class="s3">start </span><span class="s1">&gt; </span><span class="s3">width</span><span class="s1">) {</span>
      <span class="s3">end </span><span class="s1">= (</span><span class="s3">curr </span><span class="s1">&gt; </span><span class="s3">start</span><span class="s1">) ? </span><span class="s3">curr </span><span class="s1">: </span><span class="s3">next</span><span class="s1">; </span><span class="s0">// derive end &lt;= length-2</span>
      <span class="s3">result </span><span class="s1">+= </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">+ </span><span class="s3">line</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">start</span><span class="s1">, </span><span class="s3">end</span><span class="s1">);</span>
      <span class="s0">// skip the space that was output as \n</span>
      <span class="s3">start </span><span class="s1">= </span><span class="s3">end </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;                    </span><span class="s0">// derive start &lt;= length-1</span>
    <span class="s1">}</span>
    <span class="s3">curr </span><span class="s1">= </span><span class="s3">next</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">// By the invariants, start &lt;= length-1, so there is something left over.</span>
  <span class="s0">// It is either the whole string or a part starting from non-whitespace.</span>
  <span class="s3">result </span><span class="s1">+= </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">;</span>
  <span class="s0">// Insert a break if the remainder is too long and there is a break available.</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">line</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s3">start </span><span class="s1">&gt; </span><span class="s3">width </span><span class="s1">&amp;&amp; </span><span class="s3">curr </span><span class="s1">&gt; </span><span class="s3">start</span><span class="s1">) {</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">line</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">start</span><span class="s1">, </span><span class="s3">curr</span><span class="s1">) + </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">+ </span><span class="s3">line</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">curr </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">line</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">start</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">1</span><span class="s1">); </span><span class="s0">// drop extra \n joiner</span>
<span class="s1">}</span>

<span class="s0">// Escapes a double-quoted string.</span>
<span class="s2">function </span><span class="s3">escapeString</span><span class="s1">(</span><span class="s3">string</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>
  <span class="s2">var </span><span class="s3">char</span><span class="s1">, </span><span class="s3">nextChar</span><span class="s1">;</span>
  <span class="s2">var </span><span class="s3">escapeSeq</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s3">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s3">i </span><span class="s1">&lt; </span><span class="s3">string</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">i</span><span class="s1">++) {</span>
    <span class="s3">char </span><span class="s1">= </span><span class="s3">string</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">i</span><span class="s1">);</span>
    <span class="s0">// Check for surrogate pairs (reference Unicode 3.0 section &quot;3.7 Surrogates&quot;).</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">char </span><span class="s1">&gt;= </span><span class="s5">0xD800 </span><span class="s1">&amp;&amp; </span><span class="s3">char </span><span class="s1">&lt;= </span><span class="s5">0xDBFF</span><span class="s0">/* high surrogate */</span><span class="s1">) {</span>
      <span class="s3">nextChar </span><span class="s1">= </span><span class="s3">string</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">nextChar </span><span class="s1">&gt;= </span><span class="s5">0xDC00 </span><span class="s1">&amp;&amp; </span><span class="s3">nextChar </span><span class="s1">&lt;= </span><span class="s5">0xDFFF</span><span class="s0">/* low surrogate */</span><span class="s1">) {</span>
        <span class="s0">// Combine the surrogate pair and store it escaped.</span>
        <span class="s3">result </span><span class="s1">+= </span><span class="s3">encodeHex</span><span class="s1">((</span><span class="s3">char </span><span class="s1">- </span><span class="s5">0xD800</span><span class="s1">) * </span><span class="s5">0x400 </span><span class="s1">+ </span><span class="s3">nextChar </span><span class="s1">- </span><span class="s5">0xDC00 </span><span class="s1">+ </span><span class="s5">0x10000</span><span class="s1">);</span>
        <span class="s0">// Advance index one extra since we already used that char here.</span>
        <span class="s3">i</span><span class="s1">++; </span><span class="s2">continue</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">escapeSeq </span><span class="s1">= </span><span class="s3">ESCAPE_SEQUENCES</span><span class="s1">[</span><span class="s3">char</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= !</span><span class="s3">escapeSeq </span><span class="s1">&amp;&amp; </span><span class="s3">isPrintable</span><span class="s1">(</span><span class="s3">char</span><span class="s1">)</span>
      <span class="s1">? </span><span class="s3">string</span><span class="s1">[</span><span class="s3">i</span><span class="s1">]</span>
      <span class="s1">: </span><span class="s3">escapeSeq </span><span class="s1">|| </span><span class="s3">encodeHex</span><span class="s1">(</span><span class="s3">char</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">writeFlowSequence</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">,</span>
      <span class="s3">_tag    </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">,</span>
      <span class="s3">index</span><span class="s1">,</span>
      <span class="s3">length</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">object</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s0">// Write only valid elements.</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">writeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">object</span><span class="s1">[</span><span class="s3">index</span><span class="s1">], </span><span class="s2">false</span><span class="s1">, </span><span class="s2">false</span><span class="s1">)) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">index </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) </span><span class="s3">_result </span><span class="s1">+= </span><span class="s4">',' </span><span class="s1">+ (!</span><span class="s3">state</span><span class="s1">.</span><span class="s3">condenseFlow </span><span class="s1">? </span><span class="s4">' ' </span><span class="s1">: </span><span class="s4">''</span><span class="s1">);</span>
      <span class="s3">_result </span><span class="s1">+= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">_tag</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s4">'[' </span><span class="s1">+ </span><span class="s3">_result </span><span class="s1">+ </span><span class="s4">']'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">writeBlockSequence</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">object</span><span class="s1">, </span><span class="s3">compact</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">,</span>
      <span class="s3">_tag    </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">,</span>
      <span class="s3">index</span><span class="s1">,</span>
      <span class="s3">length</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">object</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s0">// Write only valid elements.</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">writeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">, </span><span class="s3">object</span><span class="s1">[</span><span class="s3">index</span><span class="s1">], </span><span class="s2">true</span><span class="s1">, </span><span class="s2">true</span><span class="s1">)) {</span>
      <span class="s2">if </span><span class="s1">(!</span><span class="s3">compact </span><span class="s1">|| </span><span class="s3">index </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
        <span class="s3">_result </span><span class="s1">+= </span><span class="s3">generateNextLine</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">&amp;&amp; </span><span class="s3">CHAR_LINE_FEED </span><span class="s1">=== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s5">0</span><span class="s1">)) {</span>
        <span class="s3">_result </span><span class="s1">+= </span><span class="s4">'-'</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">_result </span><span class="s1">+= </span><span class="s4">'- '</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">_result </span><span class="s1">+= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">_tag</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s3">_result </span><span class="s1">|| </span><span class="s4">'[]'</span><span class="s1">; </span><span class="s0">// Empty sequence if no valid values.</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">writeFlowMapping</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_result       </span><span class="s1">= </span><span class="s4">''</span><span class="s1">,</span>
      <span class="s3">_tag          </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">,</span>
      <span class="s3">objectKeyList </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">object</span><span class="s1">),</span>
      <span class="s3">index</span><span class="s1">,</span>
      <span class="s3">length</span><span class="s1">,</span>
      <span class="s3">objectKey</span><span class="s1">,</span>
      <span class="s3">objectValue</span><span class="s1">,</span>
      <span class="s3">pairBuffer</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">objectKeyList</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>

    <span class="s3">pairBuffer </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">index </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) </span><span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s4">', '</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">condenseFlow</span><span class="s1">) </span><span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s4">'&quot;'</span><span class="s1">;</span>

    <span class="s3">objectKey </span><span class="s1">= </span><span class="s3">objectKeyList</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>
    <span class="s3">objectValue </span><span class="s1">= </span><span class="s3">object</span><span class="s1">[</span><span class="s3">objectKey</span><span class="s1">];</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">writeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">objectKey</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s2">false</span><span class="s1">)) {</span>
      <span class="s2">continue</span><span class="s1">; </span><span class="s0">// Skip this pair because of invalid key;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">.</span><span class="s3">length </span><span class="s1">&gt; </span><span class="s5">1024</span><span class="s1">) </span><span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s4">'? '</span><span class="s1">;</span>

    <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">+ (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">condenseFlow </span><span class="s1">? </span><span class="s4">'&quot;' </span><span class="s1">: </span><span class="s4">''</span><span class="s1">) + </span><span class="s4">':' </span><span class="s1">+ (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">condenseFlow </span><span class="s1">? </span><span class="s4">'' </span><span class="s1">: </span><span class="s4">' '</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">writeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">objectValue</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s2">false</span><span class="s1">)) {</span>
      <span class="s2">continue</span><span class="s1">; </span><span class="s0">// Skip this pair because of invalid value.</span>
    <span class="s1">}</span>

    <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>

    <span class="s0">// Both key and value are valid.</span>
    <span class="s3">_result </span><span class="s1">+= </span><span class="s3">pairBuffer</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">_tag</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s4">'{' </span><span class="s1">+ </span><span class="s3">_result </span><span class="s1">+ </span><span class="s4">'}'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">writeBlockMapping</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">object</span><span class="s1">, </span><span class="s3">compact</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_result       </span><span class="s1">= </span><span class="s4">''</span><span class="s1">,</span>
      <span class="s3">_tag          </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">,</span>
      <span class="s3">objectKeyList </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">object</span><span class="s1">),</span>
      <span class="s3">index</span><span class="s1">,</span>
      <span class="s3">length</span><span class="s1">,</span>
      <span class="s3">objectKey</span><span class="s1">,</span>
      <span class="s3">objectValue</span><span class="s1">,</span>
      <span class="s3">explicitPair</span><span class="s1">,</span>
      <span class="s3">pairBuffer</span><span class="s1">;</span>

  <span class="s0">// Allow sorting keys so that the output file is deterministic</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">sortKeys </span><span class="s1">=== </span><span class="s2">true</span><span class="s1">) {</span>
    <span class="s0">// Default sorting</span>
    <span class="s3">objectKeyList</span><span class="s1">.</span><span class="s3">sort</span><span class="s1">();</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">state</span><span class="s1">.</span><span class="s3">sortKeys </span><span class="s1">=== </span><span class="s4">'function'</span><span class="s1">) {</span>
    <span class="s0">// Custom sort function</span>
    <span class="s3">objectKeyList</span><span class="s1">.</span><span class="s3">sort</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">sortKeys</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">sortKeys</span><span class="s1">) {</span>
    <span class="s0">// Something is wrong</span>
    <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'sortKeys must be a boolean or a function'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">objectKeyList</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">pairBuffer </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">compact </span><span class="s1">|| </span><span class="s3">index </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s3">generateNextLine</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">objectKey </span><span class="s1">= </span><span class="s3">objectKeyList</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>
    <span class="s3">objectValue </span><span class="s1">= </span><span class="s3">object</span><span class="s1">[</span><span class="s3">objectKey</span><span class="s1">];</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">writeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">, </span><span class="s3">objectKey</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s2">true</span><span class="s1">)) {</span>
      <span class="s2">continue</span><span class="s1">; </span><span class="s0">// Skip this pair because of invalid key.</span>
    <span class="s1">}</span>

    <span class="s3">explicitPair </span><span class="s1">= (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">&amp;&amp; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s4">'?'</span><span class="s1">) ||</span>
                   <span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">&amp;&amp; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">.</span><span class="s3">length </span><span class="s1">&gt; </span><span class="s5">1024</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">explicitPair</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">&amp;&amp; </span><span class="s3">CHAR_LINE_FEED </span><span class="s1">=== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s5">0</span><span class="s1">)) {</span>
        <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s4">'?'</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s4">'? '</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">explicitPair</span><span class="s1">) {</span>
      <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s3">generateNextLine</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">writeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">, </span><span class="s3">objectValue</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s3">explicitPair</span><span class="s1">)) {</span>
      <span class="s2">continue</span><span class="s1">; </span><span class="s0">// Skip this pair because of invalid value.</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">&amp;&amp; </span><span class="s3">CHAR_LINE_FEED </span><span class="s1">=== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s5">0</span><span class="s1">)) {</span>
      <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s4">':'</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s4">': '</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">pairBuffer </span><span class="s1">+= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>

    <span class="s0">// Both key and value are valid.</span>
    <span class="s3">_result </span><span class="s1">+= </span><span class="s3">pairBuffer</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">_tag</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s3">_result </span><span class="s1">|| </span><span class="s4">'{}'</span><span class="s1">; </span><span class="s0">// Empty mapping if no valid pairs.</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">detectType</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">object</span><span class="s1">, </span><span class="s3">explicit</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_result</span><span class="s1">, </span><span class="s3">typeList</span><span class="s1">, </span><span class="s3">index</span><span class="s1">, </span><span class="s3">length</span><span class="s1">, </span><span class="s3">type</span><span class="s1">, </span><span class="s3">style</span><span class="s1">;</span>

  <span class="s3">typeList </span><span class="s1">= </span><span class="s3">explicit </span><span class="s1">? </span><span class="s3">state</span><span class="s1">.</span><span class="s3">explicitTypes </span><span class="s1">: </span><span class="s3">state</span><span class="s1">.</span><span class="s3">implicitTypes</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">typeList</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">type </span><span class="s1">= </span><span class="s3">typeList</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>

    <span class="s2">if </span><span class="s1">((</span><span class="s3">type</span><span class="s1">.</span><span class="s3">instanceOf  </span><span class="s1">|| </span><span class="s3">type</span><span class="s1">.</span><span class="s3">predicate</span><span class="s1">) &amp;&amp;</span>
        <span class="s1">(!</span><span class="s3">type</span><span class="s1">.</span><span class="s3">instanceOf </span><span class="s1">|| ((</span><span class="s2">typeof </span><span class="s3">object </span><span class="s1">=== </span><span class="s4">'object'</span><span class="s1">) &amp;&amp; (</span><span class="s3">object </span><span class="s2">instanceof </span><span class="s3">type</span><span class="s1">.</span><span class="s3">instanceOf</span><span class="s1">))) &amp;&amp;</span>
        <span class="s1">(!</span><span class="s3">type</span><span class="s1">.</span><span class="s3">predicate  </span><span class="s1">|| </span><span class="s3">type</span><span class="s1">.</span><span class="s3">predicate</span><span class="s1">(</span><span class="s3">object</span><span class="s1">))) {</span>

      <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">explicit </span><span class="s1">? </span><span class="s3">type</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">: </span><span class="s4">'?'</span><span class="s1">;</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">type</span><span class="s1">.</span><span class="s3">represent</span><span class="s1">) {</span>
        <span class="s3">style </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">styleMap</span><span class="s1">[</span><span class="s3">type</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">] || </span><span class="s3">type</span><span class="s1">.</span><span class="s3">defaultStyle</span><span class="s1">;</span>

        <span class="s2">if </span><span class="s1">(</span><span class="s3">_toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">type</span><span class="s1">.</span><span class="s3">represent</span><span class="s1">) === </span><span class="s4">'[object Function]'</span><span class="s1">) {</span>
          <span class="s3">_result </span><span class="s1">= </span><span class="s3">type</span><span class="s1">.</span><span class="s3">represent</span><span class="s1">(</span><span class="s3">object</span><span class="s1">, </span><span class="s3">style</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">type</span><span class="s1">.</span><span class="s3">represent</span><span class="s1">, </span><span class="s3">style</span><span class="s1">)) {</span>
          <span class="s3">_result </span><span class="s1">= </span><span class="s3">type</span><span class="s1">.</span><span class="s3">represent</span><span class="s1">[</span><span class="s3">style</span><span class="s1">](</span><span class="s3">object</span><span class="s1">, </span><span class="s3">style</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
          <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'!&lt;' </span><span class="s1">+ </span><span class="s3">type</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">+ </span><span class="s4">'&gt; tag resolver accepts not &quot;' </span><span class="s1">+ </span><span class="s3">style </span><span class="s1">+ </span><span class="s4">'&quot; style'</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s3">_result</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">return true</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">return false</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">// Serializes `object` and writes it to global `result`.</span>
<span class="s0">// Returns true on success, or false on invalid object.</span>
<span class="s0">//</span>
<span class="s2">function </span><span class="s3">writeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">object</span><span class="s1">, </span><span class="s3">block</span><span class="s1">, </span><span class="s3">compact</span><span class="s1">, </span><span class="s3">iskey</span><span class="s1">) {</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s3">object</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">detectType</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">object</span><span class="s1">, </span><span class="s2">false</span><span class="s1">)) {</span>
    <span class="s3">detectType</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">object</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">var </span><span class="s3">type </span><span class="s1">= </span><span class="s3">_toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">block</span><span class="s1">) {</span>
    <span class="s3">block </span><span class="s1">= (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">flowLevel </span><span class="s1">&lt; </span><span class="s5">0 </span><span class="s1">|| </span><span class="s3">state</span><span class="s1">.</span><span class="s3">flowLevel </span><span class="s1">&gt; </span><span class="s3">level</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">var </span><span class="s3">objectOrArray </span><span class="s1">= </span><span class="s3">type </span><span class="s1">=== </span><span class="s4">'[object Object]' </span><span class="s1">|| </span><span class="s3">type </span><span class="s1">=== </span><span class="s4">'[object Array]'</span><span class="s1">,</span>
      <span class="s3">duplicateIndex</span><span class="s1">,</span>
      <span class="s3">duplicate</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">objectOrArray</span><span class="s1">) {</span>
    <span class="s3">duplicateIndex </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">duplicates</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">object</span><span class="s1">);</span>
    <span class="s3">duplicate </span><span class="s1">= </span><span class="s3">duplicateIndex </span><span class="s1">!== -</span><span class="s5">1</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">((</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">&amp;&amp; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s4">'?'</span><span class="s1">) || </span><span class="s3">duplicate </span><span class="s1">|| (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">indent </span><span class="s1">!== </span><span class="s5">2 </span><span class="s1">&amp;&amp; </span><span class="s3">level </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">)) {</span>
    <span class="s3">compact </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">duplicate </span><span class="s1">&amp;&amp; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">usedDuplicates</span><span class="s1">[</span><span class="s3">duplicateIndex</span><span class="s1">]) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s4">'*ref_' </span><span class="s1">+ </span><span class="s3">duplicateIndex</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">objectOrArray </span><span class="s1">&amp;&amp; </span><span class="s3">duplicate </span><span class="s1">&amp;&amp; !</span><span class="s3">state</span><span class="s1">.</span><span class="s3">usedDuplicates</span><span class="s1">[</span><span class="s3">duplicateIndex</span><span class="s1">]) {</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">usedDuplicates</span><span class="s1">[</span><span class="s3">duplicateIndex</span><span class="s1">] = </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">type </span><span class="s1">=== </span><span class="s4">'[object Object]'</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">block </span><span class="s1">&amp;&amp; (</span><span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">).</span><span class="s3">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">)) {</span>
        <span class="s3">writeBlockMapping</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">, </span><span class="s3">compact</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">duplicate</span><span class="s1">) {</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s4">'&amp;ref_' </span><span class="s1">+ </span><span class="s3">duplicateIndex </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">writeFlowMapping</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">duplicate</span><span class="s1">) {</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s4">'&amp;ref_' </span><span class="s1">+ </span><span class="s3">duplicateIndex </span><span class="s1">+ </span><span class="s4">' ' </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">type </span><span class="s1">=== </span><span class="s4">'[object Array]'</span><span class="s1">) {</span>
      <span class="s2">var </span><span class="s3">arrayLevel </span><span class="s1">= (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">noArrayIndent </span><span class="s1">&amp;&amp; (</span><span class="s3">level </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">)) ? </span><span class="s3">level </span><span class="s1">- </span><span class="s5">1 </span><span class="s1">: </span><span class="s3">level</span><span class="s1">;</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">block </span><span class="s1">&amp;&amp; (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">.</span><span class="s3">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">)) {</span>
        <span class="s3">writeBlockSequence</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">arrayLevel</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">, </span><span class="s3">compact</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">duplicate</span><span class="s1">) {</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s4">'&amp;ref_' </span><span class="s1">+ </span><span class="s3">duplicateIndex </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">writeFlowSequence</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">arrayLevel</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">duplicate</span><span class="s1">) {</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s4">'&amp;ref_' </span><span class="s1">+ </span><span class="s3">duplicateIndex </span><span class="s1">+ </span><span class="s4">' ' </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">type </span><span class="s1">=== </span><span class="s4">'[object String]'</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s4">'?'</span><span class="s1">) {</span>
        <span class="s3">writeScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">, </span><span class="s3">level</span><span class="s1">, </span><span class="s3">iskey</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">skipInvalid</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>
      <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'unacceptable kind of an object to dump ' </span><span class="s1">+ </span><span class="s3">type</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">&amp;&amp; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s4">'?'</span><span class="s1">) {</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">= </span><span class="s4">'!&lt;' </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">+ </span><span class="s4">'&gt; ' </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">getDuplicateReferences</span><span class="s1">(</span><span class="s3">object</span><span class="s1">, </span><span class="s3">state</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">objects </span><span class="s1">= [],</span>
      <span class="s3">duplicatesIndexes </span><span class="s1">= [],</span>
      <span class="s3">index</span><span class="s1">,</span>
      <span class="s3">length</span><span class="s1">;</span>

  <span class="s3">inspectNode</span><span class="s1">(</span><span class="s3">object</span><span class="s1">, </span><span class="s3">objects</span><span class="s1">, </span><span class="s3">duplicatesIndexes</span><span class="s1">);</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">duplicatesIndexes</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">duplicates</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">objects</span><span class="s1">[</span><span class="s3">duplicatesIndexes</span><span class="s1">[</span><span class="s3">index</span><span class="s1">]]);</span>
  <span class="s1">}</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">usedDuplicates </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Array</span><span class="s1">(</span><span class="s3">length</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">inspectNode</span><span class="s1">(</span><span class="s3">object</span><span class="s1">, </span><span class="s3">objects</span><span class="s1">, </span><span class="s3">duplicatesIndexes</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">objectKeyList</span><span class="s1">,</span>
      <span class="s3">index</span><span class="s1">,</span>
      <span class="s3">length</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">object </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">&amp;&amp; </span><span class="s2">typeof </span><span class="s3">object </span><span class="s1">=== </span><span class="s4">'object'</span><span class="s1">) {</span>
    <span class="s3">index </span><span class="s1">= </span><span class="s3">objects</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">object</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">index </span><span class="s1">!== -</span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">duplicatesIndexes</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">index</span><span class="s1">) === -</span><span class="s5">1</span><span class="s1">) {</span>
        <span class="s3">duplicatesIndexes</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">index</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">objects</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">object</span><span class="s1">);</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">Array</span><span class="s1">.</span><span class="s3">isArray</span><span class="s1">(</span><span class="s3">object</span><span class="s1">)) {</span>
        <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">object</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
          <span class="s3">inspectNode</span><span class="s1">(</span><span class="s3">object</span><span class="s1">[</span><span class="s3">index</span><span class="s1">], </span><span class="s3">objects</span><span class="s1">, </span><span class="s3">duplicatesIndexes</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">objectKeyList </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">object</span><span class="s1">);</span>

        <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">objectKeyList</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
          <span class="s3">inspectNode</span><span class="s1">(</span><span class="s3">object</span><span class="s1">[</span><span class="s3">objectKeyList</span><span class="s1">[</span><span class="s3">index</span><span class="s1">]], </span><span class="s3">objects</span><span class="s1">, </span><span class="s3">duplicatesIndexes</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">dump</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s3">options </span><span class="s1">= </span><span class="s3">options </span><span class="s1">|| {};</span>

  <span class="s2">var </span><span class="s3">state </span><span class="s1">= </span><span class="s2">new </span><span class="s3">State</span><span class="s1">(</span><span class="s3">options</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">state</span><span class="s1">.</span><span class="s3">noRefs</span><span class="s1">) </span><span class="s3">getDuplicateReferences</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">state</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">writeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s5">0</span><span class="s1">, </span><span class="s3">input</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s2">true</span><span class="s1">)) </span><span class="s2">return </span><span class="s3">state</span><span class="s1">.</span><span class="s3">dump </span><span class="s1">+ </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">;</span>

  <span class="s2">return </span><span class="s4">''</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">safeDump</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">dump</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">common</span><span class="s1">.</span><span class="s3">extend</span><span class="s1">({ </span><span class="s3">schema</span><span class="s1">: </span><span class="s3">DEFAULT_SAFE_SCHEMA </span><span class="s1">}, </span><span class="s3">options</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">dump     </span><span class="s1">= </span><span class="s3">dump</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">safeDump </span><span class="s1">= </span><span class="s3">safeDump</span><span class="s1">;</span>

<span class="s1">},{</span><span class="s4">&quot;./common&quot;</span><span class="s1">:</span><span class="s5">2</span><span class="s1">,</span><span class="s4">&quot;./exception&quot;</span><span class="s1">:</span><span class="s5">4</span><span class="s1">,</span><span class="s4">&quot;./schema/default_full&quot;</span><span class="s1">:</span><span class="s5">9</span><span class="s1">,</span><span class="s4">&quot;./schema/default_safe&quot;</span><span class="s1">:</span><span class="s5">10</span><span class="s1">}],</span><span class="s5">4</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s0">// YAML error class. http://stackoverflow.com/questions/8458984</span>
<span class="s0">//</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">function </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s3">reason</span><span class="s1">, </span><span class="s3">mark</span><span class="s1">) {</span>
  <span class="s0">// Super constructor</span>
  <span class="s3">Error</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s2">this</span><span class="s1">);</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">name </span><span class="s1">= </span><span class="s4">'YAMLException'</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">reason </span><span class="s1">= </span><span class="s3">reason</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">mark </span><span class="s1">= </span><span class="s3">mark</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">message </span><span class="s1">= (</span><span class="s2">this</span><span class="s1">.</span><span class="s3">reason </span><span class="s1">|| </span><span class="s4">'(unknown reason)'</span><span class="s1">) + (</span><span class="s2">this</span><span class="s1">.</span><span class="s3">mark </span><span class="s1">? </span><span class="s4">' ' </span><span class="s1">+ </span><span class="s2">this</span><span class="s1">.</span><span class="s3">mark</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">() : </span><span class="s4">''</span><span class="s1">);</span>

  <span class="s0">// Include stack trace in error object</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">Error</span><span class="s1">.</span><span class="s3">captureStackTrace</span><span class="s1">) {</span>
    <span class="s0">// Chrome and NodeJS</span>
    <span class="s3">Error</span><span class="s1">.</span><span class="s3">captureStackTrace</span><span class="s1">(</span><span class="s2">this</span><span class="s1">, </span><span class="s2">this</span><span class="s1">.</span><span class="s3">constructor</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s0">// FF, IE 10+ and Safari 6+. Fallback for others</span>
    <span class="s2">this</span><span class="s1">.</span><span class="s3">stack </span><span class="s1">= (</span><span class="s2">new </span><span class="s3">Error</span><span class="s1">()).</span><span class="s3">stack </span><span class="s1">|| </span><span class="s4">''</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>


<span class="s0">// Inherit from Error</span>
<span class="s3">YAMLException</span><span class="s1">.</span><span class="s3">prototype </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">create</span><span class="s1">(</span><span class="s3">Error</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">);</span>
<span class="s3">YAMLException</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">constructor </span><span class="s1">= </span><span class="s3">YAMLException</span><span class="s1">;</span>


<span class="s3">YAMLException</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString </span><span class="s1">= </span><span class="s2">function </span><span class="s3">toString</span><span class="s1">(</span><span class="s3">compact</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">result </span><span class="s1">= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">name </span><span class="s1">+ </span><span class="s4">': '</span><span class="s1">;</span>

  <span class="s3">result </span><span class="s1">+= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">reason </span><span class="s1">|| </span><span class="s4">'(unknown reason)'</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">compact </span><span class="s1">&amp;&amp; </span><span class="s2">this</span><span class="s1">.</span><span class="s3">mark</span><span class="s1">) {</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s4">' ' </span><span class="s1">+ </span><span class="s2">this</span><span class="s1">.</span><span class="s3">mark</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">();</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">};</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s3">YAMLException</span><span class="s1">;</span>

<span class="s1">},{}],</span><span class="s5">5</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s0">/*eslint-disable max-len,no-use-before-define*/</span>

<span class="s2">var </span><span class="s3">common              </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./common'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">YAMLException       </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./exception'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">Mark                </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./mark'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">DEFAULT_SAFE_SCHEMA </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./schema/default_safe'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">DEFAULT_FULL_SCHEMA </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./schema/default_full'</span><span class="s1">);</span>


<span class="s2">var </span><span class="s3">_hasOwnProperty </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">hasOwnProperty</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">CONTEXT_FLOW_IN   </span><span class="s1">= </span><span class="s5">1</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">CONTEXT_FLOW_OUT  </span><span class="s1">= </span><span class="s5">2</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">CONTEXT_BLOCK_IN  </span><span class="s1">= </span><span class="s5">3</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">CONTEXT_BLOCK_OUT </span><span class="s1">= </span><span class="s5">4</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">CHOMPING_CLIP  </span><span class="s1">= </span><span class="s5">1</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">CHOMPING_STRIP </span><span class="s1">= </span><span class="s5">2</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">CHOMPING_KEEP  </span><span class="s1">= </span><span class="s5">3</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">PATTERN_NON_PRINTABLE         </span><span class="s1">= </span><span class="s6">/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">PATTERN_NON_ASCII_LINE_BREAKS </span><span class="s1">= </span><span class="s6">/[\x85\u2028\u2029]/</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">PATTERN_FLOW_INDICATORS       </span><span class="s1">= </span><span class="s6">/[,\[\]\{\}]/</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">PATTERN_TAG_HANDLE            </span><span class="s1">= </span><span class="s6">/^(?:!|!!|![a-z\-]+!)$/i</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">PATTERN_TAG_URI               </span><span class="s1">= </span><span class="s6">/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&amp;=\+\$,_\.!~\*'\(\)\[\]])*$/i</span><span class="s1">;</span>


<span class="s2">function </span><span class="s3">_class</span><span class="s1">(</span><span class="s3">obj</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">obj</span><span class="s1">); }</span>

<span class="s2">function </span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x0A</span><span class="s0">/* LF */</span><span class="s1">) || (</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x0D</span><span class="s0">/* CR */</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">is_WHITE_SPACE</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x09</span><span class="s0">/* Tab */</span><span class="s1">) || (</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x20</span><span class="s0">/* Space */</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x09</span><span class="s0">/* Tab */</span><span class="s1">) ||</span>
         <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x20</span><span class="s0">/* Space */</span><span class="s1">) ||</span>
         <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x0A</span><span class="s0">/* LF */</span><span class="s1">) ||</span>
         <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x0D</span><span class="s0">/* CR */</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">is_FLOW_INDICATOR</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x2C</span><span class="s0">/* , */ </span><span class="s1">||</span>
         <span class="s3">c </span><span class="s1">=== </span><span class="s5">0x5B</span><span class="s0">/* [ */ </span><span class="s1">||</span>
         <span class="s3">c </span><span class="s1">=== </span><span class="s5">0x5D</span><span class="s0">/* ] */ </span><span class="s1">||</span>
         <span class="s3">c </span><span class="s1">=== </span><span class="s5">0x7B</span><span class="s0">/* { */ </span><span class="s1">||</span>
         <span class="s3">c </span><span class="s1">=== </span><span class="s5">0x7D</span><span class="s0">/* } */</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">fromHexCode</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">lc</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">((</span><span class="s5">0x30</span><span class="s0">/* 0 */ </span><span class="s1">&lt;= </span><span class="s3">c</span><span class="s1">) &amp;&amp; (</span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x39</span><span class="s0">/* 9 */</span><span class="s1">)) {</span>
    <span class="s2">return </span><span class="s3">c </span><span class="s1">- </span><span class="s5">0x30</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">/*eslint-disable no-bitwise*/</span>
  <span class="s3">lc </span><span class="s1">= </span><span class="s3">c </span><span class="s1">| </span><span class="s5">0x20</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">((</span><span class="s5">0x61</span><span class="s0">/* a */ </span><span class="s1">&lt;= </span><span class="s3">lc</span><span class="s1">) &amp;&amp; (</span><span class="s3">lc </span><span class="s1">&lt;= </span><span class="s5">0x66</span><span class="s0">/* f */</span><span class="s1">)) {</span>
    <span class="s2">return </span><span class="s3">lc </span><span class="s1">- </span><span class="s5">0x61 </span><span class="s1">+ </span><span class="s5">10</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s1">-</span><span class="s5">1</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">escapedHexLen</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x78</span><span class="s0">/* x */</span><span class="s1">) { </span><span class="s2">return </span><span class="s5">2</span><span class="s1">; }</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x75</span><span class="s0">/* u */</span><span class="s1">) { </span><span class="s2">return </span><span class="s5">4</span><span class="s1">; }</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x55</span><span class="s0">/* U */</span><span class="s1">) { </span><span class="s2">return </span><span class="s5">8</span><span class="s1">; }</span>
  <span class="s2">return </span><span class="s5">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">fromDecimalCode</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">((</span><span class="s5">0x30</span><span class="s0">/* 0 */ </span><span class="s1">&lt;= </span><span class="s3">c</span><span class="s1">) &amp;&amp; (</span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x39</span><span class="s0">/* 9 */</span><span class="s1">)) {</span>
    <span class="s2">return </span><span class="s3">c </span><span class="s1">- </span><span class="s5">0x30</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s1">-</span><span class="s5">1</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">simpleEscapeSequence</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s0">/* eslint-disable indent */</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x30</span><span class="s0">/* 0 */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x00</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x61</span><span class="s0">/* a */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x07</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x62</span><span class="s0">/* b */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x08</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x74</span><span class="s0">/* t */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x09</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x09</span><span class="s0">/* Tab */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x09</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x6E</span><span class="s0">/* n */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x0A</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x76</span><span class="s0">/* v */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x0B</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x66</span><span class="s0">/* f */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x0C</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x72</span><span class="s0">/* r */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x0D</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x65</span><span class="s0">/* e */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x1B</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x20</span><span class="s0">/* Space */</span><span class="s1">) ? </span><span class="s4">' ' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x22</span><span class="s0">/* &quot; */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x22</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x2F</span><span class="s0">/* / */</span><span class="s1">) ? </span><span class="s4">'/' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x5C</span><span class="s0">/* \ */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x5C</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x4E</span><span class="s0">/* N */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\x85</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x5F</span><span class="s0">/* _ */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\xA0</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x4C</span><span class="s0">/* L */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\u2028</span><span class="s4">' </span><span class="s1">:</span>
        <span class="s1">(</span><span class="s3">c </span><span class="s1">=== </span><span class="s5">0x50</span><span class="s0">/* P */</span><span class="s1">) ? </span><span class="s4">'</span><span class="s2">\u2029</span><span class="s4">' </span><span class="s1">: </span><span class="s4">''</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">charFromCodepoint</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0xFFFF</span><span class="s1">) {</span>
    <span class="s2">return </span><span class="s3">String</span><span class="s1">.</span><span class="s3">fromCharCode</span><span class="s1">(</span><span class="s3">c</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s0">// Encode UTF-16 surrogate pair</span>
  <span class="s0">// https://en.wikipedia.org/wiki/UTF-16#Code_points_U.2B010000_to_U.2B10FFFF</span>
  <span class="s2">return </span><span class="s3">String</span><span class="s1">.</span><span class="s3">fromCharCode</span><span class="s1">(</span>
    <span class="s1">((</span><span class="s3">c </span><span class="s1">- </span><span class="s5">0x010000</span><span class="s1">) &gt;&gt; </span><span class="s5">10</span><span class="s1">) + </span><span class="s5">0xD800</span><span class="s1">,</span>
    <span class="s1">((</span><span class="s3">c </span><span class="s1">- </span><span class="s5">0x010000</span><span class="s1">) &amp; </span><span class="s5">0x03FF</span><span class="s1">) + </span><span class="s5">0xDC00</span>
  <span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">var </span><span class="s3">simpleEscapeCheck </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Array</span><span class="s1">(</span><span class="s5">256</span><span class="s1">); </span><span class="s0">// integer, for fast access</span>
<span class="s2">var </span><span class="s3">simpleEscapeMap </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Array</span><span class="s1">(</span><span class="s5">256</span><span class="s1">);</span>
<span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s3">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s3">i </span><span class="s1">&lt; </span><span class="s5">256</span><span class="s1">; </span><span class="s3">i</span><span class="s1">++) {</span>
  <span class="s3">simpleEscapeCheck</span><span class="s1">[</span><span class="s3">i</span><span class="s1">] = </span><span class="s3">simpleEscapeSequence</span><span class="s1">(</span><span class="s3">i</span><span class="s1">) ? </span><span class="s5">1 </span><span class="s1">: </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s3">simpleEscapeMap</span><span class="s1">[</span><span class="s3">i</span><span class="s1">] = </span><span class="s3">simpleEscapeSequence</span><span class="s1">(</span><span class="s3">i</span><span class="s1">);</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">State</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">input </span><span class="s1">= </span><span class="s3">input</span><span class="s1">;</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">filename  </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'filename'</span><span class="s1">]  || </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">schema    </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'schema'</span><span class="s1">]    || </span><span class="s3">DEFAULT_FULL_SCHEMA</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">onWarning </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'onWarning'</span><span class="s1">] || </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">legacy    </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'legacy'</span><span class="s1">]    || </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">json      </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'json'</span><span class="s1">]      || </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">listener  </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'listener'</span><span class="s1">]  || </span><span class="s2">null</span><span class="s1">;</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">implicitTypes </span><span class="s1">= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">schema</span><span class="s1">.</span><span class="s3">compiledImplicit</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">typeMap       </span><span class="s1">= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">schema</span><span class="s1">.</span><span class="s3">compiledTypeMap</span><span class="s1">;</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">length     </span><span class="s1">= </span><span class="s3">input</span><span class="s1">.</span><span class="s3">length</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">position   </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">line       </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">lineStart  </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">documents </span><span class="s1">= [];</span>

  <span class="s0">/* 
  this.version; 
  this.checkLineBreaks; 
  this.tagMap; 
  this.anchorMap; 
  this.tag; 
  this.anchor; 
  this.kind; 
  this.result;*/</span>

<span class="s1">}</span>


<span class="s2">function </span><span class="s3">generateError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">message</span><span class="s1">) {</span>
  <span class="s2">return new </span><span class="s3">YAMLException</span><span class="s1">(</span>
    <span class="s3">message</span><span class="s1">,</span>
    <span class="s2">new </span><span class="s3">Mark</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">filename</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">line</span><span class="s1">, (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">- </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineStart</span><span class="s1">)));</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">message</span><span class="s1">) {</span>
  <span class="s2">throw </span><span class="s3">generateError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">message</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">throwWarning</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">message</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">onWarning</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">onWarning</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s2">null</span><span class="s1">, </span><span class="s3">generateError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">message</span><span class="s1">));</span>
  <span class="s1">}</span>
<span class="s1">}</span>


<span class="s2">var </span><span class="s3">directiveHandlers </span><span class="s1">= {</span>

  <span class="s3">YAML</span><span class="s1">: </span><span class="s2">function </span><span class="s3">handleYamlDirective</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">name</span><span class="s1">, </span><span class="s3">args</span><span class="s1">) {</span>

    <span class="s2">var </span><span class="s3">match</span><span class="s1">, </span><span class="s3">major</span><span class="s1">, </span><span class="s3">minor</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">version </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'duplication of %YAML directive'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">args</span><span class="s1">.</span><span class="s3">length </span><span class="s1">!== </span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'YAML directive accepts exactly one argument'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">match </span><span class="s1">= </span><span class="s6">/^([0-9]+)\.([0-9]+)$/</span><span class="s1">.</span><span class="s3">exec</span><span class="s1">(</span><span class="s3">args</span><span class="s1">[</span><span class="s5">0</span><span class="s1">]);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">match </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'ill-formed argument of the YAML directive'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">major </span><span class="s1">= </span><span class="s3">parseInt</span><span class="s1">(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">1</span><span class="s1">], </span><span class="s5">10</span><span class="s1">);</span>
    <span class="s3">minor </span><span class="s1">= </span><span class="s3">parseInt</span><span class="s1">(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">2</span><span class="s1">], </span><span class="s5">10</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">major </span><span class="s1">!== </span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unacceptable YAML version of the document'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">state</span><span class="s1">.</span><span class="s3">version </span><span class="s1">= </span><span class="s3">args</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">checkLineBreaks </span><span class="s1">= (</span><span class="s3">minor </span><span class="s1">&lt; </span><span class="s5">2</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">minor </span><span class="s1">!== </span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s3">minor </span><span class="s1">!== </span><span class="s5">2</span><span class="s1">) {</span>
      <span class="s3">throwWarning</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unsupported YAML version of the document'</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">},</span>

  <span class="s3">TAG</span><span class="s1">: </span><span class="s2">function </span><span class="s3">handleTagDirective</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">name</span><span class="s1">, </span><span class="s3">args</span><span class="s1">) {</span>

    <span class="s2">var </span><span class="s3">handle</span><span class="s1">, </span><span class="s3">prefix</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">args</span><span class="s1">.</span><span class="s3">length </span><span class="s1">!== </span><span class="s5">2</span><span class="s1">) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'TAG directive accepts exactly two arguments'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">handle </span><span class="s1">= </span><span class="s3">args</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
    <span class="s3">prefix </span><span class="s1">= </span><span class="s3">args</span><span class="s1">[</span><span class="s5">1</span><span class="s1">];</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">PATTERN_TAG_HANDLE</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">handle</span><span class="s1">)) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'ill-formed tag handle (first argument) of the TAG directive'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tagMap</span><span class="s1">, </span><span class="s3">handle</span><span class="s1">)) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'there is a previously declared suffix for &quot;' </span><span class="s1">+ </span><span class="s3">handle </span><span class="s1">+ </span><span class="s4">'&quot; tag handle'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">PATTERN_TAG_URI</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">prefix</span><span class="s1">)) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'ill-formed tag prefix (second argument) of the TAG directive'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">state</span><span class="s1">.</span><span class="s3">tagMap</span><span class="s1">[</span><span class="s3">handle</span><span class="s1">] = </span><span class="s3">prefix</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>


<span class="s2">function </span><span class="s3">captureSegment</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">start</span><span class="s1">, </span><span class="s3">end</span><span class="s1">, </span><span class="s3">checkJson</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_position</span><span class="s1">, </span><span class="s3">_length</span><span class="s1">, </span><span class="s3">_character</span><span class="s1">, </span><span class="s3">_result</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">start </span><span class="s1">&lt; </span><span class="s3">end</span><span class="s1">) {</span>
    <span class="s3">_result </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">start</span><span class="s1">, </span><span class="s3">end</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">checkJson</span><span class="s1">) {</span>
      <span class="s2">for </span><span class="s1">(</span><span class="s3">_position </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">_length </span><span class="s1">= </span><span class="s3">_result</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">_position </span><span class="s1">&lt; </span><span class="s3">_length</span><span class="s1">; </span><span class="s3">_position </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
        <span class="s3">_character </span><span class="s1">= </span><span class="s3">_result</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">_position</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(!(</span><span class="s3">_character </span><span class="s1">=== </span><span class="s5">0x09 </span><span class="s1">||</span>
              <span class="s1">(</span><span class="s5">0x20 </span><span class="s1">&lt;= </span><span class="s3">_character </span><span class="s1">&amp;&amp; </span><span class="s3">_character </span><span class="s1">&lt;= </span><span class="s5">0x10FFFF</span><span class="s1">))) {</span>
          <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'expected valid JSON character'</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">PATTERN_NON_PRINTABLE</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">_result</span><span class="s1">)) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'the stream contains non-printable characters'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s3">_result</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">mergeMappings</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">destination</span><span class="s1">, </span><span class="s3">source</span><span class="s1">, </span><span class="s3">overridableKeys</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">sourceKeys</span><span class="s1">, </span><span class="s3">key</span><span class="s1">, </span><span class="s3">index</span><span class="s1">, </span><span class="s3">quantity</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">common</span><span class="s1">.</span><span class="s3">isObject</span><span class="s1">(</span><span class="s3">source</span><span class="s1">)) {</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'cannot merge mappings; the provided source object is unacceptable'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">sourceKeys </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">source</span><span class="s1">);</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">quantity </span><span class="s1">= </span><span class="s3">sourceKeys</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">quantity</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">key </span><span class="s1">= </span><span class="s3">sourceKeys</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">destination</span><span class="s1">, </span><span class="s3">key</span><span class="s1">)) {</span>
      <span class="s3">destination</span><span class="s1">[</span><span class="s3">key</span><span class="s1">] = </span><span class="s3">source</span><span class="s1">[</span><span class="s3">key</span><span class="s1">];</span>
      <span class="s3">overridableKeys</span><span class="s1">[</span><span class="s3">key</span><span class="s1">] = </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">storeMappingPair</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">_result</span><span class="s1">, </span><span class="s3">overridableKeys</span><span class="s1">, </span><span class="s3">keyTag</span><span class="s1">, </span><span class="s3">keyNode</span><span class="s1">, </span><span class="s3">valueNode</span><span class="s1">, </span><span class="s3">startLine</span><span class="s1">, </span><span class="s3">startPos</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">index</span><span class="s1">, </span><span class="s3">quantity</span><span class="s1">;</span>

  <span class="s0">// The output is a plain object here, so keys can only be strings.</span>
  <span class="s0">// We need to convert keyNode to a string, but doing so can hang the process</span>
  <span class="s0">// (deeply nested arrays that explode exponentially using aliases).</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">Array</span><span class="s1">.</span><span class="s3">isArray</span><span class="s1">(</span><span class="s3">keyNode</span><span class="s1">)) {</span>
    <span class="s3">keyNode </span><span class="s1">= </span><span class="s3">Array</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">keyNode</span><span class="s1">);</span>

    <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">quantity </span><span class="s1">= </span><span class="s3">keyNode</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">quantity</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">Array</span><span class="s1">.</span><span class="s3">isArray</span><span class="s1">(</span><span class="s3">keyNode</span><span class="s1">[</span><span class="s3">index</span><span class="s1">])) {</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'nested arrays are not supported inside keys'</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">keyNode </span><span class="s1">=== </span><span class="s4">'object' </span><span class="s1">&amp;&amp; </span><span class="s3">_class</span><span class="s1">(</span><span class="s3">keyNode</span><span class="s1">[</span><span class="s3">index</span><span class="s1">]) === </span><span class="s4">'[object Object]'</span><span class="s1">) {</span>
        <span class="s3">keyNode</span><span class="s1">[</span><span class="s3">index</span><span class="s1">] = </span><span class="s4">'[object Object]'</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">// Avoid code execution in load() via toString property</span>
  <span class="s0">// (still use its own toString for arrays, timestamps,</span>
  <span class="s0">// and whatever user schema extensions happen to have @@toStringTag)</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">keyNode </span><span class="s1">=== </span><span class="s4">'object' </span><span class="s1">&amp;&amp; </span><span class="s3">_class</span><span class="s1">(</span><span class="s3">keyNode</span><span class="s1">) === </span><span class="s4">'[object Object]'</span><span class="s1">) {</span>
    <span class="s3">keyNode </span><span class="s1">= </span><span class="s4">'[object Object]'</span><span class="s1">;</span>
  <span class="s1">}</span>


  <span class="s3">keyNode </span><span class="s1">= </span><span class="s3">String</span><span class="s1">(</span><span class="s3">keyNode</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">_result </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s3">_result </span><span class="s1">= {};</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">keyTag </span><span class="s1">=== </span><span class="s4">'tag:yaml.org,2002:merge'</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">Array</span><span class="s1">.</span><span class="s3">isArray</span><span class="s1">(</span><span class="s3">valueNode</span><span class="s1">)) {</span>
      <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">quantity </span><span class="s1">= </span><span class="s3">valueNode</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">quantity</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
        <span class="s3">mergeMappings</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">_result</span><span class="s1">, </span><span class="s3">valueNode</span><span class="s1">[</span><span class="s3">index</span><span class="s1">], </span><span class="s3">overridableKeys</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">mergeMappings</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">_result</span><span class="s1">, </span><span class="s3">valueNode</span><span class="s1">, </span><span class="s3">overridableKeys</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s2">if </span><span class="s1">(!</span><span class="s3">state</span><span class="s1">.</span><span class="s3">json </span><span class="s1">&amp;&amp;</span>
        <span class="s1">!</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">overridableKeys</span><span class="s1">, </span><span class="s3">keyNode</span><span class="s1">) &amp;&amp;</span>
        <span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">_result</span><span class="s1">, </span><span class="s3">keyNode</span><span class="s1">)) {</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">line </span><span class="s1">= </span><span class="s3">startLine </span><span class="s1">|| </span><span class="s3">state</span><span class="s1">.</span><span class="s3">line</span><span class="s1">;</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">= </span><span class="s3">startPos </span><span class="s1">|| </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'duplicated mapping key'</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">_result</span><span class="s1">[</span><span class="s3">keyNode</span><span class="s1">] = </span><span class="s3">valueNode</span><span class="s1">;</span>
    <span class="s2">delete </span><span class="s3">overridableKeys</span><span class="s1">[</span><span class="s3">keyNode</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">_result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readLineBreak</span><span class="s1">(</span><span class="s3">state</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x0A</span><span class="s0">/* LF */</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x0D</span><span class="s0">/* CR */</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">) === </span><span class="s5">0x0A</span><span class="s0">/* LF */</span><span class="s1">) {</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'a line break is expected'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">line </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">lineStart </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">allowComments</span><span class="s1">, </span><span class="s3">checkIndent</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">lineBreaks </span><span class="s1">= </span><span class="s5">0</span><span class="s1">,</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s2">while </span><span class="s1">(</span><span class="s3">is_WHITE_SPACE</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">allowComments </span><span class="s1">&amp;&amp; </span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x23</span><span class="s0">/* # */</span><span class="s1">) {</span>
      <span class="s2">do </span><span class="s1">{</span>
        <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x0A</span><span class="s0">/* LF */ </span><span class="s1">&amp;&amp; </span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x0D</span><span class="s0">/* CR */ </span><span class="s1">&amp;&amp; </span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s3">readLineBreak</span><span class="s1">(</span><span class="s3">state</span><span class="s1">);</span>

      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
      <span class="s3">lineBreaks</span><span class="s1">++;</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

      <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x20</span><span class="s0">/* Space */</span><span class="s1">) {</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent</span><span class="s1">++;</span>
        <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">checkIndent </span><span class="s1">!== -</span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s3">lineBreaks </span><span class="s1">!== </span><span class="s5">0 </span><span class="s1">&amp;&amp; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&lt; </span><span class="s3">checkIndent</span><span class="s1">) {</span>
    <span class="s3">throwWarning</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'deficient indentation'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">lineBreaks</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">testDocumentSeparator</span><span class="s1">(</span><span class="s3">state</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_position </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">_position</span><span class="s1">);</span>

  <span class="s0">// Condition state.position === state.lineStart is tested</span>
  <span class="s0">// in parent on each call, for efficiency. No needs to test here again.</span>
  <span class="s2">if </span><span class="s1">((</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x2D</span><span class="s0">/* - */ </span><span class="s1">|| </span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x2E</span><span class="s0">/* . */</span><span class="s1">) &amp;&amp;</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">_position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">) &amp;&amp;</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">_position </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)) {</span>

    <span class="s3">_position </span><span class="s1">+= </span><span class="s5">3</span><span class="s1">;</span>

    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">_position</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0 </span><span class="s1">|| </span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s2">return true</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">return false</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">writeFoldedLines</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">count</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">count </span><span class="s1">=== </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s4">' '</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">count </span><span class="s1">&gt; </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">, </span><span class="s3">count </span><span class="s1">- </span><span class="s5">1</span><span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">readPlainScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">, </span><span class="s3">withinFlowCollection</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">preceding</span><span class="s1">,</span>
      <span class="s3">following</span><span class="s1">,</span>
      <span class="s3">captureStart</span><span class="s1">,</span>
      <span class="s3">captureEnd</span><span class="s1">,</span>
      <span class="s3">hasPendingContent</span><span class="s1">,</span>
      <span class="s3">_line</span><span class="s1">,</span>
      <span class="s3">_lineStart</span><span class="s1">,</span>
      <span class="s3">_lineIndent</span><span class="s1">,</span>
      <span class="s3">_kind </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">kind</span><span class="s1">,</span>
      <span class="s3">_result </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)      ||</span>
      <span class="s3">is_FLOW_INDICATOR</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">) ||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x23</span><span class="s0">/* # */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x26</span><span class="s0">/* &amp; */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x2A</span><span class="s0">/* * */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x21</span><span class="s0">/* ! */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x7C</span><span class="s0">/* | */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3E</span><span class="s0">/* &gt; */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x27</span><span class="s0">/* ' */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x22</span><span class="s0">/* &quot; */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x25</span><span class="s0">/* % */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x40</span><span class="s0">/* @ */    </span><span class="s1">||</span>
      <span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x60</span><span class="s0">/* ` */</span><span class="s1">) {</span>
    <span class="s2">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3F</span><span class="s0">/* ? */ </span><span class="s1">|| </span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x2D</span><span class="s0">/* - */</span><span class="s1">) {</span>
    <span class="s3">following </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">following</span><span class="s1">) ||</span>
        <span class="s3">withinFlowCollection </span><span class="s1">&amp;&amp; </span><span class="s3">is_FLOW_INDICATOR</span><span class="s1">(</span><span class="s3">following</span><span class="s1">)) {</span>
      <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">= </span><span class="s4">'scalar'</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>
  <span class="s3">captureStart </span><span class="s1">= </span><span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>
  <span class="s3">hasPendingContent </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3A</span><span class="s0">/* : */</span><span class="s1">) {</span>
      <span class="s3">following </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">following</span><span class="s1">) ||</span>
          <span class="s3">withinFlowCollection </span><span class="s1">&amp;&amp; </span><span class="s3">is_FLOW_INDICATOR</span><span class="s1">(</span><span class="s3">following</span><span class="s1">)) {</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s1">}</span>

    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x23</span><span class="s0">/* # */</span><span class="s1">) {</span>
      <span class="s3">preceding </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">- </span><span class="s5">1</span><span class="s1">);</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">preceding</span><span class="s1">)) {</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s1">}</span>

    <span class="s1">} </span><span class="s2">else if </span><span class="s1">((</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">=== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineStart </span><span class="s1">&amp;&amp; </span><span class="s3">testDocumentSeparator</span><span class="s1">(</span><span class="s3">state</span><span class="s1">)) ||</span>
               <span class="s3">withinFlowCollection </span><span class="s1">&amp;&amp; </span><span class="s3">is_FLOW_INDICATOR</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s2">break</span><span class="s1">;</span>

    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s3">_line </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">line</span><span class="s1">;</span>
      <span class="s3">_lineStart </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineStart</span><span class="s1">;</span>
      <span class="s3">_lineIndent </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent</span><span class="s1">;</span>
      <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">);</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&gt;= </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
        <span class="s3">hasPendingContent </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
        <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
        <span class="s2">continue</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">= </span><span class="s3">captureEnd</span><span class="s1">;</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">line </span><span class="s1">= </span><span class="s3">_line</span><span class="s1">;</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">lineStart </span><span class="s1">= </span><span class="s3">_lineStart</span><span class="s1">;</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">= </span><span class="s3">_lineIndent</span><span class="s1">;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">hasPendingContent</span><span class="s1">) {</span>
      <span class="s3">captureSegment</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">captureStart</span><span class="s1">, </span><span class="s3">captureEnd</span><span class="s1">, </span><span class="s2">false</span><span class="s1">);</span>
      <span class="s3">writeFoldedLines</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">line </span><span class="s1">- </span><span class="s3">_line</span><span class="s1">);</span>
      <span class="s3">captureStart </span><span class="s1">= </span><span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>
      <span class="s3">hasPendingContent </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">is_WHITE_SPACE</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">captureSegment</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">captureStart</span><span class="s1">, </span><span class="s3">captureEnd</span><span class="s1">, </span><span class="s2">false</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">) {</span>
    <span class="s2">return true</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">= </span><span class="s3">_kind</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s3">_result</span><span class="s1">;</span>
  <span class="s2">return false</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readSingleQuotedScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">ch</span><span class="s1">,</span>
      <span class="s3">captureStart</span><span class="s1">, </span><span class="s3">captureEnd</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x27</span><span class="s0">/* ' */</span><span class="s1">) {</span>
    <span class="s2">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">= </span><span class="s4">'scalar'</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
  <span class="s3">captureStart </span><span class="s1">= </span><span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">((</span><span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">)) !== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x27</span><span class="s0">/* ' */</span><span class="s1">) {</span>
      <span class="s3">captureSegment</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">captureStart</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x27</span><span class="s0">/* ' */</span><span class="s1">) {</span>
        <span class="s3">captureStart </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
        <span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s2">return true</span><span class="s1">;</span>
      <span class="s1">}</span>

    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s3">captureSegment</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">captureStart</span><span class="s1">, </span><span class="s3">captureEnd</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
      <span class="s3">writeFoldedLines</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">));</span>
      <span class="s3">captureStart </span><span class="s1">= </span><span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">=== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineStart </span><span class="s1">&amp;&amp; </span><span class="s3">testDocumentSeparator</span><span class="s1">(</span><span class="s3">state</span><span class="s1">)) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unexpected end of the document within a single quoted scalar'</span><span class="s1">);</span>

    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
      <span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unexpected end of the stream within a single quoted scalar'</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readDoubleQuotedScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">captureStart</span><span class="s1">,</span>
      <span class="s3">captureEnd</span><span class="s1">,</span>
      <span class="s3">hexLength</span><span class="s1">,</span>
      <span class="s3">hexResult</span><span class="s1">,</span>
      <span class="s3">tmp</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x22</span><span class="s0">/* &quot; */</span><span class="s1">) {</span>
    <span class="s2">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">= </span><span class="s4">'scalar'</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
  <span class="s3">captureStart </span><span class="s1">= </span><span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">((</span><span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">)) !== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x22</span><span class="s0">/* &quot; */</span><span class="s1">) {</span>
      <span class="s3">captureSegment</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">captureStart</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
      <span class="s2">return true</span><span class="s1">;</span>

    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x5C</span><span class="s0">/* \ */</span><span class="s1">) {</span>
      <span class="s3">captureSegment</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">captureStart</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
        <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">);</span>

        <span class="s0">// TODO: rework to inline fn with no type cast?</span>
      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">&lt; </span><span class="s5">256 </span><span class="s1">&amp;&amp; </span><span class="s3">simpleEscapeCheck</span><span class="s1">[</span><span class="s3">ch</span><span class="s1">]) {</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s3">simpleEscapeMap</span><span class="s1">[</span><span class="s3">ch</span><span class="s1">];</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>

      <span class="s1">} </span><span class="s2">else if </span><span class="s1">((</span><span class="s3">tmp </span><span class="s1">= </span><span class="s3">escapedHexLen</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) &gt; </span><span class="s5">0</span><span class="s1">) {</span>
        <span class="s3">hexLength </span><span class="s1">= </span><span class="s3">tmp</span><span class="s1">;</span>
        <span class="s3">hexResult </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

        <span class="s2">for </span><span class="s1">(; </span><span class="s3">hexLength </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">; </span><span class="s3">hexLength</span><span class="s1">--) {</span>
          <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

          <span class="s2">if </span><span class="s1">((</span><span class="s3">tmp </span><span class="s1">= </span><span class="s3">fromHexCode</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) &gt;= </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s3">hexResult </span><span class="s1">= (</span><span class="s3">hexResult </span><span class="s1">&lt;&lt; </span><span class="s5">4</span><span class="s1">) + </span><span class="s3">tmp</span><span class="s1">;</span>

          <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'expected hexadecimal character'</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s3">charFromCodepoint</span><span class="s1">(</span><span class="s3">hexResult</span><span class="s1">);</span>

        <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>

      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unknown escape sequence'</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">captureStart </span><span class="s1">= </span><span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s3">captureSegment</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">captureStart</span><span class="s1">, </span><span class="s3">captureEnd</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
      <span class="s3">writeFoldedLines</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">));</span>
      <span class="s3">captureStart </span><span class="s1">= </span><span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">=== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineStart </span><span class="s1">&amp;&amp; </span><span class="s3">testDocumentSeparator</span><span class="s1">(</span><span class="s3">state</span><span class="s1">)) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unexpected end of the document within a double quoted scalar'</span><span class="s1">);</span>

    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
      <span class="s3">captureEnd </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unexpected end of the stream within a double quoted scalar'</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readFlowCollection</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">readNext </span><span class="s1">= </span><span class="s2">true</span><span class="s1">,</span>
      <span class="s3">_line</span><span class="s1">,</span>
      <span class="s3">_tag     </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">,</span>
      <span class="s3">_result</span><span class="s1">,</span>
      <span class="s3">_anchor  </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor</span><span class="s1">,</span>
      <span class="s3">following</span><span class="s1">,</span>
      <span class="s3">terminator</span><span class="s1">,</span>
      <span class="s3">isPair</span><span class="s1">,</span>
      <span class="s3">isExplicitPair</span><span class="s1">,</span>
      <span class="s3">isMapping</span><span class="s1">,</span>
      <span class="s3">overridableKeys </span><span class="s1">= {},</span>
      <span class="s3">keyNode</span><span class="s1">,</span>
      <span class="s3">keyTag</span><span class="s1">,</span>
      <span class="s3">valueNode</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x5B</span><span class="s0">/* [ */</span><span class="s1">) {</span>
    <span class="s3">terminator </span><span class="s1">= </span><span class="s5">0x5D</span><span class="s1">;</span><span class="s0">/* ] */</span>
    <span class="s3">isMapping </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
    <span class="s3">_result </span><span class="s1">= [];</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x7B</span><span class="s0">/* { */</span><span class="s1">) {</span>
    <span class="s3">terminator </span><span class="s1">= </span><span class="s5">0x7D</span><span class="s1">;</span><span class="s0">/* } */</span>
    <span class="s3">isMapping </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s3">_result </span><span class="s1">= {};</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s2">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">anchorMap</span><span class="s1">[</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor</span><span class="s1">] = </span><span class="s3">_result</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">);</span>

    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s3">terminator</span><span class="s1">) {</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">_tag</span><span class="s1">;</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">= </span><span class="s3">_anchor</span><span class="s1">;</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">= </span><span class="s3">isMapping </span><span class="s1">? </span><span class="s4">'mapping' </span><span class="s1">: </span><span class="s4">'sequence'</span><span class="s1">;</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s3">_result</span><span class="s1">;</span>
      <span class="s2">return true</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!</span><span class="s3">readNext</span><span class="s1">) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'missed comma between flow collection entries'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">keyTag </span><span class="s1">= </span><span class="s3">keyNode </span><span class="s1">= </span><span class="s3">valueNode </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
    <span class="s3">isPair </span><span class="s1">= </span><span class="s3">isExplicitPair </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3F</span><span class="s0">/* ? */</span><span class="s1">) {</span>
      <span class="s3">following </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">following</span><span class="s1">)) {</span>
        <span class="s3">isPair </span><span class="s1">= </span><span class="s3">isExplicitPair </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>
        <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">_line </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">line</span><span class="s1">;</span>
    <span class="s3">composeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">, </span><span class="s3">CONTEXT_FLOW_IN</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
    <span class="s3">keyTag </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">;</span>
    <span class="s3">keyNode </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">;</span>
    <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">);</span>

    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">((</span><span class="s3">isExplicitPair </span><span class="s1">|| </span><span class="s3">state</span><span class="s1">.</span><span class="s3">line </span><span class="s1">=== </span><span class="s3">_line</span><span class="s1">) &amp;&amp; </span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3A</span><span class="s0">/* : */</span><span class="s1">) {</span>
      <span class="s3">isPair </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
      <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">);</span>
      <span class="s3">composeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">, </span><span class="s3">CONTEXT_FLOW_IN</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
      <span class="s3">valueNode </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">isMapping</span><span class="s1">) {</span>
      <span class="s3">storeMappingPair</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">_result</span><span class="s1">, </span><span class="s3">overridableKeys</span><span class="s1">, </span><span class="s3">keyTag</span><span class="s1">, </span><span class="s3">keyNode</span><span class="s1">, </span><span class="s3">valueNode</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">isPair</span><span class="s1">) {</span>
      <span class="s3">_result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">storeMappingPair</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">null</span><span class="s1">, </span><span class="s3">overridableKeys</span><span class="s1">, </span><span class="s3">keyTag</span><span class="s1">, </span><span class="s3">keyNode</span><span class="s1">, </span><span class="s3">valueNode</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">_result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">keyNode</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">);</span>

    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x2C</span><span class="s0">/* , */</span><span class="s1">) {</span>
      <span class="s3">readNext </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">readNext </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unexpected end of the stream within a flow collection'</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readBlockScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">captureStart</span><span class="s1">,</span>
      <span class="s3">folding</span><span class="s1">,</span>
      <span class="s3">chomping       </span><span class="s1">= </span><span class="s3">CHOMPING_CLIP</span><span class="s1">,</span>
      <span class="s3">didReadContent </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">detectedIndent </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">textIndent     </span><span class="s1">= </span><span class="s3">nodeIndent</span><span class="s1">,</span>
      <span class="s3">emptyLines     </span><span class="s1">= </span><span class="s5">0</span><span class="s1">,</span>
      <span class="s3">atMoreIndented </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">tmp</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x7C</span><span class="s0">/* | */</span><span class="s1">) {</span>
    <span class="s3">folding </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3E</span><span class="s0">/* &gt; */</span><span class="s1">) {</span>
    <span class="s3">folding </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s2">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">= </span><span class="s4">'scalar'</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x2B</span><span class="s0">/* + */ </span><span class="s1">|| </span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x2D</span><span class="s0">/* - */</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">CHOMPING_CLIP </span><span class="s1">=== </span><span class="s3">chomping</span><span class="s1">) {</span>
        <span class="s3">chomping </span><span class="s1">= (</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x2B</span><span class="s0">/* + */</span><span class="s1">) ? </span><span class="s3">CHOMPING_KEEP </span><span class="s1">: </span><span class="s3">CHOMPING_STRIP</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'repeat of a chomping mode identifier'</span><span class="s1">);</span>
      <span class="s1">}</span>

    <span class="s1">} </span><span class="s2">else if </span><span class="s1">((</span><span class="s3">tmp </span><span class="s1">= </span><span class="s3">fromDecimalCode</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) &gt;= </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">tmp </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'bad explicit indentation width of a block scalar; it cannot be less than one'</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(!</span><span class="s3">detectedIndent</span><span class="s1">) {</span>
        <span class="s3">textIndent </span><span class="s1">= </span><span class="s3">nodeIndent </span><span class="s1">+ </span><span class="s3">tmp </span><span class="s1">- </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s3">detectedIndent </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'repeat of an indentation width identifier'</span><span class="s1">);</span>
      <span class="s1">}</span>

    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">is_WHITE_SPACE</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
    <span class="s2">do </span><span class="s1">{ </span><span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">); }</span>
    <span class="s2">while </span><span class="s1">(</span><span class="s3">is_WHITE_SPACE</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">));</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x23</span><span class="s0">/* # */</span><span class="s1">) {</span>
      <span class="s2">do </span><span class="s1">{ </span><span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">); }</span>
      <span class="s2">while </span><span class="s1">(!</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">) &amp;&amp; (</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">));</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">readLineBreak</span><span class="s1">(</span><span class="s3">state</span><span class="s1">);</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

    <span class="s2">while </span><span class="s1">((!</span><span class="s3">detectedIndent </span><span class="s1">|| </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&lt; </span><span class="s3">textIndent</span><span class="s1">) &amp;&amp;</span>
           <span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x20</span><span class="s0">/* Space */</span><span class="s1">)) {</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent</span><span class="s1">++;</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">detectedIndent </span><span class="s1">&amp;&amp; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&gt; </span><span class="s3">textIndent</span><span class="s1">) {</span>
      <span class="s3">textIndent </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s3">emptyLines</span><span class="s1">++;</span>
      <span class="s2">continue</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">// End of the scalar.</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&lt; </span><span class="s3">textIndent</span><span class="s1">) {</span>

      <span class="s0">// Perform the chomping.</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">chomping </span><span class="s1">=== </span><span class="s3">CHOMPING_KEEP</span><span class="s1">) {</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">, </span><span class="s3">didReadContent </span><span class="s1">? </span><span class="s5">1 </span><span class="s1">+ </span><span class="s3">emptyLines </span><span class="s1">: </span><span class="s3">emptyLines</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">chomping </span><span class="s1">=== </span><span class="s3">CHOMPING_CLIP</span><span class="s1">) {</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">didReadContent</span><span class="s1">) { </span><span class="s0">// i.e. only if the scalar is not empty.</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s0">// Break this `while` cycle and go to the funciton's epilogue.</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">// Folded style: use fancy rules to handle line breaks.</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">folding</span><span class="s1">) {</span>

      <span class="s0">// Lines starting with white space characters (more-indented lines) are not folded.</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">is_WHITE_SPACE</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
        <span class="s3">atMoreIndented </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
        <span class="s0">// except for the first content line (cf. Example 8.1)</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">, </span><span class="s3">didReadContent </span><span class="s1">? </span><span class="s5">1 </span><span class="s1">+ </span><span class="s3">emptyLines </span><span class="s1">: </span><span class="s3">emptyLines</span><span class="s1">);</span>

      <span class="s0">// End of more-indented block.</span>
      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">atMoreIndented</span><span class="s1">) {</span>
        <span class="s3">atMoreIndented </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">, </span><span class="s3">emptyLines </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>

      <span class="s0">// Just one line break - perceive as the same line.</span>
      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">emptyLines </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">didReadContent</span><span class="s1">) { </span><span class="s0">// i.e. only if we have already read some scalar content.</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s4">' '</span><span class="s1">;</span>
        <span class="s1">}</span>

      <span class="s0">// Several line breaks - perceive as different lines.</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">, </span><span class="s3">emptyLines</span><span class="s1">);</span>
      <span class="s1">}</span>

    <span class="s0">// Literal style: just add exact number of line breaks between content lines.</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s0">// Keep all line breaks except the header line break.</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">+= </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">, </span><span class="s3">didReadContent </span><span class="s1">? </span><span class="s5">1 </span><span class="s1">+ </span><span class="s3">emptyLines </span><span class="s1">: </span><span class="s3">emptyLines</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">didReadContent </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s3">detectedIndent </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s3">emptyLines </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
    <span class="s3">captureStart </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

    <span class="s2">while </span><span class="s1">(!</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">) &amp;&amp; (</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">)) {</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">captureSegment</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">captureStart</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">, </span><span class="s2">false</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readBlockSequence</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_line</span><span class="s1">,</span>
      <span class="s3">_tag      </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">,</span>
      <span class="s3">_anchor   </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor</span><span class="s1">,</span>
      <span class="s3">_result   </span><span class="s1">= [],</span>
      <span class="s3">following</span><span class="s1">,</span>
      <span class="s3">detected  </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">anchorMap</span><span class="s1">[</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor</span><span class="s1">] = </span><span class="s3">_result</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x2D</span><span class="s0">/* - */</span><span class="s1">) {</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">following </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">following</span><span class="s1">)) {</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">detected </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">++;</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">)) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&lt;= </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
        <span class="s3">_result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s2">null</span><span class="s1">);</span>
        <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
        <span class="s2">continue</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">_line </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">line</span><span class="s1">;</span>
    <span class="s3">composeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">, </span><span class="s3">CONTEXT_BLOCK_IN</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
    <span class="s3">_result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">);</span>
    <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">);</span>

    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">((</span><span class="s3">state</span><span class="s1">.</span><span class="s3">line </span><span class="s1">=== </span><span class="s3">_line </span><span class="s1">|| </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&gt; </span><span class="s3">nodeIndent</span><span class="s1">) &amp;&amp; (</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">)) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'bad indentation of a sequence entry'</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&lt; </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">detected</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">_tag</span><span class="s1">;</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">= </span><span class="s3">_anchor</span><span class="s1">;</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">= </span><span class="s4">'sequence'</span><span class="s1">;</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s3">_result</span><span class="s1">;</span>
    <span class="s2">return true</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">return false</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readBlockMapping</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">, </span><span class="s3">flowIndent</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">following</span><span class="s1">,</span>
      <span class="s3">allowCompact</span><span class="s1">,</span>
      <span class="s3">_line</span><span class="s1">,</span>
      <span class="s3">_pos</span><span class="s1">,</span>
      <span class="s3">_tag          </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">,</span>
      <span class="s3">_anchor       </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor</span><span class="s1">,</span>
      <span class="s3">_result       </span><span class="s1">= {},</span>
      <span class="s3">overridableKeys </span><span class="s1">= {},</span>
      <span class="s3">keyTag        </span><span class="s1">= </span><span class="s2">null</span><span class="s1">,</span>
      <span class="s3">keyNode       </span><span class="s1">= </span><span class="s2">null</span><span class="s1">,</span>
      <span class="s3">valueNode     </span><span class="s1">= </span><span class="s2">null</span><span class="s1">,</span>
      <span class="s3">atExplicitKey </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">detected      </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">anchorMap</span><span class="s1">[</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor</span><span class="s1">] = </span><span class="s3">_result</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">following </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
    <span class="s3">_line </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">line</span><span class="s1">; </span><span class="s0">// Save the current line.</span>
    <span class="s3">_pos </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

    <span class="s0">//</span>
    <span class="s0">// Explicit notation case. There are two separate blocks:</span>
    <span class="s0">// first for the key (denoted by &quot;?&quot;) and second for the value (denoted by &quot;:&quot;)</span>
    <span class="s0">//</span>
    <span class="s2">if </span><span class="s1">((</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3F</span><span class="s0">/* ? */ </span><span class="s1">|| </span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3A</span><span class="s0">/* : */</span><span class="s1">) &amp;&amp; </span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">following</span><span class="s1">)) {</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3F</span><span class="s0">/* ? */</span><span class="s1">) {</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">atExplicitKey</span><span class="s1">) {</span>
          <span class="s3">storeMappingPair</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">_result</span><span class="s1">, </span><span class="s3">overridableKeys</span><span class="s1">, </span><span class="s3">keyTag</span><span class="s1">, </span><span class="s3">keyNode</span><span class="s1">, </span><span class="s2">null</span><span class="s1">);</span>
          <span class="s3">keyTag </span><span class="s1">= </span><span class="s3">keyNode </span><span class="s1">= </span><span class="s3">valueNode </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">detected </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
        <span class="s3">atExplicitKey </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
        <span class="s3">allowCompact </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>

      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">atExplicitKey</span><span class="s1">) {</span>
        <span class="s0">// i.e. 0x3A/* : */ === character after the explicit key.</span>
        <span class="s3">atExplicitKey </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
        <span class="s3">allowCompact </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>

      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line'</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">following</span><span class="s1">;</span>

    <span class="s0">//</span>
    <span class="s0">// Implicit notation case. Flow-style node as the key first, then &quot;:&quot;, and the value.</span>
    <span class="s0">//</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">composeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">flowIndent</span><span class="s1">, </span><span class="s3">CONTEXT_FLOW_OUT</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s2">true</span><span class="s1">)) {</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">line </span><span class="s1">=== </span><span class="s3">_line</span><span class="s1">) {</span>
        <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

        <span class="s2">while </span><span class="s1">(</span><span class="s3">is_WHITE_SPACE</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
          <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3A</span><span class="s0">/* : */</span><span class="s1">) {</span>
          <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

          <span class="s2">if </span><span class="s1">(!</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
            <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'a whitespace character is expected after the key-value separator within a block mapping'</span><span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s2">if </span><span class="s1">(</span><span class="s3">atExplicitKey</span><span class="s1">) {</span>
            <span class="s3">storeMappingPair</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">_result</span><span class="s1">, </span><span class="s3">overridableKeys</span><span class="s1">, </span><span class="s3">keyTag</span><span class="s1">, </span><span class="s3">keyNode</span><span class="s1">, </span><span class="s2">null</span><span class="s1">);</span>
            <span class="s3">keyTag </span><span class="s1">= </span><span class="s3">keyNode </span><span class="s1">= </span><span class="s3">valueNode </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s3">detected </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
          <span class="s3">atExplicitKey </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
          <span class="s3">allowCompact </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
          <span class="s3">keyTag </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">;</span>
          <span class="s3">keyNode </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">;</span>

        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">detected</span><span class="s1">) {</span>
          <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'can not read an implicit mapping pair; a colon is missed'</span><span class="s1">);</span>

        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">_tag</span><span class="s1">;</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">= </span><span class="s3">_anchor</span><span class="s1">;</span>
          <span class="s2">return true</span><span class="s1">; </span><span class="s0">// Keep the result of `composeNode`.</span>
        <span class="s1">}</span>

      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">detected</span><span class="s1">) {</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'can not read a block mapping entry; a multiline key may not be an implicit key'</span><span class="s1">);</span>

      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">_tag</span><span class="s1">;</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">= </span><span class="s3">_anchor</span><span class="s1">;</span>
        <span class="s2">return true</span><span class="s1">; </span><span class="s0">// Keep the result of `composeNode`.</span>
      <span class="s1">}</span>

    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s2">break</span><span class="s1">; </span><span class="s0">// Reading is done. Go to the epilogue.</span>
    <span class="s1">}</span>

    <span class="s0">//</span>
    <span class="s0">// Common reading code for both explicit and implicit notations.</span>
    <span class="s0">//</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">line </span><span class="s1">=== </span><span class="s3">_line </span><span class="s1">|| </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&gt; </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">composeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">nodeIndent</span><span class="s1">, </span><span class="s3">CONTEXT_BLOCK_OUT</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, </span><span class="s3">allowCompact</span><span class="s1">)) {</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">atExplicitKey</span><span class="s1">) {</span>
          <span class="s3">keyNode </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
          <span class="s3">valueNode </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s2">if </span><span class="s1">(!</span><span class="s3">atExplicitKey</span><span class="s1">) {</span>
        <span class="s3">storeMappingPair</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">_result</span><span class="s1">, </span><span class="s3">overridableKeys</span><span class="s1">, </span><span class="s3">keyTag</span><span class="s1">, </span><span class="s3">keyNode</span><span class="s1">, </span><span class="s3">valueNode</span><span class="s1">, </span><span class="s3">_line</span><span class="s1">, </span><span class="s3">_pos</span><span class="s1">);</span>
        <span class="s3">keyTag </span><span class="s1">= </span><span class="s3">keyNode </span><span class="s1">= </span><span class="s3">valueNode </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">);</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&gt; </span><span class="s3">nodeIndent </span><span class="s1">&amp;&amp; (</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">)) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'bad indentation of a mapping entry'</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&lt; </span><span class="s3">nodeIndent</span><span class="s1">) {</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">//</span>
  <span class="s0">// Epilogue.</span>
  <span class="s0">//</span>

  <span class="s0">// Special case: last mapping's node contains only the key in explicit notation.</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">atExplicitKey</span><span class="s1">) {</span>
    <span class="s3">storeMappingPair</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">_result</span><span class="s1">, </span><span class="s3">overridableKeys</span><span class="s1">, </span><span class="s3">keyTag</span><span class="s1">, </span><span class="s3">keyNode</span><span class="s1">, </span><span class="s2">null</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">// Expose the resulting mapping.</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">detected</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">_tag</span><span class="s1">;</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">= </span><span class="s3">_anchor</span><span class="s1">;</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">= </span><span class="s4">'mapping'</span><span class="s1">;</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s3">_result</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">detected</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readTagProperty</span><span class="s1">(</span><span class="s3">state</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_position</span><span class="s1">,</span>
      <span class="s3">isVerbatim </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">isNamed    </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">tagHandle</span><span class="s1">,</span>
      <span class="s3">tagName</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x21</span><span class="s0">/* ! */</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'duplication of a tag property'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x3C</span><span class="s0">/* &lt; */</span><span class="s1">) {</span>
    <span class="s3">isVerbatim </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x21</span><span class="s0">/* ! */</span><span class="s1">) {</span>
    <span class="s3">isNamed </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s3">tagHandle </span><span class="s1">= </span><span class="s4">'!!'</span><span class="s1">;</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s3">tagHandle </span><span class="s1">= </span><span class="s4">'!'</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">_position </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">isVerbatim</span><span class="s1">) {</span>
    <span class="s2">do </span><span class="s1">{ </span><span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">); }</span>
    <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0 </span><span class="s1">&amp;&amp; </span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x3E</span><span class="s0">/* &gt; */</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">&lt; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">length</span><span class="s1">) {</span>
      <span class="s3">tagName </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">_position</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unexpected end of the stream within a verbatim tag'</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0 </span><span class="s1">&amp;&amp; !</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x21</span><span class="s0">/* ! */</span><span class="s1">) {</span>
        <span class="s2">if </span><span class="s1">(!</span><span class="s3">isNamed</span><span class="s1">) {</span>
          <span class="s3">tagHandle </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">_position </span><span class="s1">- </span><span class="s5">1</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>

          <span class="s2">if </span><span class="s1">(!</span><span class="s3">PATTERN_TAG_HANDLE</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">tagHandle</span><span class="s1">)) {</span>
            <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'named tag handle cannot contain such characters'</span><span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s3">isNamed </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
          <span class="s3">_position </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
          <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'tag suffix cannot contain exclamation marks'</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">tagName </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">_position</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">PATTERN_FLOW_INDICATORS</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">tagName</span><span class="s1">)) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'tag suffix cannot contain flow indicator characters'</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">tagName </span><span class="s1">&amp;&amp; !</span><span class="s3">PATTERN_TAG_URI</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">tagName</span><span class="s1">)) {</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'tag name cannot contain such characters: ' </span><span class="s1">+ </span><span class="s3">tagName</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">isVerbatim</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">tagName</span><span class="s1">;</span>

  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tagMap</span><span class="s1">, </span><span class="s3">tagHandle</span><span class="s1">)) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tagMap</span><span class="s1">[</span><span class="s3">tagHandle</span><span class="s1">] + </span><span class="s3">tagName</span><span class="s1">;</span>

  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">tagHandle </span><span class="s1">=== </span><span class="s4">'!'</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s4">'!' </span><span class="s1">+ </span><span class="s3">tagName</span><span class="s1">;</span>

  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">tagHandle </span><span class="s1">=== </span><span class="s4">'!!'</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s4">'tag:yaml.org,2002:' </span><span class="s1">+ </span><span class="s3">tagName</span><span class="s1">;</span>

  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'undeclared tag handle &quot;' </span><span class="s1">+ </span><span class="s3">tagHandle </span><span class="s1">+ </span><span class="s4">'&quot;'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readAnchorProperty</span><span class="s1">(</span><span class="s3">state</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_position</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x26</span><span class="s0">/* &amp; */</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'duplication of an anchor property'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
  <span class="s3">_position </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0 </span><span class="s1">&amp;&amp; !</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">) &amp;&amp; !</span><span class="s3">is_FLOW_INDICATOR</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">=== </span><span class="s3">_position</span><span class="s1">) {</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'name of an anchor node must contain at least one character'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">_position</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readAlias</span><span class="s1">(</span><span class="s3">state</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">_position</span><span class="s1">, </span><span class="s3">alias</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x2A</span><span class="s0">/* * */</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
  <span class="s3">_position </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0 </span><span class="s1">&amp;&amp; !</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">) &amp;&amp; !</span><span class="s3">is_FLOW_INDICATOR</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">=== </span><span class="s3">_position</span><span class="s1">) {</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'name of an alias node must contain at least one character'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">alias </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">_position</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchorMap</span><span class="s1">, </span><span class="s3">alias</span><span class="s1">)) {</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unidentified alias &quot;' </span><span class="s1">+ </span><span class="s3">alias </span><span class="s1">+ </span><span class="s4">'&quot;'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchorMap</span><span class="s1">[</span><span class="s3">alias</span><span class="s1">];</span>
  <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">);</span>
  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">composeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">parentIndent</span><span class="s1">, </span><span class="s3">nodeContext</span><span class="s1">, </span><span class="s3">allowToSeek</span><span class="s1">, </span><span class="s3">allowCompact</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">allowBlockStyles</span><span class="s1">,</span>
      <span class="s3">allowBlockScalars</span><span class="s1">,</span>
      <span class="s3">allowBlockCollections</span><span class="s1">,</span>
      <span class="s3">indentStatus </span><span class="s1">= </span><span class="s5">1</span><span class="s1">, </span><span class="s0">// 1: this&gt;parent, 0: this=parent, -1: this&lt;parent</span>
      <span class="s3">atNewLine  </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">hasContent </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">typeIndex</span><span class="s1">,</span>
      <span class="s3">typeQuantity</span><span class="s1">,</span>
      <span class="s3">type</span><span class="s1">,</span>
      <span class="s3">flowIndent</span><span class="s1">,</span>
      <span class="s3">blockIndent</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">listener </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">listener</span><span class="s1">(</span><span class="s4">'open'</span><span class="s1">, </span><span class="s3">state</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">tag    </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">kind   </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>

  <span class="s3">allowBlockStyles </span><span class="s1">= </span><span class="s3">allowBlockScalars </span><span class="s1">= </span><span class="s3">allowBlockCollections </span><span class="s1">=</span>
    <span class="s3">CONTEXT_BLOCK_OUT </span><span class="s1">=== </span><span class="s3">nodeContext </span><span class="s1">||</span>
    <span class="s3">CONTEXT_BLOCK_IN  </span><span class="s1">=== </span><span class="s3">nodeContext</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">allowToSeek</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">)) {</span>
      <span class="s3">atNewLine </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&gt; </span><span class="s3">parentIndent</span><span class="s1">) {</span>
        <span class="s3">indentStatus </span><span class="s1">= </span><span class="s5">1</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">=== </span><span class="s3">parentIndent</span><span class="s1">) {</span>
        <span class="s3">indentStatus </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&lt; </span><span class="s3">parentIndent</span><span class="s1">) {</span>
        <span class="s3">indentStatus </span><span class="s1">= -</span><span class="s5">1</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">indentStatus </span><span class="s1">=== </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s2">while </span><span class="s1">(</span><span class="s3">readTagProperty</span><span class="s1">(</span><span class="s3">state</span><span class="s1">) || </span><span class="s3">readAnchorProperty</span><span class="s1">(</span><span class="s3">state</span><span class="s1">)) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">)) {</span>
        <span class="s3">atNewLine </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
        <span class="s3">allowBlockCollections </span><span class="s1">= </span><span class="s3">allowBlockStyles</span><span class="s1">;</span>

        <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&gt; </span><span class="s3">parentIndent</span><span class="s1">) {</span>
          <span class="s3">indentStatus </span><span class="s1">= </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">=== </span><span class="s3">parentIndent</span><span class="s1">) {</span>
          <span class="s3">indentStatus </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&lt; </span><span class="s3">parentIndent</span><span class="s1">) {</span>
          <span class="s3">indentStatus </span><span class="s1">= -</span><span class="s5">1</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">allowBlockCollections </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">allowBlockCollections</span><span class="s1">) {</span>
    <span class="s3">allowBlockCollections </span><span class="s1">= </span><span class="s3">atNewLine </span><span class="s1">|| </span><span class="s3">allowCompact</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">indentStatus </span><span class="s1">=== </span><span class="s5">1 </span><span class="s1">|| </span><span class="s3">CONTEXT_BLOCK_OUT </span><span class="s1">=== </span><span class="s3">nodeContext</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">CONTEXT_FLOW_IN </span><span class="s1">=== </span><span class="s3">nodeContext </span><span class="s1">|| </span><span class="s3">CONTEXT_FLOW_OUT </span><span class="s1">=== </span><span class="s3">nodeContext</span><span class="s1">) {</span>
      <span class="s3">flowIndent </span><span class="s1">= </span><span class="s3">parentIndent</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">flowIndent </span><span class="s1">= </span><span class="s3">parentIndent </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">blockIndent </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">- </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineStart</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">indentStatus </span><span class="s1">=== </span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">allowBlockCollections </span><span class="s1">&amp;&amp;</span>
          <span class="s1">(</span><span class="s3">readBlockSequence</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">blockIndent</span><span class="s1">) ||</span>
           <span class="s3">readBlockMapping</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">blockIndent</span><span class="s1">, </span><span class="s3">flowIndent</span><span class="s1">)) ||</span>
          <span class="s3">readFlowCollection</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">flowIndent</span><span class="s1">)) {</span>
        <span class="s3">hasContent </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s2">if </span><span class="s1">((</span><span class="s3">allowBlockScalars </span><span class="s1">&amp;&amp; </span><span class="s3">readBlockScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">flowIndent</span><span class="s1">)) ||</span>
            <span class="s3">readSingleQuotedScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">flowIndent</span><span class="s1">) ||</span>
            <span class="s3">readDoubleQuotedScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">flowIndent</span><span class="s1">)) {</span>
          <span class="s3">hasContent </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>

        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">readAlias</span><span class="s1">(</span><span class="s3">state</span><span class="s1">)) {</span>
          <span class="s3">hasContent </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>

          <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">|| </span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
            <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'alias node should not have any properties'</span><span class="s1">);</span>
          <span class="s1">}</span>

        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">readPlainScalar</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">flowIndent</span><span class="s1">, </span><span class="s3">CONTEXT_FLOW_IN </span><span class="s1">=== </span><span class="s3">nodeContext</span><span class="s1">)) {</span>
          <span class="s3">hasContent </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>

          <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) {</span>
            <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s4">'?'</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">anchorMap</span><span class="s1">[</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor</span><span class="s1">] = </span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">indentStatus </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s0">// Special case: block sequences are allowed to have same indentation level as the parent.</span>
      <span class="s0">// http://www.yaml.org/spec/1.2/spec.html#id2799784</span>
      <span class="s3">hasContent </span><span class="s1">= </span><span class="s3">allowBlockCollections </span><span class="s1">&amp;&amp; </span><span class="s3">readBlockSequence</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">blockIndent</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">&amp;&amp; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s4">'!'</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">=== </span><span class="s4">'?'</span><span class="s1">) {</span>
      <span class="s0">// Implicit resolving is not allowed for non-scalar types, and '?'</span>
      <span class="s0">// non-specific tag is only automatically assigned to plain scalars.</span>
      <span class="s0">//</span>
      <span class="s0">// We only need to check kind conformity in case user explicitly assigns '?'</span>
      <span class="s0">// tag, for example like this: &quot;!&lt;?&gt; [0]&quot;</span>
      <span class="s0">//</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">&amp;&amp; </span><span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">!== </span><span class="s4">'scalar'</span><span class="s1">) {</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unacceptable node kind for !&lt;?&gt; tag; it should be &quot;scalar&quot;, not &quot;' </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">+ </span><span class="s4">'&quot;'</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">for </span><span class="s1">(</span><span class="s3">typeIndex </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">typeQuantity </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">implicitTypes</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">typeIndex </span><span class="s1">&lt; </span><span class="s3">typeQuantity</span><span class="s1">; </span><span class="s3">typeIndex </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
        <span class="s3">type </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">implicitTypes</span><span class="s1">[</span><span class="s3">typeIndex</span><span class="s1">];</span>

        <span class="s2">if </span><span class="s1">(</span><span class="s3">type</span><span class="s1">.</span><span class="s3">resolve</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">)) { </span><span class="s0">// `state.result` updated in resolver if matched</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s3">type</span><span class="s1">.</span><span class="s3">construct</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">);</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">= </span><span class="s3">type</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">;</span>
          <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
            <span class="s3">state</span><span class="s1">.</span><span class="s3">anchorMap</span><span class="s1">[</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor</span><span class="s1">] = </span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">;</span>
          <span class="s1">}</span>
          <span class="s2">break</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">typeMap</span><span class="s1">[</span><span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">|| </span><span class="s4">'fallback'</span><span class="s1">], </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">)) {</span>
      <span class="s3">type </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">typeMap</span><span class="s1">[</span><span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">|| </span><span class="s4">'fallback'</span><span class="s1">][</span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">];</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">&amp;&amp; </span><span class="s3">type</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">!== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">kind</span><span class="s1">) {</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unacceptable node kind for !&lt;' </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">+ </span><span class="s4">'&gt; tag; it should be &quot;' </span><span class="s1">+ </span><span class="s3">type</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">+ </span><span class="s4">'&quot;, not &quot;' </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">+ </span><span class="s4">'&quot;'</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">if </span><span class="s1">(!</span><span class="s3">type</span><span class="s1">.</span><span class="s3">resolve</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">)) { </span><span class="s0">// `state.result` updated in resolver if matched</span>
        <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'cannot resolve a node with !&lt;' </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">+ </span><span class="s4">'&gt; explicit tag'</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">state</span><span class="s1">.</span><span class="s3">result </span><span class="s1">= </span><span class="s3">type</span><span class="s1">.</span><span class="s3">construct</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
          <span class="s3">state</span><span class="s1">.</span><span class="s3">anchorMap</span><span class="s1">[</span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor</span><span class="s1">] = </span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unknown tag !&lt;' </span><span class="s1">+ </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">+ </span><span class="s4">'&gt;'</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">listener </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">listener</span><span class="s1">(</span><span class="s4">'close'</span><span class="s1">, </span><span class="s3">state</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s2">return </span><span class="s3">state</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">||  </span><span class="s3">state</span><span class="s1">.</span><span class="s3">anchor </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">|| </span><span class="s3">hasContent</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">readDocument</span><span class="s1">(</span><span class="s3">state</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">documentStart </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">,</span>
      <span class="s3">_position</span><span class="s1">,</span>
      <span class="s3">directiveName</span><span class="s1">,</span>
      <span class="s3">directiveArgs</span><span class="s1">,</span>
      <span class="s3">hasDirectives </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">version </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">checkLineBreaks </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">legacy</span><span class="s1">;</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">tagMap </span><span class="s1">= {};</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">anchorMap </span><span class="s1">= {};</span>

  <span class="s2">while </span><span class="s1">((</span><span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">)) !== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">);</span>

    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">&gt; </span><span class="s5">0 </span><span class="s1">|| </span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0x25</span><span class="s0">/* % */</span><span class="s1">) {</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">hasDirectives </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s3">_position </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

    <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0 </span><span class="s1">&amp;&amp; !</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">directiveName </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">_position</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
    <span class="s3">directiveArgs </span><span class="s1">= [];</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">directiveName</span><span class="s1">.</span><span class="s3">length </span><span class="s1">&lt; </span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'directive name must not be less than one character in length'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s2">while </span><span class="s1">(</span><span class="s3">is_WHITE_SPACE</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
        <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s5">0x23</span><span class="s0">/* # */</span><span class="s1">) {</span>
        <span class="s2">do </span><span class="s1">{ </span><span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">); }</span>
        <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0 </span><span class="s1">&amp;&amp; !</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">));</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">is_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) </span><span class="s2">break</span><span class="s1">;</span>

      <span class="s3">_position </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

      <span class="s2">while </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0 </span><span class="s1">&amp;&amp; !</span><span class="s3">is_WS_OR_EOL</span><span class="s1">(</span><span class="s3">ch</span><span class="s1">)) {</span>
        <span class="s3">ch </span><span class="s1">= </span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(++</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">directiveArgs</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">_position</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">));</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) </span><span class="s3">readLineBreak</span><span class="s1">(</span><span class="s3">state</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">directiveHandlers</span><span class="s1">, </span><span class="s3">directiveName</span><span class="s1">)) {</span>
      <span class="s3">directiveHandlers</span><span class="s1">[</span><span class="s3">directiveName</span><span class="s1">](</span><span class="s3">state</span><span class="s1">, </span><span class="s3">directiveName</span><span class="s1">, </span><span class="s3">directiveArgs</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">throwWarning</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'unknown document directive &quot;' </span><span class="s1">+ </span><span class="s3">directiveName </span><span class="s1">+ </span><span class="s4">'&quot;'</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">=== </span><span class="s5">0 </span><span class="s1">&amp;&amp;</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">)     === </span><span class="s5">0x2D</span><span class="s0">/* - */ </span><span class="s1">&amp;&amp;</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">) === </span><span class="s5">0x2D</span><span class="s0">/* - */ </span><span class="s1">&amp;&amp;</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">) === </span><span class="s5">0x2D</span><span class="s0">/* - */</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+= </span><span class="s5">3</span><span class="s1">;</span>
    <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">);</span>

  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">hasDirectives</span><span class="s1">) {</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'directives end mark is expected'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">composeNode</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">- </span><span class="s5">1</span><span class="s1">, </span><span class="s3">CONTEXT_BLOCK_OUT</span><span class="s1">, </span><span class="s2">false</span><span class="s1">, </span><span class="s2">true</span><span class="s1">);</span>
  <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">checkLineBreaks </span><span class="s1">&amp;&amp;</span>
      <span class="s3">PATTERN_NON_ASCII_LINE_BREAKS</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">documentStart</span><span class="s1">, </span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">))) {</span>
    <span class="s3">throwWarning</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'non-ASCII line breaks are interpreted as content'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">state</span><span class="s1">.</span><span class="s3">documents</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">result</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">=== </span><span class="s3">state</span><span class="s1">.</span><span class="s3">lineStart </span><span class="s1">&amp;&amp; </span><span class="s3">testDocumentSeparator</span><span class="s1">(</span><span class="s3">state</span><span class="s1">)) {</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">) === </span><span class="s5">0x2E</span><span class="s0">/* . */</span><span class="s1">) {</span>
      <span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+= </span><span class="s5">3</span><span class="s1">;</span>
      <span class="s3">skipSeparationSpace</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, -</span><span class="s5">1</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">return</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">&lt; (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">)) {</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'end of the stream or a document separator is expected'</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
    <span class="s2">return</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">loadDocuments</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s3">input </span><span class="s1">= </span><span class="s3">String</span><span class="s1">(</span><span class="s3">input</span><span class="s1">);</span>
  <span class="s3">options </span><span class="s1">= </span><span class="s3">options </span><span class="s1">|| {};</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">input</span><span class="s1">.</span><span class="s3">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>

    <span class="s0">// Add tailing `\n` if not exists</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">input</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">) !== </span><span class="s5">0x0A</span><span class="s0">/* LF */ </span><span class="s1">&amp;&amp;</span>
        <span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">input</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">) !== </span><span class="s5">0x0D</span><span class="s0">/* CR */</span><span class="s1">) {</span>
      <span class="s3">input </span><span class="s1">+= </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">// Strip BOM</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s5">0</span><span class="s1">) === </span><span class="s5">0xFEFF</span><span class="s1">) {</span>
      <span class="s3">input </span><span class="s1">= </span><span class="s3">input</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">1</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">var </span><span class="s3">state </span><span class="s1">= </span><span class="s2">new </span><span class="s3">State</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">options</span><span class="s1">);</span>

  <span class="s2">var </span><span class="s3">nullpos </span><span class="s1">= </span><span class="s3">input</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s4">'</span><span class="s2">\0</span><span class="s4">'</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">nullpos </span><span class="s1">!== -</span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">= </span><span class="s3">nullpos</span><span class="s1">;</span>
    <span class="s3">throwError</span><span class="s1">(</span><span class="s3">state</span><span class="s1">, </span><span class="s4">'null byte is not allowed in input'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">// Use 0 as string terminator. That significantly simplifies bounds check.</span>
  <span class="s3">state</span><span class="s1">.</span><span class="s3">input </span><span class="s1">+= </span><span class="s4">'</span><span class="s2">\0</span><span class="s4">'</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position</span><span class="s1">) === </span><span class="s5">0x20</span><span class="s0">/* Space */</span><span class="s1">) {</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">lineIndent </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">state</span><span class="s1">.</span><span class="s3">position </span><span class="s1">&lt; (</span><span class="s3">state</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">)) {</span>
    <span class="s3">readDocument</span><span class="s1">(</span><span class="s3">state</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">state</span><span class="s1">.</span><span class="s3">documents</span><span class="s1">;</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">loadAll</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">iterator</span><span class="s1">, </span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">iterator </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">&amp;&amp; </span><span class="s2">typeof </span><span class="s3">iterator </span><span class="s1">=== </span><span class="s4">'object' </span><span class="s1">&amp;&amp; </span><span class="s2">typeof </span><span class="s3">options </span><span class="s1">=== </span><span class="s4">'undefined'</span><span class="s1">) {</span>
    <span class="s3">options </span><span class="s1">= </span><span class="s3">iterator</span><span class="s1">;</span>
    <span class="s3">iterator </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">var </span><span class="s3">documents </span><span class="s1">= </span><span class="s3">loadDocuments</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">options</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">iterator </span><span class="s1">!== </span><span class="s4">'function'</span><span class="s1">) {</span>
    <span class="s2">return </span><span class="s3">documents</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">documents</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">iterator</span><span class="s1">(</span><span class="s3">documents</span><span class="s1">[</span><span class="s3">index</span><span class="s1">]);</span>
  <span class="s1">}</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">load</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">documents </span><span class="s1">= </span><span class="s3">loadDocuments</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">options</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">documents</span><span class="s1">.</span><span class="s3">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s0">/*eslint-disable no-undefined*/</span>
    <span class="s2">return </span><span class="s3">undefined</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">documents</span><span class="s1">.</span><span class="s3">length </span><span class="s1">=== </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s2">return </span><span class="s3">documents</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
  <span class="s1">}</span>
  <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'expected a single document in the stream, but found more'</span><span class="s1">);</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">safeLoadAll</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">iterator</span><span class="s1">, </span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">iterator </span><span class="s1">=== </span><span class="s4">'object' </span><span class="s1">&amp;&amp; </span><span class="s3">iterator </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">&amp;&amp; </span><span class="s2">typeof </span><span class="s3">options </span><span class="s1">=== </span><span class="s4">'undefined'</span><span class="s1">) {</span>
    <span class="s3">options </span><span class="s1">= </span><span class="s3">iterator</span><span class="s1">;</span>
    <span class="s3">iterator </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">loadAll</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">iterator</span><span class="s1">, </span><span class="s3">common</span><span class="s1">.</span><span class="s3">extend</span><span class="s1">({ </span><span class="s3">schema</span><span class="s1">: </span><span class="s3">DEFAULT_SAFE_SCHEMA </span><span class="s1">}, </span><span class="s3">options</span><span class="s1">));</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">safeLoad</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">load</span><span class="s1">(</span><span class="s3">input</span><span class="s1">, </span><span class="s3">common</span><span class="s1">.</span><span class="s3">extend</span><span class="s1">({ </span><span class="s3">schema</span><span class="s1">: </span><span class="s3">DEFAULT_SAFE_SCHEMA </span><span class="s1">}, </span><span class="s3">options</span><span class="s1">));</span>
<span class="s1">}</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">loadAll     </span><span class="s1">= </span><span class="s3">loadAll</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">load        </span><span class="s1">= </span><span class="s3">load</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">safeLoadAll </span><span class="s1">= </span><span class="s3">safeLoadAll</span><span class="s1">;</span>
<span class="s3">module</span><span class="s1">.</span><span class="s3">exports</span><span class="s1">.</span><span class="s3">safeLoad    </span><span class="s1">= </span><span class="s3">safeLoad</span><span class="s1">;</span>

<span class="s1">},{</span><span class="s4">&quot;./common&quot;</span><span class="s1">:</span><span class="s5">2</span><span class="s1">,</span><span class="s4">&quot;./exception&quot;</span><span class="s1">:</span><span class="s5">4</span><span class="s1">,</span><span class="s4">&quot;./mark&quot;</span><span class="s1">:</span><span class="s5">6</span><span class="s1">,</span><span class="s4">&quot;./schema/default_full&quot;</span><span class="s1">:</span><span class="s5">9</span><span class="s1">,</span><span class="s4">&quot;./schema/default_safe&quot;</span><span class="s1">:</span><span class="s5">10</span><span class="s1">}],</span><span class="s5">6</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">common </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./common'</span><span class="s1">);</span>


<span class="s2">function </span><span class="s3">Mark</span><span class="s1">(</span><span class="s3">name</span><span class="s1">, </span><span class="s3">buffer</span><span class="s1">, </span><span class="s3">position</span><span class="s1">, </span><span class="s3">line</span><span class="s1">, </span><span class="s3">column</span><span class="s1">) {</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">name     </span><span class="s1">= </span><span class="s3">name</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">buffer   </span><span class="s1">= </span><span class="s3">buffer</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">position </span><span class="s1">= </span><span class="s3">position</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">line     </span><span class="s1">= </span><span class="s3">line</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">column   </span><span class="s1">= </span><span class="s3">column</span><span class="s1">;</span>
<span class="s1">}</span>


<span class="s3">Mark</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">getSnippet </span><span class="s1">= </span><span class="s2">function </span><span class="s3">getSnippet</span><span class="s1">(</span><span class="s3">indent</span><span class="s1">, </span><span class="s3">maxLength</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">head</span><span class="s1">, </span><span class="s3">start</span><span class="s1">, </span><span class="s3">tail</span><span class="s1">, </span><span class="s3">end</span><span class="s1">, </span><span class="s3">snippet</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.</span><span class="s3">buffer</span><span class="s1">) </span><span class="s2">return null</span><span class="s1">;</span>

  <span class="s3">indent </span><span class="s1">= </span><span class="s3">indent </span><span class="s1">|| </span><span class="s5">4</span><span class="s1">;</span>
  <span class="s3">maxLength </span><span class="s1">= </span><span class="s3">maxLength </span><span class="s1">|| </span><span class="s5">75</span><span class="s1">;</span>

  <span class="s3">head </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>
  <span class="s3">start </span><span class="s1">= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">start </span><span class="s1">&gt; </span><span class="s5">0 </span><span class="s1">&amp;&amp; </span><span class="s4">'</span><span class="s2">\x00\r\n\x85\u2028\u2029</span><span class="s4">'</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s3">buffer</span><span class="s1">.</span><span class="s3">charAt</span><span class="s1">(</span><span class="s3">start </span><span class="s1">- </span><span class="s5">1</span><span class="s1">)) === -</span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">start </span><span class="s1">-= </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s3">position </span><span class="s1">- </span><span class="s3">start </span><span class="s1">&gt; (</span><span class="s3">maxLength </span><span class="s1">/ </span><span class="s5">2 </span><span class="s1">- </span><span class="s5">1</span><span class="s1">)) {</span>
      <span class="s3">head </span><span class="s1">= </span><span class="s4">' ... '</span><span class="s1">;</span>
      <span class="s3">start </span><span class="s1">+= </span><span class="s5">5</span><span class="s1">;</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">tail </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>
  <span class="s3">end </span><span class="s1">= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">position</span><span class="s1">;</span>

  <span class="s2">while </span><span class="s1">(</span><span class="s3">end </span><span class="s1">&lt; </span><span class="s2">this</span><span class="s1">.</span><span class="s3">buffer</span><span class="s1">.</span><span class="s3">length </span><span class="s1">&amp;&amp; </span><span class="s4">'</span><span class="s2">\x00\r\n\x85\u2028\u2029</span><span class="s4">'</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s3">buffer</span><span class="s1">.</span><span class="s3">charAt</span><span class="s1">(</span><span class="s3">end</span><span class="s1">)) === -</span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">end </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">end </span><span class="s1">- </span><span class="s2">this</span><span class="s1">.</span><span class="s3">position </span><span class="s1">&gt; (</span><span class="s3">maxLength </span><span class="s1">/ </span><span class="s5">2 </span><span class="s1">- </span><span class="s5">1</span><span class="s1">)) {</span>
      <span class="s3">tail </span><span class="s1">= </span><span class="s4">' ... '</span><span class="s1">;</span>
      <span class="s3">end </span><span class="s1">-= </span><span class="s5">5</span><span class="s1">;</span>
      <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">snippet </span><span class="s1">= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">buffer</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">start</span><span class="s1">, </span><span class="s3">end</span><span class="s1">);</span>

  <span class="s2">return </span><span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">' '</span><span class="s1">, </span><span class="s3">indent</span><span class="s1">) + </span><span class="s3">head </span><span class="s1">+ </span><span class="s3">snippet </span><span class="s1">+ </span><span class="s3">tail </span><span class="s1">+ </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">+</span>
         <span class="s3">common</span><span class="s1">.</span><span class="s3">repeat</span><span class="s1">(</span><span class="s4">' '</span><span class="s1">, </span><span class="s3">indent </span><span class="s1">+ </span><span class="s2">this</span><span class="s1">.</span><span class="s3">position </span><span class="s1">- </span><span class="s3">start </span><span class="s1">+ </span><span class="s3">head</span><span class="s1">.</span><span class="s3">length</span><span class="s1">) + </span><span class="s4">'^'</span><span class="s1">;</span>
<span class="s1">};</span>


<span class="s3">Mark</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString </span><span class="s1">= </span><span class="s2">function </span><span class="s3">toString</span><span class="s1">(</span><span class="s3">compact</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">snippet</span><span class="s1">, </span><span class="s3">where </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s3">name</span><span class="s1">) {</span>
    <span class="s3">where </span><span class="s1">+= </span><span class="s4">'in &quot;' </span><span class="s1">+ </span><span class="s2">this</span><span class="s1">.</span><span class="s3">name </span><span class="s1">+ </span><span class="s4">'&quot; '</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">where </span><span class="s1">+= </span><span class="s4">'at line ' </span><span class="s1">+ (</span><span class="s2">this</span><span class="s1">.</span><span class="s3">line </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">) + </span><span class="s4">', column ' </span><span class="s1">+ (</span><span class="s2">this</span><span class="s1">.</span><span class="s3">column </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">compact</span><span class="s1">) {</span>
    <span class="s3">snippet </span><span class="s1">= </span><span class="s2">this</span><span class="s1">.</span><span class="s3">getSnippet</span><span class="s1">();</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">snippet</span><span class="s1">) {</span>
      <span class="s3">where </span><span class="s1">+= </span><span class="s4">':</span><span class="s2">\n</span><span class="s4">' </span><span class="s1">+ </span><span class="s3">snippet</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">where</span><span class="s1">;</span>
<span class="s1">};</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s3">Mark</span><span class="s1">;</span>

<span class="s1">},{</span><span class="s4">&quot;./common&quot;</span><span class="s1">:</span><span class="s5">2</span><span class="s1">}],</span><span class="s5">7</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s0">/*eslint-disable max-len*/</span>

<span class="s2">var </span><span class="s3">common        </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./common'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">YAMLException </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./exception'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">Type          </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./type'</span><span class="s1">);</span>


<span class="s2">function </span><span class="s3">compileList</span><span class="s1">(</span><span class="s3">schema</span><span class="s1">, </span><span class="s3">name</span><span class="s1">, </span><span class="s3">result</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">exclude </span><span class="s1">= [];</span>

  <span class="s3">schema</span><span class="s1">.</span><span class="s3">include</span><span class="s1">.</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">includedSchema</span><span class="s1">) {</span>
    <span class="s3">result </span><span class="s1">= </span><span class="s3">compileList</span><span class="s1">(</span><span class="s3">includedSchema</span><span class="s1">, </span><span class="s3">name</span><span class="s1">, </span><span class="s3">result</span><span class="s1">);</span>
  <span class="s1">});</span>

  <span class="s3">schema</span><span class="s1">[</span><span class="s3">name</span><span class="s1">].</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">currentType</span><span class="s1">) {</span>
    <span class="s3">result</span><span class="s1">.</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">previousType</span><span class="s1">, </span><span class="s3">previousIndex</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">previousType</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">=== </span><span class="s3">currentType</span><span class="s1">.</span><span class="s3">tag </span><span class="s1">&amp;&amp; </span><span class="s3">previousType</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">=== </span><span class="s3">currentType</span><span class="s1">.</span><span class="s3">kind</span><span class="s1">) {</span>
        <span class="s3">exclude</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">previousIndex</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">currentType</span><span class="s1">);</span>
  <span class="s1">});</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">.</span><span class="s3">filter</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">type</span><span class="s1">, </span><span class="s3">index</span><span class="s1">) {</span>
    <span class="s2">return </span><span class="s3">exclude</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">index</span><span class="s1">) === -</span><span class="s5">1</span><span class="s1">;</span>
  <span class="s1">});</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">compileMap</span><span class="s1">(</span><span class="s0">/* lists... */</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">result </span><span class="s1">= {</span>
        <span class="s3">scalar</span><span class="s1">: {},</span>
        <span class="s3">sequence</span><span class="s1">: {},</span>
        <span class="s3">mapping</span><span class="s1">: {},</span>
        <span class="s3">fallback</span><span class="s1">: {}</span>
      <span class="s1">}, </span><span class="s3">index</span><span class="s1">, </span><span class="s3">length</span><span class="s1">;</span>

  <span class="s2">function </span><span class="s3">collectType</span><span class="s1">(</span><span class="s3">type</span><span class="s1">) {</span>
    <span class="s3">result</span><span class="s1">[</span><span class="s3">type</span><span class="s1">.</span><span class="s3">kind</span><span class="s1">][</span><span class="s3">type</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">] = </span><span class="s3">result</span><span class="s1">[</span><span class="s4">'fallback'</span><span class="s1">][</span><span class="s3">type</span><span class="s1">.</span><span class="s3">tag</span><span class="s1">] = </span><span class="s3">type</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">arguments</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">arguments</span><span class="s1">[</span><span class="s3">index</span><span class="s1">].</span><span class="s3">forEach</span><span class="s1">(</span><span class="s3">collectType</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>


<span class="s2">function </span><span class="s3">Schema</span><span class="s1">(</span><span class="s3">definition</span><span class="s1">) {</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">include  </span><span class="s1">= </span><span class="s3">definition</span><span class="s1">.</span><span class="s3">include  </span><span class="s1">|| [];</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">implicit </span><span class="s1">= </span><span class="s3">definition</span><span class="s1">.</span><span class="s3">implicit </span><span class="s1">|| [];</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">explicit </span><span class="s1">= </span><span class="s3">definition</span><span class="s1">.</span><span class="s3">explicit </span><span class="s1">|| [];</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">implicit</span><span class="s1">.</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">type</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">type</span><span class="s1">.</span><span class="s3">loadKind </span><span class="s1">&amp;&amp; </span><span class="s3">type</span><span class="s1">.</span><span class="s3">loadKind </span><span class="s1">!== </span><span class="s4">'scalar'</span><span class="s1">) {</span>
      <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.'</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>

  <span class="s2">this</span><span class="s1">.</span><span class="s3">compiledImplicit </span><span class="s1">= </span><span class="s3">compileList</span><span class="s1">(</span><span class="s2">this</span><span class="s1">, </span><span class="s4">'implicit'</span><span class="s1">, []);</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">compiledExplicit </span><span class="s1">= </span><span class="s3">compileList</span><span class="s1">(</span><span class="s2">this</span><span class="s1">, </span><span class="s4">'explicit'</span><span class="s1">, []);</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">compiledTypeMap  </span><span class="s1">= </span><span class="s3">compileMap</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s3">compiledImplicit</span><span class="s1">, </span><span class="s2">this</span><span class="s1">.</span><span class="s3">compiledExplicit</span><span class="s1">);</span>
<span class="s1">}</span>


<span class="s3">Schema</span><span class="s1">.</span><span class="s3">DEFAULT </span><span class="s1">= </span><span class="s2">null</span><span class="s1">;</span>


<span class="s3">Schema</span><span class="s1">.</span><span class="s3">create </span><span class="s1">= </span><span class="s2">function </span><span class="s3">createSchema</span><span class="s1">() {</span>
  <span class="s2">var </span><span class="s3">schemas</span><span class="s1">, </span><span class="s3">types</span><span class="s1">;</span>

  <span class="s2">switch </span><span class="s1">(</span><span class="s3">arguments</span><span class="s1">.</span><span class="s3">length</span><span class="s1">) {</span>
    <span class="s2">case </span><span class="s5">1</span><span class="s1">:</span>
      <span class="s3">schemas </span><span class="s1">= </span><span class="s3">Schema</span><span class="s1">.</span><span class="s3">DEFAULT</span><span class="s1">;</span>
      <span class="s3">types </span><span class="s1">= </span><span class="s3">arguments</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
      <span class="s2">break</span><span class="s1">;</span>

    <span class="s2">case </span><span class="s5">2</span><span class="s1">:</span>
      <span class="s3">schemas </span><span class="s1">= </span><span class="s3">arguments</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
      <span class="s3">types </span><span class="s1">= </span><span class="s3">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">];</span>
      <span class="s2">break</span><span class="s1">;</span>

    <span class="s2">default</span><span class="s1">:</span>
      <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'Wrong number of arguments for Schema.create function'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">schemas </span><span class="s1">= </span><span class="s3">common</span><span class="s1">.</span><span class="s3">toArray</span><span class="s1">(</span><span class="s3">schemas</span><span class="s1">);</span>
  <span class="s3">types </span><span class="s1">= </span><span class="s3">common</span><span class="s1">.</span><span class="s3">toArray</span><span class="s1">(</span><span class="s3">types</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">schemas</span><span class="s1">.</span><span class="s3">every</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">schema</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">schema </span><span class="s2">instanceof </span><span class="s3">Schema</span><span class="s1">; })) {</span>
    <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'Specified list of super schemas (or a single Schema object) contains a non-Schema object.'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">types</span><span class="s1">.</span><span class="s3">every</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">type</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">type </span><span class="s2">instanceof </span><span class="s3">Type</span><span class="s1">; })) {</span>
    <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'Specified list of YAML types (or a single Type object) contains a non-Type object.'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return new </span><span class="s3">Schema</span><span class="s1">({</span>
    <span class="s3">include</span><span class="s1">: </span><span class="s3">schemas</span><span class="s1">,</span>
    <span class="s3">explicit</span><span class="s1">: </span><span class="s3">types</span>
  <span class="s1">});</span>
<span class="s1">};</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s3">Schema</span><span class="s1">;</span>

<span class="s1">},{</span><span class="s4">&quot;./common&quot;</span><span class="s1">:</span><span class="s5">2</span><span class="s1">,</span><span class="s4">&quot;./exception&quot;</span><span class="s1">:</span><span class="s5">4</span><span class="s1">,</span><span class="s4">&quot;./type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">8</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s0">// Standard YAML's Core schema.</span>
<span class="s0">// http://www.yaml.org/spec/1.2/spec.html#id2804923</span>
<span class="s0">//</span>
<span class="s0">// NOTE: JS-YAML does not support schema-specific tag resolution restrictions.</span>
<span class="s0">// So, Core schema has no distinctions from JSON schema is JS-YAML.</span>


<span class="s4">'use strict'</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">Schema </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../schema'</span><span class="s1">);</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Schema</span><span class="s1">({</span>
  <span class="s3">include</span><span class="s1">: [</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'./json'</span><span class="s1">)</span>
  <span class="s1">]</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../schema&quot;</span><span class="s1">:</span><span class="s5">7</span><span class="s1">,</span><span class="s4">&quot;./json&quot;</span><span class="s1">:</span><span class="s5">12</span><span class="s1">}],</span><span class="s5">9</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s0">// JS-YAML's default schema for `load` function.</span>
<span class="s0">// It is not described in the YAML specification.</span>
<span class="s0">//</span>
<span class="s0">// This schema is based on JS-YAML's default safe schema and includes</span>
<span class="s0">// JavaScript-specific types: !!js/undefined, !!js/regexp and !!js/function.</span>
<span class="s0">//</span>
<span class="s0">// Also this schema is used as default base schema at `Schema.create` function.</span>


<span class="s4">'use strict'</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">Schema </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../schema'</span><span class="s1">);</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s3">Schema</span><span class="s1">.</span><span class="s3">DEFAULT </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Schema</span><span class="s1">({</span>
  <span class="s3">include</span><span class="s1">: [</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'./default_safe'</span><span class="s1">)</span>
  <span class="s1">],</span>
  <span class="s3">explicit</span><span class="s1">: [</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/js/undefined'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/js/regexp'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/js/function'</span><span class="s1">)</span>
  <span class="s1">]</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../schema&quot;</span><span class="s1">:</span><span class="s5">7</span><span class="s1">,</span><span class="s4">&quot;../type/js/function&quot;</span><span class="s1">:</span><span class="s5">18</span><span class="s1">,</span><span class="s4">&quot;../type/js/regexp&quot;</span><span class="s1">:</span><span class="s5">19</span><span class="s1">,</span><span class="s4">&quot;../type/js/undefined&quot;</span><span class="s1">:</span><span class="s5">20</span><span class="s1">,</span><span class="s4">&quot;./default_safe&quot;</span><span class="s1">:</span><span class="s5">10</span><span class="s1">}],</span><span class="s5">10</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s0">// JS-YAML's default schema for `safeLoad` function.</span>
<span class="s0">// It is not described in the YAML specification.</span>
<span class="s0">//</span>
<span class="s0">// This schema is based on standard YAML's Core schema and includes most of</span>
<span class="s0">// extra types described at YAML tag repository. (http://yaml.org/type/)</span>


<span class="s4">'use strict'</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">Schema </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../schema'</span><span class="s1">);</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Schema</span><span class="s1">({</span>
  <span class="s3">include</span><span class="s1">: [</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'./core'</span><span class="s1">)</span>
  <span class="s1">],</span>
  <span class="s3">implicit</span><span class="s1">: [</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/timestamp'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/merge'</span><span class="s1">)</span>
  <span class="s1">],</span>
  <span class="s3">explicit</span><span class="s1">: [</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/binary'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/omap'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/pairs'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/set'</span><span class="s1">)</span>
  <span class="s1">]</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../schema&quot;</span><span class="s1">:</span><span class="s5">7</span><span class="s1">,</span><span class="s4">&quot;../type/binary&quot;</span><span class="s1">:</span><span class="s5">14</span><span class="s1">,</span><span class="s4">&quot;../type/merge&quot;</span><span class="s1">:</span><span class="s5">22</span><span class="s1">,</span><span class="s4">&quot;../type/omap&quot;</span><span class="s1">:</span><span class="s5">24</span><span class="s1">,</span><span class="s4">&quot;../type/pairs&quot;</span><span class="s1">:</span><span class="s5">25</span><span class="s1">,</span><span class="s4">&quot;../type/set&quot;</span><span class="s1">:</span><span class="s5">27</span><span class="s1">,</span><span class="s4">&quot;../type/timestamp&quot;</span><span class="s1">:</span><span class="s5">29</span><span class="s1">,</span><span class="s4">&quot;./core&quot;</span><span class="s1">:</span><span class="s5">8</span><span class="s1">}],</span><span class="s5">11</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s0">// Standard YAML's Failsafe schema.</span>
<span class="s0">// http://www.yaml.org/spec/1.2/spec.html#id2802346</span>


<span class="s4">'use strict'</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">Schema </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../schema'</span><span class="s1">);</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Schema</span><span class="s1">({</span>
  <span class="s3">explicit</span><span class="s1">: [</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/str'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/seq'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/map'</span><span class="s1">)</span>
  <span class="s1">]</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../schema&quot;</span><span class="s1">:</span><span class="s5">7</span><span class="s1">,</span><span class="s4">&quot;../type/map&quot;</span><span class="s1">:</span><span class="s5">21</span><span class="s1">,</span><span class="s4">&quot;../type/seq&quot;</span><span class="s1">:</span><span class="s5">26</span><span class="s1">,</span><span class="s4">&quot;../type/str&quot;</span><span class="s1">:</span><span class="s5">28</span><span class="s1">}],</span><span class="s5">12</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s0">// Standard YAML's JSON schema.</span>
<span class="s0">// http://www.yaml.org/spec/1.2/spec.html#id2803231</span>
<span class="s0">//</span>
<span class="s0">// NOTE: JS-YAML does not support schema-specific tag resolution restrictions.</span>
<span class="s0">// So, this schema is not such strict as defined in the YAML specification.</span>
<span class="s0">// It allows numbers in binary notaion, use `Null` and `NULL` as `null`, etc.</span>


<span class="s4">'use strict'</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">Schema </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../schema'</span><span class="s1">);</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Schema</span><span class="s1">({</span>
  <span class="s3">include</span><span class="s1">: [</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'./failsafe'</span><span class="s1">)</span>
  <span class="s1">],</span>
  <span class="s3">implicit</span><span class="s1">: [</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/null'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/bool'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/int'</span><span class="s1">),</span>
    <span class="s3">require</span><span class="s1">(</span><span class="s4">'../type/float'</span><span class="s1">)</span>
  <span class="s1">]</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../schema&quot;</span><span class="s1">:</span><span class="s5">7</span><span class="s1">,</span><span class="s4">&quot;../type/bool&quot;</span><span class="s1">:</span><span class="s5">15</span><span class="s1">,</span><span class="s4">&quot;../type/float&quot;</span><span class="s1">:</span><span class="s5">16</span><span class="s1">,</span><span class="s4">&quot;../type/int&quot;</span><span class="s1">:</span><span class="s5">17</span><span class="s1">,</span><span class="s4">&quot;../type/null&quot;</span><span class="s1">:</span><span class="s5">23</span><span class="s1">,</span><span class="s4">&quot;./failsafe&quot;</span><span class="s1">:</span><span class="s5">11</span><span class="s1">}],</span><span class="s5">13</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">YAMLException </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./exception'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s3">TYPE_CONSTRUCTOR_OPTIONS </span><span class="s1">= [</span>
  <span class="s4">'kind'</span><span class="s1">,</span>
  <span class="s4">'resolve'</span><span class="s1">,</span>
  <span class="s4">'construct'</span><span class="s1">,</span>
  <span class="s4">'instanceOf'</span><span class="s1">,</span>
  <span class="s4">'predicate'</span><span class="s1">,</span>
  <span class="s4">'represent'</span><span class="s1">,</span>
  <span class="s4">'defaultStyle'</span><span class="s1">,</span>
  <span class="s4">'styleAliases'</span>
<span class="s1">];</span>

<span class="s2">var </span><span class="s3">YAML_NODE_KINDS </span><span class="s1">= [</span>
  <span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s4">'sequence'</span><span class="s1">,</span>
  <span class="s4">'mapping'</span>
<span class="s1">];</span>

<span class="s2">function </span><span class="s3">compileStyleAliases</span><span class="s1">(</span><span class="s3">map</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">result </span><span class="s1">= {};</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">map </span><span class="s1">!== </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">map</span><span class="s1">).</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">style</span><span class="s1">) {</span>
      <span class="s3">map</span><span class="s1">[</span><span class="s3">style</span><span class="s1">].</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">alias</span><span class="s1">) {</span>
        <span class="s3">result</span><span class="s1">[</span><span class="s3">String</span><span class="s1">(</span><span class="s3">alias</span><span class="s1">)] = </span><span class="s3">style</span><span class="s1">;</span>
      <span class="s1">});</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">Type</span><span class="s1">(</span><span class="s3">tag</span><span class="s1">, </span><span class="s3">options</span><span class="s1">) {</span>
  <span class="s3">options </span><span class="s1">= </span><span class="s3">options </span><span class="s1">|| {};</span>

  <span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">options</span><span class="s1">).</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">name</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">TYPE_CONSTRUCTOR_OPTIONS</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">name</span><span class="s1">) === -</span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'Unknown option &quot;' </span><span class="s1">+ </span><span class="s3">name </span><span class="s1">+ </span><span class="s4">'&quot; is met in definition of &quot;' </span><span class="s1">+ </span><span class="s3">tag </span><span class="s1">+ </span><span class="s4">'&quot; YAML type.'</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>

  <span class="s0">// TODO: Add tag format check.</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">tag          </span><span class="s1">= </span><span class="s3">tag</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">kind         </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'kind'</span><span class="s1">]         || </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">resolve      </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'resolve'</span><span class="s1">]      || </span><span class="s2">function </span><span class="s1">() { </span><span class="s2">return true</span><span class="s1">; };</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">construct    </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'construct'</span><span class="s1">]    || </span><span class="s2">function </span><span class="s1">(</span><span class="s3">data</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">data</span><span class="s1">; };</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">instanceOf   </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'instanceOf'</span><span class="s1">]   || </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">predicate    </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'predicate'</span><span class="s1">]    || </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">represent    </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'represent'</span><span class="s1">]    || </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">defaultStyle </span><span class="s1">= </span><span class="s3">options</span><span class="s1">[</span><span class="s4">'defaultStyle'</span><span class="s1">] || </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s2">this</span><span class="s1">.</span><span class="s3">styleAliases </span><span class="s1">= </span><span class="s3">compileStyleAliases</span><span class="s1">(</span><span class="s3">options</span><span class="s1">[</span><span class="s4">'styleAliases'</span><span class="s1">] || </span><span class="s2">null</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">YAML_NODE_KINDS</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s3">kind</span><span class="s1">) === -</span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s2">throw new </span><span class="s3">YAMLException</span><span class="s1">(</span><span class="s4">'Unknown kind &quot;' </span><span class="s1">+ </span><span class="s2">this</span><span class="s1">.</span><span class="s3">kind </span><span class="s1">+ </span><span class="s4">'&quot; is specified for &quot;' </span><span class="s1">+ </span><span class="s3">tag </span><span class="s1">+ </span><span class="s4">'&quot; YAML type.'</span><span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s3">Type</span><span class="s1">;</span>

<span class="s1">},{</span><span class="s4">&quot;./exception&quot;</span><span class="s1">:</span><span class="s5">4</span><span class="s1">}],</span><span class="s5">14</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s0">/*eslint-disable no-bitwise*/</span>

<span class="s2">var </span><span class="s3">NodeBuffer</span><span class="s1">;</span>

<span class="s2">try </span><span class="s1">{</span>
  <span class="s0">// A trick for browserified version, to not include `Buffer` shim</span>
  <span class="s2">var </span><span class="s3">_require </span><span class="s1">= </span><span class="s3">require</span><span class="s1">;</span>
  <span class="s3">NodeBuffer </span><span class="s1">= </span><span class="s3">_require</span><span class="s1">(</span><span class="s4">'buffer'</span><span class="s1">).</span><span class="s3">Buffer</span><span class="s1">;</span>
<span class="s1">} </span><span class="s2">catch </span><span class="s1">(</span><span class="s3">__</span><span class="s1">) {}</span>

<span class="s2">var </span><span class="s3">Type       </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>


<span class="s0">// [ 64, 65, 66 ] -&gt; [ padding, CR, LF ]</span>
<span class="s2">var </span><span class="s3">BASE64_MAP </span><span class="s1">= </span><span class="s4">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=</span><span class="s2">\n\r</span><span class="s4">'</span><span class="s1">;</span>


<span class="s2">function </span><span class="s3">resolveYamlBinary</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s2">var </span><span class="s3">code</span><span class="s1">, </span><span class="s3">idx</span><span class="s1">, </span><span class="s3">bitlen </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">max </span><span class="s1">= </span><span class="s3">data</span><span class="s1">.</span><span class="s3">length</span><span class="s1">, </span><span class="s3">map </span><span class="s1">= </span><span class="s3">BASE64_MAP</span><span class="s1">;</span>

  <span class="s0">// Convert one by one.</span>
  <span class="s2">for </span><span class="s1">(</span><span class="s3">idx </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s3">idx </span><span class="s1">&lt; </span><span class="s3">max</span><span class="s1">; </span><span class="s3">idx</span><span class="s1">++) {</span>
    <span class="s3">code </span><span class="s1">= </span><span class="s3">map</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">data</span><span class="s1">.</span><span class="s3">charAt</span><span class="s1">(</span><span class="s3">idx</span><span class="s1">));</span>

    <span class="s0">// Skip CR/LF</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">code </span><span class="s1">&gt; </span><span class="s5">64</span><span class="s1">) </span><span class="s2">continue</span><span class="s1">;</span>

    <span class="s0">// Fail on illegal characters</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">code </span><span class="s1">&lt; </span><span class="s5">0</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

    <span class="s3">bitlen </span><span class="s1">+= </span><span class="s5">6</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">// If there are any bits left, source was corrupted</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s3">bitlen </span><span class="s1">% </span><span class="s5">8</span><span class="s1">) === </span><span class="s5">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructYamlBinary</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">idx</span><span class="s1">, </span><span class="s3">tailbits</span><span class="s1">,</span>
      <span class="s3">input </span><span class="s1">= </span><span class="s3">data</span><span class="s1">.</span><span class="s3">replace</span><span class="s1">(</span><span class="s6">/[\r\n=]/g</span><span class="s1">, </span><span class="s4">''</span><span class="s1">), </span><span class="s0">// remove CR/LF &amp; padding to simplify scan</span>
      <span class="s3">max </span><span class="s1">= </span><span class="s3">input</span><span class="s1">.</span><span class="s3">length</span><span class="s1">,</span>
      <span class="s3">map </span><span class="s1">= </span><span class="s3">BASE64_MAP</span><span class="s1">,</span>
      <span class="s3">bits </span><span class="s1">= </span><span class="s5">0</span><span class="s1">,</span>
      <span class="s3">result </span><span class="s1">= [];</span>

  <span class="s0">// Collect by 6*4 bits (3 bytes)</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">idx </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s3">idx </span><span class="s1">&lt; </span><span class="s3">max</span><span class="s1">; </span><span class="s3">idx</span><span class="s1">++) {</span>
    <span class="s2">if </span><span class="s1">((</span><span class="s3">idx </span><span class="s1">% </span><span class="s5">4 </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) &amp;&amp; </span><span class="s3">idx</span><span class="s1">) {</span>
      <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">((</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">16</span><span class="s1">) &amp; </span><span class="s5">0xFF</span><span class="s1">);</span>
      <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">((</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">8</span><span class="s1">) &amp; </span><span class="s5">0xFF</span><span class="s1">);</span>
      <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">bits </span><span class="s1">&amp; </span><span class="s5">0xFF</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">bits </span><span class="s1">= (</span><span class="s3">bits </span><span class="s1">&lt;&lt; </span><span class="s5">6</span><span class="s1">) | </span><span class="s3">map</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">input</span><span class="s1">.</span><span class="s3">charAt</span><span class="s1">(</span><span class="s3">idx</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s0">// Dump tail</span>

  <span class="s3">tailbits </span><span class="s1">= (</span><span class="s3">max </span><span class="s1">% </span><span class="s5">4</span><span class="s1">) * </span><span class="s5">6</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">tailbits </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">((</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">16</span><span class="s1">) &amp; </span><span class="s5">0xFF</span><span class="s1">);</span>
    <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">((</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">8</span><span class="s1">) &amp; </span><span class="s5">0xFF</span><span class="s1">);</span>
    <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">bits </span><span class="s1">&amp; </span><span class="s5">0xFF</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">tailbits </span><span class="s1">=== </span><span class="s5">18</span><span class="s1">) {</span>
    <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">((</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">10</span><span class="s1">) &amp; </span><span class="s5">0xFF</span><span class="s1">);</span>
    <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">((</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">2</span><span class="s1">) &amp; </span><span class="s5">0xFF</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">tailbits </span><span class="s1">=== </span><span class="s5">12</span><span class="s1">) {</span>
    <span class="s3">result</span><span class="s1">.</span><span class="s3">push</span><span class="s1">((</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">4</span><span class="s1">) &amp; </span><span class="s5">0xFF</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">// Wrap into Buffer for NodeJS and leave Array for browser</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">NodeBuffer</span><span class="s1">) {</span>
    <span class="s0">// Support node 6.+ Buffer API when available</span>
    <span class="s2">return </span><span class="s3">NodeBuffer</span><span class="s1">.</span><span class="s3">from </span><span class="s1">? </span><span class="s3">NodeBuffer</span><span class="s1">.</span><span class="s3">from</span><span class="s1">(</span><span class="s3">result</span><span class="s1">) : </span><span class="s2">new </span><span class="s3">NodeBuffer</span><span class="s1">(</span><span class="s3">result</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">representYamlBinary</span><span class="s1">(</span><span class="s3">object </span><span class="s0">/*, style*/</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">result </span><span class="s1">= </span><span class="s4">''</span><span class="s1">, </span><span class="s3">bits </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">idx</span><span class="s1">, </span><span class="s3">tail</span><span class="s1">,</span>
      <span class="s3">max </span><span class="s1">= </span><span class="s3">object</span><span class="s1">.</span><span class="s3">length</span><span class="s1">,</span>
      <span class="s3">map </span><span class="s1">= </span><span class="s3">BASE64_MAP</span><span class="s1">;</span>

  <span class="s0">// Convert every three bytes to 4 ASCII characters.</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">idx </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s3">idx </span><span class="s1">&lt; </span><span class="s3">max</span><span class="s1">; </span><span class="s3">idx</span><span class="s1">++) {</span>
    <span class="s2">if </span><span class="s1">((</span><span class="s3">idx </span><span class="s1">% </span><span class="s5">3 </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) &amp;&amp; </span><span class="s3">idx</span><span class="s1">) {</span>
      <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">18</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
      <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">12</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
      <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">6</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
      <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[</span><span class="s3">bits </span><span class="s1">&amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s3">bits </span><span class="s1">= (</span><span class="s3">bits </span><span class="s1">&lt;&lt; </span><span class="s5">8</span><span class="s1">) + </span><span class="s3">object</span><span class="s1">[</span><span class="s3">idx</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s0">// Dump tail</span>

  <span class="s3">tail </span><span class="s1">= </span><span class="s3">max </span><span class="s1">% </span><span class="s5">3</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">tail </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">18</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">12</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">6</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[</span><span class="s3">bits </span><span class="s1">&amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">tail </span><span class="s1">=== </span><span class="s5">2</span><span class="s1">) {</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">10</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">4</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&lt;&lt; </span><span class="s5">2</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[</span><span class="s5">64</span><span class="s1">];</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">tail </span><span class="s1">=== </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&gt;&gt; </span><span class="s5">2</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[(</span><span class="s3">bits </span><span class="s1">&lt;&lt; </span><span class="s5">4</span><span class="s1">) &amp; </span><span class="s5">0x3F</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[</span><span class="s5">64</span><span class="s1">];</span>
    <span class="s3">result </span><span class="s1">+= </span><span class="s3">map</span><span class="s1">[</span><span class="s5">64</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isBinary</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">NodeBuffer </span><span class="s1">&amp;&amp; </span><span class="s3">NodeBuffer</span><span class="s1">.</span><span class="s3">isBuffer</span><span class="s1">(</span><span class="s3">object</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:binary'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlBinary</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructYamlBinary</span><span class="s1">,</span>
  <span class="s3">predicate</span><span class="s1">: </span><span class="s3">isBinary</span><span class="s1">,</span>
  <span class="s3">represent</span><span class="s1">: </span><span class="s3">representYamlBinary</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">15</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s2">function </span><span class="s3">resolveYamlBoolean</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s2">var </span><span class="s3">max </span><span class="s1">= </span><span class="s3">data</span><span class="s1">.</span><span class="s3">length</span><span class="s1">;</span>

  <span class="s2">return </span><span class="s1">(</span><span class="s3">max </span><span class="s1">=== </span><span class="s5">4 </span><span class="s1">&amp;&amp; (</span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'true' </span><span class="s1">|| </span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'True' </span><span class="s1">|| </span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'TRUE'</span><span class="s1">)) ||</span>
         <span class="s1">(</span><span class="s3">max </span><span class="s1">=== </span><span class="s5">5 </span><span class="s1">&amp;&amp; (</span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'false' </span><span class="s1">|| </span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'False' </span><span class="s1">|| </span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'FALSE'</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructYamlBoolean</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'true' </span><span class="s1">||</span>
         <span class="s3">data </span><span class="s1">=== </span><span class="s4">'True' </span><span class="s1">||</span>
         <span class="s3">data </span><span class="s1">=== </span><span class="s4">'TRUE'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isBoolean</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) === </span><span class="s4">'[object Boolean]'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:bool'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlBoolean</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructYamlBoolean</span><span class="s1">,</span>
  <span class="s3">predicate</span><span class="s1">: </span><span class="s3">isBoolean</span><span class="s1">,</span>
  <span class="s3">represent</span><span class="s1">: {</span>
    <span class="s3">lowercase</span><span class="s1">: </span><span class="s2">function </span><span class="s1">(</span><span class="s3">object</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">object </span><span class="s1">? </span><span class="s4">'true' </span><span class="s1">: </span><span class="s4">'false'</span><span class="s1">; },</span>
    <span class="s3">uppercase</span><span class="s1">: </span><span class="s2">function </span><span class="s1">(</span><span class="s3">object</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">object </span><span class="s1">? </span><span class="s4">'TRUE' </span><span class="s1">: </span><span class="s4">'FALSE'</span><span class="s1">; },</span>
    <span class="s3">camelcase</span><span class="s1">: </span><span class="s2">function </span><span class="s1">(</span><span class="s3">object</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">object </span><span class="s1">? </span><span class="s4">'True' </span><span class="s1">: </span><span class="s4">'False'</span><span class="s1">; }</span>
  <span class="s1">},</span>
  <span class="s3">defaultStyle</span><span class="s1">: </span><span class="s4">'lowercase'</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">16</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">common </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../common'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">Type   </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s3">YAML_FLOAT_PATTERN </span><span class="s1">= </span><span class="s2">new </span><span class="s3">RegExp</span><span class="s1">(</span>
  <span class="s0">// 2.5e4, 2.5 and integers</span>
  <span class="s4">'^(?:[-+]?(?:0|[1-9][0-9_]*)(?:</span><span class="s2">\\</span><span class="s4">.[0-9_]*)?(?:[eE][-+]?[0-9]+)?' </span><span class="s1">+</span>
  <span class="s0">// .2e4, .2</span>
  <span class="s0">// special case, seems not from spec</span>
  <span class="s4">'|</span><span class="s2">\\</span><span class="s4">.[0-9_]+(?:[eE][-+]?[0-9]+)?' </span><span class="s1">+</span>
  <span class="s0">// 20:59</span>
  <span class="s4">'|[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+</span><span class="s2">\\</span><span class="s4">.[0-9_]*' </span><span class="s1">+</span>
  <span class="s0">// .inf</span>
  <span class="s4">'|[-+]?</span><span class="s2">\\</span><span class="s4">.(?:inf|Inf|INF)' </span><span class="s1">+</span>
  <span class="s0">// .nan</span>
  <span class="s4">'|</span><span class="s2">\\</span><span class="s4">.(?:nan|NaN|NAN))$'</span><span class="s1">);</span>

<span class="s2">function </span><span class="s3">resolveYamlFloat</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">YAML_FLOAT_PATTERN</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) ||</span>
      <span class="s0">// Quick hack to not allow integers end with `_`</span>
      <span class="s0">// Probably should update regexp &amp; check speed</span>
      <span class="s3">data</span><span class="s1">[</span><span class="s3">data</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">] === </span><span class="s4">'_'</span><span class="s1">) {</span>
    <span class="s2">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructYamlFloat</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">value</span><span class="s1">, </span><span class="s3">sign</span><span class="s1">, </span><span class="s3">base</span><span class="s1">, </span><span class="s3">digits</span><span class="s1">;</span>

  <span class="s3">value  </span><span class="s1">= </span><span class="s3">data</span><span class="s1">.</span><span class="s3">replace</span><span class="s1">(</span><span class="s6">/_/g</span><span class="s1">, </span><span class="s4">''</span><span class="s1">).</span><span class="s3">toLowerCase</span><span class="s1">();</span>
  <span class="s3">sign   </span><span class="s1">= </span><span class="s3">value</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s4">'-' </span><span class="s1">? -</span><span class="s5">1 </span><span class="s1">: </span><span class="s5">1</span><span class="s1">;</span>
  <span class="s3">digits </span><span class="s1">= [];</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s4">'+-'</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">value</span><span class="s1">[</span><span class="s5">0</span><span class="s1">]) &gt;= </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">value </span><span class="s1">= </span><span class="s3">value</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">1</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">value </span><span class="s1">=== </span><span class="s4">'.inf'</span><span class="s1">) {</span>
    <span class="s2">return </span><span class="s1">(</span><span class="s3">sign </span><span class="s1">=== </span><span class="s5">1</span><span class="s1">) ? </span><span class="s3">Number</span><span class="s1">.</span><span class="s3">POSITIVE_INFINITY </span><span class="s1">: </span><span class="s3">Number</span><span class="s1">.</span><span class="s3">NEGATIVE_INFINITY</span><span class="s1">;</span>

  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">value </span><span class="s1">=== </span><span class="s4">'.nan'</span><span class="s1">) {</span>
    <span class="s2">return </span><span class="s3">NaN</span><span class="s1">;</span>

  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">value</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s4">':'</span><span class="s1">) &gt;= </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">value</span><span class="s1">.</span><span class="s3">split</span><span class="s1">(</span><span class="s4">':'</span><span class="s1">).</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">v</span><span class="s1">) {</span>
      <span class="s3">digits</span><span class="s1">.</span><span class="s3">unshift</span><span class="s1">(</span><span class="s3">parseFloat</span><span class="s1">(</span><span class="s3">v</span><span class="s1">, </span><span class="s5">10</span><span class="s1">));</span>
    <span class="s1">});</span>

    <span class="s3">value </span><span class="s1">= </span><span class="s5">0.0</span><span class="s1">;</span>
    <span class="s3">base </span><span class="s1">= </span><span class="s5">1</span><span class="s1">;</span>

    <span class="s3">digits</span><span class="s1">.</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">d</span><span class="s1">) {</span>
      <span class="s3">value </span><span class="s1">+= </span><span class="s3">d </span><span class="s1">* </span><span class="s3">base</span><span class="s1">;</span>
      <span class="s3">base </span><span class="s1">*= </span><span class="s5">60</span><span class="s1">;</span>
    <span class="s1">});</span>

    <span class="s2">return </span><span class="s3">sign </span><span class="s1">* </span><span class="s3">value</span><span class="s1">;</span>

  <span class="s1">}</span>
  <span class="s2">return </span><span class="s3">sign </span><span class="s1">* </span><span class="s3">parseFloat</span><span class="s1">(</span><span class="s3">value</span><span class="s1">, </span><span class="s5">10</span><span class="s1">);</span>
<span class="s1">}</span>


<span class="s2">var </span><span class="s3">SCIENTIFIC_WITHOUT_DOT </span><span class="s1">= </span><span class="s6">/^[-+]?[0-9]+e/</span><span class="s1">;</span>

<span class="s2">function </span><span class="s3">representYamlFloat</span><span class="s1">(</span><span class="s3">object</span><span class="s1">, </span><span class="s3">style</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">res</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">isNaN</span><span class="s1">(</span><span class="s3">object</span><span class="s1">)) {</span>
    <span class="s2">switch </span><span class="s1">(</span><span class="s3">style</span><span class="s1">) {</span>
      <span class="s2">case </span><span class="s4">'lowercase'</span><span class="s1">: </span><span class="s2">return </span><span class="s4">'.nan'</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s4">'uppercase'</span><span class="s1">: </span><span class="s2">return </span><span class="s4">'.NAN'</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s4">'camelcase'</span><span class="s1">: </span><span class="s2">return </span><span class="s4">'.NaN'</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">Number</span><span class="s1">.</span><span class="s3">POSITIVE_INFINITY </span><span class="s1">=== </span><span class="s3">object</span><span class="s1">) {</span>
    <span class="s2">switch </span><span class="s1">(</span><span class="s3">style</span><span class="s1">) {</span>
      <span class="s2">case </span><span class="s4">'lowercase'</span><span class="s1">: </span><span class="s2">return </span><span class="s4">'.inf'</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s4">'uppercase'</span><span class="s1">: </span><span class="s2">return </span><span class="s4">'.INF'</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s4">'camelcase'</span><span class="s1">: </span><span class="s2">return </span><span class="s4">'.Inf'</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">Number</span><span class="s1">.</span><span class="s3">NEGATIVE_INFINITY </span><span class="s1">=== </span><span class="s3">object</span><span class="s1">) {</span>
    <span class="s2">switch </span><span class="s1">(</span><span class="s3">style</span><span class="s1">) {</span>
      <span class="s2">case </span><span class="s4">'lowercase'</span><span class="s1">: </span><span class="s2">return </span><span class="s4">'-.inf'</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s4">'uppercase'</span><span class="s1">: </span><span class="s2">return </span><span class="s4">'-.INF'</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s4">'camelcase'</span><span class="s1">: </span><span class="s2">return </span><span class="s4">'-.Inf'</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s3">common</span><span class="s1">.</span><span class="s3">isNegativeZero</span><span class="s1">(</span><span class="s3">object</span><span class="s1">)) {</span>
    <span class="s2">return </span><span class="s4">'-0.0'</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">res </span><span class="s1">= </span><span class="s3">object</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">(</span><span class="s5">10</span><span class="s1">);</span>

  <span class="s0">// JS stringifier can build scientific format without dots: 5e-100,</span>
  <span class="s0">// while YAML requres dot: 5.e-100. Fix it with simple hack</span>

  <span class="s2">return </span><span class="s3">SCIENTIFIC_WITHOUT_DOT</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">res</span><span class="s1">) ? </span><span class="s3">res</span><span class="s1">.</span><span class="s3">replace</span><span class="s1">(</span><span class="s4">'e'</span><span class="s1">, </span><span class="s4">'.e'</span><span class="s1">) : </span><span class="s3">res</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isFloat</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) === </span><span class="s4">'[object Number]'</span><span class="s1">) &amp;&amp;</span>
         <span class="s1">(</span><span class="s3">object </span><span class="s1">% </span><span class="s5">1 </span><span class="s1">!== </span><span class="s5">0 </span><span class="s1">|| </span><span class="s3">common</span><span class="s1">.</span><span class="s3">isNegativeZero</span><span class="s1">(</span><span class="s3">object</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:float'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlFloat</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructYamlFloat</span><span class="s1">,</span>
  <span class="s3">predicate</span><span class="s1">: </span><span class="s3">isFloat</span><span class="s1">,</span>
  <span class="s3">represent</span><span class="s1">: </span><span class="s3">representYamlFloat</span><span class="s1">,</span>
  <span class="s3">defaultStyle</span><span class="s1">: </span><span class="s4">'lowercase'</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../common&quot;</span><span class="s1">:</span><span class="s5">2</span><span class="s1">,</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">17</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">common </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../common'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s3">Type   </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s2">function </span><span class="s3">isHexCode</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">((</span><span class="s5">0x30</span><span class="s0">/* 0 */ </span><span class="s1">&lt;= </span><span class="s3">c</span><span class="s1">) &amp;&amp; (</span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x39</span><span class="s0">/* 9 */</span><span class="s1">)) ||</span>
         <span class="s1">((</span><span class="s5">0x41</span><span class="s0">/* A */ </span><span class="s1">&lt;= </span><span class="s3">c</span><span class="s1">) &amp;&amp; (</span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x46</span><span class="s0">/* F */</span><span class="s1">)) ||</span>
         <span class="s1">((</span><span class="s5">0x61</span><span class="s0">/* a */ </span><span class="s1">&lt;= </span><span class="s3">c</span><span class="s1">) &amp;&amp; (</span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x66</span><span class="s0">/* f */</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isOctCode</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">((</span><span class="s5">0x30</span><span class="s0">/* 0 */ </span><span class="s1">&lt;= </span><span class="s3">c</span><span class="s1">) &amp;&amp; (</span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x37</span><span class="s0">/* 7 */</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isDecCode</span><span class="s1">(</span><span class="s3">c</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">((</span><span class="s5">0x30</span><span class="s0">/* 0 */ </span><span class="s1">&lt;= </span><span class="s3">c</span><span class="s1">) &amp;&amp; (</span><span class="s3">c </span><span class="s1">&lt;= </span><span class="s5">0x39</span><span class="s0">/* 9 */</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">resolveYamlInteger</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s2">var </span><span class="s3">max </span><span class="s1">= </span><span class="s3">data</span><span class="s1">.</span><span class="s3">length</span><span class="s1">,</span>
      <span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">,</span>
      <span class="s3">hasDigits </span><span class="s1">= </span><span class="s2">false</span><span class="s1">,</span>
      <span class="s3">ch</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">max</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">data</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>

  <span class="s0">// sign</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'-' </span><span class="s1">|| </span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'+'</span><span class="s1">) {</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">data</span><span class="s1">[++</span><span class="s3">index</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'0'</span><span class="s1">) {</span>
    <span class="s0">// 0</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">index </span><span class="s1">+ </span><span class="s5">1 </span><span class="s1">=== </span><span class="s3">max</span><span class="s1">) </span><span class="s2">return true</span><span class="s1">;</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">data</span><span class="s1">[++</span><span class="s3">index</span><span class="s1">];</span>

    <span class="s0">// base 2, base 8, base 16</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'b'</span><span class="s1">) {</span>
      <span class="s0">// base 2</span>
      <span class="s3">index</span><span class="s1">++;</span>

      <span class="s2">for </span><span class="s1">(; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">max</span><span class="s1">; </span><span class="s3">index</span><span class="s1">++) {</span>
        <span class="s3">ch </span><span class="s1">= </span><span class="s3">data</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'_'</span><span class="s1">) </span><span class="s2">continue</span><span class="s1">;</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s4">'0' </span><span class="s1">&amp;&amp; </span><span class="s3">ch </span><span class="s1">!== </span><span class="s4">'1'</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>
        <span class="s3">hasDigits </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">return </span><span class="s3">hasDigits </span><span class="s1">&amp;&amp; </span><span class="s3">ch </span><span class="s1">!== </span><span class="s4">'_'</span><span class="s1">;</span>
    <span class="s1">}</span>


    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'x'</span><span class="s1">) {</span>
      <span class="s0">// base 16</span>
      <span class="s3">index</span><span class="s1">++;</span>

      <span class="s2">for </span><span class="s1">(; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">max</span><span class="s1">; </span><span class="s3">index</span><span class="s1">++) {</span>
        <span class="s3">ch </span><span class="s1">= </span><span class="s3">data</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'_'</span><span class="s1">) </span><span class="s2">continue</span><span class="s1">;</span>
        <span class="s2">if </span><span class="s1">(!</span><span class="s3">isHexCode</span><span class="s1">(</span><span class="s3">data</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">index</span><span class="s1">))) </span><span class="s2">return false</span><span class="s1">;</span>
        <span class="s3">hasDigits </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">return </span><span class="s3">hasDigits </span><span class="s1">&amp;&amp; </span><span class="s3">ch </span><span class="s1">!== </span><span class="s4">'_'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">// base 8</span>
    <span class="s2">for </span><span class="s1">(; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">max</span><span class="s1">; </span><span class="s3">index</span><span class="s1">++) {</span>
      <span class="s3">ch </span><span class="s1">= </span><span class="s3">data</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'_'</span><span class="s1">) </span><span class="s2">continue</span><span class="s1">;</span>
      <span class="s2">if </span><span class="s1">(!</span><span class="s3">isOctCode</span><span class="s1">(</span><span class="s3">data</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">index</span><span class="s1">))) </span><span class="s2">return false</span><span class="s1">;</span>
      <span class="s3">hasDigits </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s3">hasDigits </span><span class="s1">&amp;&amp; </span><span class="s3">ch </span><span class="s1">!== </span><span class="s4">'_'</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">// base 10 (except 0) or base 60</span>

  <span class="s0">// value should not start with `_`;</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'_'</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">max</span><span class="s1">; </span><span class="s3">index</span><span class="s1">++) {</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">data</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'_'</span><span class="s1">) </span><span class="s2">continue</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">':'</span><span class="s1">) </span><span class="s2">break</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(!</span><span class="s3">isDecCode</span><span class="s1">(</span><span class="s3">data</span><span class="s1">.</span><span class="s3">charCodeAt</span><span class="s1">(</span><span class="s3">index</span><span class="s1">))) {</span>
      <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">hasDigits </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">// Should have digits and should not end with `_`</span>
  <span class="s2">if </span><span class="s1">(!</span><span class="s3">hasDigits </span><span class="s1">|| </span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'_'</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s0">// if !base60 - done;</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">!== </span><span class="s4">':'</span><span class="s1">) </span><span class="s2">return true</span><span class="s1">;</span>

  <span class="s0">// base60 almost not used, no needs to optimize</span>
  <span class="s2">return </span><span class="s6">/^(:[0-5]?[0-9])+$/</span><span class="s1">.</span><span class="s3">test</span><span class="s1">(</span><span class="s3">data</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">index</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructYamlInteger</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">value </span><span class="s1">= </span><span class="s3">data</span><span class="s1">, </span><span class="s3">sign </span><span class="s1">= </span><span class="s5">1</span><span class="s1">, </span><span class="s3">ch</span><span class="s1">, </span><span class="s3">base</span><span class="s1">, </span><span class="s3">digits </span><span class="s1">= [];</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">value</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s4">'_'</span><span class="s1">) !== -</span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">value </span><span class="s1">= </span><span class="s3">value</span><span class="s1">.</span><span class="s3">replace</span><span class="s1">(</span><span class="s6">/_/g</span><span class="s1">, </span><span class="s4">''</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">ch </span><span class="s1">= </span><span class="s3">value</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'-' </span><span class="s1">|| </span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'+'</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'-'</span><span class="s1">) </span><span class="s3">sign </span><span class="s1">= -</span><span class="s5">1</span><span class="s1">;</span>
    <span class="s3">value </span><span class="s1">= </span><span class="s3">value</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">1</span><span class="s1">);</span>
    <span class="s3">ch </span><span class="s1">= </span><span class="s3">value</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">value </span><span class="s1">=== </span><span class="s4">'0'</span><span class="s1">) </span><span class="s2">return </span><span class="s5">0</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ch </span><span class="s1">=== </span><span class="s4">'0'</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">value</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] === </span><span class="s4">'b'</span><span class="s1">) </span><span class="s2">return </span><span class="s3">sign </span><span class="s1">* </span><span class="s3">parseInt</span><span class="s1">(</span><span class="s3">value</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">2</span><span class="s1">), </span><span class="s5">2</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">value</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] === </span><span class="s4">'x'</span><span class="s1">) </span><span class="s2">return </span><span class="s3">sign </span><span class="s1">* </span><span class="s3">parseInt</span><span class="s1">(</span><span class="s3">value</span><span class="s1">, </span><span class="s5">16</span><span class="s1">);</span>
    <span class="s2">return </span><span class="s3">sign </span><span class="s1">* </span><span class="s3">parseInt</span><span class="s1">(</span><span class="s3">value</span><span class="s1">, </span><span class="s5">8</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">value</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s4">':'</span><span class="s1">) !== -</span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">value</span><span class="s1">.</span><span class="s3">split</span><span class="s1">(</span><span class="s4">':'</span><span class="s1">).</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">v</span><span class="s1">) {</span>
      <span class="s3">digits</span><span class="s1">.</span><span class="s3">unshift</span><span class="s1">(</span><span class="s3">parseInt</span><span class="s1">(</span><span class="s3">v</span><span class="s1">, </span><span class="s5">10</span><span class="s1">));</span>
    <span class="s1">});</span>

    <span class="s3">value </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
    <span class="s3">base </span><span class="s1">= </span><span class="s5">1</span><span class="s1">;</span>

    <span class="s3">digits</span><span class="s1">.</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">d</span><span class="s1">) {</span>
      <span class="s3">value </span><span class="s1">+= (</span><span class="s3">d </span><span class="s1">* </span><span class="s3">base</span><span class="s1">);</span>
      <span class="s3">base </span><span class="s1">*= </span><span class="s5">60</span><span class="s1">;</span>
    <span class="s1">});</span>

    <span class="s2">return </span><span class="s3">sign </span><span class="s1">* </span><span class="s3">value</span><span class="s1">;</span>

  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">sign </span><span class="s1">* </span><span class="s3">parseInt</span><span class="s1">(</span><span class="s3">value</span><span class="s1">, </span><span class="s5">10</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isInteger</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s1">(</span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">object</span><span class="s1">)) === </span><span class="s4">'[object Number]' </span><span class="s1">&amp;&amp;</span>
         <span class="s1">(</span><span class="s3">object </span><span class="s1">% </span><span class="s5">1 </span><span class="s1">=== </span><span class="s5">0 </span><span class="s1">&amp;&amp; !</span><span class="s3">common</span><span class="s1">.</span><span class="s3">isNegativeZero</span><span class="s1">(</span><span class="s3">object</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:int'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlInteger</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructYamlInteger</span><span class="s1">,</span>
  <span class="s3">predicate</span><span class="s1">: </span><span class="s3">isInteger</span><span class="s1">,</span>
  <span class="s3">represent</span><span class="s1">: {</span>
    <span class="s3">binary</span><span class="s1">:      </span><span class="s2">function </span><span class="s1">(</span><span class="s3">obj</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">obj </span><span class="s1">&gt;= </span><span class="s5">0 </span><span class="s1">? </span><span class="s4">'0b' </span><span class="s1">+ </span><span class="s3">obj</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">(</span><span class="s5">2</span><span class="s1">) : </span><span class="s4">'-0b' </span><span class="s1">+ </span><span class="s3">obj</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">(</span><span class="s5">2</span><span class="s1">).</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">1</span><span class="s1">); },</span>
    <span class="s3">octal</span><span class="s1">:       </span><span class="s2">function </span><span class="s1">(</span><span class="s3">obj</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">obj </span><span class="s1">&gt;= </span><span class="s5">0 </span><span class="s1">? </span><span class="s4">'0'  </span><span class="s1">+ </span><span class="s3">obj</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">(</span><span class="s5">8</span><span class="s1">) : </span><span class="s4">'-0'  </span><span class="s1">+ </span><span class="s3">obj</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">(</span><span class="s5">8</span><span class="s1">).</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">1</span><span class="s1">); },</span>
    <span class="s3">decimal</span><span class="s1">:     </span><span class="s2">function </span><span class="s1">(</span><span class="s3">obj</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">obj</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">(</span><span class="s5">10</span><span class="s1">); },</span>
    <span class="s0">/* eslint-disable max-len */</span>
    <span class="s3">hexadecimal</span><span class="s1">: </span><span class="s2">function </span><span class="s1">(</span><span class="s3">obj</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">obj </span><span class="s1">&gt;= </span><span class="s5">0 </span><span class="s1">? </span><span class="s4">'0x' </span><span class="s1">+ </span><span class="s3">obj</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">(</span><span class="s5">16</span><span class="s1">).</span><span class="s3">toUpperCase</span><span class="s1">() :  </span><span class="s4">'-0x' </span><span class="s1">+ </span><span class="s3">obj</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">(</span><span class="s5">16</span><span class="s1">).</span><span class="s3">toUpperCase</span><span class="s1">().</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">1</span><span class="s1">); }</span>
  <span class="s1">},</span>
  <span class="s3">defaultStyle</span><span class="s1">: </span><span class="s4">'decimal'</span><span class="s1">,</span>
  <span class="s3">styleAliases</span><span class="s1">: {</span>
    <span class="s3">binary</span><span class="s1">:      [ </span><span class="s5">2</span><span class="s1">,  </span><span class="s4">'bin' </span><span class="s1">],</span>
    <span class="s3">octal</span><span class="s1">:       [ </span><span class="s5">8</span><span class="s1">,  </span><span class="s4">'oct' </span><span class="s1">],</span>
    <span class="s3">decimal</span><span class="s1">:     [ </span><span class="s5">10</span><span class="s1">, </span><span class="s4">'dec' </span><span class="s1">],</span>
    <span class="s3">hexadecimal</span><span class="s1">: [ </span><span class="s5">16</span><span class="s1">, </span><span class="s4">'hex' </span><span class="s1">]</span>
  <span class="s1">}</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../common&quot;</span><span class="s1">:</span><span class="s5">2</span><span class="s1">,</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">18</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">esprima</span><span class="s1">;</span>

<span class="s0">// Browserified version does not have esprima</span>
<span class="s0">//</span>
<span class="s0">// 1. For node.js just require module as deps</span>
<span class="s0">// 2. For browser try to require mudule via external AMD system.</span>
<span class="s0">//    If not found - try to fallback to window.esprima. If not</span>
<span class="s0">//    found too - then fail to parse.</span>
<span class="s0">//</span>
<span class="s2">try </span><span class="s1">{</span>
  <span class="s0">// workaround to exclude package from browserify list.</span>
  <span class="s2">var </span><span class="s3">_require </span><span class="s1">= </span><span class="s3">require</span><span class="s1">;</span>
  <span class="s3">esprima </span><span class="s1">= </span><span class="s3">_require</span><span class="s1">(</span><span class="s4">'esprima'</span><span class="s1">);</span>
<span class="s1">} </span><span class="s2">catch </span><span class="s1">(</span><span class="s3">_</span><span class="s1">) {</span>
  <span class="s0">/* eslint-disable no-redeclare */</span>
  <span class="s0">/* global window */</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">window </span><span class="s1">!== </span><span class="s4">'undefined'</span><span class="s1">) </span><span class="s3">esprima </span><span class="s1">= </span><span class="s3">window</span><span class="s1">.</span><span class="s3">esprima</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../../type'</span><span class="s1">);</span>

<span class="s2">function </span><span class="s3">resolveJavascriptFunction</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s2">try </span><span class="s1">{</span>
    <span class="s2">var </span><span class="s3">source </span><span class="s1">= </span><span class="s4">'(' </span><span class="s1">+ </span><span class="s3">data </span><span class="s1">+ </span><span class="s4">')'</span><span class="s1">,</span>
        <span class="s3">ast    </span><span class="s1">= </span><span class="s3">esprima</span><span class="s1">.</span><span class="s3">parse</span><span class="s1">(</span><span class="s3">source</span><span class="s1">, { </span><span class="s3">range</span><span class="s1">: </span><span class="s2">true </span><span class="s1">});</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">ast</span><span class="s1">.</span><span class="s3">type                    </span><span class="s1">!== </span><span class="s4">'Program'             </span><span class="s1">||</span>
        <span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">.</span><span class="s3">length             </span><span class="s1">!== </span><span class="s5">1                     </span><span class="s1">||</span>
        <span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s3">type            </span><span class="s1">!== </span><span class="s4">'ExpressionStatement' </span><span class="s1">||</span>
        <span class="s1">(</span><span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s3">expression</span><span class="s1">.</span><span class="s3">type </span><span class="s1">!== </span><span class="s4">'ArrowFunctionExpression' </span><span class="s1">&amp;&amp;</span>
          <span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s3">expression</span><span class="s1">.</span><span class="s3">type </span><span class="s1">!== </span><span class="s4">'FunctionExpression'</span><span class="s1">)) {</span>
      <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">return true</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s2">catch </span><span class="s1">(</span><span class="s3">err</span><span class="s1">) {</span>
    <span class="s2">return false</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructJavascriptFunction</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s0">/*jslint evil:true*/</span>

  <span class="s2">var </span><span class="s3">source </span><span class="s1">= </span><span class="s4">'(' </span><span class="s1">+ </span><span class="s3">data </span><span class="s1">+ </span><span class="s4">')'</span><span class="s1">,</span>
      <span class="s3">ast    </span><span class="s1">= </span><span class="s3">esprima</span><span class="s1">.</span><span class="s3">parse</span><span class="s1">(</span><span class="s3">source</span><span class="s1">, { </span><span class="s3">range</span><span class="s1">: </span><span class="s2">true </span><span class="s1">}),</span>
      <span class="s3">params </span><span class="s1">= [],</span>
      <span class="s3">body</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">ast</span><span class="s1">.</span><span class="s3">type                    </span><span class="s1">!== </span><span class="s4">'Program'             </span><span class="s1">||</span>
      <span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">.</span><span class="s3">length             </span><span class="s1">!== </span><span class="s5">1                     </span><span class="s1">||</span>
      <span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s3">type            </span><span class="s1">!== </span><span class="s4">'ExpressionStatement' </span><span class="s1">||</span>
      <span class="s1">(</span><span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s3">expression</span><span class="s1">.</span><span class="s3">type </span><span class="s1">!== </span><span class="s4">'ArrowFunctionExpression' </span><span class="s1">&amp;&amp;</span>
        <span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s3">expression</span><span class="s1">.</span><span class="s3">type </span><span class="s1">!== </span><span class="s4">'FunctionExpression'</span><span class="s1">)) {</span>
    <span class="s2">throw new </span><span class="s3">Error</span><span class="s1">(</span><span class="s4">'Failed to resolve function'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s3">expression</span><span class="s1">.</span><span class="s3">params</span><span class="s1">.</span><span class="s3">forEach</span><span class="s1">(</span><span class="s2">function </span><span class="s1">(</span><span class="s3">param</span><span class="s1">) {</span>
    <span class="s3">params</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">param</span><span class="s1">.</span><span class="s3">name</span><span class="s1">);</span>
  <span class="s1">});</span>

  <span class="s3">body </span><span class="s1">= </span><span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s3">expression</span><span class="s1">.</span><span class="s3">body</span><span class="s1">.</span><span class="s3">range</span><span class="s1">;</span>

  <span class="s0">// Esprima's ranges include the first '{' and the last '}' characters on</span>
  <span class="s0">// function expressions. So cut them out.</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">ast</span><span class="s1">.</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s3">expression</span><span class="s1">.</span><span class="s3">body</span><span class="s1">.</span><span class="s3">type </span><span class="s1">=== </span><span class="s4">'BlockStatement'</span><span class="s1">) {</span>
    <span class="s0">/*eslint-disable no-new-func*/</span>
    <span class="s2">return new </span><span class="s3">Function</span><span class="s1">(</span><span class="s3">params</span><span class="s1">, </span><span class="s3">source</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] + </span><span class="s5">1</span><span class="s1">, </span><span class="s3">body</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] - </span><span class="s5">1</span><span class="s1">));</span>
  <span class="s1">}</span>
  <span class="s0">// ES6 arrow functions can omit the BlockStatement. In that case, just return</span>
  <span class="s0">// the body.</span>
  <span class="s0">/*eslint-disable no-new-func*/</span>
  <span class="s2">return new </span><span class="s3">Function</span><span class="s1">(</span><span class="s3">params</span><span class="s1">, </span><span class="s4">'return ' </span><span class="s1">+ </span><span class="s3">source</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s3">body</span><span class="s1">[</span><span class="s5">0</span><span class="s1">], </span><span class="s3">body</span><span class="s1">[</span><span class="s5">1</span><span class="s1">]));</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">representJavascriptFunction</span><span class="s1">(</span><span class="s3">object </span><span class="s0">/*, style*/</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">object</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">();</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isFunction</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) === </span><span class="s4">'[object Function]'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:js/function'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveJavascriptFunction</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructJavascriptFunction</span><span class="s1">,</span>
  <span class="s3">predicate</span><span class="s1">: </span><span class="s3">isFunction</span><span class="s1">,</span>
  <span class="s3">represent</span><span class="s1">: </span><span class="s3">representJavascriptFunction</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">19</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../../type'</span><span class="s1">);</span>

<span class="s2">function </span><span class="s3">resolveJavascriptRegExp</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data</span><span class="s1">.</span><span class="s3">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

  <span class="s2">var </span><span class="s3">regexp </span><span class="s1">= </span><span class="s3">data</span><span class="s1">,</span>
      <span class="s3">tail   </span><span class="s1">= </span><span class="s6">/\/([gim]*)$/</span><span class="s1">.</span><span class="s3">exec</span><span class="s1">(</span><span class="s3">data</span><span class="s1">),</span>
      <span class="s3">modifiers </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>

  <span class="s0">// if regexp starts with '/' it can have modifiers and must be properly closed</span>
  <span class="s0">// `/foo/gim` - modifiers tail can be maximum 3 chars</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">regexp</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s4">'/'</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">tail</span><span class="s1">) </span><span class="s3">modifiers </span><span class="s1">= </span><span class="s3">tail</span><span class="s1">[</span><span class="s5">1</span><span class="s1">];</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">modifiers</span><span class="s1">.</span><span class="s3">length </span><span class="s1">&gt; </span><span class="s5">3</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>
    <span class="s0">// if expression starts with /, is should be properly terminated</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">regexp</span><span class="s1">[</span><span class="s3">regexp</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s3">modifiers</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">] !== </span><span class="s4">'/'</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructJavascriptRegExp</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">regexp </span><span class="s1">= </span><span class="s3">data</span><span class="s1">,</span>
      <span class="s3">tail   </span><span class="s1">= </span><span class="s6">/\/([gim]*)$/</span><span class="s1">.</span><span class="s3">exec</span><span class="s1">(</span><span class="s3">data</span><span class="s1">),</span>
      <span class="s3">modifiers </span><span class="s1">= </span><span class="s4">''</span><span class="s1">;</span>

  <span class="s0">// `/foo/gim` - tail can be maximum 4 chars</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">regexp</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s4">'/'</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">tail</span><span class="s1">) </span><span class="s3">modifiers </span><span class="s1">= </span><span class="s3">tail</span><span class="s1">[</span><span class="s5">1</span><span class="s1">];</span>
    <span class="s3">regexp </span><span class="s1">= </span><span class="s3">regexp</span><span class="s1">.</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">1</span><span class="s1">, </span><span class="s3">regexp</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s3">modifiers</span><span class="s1">.</span><span class="s3">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">return new </span><span class="s3">RegExp</span><span class="s1">(</span><span class="s3">regexp</span><span class="s1">, </span><span class="s3">modifiers</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">representJavascriptRegExp</span><span class="s1">(</span><span class="s3">object </span><span class="s0">/*, style*/</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">result </span><span class="s1">= </span><span class="s4">'/' </span><span class="s1">+ </span><span class="s3">object</span><span class="s1">.</span><span class="s3">source </span><span class="s1">+ </span><span class="s4">'/'</span><span class="s1">;</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">object</span><span class="s1">.</span><span class="s3">global</span><span class="s1">) </span><span class="s3">result </span><span class="s1">+= </span><span class="s4">'g'</span><span class="s1">;</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">object</span><span class="s1">.</span><span class="s3">multiline</span><span class="s1">) </span><span class="s3">result </span><span class="s1">+= </span><span class="s4">'m'</span><span class="s1">;</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">object</span><span class="s1">.</span><span class="s3">ignoreCase</span><span class="s1">) </span><span class="s3">result </span><span class="s1">+= </span><span class="s4">'i'</span><span class="s1">;</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isRegExp</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) === </span><span class="s4">'[object RegExp]'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:js/regexp'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveJavascriptRegExp</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructJavascriptRegExp</span><span class="s1">,</span>
  <span class="s3">predicate</span><span class="s1">: </span><span class="s3">isRegExp</span><span class="s1">,</span>
  <span class="s3">represent</span><span class="s1">: </span><span class="s3">representJavascriptRegExp</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">20</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../../type'</span><span class="s1">);</span>

<span class="s2">function </span><span class="s3">resolveJavascriptUndefined</span><span class="s1">() {</span>
  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructJavascriptUndefined</span><span class="s1">() {</span>
  <span class="s0">/*eslint-disable no-undefined*/</span>
  <span class="s2">return </span><span class="s3">undefined</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">representJavascriptUndefined</span><span class="s1">() {</span>
  <span class="s2">return </span><span class="s4">''</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isUndefined</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">return typeof </span><span class="s3">object </span><span class="s1">=== </span><span class="s4">'undefined'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:js/undefined'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveJavascriptUndefined</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructJavascriptUndefined</span><span class="s1">,</span>
  <span class="s3">predicate</span><span class="s1">: </span><span class="s3">isUndefined</span><span class="s1">,</span>
  <span class="s3">represent</span><span class="s1">: </span><span class="s3">representJavascriptUndefined</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">21</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:map'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'mapping'</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s2">function </span><span class="s1">(</span><span class="s3">data</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">data </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">? </span><span class="s3">data </span><span class="s1">: {}; }</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">22</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s2">function </span><span class="s3">resolveYamlMerge</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'&lt;&lt;' </span><span class="s1">|| </span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:merge'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlMerge</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">23</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s2">function </span><span class="s3">resolveYamlNull</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return true</span><span class="s1">;</span>

  <span class="s2">var </span><span class="s3">max </span><span class="s1">= </span><span class="s3">data</span><span class="s1">.</span><span class="s3">length</span><span class="s1">;</span>

  <span class="s2">return </span><span class="s1">(</span><span class="s3">max </span><span class="s1">=== </span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'~'</span><span class="s1">) ||</span>
         <span class="s1">(</span><span class="s3">max </span><span class="s1">=== </span><span class="s5">4 </span><span class="s1">&amp;&amp; (</span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'null' </span><span class="s1">|| </span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'Null' </span><span class="s1">|| </span><span class="s3">data </span><span class="s1">=== </span><span class="s4">'NULL'</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructYamlNull</span><span class="s1">() {</span>
  <span class="s2">return null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">isNull</span><span class="s1">(</span><span class="s3">object</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">object </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:null'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlNull</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructYamlNull</span><span class="s1">,</span>
  <span class="s3">predicate</span><span class="s1">: </span><span class="s3">isNull</span><span class="s1">,</span>
  <span class="s3">represent</span><span class="s1">: {</span>
    <span class="s3">canonical</span><span class="s1">: </span><span class="s2">function </span><span class="s1">() { </span><span class="s2">return </span><span class="s4">'~'</span><span class="s1">;    },</span>
    <span class="s3">lowercase</span><span class="s1">: </span><span class="s2">function </span><span class="s1">() { </span><span class="s2">return </span><span class="s4">'null'</span><span class="s1">; },</span>
    <span class="s3">uppercase</span><span class="s1">: </span><span class="s2">function </span><span class="s1">() { </span><span class="s2">return </span><span class="s4">'NULL'</span><span class="s1">; },</span>
    <span class="s3">camelcase</span><span class="s1">: </span><span class="s2">function </span><span class="s1">() { </span><span class="s2">return </span><span class="s4">'Null'</span><span class="s1">; }</span>
  <span class="s1">},</span>
  <span class="s3">defaultStyle</span><span class="s1">: </span><span class="s4">'lowercase'</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">24</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s3">_hasOwnProperty </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">hasOwnProperty</span><span class="s1">;</span>
<span class="s2">var </span><span class="s3">_toString       </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">;</span>

<span class="s2">function </span><span class="s3">resolveYamlOmap</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return true</span><span class="s1">;</span>

  <span class="s2">var </span><span class="s3">objectKeys </span><span class="s1">= [], </span><span class="s3">index</span><span class="s1">, </span><span class="s3">length</span><span class="s1">, </span><span class="s3">pair</span><span class="s1">, </span><span class="s3">pairKey</span><span class="s1">, </span><span class="s3">pairHasKey</span><span class="s1">,</span>
      <span class="s3">object </span><span class="s1">= </span><span class="s3">data</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">object</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">pair </span><span class="s1">= </span><span class="s3">object</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>
    <span class="s3">pairHasKey </span><span class="s1">= </span><span class="s2">false</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">_toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">pair</span><span class="s1">) !== </span><span class="s4">'[object Object]'</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

    <span class="s2">for </span><span class="s1">(</span><span class="s3">pairKey </span><span class="s2">in </span><span class="s3">pair</span><span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">pair</span><span class="s1">, </span><span class="s3">pairKey</span><span class="s1">)) {</span>
        <span class="s2">if </span><span class="s1">(!</span><span class="s3">pairHasKey</span><span class="s1">) </span><span class="s3">pairHasKey </span><span class="s1">= </span><span class="s2">true</span><span class="s1">;</span>
        <span class="s2">else return false</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(!</span><span class="s3">pairHasKey</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">objectKeys</span><span class="s1">.</span><span class="s3">indexOf</span><span class="s1">(</span><span class="s3">pairKey</span><span class="s1">) === -</span><span class="s5">1</span><span class="s1">) </span><span class="s3">objectKeys</span><span class="s1">.</span><span class="s3">push</span><span class="s1">(</span><span class="s3">pairKey</span><span class="s1">);</span>
    <span class="s2">else return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructYamlOmap</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">data </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">? </span><span class="s3">data </span><span class="s1">: [];</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:omap'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'sequence'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlOmap</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructYamlOmap</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">25</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s3">_toString </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">toString</span><span class="s1">;</span>

<span class="s2">function </span><span class="s3">resolveYamlPairs</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return true</span><span class="s1">;</span>

  <span class="s2">var </span><span class="s3">index</span><span class="s1">, </span><span class="s3">length</span><span class="s1">, </span><span class="s3">pair</span><span class="s1">, </span><span class="s3">keys</span><span class="s1">, </span><span class="s3">result</span><span class="s1">,</span>
      <span class="s3">object </span><span class="s1">= </span><span class="s3">data</span><span class="s1">;</span>

  <span class="s3">result </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Array</span><span class="s1">(</span><span class="s3">object</span><span class="s1">.</span><span class="s3">length</span><span class="s1">);</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">object</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">pair </span><span class="s1">= </span><span class="s3">object</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">_toString</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">pair</span><span class="s1">) !== </span><span class="s4">'[object Object]'</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

    <span class="s3">keys </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">pair</span><span class="s1">);</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">keys</span><span class="s1">.</span><span class="s3">length </span><span class="s1">!== </span><span class="s5">1</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>

    <span class="s3">result</span><span class="s1">[</span><span class="s3">index</span><span class="s1">] = [ </span><span class="s3">keys</span><span class="s1">[</span><span class="s5">0</span><span class="s1">], </span><span class="s3">pair</span><span class="s1">[</span><span class="s3">keys</span><span class="s1">[</span><span class="s5">0</span><span class="s1">]] ];</span>
  <span class="s1">}</span>

  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructYamlPairs</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return </span><span class="s1">[];</span>

  <span class="s2">var </span><span class="s3">index</span><span class="s1">, </span><span class="s3">length</span><span class="s1">, </span><span class="s3">pair</span><span class="s1">, </span><span class="s3">keys</span><span class="s1">, </span><span class="s3">result</span><span class="s1">,</span>
      <span class="s3">object </span><span class="s1">= </span><span class="s3">data</span><span class="s1">;</span>

  <span class="s3">result </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Array</span><span class="s1">(</span><span class="s3">object</span><span class="s1">.</span><span class="s3">length</span><span class="s1">);</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">index </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s3">length </span><span class="s1">= </span><span class="s3">object</span><span class="s1">.</span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">&lt; </span><span class="s3">length</span><span class="s1">; </span><span class="s3">index </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s3">pair </span><span class="s1">= </span><span class="s3">object</span><span class="s1">[</span><span class="s3">index</span><span class="s1">];</span>

    <span class="s3">keys </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">keys</span><span class="s1">(</span><span class="s3">pair</span><span class="s1">);</span>

    <span class="s3">result</span><span class="s1">[</span><span class="s3">index</span><span class="s1">] = [ </span><span class="s3">keys</span><span class="s1">[</span><span class="s5">0</span><span class="s1">], </span><span class="s3">pair</span><span class="s1">[</span><span class="s3">keys</span><span class="s1">[</span><span class="s5">0</span><span class="s1">]] ];</span>
  <span class="s1">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:pairs'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'sequence'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlPairs</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructYamlPairs</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">26</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:seq'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'sequence'</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s2">function </span><span class="s1">(</span><span class="s3">data</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">data </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">? </span><span class="s3">data </span><span class="s1">: []; }</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">27</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s3">_hasOwnProperty </span><span class="s1">= </span><span class="s3">Object</span><span class="s1">.</span><span class="s3">prototype</span><span class="s1">.</span><span class="s3">hasOwnProperty</span><span class="s1">;</span>

<span class="s2">function </span><span class="s3">resolveYamlSet</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return true</span><span class="s1">;</span>

  <span class="s2">var </span><span class="s3">key</span><span class="s1">, </span><span class="s3">object </span><span class="s1">= </span><span class="s3">data</span><span class="s1">;</span>

  <span class="s2">for </span><span class="s1">(</span><span class="s3">key </span><span class="s2">in </span><span class="s3">object</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">_hasOwnProperty</span><span class="s1">.</span><span class="s3">call</span><span class="s1">(</span><span class="s3">object</span><span class="s1">, </span><span class="s3">key</span><span class="s1">)) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">object</span><span class="s1">[</span><span class="s3">key</span><span class="s1">] !== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructYamlSet</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">data </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">? </span><span class="s3">data </span><span class="s1">: {};</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:set'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'mapping'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlSet</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructYamlSet</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">28</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:str'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s2">function </span><span class="s1">(</span><span class="s3">data</span><span class="s1">) { </span><span class="s2">return </span><span class="s3">data </span><span class="s1">!== </span><span class="s2">null </span><span class="s1">? </span><span class="s3">data </span><span class="s1">: </span><span class="s4">''</span><span class="s1">; }</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s5">29</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s3">Type </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'../type'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s3">YAML_DATE_REGEXP </span><span class="s1">= </span><span class="s2">new </span><span class="s3">RegExp</span><span class="s1">(</span>
  <span class="s4">'^([0-9][0-9][0-9][0-9])'          </span><span class="s1">+ </span><span class="s0">// [1] year</span>
  <span class="s4">'-([0-9][0-9])'                    </span><span class="s1">+ </span><span class="s0">// [2] month</span>
  <span class="s4">'-([0-9][0-9])$'</span><span class="s1">);                   </span><span class="s0">// [3] day</span>

<span class="s2">var </span><span class="s3">YAML_TIMESTAMP_REGEXP </span><span class="s1">= </span><span class="s2">new </span><span class="s3">RegExp</span><span class="s1">(</span>
  <span class="s4">'^([0-9][0-9][0-9][0-9])'          </span><span class="s1">+ </span><span class="s0">// [1] year</span>
  <span class="s4">'-([0-9][0-9]?)'                   </span><span class="s1">+ </span><span class="s0">// [2] month</span>
  <span class="s4">'-([0-9][0-9]?)'                   </span><span class="s1">+ </span><span class="s0">// [3] day</span>
  <span class="s4">'(?:[Tt]|[ </span><span class="s2">\\</span><span class="s4">t]+)'                 </span><span class="s1">+ </span><span class="s0">// ...</span>
  <span class="s4">'([0-9][0-9]?)'                    </span><span class="s1">+ </span><span class="s0">// [4] hour</span>
  <span class="s4">':([0-9][0-9])'                    </span><span class="s1">+ </span><span class="s0">// [5] minute</span>
  <span class="s4">':([0-9][0-9])'                    </span><span class="s1">+ </span><span class="s0">// [6] second</span>
  <span class="s4">'(?:</span><span class="s2">\\</span><span class="s4">.([0-9]*))?'                 </span><span class="s1">+ </span><span class="s0">// [7] fraction</span>
  <span class="s4">'(?:[ </span><span class="s2">\\</span><span class="s4">t]*(Z|([-+])([0-9][0-9]?)' </span><span class="s1">+ </span><span class="s0">// [8] tz [9] tz_sign [10] tz_hour</span>
  <span class="s4">'(?::([0-9][0-9]))?))?$'</span><span class="s1">);           </span><span class="s0">// [11] tz_minute</span>

<span class="s2">function </span><span class="s3">resolveYamlTimestamp</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">data </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return false</span><span class="s1">;</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">YAML_DATE_REGEXP</span><span class="s1">.</span><span class="s3">exec</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) !== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return true</span><span class="s1">;</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">YAML_TIMESTAMP_REGEXP</span><span class="s1">.</span><span class="s3">exec</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) !== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">return true</span><span class="s1">;</span>
  <span class="s2">return false</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">constructYamlTimestamp</span><span class="s1">(</span><span class="s3">data</span><span class="s1">) {</span>
  <span class="s2">var </span><span class="s3">match</span><span class="s1">, </span><span class="s3">year</span><span class="s1">, </span><span class="s3">month</span><span class="s1">, </span><span class="s3">day</span><span class="s1">, </span><span class="s3">hour</span><span class="s1">, </span><span class="s3">minute</span><span class="s1">, </span><span class="s3">second</span><span class="s1">, </span><span class="s3">fraction </span><span class="s1">= </span><span class="s5">0</span><span class="s1">,</span>
      <span class="s3">delta </span><span class="s1">= </span><span class="s2">null</span><span class="s1">, </span><span class="s3">tz_hour</span><span class="s1">, </span><span class="s3">tz_minute</span><span class="s1">, </span><span class="s3">date</span><span class="s1">;</span>

  <span class="s3">match </span><span class="s1">= </span><span class="s3">YAML_DATE_REGEXP</span><span class="s1">.</span><span class="s3">exec</span><span class="s1">(</span><span class="s3">data</span><span class="s1">);</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">match </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s3">match </span><span class="s1">= </span><span class="s3">YAML_TIMESTAMP_REGEXP</span><span class="s1">.</span><span class="s3">exec</span><span class="s1">(</span><span class="s3">data</span><span class="s1">);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">match </span><span class="s1">=== </span><span class="s2">null</span><span class="s1">) </span><span class="s2">throw new </span><span class="s3">Error</span><span class="s1">(</span><span class="s4">'Date resolve error'</span><span class="s1">);</span>

  <span class="s0">// match: [1] year [2] month [3] day</span>

  <span class="s3">year </span><span class="s1">= +(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">1</span><span class="s1">]);</span>
  <span class="s3">month </span><span class="s1">= +(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">2</span><span class="s1">]) - </span><span class="s5">1</span><span class="s1">; </span><span class="s0">// JS month starts with 0</span>
  <span class="s3">day </span><span class="s1">= +(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">3</span><span class="s1">]);</span>

  <span class="s2">if </span><span class="s1">(!</span><span class="s3">match</span><span class="s1">[</span><span class="s5">4</span><span class="s1">]) { </span><span class="s0">// no hour</span>
    <span class="s2">return new </span><span class="s3">Date</span><span class="s1">(</span><span class="s3">Date</span><span class="s1">.</span><span class="s3">UTC</span><span class="s1">(</span><span class="s3">year</span><span class="s1">, </span><span class="s3">month</span><span class="s1">, </span><span class="s3">day</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s0">// match: [4] hour [5] minute [6] second [7] fraction</span>

  <span class="s3">hour </span><span class="s1">= +(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">4</span><span class="s1">]);</span>
  <span class="s3">minute </span><span class="s1">= +(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">5</span><span class="s1">]);</span>
  <span class="s3">second </span><span class="s1">= +(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">6</span><span class="s1">]);</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">7</span><span class="s1">]) {</span>
    <span class="s3">fraction </span><span class="s1">= </span><span class="s3">match</span><span class="s1">[</span><span class="s5">7</span><span class="s1">].</span><span class="s3">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s5">3</span><span class="s1">);</span>
    <span class="s2">while </span><span class="s1">(</span><span class="s3">fraction</span><span class="s1">.</span><span class="s3">length </span><span class="s1">&lt; </span><span class="s5">3</span><span class="s1">) { </span><span class="s0">// milli-seconds</span>
      <span class="s3">fraction </span><span class="s1">+= </span><span class="s4">'0'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">fraction </span><span class="s1">= +</span><span class="s3">fraction</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">// match: [8] tz [9] tz_sign [10] tz_hour [11] tz_minute</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">9</span><span class="s1">]) {</span>
    <span class="s3">tz_hour </span><span class="s1">= +(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">10</span><span class="s1">]);</span>
    <span class="s3">tz_minute </span><span class="s1">= +(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">11</span><span class="s1">] || </span><span class="s5">0</span><span class="s1">);</span>
    <span class="s3">delta </span><span class="s1">= (</span><span class="s3">tz_hour </span><span class="s1">* </span><span class="s5">60 </span><span class="s1">+ </span><span class="s3">tz_minute</span><span class="s1">) * </span><span class="s5">60000</span><span class="s1">; </span><span class="s0">// delta in mili-seconds</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">match</span><span class="s1">[</span><span class="s5">9</span><span class="s1">] === </span><span class="s4">'-'</span><span class="s1">) </span><span class="s3">delta </span><span class="s1">= -</span><span class="s3">delta</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">date </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Date</span><span class="s1">(</span><span class="s3">Date</span><span class="s1">.</span><span class="s3">UTC</span><span class="s1">(</span><span class="s3">year</span><span class="s1">, </span><span class="s3">month</span><span class="s1">, </span><span class="s3">day</span><span class="s1">, </span><span class="s3">hour</span><span class="s1">, </span><span class="s3">minute</span><span class="s1">, </span><span class="s3">second</span><span class="s1">, </span><span class="s3">fraction</span><span class="s1">));</span>

  <span class="s2">if </span><span class="s1">(</span><span class="s3">delta</span><span class="s1">) </span><span class="s3">date</span><span class="s1">.</span><span class="s3">setTime</span><span class="s1">(</span><span class="s3">date</span><span class="s1">.</span><span class="s3">getTime</span><span class="s1">() - </span><span class="s3">delta</span><span class="s1">);</span>

  <span class="s2">return </span><span class="s3">date</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s3">representYamlTimestamp</span><span class="s1">(</span><span class="s3">object </span><span class="s0">/*, style*/</span><span class="s1">) {</span>
  <span class="s2">return </span><span class="s3">object</span><span class="s1">.</span><span class="s3">toISOString</span><span class="s1">();</span>
<span class="s1">}</span>

<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s2">new </span><span class="s3">Type</span><span class="s1">(</span><span class="s4">'tag:yaml.org,2002:timestamp'</span><span class="s1">, {</span>
  <span class="s3">kind</span><span class="s1">: </span><span class="s4">'scalar'</span><span class="s1">,</span>
  <span class="s3">resolve</span><span class="s1">: </span><span class="s3">resolveYamlTimestamp</span><span class="s1">,</span>
  <span class="s3">construct</span><span class="s1">: </span><span class="s3">constructYamlTimestamp</span><span class="s1">,</span>
  <span class="s3">instanceOf</span><span class="s1">: </span><span class="s3">Date</span><span class="s1">,</span>
  <span class="s3">represent</span><span class="s1">: </span><span class="s3">representYamlTimestamp</span>
<span class="s1">});</span>

<span class="s1">},{</span><span class="s4">&quot;../type&quot;</span><span class="s1">:</span><span class="s5">13</span><span class="s1">}],</span><span class="s4">&quot;/&quot;</span><span class="s1">:[</span><span class="s2">function</span><span class="s1">(</span><span class="s3">require</span><span class="s1">,</span><span class="s3">module</span><span class="s1">,</span><span class="s3">exports</span><span class="s1">){</span>
<span class="s4">'use strict'</span><span class="s1">;</span>


<span class="s2">var </span><span class="s3">yaml </span><span class="s1">= </span><span class="s3">require</span><span class="s1">(</span><span class="s4">'./lib/js-yaml.js'</span><span class="s1">);</span>


<span class="s3">module</span><span class="s1">.</span><span class="s3">exports </span><span class="s1">= </span><span class="s3">yaml</span><span class="s1">;</span>

<span class="s1">},{</span><span class="s4">&quot;./lib/js-yaml.js&quot;</span><span class="s1">:</span><span class="s5">1</span><span class="s1">}]},{},[])(</span><span class="s4">&quot;/&quot;</span><span class="s1">)</span>
<span class="s1">});</span>
</pre>
</body>
</html>