<html>
<head>
<title>magic-string.es.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
magic-string.es.js</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s2">{ </span><span class="s1">encode </span><span class="s2">} </span><span class="s1">from </span><span class="s3">'sourcemap-codec'</span><span class="s2">;</span>

<span class="s0">var </span><span class="s1">BitSet </span><span class="s2">= </span><span class="s0">function </span><span class="s1">BitSet</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">bits </span><span class="s2">= </span><span class="s1">arg </span><span class="s0">instanceof </span><span class="s1">BitSet </span><span class="s2">? </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">bits</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">() : [];</span>
<span class="s2">};</span>

<span class="s1">BitSet</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">add </span><span class="s2">= </span><span class="s0">function </span><span class="s1">add </span><span class="s2">(</span><span class="s1">n</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">bits</span><span class="s2">[</span><span class="s1">n </span><span class="s2">&gt;&gt; </span><span class="s4">5</span><span class="s2">] |= </span><span class="s4">1 </span><span class="s2">&lt;&lt; (</span><span class="s1">n </span><span class="s2">&amp; </span><span class="s4">31</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">BitSet</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">has </span><span class="s2">= </span><span class="s0">function </span><span class="s1">has </span><span class="s2">(</span><span class="s1">n</span><span class="s2">) {</span>
	<span class="s0">return </span><span class="s2">!!(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">bits</span><span class="s2">[</span><span class="s1">n </span><span class="s2">&gt;&gt; </span><span class="s4">5</span><span class="s2">] &amp; (</span><span class="s4">1 </span><span class="s2">&lt;&lt; (</span><span class="s1">n </span><span class="s2">&amp; </span><span class="s4">31</span><span class="s2">)));</span>
<span class="s2">};</span>

<span class="s0">var </span><span class="s1">Chunk </span><span class="s2">= </span><span class="s0">function </span><span class="s1">Chunk</span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">, </span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">start </span><span class="s2">= </span><span class="s1">start</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">end </span><span class="s2">= </span><span class="s1">end</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">original </span><span class="s2">= </span><span class="s1">content</span><span class="s2">;</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">content </span><span class="s2">= </span><span class="s1">content</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">storeName </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">edited </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>

	<span class="s5">// we make these non-enumerable, for sanity while debugging</span>
	<span class="s1">Object</span><span class="s2">.</span><span class="s1">defineProperties</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, {</span>
		<span class="s1">previous</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s0">null </span><span class="s2">},</span>
		<span class="s1">next</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s0">null </span><span class="s2">},</span>
	<span class="s2">});</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">appendLeft </span><span class="s2">= </span><span class="s0">function </span><span class="s1">appendLeft </span><span class="s2">(</span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">+= </span><span class="s1">content</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">appendRight </span><span class="s2">= </span><span class="s0">function </span><span class="s1">appendRight </span><span class="s2">(</span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">+ </span><span class="s1">content</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">clone </span><span class="s2">= </span><span class="s0">function </span><span class="s1">clone </span><span class="s2">() {</span>
	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Chunk</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">start</span><span class="s2">, </span><span class="s0">this</span><span class="s2">.</span><span class="s1">end</span><span class="s2">, </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">);</span>

	<span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">;</span>
	<span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">;</span>
	<span class="s1">chunk</span><span class="s2">.</span><span class="s1">content </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">content</span><span class="s2">;</span>
	<span class="s1">chunk</span><span class="s2">.</span><span class="s1">storeName </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">storeName</span><span class="s2">;</span>
	<span class="s1">chunk</span><span class="s2">.</span><span class="s1">edited </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">edited</span><span class="s2">;</span>

	<span class="s0">return </span><span class="s1">chunk</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">contains </span><span class="s2">= </span><span class="s0">function </span><span class="s1">contains </span><span class="s2">(</span><span class="s1">index</span><span class="s2">) {</span>
	<span class="s0">return this</span><span class="s2">.</span><span class="s1">start </span><span class="s2">&lt; </span><span class="s1">index </span><span class="s2">&amp;&amp; </span><span class="s1">index </span><span class="s2">&lt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">end</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">eachNext </span><span class="s2">= </span><span class="s0">function </span><span class="s1">eachNext </span><span class="s2">(</span><span class="s1">fn</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>
	<span class="s0">while </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s1">fn</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">);</span>
		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
	<span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">eachPrevious </span><span class="s2">= </span><span class="s0">function </span><span class="s1">eachPrevious </span><span class="s2">(</span><span class="s1">fn</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>
	<span class="s0">while </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s1">fn</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">);</span>
		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">;</span>
	<span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">edit </span><span class="s2">= </span><span class="s0">function </span><span class="s1">edit </span><span class="s2">(</span><span class="s1">content</span><span class="s2">, </span><span class="s1">storeName</span><span class="s2">, </span><span class="s1">contentOnly</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">content </span><span class="s2">= </span><span class="s1">content</span><span class="s2">;</span>
	<span class="s0">if </span><span class="s2">(!</span><span class="s1">contentOnly</span><span class="s2">) {</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>
	<span class="s2">}</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">storeName </span><span class="s2">= </span><span class="s1">storeName</span><span class="s2">;</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">edited </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>

	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">prependLeft </span><span class="s2">= </span><span class="s0">function </span><span class="s1">prependLeft </span><span class="s2">(</span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s1">content </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">prependRight </span><span class="s2">= </span><span class="s0">function </span><span class="s1">prependRight </span><span class="s2">(</span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s1">content </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">split </span><span class="s2">= </span><span class="s0">function </span><span class="s1">split </span><span class="s2">(</span><span class="s1">index</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">sliceIndex </span><span class="s2">= </span><span class="s1">index </span><span class="s2">- </span><span class="s0">this</span><span class="s2">.</span><span class="s1">start</span><span class="s2">;</span>

	<span class="s0">var </span><span class="s1">originalBefore </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">sliceIndex</span><span class="s2">);</span>
	<span class="s0">var </span><span class="s1">originalAfter </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">sliceIndex</span><span class="s2">);</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">original </span><span class="s2">= </span><span class="s1">originalBefore</span><span class="s2">;</span>

	<span class="s0">var </span><span class="s1">newChunk </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Chunk</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s0">this</span><span class="s2">.</span><span class="s1">end</span><span class="s2">, </span><span class="s1">originalAfter</span><span class="s2">);</span>
	<span class="s1">newChunk</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">end </span><span class="s2">= </span><span class="s1">index</span><span class="s2">;</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">edited</span><span class="s2">) {</span>
		<span class="s5">// TODO is this block necessary?...</span>
		<span class="s1">newChunk</span><span class="s2">.</span><span class="s1">edit</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s0">false</span><span class="s2">);</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">content </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>
	<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">content </span><span class="s2">= </span><span class="s1">originalBefore</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s1">newChunk</span><span class="s2">.</span><span class="s1">next </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">newChunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">) { </span><span class="s1">newChunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">.</span><span class="s1">previous </span><span class="s2">= </span><span class="s1">newChunk</span><span class="s2">; }</span>
	<span class="s1">newChunk</span><span class="s2">.</span><span class="s1">previous </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">next </span><span class="s2">= </span><span class="s1">newChunk</span><span class="s2">;</span>

	<span class="s0">return </span><span class="s1">newChunk</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">toString </span><span class="s2">= </span><span class="s0">function </span><span class="s1">toString </span><span class="s2">() {</span>
	<span class="s0">return this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">content </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimEnd </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimEnd </span><span class="s2">(</span><span class="s1">rx</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return true</span><span class="s2">; }</span>

	<span class="s0">var </span><span class="s1">trimmed </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">trimmed</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">trimmed </span><span class="s2">!== </span><span class="s0">this</span><span class="s2">.</span><span class="s1">content</span><span class="s2">) {</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">start </span><span class="s2">+ </span><span class="s1">trimmed</span><span class="s2">.</span><span class="s1">length</span><span class="s2">).</span><span class="s1">edit</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s1">undefined</span><span class="s2">, </span><span class="s0">true</span><span class="s2">);</span>
		<span class="s2">}</span>
		<span class="s0">return true</span><span class="s2">;</span>
	<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">edit</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s1">undefined</span><span class="s2">, </span><span class="s0">true</span><span class="s2">);</span>

		<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return true</span><span class="s2">; }</span>
	<span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">Chunk</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimStart </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimStart </span><span class="s2">(</span><span class="s1">rx</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return true</span><span class="s2">; }</span>

	<span class="s0">var </span><span class="s1">trimmed </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">trimmed</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">trimmed </span><span class="s2">!== </span><span class="s0">this</span><span class="s2">.</span><span class="s1">content</span><span class="s2">) {</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">end </span><span class="s2">- </span><span class="s1">trimmed</span><span class="s2">.</span><span class="s1">length</span><span class="s2">);</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">edit</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s1">undefined</span><span class="s2">, </span><span class="s0">true</span><span class="s2">);</span>
		<span class="s2">}</span>
		<span class="s0">return true</span><span class="s2">;</span>
	<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">edit</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s1">undefined</span><span class="s2">, </span><span class="s0">true</span><span class="s2">);</span>

		<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return true</span><span class="s2">; }</span>
	<span class="s2">}</span>
<span class="s2">};</span>

<span class="s0">var </span><span class="s1">btoa </span><span class="s2">= </span><span class="s0">function </span><span class="s2">() {</span>
	<span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'Unsupported environment: `window.btoa` or `Buffer` should be supported.'</span><span class="s2">);</span>
<span class="s2">};</span>
<span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">window </span><span class="s2">!== </span><span class="s3">'undefined' </span><span class="s2">&amp;&amp; </span><span class="s0">typeof </span><span class="s1">window</span><span class="s2">.</span><span class="s1">btoa </span><span class="s2">=== </span><span class="s3">'function'</span><span class="s2">) {</span>
	<span class="s1">btoa </span><span class="s2">= </span><span class="s0">function </span><span class="s2">(</span><span class="s1">str</span><span class="s2">) { </span><span class="s0">return </span><span class="s1">window</span><span class="s2">.</span><span class="s1">btoa</span><span class="s2">(</span><span class="s1">unescape</span><span class="s2">(</span><span class="s1">encodeURIComponent</span><span class="s2">(</span><span class="s1">str</span><span class="s2">))); };</span>
<span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">Buffer </span><span class="s2">=== </span><span class="s3">'function'</span><span class="s2">) {</span>
	<span class="s1">btoa </span><span class="s2">= </span><span class="s0">function </span><span class="s2">(</span><span class="s1">str</span><span class="s2">) { </span><span class="s0">return </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">from</span><span class="s2">(</span><span class="s1">str</span><span class="s2">, </span><span class="s3">'utf-8'</span><span class="s2">).</span><span class="s1">toString</span><span class="s2">(</span><span class="s3">'base64'</span><span class="s2">); };</span>
<span class="s2">}</span>

<span class="s0">var </span><span class="s1">SourceMap </span><span class="s2">= </span><span class="s0">function </span><span class="s1">SourceMap</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s4">3</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">file </span><span class="s2">= </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">file</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">sources </span><span class="s2">= </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">sourcesContent </span><span class="s2">= </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">sourcesContent</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">names </span><span class="s2">= </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">names</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">mappings </span><span class="s2">= </span><span class="s1">encode</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">.</span><span class="s1">mappings</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">SourceMap</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">toString </span><span class="s2">= </span><span class="s0">function </span><span class="s1">toString </span><span class="s2">() {</span>
	<span class="s0">return </span><span class="s1">JSON</span><span class="s2">.</span><span class="s1">stringify</span><span class="s2">(</span><span class="s0">this</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">SourceMap</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">toUrl </span><span class="s2">= </span><span class="s0">function </span><span class="s1">toUrl </span><span class="s2">() {</span>
	<span class="s0">return </span><span class="s3">'data:application/json;charset=utf-8;base64,' </span><span class="s2">+ </span><span class="s1">btoa</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">toString</span><span class="s2">());</span>
<span class="s2">};</span>

<span class="s0">function </span><span class="s1">guessIndent</span><span class="s2">(</span><span class="s1">code</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">lines </span><span class="s2">= </span><span class="s1">code</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">tabbed </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">line</span><span class="s2">) { </span><span class="s0">return </span><span class="s6">/^\t+/</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">line</span><span class="s2">); });</span>
	<span class="s0">var </span><span class="s1">spaced </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">line</span><span class="s2">) { </span><span class="s0">return </span><span class="s6">/^ {2,}/</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">line</span><span class="s2">); });</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">tabbed</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s4">0 </span><span class="s2">&amp;&amp; </span><span class="s1">spaced</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s4">0</span><span class="s2">) {</span>
		<span class="s0">return null</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s5">// More lines tabbed than spaced? Assume tabs, and</span>
	<span class="s5">// default to tabs in the case of a tie (or nothing</span>
	<span class="s5">// to go on)</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">tabbed</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt;= </span><span class="s1">spaced</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
		<span class="s0">return </span><span class="s3">'</span><span class="s0">\t</span><span class="s3">'</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s5">// Otherwise, we need to guess the multiple</span>
	<span class="s0">var </span><span class="s1">min </span><span class="s2">= </span><span class="s1">spaced</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">previous</span><span class="s2">, </span><span class="s1">current</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">numSpaces </span><span class="s2">= </span><span class="s6">/^ +/</span><span class="s2">.</span><span class="s1">exec</span><span class="s2">(</span><span class="s1">current</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">length</span><span class="s2">;</span>
		<span class="s0">return </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">numSpaces</span><span class="s2">, </span><span class="s1">previous</span><span class="s2">);</span>
	<span class="s2">}, </span><span class="s1">Infinity</span><span class="s2">);</span>

	<span class="s0">return new </span><span class="s1">Array</span><span class="s2">(</span><span class="s1">min </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">).</span><span class="s1">join</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">);</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">getRelativePath</span><span class="s2">(</span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">fromParts </span><span class="s2">= </span><span class="s1">from</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">/[/\\]/</span><span class="s2">);</span>
	<span class="s0">var </span><span class="s1">toParts </span><span class="s2">= </span><span class="s1">to</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">/[/\\]/</span><span class="s2">);</span>

	<span class="s1">fromParts</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(); </span><span class="s5">// get dirname</span>

	<span class="s0">while </span><span class="s2">(</span><span class="s1">fromParts</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] === </span><span class="s1">toParts</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]) {</span>
		<span class="s1">fromParts</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">();</span>
		<span class="s1">toParts</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">();</span>
	<span class="s2">}</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">fromParts</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s1">fromParts</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
		<span class="s0">while </span><span class="s2">(</span><span class="s1">i</span><span class="s2">--) { </span><span class="s1">fromParts</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s3">'..'</span><span class="s2">; }</span>
	<span class="s2">}</span>

	<span class="s0">return </span><span class="s1">fromParts</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">toParts</span><span class="s2">).</span><span class="s1">join</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">);</span>
<span class="s2">}</span>

<span class="s0">var </span><span class="s1">toString </span><span class="s2">= </span><span class="s1">Object</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">toString</span><span class="s2">;</span>

<span class="s0">function </span><span class="s1">isObject</span><span class="s2">(</span><span class="s1">thing</span><span class="s2">) {</span>
	<span class="s0">return </span><span class="s1">toString</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">thing</span><span class="s2">) === </span><span class="s3">'[object Object]'</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">getLocator</span><span class="s2">(</span><span class="s1">source</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">originalLines </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">);</span>
	<span class="s0">var </span><span class="s1">lineOffsets </span><span class="s2">= [];</span>

	<span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s1">pos </span><span class="s2">= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">originalLines</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
		<span class="s1">lineOffsets</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">);</span>
		<span class="s1">pos </span><span class="s2">+= </span><span class="s1">originalLines</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">length </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">return function </span><span class="s1">locate</span><span class="s2">(</span><span class="s1">index</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">j </span><span class="s2">= </span><span class="s1">lineOffsets</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
		<span class="s0">while </span><span class="s2">(</span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">j</span><span class="s2">) {</span>
			<span class="s0">var </span><span class="s1">m </span><span class="s2">= (</span><span class="s1">i </span><span class="s2">+ </span><span class="s1">j</span><span class="s2">) &gt;&gt; </span><span class="s4">1</span><span class="s2">;</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">lineOffsets</span><span class="s2">[</span><span class="s1">m</span><span class="s2">]) {</span>
				<span class="s1">j </span><span class="s2">= </span><span class="s1">m</span><span class="s2">;</span>
			<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
				<span class="s1">i </span><span class="s2">= </span><span class="s1">m </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">;</span>
			<span class="s2">}</span>
		<span class="s2">}</span>
		<span class="s0">var </span><span class="s1">line </span><span class="s2">= </span><span class="s1">i </span><span class="s2">- </span><span class="s4">1</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">column </span><span class="s2">= </span><span class="s1">index </span><span class="s2">- </span><span class="s1">lineOffsets</span><span class="s2">[</span><span class="s1">line</span><span class="s2">];</span>
		<span class="s0">return </span><span class="s2">{ </span><span class="s1">line</span><span class="s2">: </span><span class="s1">line</span><span class="s2">, </span><span class="s1">column</span><span class="s2">: </span><span class="s1">column </span><span class="s2">};</span>
	<span class="s2">};</span>
<span class="s2">}</span>

<span class="s0">var </span><span class="s1">Mappings </span><span class="s2">= </span><span class="s0">function </span><span class="s1">Mappings</span><span class="s2">(</span><span class="s1">hires</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">hires </span><span class="s2">= </span><span class="s1">hires</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeLine </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeColumn </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">raw </span><span class="s2">= [];</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">rawSegments </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">raw</span><span class="s2">[</span><span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeLine</span><span class="s2">] = [];</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">pending </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Mappings</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">addEdit </span><span class="s2">= </span><span class="s0">function </span><span class="s1">addEdit </span><span class="s2">(</span><span class="s1">sourceIndex</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">nameIndex</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">segment </span><span class="s2">= [</span><span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeColumn</span><span class="s2">, </span><span class="s1">sourceIndex</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">.</span><span class="s1">column</span><span class="s2">];</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">nameIndex </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">) {</span>
			<span class="s1">segment</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">nameIndex</span><span class="s2">);</span>
		<span class="s2">}</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">rawSegments</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">segment</span><span class="s2">);</span>
	<span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">pending</span><span class="s2">) {</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">rawSegments</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">pending</span><span class="s2">);</span>
	<span class="s2">}</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">content</span><span class="s2">);</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">pending </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Mappings</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">addUneditedChunk </span><span class="s2">= </span><span class="s0">function </span><span class="s1">addUneditedChunk </span><span class="s2">(</span><span class="s1">sourceIndex</span><span class="s2">, </span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">original</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">sourcemapLocations</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">originalCharIndex </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">first </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>

	<span class="s0">while </span><span class="s2">(</span><span class="s1">originalCharIndex </span><span class="s2">&lt; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">hires </span><span class="s2">|| </span><span class="s1">first </span><span class="s2">|| </span><span class="s1">sourcemapLocations</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s1">originalCharIndex</span><span class="s2">)) {</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">rawSegments</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span><span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeColumn</span><span class="s2">, </span><span class="s1">sourceIndex</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">.</span><span class="s1">column</span><span class="s2">]);</span>
		<span class="s2">}</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">original</span><span class="s2">[</span><span class="s1">originalCharIndex</span><span class="s2">] === </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">) {</span>
			<span class="s1">loc</span><span class="s2">.</span><span class="s1">line </span><span class="s2">+= </span><span class="s4">1</span><span class="s2">;</span>
			<span class="s1">loc</span><span class="s2">.</span><span class="s1">column </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeLine </span><span class="s2">+= </span><span class="s4">1</span><span class="s2">;</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">raw</span><span class="s2">[</span><span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeLine</span><span class="s2">] = </span><span class="s0">this</span><span class="s2">.</span><span class="s1">rawSegments </span><span class="s2">= [];</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeColumn </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
			<span class="s1">first </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
		<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
			<span class="s1">loc</span><span class="s2">.</span><span class="s1">column </span><span class="s2">+= </span><span class="s4">1</span><span class="s2">;</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeColumn </span><span class="s2">+= </span><span class="s4">1</span><span class="s2">;</span>
			<span class="s1">first </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s1">originalCharIndex </span><span class="s2">+= </span><span class="s4">1</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">pending </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Mappings</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">advance </span><span class="s2">= </span><span class="s0">function </span><span class="s1">advance </span><span class="s2">(</span><span class="s1">str</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(!</span><span class="s1">str</span><span class="s2">) { </span><span class="s0">return</span><span class="s2">; }</span>

	<span class="s0">var </span><span class="s1">lines </span><span class="s2">= </span><span class="s1">str</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">);</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">lines</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">) {</span>
		<span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">lines</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeLine</span><span class="s2">++;</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">raw</span><span class="s2">[</span><span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeLine</span><span class="s2">] = </span><span class="s0">this</span><span class="s2">.</span><span class="s1">rawSegments </span><span class="s2">= [];</span>
		<span class="s2">}</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeColumn </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">generatedCodeColumn </span><span class="s2">+= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">lines</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">].</span><span class="s1">length</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s0">var </span><span class="s1">n </span><span class="s2">= </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">;</span>

<span class="s0">var </span><span class="s1">warned </span><span class="s2">= {</span>
	<span class="s1">insertLeft</span><span class="s2">: </span><span class="s0">false</span><span class="s2">,</span>
	<span class="s1">insertRight</span><span class="s2">: </span><span class="s0">false</span><span class="s2">,</span>
	<span class="s1">storeName</span><span class="s2">: </span><span class="s0">false</span><span class="s2">,</span>
<span class="s2">};</span>

<span class="s0">var </span><span class="s1">MagicString </span><span class="s2">= </span><span class="s0">function </span><span class="s1">MagicString</span><span class="s2">(</span><span class="s1">string</span><span class="s2">, </span><span class="s1">options</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">( </span><span class="s1">options </span><span class="s2">=== </span><span class="s0">void </span><span class="s4">0 </span><span class="s2">) </span><span class="s1">options </span><span class="s2">= {};</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Chunk</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">string</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">string</span><span class="s2">);</span>

	<span class="s1">Object</span><span class="s2">.</span><span class="s1">defineProperties</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, {</span>
		<span class="s1">original</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s1">string </span><span class="s2">},</span>
		<span class="s1">outro</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s3">'' </span><span class="s2">},</span>
		<span class="s1">intro</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s3">'' </span><span class="s2">},</span>
		<span class="s1">firstChunk</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s1">chunk </span><span class="s2">},</span>
		<span class="s1">lastChunk</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s1">chunk </span><span class="s2">},</span>
		<span class="s1">lastSearchedChunk</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s1">chunk </span><span class="s2">},</span>
		<span class="s1">byStart</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: {} },</span>
		<span class="s1">byEnd</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: {} },</span>
		<span class="s1">filename</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s1">options</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">},</span>
		<span class="s1">indentExclusionRanges</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s1">options</span><span class="s2">.</span><span class="s1">indentExclusionRanges </span><span class="s2">},</span>
		<span class="s1">sourcemapLocations</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s0">new </span><span class="s1">BitSet</span><span class="s2">() },</span>
		<span class="s1">storedNames</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: {} },</span>
		<span class="s1">indentStr</span><span class="s2">: { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s1">guessIndent</span><span class="s2">(</span><span class="s1">string</span><span class="s2">) },</span>
	<span class="s2">});</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">chunk</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">string</span><span class="s2">.</span><span class="s1">length</span><span class="s2">] = </span><span class="s1">chunk</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">addSourcemapLocation </span><span class="s2">= </span><span class="s0">function </span><span class="s1">addSourcemapLocation </span><span class="s2">(</span><span class="s1">char</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">sourcemapLocations</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">char</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">append </span><span class="s2">= </span><span class="s0">function </span><span class="s1">append </span><span class="s2">(</span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">content </span><span class="s2">!== </span><span class="s3">'string'</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'outro content must be a string'</span><span class="s2">); }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">+= </span><span class="s1">content</span><span class="s2">;</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">appendLeft </span><span class="s2">= </span><span class="s0">function </span><span class="s1">appendLeft </span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">content </span><span class="s2">!== </span><span class="s3">'string'</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'inserted content must be a string'</span><span class="s2">); }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">index</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">index</span><span class="s2">];</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s1">chunk</span><span class="s2">.</span><span class="s1">appendLeft</span><span class="s2">(</span><span class="s1">content</span><span class="s2">);</span>
	<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">+= </span><span class="s1">content</span><span class="s2">;</span>
	<span class="s2">}</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">appendRight </span><span class="s2">= </span><span class="s0">function </span><span class="s1">appendRight </span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">content </span><span class="s2">!== </span><span class="s3">'string'</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'inserted content must be a string'</span><span class="s2">); }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">index</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">index</span><span class="s2">];</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s1">chunk</span><span class="s2">.</span><span class="s1">appendRight</span><span class="s2">(</span><span class="s1">content</span><span class="s2">);</span>
	<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">+= </span><span class="s1">content</span><span class="s2">;</span>
	<span class="s2">}</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">clone </span><span class="s2">= </span><span class="s0">function </span><span class="s1">clone </span><span class="s2">() {</span>
	<span class="s0">var </span><span class="s1">cloned </span><span class="s2">= </span><span class="s0">new </span><span class="s1">MagicString</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">, { </span><span class="s1">filename</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">});</span>

	<span class="s0">var </span><span class="s1">originalChunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">clonedChunk </span><span class="s2">= (</span><span class="s1">cloned</span><span class="s2">.</span><span class="s1">firstChunk </span><span class="s2">= </span><span class="s1">cloned</span><span class="s2">.</span><span class="s1">lastSearchedChunk </span><span class="s2">= </span><span class="s1">originalChunk</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">());</span>

	<span class="s0">while </span><span class="s2">(</span><span class="s1">originalChunk</span><span class="s2">) {</span>
		<span class="s1">cloned</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">clonedChunk</span><span class="s2">.</span><span class="s1">start</span><span class="s2">] = </span><span class="s1">clonedChunk</span><span class="s2">;</span>
		<span class="s1">cloned</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">clonedChunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">] = </span><span class="s1">clonedChunk</span><span class="s2">;</span>

		<span class="s0">var </span><span class="s1">nextOriginalChunk </span><span class="s2">= </span><span class="s1">originalChunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">nextClonedChunk </span><span class="s2">= </span><span class="s1">nextOriginalChunk </span><span class="s2">&amp;&amp; </span><span class="s1">nextOriginalChunk</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">();</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">nextClonedChunk</span><span class="s2">) {</span>
			<span class="s1">clonedChunk</span><span class="s2">.</span><span class="s1">next </span><span class="s2">= </span><span class="s1">nextClonedChunk</span><span class="s2">;</span>
			<span class="s1">nextClonedChunk</span><span class="s2">.</span><span class="s1">previous </span><span class="s2">= </span><span class="s1">clonedChunk</span><span class="s2">;</span>

			<span class="s1">clonedChunk </span><span class="s2">= </span><span class="s1">nextClonedChunk</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s1">originalChunk </span><span class="s2">= </span><span class="s1">nextOriginalChunk</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s1">cloned</span><span class="s2">.</span><span class="s1">lastChunk </span><span class="s2">= </span><span class="s1">clonedChunk</span><span class="s2">;</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">indentExclusionRanges</span><span class="s2">) {</span>
		<span class="s1">cloned</span><span class="s2">.</span><span class="s1">indentExclusionRanges </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">indentExclusionRanges</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">();</span>
	<span class="s2">}</span>

	<span class="s1">cloned</span><span class="s2">.</span><span class="s1">sourcemapLocations </span><span class="s2">= </span><span class="s0">new </span><span class="s1">BitSet</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">sourcemapLocations</span><span class="s2">);</span>

	<span class="s1">cloned</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">;</span>
	<span class="s1">cloned</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">;</span>

	<span class="s0">return </span><span class="s1">cloned</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">generateDecodedMap </span><span class="s2">= </span><span class="s0">function </span><span class="s1">generateDecodedMap </span><span class="s2">(</span><span class="s1">options</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">this$1$1 </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>

	<span class="s1">options </span><span class="s2">= </span><span class="s1">options </span><span class="s2">|| {};</span>

	<span class="s0">var </span><span class="s1">sourceIndex </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">names </span><span class="s2">= </span><span class="s1">Object</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">storedNames</span><span class="s2">);</span>
	<span class="s0">var </span><span class="s1">mappings </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Mappings</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">hires</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">locate </span><span class="s2">= </span><span class="s1">getLocator</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">);</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">) {</span>
		<span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">);</span>
	<span class="s2">}</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk</span><span class="s2">.</span><span class="s1">eachNext</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">loc </span><span class="s2">= </span><span class="s1">locate</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start</span><span class="s2">);</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">); }</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">edited</span><span class="s2">) {</span>
			<span class="s1">mappings</span><span class="s2">.</span><span class="s1">addEdit</span><span class="s2">(</span>
				<span class="s1">sourceIndex</span><span class="s2">,</span>
				<span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">,</span>
				<span class="s1">loc</span><span class="s2">,</span>
				<span class="s1">chunk</span><span class="s2">.</span><span class="s1">storeName </span><span class="s2">? </span><span class="s1">names</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">original</span><span class="s2">) : -</span><span class="s4">1</span>
			<span class="s2">);</span>
		<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
			<span class="s1">mappings</span><span class="s2">.</span><span class="s1">addUneditedChunk</span><span class="s2">(</span><span class="s1">sourceIndex</span><span class="s2">, </span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">this$1$1</span><span class="s2">.</span><span class="s1">original</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">this$1$1</span><span class="s2">.</span><span class="s1">sourcemapLocations</span><span class="s2">);</span>
		<span class="s2">}</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">); }</span>
	<span class="s2">});</span>

	<span class="s0">return </span><span class="s2">{</span>
		<span class="s1">file</span><span class="s2">: </span><span class="s1">options</span><span class="s2">.</span><span class="s1">file </span><span class="s2">? </span><span class="s1">options</span><span class="s2">.</span><span class="s1">file</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">/[/\\]/</span><span class="s2">).</span><span class="s1">pop</span><span class="s2">() : </span><span class="s0">null</span><span class="s2">,</span>
		<span class="s1">sources</span><span class="s2">: [</span><span class="s1">options</span><span class="s2">.</span><span class="s1">source </span><span class="s2">? </span><span class="s1">getRelativePath</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">file </span><span class="s2">|| </span><span class="s3">''</span><span class="s2">, </span><span class="s1">options</span><span class="s2">.</span><span class="s1">source</span><span class="s2">) : </span><span class="s0">null</span><span class="s2">],</span>
		<span class="s1">sourcesContent</span><span class="s2">: </span><span class="s1">options</span><span class="s2">.</span><span class="s1">includeContent </span><span class="s2">? [</span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">] : [</span><span class="s0">null</span><span class="s2">],</span>
		<span class="s1">names</span><span class="s2">: </span><span class="s1">names</span><span class="s2">,</span>
		<span class="s1">mappings</span><span class="s2">: </span><span class="s1">mappings</span><span class="s2">.</span><span class="s1">raw</span><span class="s2">,</span>
	<span class="s2">};</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">generateMap </span><span class="s2">= </span><span class="s0">function </span><span class="s1">generateMap </span><span class="s2">(</span><span class="s1">options</span><span class="s2">) {</span>
	<span class="s0">return new </span><span class="s1">SourceMap</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">generateDecodedMap</span><span class="s2">(</span><span class="s1">options</span><span class="s2">));</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getIndentString </span><span class="s2">= </span><span class="s0">function </span><span class="s1">getIndentString </span><span class="s2">() {</span>
	<span class="s0">return this</span><span class="s2">.</span><span class="s1">indentStr </span><span class="s2">=== </span><span class="s0">null </span><span class="s2">? </span><span class="s3">'</span><span class="s0">\t</span><span class="s3">' </span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">indentStr</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">indent </span><span class="s2">= </span><span class="s0">function </span><span class="s1">indent </span><span class="s2">(</span><span class="s1">indentStr</span><span class="s2">, </span><span class="s1">options</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">pattern </span><span class="s2">= </span><span class="s6">/^[^\r\n]/gm</span><span class="s2">;</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">isObject</span><span class="s2">(</span><span class="s1">indentStr</span><span class="s2">)) {</span>
		<span class="s1">options </span><span class="s2">= </span><span class="s1">indentStr</span><span class="s2">;</span>
		<span class="s1">indentStr </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s1">indentStr </span><span class="s2">= </span><span class="s1">indentStr </span><span class="s2">!== </span><span class="s1">undefined </span><span class="s2">? </span><span class="s1">indentStr </span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">indentStr </span><span class="s2">|| </span><span class="s3">'</span><span class="s0">\t</span><span class="s3">'</span><span class="s2">;</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">indentStr </span><span class="s2">=== </span><span class="s3">''</span><span class="s2">) { </span><span class="s0">return this</span><span class="s2">; } </span><span class="s5">// noop</span>

	<span class="s1">options </span><span class="s2">= </span><span class="s1">options </span><span class="s2">|| {};</span>

	<span class="s5">// Process exclusion ranges</span>
	<span class="s0">var </span><span class="s1">isExcluded </span><span class="s2">= {};</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">exclusions </span><span class="s2">=</span>
			<span class="s0">typeof </span><span class="s1">options</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] === </span><span class="s3">'number' </span><span class="s2">? [</span><span class="s1">options</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">] : </span><span class="s1">options</span><span class="s2">.</span><span class="s1">exclude</span><span class="s2">;</span>
		<span class="s1">exclusions</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">exclusion</span><span class="s2">) {</span>
			<span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s1">exclusion</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">exclusion</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]; </span><span class="s1">i </span><span class="s2">+= </span><span class="s4">1</span><span class="s2">) {</span>
				<span class="s1">isExcluded</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s0">true</span><span class="s2">;</span>
			<span class="s2">}</span>
		<span class="s2">});</span>
	<span class="s2">}</span>

	<span class="s0">var </span><span class="s1">shouldIndentNextCharacter </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">indentStart </span><span class="s2">!== </span><span class="s0">false</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">replacer </span><span class="s2">= </span><span class="s0">function </span><span class="s2">(</span><span class="s1">match</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">shouldIndentNextCharacter</span><span class="s2">) { </span><span class="s0">return </span><span class="s2">(</span><span class="s3">&quot;&quot; </span><span class="s2">+ </span><span class="s1">indentStr </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">); }</span>
		<span class="s1">shouldIndentNextCharacter </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
		<span class="s0">return </span><span class="s1">match</span><span class="s2">;</span>
	<span class="s2">};</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">, </span><span class="s1">replacer</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">charIndex </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk</span><span class="s2">;</span>

	<span class="s0">while </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">end </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">;</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">edited</span><span class="s2">) {</span>
			<span class="s0">if </span><span class="s2">(!</span><span class="s1">isExcluded</span><span class="s2">[</span><span class="s1">charIndex</span><span class="s2">]) {</span>
				<span class="s1">chunk</span><span class="s2">.</span><span class="s1">content </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">, </span><span class="s1">replacer</span><span class="s2">);</span>

				<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
					<span class="s1">shouldIndentNextCharacter </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">] === </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">;</span>
				<span class="s2">}</span>
			<span class="s2">}</span>
		<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
			<span class="s1">charIndex </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start</span><span class="s2">;</span>

			<span class="s0">while </span><span class="s2">(</span><span class="s1">charIndex </span><span class="s2">&lt; </span><span class="s1">end</span><span class="s2">) {</span>
				<span class="s0">if </span><span class="s2">(!</span><span class="s1">isExcluded</span><span class="s2">[</span><span class="s1">charIndex</span><span class="s2">]) {</span>
					<span class="s0">var </span><span class="s1">char </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">[</span><span class="s1">charIndex</span><span class="s2">];</span>

					<span class="s0">if </span><span class="s2">(</span><span class="s1">char </span><span class="s2">=== </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">) {</span>
						<span class="s1">shouldIndentNextCharacter </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
					<span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">char </span><span class="s2">!== </span><span class="s3">'</span><span class="s0">\r</span><span class="s3">' </span><span class="s2">&amp;&amp; </span><span class="s1">shouldIndentNextCharacter</span><span class="s2">) {</span>
						<span class="s1">shouldIndentNextCharacter </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>

						<span class="s0">if </span><span class="s2">(</span><span class="s1">charIndex </span><span class="s2">=== </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start</span><span class="s2">) {</span>
							<span class="s1">chunk</span><span class="s2">.</span><span class="s1">prependRight</span><span class="s2">(</span><span class="s1">indentStr</span><span class="s2">);</span>
						<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
							<span class="s0">this</span><span class="s2">.</span><span class="s1">_splitChunk</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">charIndex</span><span class="s2">);</span>
							<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
							<span class="s1">chunk</span><span class="s2">.</span><span class="s1">prependRight</span><span class="s2">(</span><span class="s1">indentStr</span><span class="s2">);</span>
						<span class="s2">}</span>
					<span class="s2">}</span>
				<span class="s2">}</span>

				<span class="s1">charIndex </span><span class="s2">+= </span><span class="s4">1</span><span class="s2">;</span>
			<span class="s2">}</span>
		<span class="s2">}</span>

		<span class="s1">charIndex </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">;</span>
		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">, </span><span class="s1">replacer</span><span class="s2">);</span>

	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">insert </span><span class="s2">= </span><span class="s0">function </span><span class="s1">insert </span><span class="s2">() {</span>
	<span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span>
		<span class="s3">'magicString.insert(...) is deprecated. Use prependRight(...) or appendLeft(...)'</span>
	<span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">insertLeft </span><span class="s2">= </span><span class="s0">function </span><span class="s1">insertLeft </span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(!</span><span class="s1">warned</span><span class="s2">.</span><span class="s1">insertLeft</span><span class="s2">) {</span>
		<span class="s1">console</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
			<span class="s3">'magicString.insertLeft(...) is deprecated. Use magicString.appendLeft(...) instead'</span>
		<span class="s2">); </span><span class="s5">// eslint-disable-line no-console</span>
		<span class="s1">warned</span><span class="s2">.</span><span class="s1">insertLeft </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">return this</span><span class="s2">.</span><span class="s1">appendLeft</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">content</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">insertRight </span><span class="s2">= </span><span class="s0">function </span><span class="s1">insertRight </span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(!</span><span class="s1">warned</span><span class="s2">.</span><span class="s1">insertRight</span><span class="s2">) {</span>
		<span class="s1">console</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
			<span class="s3">'magicString.insertRight(...) is deprecated. Use magicString.prependRight(...) instead'</span>
		<span class="s2">); </span><span class="s5">// eslint-disable-line no-console</span>
		<span class="s1">warned</span><span class="s2">.</span><span class="s1">insertRight </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">return this</span><span class="s2">.</span><span class="s1">prependRight</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">content</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">move </span><span class="s2">= </span><span class="s0">function </span><span class="s1">move </span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">, </span><span class="s1">index</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s1">start </span><span class="s2">&amp;&amp; </span><span class="s1">index </span><span class="s2">&lt;= </span><span class="s1">end</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'Cannot move a selection inside itself'</span><span class="s2">); }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">start</span><span class="s2">);</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">end</span><span class="s2">);</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">index</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">first </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">start</span><span class="s2">];</span>
	<span class="s0">var </span><span class="s1">last </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">end</span><span class="s2">];</span>

	<span class="s0">var </span><span class="s1">oldLeft </span><span class="s2">= </span><span class="s1">first</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">oldRight </span><span class="s2">= </span><span class="s1">last</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>

	<span class="s0">var </span><span class="s1">newRight </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">index</span><span class="s2">];</span>
	<span class="s0">if </span><span class="s2">(!</span><span class="s1">newRight </span><span class="s2">&amp;&amp; </span><span class="s1">last </span><span class="s2">=== </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk</span><span class="s2">) { </span><span class="s0">return this</span><span class="s2">; }</span>
	<span class="s0">var </span><span class="s1">newLeft </span><span class="s2">= </span><span class="s1">newRight </span><span class="s2">? </span><span class="s1">newRight</span><span class="s2">.</span><span class="s1">previous </span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk</span><span class="s2">;</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">oldLeft</span><span class="s2">) { </span><span class="s1">oldLeft</span><span class="s2">.</span><span class="s1">next </span><span class="s2">= </span><span class="s1">oldRight</span><span class="s2">; }</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">oldRight</span><span class="s2">) { </span><span class="s1">oldRight</span><span class="s2">.</span><span class="s1">previous </span><span class="s2">= </span><span class="s1">oldLeft</span><span class="s2">; }</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">newLeft</span><span class="s2">) { </span><span class="s1">newLeft</span><span class="s2">.</span><span class="s1">next </span><span class="s2">= </span><span class="s1">first</span><span class="s2">; }</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">newRight</span><span class="s2">) { </span><span class="s1">newRight</span><span class="s2">.</span><span class="s1">previous </span><span class="s2">= </span><span class="s1">last</span><span class="s2">; }</span>

	<span class="s0">if </span><span class="s2">(!</span><span class="s1">first</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">) { </span><span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk </span><span class="s2">= </span><span class="s1">last</span><span class="s2">.</span><span class="s1">next</span><span class="s2">; }</span>
	<span class="s0">if </span><span class="s2">(!</span><span class="s1">last</span><span class="s2">.</span><span class="s1">next</span><span class="s2">) {</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk </span><span class="s2">= </span><span class="s1">first</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">;</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk</span><span class="s2">.</span><span class="s1">next </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s1">first</span><span class="s2">.</span><span class="s1">previous </span><span class="s2">= </span><span class="s1">newLeft</span><span class="s2">;</span>
	<span class="s1">last</span><span class="s2">.</span><span class="s1">next </span><span class="s2">= </span><span class="s1">newRight </span><span class="s2">|| </span><span class="s0">null</span><span class="s2">;</span>

	<span class="s0">if </span><span class="s2">(!</span><span class="s1">newLeft</span><span class="s2">) { </span><span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk </span><span class="s2">= </span><span class="s1">first</span><span class="s2">; }</span>
	<span class="s0">if </span><span class="s2">(!</span><span class="s1">newRight</span><span class="s2">) { </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk </span><span class="s2">= </span><span class="s1">last</span><span class="s2">; }</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">overwrite </span><span class="s2">= </span><span class="s0">function </span><span class="s1">overwrite </span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">options</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">content </span><span class="s2">!== </span><span class="s3">'string'</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'replacement content must be a string'</span><span class="s2">); }</span>

	<span class="s0">while </span><span class="s2">(</span><span class="s1">start </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">) { </span><span class="s1">start </span><span class="s2">+= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; }</span>
	<span class="s0">while </span><span class="s2">(</span><span class="s1">end </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">) { </span><span class="s1">end </span><span class="s2">+= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; }</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">end </span><span class="s2">&gt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'end is out of bounds'</span><span class="s2">); }</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">start </span><span class="s2">=== </span><span class="s1">end</span><span class="s2">)</span>
		<span class="s2">{ </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span>
			<span class="s3">'Cannot overwrite a zero-length range  use appendLeft or prependRight instead'</span>
		<span class="s2">); }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">start</span><span class="s2">);</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">end</span><span class="s2">);</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">options </span><span class="s2">=== </span><span class="s0">true</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(!</span><span class="s1">warned</span><span class="s2">.</span><span class="s1">storeName</span><span class="s2">) {</span>
			<span class="s1">console</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
				<span class="s3">'The final argument to magicString.overwrite(...) should be an options object. See https://github.com/rich-harris/magic-string'</span>
			<span class="s2">); </span><span class="s5">// eslint-disable-line no-console</span>
			<span class="s1">warned</span><span class="s2">.</span><span class="s1">storeName </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s1">options </span><span class="s2">= { </span><span class="s1">storeName</span><span class="s2">: </span><span class="s0">true </span><span class="s2">};</span>
	<span class="s2">}</span>
	<span class="s0">var </span><span class="s1">storeName </span><span class="s2">= </span><span class="s1">options </span><span class="s2">!== </span><span class="s1">undefined </span><span class="s2">? </span><span class="s1">options</span><span class="s2">.</span><span class="s1">storeName </span><span class="s2">: </span><span class="s0">false</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">contentOnly </span><span class="s2">= </span><span class="s1">options </span><span class="s2">!== </span><span class="s1">undefined </span><span class="s2">? </span><span class="s1">options</span><span class="s2">.</span><span class="s1">contentOnly </span><span class="s2">: </span><span class="s0">false</span><span class="s2">;</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">storeName</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">original </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">);</span>
		<span class="s1">Object</span><span class="s2">.</span><span class="s1">defineProperty</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">storedNames</span><span class="s2">, </span><span class="s1">original</span><span class="s2">, { </span><span class="s1">writable</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s0">true</span><span class="s2">, </span><span class="s1">enumerable</span><span class="s2">: </span><span class="s0">true </span><span class="s2">});</span>
	<span class="s2">}</span>

	<span class="s0">var </span><span class="s1">first </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">start</span><span class="s2">];</span>
	<span class="s0">var </span><span class="s1">last </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">end</span><span class="s2">];</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">first</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s1">first</span><span class="s2">;</span>
		<span class="s0">while </span><span class="s2">(</span><span class="s1">chunk </span><span class="s2">!== </span><span class="s1">last</span><span class="s2">) {</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next </span><span class="s2">!== </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">]) {</span>
				<span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'Cannot overwrite across a split point'</span><span class="s2">);</span>
			<span class="s2">}</span>
			<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
			<span class="s1">chunk</span><span class="s2">.</span><span class="s1">edit</span><span class="s2">(</span><span class="s3">''</span><span class="s2">, </span><span class="s0">false</span><span class="s2">);</span>
		<span class="s2">}</span>

		<span class="s1">first</span><span class="s2">.</span><span class="s1">edit</span><span class="s2">(</span><span class="s1">content</span><span class="s2">, </span><span class="s1">storeName</span><span class="s2">, </span><span class="s1">contentOnly</span><span class="s2">);</span>
	<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
		<span class="s5">// must be inserting at the end</span>
		<span class="s0">var </span><span class="s1">newChunk </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Chunk</span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">, </span><span class="s3">''</span><span class="s2">).</span><span class="s1">edit</span><span class="s2">(</span><span class="s1">content</span><span class="s2">, </span><span class="s1">storeName</span><span class="s2">);</span>

		<span class="s5">// TODO last chunk in the array may not be the last chunk, if it's moved...</span>
		<span class="s1">last</span><span class="s2">.</span><span class="s1">next </span><span class="s2">= </span><span class="s1">newChunk</span><span class="s2">;</span>
		<span class="s1">newChunk</span><span class="s2">.</span><span class="s1">previous </span><span class="s2">= </span><span class="s1">last</span><span class="s2">;</span>
	<span class="s2">}</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">prepend </span><span class="s2">= </span><span class="s0">function </span><span class="s1">prepend </span><span class="s2">(</span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">content </span><span class="s2">!== </span><span class="s3">'string'</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'outro content must be a string'</span><span class="s2">); }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s1">content </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">;</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">prependLeft </span><span class="s2">= </span><span class="s0">function </span><span class="s1">prependLeft </span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">content </span><span class="s2">!== </span><span class="s3">'string'</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'inserted content must be a string'</span><span class="s2">); }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">index</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">index</span><span class="s2">];</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s1">chunk</span><span class="s2">.</span><span class="s1">prependLeft</span><span class="s2">(</span><span class="s1">content</span><span class="s2">);</span>
	<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s1">content </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">;</span>
	<span class="s2">}</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">prependRight </span><span class="s2">= </span><span class="s0">function </span><span class="s1">prependRight </span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">content</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">content </span><span class="s2">!== </span><span class="s3">'string'</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'inserted content must be a string'</span><span class="s2">); }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">index</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">index</span><span class="s2">];</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s1">chunk</span><span class="s2">.</span><span class="s1">prependRight</span><span class="s2">(</span><span class="s1">content</span><span class="s2">);</span>
	<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s1">content </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">;</span>
	<span class="s2">}</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">remove </span><span class="s2">= </span><span class="s0">function </span><span class="s1">remove </span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">) {</span>
	<span class="s0">while </span><span class="s2">(</span><span class="s1">start </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">) { </span><span class="s1">start </span><span class="s2">+= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; }</span>
	<span class="s0">while </span><span class="s2">(</span><span class="s1">end </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">) { </span><span class="s1">end </span><span class="s2">+= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; }</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">start </span><span class="s2">=== </span><span class="s1">end</span><span class="s2">) { </span><span class="s0">return this</span><span class="s2">; }</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">start </span><span class="s2">&lt; </span><span class="s4">0 </span><span class="s2">|| </span><span class="s1">end </span><span class="s2">&gt; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'Character is out of bounds'</span><span class="s2">); }</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">start </span><span class="s2">&gt; </span><span class="s1">end</span><span class="s2">) { </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'end must be greater than start'</span><span class="s2">); }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">start</span><span class="s2">);</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">_split</span><span class="s2">(</span><span class="s1">end</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">start</span><span class="s2">];</span>

	<span class="s0">while </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>
		<span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>
		<span class="s1">chunk</span><span class="s2">.</span><span class="s1">edit</span><span class="s2">(</span><span class="s3">''</span><span class="s2">);</span>

		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">end </span><span class="s2">&gt; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end </span><span class="s2">? </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">] : </span><span class="s0">null</span><span class="s2">;</span>
	<span class="s2">}</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">lastChar </span><span class="s2">= </span><span class="s0">function </span><span class="s1">lastChar </span><span class="s2">() {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">[</span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">]; }</span>
	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk</span><span class="s2">;</span>
	<span class="s0">do </span><span class="s2">{</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">]; }</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">]; }</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">]; }</span>
	<span class="s2">} </span><span class="s0">while </span><span class="s2">((</span><span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">));</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">[</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">]; }</span>
	<span class="s0">return </span><span class="s3">''</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">lastLine </span><span class="s2">= </span><span class="s0">function </span><span class="s1">lastLine </span><span class="s2">() {</span>
	<span class="s0">var </span><span class="s1">lineIndex </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">lastIndexOf</span><span class="s2">(</span><span class="s1">n</span><span class="s2">);</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">!== -</span><span class="s4">1</span><span class="s2">) { </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">substr</span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">); }</span>
	<span class="s0">var </span><span class="s1">lineStr </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk</span><span class="s2">;</span>
	<span class="s0">do </span><span class="s2">{</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) {</span>
			<span class="s1">lineIndex </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">lastIndexOf</span><span class="s2">(</span><span class="s1">n</span><span class="s2">);</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">!== -</span><span class="s4">1</span><span class="s2">) { </span><span class="s0">return </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">substr</span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">) + </span><span class="s1">lineStr</span><span class="s2">; }</span>
			<span class="s1">lineStr </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">+ </span><span class="s1">lineStr</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) {</span>
			<span class="s1">lineIndex </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">lastIndexOf</span><span class="s2">(</span><span class="s1">n</span><span class="s2">);</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">!== -</span><span class="s4">1</span><span class="s2">) { </span><span class="s0">return </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">substr</span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">) + </span><span class="s1">lineStr</span><span class="s2">; }</span>
			<span class="s1">lineStr </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content </span><span class="s2">+ </span><span class="s1">lineStr</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) {</span>
			<span class="s1">lineIndex </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">lastIndexOf</span><span class="s2">(</span><span class="s1">n</span><span class="s2">);</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">!== -</span><span class="s4">1</span><span class="s2">) { </span><span class="s0">return </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">substr</span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">) + </span><span class="s1">lineStr</span><span class="s2">; }</span>
			<span class="s1">lineStr </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">+ </span><span class="s1">lineStr</span><span class="s2">;</span>
		<span class="s2">}</span>
	<span class="s2">} </span><span class="s0">while </span><span class="s2">((</span><span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">));</span>
	<span class="s1">lineIndex </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">lastIndexOf</span><span class="s2">(</span><span class="s1">n</span><span class="s2">);</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">!== -</span><span class="s4">1</span><span class="s2">) { </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">substr</span><span class="s2">(</span><span class="s1">lineIndex </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">) + </span><span class="s1">lineStr</span><span class="s2">; }</span>
	<span class="s0">return this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">+ </span><span class="s1">lineStr</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">slice </span><span class="s2">= </span><span class="s0">function </span><span class="s1">slice </span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">( </span><span class="s1">start </span><span class="s2">=== </span><span class="s0">void </span><span class="s4">0 </span><span class="s2">) </span><span class="s1">start </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
		<span class="s0">if </span><span class="s2">( </span><span class="s1">end </span><span class="s2">=== </span><span class="s0">void </span><span class="s4">0 </span><span class="s2">) </span><span class="s1">end </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>

	<span class="s0">while </span><span class="s2">(</span><span class="s1">start </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">) { </span><span class="s1">start </span><span class="s2">+= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; }</span>
	<span class="s0">while </span><span class="s2">(</span><span class="s1">end </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">) { </span><span class="s1">end </span><span class="s2">+= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; }</span>

	<span class="s0">var </span><span class="s1">result </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>

	<span class="s5">// find start chunk</span>
	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk</span><span class="s2">;</span>
	<span class="s0">while </span><span class="s2">(</span><span class="s1">chunk </span><span class="s2">&amp;&amp; (</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start </span><span class="s2">&gt; </span><span class="s1">start </span><span class="s2">|| </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end </span><span class="s2">&lt;= </span><span class="s1">start</span><span class="s2">)) {</span>
		<span class="s5">// found end chunk before start</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start </span><span class="s2">&lt; </span><span class="s1">end </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end </span><span class="s2">&gt;= </span><span class="s1">end</span><span class="s2">) {</span>
			<span class="s0">return </span><span class="s1">result</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">edited </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start </span><span class="s2">!== </span><span class="s1">start</span><span class="s2">)</span>
		<span class="s2">{ </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">((</span><span class="s3">&quot;Cannot use replaced character &quot; </span><span class="s2">+ </span><span class="s1">start </span><span class="s2">+ </span><span class="s3">&quot; as slice start anchor.&quot;</span><span class="s2">)); }</span>

	<span class="s0">var </span><span class="s1">startChunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">;</span>
	<span class="s0">while </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">&amp;&amp; (</span><span class="s1">startChunk </span><span class="s2">!== </span><span class="s1">chunk </span><span class="s2">|| </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start </span><span class="s2">=== </span><span class="s1">start</span><span class="s2">)) {</span>
			<span class="s1">result </span><span class="s2">+= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s0">var </span><span class="s1">containsEnd </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start </span><span class="s2">&lt; </span><span class="s1">end </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end </span><span class="s2">&gt;= </span><span class="s1">end</span><span class="s2">;</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">containsEnd </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">edited </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end </span><span class="s2">!== </span><span class="s1">end</span><span class="s2">)</span>
			<span class="s2">{ </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">((</span><span class="s3">&quot;Cannot use replaced character &quot; </span><span class="s2">+ </span><span class="s1">end </span><span class="s2">+ </span><span class="s3">&quot; as slice end anchor.&quot;</span><span class="s2">)); }</span>

		<span class="s0">var </span><span class="s1">sliceStart </span><span class="s2">= </span><span class="s1">startChunk </span><span class="s2">=== </span><span class="s1">chunk </span><span class="s2">? </span><span class="s1">start </span><span class="s2">- </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start </span><span class="s2">: </span><span class="s4">0</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">sliceEnd </span><span class="s2">= </span><span class="s1">containsEnd </span><span class="s2">? </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length </span><span class="s2">+ </span><span class="s1">end </span><span class="s2">- </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end </span><span class="s2">: </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>

		<span class="s1">result </span><span class="s2">+= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">sliceStart</span><span class="s2">, </span><span class="s1">sliceEnd</span><span class="s2">);</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">&amp;&amp; (!</span><span class="s1">containsEnd </span><span class="s2">|| </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end </span><span class="s2">=== </span><span class="s1">end</span><span class="s2">)) {</span>
			<span class="s1">result </span><span class="s2">+= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">containsEnd</span><span class="s2">) {</span>
			<span class="s0">break</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">return </span><span class="s1">result</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s5">// TODO deprecate this? not really very useful</span>
<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">snip </span><span class="s2">= </span><span class="s0">function </span><span class="s1">snip </span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">clone </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">();</span>
	<span class="s1">clone</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">start</span><span class="s2">);</span>
	<span class="s1">clone</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">end</span><span class="s2">, </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">original</span><span class="s2">.</span><span class="s1">length</span><span class="s2">);</span>

	<span class="s0">return </span><span class="s1">clone</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_split </span><span class="s2">= </span><span class="s0">function </span><span class="s1">_split </span><span class="s2">(</span><span class="s1">index</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] || </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]) { </span><span class="s0">return</span><span class="s2">; }</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastSearchedChunk</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">searchForward </span><span class="s2">= </span><span class="s1">index </span><span class="s2">&gt; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">;</span>

	<span class="s0">while </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)) { </span><span class="s0">return this</span><span class="s2">.</span><span class="s1">_splitChunk</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">index</span><span class="s2">); }</span>

		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">searchForward </span><span class="s2">? </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">] : </span><span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start</span><span class="s2">];</span>
	<span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_splitChunk </span><span class="s2">= </span><span class="s0">function </span><span class="s1">_splitChunk </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">index</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">edited </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
		<span class="s5">// zero-length edited chunks are a special case (overlapping replacements)</span>
		<span class="s0">var </span><span class="s1">loc </span><span class="s2">= </span><span class="s1">getLocator</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">original</span><span class="s2">)(</span><span class="s1">index</span><span class="s2">);</span>
		<span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span>
			<span class="s2">(</span><span class="s3">&quot;Cannot split a chunk that has already been edited (&quot; </span><span class="s2">+ (</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">line</span><span class="s2">) + </span><span class="s3">&quot;:&quot; </span><span class="s2">+ (</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">column</span><span class="s2">) + </span><span class="s3">&quot;  </span><span class="s0">\&quot;</span><span class="s3">&quot; </span><span class="s2">+ (</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">original</span><span class="s2">) + </span><span class="s3">&quot;</span><span class="s0">\&quot;</span><span class="s3">)&quot;</span><span class="s2">)</span>
		<span class="s2">);</span>
	<span class="s2">}</span>

	<span class="s0">var </span><span class="s1">newChunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">index</span><span class="s2">);</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">chunk</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">newChunk</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">newChunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">] = </span><span class="s1">newChunk</span><span class="s2">;</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk </span><span class="s2">=== </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk</span><span class="s2">) { </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk </span><span class="s2">= </span><span class="s1">newChunk</span><span class="s2">; }</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">lastSearchedChunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">;</span>
	<span class="s0">return true</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">toString </span><span class="s2">= </span><span class="s0">function </span><span class="s1">toString </span><span class="s2">() {</span>
	<span class="s0">var </span><span class="s1">str </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">;</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk</span><span class="s2">;</span>
	<span class="s0">while </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
		<span class="s1">str </span><span class="s2">+= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">toString</span><span class="s2">();</span>
		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">return </span><span class="s1">str </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">isEmpty </span><span class="s2">= </span><span class="s0">function </span><span class="s1">isEmpty </span><span class="s2">() {</span>
	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk</span><span class="s2">;</span>
	<span class="s0">do </span><span class="s2">{</span>
		<span class="s0">if </span><span class="s2">(</span>
			<span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">()) ||</span>
			<span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">()) ||</span>
			<span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&amp;&amp; </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">())</span>
		<span class="s2">)</span>
			<span class="s2">{ </span><span class="s0">return false</span><span class="s2">; }</span>
	<span class="s2">} </span><span class="s0">while </span><span class="s2">((</span><span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">));</span>
	<span class="s0">return true</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s0">function </span><span class="s1">length </span><span class="s2">() {</span>
	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">length </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
	<span class="s0">do </span><span class="s2">{</span>
		<span class="s1">length </span><span class="s2">+= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">+ </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length </span><span class="s2">+ </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
	<span class="s2">} </span><span class="s0">while </span><span class="s2">((</span><span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">));</span>
	<span class="s0">return </span><span class="s1">length</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimLines </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimLines </span><span class="s2">() {</span>
	<span class="s0">return this</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">(</span><span class="s3">'[</span><span class="s0">\\</span><span class="s3">r</span><span class="s0">\\</span><span class="s3">n]'</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trim </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trim </span><span class="s2">(</span><span class="s1">charType</span><span class="s2">) {</span>
	<span class="s0">return this</span><span class="s2">.</span><span class="s1">trimStart</span><span class="s2">(</span><span class="s1">charType</span><span class="s2">).</span><span class="s1">trimEnd</span><span class="s2">(</span><span class="s1">charType</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimEndAborted </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimEndAborted </span><span class="s2">(</span><span class="s1">charType</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">rx </span><span class="s2">= </span><span class="s0">new </span><span class="s1">RegExp</span><span class="s2">((</span><span class="s1">charType </span><span class="s2">|| </span><span class="s3">'</span><span class="s0">\\</span><span class="s3">s'</span><span class="s2">) + </span><span class="s3">'+$'</span><span class="s2">);</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">outro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return true</span><span class="s2">; }</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk</span><span class="s2">;</span>

	<span class="s0">do </span><span class="s2">{</span>
		<span class="s0">var </span><span class="s1">end </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">aborted </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">trimEnd</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">);</span>

		<span class="s5">// if chunk was trimmed, we have a new lastChunk</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end </span><span class="s2">!== </span><span class="s1">end</span><span class="s2">) {</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk </span><span class="s2">=== </span><span class="s1">chunk</span><span class="s2">) {</span>
				<span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
			<span class="s2">}</span>

			<span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">] = </span><span class="s1">chunk</span><span class="s2">;</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">.</span><span class="s1">start</span><span class="s2">] = </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">.</span><span class="s1">end</span><span class="s2">] = </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">aborted</span><span class="s2">) { </span><span class="s0">return true</span><span class="s2">; }</span>
		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">;</span>
	<span class="s2">} </span><span class="s0">while </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">);</span>

	<span class="s0">return false</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimEnd </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimEnd </span><span class="s2">(</span><span class="s1">charType</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">trimEndAborted</span><span class="s2">(</span><span class="s1">charType</span><span class="s2">);</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>
<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimStartAborted </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimStartAborted </span><span class="s2">(</span><span class="s1">charType</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">rx </span><span class="s2">= </span><span class="s0">new </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s3">'^' </span><span class="s2">+ (</span><span class="s1">charType </span><span class="s2">|| </span><span class="s3">'</span><span class="s0">\\</span><span class="s3">s'</span><span class="s2">) + </span><span class="s3">'+'</span><span class="s2">);</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s0">return true</span><span class="s2">; }</span>

	<span class="s0">var </span><span class="s1">chunk </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">firstChunk</span><span class="s2">;</span>

	<span class="s0">do </span><span class="s2">{</span>
		<span class="s0">var </span><span class="s1">end </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">aborted </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">trimStart</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">);</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end </span><span class="s2">!== </span><span class="s1">end</span><span class="s2">) {</span>
			<span class="s5">// special case...</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk </span><span class="s2">=== </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk</span><span class="s2">) { </span><span class="s0">this</span><span class="s2">.</span><span class="s1">lastChunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">; }</span>

			<span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">end</span><span class="s2">] = </span><span class="s1">chunk</span><span class="s2">;</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">byStart</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">.</span><span class="s1">start</span><span class="s2">] = </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">byEnd</span><span class="s2">[</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">.</span><span class="s1">end</span><span class="s2">] = </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">aborted</span><span class="s2">) { </span><span class="s0">return true</span><span class="s2">; }</span>
		<span class="s1">chunk </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">next</span><span class="s2">;</span>
	<span class="s2">} </span><span class="s0">while </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">);</span>

	<span class="s0">return false</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">MagicString</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimStart </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimStart </span><span class="s2">(</span><span class="s1">charType</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">trimStartAborted</span><span class="s2">(</span><span class="s1">charType</span><span class="s2">);</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s0">var </span><span class="s1">hasOwnProp </span><span class="s2">= </span><span class="s1">Object</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">;</span>

<span class="s0">var </span><span class="s1">Bundle </span><span class="s2">= </span><span class="s0">function </span><span class="s1">Bundle</span><span class="s2">(</span><span class="s1">options</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">( </span><span class="s1">options </span><span class="s2">=== </span><span class="s0">void </span><span class="s4">0 </span><span class="s2">) </span><span class="s1">options </span><span class="s2">= {};</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">|| </span><span class="s3">''</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">separator </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">separator </span><span class="s2">!== </span><span class="s1">undefined </span><span class="s2">? </span><span class="s1">options</span><span class="s2">.</span><span class="s1">separator </span><span class="s2">: </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">;</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">sources </span><span class="s2">= [];</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSources </span><span class="s2">= [];</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSourceIndexByFilename </span><span class="s2">= {};</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">addSource </span><span class="s2">= </span><span class="s0">function </span><span class="s1">addSource </span><span class="s2">(</span><span class="s1">source</span><span class="s2">) {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s1">source </span><span class="s0">instanceof </span><span class="s1">MagicString</span><span class="s2">) {</span>
		<span class="s0">return this</span><span class="s2">.</span><span class="s1">addSource</span><span class="s2">({</span>
			<span class="s1">content</span><span class="s2">: </span><span class="s1">source</span><span class="s2">,</span>
			<span class="s1">filename</span><span class="s2">: </span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">,</span>
			<span class="s1">separator</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">separator</span><span class="s2">,</span>
		<span class="s2">});</span>
	<span class="s2">}</span>

	<span class="s0">if </span><span class="s2">(!</span><span class="s1">isObject</span><span class="s2">(</span><span class="s1">source</span><span class="s2">) || !</span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">) {</span>
		<span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span>
			<span class="s3">'bundle.addSource() takes an object with a `content` property, which should be an instance of MagicString, and an optional `filename`'</span>
		<span class="s2">);</span>
	<span class="s2">}</span>

	<span class="s2">[</span><span class="s3">'filename'</span><span class="s2">, </span><span class="s3">'indentExclusionRanges'</span><span class="s2">, </span><span class="s3">'separator'</span><span class="s2">].</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">option</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(!</span><span class="s1">hasOwnProp</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">option</span><span class="s2">)) { </span><span class="s1">source</span><span class="s2">[</span><span class="s1">option</span><span class="s2">] = </span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">[</span><span class="s1">option</span><span class="s2">]; }</span>
	<span class="s2">});</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">source</span><span class="s2">.</span><span class="s1">separator </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) {</span>
		<span class="s5">// TODO there's a bunch of this sort of thing, needs cleaning up</span>
		<span class="s1">source</span><span class="s2">.</span><span class="s1">separator </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">separator</span><span class="s2">;</span>
	<span class="s2">}</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(!</span><span class="s1">hasOwnProp</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSourceIndexByFilename</span><span class="s2">, </span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)) {</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSourceIndexByFilename</span><span class="s2">[</span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">] = </span><span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSources</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSources</span><span class="s2">.</span><span class="s1">push</span><span class="s2">({ </span><span class="s1">filename</span><span class="s2">: </span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">content</span><span class="s2">: </span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">original </span><span class="s2">});</span>
		<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
			<span class="s0">var </span><span class="s1">uniqueSource </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSources</span><span class="s2">[</span><span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSourceIndexByFilename</span><span class="s2">[</span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">]];</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">original </span><span class="s2">!== </span><span class="s1">uniqueSource</span><span class="s2">.</span><span class="s1">content</span><span class="s2">) {</span>
				<span class="s0">throw new </span><span class="s1">Error</span><span class="s2">((</span><span class="s3">&quot;Illegal source: same filename (&quot; </span><span class="s2">+ (</span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">) + </span><span class="s3">&quot;), different contents&quot;</span><span class="s2">));</span>
			<span class="s2">}</span>
		<span class="s2">}</span>
	<span class="s2">}</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">source</span><span class="s2">);</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">append </span><span class="s2">= </span><span class="s0">function </span><span class="s1">append </span><span class="s2">(</span><span class="s1">str</span><span class="s2">, </span><span class="s1">options</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">addSource</span><span class="s2">({</span>
		<span class="s1">content</span><span class="s2">: </span><span class="s0">new </span><span class="s1">MagicString</span><span class="s2">(</span><span class="s1">str</span><span class="s2">),</span>
		<span class="s1">separator</span><span class="s2">: (</span><span class="s1">options </span><span class="s2">&amp;&amp; </span><span class="s1">options</span><span class="s2">.</span><span class="s1">separator</span><span class="s2">) || </span><span class="s3">''</span><span class="s2">,</span>
	<span class="s2">});</span>

	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">clone </span><span class="s2">= </span><span class="s0">function </span><span class="s1">clone </span><span class="s2">() {</span>
	<span class="s0">var </span><span class="s1">bundle </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Bundle</span><span class="s2">({</span>
		<span class="s1">intro</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">,</span>
		<span class="s1">separator</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">separator</span><span class="s2">,</span>
	<span class="s2">});</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">source</span><span class="s2">) {</span>
		<span class="s1">bundle</span><span class="s2">.</span><span class="s1">addSource</span><span class="s2">({</span>
			<span class="s1">filename</span><span class="s2">: </span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">,</span>
			<span class="s1">content</span><span class="s2">: </span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">(),</span>
			<span class="s1">separator</span><span class="s2">: </span><span class="s1">source</span><span class="s2">.</span><span class="s1">separator</span><span class="s2">,</span>
		<span class="s2">});</span>
	<span class="s2">});</span>

	<span class="s0">return </span><span class="s1">bundle</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">generateDecodedMap </span><span class="s2">= </span><span class="s0">function </span><span class="s1">generateDecodedMap </span><span class="s2">(</span><span class="s1">options</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">this$1$1 </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>
		<span class="s0">if </span><span class="s2">( </span><span class="s1">options </span><span class="s2">=== </span><span class="s0">void </span><span class="s4">0 </span><span class="s2">) </span><span class="s1">options </span><span class="s2">= {};</span>

	<span class="s0">var </span><span class="s1">names </span><span class="s2">= [];</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">source</span><span class="s2">) {</span>
		<span class="s1">Object</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">(</span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">storedNames</span><span class="s2">).</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
			<span class="s0">if </span><span class="s2">(!~</span><span class="s1">names</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)) { </span><span class="s1">names</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">name</span><span class="s2">); }</span>
		<span class="s2">});</span>
	<span class="s2">});</span>

	<span class="s0">var </span><span class="s1">mappings </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Mappings</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">hires</span><span class="s2">);</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">) {</span>
		<span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">);</span>
	<span class="s2">}</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">i</span><span class="s2">) {</span>
		<span class="s0">if </span><span class="s2">(</span><span class="s1">i </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) {</span>
			<span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">this$1$1</span><span class="s2">.</span><span class="s1">separator</span><span class="s2">);</span>
		<span class="s2">}</span>

		<span class="s0">var </span><span class="s1">sourceIndex </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">? </span><span class="s1">this$1$1</span><span class="s2">.</span><span class="s1">uniqueSourceIndexByFilename</span><span class="s2">[</span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">] : -</span><span class="s4">1</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">magicString </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">locate </span><span class="s2">= </span><span class="s1">getLocator</span><span class="s2">(</span><span class="s1">magicString</span><span class="s2">.</span><span class="s1">original</span><span class="s2">);</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">magicString</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">) {</span>
			<span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">magicString</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">);</span>
		<span class="s2">}</span>

		<span class="s1">magicString</span><span class="s2">.</span><span class="s1">firstChunk</span><span class="s2">.</span><span class="s1">eachNext</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) {</span>
			<span class="s0">var </span><span class="s1">loc </span><span class="s2">= </span><span class="s1">locate</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">start</span><span class="s2">);</span>

			<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">); }</span>

			<span class="s0">if </span><span class="s2">(</span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">) {</span>
				<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">edited</span><span class="s2">) {</span>
					<span class="s1">mappings</span><span class="s2">.</span><span class="s1">addEdit</span><span class="s2">(</span>
						<span class="s1">sourceIndex</span><span class="s2">,</span>
						<span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">,</span>
						<span class="s1">loc</span><span class="s2">,</span>
						<span class="s1">chunk</span><span class="s2">.</span><span class="s1">storeName </span><span class="s2">? </span><span class="s1">names</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">original</span><span class="s2">) : -</span><span class="s4">1</span>
					<span class="s2">);</span>
				<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
					<span class="s1">mappings</span><span class="s2">.</span><span class="s1">addUneditedChunk</span><span class="s2">(</span>
						<span class="s1">sourceIndex</span><span class="s2">,</span>
						<span class="s1">chunk</span><span class="s2">,</span>
						<span class="s1">magicString</span><span class="s2">.</span><span class="s1">original</span><span class="s2">,</span>
						<span class="s1">loc</span><span class="s2">,</span>
						<span class="s1">magicString</span><span class="s2">.</span><span class="s1">sourcemapLocations</span>
					<span class="s2">);</span>
				<span class="s2">}</span>
			<span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
				<span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">content</span><span class="s2">);</span>
			<span class="s2">}</span>

			<span class="s0">if </span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) { </span><span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">); }</span>
		<span class="s2">});</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">magicString</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">) {</span>
			<span class="s1">mappings</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">magicString</span><span class="s2">.</span><span class="s1">outro</span><span class="s2">);</span>
		<span class="s2">}</span>
	<span class="s2">});</span>

	<span class="s0">return </span><span class="s2">{</span>
		<span class="s1">file</span><span class="s2">: </span><span class="s1">options</span><span class="s2">.</span><span class="s1">file </span><span class="s2">? </span><span class="s1">options</span><span class="s2">.</span><span class="s1">file</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">/[/\\]/</span><span class="s2">).</span><span class="s1">pop</span><span class="s2">() : </span><span class="s0">null</span><span class="s2">,</span>
		<span class="s1">sources</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSources</span><span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">source</span><span class="s2">) {</span>
			<span class="s0">return </span><span class="s1">options</span><span class="s2">.</span><span class="s1">file </span><span class="s2">? </span><span class="s1">getRelativePath</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">file</span><span class="s2">, </span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">) : </span><span class="s1">source</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">;</span>
		<span class="s2">}),</span>
		<span class="s1">sourcesContent</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">uniqueSources</span><span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">source</span><span class="s2">) {</span>
			<span class="s0">return </span><span class="s1">options</span><span class="s2">.</span><span class="s1">includeContent </span><span class="s2">? </span><span class="s1">source</span><span class="s2">.</span><span class="s1">content </span><span class="s2">: </span><span class="s0">null</span><span class="s2">;</span>
		<span class="s2">}),</span>
		<span class="s1">names</span><span class="s2">: </span><span class="s1">names</span><span class="s2">,</span>
		<span class="s1">mappings</span><span class="s2">: </span><span class="s1">mappings</span><span class="s2">.</span><span class="s1">raw</span><span class="s2">,</span>
	<span class="s2">};</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">generateMap </span><span class="s2">= </span><span class="s0">function </span><span class="s1">generateMap </span><span class="s2">(</span><span class="s1">options</span><span class="s2">) {</span>
	<span class="s0">return new </span><span class="s1">SourceMap</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">generateDecodedMap</span><span class="s2">(</span><span class="s1">options</span><span class="s2">));</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getIndentString </span><span class="s2">= </span><span class="s0">function </span><span class="s1">getIndentString </span><span class="s2">() {</span>
	<span class="s0">var </span><span class="s1">indentStringCounts </span><span class="s2">= {};</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">source</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">indentStr </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">indentStr</span><span class="s2">;</span>

		<span class="s0">if </span><span class="s2">(</span><span class="s1">indentStr </span><span class="s2">=== </span><span class="s0">null</span><span class="s2">) { </span><span class="s0">return</span><span class="s2">; }</span>

		<span class="s0">if </span><span class="s2">(!</span><span class="s1">indentStringCounts</span><span class="s2">[</span><span class="s1">indentStr</span><span class="s2">]) { </span><span class="s1">indentStringCounts</span><span class="s2">[</span><span class="s1">indentStr</span><span class="s2">] = </span><span class="s4">0</span><span class="s2">; }</span>
		<span class="s1">indentStringCounts</span><span class="s2">[</span><span class="s1">indentStr</span><span class="s2">] += </span><span class="s4">1</span><span class="s2">;</span>
	<span class="s2">});</span>

	<span class="s0">return </span><span class="s2">(</span>
		<span class="s1">Object</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">(</span><span class="s1">indentStringCounts</span><span class="s2">).</span><span class="s1">sort</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) {</span>
			<span class="s0">return </span><span class="s1">indentStringCounts</span><span class="s2">[</span><span class="s1">a</span><span class="s2">] - </span><span class="s1">indentStringCounts</span><span class="s2">[</span><span class="s1">b</span><span class="s2">];</span>
		<span class="s2">})[</span><span class="s4">0</span><span class="s2">] || </span><span class="s3">'</span><span class="s0">\t</span><span class="s3">'</span>
	<span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">indent </span><span class="s2">= </span><span class="s0">function </span><span class="s1">indent </span><span class="s2">(</span><span class="s1">indentStr</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">this$1$1 </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>

	<span class="s0">if </span><span class="s2">(!</span><span class="s1">arguments</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
		<span class="s1">indentStr </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getIndentString</span><span class="s2">();</span>
	<span class="s2">}</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s1">indentStr </span><span class="s2">=== </span><span class="s3">''</span><span class="s2">) { </span><span class="s0">return this</span><span class="s2">; } </span><span class="s5">// noop</span>

	<span class="s0">var </span><span class="s1">trailingNewline </span><span class="s2">= !</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">|| </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">) === </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">;</span>

	<span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">i</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">separator </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">separator </span><span class="s2">!== </span><span class="s1">undefined </span><span class="s2">? </span><span class="s1">source</span><span class="s2">.</span><span class="s1">separator </span><span class="s2">: </span><span class="s1">this$1$1</span><span class="s2">.</span><span class="s1">separator</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">indentStart </span><span class="s2">= </span><span class="s1">trailingNewline </span><span class="s2">|| (</span><span class="s1">i </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s2">&amp;&amp; </span><span class="s6">/\r?\n$/</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">separator</span><span class="s2">));</span>

		<span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">indent</span><span class="s2">(</span><span class="s1">indentStr</span><span class="s2">, {</span>
			<span class="s1">exclude</span><span class="s2">: </span><span class="s1">source</span><span class="s2">.</span><span class="s1">indentExclusionRanges</span><span class="s2">,</span>
			<span class="s1">indentStart</span><span class="s2">: </span><span class="s1">indentStart</span><span class="s2">, </span><span class="s5">//: trailingNewline || /\r?\n$/.test( separator )  //true///\r?\n/.test( separator )</span>
		<span class="s2">});</span>

		<span class="s1">trailingNewline </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">lastChar</span><span class="s2">() === </span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">;</span>
	<span class="s2">});</span>

	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">) {</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">=</span>
			<span class="s1">indentStr </span><span class="s2">+</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">/^[^\n]/gm</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">match</span><span class="s2">, </span><span class="s1">index</span><span class="s2">) {</span>
				<span class="s0">return </span><span class="s1">index </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s2">? </span><span class="s1">indentStr </span><span class="s2">+ </span><span class="s1">match </span><span class="s2">: </span><span class="s1">match</span><span class="s2">;</span>
			<span class="s2">});</span>
	<span class="s2">}</span>

	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">prepend </span><span class="s2">= </span><span class="s0">function </span><span class="s1">prepend </span><span class="s2">(</span><span class="s1">str</span><span class="s2">) {</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s1">str </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">;</span>
	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">toString </span><span class="s2">= </span><span class="s0">function </span><span class="s1">toString </span><span class="s2">() {</span>
		<span class="s0">var </span><span class="s1">this$1$1 </span><span class="s2">= </span><span class="s0">this</span><span class="s2">;</span>

	<span class="s0">var </span><span class="s1">body </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span>
		<span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">i</span><span class="s2">) {</span>
			<span class="s0">var </span><span class="s1">separator </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">separator </span><span class="s2">!== </span><span class="s1">undefined </span><span class="s2">? </span><span class="s1">source</span><span class="s2">.</span><span class="s1">separator </span><span class="s2">: </span><span class="s1">this$1$1</span><span class="s2">.</span><span class="s1">separator</span><span class="s2">;</span>
			<span class="s0">var </span><span class="s1">str </span><span class="s2">= (</span><span class="s1">i </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s2">? </span><span class="s1">separator </span><span class="s2">: </span><span class="s3">''</span><span class="s2">) + </span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">toString</span><span class="s2">();</span>

			<span class="s0">return </span><span class="s1">str</span><span class="s2">;</span>
		<span class="s2">})</span>
		<span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">);</span>

	<span class="s0">return this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">+ </span><span class="s1">body</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">isEmpty </span><span class="s2">= </span><span class="s0">function </span><span class="s1">isEmpty </span><span class="s2">() {</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">()) { </span><span class="s0">return false</span><span class="s2">; }</span>
	<span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">.</span><span class="s1">some</span><span class="s2">(</span><span class="s0">function </span><span class="s2">(</span><span class="s1">source</span><span class="s2">) { </span><span class="s0">return </span><span class="s2">!</span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">isEmpty</span><span class="s2">(); })) { </span><span class="s0">return false</span><span class="s2">; }</span>
	<span class="s0">return true</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s0">function </span><span class="s1">length </span><span class="s2">() {</span>
	<span class="s0">return this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span>
		<span class="s0">function </span><span class="s2">(</span><span class="s1">length</span><span class="s2">, </span><span class="s1">source</span><span class="s2">) { </span><span class="s0">return </span><span class="s1">length </span><span class="s2">+ </span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">length</span><span class="s2">(); },</span>
		<span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">length</span>
	<span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimLines </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimLines </span><span class="s2">() {</span>
	<span class="s0">return this</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">(</span><span class="s3">'[</span><span class="s0">\\</span><span class="s3">r</span><span class="s0">\\</span><span class="s3">n]'</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trim </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trim </span><span class="s2">(</span><span class="s1">charType</span><span class="s2">) {</span>
	<span class="s0">return this</span><span class="s2">.</span><span class="s1">trimStart</span><span class="s2">(</span><span class="s1">charType</span><span class="s2">).</span><span class="s1">trimEnd</span><span class="s2">(</span><span class="s1">charType</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimStart </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimStart </span><span class="s2">(</span><span class="s1">charType</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">rx </span><span class="s2">= </span><span class="s0">new </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s3">'^' </span><span class="s2">+ (</span><span class="s1">charType </span><span class="s2">|| </span><span class="s3">'</span><span class="s0">\\</span><span class="s3">s'</span><span class="s2">) + </span><span class="s3">'+'</span><span class="s2">);</span>
	<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>

	<span class="s0">if </span><span class="s2">(!</span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">) {</span>
		<span class="s0">var </span><span class="s1">source</span><span class="s2">;</span>
		<span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>

		<span class="s0">do </span><span class="s2">{</span>
			<span class="s1">source </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">[</span><span class="s1">i</span><span class="s2">++];</span>
			<span class="s0">if </span><span class="s2">(!</span><span class="s1">source</span><span class="s2">) {</span>
				<span class="s0">break</span><span class="s2">;</span>
			<span class="s2">}</span>
		<span class="s2">} </span><span class="s0">while </span><span class="s2">(!</span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">trimStartAborted</span><span class="s2">(</span><span class="s1">charType</span><span class="s2">));</span>
	<span class="s2">}</span>

	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">Bundle</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">trimEnd </span><span class="s2">= </span><span class="s0">function </span><span class="s1">trimEnd </span><span class="s2">(</span><span class="s1">charType</span><span class="s2">) {</span>
	<span class="s0">var </span><span class="s1">rx </span><span class="s2">= </span><span class="s0">new </span><span class="s1">RegExp</span><span class="s2">((</span><span class="s1">charType </span><span class="s2">|| </span><span class="s3">'</span><span class="s0">\\</span><span class="s3">s'</span><span class="s2">) + </span><span class="s3">'+$'</span><span class="s2">);</span>

	<span class="s0">var </span><span class="s1">source</span><span class="s2">;</span>
	<span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">;</span>

	<span class="s0">do </span><span class="s2">{</span>
		<span class="s1">source </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sources</span><span class="s2">[</span><span class="s1">i</span><span class="s2">--];</span>
		<span class="s0">if </span><span class="s2">(!</span><span class="s1">source</span><span class="s2">) {</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">intro </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">intro</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">rx</span><span class="s2">, </span><span class="s3">''</span><span class="s2">);</span>
			<span class="s0">break</span><span class="s2">;</span>
		<span class="s2">}</span>
	<span class="s2">} </span><span class="s0">while </span><span class="s2">(!</span><span class="s1">source</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">trimEndAborted</span><span class="s2">(</span><span class="s1">charType</span><span class="s2">));</span>

	<span class="s0">return this</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s0">export </span><span class="s2">{ </span><span class="s1">Bundle</span><span class="s2">, </span><span class="s1">SourceMap</span><span class="s2">, </span><span class="s1">MagicString </span><span class="s2">as </span><span class="s0">default </span><span class="s2">};</span>
<span class="s5">//# sourceMappingURL=magic-string.es.js.map</span>
</pre>
</body>
</html>