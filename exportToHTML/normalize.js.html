<html>
<head>
<title>normalize.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
.s7 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
normalize.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>

<span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">exports</span><span class="s1">, </span><span class="s0">'__esModule'</span><span class="s1">, {</span>
  <span class="s2">value</span><span class="s1">: </span><span class="s3">true</span>
<span class="s1">});</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">default </span><span class="s1">= </span><span class="s2">normalize</span><span class="s1">;</span>

<span class="s3">function </span><span class="s2">_crypto</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'crypto'</span><span class="s1">);</span>

  <span class="s2">_crypto </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">path</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">_interopRequireWildcard</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'path'</span><span class="s1">));</span>

  <span class="s2">path </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_chalk</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'chalk'</span><span class="s1">));</span>

  <span class="s2">_chalk </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_deepmerge</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'deepmerge'</span><span class="s1">));</span>

  <span class="s2">_deepmerge </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_glob</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'glob'</span><span class="s1">);</span>

  <span class="s2">_glob </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_gracefulFs</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'graceful-fs'</span><span class="s1">);</span>

  <span class="s2">_gracefulFs </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_micromatch</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'micromatch'</span><span class="s1">));</span>

  <span class="s2">_micromatch </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_jestRegexUtil</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jest-regex-util'</span><span class="s1">);</span>

  <span class="s2">_jestRegexUtil </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_jestResolve</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">_interopRequireWildcard</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jest-resolve'</span><span class="s1">));</span>

  <span class="s2">_jestResolve </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_jestUtil</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jest-util'</span><span class="s1">);</span>

  <span class="s2">_jestUtil </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_jestValidate</span><span class="s1">() {</span>
  <span class="s3">const </span><span class="s2">data </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jest-validate'</span><span class="s1">);</span>

  <span class="s2">_jestValidate </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">var </span><span class="s2">_Defaults </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./Defaults'</span><span class="s1">));</span>

<span class="s3">var </span><span class="s2">_Deprecated </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./Deprecated'</span><span class="s1">));</span>

<span class="s3">var </span><span class="s2">_ReporterValidationErrors </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./ReporterValidationErrors'</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">_ValidConfig </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./ValidConfig'</span><span class="s1">));</span>

<span class="s3">var </span><span class="s2">_color </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./color'</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">_constants </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./constants'</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">_getMaxWorkers </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./getMaxWorkers'</span><span class="s1">));</span>

<span class="s3">var </span><span class="s2">_setFromArgv </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./setFromArgv'</span><span class="s1">));</span>

<span class="s3">var </span><span class="s2">_utils </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./utils'</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">_validatePattern </span><span class="s1">= </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./validatePattern'</span><span class="s1">));</span>

<span class="s3">function </span><span class="s2">_interopRequireDefault</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s2">obj </span><span class="s1">&amp;&amp; </span><span class="s2">obj</span><span class="s1">.</span><span class="s2">__esModule </span><span class="s1">? </span><span class="s2">obj </span><span class="s1">: {</span><span class="s3">default</span><span class="s1">: </span><span class="s2">obj</span><span class="s1">};</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_getRequireWildcardCache</span><span class="s1">(</span><span class="s2">nodeInterop</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">WeakMap </span><span class="s1">!== </span><span class="s0">'function'</span><span class="s1">) </span><span class="s3">return null</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">cacheBabelInterop </span><span class="s1">= </span><span class="s3">new </span><span class="s2">WeakMap</span><span class="s1">();</span>
  <span class="s3">var </span><span class="s2">cacheNodeInterop </span><span class="s1">= </span><span class="s3">new </span><span class="s2">WeakMap</span><span class="s1">();</span>
  <span class="s3">return </span><span class="s1">(</span><span class="s2">_getRequireWildcardCache </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">nodeInterop</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">nodeInterop </span><span class="s1">? </span><span class="s2">cacheNodeInterop </span><span class="s1">: </span><span class="s2">cacheBabelInterop</span><span class="s1">;</span>
  <span class="s1">})(</span><span class="s2">nodeInterop</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">_interopRequireWildcard</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">, </span><span class="s2">nodeInterop</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">nodeInterop </span><span class="s1">&amp;&amp; </span><span class="s2">obj </span><span class="s1">&amp;&amp; </span><span class="s2">obj</span><span class="s1">.</span><span class="s2">__esModule</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">obj</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">obj </span><span class="s1">=== </span><span class="s3">null </span><span class="s1">|| (</span><span class="s3">typeof </span><span class="s2">obj </span><span class="s1">!== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">obj </span><span class="s1">!== </span><span class="s0">'function'</span><span class="s1">)) {</span>
    <span class="s3">return </span><span class="s1">{</span><span class="s3">default</span><span class="s1">: </span><span class="s2">obj</span><span class="s1">};</span>
  <span class="s1">}</span>
  <span class="s3">var </span><span class="s2">cache </span><span class="s1">= </span><span class="s2">_getRequireWildcardCache</span><span class="s1">(</span><span class="s2">nodeInterop</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">cache </span><span class="s1">&amp;&amp; </span><span class="s2">cache</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">)) {</span>
    <span class="s3">return </span><span class="s2">cache</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s3">var </span><span class="s2">newObj </span><span class="s1">= {};</span>
  <span class="s3">var </span><span class="s2">hasPropertyDescriptor </span><span class="s1">=</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty </span><span class="s1">&amp;&amp; </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">getOwnPropertyDescriptor</span><span class="s1">;</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">obj</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">!== </span><span class="s0">'default' </span><span class="s1">&amp;&amp; </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">, </span><span class="s2">key</span><span class="s1">)) {</span>
      <span class="s3">var </span><span class="s2">desc </span><span class="s1">= </span><span class="s2">hasPropertyDescriptor</span>
        <span class="s1">? </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">getOwnPropertyDescriptor</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">, </span><span class="s2">key</span><span class="s1">)</span>
        <span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">desc </span><span class="s1">&amp;&amp; (</span><span class="s2">desc</span><span class="s1">.</span><span class="s2">get </span><span class="s1">|| </span><span class="s2">desc</span><span class="s1">.</span><span class="s2">set</span><span class="s1">)) {</span>
        <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">newObj</span><span class="s1">, </span><span class="s2">key</span><span class="s1">, </span><span class="s2">desc</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">newObj</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">obj</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s2">newObj</span><span class="s1">.</span><span class="s2">default </span><span class="s1">= </span><span class="s2">obj</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">cache</span><span class="s1">) {</span>
    <span class="s2">cache</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">, </span><span class="s2">newObj</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">newObj</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* Copyright (c) Facebook, Inc. and its affiliates. All Rights Reserved.</span>
 <span class="s4">*</span>
 <span class="s4">* This source code is licensed under the MIT license found in the</span>
 <span class="s4">* LICENSE file in the root directory of this source tree.</span>
 <span class="s4">*/</span>
<span class="s3">const </span><span class="s2">ERROR </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">BULLET</span><span class="s1">}</span><span class="s0">Validation Error`</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">PRESET_EXTENSIONS </span><span class="s1">= [</span><span class="s0">'.json'</span><span class="s1">, </span><span class="s0">'.js'</span><span class="s1">, </span><span class="s0">'.cjs'</span><span class="s1">, </span><span class="s0">'.mjs'</span><span class="s1">];</span>
<span class="s3">const </span><span class="s2">PRESET_NAME </span><span class="s1">= </span><span class="s0">'jest-preset'</span><span class="s1">;</span>

<span class="s3">const </span><span class="s2">createConfigError </span><span class="s1">= </span><span class="s2">message </span><span class="s1">=&gt;</span>
  <span class="s3">new </span><span class="s1">(</span><span class="s2">_jestValidate</span><span class="s1">().</span><span class="s2">ValidationError</span><span class="s1">)(</span>
    <span class="s2">ERROR</span><span class="s1">,</span>
    <span class="s2">message</span><span class="s1">,</span>
    <span class="s2">_utils</span><span class="s1">.</span><span class="s2">DOCUMENTATION_NOTE</span>
  <span class="s1">);</span>

<span class="s3">function </span><span class="s2">verifyDirectoryExists</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">key</span><span class="s1">) {</span>
  <span class="s3">try </span><span class="s1">{</span>
    <span class="s3">const </span><span class="s2">rootStat </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_gracefulFs</span><span class="s1">().</span><span class="s2">statSync</span><span class="s1">)(</span><span class="s2">path</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">rootStat</span><span class="s1">.</span><span class="s2">isDirectory</span><span class="s1">()) {</span>
      <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
        <span class="s0">`  </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s2">path</span><span class="s1">)} </span><span class="s0">in the </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
          <span class="s2">key</span>
        <span class="s1">)} </span><span class="s0">option is not a directory.`</span>
      <span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">err </span><span class="s3">instanceof </span><span class="s2">_jestValidate</span><span class="s1">().</span><span class="s2">ValidationError</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">err</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">.</span><span class="s2">code </span><span class="s1">=== </span><span class="s0">'ENOENT'</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
        <span class="s0">`  Directory </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
          <span class="s2">path</span>
        <span class="s1">)} </span><span class="s0">in the </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s2">key</span><span class="s1">)} </span><span class="s0">option was not found.`</span>
      <span class="s1">);</span>
    <span class="s1">} </span><span class="s6">// Not sure in which cases `statSync` can throw, so let's just show the underlying error to the user</span>

    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
      <span class="s0">`  Got an error trying to find </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
        <span class="s2">path</span>
      <span class="s1">)} </span><span class="s0">in the </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s2">key</span><span class="s1">)} </span><span class="s0">option.</span><span class="s3">\n\n  </span><span class="s0">Error was: </span><span class="s2">$</span><span class="s1">{</span>
        <span class="s2">err</span><span class="s1">.</span><span class="s2">message</span>
      <span class="s1">}</span><span class="s0">`</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">} </span><span class="s6">// TS 3.5 forces us to split these into 2</span>

<span class="s3">const </span><span class="s2">mergeModuleNameMapperWithPreset </span><span class="s1">= (</span><span class="s2">options</span><span class="s1">, </span><span class="s2">preset</span><span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">[</span><span class="s0">'moduleNameMapper'</span><span class="s1">] &amp;&amp; </span><span class="s2">preset</span><span class="s1">[</span><span class="s0">'moduleNameMapper'</span><span class="s1">]) {</span>
    <span class="s2">options</span><span class="s1">[</span><span class="s0">'moduleNameMapper'</span><span class="s1">] = {</span>
      <span class="s2">...options</span><span class="s1">[</span><span class="s0">'moduleNameMapper'</span><span class="s1">],</span>
      <span class="s2">...preset</span><span class="s1">[</span><span class="s0">'moduleNameMapper'</span><span class="s1">],</span>
      <span class="s2">...options</span><span class="s1">[</span><span class="s0">'moduleNameMapper'</span><span class="s1">]</span>
    <span class="s1">};</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">mergeTransformWithPreset </span><span class="s1">= (</span><span class="s2">options</span><span class="s1">, </span><span class="s2">preset</span><span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">[</span><span class="s0">'transform'</span><span class="s1">] &amp;&amp; </span><span class="s2">preset</span><span class="s1">[</span><span class="s0">'transform'</span><span class="s1">]) {</span>
    <span class="s2">options</span><span class="s1">[</span><span class="s0">'transform'</span><span class="s1">] = {</span>
      <span class="s2">...options</span><span class="s1">[</span><span class="s0">'transform'</span><span class="s1">],</span>
      <span class="s2">...preset</span><span class="s1">[</span><span class="s0">'transform'</span><span class="s1">],</span>
      <span class="s2">...options</span><span class="s1">[</span><span class="s0">'transform'</span><span class="s1">]</span>
    <span class="s1">};</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">mergeGlobalsWithPreset </span><span class="s1">= (</span><span class="s2">options</span><span class="s1">, </span><span class="s2">preset</span><span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">[</span><span class="s0">'globals'</span><span class="s1">] &amp;&amp; </span><span class="s2">preset</span><span class="s1">[</span><span class="s0">'globals'</span><span class="s1">]) {</span>
    <span class="s2">options</span><span class="s1">[</span><span class="s0">'globals'</span><span class="s1">] = (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_deepmerge</span><span class="s1">().</span><span class="s2">default</span><span class="s1">)(</span>
      <span class="s2">preset</span><span class="s1">[</span><span class="s0">'globals'</span><span class="s1">],</span>
      <span class="s2">options</span><span class="s1">[</span><span class="s0">'globals'</span><span class="s1">]</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">setupPreset </span><span class="s1">= </span><span class="s2">async </span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">optionsPreset</span><span class="s1">) =&gt; {</span>
  <span class="s3">let </span><span class="s2">preset</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">presetPath </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">replaceRootDirInPath</span><span class="s1">)(</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">,</span>
    <span class="s2">optionsPreset</span>
  <span class="s1">);</span>

  <span class="s3">const </span><span class="s2">presetModule </span><span class="s1">= </span><span class="s2">_jestResolve</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">findNodeModule</span><span class="s1">(</span>
    <span class="s2">presetPath</span><span class="s1">.</span><span class="s2">startsWith</span><span class="s1">(</span><span class="s0">'.'</span><span class="s1">)</span>
      <span class="s1">? </span><span class="s2">presetPath</span>
      <span class="s1">: </span><span class="s2">path</span><span class="s1">().</span><span class="s2">join</span><span class="s1">(</span><span class="s2">presetPath</span><span class="s1">, </span><span class="s2">PRESET_NAME</span><span class="s1">),</span>
    <span class="s1">{</span>
      <span class="s2">basedir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">,</span>
      <span class="s2">extensions</span><span class="s1">: </span><span class="s2">PRESET_EXTENSIONS</span>
    <span class="s1">}</span>
  <span class="s1">);</span>

  <span class="s3">try </span><span class="s1">{</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">presetModule</span><span class="s1">) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Cannot find module '</span><span class="s2">$</span><span class="s1">{</span><span class="s2">presetPath</span><span class="s1">}</span><span class="s0">'`</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s6">// Force re-evaluation to support multiple projects</span>

    <span class="s3">try </span><span class="s1">{</span>
      <span class="s3">delete </span><span class="s2">require</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">[</span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">presetModule</span><span class="s1">)];</span>
    <span class="s1">} </span><span class="s3">catch </span><span class="s1">{}</span>

    <span class="s2">preset </span><span class="s1">= </span><span class="s3">await </span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestUtil</span><span class="s1">().</span><span class="s2">requireOrImportModule</span><span class="s1">)(</span><span class="s2">presetModule</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">error </span><span class="s3">instanceof </span><span class="s2">SyntaxError </span><span class="s1">|| </span><span class="s2">error </span><span class="s3">instanceof </span><span class="s2">TypeError</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
        <span class="s0">`  Preset </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s2">presetPath</span><span class="s1">)} </span><span class="s0">is invalid:</span><span class="s3">\n\n  </span><span class="s2">$</span><span class="s1">{</span>
          <span class="s2">error</span><span class="s1">.</span><span class="s2">message</span>
        <span class="s1">}</span><span class="s3">\n  </span><span class="s2">$</span><span class="s1">{</span><span class="s2">error</span><span class="s1">.</span><span class="s2">stack</span><span class="s1">}</span><span class="s0">`</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">error</span><span class="s1">.</span><span class="s2">message</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'Cannot find module'</span><span class="s1">)) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">error</span><span class="s1">.</span><span class="s2">message</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s2">presetPath</span><span class="s1">)) {</span>
        <span class="s3">const </span><span class="s2">preset </span><span class="s1">= </span><span class="s2">_jestResolve</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">findNodeModule</span><span class="s1">(</span><span class="s2">presetPath</span><span class="s1">, {</span>
          <span class="s2">basedir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
        <span class="s1">});</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">preset</span><span class="s1">) {</span>
          <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
            <span class="s0">`  Module </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
              <span class="s2">presetPath</span>
            <span class="s1">)} </span><span class="s0">should have &quot;jest-preset.js&quot; or &quot;jest-preset.json&quot; file at the root.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
          <span class="s0">`  Preset </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s2">presetPath</span><span class="s1">)} </span><span class="s0">not found.`</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
        <span class="s0">`  Missing dependency in </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s2">presetPath</span><span class="s1">)}</span><span class="s0">:</span><span class="s3">\n\n  </span><span class="s2">$</span><span class="s1">{</span>
          <span class="s2">error</span><span class="s1">.</span><span class="s2">message</span>
        <span class="s1">}</span><span class="s3">\n  </span><span class="s2">$</span><span class="s1">{</span><span class="s2">error</span><span class="s1">.</span><span class="s2">stack</span><span class="s1">}</span><span class="s0">`</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
      <span class="s0">`  An unknown error occurred in </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
        <span class="s2">presetPath</span>
      <span class="s1">)}</span><span class="s0">:</span><span class="s3">\n\n  </span><span class="s2">$</span><span class="s1">{</span><span class="s2">error</span><span class="s1">.</span><span class="s2">message</span><span class="s1">}</span><span class="s3">\n  </span><span class="s2">$</span><span class="s1">{</span><span class="s2">error</span><span class="s1">.</span><span class="s2">stack</span><span class="s1">}</span><span class="s0">`</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupFiles</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">setupFiles </span><span class="s1">= (</span><span class="s2">preset</span><span class="s1">.</span><span class="s2">setupFiles </span><span class="s1">|| []).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupFiles</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupFilesAfterEnv</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">setupFilesAfterEnv </span><span class="s1">= (</span><span class="s2">preset</span><span class="s1">.</span><span class="s2">setupFilesAfterEnv </span><span class="s1">|| []).</span><span class="s2">concat</span><span class="s1">(</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">setupFilesAfterEnv</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">modulePathIgnorePatterns </span><span class="s1">&amp;&amp; </span><span class="s2">preset</span><span class="s1">.</span><span class="s2">modulePathIgnorePatterns</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">modulePathIgnorePatterns </span><span class="s1">= </span><span class="s2">preset</span><span class="s1">.</span><span class="s2">modulePathIgnorePatterns</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">modulePathIgnorePatterns</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">mergeModuleNameMapperWithPreset</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">preset</span><span class="s1">);</span>
  <span class="s2">mergeTransformWithPreset</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">preset</span><span class="s1">);</span>
  <span class="s2">mergeGlobalsWithPreset</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">preset</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s1">{</span><span class="s2">...preset</span><span class="s1">, </span><span class="s2">...options</span><span class="s1">};</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">setupBabelJest </span><span class="s1">= </span><span class="s2">options </span><span class="s1">=&gt; {</span>
  <span class="s3">const </span><span class="s2">transform </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">transform</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">babelJest</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">transform</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">customJSPattern </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">transform</span><span class="s1">).</span><span class="s2">find</span><span class="s1">(</span><span class="s2">pattern </span><span class="s1">=&gt; {</span>
      <span class="s3">const </span><span class="s2">regex </span><span class="s1">= </span><span class="s3">new </span><span class="s2">RegExp</span><span class="s1">(</span><span class="s2">pattern</span><span class="s1">);</span>
      <span class="s3">return </span><span class="s2">regex</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s0">'a.js'</span><span class="s1">) || </span><span class="s2">regex</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s0">'a.jsx'</span><span class="s1">);</span>
    <span class="s1">});</span>
    <span class="s3">const </span><span class="s2">customTSPattern </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">transform</span><span class="s1">).</span><span class="s2">find</span><span class="s1">(</span><span class="s2">pattern </span><span class="s1">=&gt; {</span>
      <span class="s3">const </span><span class="s2">regex </span><span class="s1">= </span><span class="s3">new </span><span class="s2">RegExp</span><span class="s1">(</span><span class="s2">pattern</span><span class="s1">);</span>
      <span class="s3">return </span><span class="s2">regex</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s0">'a.ts'</span><span class="s1">) || </span><span class="s2">regex</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s0">'a.tsx'</span><span class="s1">);</span>
    <span class="s1">});</span>
    <span class="s1">[</span><span class="s2">customJSPattern</span><span class="s1">, </span><span class="s2">customTSPattern</span><span class="s1">].</span><span class="s2">forEach</span><span class="s1">(</span><span class="s2">pattern </span><span class="s1">=&gt; {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">pattern</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">customTransformer </span><span class="s1">= </span><span class="s2">transform</span><span class="s1">[</span><span class="s2">pattern</span><span class="s1">];</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">customTransformer</span><span class="s1">)) {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">customTransformer</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s0">'babel-jest'</span><span class="s1">) {</span>
            <span class="s2">babelJest </span><span class="s1">= </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s0">'babel-jest'</span><span class="s1">);</span>
            <span class="s2">customTransformer</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] = </span><span class="s2">babelJest</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">customTransformer</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'babel-jest'</span><span class="s1">)) {</span>
            <span class="s2">babelJest </span><span class="s1">= </span><span class="s2">customTransformer</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">customTransformer </span><span class="s1">=== </span><span class="s0">'babel-jest'</span><span class="s1">) {</span>
            <span class="s2">babelJest </span><span class="s1">= </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s0">'babel-jest'</span><span class="s1">);</span>
            <span class="s2">transform</span><span class="s1">[</span><span class="s2">pattern</span><span class="s1">] = </span><span class="s2">babelJest</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">customTransformer</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'babel-jest'</span><span class="s1">)) {</span>
            <span class="s2">babelJest </span><span class="s1">= </span><span class="s2">customTransformer</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s2">babelJest </span><span class="s1">= </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s0">'babel-jest'</span><span class="s1">);</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">transform </span><span class="s1">= {</span>
      <span class="s1">[</span><span class="s2">_constants</span><span class="s1">.</span><span class="s2">DEFAULT_JS_PATTERN</span><span class="s1">]: </span><span class="s2">babelJest</span>
    <span class="s1">};</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">normalizeCollectCoverageOnlyFrom </span><span class="s1">= (</span><span class="s2">options</span><span class="s1">, </span><span class="s2">key</span><span class="s1">) =&gt; {</span>
  <span class="s3">const </span><span class="s2">initialCollectCoverageFrom </span><span class="s1">= </span><span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
  <span class="s3">const </span><span class="s2">collectCoverageOnlyFrom </span><span class="s1">= </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">initialCollectCoverageFrom</span><span class="s1">)</span>
    <span class="s1">? </span><span class="s2">initialCollectCoverageFrom </span><span class="s6">// passed from argv</span>
    <span class="s1">: </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">initialCollectCoverageFrom</span><span class="s1">); </span><span class="s6">// passed from options</span>

  <span class="s3">return </span><span class="s2">collectCoverageOnlyFrom</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">map</span><span class="s1">, </span><span class="s2">filePath</span><span class="s1">) =&gt; {</span>
    <span class="s2">filePath </span><span class="s1">= </span><span class="s2">path</span><span class="s1">().</span><span class="s2">resolve</span><span class="s1">(</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">,</span>
      <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">replaceRootDirInPath</span><span class="s1">)(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s2">filePath</span><span class="s1">)</span>
    <span class="s1">);</span>
    <span class="s2">map</span><span class="s1">[</span><span class="s2">filePath</span><span class="s1">] = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">map</span><span class="s1">;</span>
  <span class="s1">}, </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">));</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">normalizeCollectCoverageFrom </span><span class="s1">= (</span><span class="s2">options</span><span class="s1">, </span><span class="s2">key</span><span class="s1">) =&gt; {</span>
  <span class="s3">const </span><span class="s2">initialCollectCoverageFrom </span><span class="s1">= </span><span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
  <span class="s3">let </span><span class="s2">value</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">initialCollectCoverageFrom</span><span class="s1">) {</span>
    <span class="s2">value </span><span class="s1">= [];</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">initialCollectCoverageFrom</span><span class="s1">)) {</span>
    <span class="s3">try </span><span class="s1">{</span>
      <span class="s2">value </span><span class="s1">= </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">initialCollectCoverageFrom</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">catch </span><span class="s1">{}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] &amp;&amp; !</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) {</span>
      <span class="s2">value </span><span class="s1">= [</span><span class="s2">initialCollectCoverageFrom</span><span class="s1">];</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s2">value </span><span class="s1">= </span><span class="s2">initialCollectCoverageFrom</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s2">value </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">filePath </span><span class="s1">=&gt;</span>
      <span class="s2">filePath</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/^(!?)(&lt;rootDir&gt;\/)(.*)/</span><span class="s1">, </span><span class="s0">'$1$3'</span><span class="s1">)</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">value</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">normalizeUnmockedModulePathPatterns </span><span class="s1">= (</span>
  <span class="s2">options</span><span class="s1">,</span>
  <span class="s2">key </span><span class="s6">// _replaceRootDirTags is specifically well-suited for substituting</span>
<span class="s1">) =&gt;</span>
  <span class="s6">// &lt;rootDir&gt; in paths (it deals with properly interpreting relative path</span>
  <span class="s6">// separators, etc).</span>
  <span class="s6">//</span>
  <span class="s6">// For patterns, direct global substitution is far more ideal, so we</span>
  <span class="s6">// special case substitutions for patterns here.</span>
  <span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">].</span><span class="s2">map</span><span class="s1">(</span><span class="s2">pattern </span><span class="s1">=&gt;</span>
    <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestRegexUtil</span><span class="s1">().</span><span class="s2">replacePathSepForRegex</span><span class="s1">)(</span>
      <span class="s2">pattern</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/&lt;rootDir&gt;/g</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">)</span>
    <span class="s1">)</span>
  <span class="s1">);</span>

<span class="s3">const </span><span class="s2">normalizePreprocessor </span><span class="s1">= </span><span class="s2">options </span><span class="s1">=&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">scriptPreprocessor </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">transform</span><span class="s1">) {</span>
    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span><span class="s0">`  Options: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
      <span class="s0">'scriptPreprocessor'</span>
    <span class="s1">)} </span><span class="s0">and </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s0">'transform'</span><span class="s1">)} </span><span class="s0">cannot be used together. 
  Please change your configuration to only use </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
    <span class="s0">'transform'</span>
  <span class="s1">)}</span><span class="s0">.`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">preprocessorIgnorePatterns </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">transformIgnorePatterns</span><span class="s1">) {</span>
    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span><span class="s0">`  Options </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
      <span class="s0">'preprocessorIgnorePatterns'</span>
    <span class="s1">)} </span><span class="s0">and </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
      <span class="s0">'transformIgnorePatterns'</span>
    <span class="s1">)} </span><span class="s0">cannot be used together. 
  Please change your configuration to only use </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
    <span class="s0">'transformIgnorePatterns'</span>
  <span class="s1">)}</span><span class="s0">.`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">scriptPreprocessor</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">transform </span><span class="s1">= {</span>
      <span class="s0">'.*'</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">scriptPreprocessor</span>
    <span class="s1">};</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">preprocessorIgnorePatterns</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">transformIgnorePatterns </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">preprocessorIgnorePatterns</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">scriptPreprocessor</span><span class="s1">;</span>
  <span class="s3">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">preprocessorIgnorePatterns</span><span class="s1">;</span>
  <span class="s3">return </span><span class="s2">options</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">normalizeMissingOptions </span><span class="s1">= (</span><span class="s2">options</span><span class="s1">, </span><span class="s2">configPath</span><span class="s1">, </span><span class="s2">projectIndex</span><span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">name</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_crypto</span><span class="s1">().</span><span class="s2">createHash</span><span class="s1">)(</span><span class="s0">'md5'</span><span class="s1">)</span>
      <span class="s1">.</span><span class="s2">update</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">) </span><span class="s6">// In case we load config from some path that has the same root dir</span>
      <span class="s1">.</span><span class="s2">update</span><span class="s1">(</span><span class="s2">configPath </span><span class="s1">|| </span><span class="s0">''</span><span class="s1">)</span>
      <span class="s1">.</span><span class="s2">update</span><span class="s1">(</span><span class="s2">String</span><span class="s1">(</span><span class="s2">projectIndex</span><span class="s1">))</span>
      <span class="s1">.</span><span class="s2">digest</span><span class="s1">(</span><span class="s0">'hex'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupFiles</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">setupFiles </span><span class="s1">= [];</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">options</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">normalizeRootDir </span><span class="s1">= </span><span class="s2">options </span><span class="s1">=&gt; {</span>
  <span class="s6">// Assert that there *is* a rootDir</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">) {</span>
    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
      <span class="s0">`  Configuration option </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
        <span class="s0">'rootDir'</span>
      <span class="s1">)} </span><span class="s0">must be specified.`</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir </span><span class="s1">= </span><span class="s2">path</span><span class="s1">().</span><span class="s2">normalize</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">);</span>

  <span class="s3">try </span><span class="s1">{</span>
    <span class="s6">// try to resolve windows short paths, ignoring errors (permission errors, mostly)</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestUtil</span><span class="s1">().</span><span class="s2">tryRealpath</span><span class="s1">)(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">{</span>
    <span class="s6">// ignored</span>
  <span class="s1">}</span>

  <span class="s2">verifyDirectoryExists</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s0">'rootDir'</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s1">{</span><span class="s2">...options</span><span class="s1">, </span><span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">};</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">normalizeReporters </span><span class="s1">= </span><span class="s2">options </span><span class="s1">=&gt; {</span>
  <span class="s3">const </span><span class="s2">reporters </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">reporters</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">reporters </span><span class="s1">|| !</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">reporters</span><span class="s1">)) {</span>
    <span class="s3">return </span><span class="s2">options</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_ReporterValidationErrors</span><span class="s1">.</span><span class="s2">validateReporters</span><span class="s1">)(</span><span class="s2">reporters</span><span class="s1">);</span>
  <span class="s2">options</span><span class="s1">.</span><span class="s2">reporters </span><span class="s1">= </span><span class="s2">reporters</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">reporterConfig </span><span class="s1">=&gt; {</span>
    <span class="s3">const </span><span class="s2">normalizedReporterConfig </span><span class="s1">=</span>
      <span class="s3">typeof </span><span class="s2">reporterConfig </span><span class="s1">=== </span><span class="s0">'string' </span><span class="s6">// if reporter config is a string, we wrap it in an array</span>
        <span class="s1">? </span><span class="s6">// and pass an empty object for options argument, to normalize</span>
          <span class="s6">// the shape.</span>
          <span class="s1">[</span><span class="s2">reporterConfig</span><span class="s1">, {}]</span>
        <span class="s1">: </span><span class="s2">reporterConfig</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">reporterPath </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">replaceRootDirInPath</span><span class="s1">)(</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">,</span>
      <span class="s2">normalizedReporterConfig</span><span class="s1">[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">reporterPath </span><span class="s1">!== </span><span class="s2">_constants</span><span class="s1">.</span><span class="s2">DEFAULT_REPORTER_LABEL</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">reporter </span><span class="s1">= </span><span class="s2">_jestResolve</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">findNodeModule</span><span class="s1">(</span><span class="s2">reporterPath</span><span class="s1">, {</span>
        <span class="s2">basedir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
      <span class="s1">});</span>

      <span class="s3">if </span><span class="s1">(!</span><span class="s2">reporter</span><span class="s1">) {</span>
        <span class="s3">throw new </span><span class="s1">(</span><span class="s2">_jestResolve</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">ModuleNotFoundError</span><span class="s1">)(</span>
          <span class="s0">'Could not resolve a module for a custom reporter.</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`  Module name: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">reporterPath</span><span class="s1">}</span><span class="s0">`</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">normalizedReporterConfig</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] = </span><span class="s2">reporter</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">normalizedReporterConfig</span><span class="s1">;</span>
  <span class="s1">});</span>
  <span class="s3">return </span><span class="s2">options</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">buildTestPathPattern </span><span class="s1">= </span><span class="s2">argv </span><span class="s1">=&gt; {</span>
  <span class="s3">const </span><span class="s2">patterns </span><span class="s1">= [];</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">argv</span><span class="s1">.</span><span class="s2">_</span><span class="s1">) {</span>
    <span class="s2">patterns</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">...argv</span><span class="s1">.</span><span class="s2">_</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">argv</span><span class="s1">.</span><span class="s2">testPathPattern</span><span class="s1">) {</span>
    <span class="s2">patterns</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">...argv</span><span class="s1">.</span><span class="s2">testPathPattern</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">replacePosixSep </span><span class="s1">= </span><span class="s2">pattern </span><span class="s1">=&gt; {</span>
    <span class="s6">// yargs coerces positional args into numbers</span>
    <span class="s3">const </span><span class="s2">patternAsString </span><span class="s1">= </span><span class="s2">pattern</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">();</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">path</span><span class="s1">().</span><span class="s2">sep </span><span class="s1">=== </span><span class="s0">'/'</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s2">patternAsString</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">patternAsString</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/\//g</span><span class="s1">, </span><span class="s0">'</span><span class="s3">\\\\</span><span class="s0">'</span><span class="s1">);</span>
  <span class="s1">};</span>

  <span class="s3">const </span><span class="s2">testPathPattern </span><span class="s1">= </span><span class="s2">patterns</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">replacePosixSep</span><span class="s1">).</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'|'</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">((</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_validatePattern</span><span class="s1">.</span><span class="s2">default</span><span class="s1">)(</span><span class="s2">testPathPattern</span><span class="s1">)) {</span>
    <span class="s3">return </span><span class="s2">testPathPattern</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s2">showTestPathPatternError</span><span class="s1">(</span><span class="s2">testPathPattern</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">showTestPathPatternError </span><span class="s1">= </span><span class="s2">testPathPattern </span><span class="s1">=&gt; {</span>
  <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestUtil</span><span class="s1">().</span><span class="s2">clearLine</span><span class="s1">)(</span><span class="s2">process</span><span class="s1">.</span><span class="s2">stdout</span><span class="s1">); </span><span class="s6">// eslint-disable-next-line no-console</span>

  <span class="s2">console</span><span class="s1">.</span><span class="s2">log</span><span class="s1">(</span>
    <span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">red</span><span class="s1">(</span>
      <span class="s0">`  Invalid testPattern </span><span class="s2">$</span><span class="s1">{</span><span class="s2">testPathPattern</span><span class="s1">} </span><span class="s0">supplied. ` </span><span class="s1">+</span>
        <span class="s0">'Running all tests instead.'</span>
    <span class="s1">)</span>
  <span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">function </span><span class="s2">validateExtensionsToTreatAsEsm</span><span class="s1">(</span><span class="s2">extensionsToTreatAsEsm</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">extensionsToTreatAsEsm </span><span class="s1">|| </span><span class="s2">extensionsToTreatAsEsm</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s3">return</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">function </span><span class="s2">printConfig</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">string </span><span class="s1">= </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">ext </span><span class="s1">=&gt; </span><span class="s0">`'</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ext</span><span class="s1">}</span><span class="s0">'`</span><span class="s1">).</span><span class="s2">join</span><span class="s1">(</span><span class="s0">', '</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s0">`extensionsToTreatAsEsm: [</span><span class="s2">$</span><span class="s1">{</span><span class="s2">string</span><span class="s1">}</span><span class="s0">]`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">extensionWithoutDot </span><span class="s1">= </span><span class="s2">extensionsToTreatAsEsm</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span>
    <span class="s2">ext </span><span class="s1">=&gt; !</span><span class="s2">ext</span><span class="s1">.</span><span class="s2">startsWith</span><span class="s1">(</span><span class="s0">'.'</span><span class="s1">)</span>
  <span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">extensionWithoutDot</span><span class="s1">) {</span>
    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span><span class="s0">`  Option: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printConfig</span><span class="s1">(</span>
      <span class="s2">extensionsToTreatAsEsm</span>
    <span class="s1">)} </span><span class="s0">includes a string that does not start with a period (</span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
      <span class="s0">'.'</span>
    <span class="s1">)}</span><span class="s0">). 
  Please change your configuration to </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printConfig</span><span class="s1">(</span>
    <span class="s2">extensionsToTreatAsEsm</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">ext </span><span class="s1">=&gt; (</span><span class="s2">ext</span><span class="s1">.</span><span class="s2">startsWith</span><span class="s1">(</span><span class="s0">'.'</span><span class="s1">) ? </span><span class="s2">ext </span><span class="s1">: </span><span class="s0">`.</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ext</span><span class="s1">}</span><span class="s0">`</span><span class="s1">))</span>
  <span class="s1">)}</span><span class="s0">.`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">extensionsToTreatAsEsm</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'.js'</span><span class="s1">)) {</span>
    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
      <span class="s0">`  Option: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printConfig</span><span class="s1">(</span>
        <span class="s2">extensionsToTreatAsEsm</span>
      <span class="s1">)} </span><span class="s0">includes </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
        <span class="s0">&quot;'.js'&quot;</span>
      <span class="s1">)} </span><span class="s0">which is always inferred based on </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
        <span class="s0">'type'</span>
      <span class="s1">)} </span><span class="s0">in its nearest </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s0">'package.json'</span><span class="s1">)}</span><span class="s0">.`</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">extensionsToTreatAsEsm</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'.cjs'</span><span class="s1">)) {</span>
    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
      <span class="s0">`  Option: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printConfig</span><span class="s1">(</span>
        <span class="s2">extensionsToTreatAsEsm</span>
      <span class="s1">)} </span><span class="s0">includes </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
        <span class="s0">&quot;'.cjs'&quot;</span>
      <span class="s1">)} </span><span class="s0">which is always treated as CommonJS.`</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">extensionsToTreatAsEsm</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'.mjs'</span><span class="s1">)) {</span>
    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
      <span class="s0">`  Option: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printConfig</span><span class="s1">(</span>
        <span class="s2">extensionsToTreatAsEsm</span>
      <span class="s1">)} </span><span class="s0">includes </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
        <span class="s0">&quot;'.mjs'&quot;</span>
      <span class="s1">)} </span><span class="s0">which is always treated as an ECMAScript Module.`</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">async </span><span class="s3">function </span><span class="s2">normalize</span><span class="s1">(</span>
  <span class="s2">initialOptions</span><span class="s1">,</span>
  <span class="s2">argv</span><span class="s1">,</span>
  <span class="s2">configPath</span><span class="s1">,</span>
  <span class="s2">projectIndex </span><span class="s1">= </span><span class="s2">Infinity</span>
<span class="s1">) {</span>
  <span class="s3">var </span><span class="s2">_options$haste</span><span class="s1">, </span><span class="s2">_argv$_</span><span class="s1">;</span>

  <span class="s3">const </span><span class="s1">{</span><span class="s2">hasDeprecationWarnings</span><span class="s1">} = (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestValidate</span><span class="s1">().</span><span class="s2">validate</span><span class="s1">)(</span>
    <span class="s2">initialOptions</span><span class="s1">,</span>
    <span class="s1">{</span>
      <span class="s2">comment</span><span class="s1">: </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">DOCUMENTATION_NOTE</span><span class="s1">,</span>
      <span class="s2">deprecatedConfig</span><span class="s1">: </span><span class="s2">_Deprecated</span><span class="s1">.</span><span class="s2">default</span><span class="s1">,</span>
      <span class="s2">exampleConfig</span><span class="s1">: </span><span class="s2">_ValidConfig</span><span class="s1">.</span><span class="s2">default</span><span class="s1">,</span>
      <span class="s2">recursiveDenylist</span><span class="s1">: [</span>
        <span class="s0">'collectCoverageOnlyFrom'</span><span class="s1">, </span><span class="s6">// 'coverageThreshold' allows to use 'global' and glob strings on the same</span>
        <span class="s6">// level, there's currently no way we can deal with such config</span>
        <span class="s0">'coverageThreshold'</span><span class="s1">,</span>
        <span class="s0">'globals'</span><span class="s1">,</span>
        <span class="s0">'moduleNameMapper'</span><span class="s1">,</span>
        <span class="s0">'testEnvironmentOptions'</span><span class="s1">,</span>
        <span class="s0">'transform'</span>
      <span class="s1">]</span>
    <span class="s1">}</span>
  <span class="s1">);</span>
  <span class="s3">let </span><span class="s2">options </span><span class="s1">= </span><span class="s2">normalizePreprocessor</span><span class="s1">(</span>
    <span class="s2">normalizeReporters</span><span class="s1">(</span>
      <span class="s2">normalizeMissingOptions</span><span class="s1">(</span>
        <span class="s2">normalizeRootDir</span><span class="s1">((</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_setFromArgv</span><span class="s1">.</span><span class="s2">default</span><span class="s1">)(</span><span class="s2">initialOptions</span><span class="s1">, </span><span class="s2">argv</span><span class="s1">)),</span>
        <span class="s2">configPath</span><span class="s1">,</span>
        <span class="s2">projectIndex</span>
      <span class="s1">)</span>
    <span class="s1">)</span>
  <span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">preset</span><span class="s1">) {</span>
    <span class="s2">options </span><span class="s1">= </span><span class="s3">await </span><span class="s2">setupPreset</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">preset</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupFilesAfterEnv</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">setupFilesAfterEnv </span><span class="s1">= [];</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">setupTestFrameworkScriptFile </span><span class="s1">&amp;&amp;</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">setupFilesAfterEnv</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">0</span>
  <span class="s1">) {</span>
    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span><span class="s0">`  Options: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
      <span class="s0">'setupTestFrameworkScriptFile'</span>
    <span class="s1">)} </span><span class="s0">and </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
      <span class="s0">'setupFilesAfterEnv'</span>
    <span class="s1">)} </span><span class="s0">cannot be used together. 
  Please change your configuration to only use </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
    <span class="s0">'setupFilesAfterEnv'</span>
  <span class="s1">)}</span><span class="s0">.`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupTestFrameworkScriptFile</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">setupFilesAfterEnv</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupTestFrameworkScriptFile</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">options</span><span class="s1">.</span><span class="s2">testEnvironment </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestResolve</span><span class="s1">().</span><span class="s2">resolveTestEnvironment</span><span class="s1">)({</span>
    <span class="s2">requireResolveFunction</span><span class="s1">: </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">,</span>
    <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">,</span>
    <span class="s2">testEnvironment</span><span class="s1">:</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">testEnvironment </span><span class="s1">||</span>
      <span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">_Defaults</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">testEnvironment</span><span class="s1">)</span>
  <span class="s1">});</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">roots </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">testPathDirs</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">roots </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">testPathDirs</span><span class="s1">;</span>
    <span class="s3">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">testPathDirs</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">roots</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">roots </span><span class="s1">= [</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span>
    <span class="s1">!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">testRunner </span><span class="s1">||</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">testRunner </span><span class="s1">=== </span><span class="s0">'circus' </span><span class="s1">||</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">testRunner </span><span class="s1">=== </span><span class="s0">'jest-circus'</span>
  <span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">testRunner </span><span class="s1">= </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s0">'jest-circus/runner'</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">testRunner </span><span class="s1">=== </span><span class="s0">'jasmine2'</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">testRunner </span><span class="s1">= </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s0">'jest-jasmine2'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">coverageDirectory</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">coverageDirectory </span><span class="s1">= </span><span class="s2">path</span><span class="s1">().</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s0">'coverage'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">setupBabelJest</span><span class="s1">(</span><span class="s2">options</span><span class="s1">); </span><span class="s6">// TODO: Type this properly</span>

  <span class="s3">const </span><span class="s2">newOptions </span><span class="s1">= {</span><span class="s2">..._Defaults</span><span class="s1">.</span><span class="s2">default</span><span class="s1">};</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">)(</span><span class="s3">null</span><span class="s1">, {</span>
      <span class="s2">filePath</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">,</span>
      <span class="s2">key</span><span class="s1">: </span><span class="s0">'resolver'</span><span class="s1">,</span>
      <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">validateExtensionsToTreatAsEsm</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">extensionsToTreatAsEsm</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">watchman </span><span class="s1">== </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">watchman </span><span class="s1">= </span><span class="s2">_Defaults</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">watchman</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">optionKeys </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
  <span class="s2">optionKeys</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">newOptions</span><span class="s1">, </span><span class="s2">key</span><span class="s1">) =&gt; {</span>
    <span class="s6">// The resolver has been resolved separately; skip it</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">=== </span><span class="s0">'resolver'</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s2">newOptions</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s6">// This is cheating, because it claims that all keys of InitialOptions are Required.</span>
    <span class="s6">// We only really know it's Required for oldOptions[key], not for oldOptions.someOtherKey,</span>
    <span class="s6">// so oldOptions[key] is the only way it should be used.</span>

    <span class="s3">const </span><span class="s2">oldOptions </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">value</span><span class="s1">;</span>

    <span class="s3">switch </span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
      <span class="s3">case </span><span class="s0">'collectCoverageOnlyFrom'</span><span class="s1">:</span>
        <span class="s2">value </span><span class="s1">= </span><span class="s2">normalizeCollectCoverageOnlyFrom</span><span class="s1">(</span><span class="s2">oldOptions</span><span class="s1">, </span><span class="s2">key</span><span class="s1">);</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'setupFiles'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'setupFilesAfterEnv'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'snapshotSerializers'</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s3">const </span><span class="s2">option </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
          <span class="s2">value </span><span class="s1">=</span>
            <span class="s2">option </span><span class="s1">&amp;&amp;</span>
            <span class="s2">option</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">filePath </span><span class="s1">=&gt;</span>
              <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">)(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">, {</span>
                <span class="s2">filePath</span><span class="s1">,</span>
                <span class="s2">key</span><span class="s1">,</span>
                <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
              <span class="s1">})</span>
            <span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'modulePaths'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'roots'</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s3">const </span><span class="s2">option </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
          <span class="s2">value </span><span class="s1">=</span>
            <span class="s2">option </span><span class="s1">&amp;&amp;</span>
            <span class="s2">option</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">filePath </span><span class="s1">=&gt;</span>
              <span class="s2">path</span><span class="s1">().</span><span class="s2">resolve</span><span class="s1">(</span>
                <span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">,</span>
                <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">replaceRootDirInPath</span><span class="s1">)(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s2">filePath</span><span class="s1">)</span>
              <span class="s1">)</span>
            <span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'collectCoverageFrom'</span><span class="s1">:</span>
        <span class="s2">value </span><span class="s1">= </span><span class="s2">normalizeCollectCoverageFrom</span><span class="s1">(</span><span class="s2">oldOptions</span><span class="s1">, </span><span class="s2">key</span><span class="s1">);</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'cacheDirectory'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'coverageDirectory'</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s3">const </span><span class="s2">option </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
          <span class="s2">value </span><span class="s1">=</span>
            <span class="s2">option </span><span class="s1">&amp;&amp;</span>
            <span class="s2">path</span><span class="s1">().</span><span class="s2">resolve</span><span class="s1">(</span>
              <span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">,</span>
              <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">replaceRootDirInPath</span><span class="s1">)(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s2">option</span><span class="s1">)</span>
            <span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'dependencyExtractor'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'globalSetup'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'globalTeardown'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'moduleLoader'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'snapshotResolver'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testResultsProcessor'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testRunner'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'filter'</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s3">const </span><span class="s2">option </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
          <span class="s2">value </span><span class="s1">=</span>
            <span class="s2">option </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">)(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">, {</span>
              <span class="s2">filePath</span><span class="s1">: </span><span class="s2">option</span><span class="s1">,</span>
              <span class="s2">key</span><span class="s1">,</span>
              <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
            <span class="s1">});</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'runner'</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s3">const </span><span class="s2">option </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
          <span class="s2">value </span><span class="s1">=</span>
            <span class="s2">option </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestResolve</span><span class="s1">().</span><span class="s2">resolveRunner</span><span class="s1">)(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">, {</span>
              <span class="s2">filePath</span><span class="s1">: </span><span class="s2">option</span><span class="s1">,</span>
              <span class="s2">requireResolveFunction</span><span class="s1">: </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">,</span>
              <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
            <span class="s1">});</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'prettierPath'</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s6">// We only want this to throw if &quot;prettierPath&quot; is explicitly passed</span>
          <span class="s6">// from config or CLI, and the requested path isn't found. Otherwise we</span>
          <span class="s6">// set it to null and throw an error lazily when it is used.</span>
          <span class="s3">const </span><span class="s2">option </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
          <span class="s2">value </span><span class="s1">=</span>
            <span class="s2">option </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">)(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">, {</span>
              <span class="s2">filePath</span><span class="s1">: </span><span class="s2">option</span><span class="s1">,</span>
              <span class="s2">key</span><span class="s1">,</span>
              <span class="s2">optional</span><span class="s1">: </span><span class="s2">option </span><span class="s1">=== </span><span class="s2">_Defaults</span><span class="s1">.</span><span class="s2">default</span><span class="s1">[</span><span class="s2">key</span><span class="s1">],</span>
              <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
            <span class="s1">});</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'moduleNameMapper'</span><span class="s1">:</span>
        <span class="s3">const </span><span class="s2">moduleNameMapper </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
        <span class="s2">value </span><span class="s1">=</span>
          <span class="s2">moduleNameMapper </span><span class="s1">&amp;&amp;</span>
          <span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">moduleNameMapper</span><span class="s1">).</span><span class="s2">map</span><span class="s1">(</span><span class="s2">regex </span><span class="s1">=&gt; {</span>
            <span class="s3">const </span><span class="s2">item </span><span class="s1">= </span><span class="s2">moduleNameMapper </span><span class="s1">&amp;&amp; </span><span class="s2">moduleNameMapper</span><span class="s1">[</span><span class="s2">regex</span><span class="s1">];</span>
            <span class="s3">return </span><span class="s1">(</span>
              <span class="s2">item </span><span class="s1">&amp;&amp; [</span>
                <span class="s2">regex</span><span class="s1">,</span>
                <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">_replaceRootDirTags</span><span class="s1">)(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s2">item</span><span class="s1">)</span>
              <span class="s1">]</span>
            <span class="s1">);</span>
          <span class="s1">});</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'transform'</span><span class="s1">:</span>
        <span class="s3">const </span><span class="s2">transform </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
        <span class="s2">value </span><span class="s1">=</span>
          <span class="s2">transform </span><span class="s1">&amp;&amp;</span>
          <span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">transform</span><span class="s1">).</span><span class="s2">map</span><span class="s1">(</span><span class="s2">regex </span><span class="s1">=&gt; {</span>
            <span class="s3">const </span><span class="s2">transformElement </span><span class="s1">= </span><span class="s2">transform</span><span class="s1">[</span><span class="s2">regex</span><span class="s1">];</span>
            <span class="s3">return </span><span class="s1">[</span>
              <span class="s2">regex</span><span class="s1">,</span>
              <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">)(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">, {</span>
                <span class="s2">filePath</span><span class="s1">: </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">transformElement</span><span class="s1">)</span>
                  <span class="s1">? </span><span class="s2">transformElement</span><span class="s1">[</span><span class="s5">0</span><span class="s1">]</span>
                  <span class="s1">: </span><span class="s2">transformElement</span><span class="s1">,</span>
                <span class="s2">key</span><span class="s1">,</span>
                <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
              <span class="s1">}),</span>
              <span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">transformElement</span><span class="s1">) ? </span><span class="s2">transformElement</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] : {}</span>
            <span class="s1">];</span>
          <span class="s1">});</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'coveragePathIgnorePatterns'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'modulePathIgnorePatterns'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testPathIgnorePatterns'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'transformIgnorePatterns'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'watchPathIgnorePatterns'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'unmockedModulePathPatterns'</span><span class="s1">:</span>
        <span class="s2">value </span><span class="s1">= </span><span class="s2">normalizeUnmockedModulePathPatterns</span><span class="s1">(</span><span class="s2">oldOptions</span><span class="s1">, </span><span class="s2">key</span><span class="s1">);</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'haste'</span><span class="s1">:</span>
        <span class="s2">value </span><span class="s1">= {</span><span class="s2">...oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">]};</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">hasteImplModulePath </span><span class="s1">!= </span><span class="s3">null</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">resolvedHasteImpl </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">)(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">, {</span>
            <span class="s2">filePath</span><span class="s1">: (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">replaceRootDirInPath</span><span class="s1">)(</span>
              <span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">,</span>
              <span class="s2">value</span><span class="s1">.</span><span class="s2">hasteImplModulePath</span>
            <span class="s1">),</span>
            <span class="s2">key</span><span class="s1">: </span><span class="s0">'haste.hasteImplModulePath'</span><span class="s1">,</span>
            <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
          <span class="s1">});</span>
          <span class="s2">value</span><span class="s1">.</span><span class="s2">hasteImplModulePath </span><span class="s1">= </span><span class="s2">resolvedHasteImpl </span><span class="s1">|| </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'projects'</span><span class="s1">:</span>
        <span class="s2">value </span><span class="s1">= (</span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] || [])</span>
          <span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">project </span><span class="s1">=&gt;</span>
            <span class="s3">typeof </span><span class="s2">project </span><span class="s1">=== </span><span class="s0">'string'</span>
              <span class="s1">? (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">_replaceRootDirTags</span><span class="s1">)(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s2">project</span><span class="s1">)</span>
              <span class="s1">: </span><span class="s2">project</span>
          <span class="s1">)</span>
          <span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">projects</span><span class="s1">, </span><span class="s2">project</span><span class="s1">) =&gt; {</span>
            <span class="s6">// Project can be specified as globs. If a glob matches any files,</span>
            <span class="s6">// We expand it to these paths. If not, we keep the original path</span>
            <span class="s6">// for the future resolution.</span>
            <span class="s3">const </span><span class="s2">globMatches </span><span class="s1">=</span>
              <span class="s3">typeof </span><span class="s2">project </span><span class="s1">=== </span><span class="s0">'string' </span><span class="s1">? (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_glob</span><span class="s1">().</span><span class="s2">sync</span><span class="s1">)(</span><span class="s2">project</span><span class="s1">) : [];</span>
            <span class="s3">return </span><span class="s2">projects</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">globMatches</span><span class="s1">.</span><span class="s2">length </span><span class="s1">? </span><span class="s2">globMatches </span><span class="s1">: </span><span class="s2">project</span><span class="s1">);</span>
          <span class="s1">}, []);</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'moduleDirectories'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testMatch'</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s3">const </span><span class="s2">replacedRootDirTags </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">_replaceRootDirTags</span><span class="s1">)(</span>
            <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">escapeGlobCharacters</span><span class="s1">)(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">),</span>
            <span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">]</span>
          <span class="s1">);</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">replacedRootDirTags</span><span class="s1">) {</span>
            <span class="s2">value </span><span class="s1">= </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">replacedRootDirTags</span><span class="s1">)</span>
              <span class="s1">? </span><span class="s2">replacedRootDirTags</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">_jestUtil</span><span class="s1">().</span><span class="s2">replacePathSepForGlob</span><span class="s1">)</span>
              <span class="s1">: (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestUtil</span><span class="s1">().</span><span class="s2">replacePathSepForGlob</span><span class="s1">)(</span><span class="s2">replacedRootDirTags</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s2">value </span><span class="s1">= </span><span class="s2">replacedRootDirTags</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'testRegex'</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s3">const </span><span class="s2">option </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
          <span class="s2">value </span><span class="s1">= </span><span class="s2">option</span>
            <span class="s1">? (</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">option</span><span class="s1">) ? </span><span class="s2">option </span><span class="s1">: [</span><span class="s2">option</span><span class="s1">]).</span><span class="s2">map</span><span class="s1">(</span>
                <span class="s2">_jestRegexUtil</span><span class="s1">().</span><span class="s2">replacePathSepForRegex</span>
              <span class="s1">)</span>
            <span class="s1">: [];</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'moduleFileExtensions'</span><span class="s1">: {</span>
        <span class="s2">value </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>

        <span class="s3">if </span><span class="s1">(</span>
          <span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) &amp;&amp; </span><span class="s6">// If it's the wrong type, it can throw at a later time</span>
          <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">runner </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">||</span>
            <span class="s2">options</span><span class="s1">.</span><span class="s2">runner </span><span class="s1">=== </span><span class="s2">_Defaults</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">runner</span><span class="s1">) &amp;&amp; </span><span class="s6">// Only require 'js' for the default jest-runner</span>
          <span class="s1">!</span><span class="s2">value</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'js'</span><span class="s1">)</span>
        <span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">errorMessage </span><span class="s1">=</span>
            <span class="s0">&quot;  moduleFileExtensions must include 'js':</span><span class="s3">\n</span><span class="s0">&quot; </span><span class="s1">+</span>
            <span class="s0">'  but instead received:</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`    </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">.</span><span class="s2">red</span><span class="s1">(</span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">value</span><span class="s1">))}</span><span class="s0">`</span><span class="s1">; </span><span class="s6">// If `js` is not included, any dependency Jest itself injects into</span>
          <span class="s6">// the environment, like jasmine or sourcemap-support, will need to</span>
          <span class="s6">// `require` its modules with a file extension. This is not plausible</span>
          <span class="s6">// in the long run, so it's way easier to just fail hard early.</span>
          <span class="s6">// We might consider throwing if `json` is missing as well, as it's a</span>
          <span class="s6">// fair assumption from modules that they can do</span>
          <span class="s6">// `require('some-package/package') without the trailing `.json` as it</span>
          <span class="s6">// works in Node normally.</span>

          <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
            <span class="s2">errorMessage </span><span class="s1">+</span>
              <span class="s0">&quot;</span><span class="s3">\n  </span><span class="s0">Please change your configuration to include 'js'.&quot;</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">break</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">case </span><span class="s0">'bail'</span><span class="s1">: {</span>
        <span class="s3">const </span><span class="s2">bail </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">bail </span><span class="s1">=== </span><span class="s0">'boolean'</span><span class="s1">) {</span>
          <span class="s2">value </span><span class="s1">= </span><span class="s2">bail </span><span class="s1">? </span><span class="s5">1 </span><span class="s1">: </span><span class="s5">0</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">bail </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
          <span class="s2">value </span><span class="s1">= </span><span class="s5">1</span><span class="s1">; </span><span class="s6">// If Jest is invoked as `jest --bail someTestPattern` then need to</span>
          <span class="s6">// move the pattern from the `bail` configuration and into `argv._`</span>
          <span class="s6">// to be processed as an extra parameter</span>

          <span class="s2">argv</span><span class="s1">.</span><span class="s2">_</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">bail</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">value </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
        <span class="s1">}</span>

        <span class="s3">break</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">case </span><span class="s0">'displayName'</span><span class="s1">: {</span>
        <span class="s3">const </span><span class="s2">displayName </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
        <span class="s4">/**</span>
         <span class="s4">* Ensuring that displayName shape is correct here so that the</span>
         <span class="s4">* reporters can trust the shape of the data</span>
         <span class="s4">*/</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">displayName </span><span class="s1">=== </span><span class="s0">'object'</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s1">{</span><span class="s2">name</span><span class="s1">, </span><span class="s2">color</span><span class="s1">} = </span><span class="s2">displayName</span><span class="s1">;</span>

          <span class="s3">if </span><span class="s1">(</span>
            <span class="s1">!</span><span class="s2">name </span><span class="s1">||</span>
            <span class="s1">!</span><span class="s2">color </span><span class="s1">||</span>
            <span class="s3">typeof </span><span class="s2">name </span><span class="s1">!== </span><span class="s0">'string' </span><span class="s1">||</span>
            <span class="s3">typeof </span><span class="s2">color </span><span class="s1">!== </span><span class="s0">'string'</span>
          <span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">errorMessage </span><span class="s1">=</span>
              <span class="s0">`  Option &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
                <span class="s0">'displayName'</span>
              <span class="s1">)}</span><span class="s0">&quot; must be of type:</span><span class="s3">\n\n</span><span class="s0">` </span><span class="s1">+</span>
              <span class="s0">'  {</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+</span>
              <span class="s0">'    name: string;</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+</span>
              <span class="s0">'    color: string;</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+</span>
              <span class="s0">'  }</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
            <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span><span class="s2">errorMessage</span><span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s2">value </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">value </span><span class="s1">= {</span>
            <span class="s2">color</span><span class="s1">: (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_color</span><span class="s1">.</span><span class="s2">getDisplayNameColor</span><span class="s1">)(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">runner</span><span class="s1">),</span>
            <span class="s2">name</span><span class="s1">: </span><span class="s2">displayName</span>
          <span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s3">break</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">case </span><span class="s0">'testTimeout'</span><span class="s1">: {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] &lt; </span><span class="s5">0</span><span class="s1">) {</span>
          <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
            <span class="s0">`  Option &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span>
              <span class="s0">'testTimeout'</span>
            <span class="s1">)}</span><span class="s0">&quot; must be a natural number.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">value </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">case </span><span class="s0">'automock'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'cache'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'changedSince'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'changedFilesWithAncestor'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'clearMocks'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'collectCoverage'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'coverageProvider'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'coverageReporters'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'coverageThreshold'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'detectLeaks'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'detectOpenHandles'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'errorOnDeprecated'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'expand'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'extensionsToTreatAsEsm'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'extraGlobals'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'globals'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'findRelatedTests'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'forceCoverageMatch'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'forceExit'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'injectGlobals'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'lastCommit'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'listTests'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'logHeapUsage'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'maxConcurrency'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'name'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'noStackTrace'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'notify'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'notifyMode'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'onlyChanged'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'onlyFailures'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'outputFile'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'passWithNoTests'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'replname'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'reporters'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'resetMocks'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'resetModules'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'restoreMocks'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'rootDir'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'runTestsByPath'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'silent'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'skipFilter'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'skipNodeResolution'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'slowTestThreshold'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'snapshotFormat'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testEnvironment'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testEnvironmentOptions'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testFailureExitCode'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testLocationInResults'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testNamePattern'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'testURL'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'timers'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'useStderr'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'verbose'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'watch'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'watchAll'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'watchman'</span><span class="s1">:</span>
        <span class="s2">value </span><span class="s1">= </span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'watchPlugins'</span><span class="s1">:</span>
        <span class="s2">value </span><span class="s1">= (</span><span class="s2">oldOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] || []).</span><span class="s2">map</span><span class="s1">(</span><span class="s2">watchPlugin </span><span class="s1">=&gt; {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">watchPlugin </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s1">{</span>
              <span class="s2">config</span><span class="s1">: {},</span>
              <span class="s2">path</span><span class="s1">: (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestResolve</span><span class="s1">().</span><span class="s2">resolveWatchPlugin</span><span class="s1">)(</span>
                <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">,</span>
                <span class="s1">{</span>
                  <span class="s2">filePath</span><span class="s1">: </span><span class="s2">watchPlugin</span><span class="s1">,</span>
                  <span class="s2">requireResolveFunction</span><span class="s1">: </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">,</span>
                  <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
                <span class="s1">}</span>
              <span class="s1">)</span>
            <span class="s1">};</span>
          <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s3">return </span><span class="s1">{</span>
              <span class="s2">config</span><span class="s1">: </span><span class="s2">watchPlugin</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] || {},</span>
              <span class="s2">path</span><span class="s1">: (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestResolve</span><span class="s1">().</span><span class="s2">resolveWatchPlugin</span><span class="s1">)(</span>
                <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">,</span>
                <span class="s1">{</span>
                  <span class="s2">filePath</span><span class="s1">: </span><span class="s2">watchPlugin</span><span class="s1">[</span><span class="s5">0</span><span class="s1">],</span>
                  <span class="s2">requireResolveFunction</span><span class="s1">: </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">,</span>
                  <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
                <span class="s1">}</span>
              <span class="s1">)</span>
            <span class="s1">};</span>
          <span class="s1">}</span>
        <span class="s1">});</span>
        <span class="s3">break</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s6">// @ts-expect-error: automock is missing in GlobalConfig, so what</span>

    <span class="s2">newOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">value</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">newOptions</span><span class="s1">;</span>
  <span class="s1">}, </span><span class="s2">newOptions</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">watchman </span><span class="s1">&amp;&amp;</span>
    <span class="s1">(</span><span class="s2">_options$haste </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">haste</span><span class="s1">) !== </span><span class="s3">null </span><span class="s1">&amp;&amp;</span>
    <span class="s2">_options$haste </span><span class="s1">!== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">&amp;&amp;</span>
    <span class="s2">_options$haste</span><span class="s1">.</span><span class="s2">enableSymlinks</span>
  <span class="s1">) {</span>
    <span class="s3">throw new </span><span class="s1">(</span><span class="s2">_jestValidate</span><span class="s1">().</span><span class="s2">ValidationError</span><span class="s1">)(</span>
      <span class="s0">'Validation Error'</span><span class="s1">,</span>
      <span class="s0">'haste.enableSymlinks is incompatible with watchman'</span><span class="s1">,</span>
      <span class="s0">'Either set haste.enableSymlinks to false or do not use watchman'</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">roots</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">root</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt; {</span>
    <span class="s2">verifyDirectoryExists</span><span class="s1">(</span><span class="s2">root</span><span class="s1">, </span><span class="s0">`roots[</span><span class="s2">$</span><span class="s1">{</span><span class="s2">i</span><span class="s1">}</span><span class="s0">]`</span><span class="s1">);</span>
  <span class="s1">});</span>

  <span class="s3">try </span><span class="s1">{</span>
    <span class="s6">// try to resolve windows short paths, ignoring errors (permission errors, mostly)</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">cwd </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestUtil</span><span class="s1">().</span><span class="s2">tryRealpath</span><span class="s1">)(</span><span class="s2">process</span><span class="s1">.</span><span class="s2">cwd</span><span class="s1">());</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">{</span>
    <span class="s6">// ignored</span>
  <span class="s1">}</span>

  <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">testSequencer </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestResolve</span><span class="s1">().</span><span class="s2">resolveSequencer</span><span class="s1">)(</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">resolver</span><span class="s1">,</span>
    <span class="s1">{</span>
      <span class="s2">filePath</span><span class="s1">:</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">testSequencer </span><span class="s1">||</span>
        <span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">_Defaults</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">testSequencer</span><span class="s1">),</span>
      <span class="s2">requireResolveFunction</span><span class="s1">: </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">,</span>
      <span class="s2">rootDir</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span>
    <span class="s1">}</span>
  <span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">runner </span><span class="s1">=== </span><span class="s2">_Defaults</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">runner</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">runner </span><span class="s1">= </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">runner</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">nonFlagArgs </span><span class="s1">=</span>
    <span class="s1">(</span><span class="s2">_argv$_ </span><span class="s1">= </span><span class="s2">argv</span><span class="s1">.</span><span class="s2">_</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_argv$_ </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0</span>
      <span class="s1">? </span><span class="s3">void </span><span class="s5">0</span>
      <span class="s1">: </span><span class="s2">_argv$_</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">arg </span><span class="s1">=&gt; </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">arg</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
  <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">testPathPattern </span><span class="s1">= </span><span class="s2">buildTestPathPattern</span><span class="s1">(</span><span class="s2">argv</span><span class="s1">);</span>
  <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">json </span><span class="s1">= !!</span><span class="s2">argv</span><span class="s1">.</span><span class="s2">json</span><span class="s1">;</span>
  <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">testFailureExitCode </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">testFailureExitCode</span><span class="s1">, </span><span class="s5">10</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">lastCommit </span><span class="s1">||</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">changedFilesWithAncestor </span><span class="s1">||</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">changedSince</span>
  <span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">onlyChanged </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">argv</span><span class="s1">.</span><span class="s2">all</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">onlyChanged </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">onlyFailures </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">testPathPattern</span><span class="s1">) {</span>
    <span class="s6">// When passing a test path pattern we don't want to only monitor changed</span>
    <span class="s6">// files unless `--watch` is also passed.</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">onlyChanged </span><span class="s1">= </span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">watch</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">onlyChanged</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">onlyChanged </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">lastCommit</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">lastCommit </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">onlyFailures</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">onlyFailures </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">watchAll</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">watchAll </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s6">// as unknown since it can happen. We really need to fix the types here</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">moduleNameMapper </span><span class="s1">=== </span><span class="s2">_Defaults</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">moduleNameMapper</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">moduleNameMapper </span><span class="s1">= [];</span>
  <span class="s1">}</span>

  <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">updateSnapshot </span><span class="s1">=</span>
    <span class="s2">argv</span><span class="s1">.</span><span class="s2">ci </span><span class="s1">&amp;&amp; !</span><span class="s2">argv</span><span class="s1">.</span><span class="s2">updateSnapshot</span>
      <span class="s1">? </span><span class="s0">'none'</span>
      <span class="s1">: </span><span class="s2">argv</span><span class="s1">.</span><span class="s2">updateSnapshot</span>
      <span class="s1">? </span><span class="s0">'all'</span>
      <span class="s1">: </span><span class="s0">'new'</span><span class="s1">;</span>
  <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">maxConcurrency </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">maxConcurrency</span><span class="s1">, </span><span class="s5">10</span><span class="s1">);</span>
  <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">maxWorkers </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_getMaxWorkers</span><span class="s1">.</span><span class="s2">default</span><span class="s1">)(</span><span class="s2">argv</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">testRegex</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">testMatch</span><span class="s1">) {</span>
    <span class="s3">throw </span><span class="s2">createConfigError</span><span class="s1">(</span>
      <span class="s0">`  Configuration options </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s0">'testMatch'</span><span class="s1">)} </span><span class="s0">and` </span><span class="s1">+</span>
        <span class="s0">` </span><span class="s2">$</span><span class="s1">{</span><span class="s2">_chalk</span><span class="s1">().</span><span class="s2">default</span><span class="s1">.</span><span class="s2">bold</span><span class="s1">(</span><span class="s0">'testRegex'</span><span class="s1">)} </span><span class="s0">cannot be used together.`</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">testRegex</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; !</span><span class="s2">options</span><span class="s1">.</span><span class="s2">testMatch</span><span class="s1">) {</span>
    <span class="s6">// Prevent the default testMatch conflicting with any explicitly</span>
    <span class="s6">// configured `testRegex` value</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">testMatch </span><span class="s1">= [];</span>
  <span class="s1">} </span><span class="s6">// If argv.json is set, coverageReporters shouldn't print a text report.</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">argv</span><span class="s1">.</span><span class="s2">json</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">coverageReporters </span><span class="s1">= (</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">coverageReporters </span><span class="s1">|| []).</span><span class="s2">filter</span><span class="s1">(</span>
      <span class="s2">reporter </span><span class="s1">=&gt; </span><span class="s2">reporter </span><span class="s1">!== </span><span class="s0">'text'</span>
    <span class="s1">);</span>
  <span class="s1">} </span><span class="s6">// If collectCoverage is enabled while using --findRelatedTests we need to</span>
  <span class="s6">// avoid having false negatives in the generated coverage report.</span>
  <span class="s6">// The following: `--findRelatedTests '/rootDir/file1.js' --coverage`</span>
  <span class="s6">// Is transformed to: `--findRelatedTests '/rootDir/file1.js' --coverage --collectCoverageFrom 'file1.js'`</span>
  <span class="s6">// where arguments to `--collectCoverageFrom` should be globs (or relative</span>
  <span class="s6">// paths to the rootDir)</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">collectCoverage </span><span class="s1">&amp;&amp; </span><span class="s2">argv</span><span class="s1">.</span><span class="s2">findRelatedTests</span><span class="s1">) {</span>
    <span class="s3">let </span><span class="s2">collectCoverageFrom </span><span class="s1">= </span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">nonFlagArgs</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">filename </span><span class="s1">=&gt; {</span>
      <span class="s2">filename </span><span class="s1">= (</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">replaceRootDirInPath</span><span class="s1">)(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
      <span class="s3">return </span><span class="s2">path</span><span class="s1">().</span><span class="s2">isAbsolute</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">)</span>
        <span class="s1">? </span><span class="s2">path</span><span class="s1">().</span><span class="s2">relative</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">)</span>
        <span class="s1">: </span><span class="s2">filename</span><span class="s1">;</span>
    <span class="s1">}); </span><span class="s6">// Don't override existing collectCoverageFrom options</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">collectCoverageFrom</span><span class="s1">) {</span>
      <span class="s2">collectCoverageFrom </span><span class="s1">= </span><span class="s2">collectCoverageFrom</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">patterns</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_micromatch</span><span class="s1">().</span><span class="s2">default</span><span class="s1">)(</span>
            <span class="s1">[</span>
              <span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">_jestUtil</span><span class="s1">().</span><span class="s2">replacePathSepForGlob</span><span class="s1">)(</span>
                <span class="s2">path</span><span class="s1">().</span><span class="s2">relative</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">rootDir</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">)</span>
              <span class="s1">)</span>
            <span class="s1">],</span>
            <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">collectCoverageFrom</span>
          <span class="s1">).</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span>
        <span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">patterns</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s1">[</span><span class="s2">...patterns</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">];</span>
      <span class="s1">}, </span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">collectCoverageFrom</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">collectCoverageFrom </span><span class="s1">= </span><span class="s2">collectCoverageFrom</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">collectCoverageFrom</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">collectCoverageFrom </span><span class="s1">= [];</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">findRelatedTests</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">findRelatedTests </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">projects</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">projects </span><span class="s1">= [];</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">extraGlobals</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">extraGlobals </span><span class="s1">= [];</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">forceExit</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">forceExit </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">newOptions</span><span class="s1">.</span><span class="s2">logHeapUsage</span><span class="s1">) {</span>
    <span class="s2">newOptions</span><span class="s1">.</span><span class="s2">logHeapUsage </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">{</span>
    <span class="s2">hasDeprecationWarnings</span><span class="s1">,</span>
    <span class="s2">options</span><span class="s1">: </span><span class="s2">newOptions</span>
  <span class="s1">};</span>
<span class="s1">}</span>
</pre>
</body>
</html>