<html>
<head>
<title>nwsapi.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #67a37c; font-style: italic;}
.s7 { color: #2aacb8;}
.s8 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
nwsapi.js</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (C) 2007-2025 Diego Perini 
 * All rights reserved. 
 * 
 * nwsapi.js - Fast CSS Selectors API Engine 
 * 
 * Author: Diego Perini &lt;diego.perini at gmail com&gt; 
 * Version: 2.2.20 
 * Created: 20070722 
 * Release: 20250322 
 * 
 * License: 
 *  https://javascript.nwbox.com/nwsapi/MIT-LICENSE 
 * Download: 
 *  https://javascript.nwbox.com/nwsapi/nwsapi.js 
 */</span>

<span class="s2">(</span><span class="s3">function </span><span class="s1">Export</span><span class="s2">(</span><span class="s1">global</span><span class="s2">, </span><span class="s1">factory</span><span class="s2">) {</span>

  <span class="s4">'use strict'</span><span class="s2">;</span>

  <span class="s3">if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">module </span><span class="s2">== </span><span class="s4">'object' </span><span class="s2">&amp;&amp; </span><span class="s3">typeof </span><span class="s1">exports </span><span class="s2">== </span><span class="s4">'object'</span><span class="s2">) {</span>
    <span class="s1">module</span><span class="s2">.</span><span class="s1">exports </span><span class="s2">= </span><span class="s1">factory</span><span class="s2">;</span>
  <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">define </span><span class="s2">== </span><span class="s4">'function' </span><span class="s2">&amp;&amp; </span><span class="s1">define</span><span class="s2">[</span><span class="s4">'amd'</span><span class="s2">]) {</span>
    <span class="s1">define</span><span class="s2">(</span><span class="s1">factory</span><span class="s2">);</span>
  <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
    <span class="s1">global</span><span class="s2">.</span><span class="s1">NW </span><span class="s2">|| (</span><span class="s1">global</span><span class="s2">.</span><span class="s1">NW </span><span class="s2">= { });</span>
    <span class="s1">global</span><span class="s2">.</span><span class="s1">NW</span><span class="s2">.</span><span class="s1">Dom </span><span class="s2">= </span><span class="s1">factory</span><span class="s2">(</span><span class="s1">global</span><span class="s2">, </span><span class="s1">Export</span><span class="s2">);</span>
  <span class="s2">}</span>

<span class="s2">})(</span><span class="s3">this</span><span class="s2">, </span><span class="s3">function </span><span class="s1">Factory</span><span class="s2">(</span><span class="s1">global</span><span class="s2">, </span><span class="s1">Export</span><span class="s2">) {</span>
  <span class="s5">/**</span>
   <span class="s5">* Generate a regex that matches a balanced set of parentheses.</span>
   <span class="s5">* Outermost parentheses are excluded so any amount of children can be handled.</span>
   <span class="s5">* See https://stackoverflow.com/a/35271017 for reference</span>
   <span class="s5">*</span>
   <span class="s5">* </span><span class="s6">@param </span><span class="s5">{number} depth</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{string}</span>
   <span class="s5">*/</span>
  <span class="s3">function </span><span class="s1">createMatchingParensRegex</span><span class="s2">(</span><span class="s1">depth</span><span class="s2">) {</span>
    <span class="s3">var </span><span class="s1">out </span><span class="s2">=  (</span><span class="s4">'</span><span class="s3">\\</span><span class="s4">([^)(]*?(?:'</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">depth</span><span class="s2">) + </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">([^)(]*?</span><span class="s3">\\</span><span class="s4">)' </span><span class="s2">+ </span><span class="s4">'[^)(]*?)*?</span><span class="s3">\\</span><span class="s4">)'</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">depth</span><span class="s2">));</span>
    <span class="s0">// remove outermost escaped parens</span>
    <span class="s3">return </span><span class="s1">out</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s7">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s7">2</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s3">var </span><span class="s1">version </span><span class="s2">= </span><span class="s4">'nwsapi-2.2.20'</span><span class="s2">,</span>

  <span class="s1">doc </span><span class="s2">= </span><span class="s1">global</span><span class="s2">.</span><span class="s1">document</span><span class="s2">,</span>
  <span class="s1">root </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">documentElement</span><span class="s2">,</span>
  <span class="s1">slice </span><span class="s2">= </span><span class="s1">Array</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">,</span>

  <span class="s1">HSP </span><span class="s2">= </span><span class="s4">'[</span><span class="s3">\\</span><span class="s4">x20</span><span class="s3">\\</span><span class="s4">t]'</span><span class="s2">,</span>
  <span class="s1">VSP </span><span class="s2">= </span><span class="s4">'[</span><span class="s3">\\</span><span class="s4">r</span><span class="s3">\\</span><span class="s4">n</span><span class="s3">\\</span><span class="s4">f]'</span><span class="s2">,</span>
  <span class="s1">WSP </span><span class="s2">= </span><span class="s4">'[</span><span class="s3">\\</span><span class="s4">x20</span><span class="s3">\\</span><span class="s4">t</span><span class="s3">\\</span><span class="s4">r</span><span class="s3">\\</span><span class="s4">n</span><span class="s3">\\</span><span class="s4">f]'</span><span class="s2">,</span>

  <span class="s1">CFG </span><span class="s2">= {</span>
    <span class="s0">// extensions</span>
    <span class="s1">operators</span><span class="s2">: </span><span class="s4">'[~*^$|]=|='</span><span class="s2">,</span>
    <span class="s1">combinators</span><span class="s2">: </span><span class="s4">'[</span><span class="s3">\\</span><span class="s4">x20</span><span class="s3">\\</span><span class="s4">t&gt;+~](?=[^&gt;+~])'</span>
  <span class="s2">},</span>

  <span class="s1">NOT </span><span class="s2">= {</span>
    <span class="s0">// not enclosed in double/single/parens/square</span>
    <span class="s1">double_enc</span><span class="s2">: </span><span class="s4">'(?=(?:[^&quot;]*[&quot;][^&quot;]*[&quot;])*[^&quot;]*$)'</span><span class="s2">,</span>
    <span class="s1">single_enc</span><span class="s2">: </span><span class="s4">&quot;(?=(?:[^']*['][^']*['])*[^']*$)&quot;</span><span class="s2">,</span>
    <span class="s1">parens_enc</span><span class="s2">: </span><span class="s4">'(?![^</span><span class="s3">\\</span><span class="s4">x28]*</span><span class="s3">\\</span><span class="s4">x29)'</span><span class="s2">,</span>
    <span class="s1">square_enc</span><span class="s2">: </span><span class="s4">'(?![^</span><span class="s3">\\</span><span class="s4">x5b]*</span><span class="s3">\\</span><span class="s4">x5d)'</span>
  <span class="s2">},</span>

  <span class="s1">REX </span><span class="s2">= {</span>
    <span class="s0">// regular expressions</span>
    <span class="s1">HasEscapes</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\\\\</span><span class="s4">'</span><span class="s2">),</span>
    <span class="s1">HexNumbers</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^[0-9a-fA-F]'</span><span class="s2">),</span>
    <span class="s1">EscOrQuote</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^</span><span class="s3">\\\\</span><span class="s4">|[</span><span class="s3">\\</span><span class="s4">x22</span><span class="s3">\\</span><span class="s4">x27]'</span><span class="s2">),</span>
    <span class="s1">RegExpChar</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'(?!</span><span class="s3">\\\\</span><span class="s4">)[</span><span class="s3">\\\\</span><span class="s4">^$.,*+?()[</span><span class="s3">\\</span><span class="s4">]{}|</span><span class="s3">\\</span><span class="s4">/]'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">),</span>
    <span class="s1">TrimSpaces</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'+|' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'+$|' </span><span class="s2">+ </span><span class="s1">VSP</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">),</span>
    <span class="s1">SplitGroup</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'(</span><span class="s3">\\</span><span class="s4">([^)]*</span><span class="s3">\\</span><span class="s4">)|</span><span class="s3">\\</span><span class="s4">[[^[]*</span><span class="s3">\\</span><span class="s4">]|</span><span class="s3">\\\\</span><span class="s4">.|[^,])+'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">),</span>
    <span class="s1">CommaGroup</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'(</span><span class="s3">\\</span><span class="s4">s*,</span><span class="s3">\\</span><span class="s4">s*)' </span><span class="s2">+ </span><span class="s1">NOT</span><span class="s2">.</span><span class="s1">square_enc </span><span class="s2">+ </span><span class="s1">NOT</span><span class="s2">.</span><span class="s1">parens_enc</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">),</span>
    <span class="s1">FixEscapes</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\\\\</span><span class="s4">([0-9a-fA-F]{1,6}' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?|.)|([</span><span class="s3">\\</span><span class="s4">x22</span><span class="s3">\\</span><span class="s4">x27])'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">),</span>
    <span class="s1">CombineWSP</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'[</span><span class="s3">\\</span><span class="s4">n</span><span class="s3">\\</span><span class="s4">r</span><span class="s3">\\</span><span class="s4">f</span><span class="s3">\\</span><span class="s4">x20]+' </span><span class="s2">+ </span><span class="s1">NOT</span><span class="s2">.</span><span class="s1">single_enc </span><span class="s2">+ </span><span class="s1">NOT</span><span class="s2">.</span><span class="s1">double_enc</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">),</span>
    <span class="s1">TabCharWSP</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'(</span><span class="s3">\\</span><span class="s4">x20?</span><span class="s3">\\</span><span class="s4">t+</span><span class="s3">\\</span><span class="s4">x20?)' </span><span class="s2">+ </span><span class="s1">NOT</span><span class="s2">.</span><span class="s1">single_enc </span><span class="s2">+ </span><span class="s1">NOT</span><span class="s2">.</span><span class="s1">double_enc</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">),</span>
    <span class="s1">PseudosWSP</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\\</span><span class="s4">s+([-+])</span><span class="s3">\\</span><span class="s4">s+' </span><span class="s2">+ </span><span class="s1">NOT</span><span class="s2">.</span><span class="s1">square_enc</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">)</span>
  <span class="s2">},</span>

  <span class="s1">STD </span><span class="s2">= {</span>
    <span class="s1">combinator</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\\</span><span class="s4">s?([&gt;+~])</span><span class="s3">\\</span><span class="s4">s?'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">),</span>
    <span class="s1">apimethods</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^(?:</span><span class="s3">\\</span><span class="s4">w+|</span><span class="s3">\\</span><span class="s4">*)</span><span class="s3">\\</span><span class="s4">|'</span><span class="s2">),</span>
    <span class="s1">namespaces</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'(</span><span class="s3">\\</span><span class="s4">*|</span><span class="s3">\\</span><span class="s4">w+)</span><span class="s3">\\</span><span class="s4">|[</span><span class="s3">\\</span><span class="s4">w-]+'</span><span class="s2">)</span>
  <span class="s2">},</span>

  <span class="s1">GROUPS </span><span class="s2">= {</span>
    <span class="s0">// pseudo-classes requiring parameters</span>
    <span class="s1">linguistic</span><span class="s2">: </span><span class="s4">'(dir|lang)(?:</span><span class="s3">\\</span><span class="s4">x28</span><span class="s3">\\</span><span class="s4">s?([-</span><span class="s3">\\</span><span class="s4">w]{2,})</span><span class="s3">\\</span><span class="s4">s?</span><span class="s3">\\</span><span class="s4">x29)'</span><span class="s2">,</span>
    <span class="s1">logicalsel</span><span class="s2">: </span><span class="s4">'(is|where|matches|not|has)(?:</span><span class="s3">\\</span><span class="s4">x28</span><span class="s3">\\</span><span class="s4">s?(' </span><span class="s2">+ </span><span class="s1">createMatchingParensRegex</span><span class="s2">(</span><span class="s7">3</span><span class="s2">) + </span><span class="s4">')</span><span class="s3">\\</span><span class="s4">s?</span><span class="s3">\\</span><span class="s4">x29)'</span><span class="s2">,</span>
    <span class="s1">treestruct</span><span class="s2">: </span><span class="s4">'(nth(?:-last)?(?:-child|-of</span><span class="s3">\\</span><span class="s4">-type))(?:</span><span class="s3">\\</span><span class="s4">x28</span><span class="s3">\\</span><span class="s4">s?(even|odd|(?:[-+]?</span><span class="s3">\\</span><span class="s4">d*)(?:n</span><span class="s3">\\</span><span class="s4">s?[-+]?</span><span class="s3">\\</span><span class="s4">s?</span><span class="s3">\\</span><span class="s4">d*)?)</span><span class="s3">\\</span><span class="s4">s?</span><span class="s3">\\</span><span class="s4">x29)'</span><span class="s2">,</span>
    <span class="s0">// pseudo-classes not requiring parameters</span>
    <span class="s1">locationpc</span><span class="s2">: </span><span class="s4">'(any</span><span class="s3">\\</span><span class="s4">-link|link|visited|target)</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s1">useraction</span><span class="s2">: </span><span class="s4">'(hover|active|focus</span><span class="s3">\\</span><span class="s4">-within|focus</span><span class="s3">\\</span><span class="s4">-visible|focus)</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s1">structural</span><span class="s2">: </span><span class="s4">'(scope|root|empty|(?:(?:first|last|only)(?:-child|</span><span class="s3">\\</span><span class="s4">-of</span><span class="s3">\\</span><span class="s4">-type)))</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s1">inputstate</span><span class="s2">: </span><span class="s4">'(enabled|disabled|read</span><span class="s3">\\</span><span class="s4">-only|read</span><span class="s3">\\</span><span class="s4">-write|placeholder</span><span class="s3">\\</span><span class="s4">-shown|default)</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s1">inputvalue</span><span class="s2">: </span><span class="s4">'(checked|indeterminate|required|optional|valid|invalid|in</span><span class="s3">\\</span><span class="s4">-range|out</span><span class="s3">\\</span><span class="s4">-of</span><span class="s3">\\</span><span class="s4">-range)</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s0">// pseudo-classes not requiring parameters and describing functional state</span>
    <span class="s1">rsrc_state</span><span class="s2">: </span><span class="s4">'(playing|paused|seeking|buffering|stalled|muted|volume-locked)</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s1">disp_state</span><span class="s2">: </span><span class="s4">'(open|closed|modal|fullscreen|picture-in-picture)</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s1">time_state</span><span class="s2">: </span><span class="s4">'(current|past|future)</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s0">// pseudo-classes for parsing only selectors</span>
    <span class="s1">pseudo_nop</span><span class="s2">: </span><span class="s4">'(autofill|-webkit</span><span class="s3">\\</span><span class="s4">-autofill)</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s0">// pseudo-elements starting with single colon (:)</span>
    <span class="s1">pseudo_sng</span><span class="s2">: </span><span class="s4">'(after|before|first</span><span class="s3">\\</span><span class="s4">-letter|first</span><span class="s3">\\</span><span class="s4">-line)</span><span class="s3">\\</span><span class="s4">b'</span><span class="s2">,</span>
    <span class="s0">// pseudo-elements starting with double colon (::)</span>
    <span class="s1">pseudo_dbl</span><span class="s2">: </span><span class="s4">':(after|before|first</span><span class="s3">\\</span><span class="s4">-letter|first</span><span class="s3">\\</span><span class="s4">-line|selection|placeholder|-webkit-[-a-zA-Z0-9]{2,})</span><span class="s3">\\</span><span class="s4">b'</span>
  <span class="s2">},</span>

  <span class="s1">Patterns </span><span class="s2">= {</span>
    <span class="s0">// pseudo-classes</span>
    <span class="s1">treestruct</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">treestruct </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">structural</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">structural </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">linguistic</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">linguistic </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">useraction</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">useraction </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">inputstate</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">inputstate </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">inputvalue</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">inputvalue </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">rsrc_state</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">rsrc_state </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">disp_state</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">disp_state </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">time_state</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">time_state </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">locationpc</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">locationpc </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">logicalsel</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">logicalsel </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">pseudo_nop</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">pseudo_nop </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">pseudo_sng</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">pseudo_sng </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s1">pseudo_dbl</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^:(?:' </span><span class="s2">+ </span><span class="s1">GROUPS</span><span class="s2">.</span><span class="s1">pseudo_dbl </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
    <span class="s0">// combinator symbols</span>
    <span class="s1">children</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?</span><span class="s3">\\</span><span class="s4">&gt;' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?(.*)'</span><span class="s2">),</span>
    <span class="s1">adjacent</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?</span><span class="s3">\\</span><span class="s4">+' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?(.*)'</span><span class="s2">),</span>
    <span class="s1">relative</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?</span><span class="s3">\\</span><span class="s4">~' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?(.*)'</span><span class="s2">),</span>
    <span class="s1">ancestor</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'+(.*)'</span><span class="s2">),</span>
   <span class="s0">// universal &amp; namespace</span>
   <span class="s1">universal</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^(</span><span class="s3">\\</span><span class="s4">*)(.*)'</span><span class="s2">),</span>
   <span class="s1">namespace</span><span class="s2">: </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^(</span><span class="s3">\\</span><span class="s4">*|[</span><span class="s3">\\</span><span class="s4">w-]+)?</span><span class="s3">\\</span><span class="s4">|(.*)'</span><span class="s2">)</span>
  <span class="s2">},</span>

  <span class="s0">// regexp to better aproximate detection of RTL languages (Arabic)</span>
  <span class="s1">RTL </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^(?:[</span><span class="s3">\\</span><span class="s4">u0627-</span><span class="s3">\\</span><span class="s4">u064a]|[</span><span class="s3">\\</span><span class="s4">u0591-</span><span class="s3">\\</span><span class="s4">u08ff]|[</span><span class="s3">\\</span><span class="s4">ufb1d-</span><span class="s3">\\</span><span class="s4">ufdfd]|[</span><span class="s3">\\</span><span class="s4">ufe70-</span><span class="s3">\\</span><span class="s4">ufefc])+$'</span><span class="s2">),</span>

  <span class="s0">// emulate firefox error strings</span>
  <span class="s1">qsNotArgs </span><span class="s2">= </span><span class="s4">'Not enough arguments'</span><span class="s2">,</span>
  <span class="s1">qsInvalid </span><span class="s2">= </span><span class="s4">' is not a valid selector'</span><span class="s2">,</span>

  <span class="s0">// detect structural pseudo-classes in selectors</span>
  <span class="s1">reNthElem </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'(:nth(?:-last)?-child)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>
  <span class="s1">reNthType </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'(:nth(?:-last)?-of-type)'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">),</span>

  <span class="s0">// placeholder for global regexp</span>
  <span class="s1">reOptimizer</span><span class="s2">,</span>
  <span class="s1">reValidator</span><span class="s2">,</span>

  <span class="s0">// special handling configuration flags</span>
  <span class="s1">Config </span><span class="s2">= {</span>
    <span class="s1">IDS_DUPES</span><span class="s2">: </span><span class="s3">true</span><span class="s2">,</span>
    <span class="s1">ANODELIST</span><span class="s2">: </span><span class="s3">false</span><span class="s2">,</span>
    <span class="s1">LOGERRORS</span><span class="s2">: </span><span class="s3">true</span><span class="s2">,</span>
    <span class="s1">USR_EVENT</span><span class="s2">: </span><span class="s3">true</span><span class="s2">,</span>
    <span class="s1">VERBOSITY</span><span class="s2">: </span><span class="s3">true</span>
  <span class="s2">},</span>

  <span class="s1">NAMESPACE</span><span class="s2">,</span>
  <span class="s1">QUIRKS_MODE</span><span class="s2">,</span>
  <span class="s1">HTML_DOCUMENT</span><span class="s2">,</span>

  <span class="s1">ATTR_STD_OPS </span><span class="s2">= {</span>
    <span class="s4">'='</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'^='</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'$='</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'|='</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'*='</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'~='</span><span class="s2">: </span><span class="s7">1</span>
  <span class="s2">},</span>

  <span class="s1">HTML_TABLE </span><span class="s2">= {</span>
    <span class="s4">'accept'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'accept-charset'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'align'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'alink'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'axis'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">,</span>
    <span class="s4">'bgcolor'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'charset'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'checked'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'clear'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'codetype'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'color'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">,</span>
    <span class="s4">'compact'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'declare'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'defer'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'dir'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'direction'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'disabled'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">,</span>
    <span class="s4">'enctype'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'face'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'frame'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'hreflang'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'http-equiv'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'lang'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">,</span>
    <span class="s4">'language'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'link'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'media'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'method'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'multiple'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'nohref'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">,</span>
    <span class="s4">'noresize'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'noshade'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'nowrap'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'readonly'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'rel'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'rev'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">,</span>
    <span class="s4">'rules'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'scope'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'scrolling'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'selected'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'shape'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'target'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">,</span>
    <span class="s4">'text'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'type'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'valign'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'valuetype'</span><span class="s2">: </span><span class="s7">1</span><span class="s2">, </span><span class="s4">'vlink'</span><span class="s2">: </span><span class="s7">1</span>
  <span class="s2">},</span>

  <span class="s1">Combinators </span><span class="s2">= { },</span>

  <span class="s1">Selectors </span><span class="s2">= { },</span>

  <span class="s1">Operators </span><span class="s2">= {</span>
     <span class="s4">'='</span><span class="s2">: { </span><span class="s1">p1</span><span class="s2">: </span><span class="s4">'^'</span><span class="s2">,</span>
            <span class="s1">p2</span><span class="s2">: </span><span class="s4">'$'</span><span class="s2">,</span>
            <span class="s1">p3</span><span class="s2">: </span><span class="s4">'true' </span><span class="s2">},</span>
    <span class="s4">'^='</span><span class="s2">: { </span><span class="s1">p1</span><span class="s2">: </span><span class="s4">'^'</span><span class="s2">,</span>
            <span class="s1">p2</span><span class="s2">: </span><span class="s4">''</span><span class="s2">,</span>
            <span class="s1">p3</span><span class="s2">: </span><span class="s4">'true' </span><span class="s2">},</span>
    <span class="s4">'$='</span><span class="s2">: { </span><span class="s1">p1</span><span class="s2">: </span><span class="s4">''</span><span class="s2">,</span>
            <span class="s1">p2</span><span class="s2">: </span><span class="s4">'$'</span><span class="s2">,</span>
            <span class="s1">p3</span><span class="s2">: </span><span class="s4">'true' </span><span class="s2">},</span>
    <span class="s4">'*='</span><span class="s2">: { </span><span class="s1">p1</span><span class="s2">: </span><span class="s4">''</span><span class="s2">,</span>
            <span class="s1">p2</span><span class="s2">: </span><span class="s4">''</span><span class="s2">,</span>
            <span class="s1">p3</span><span class="s2">: </span><span class="s4">'true' </span><span class="s2">},</span>
    <span class="s4">'|='</span><span class="s2">: { </span><span class="s1">p1</span><span class="s2">: </span><span class="s4">'^'</span><span class="s2">,</span>
            <span class="s1">p2</span><span class="s2">: </span><span class="s4">'(-|$)'</span><span class="s2">,</span>
            <span class="s1">p3</span><span class="s2">: </span><span class="s4">'true' </span><span class="s2">},</span>
    <span class="s4">'~='</span><span class="s2">: { </span><span class="s1">p1</span><span class="s2">: </span><span class="s4">'(^|</span><span class="s3">\\</span><span class="s4">s)'</span><span class="s2">,</span>
            <span class="s1">p2</span><span class="s2">: </span><span class="s4">'(</span><span class="s3">\\</span><span class="s4">s|$)'</span><span class="s2">,</span>
            <span class="s1">p3</span><span class="s2">: </span><span class="s4">'true' </span><span class="s2">}</span>
  <span class="s2">},</span>

  <span class="s1">concatCall </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">list </span><span class="s2">= </span><span class="s1">Array</span><span class="s2">(</span><span class="s1">l</span><span class="s2">);</span>
      <span class="s3">while </span><span class="s2">(</span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">i</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s3">false </span><span class="s2">=== </span><span class="s1">callback</span><span class="s2">(</span><span class="s1">list</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])) </span><span class="s3">break</span><span class="s2">;</span>
        <span class="s2">++</span><span class="s1">i</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s1">list</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s1">concatList </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">list</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">i </span><span class="s2">= -</span><span class="s7">1</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
      <span class="s3">while </span><span class="s2">(</span><span class="s1">l</span><span class="s2">--) { </span><span class="s1">list</span><span class="s2">[</span><span class="s1">list</span><span class="s2">.</span><span class="s1">length</span><span class="s2">] = </span><span class="s1">nodes</span><span class="s2">[++</span><span class="s1">i</span><span class="s2">]; }</span>
      <span class="s3">return </span><span class="s1">list</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// only define the toNodeList helper if explicitly enabled in Config,</span>
  <span class="s0">// a safety measure for headless hosts missing feature/implementation</span>
  <span class="s1">toNodeList </span><span class="s2">=</span>
    <span class="s1">Config</span><span class="s2">.</span><span class="s1">ANODELIST </span><span class="s2">== </span><span class="s3">false </span><span class="s2">?</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) { </span><span class="s3">return </span><span class="s1">x</span><span class="s2">; } :</span>
    <span class="s3">function</span><span class="s2">() {</span>
      <span class="s0">// create a DocumentFragment</span>
      <span class="s3">var </span><span class="s1">emptyNL </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">createDocumentFragment</span><span class="s2">().</span><span class="s1">childNodes</span><span class="s2">;</span>

      <span class="s0">// this is returned from a self-executing function so that</span>
      <span class="s0">// the DocumentFragment isn't repeatedly created</span>
      <span class="s3">return function</span><span class="s2">(</span><span class="s1">nodeArray</span><span class="s2">) {</span>
        <span class="s0">// check if it is already a nodelist</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">nodeArray </span><span class="s3">instanceof </span><span class="s1">global</span><span class="s2">.</span><span class="s1">NodeList</span><span class="s2">) </span><span class="s3">return </span><span class="s1">nodeArray</span><span class="s2">;</span>

        <span class="s0">// if it's a single element, wrap it in a classic array</span>
        <span class="s3">if </span><span class="s2">(!</span><span class="s1">Array</span><span class="s2">.</span><span class="s1">isArray</span><span class="s2">(</span><span class="s1">nodeArray</span><span class="s2">)) </span><span class="s1">nodeArray </span><span class="s2">= [</span><span class="s1">nodeArray</span><span class="s2">];</span>

        <span class="s0">// base an object on emptyNL</span>
        <span class="s3">var </span><span class="s1">fakeNL </span><span class="s2">= </span><span class="s1">Object</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">emptyNL</span><span class="s2">, {</span>
          <span class="s4">'length'</span><span class="s2">: {</span>
            <span class="s1">value</span><span class="s2">: </span><span class="s1">nodeArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">enumerable</span><span class="s2">: </span><span class="s3">false</span>
          <span class="s2">},</span>
          <span class="s4">'item'</span><span class="s2">: {</span>
            <span class="s4">'value'</span><span class="s2">: </span><span class="s3">function</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) {</span>
              <span class="s3">return this</span><span class="s2">[+</span><span class="s1">i </span><span class="s2">|| </span><span class="s7">0</span><span class="s2">];</span>
            <span class="s2">},</span>
            <span class="s1">enumerable</span><span class="s2">: </span><span class="s3">false</span>
          <span class="s2">}</span>
        <span class="s2">});</span>

        <span class="s0">// copy the array elemnts</span>
        <span class="s1">nodeArray</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s3">function </span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">i</span><span class="s2">) { </span><span class="s1">fakeNL</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">v</span><span class="s2">; });</span>

        <span class="s0">// return an object pretending to be a NodeList.</span>
        <span class="s3">return </span><span class="s1">fakeNL</span><span class="s2">;</span>
      <span class="s2">};</span>
    <span class="s2">}(),</span>

  <span class="s1">documentOrder </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) {</span>
      <span class="s3">if </span><span class="s2">(!</span><span class="s1">hasDupes </span><span class="s2">&amp;&amp; </span><span class="s1">a </span><span class="s2">=== </span><span class="s1">b</span><span class="s2">) {</span>
        <span class="s1">hasDupes </span><span class="s2">= </span><span class="s3">true</span><span class="s2">;</span>
        <span class="s3">return </span><span class="s7">0</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s1">a</span><span class="s2">.</span><span class="s1">compareDocumentPosition</span><span class="s2">(</span><span class="s1">b</span><span class="s2">) &amp; </span><span class="s7">4 </span><span class="s2">? -</span><span class="s7">1 </span><span class="s2">: </span><span class="s7">1</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s1">hasDupes </span><span class="s2">= </span><span class="s3">false</span><span class="s2">,</span>

  <span class="s1">unique </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= -</span><span class="s7">1</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length </span><span class="s2">+ </span><span class="s7">1</span><span class="s2">, </span><span class="s1">list </span><span class="s2">= [ ];</span>
      <span class="s3">while </span><span class="s2">(--</span><span class="s1">l</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">++] === </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]) </span><span class="s3">continue</span><span class="s2">;</span>
        <span class="s1">list</span><span class="s2">[++</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i </span><span class="s2">- </span><span class="s7">1</span><span class="s2">];</span>
      <span class="s2">}</span>
      <span class="s1">hasDupes </span><span class="s2">= </span><span class="s3">false</span><span class="s2">;</span>
      <span class="s3">return </span><span class="s1">list</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s1">switchContext </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">force</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">oldDoc </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">;</span>
      <span class="s1">doc </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">ownerDocument </span><span class="s2">|| </span><span class="s1">context</span><span class="s2">;</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">force </span><span class="s2">|| </span><span class="s1">oldDoc </span><span class="s2">!== </span><span class="s1">doc</span><span class="s2">) {</span>
        <span class="s0">// force a new check for each document change</span>
        <span class="s0">// performed before the next select operation</span>
        <span class="s1">root </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">documentElement</span><span class="s2">;</span>
        <span class="s1">HTML_DOCUMENT </span><span class="s2">= </span><span class="s1">isHTML</span><span class="s2">(</span><span class="s1">doc</span><span class="s2">);</span>
        <span class="s1">QUIRKS_MODE </span><span class="s2">= </span><span class="s1">HTML_DOCUMENT </span><span class="s2">&amp;&amp;</span>
          <span class="s1">doc</span><span class="s2">.</span><span class="s1">compatMode</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s4">'CSS'</span><span class="s2">) &lt; </span><span class="s7">0</span><span class="s2">;</span>
        <span class="s1">NAMESPACE </span><span class="s2">= </span><span class="s1">root </span><span class="s2">&amp;&amp; </span><span class="s1">root</span><span class="s2">.</span><span class="s1">namespaceURI</span><span class="s2">;</span>
        <span class="s1">Snapshot</span><span class="s2">.</span><span class="s1">doc </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">;</span>
        <span class="s1">Snapshot</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">root</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s2">(</span><span class="s1">Snapshot</span><span class="s2">.</span><span class="s1">from </span><span class="s2">= </span><span class="s1">context</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// convert single codepoint to UTF-16 encoding</span>
  <span class="s1">codePointToUTF16 </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">codePoint</span><span class="s2">) {</span>
      <span class="s0">// out of range, use replacement character</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">codePoint </span><span class="s2">&lt; </span><span class="s7">1 </span><span class="s2">|| </span><span class="s1">codePoint </span><span class="s2">&gt; </span><span class="s7">0x10ffff </span><span class="s2">||</span>
        <span class="s2">(</span><span class="s1">codePoint </span><span class="s2">&gt; </span><span class="s7">0xd7ff </span><span class="s2">&amp;&amp; </span><span class="s1">codePoint </span><span class="s2">&lt; </span><span class="s7">0xe000</span><span class="s2">)) {</span>
        <span class="s3">return </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">ufffd'</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s0">// javascript strings are UTF-16 encoded</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">codePoint </span><span class="s2">&lt; </span><span class="s7">0x10000</span><span class="s2">) {</span>
        <span class="s3">var </span><span class="s1">lowHex </span><span class="s2">= </span><span class="s4">'000' </span><span class="s2">+ </span><span class="s1">codePoint</span><span class="s2">.</span><span class="s1">toString</span><span class="s2">(</span><span class="s7">16</span><span class="s2">);</span>
        <span class="s3">return </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">u' </span><span class="s2">+ </span><span class="s1">lowHex</span><span class="s2">.</span><span class="s1">substr</span><span class="s2">(</span><span class="s1">lowHex</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s7">4</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s0">// supplementary high + low surrogates</span>
      <span class="s3">return </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">u' </span><span class="s2">+ (((</span><span class="s1">codePoint </span><span class="s2">- </span><span class="s7">0x10000</span><span class="s2">) &gt;&gt; </span><span class="s7">0x0a</span><span class="s2">) + </span><span class="s7">0xd800</span><span class="s2">).</span><span class="s1">toString</span><span class="s2">(</span><span class="s7">16</span><span class="s2">) +</span>
             <span class="s4">'</span><span class="s3">\\</span><span class="s4">u' </span><span class="s2">+ (((</span><span class="s1">codePoint </span><span class="s2">- </span><span class="s7">0x10000</span><span class="s2">) % </span><span class="s7">0x400</span><span class="s2">) + </span><span class="s7">0xdc00</span><span class="s2">).</span><span class="s1">toString</span><span class="s2">(</span><span class="s7">16</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// convert single codepoint to string</span>
  <span class="s1">stringFromCodePoint </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">codePoint</span><span class="s2">) {</span>
      <span class="s0">// out of range, use replacement character</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">codePoint </span><span class="s2">&lt; </span><span class="s7">1 </span><span class="s2">|| </span><span class="s1">codePoint </span><span class="s2">&gt; </span><span class="s7">0x10ffff </span><span class="s2">||</span>
        <span class="s2">(</span><span class="s1">codePoint </span><span class="s2">&gt; </span><span class="s7">0xd7ff </span><span class="s2">&amp;&amp; </span><span class="s1">codePoint </span><span class="s2">&lt; </span><span class="s7">0xe000</span><span class="s2">)) {</span>
        <span class="s3">return </span><span class="s4">'</span><span class="s3">\ufffd</span><span class="s4">'</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">codePoint </span><span class="s2">&lt; </span><span class="s7">0x10000</span><span class="s2">) {</span>
        <span class="s3">return </span><span class="s1">String</span><span class="s2">.</span><span class="s1">fromCharCode</span><span class="s2">(</span><span class="s1">codePoint</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s1">String</span><span class="s2">.</span><span class="s1">fromCodePoint </span><span class="s2">?</span>
        <span class="s1">String</span><span class="s2">.</span><span class="s1">fromCodePoint</span><span class="s2">(</span><span class="s1">codePoint</span><span class="s2">) :</span>
        <span class="s1">String</span><span class="s2">.</span><span class="s1">fromCharCode</span><span class="s2">(</span>
          <span class="s2">((</span><span class="s1">codePoint </span><span class="s2">- </span><span class="s7">0x10000</span><span class="s2">) &gt;&gt; </span><span class="s7">0x0a</span><span class="s2">) + </span><span class="s7">0xd800</span><span class="s2">,</span>
          <span class="s2">((</span><span class="s1">codePoint </span><span class="s2">- </span><span class="s7">0x10000</span><span class="s2">) % </span><span class="s7">0x400</span><span class="s2">) + </span><span class="s7">0xdc00</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// convert escape sequence in a CSS string or identifier</span>
  <span class="s0">// to javascript string with javascript escape sequences</span>
  <span class="s1">convertEscapes </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">str</span><span class="s2">) {</span>
      <span class="s3">return </span><span class="s1">REX</span><span class="s2">.</span><span class="s1">HasEscapes</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">str</span><span class="s2">) ?</span>
        <span class="s1">str</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">FixEscapes</span><span class="s2">,</span>
          <span class="s3">function</span><span class="s2">(</span><span class="s1">substring</span><span class="s2">, </span><span class="s1">p1</span><span class="s2">, </span><span class="s1">p2</span><span class="s2">) {</span>
            <span class="s0">// unescaped &quot; or '</span>
            <span class="s3">return </span><span class="s1">p2 </span><span class="s2">? </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">p2 </span><span class="s2">:</span>
              <span class="s0">// javascript strings are UTF-16 encoded</span>
              <span class="s1">REX</span><span class="s2">.</span><span class="s1">HexNumbers</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">p1</span><span class="s2">) ? </span><span class="s1">codePointToUTF16</span><span class="s2">(</span><span class="s1">parseInt</span><span class="s2">(</span><span class="s1">p1</span><span class="s2">, </span><span class="s7">16</span><span class="s2">)) :</span>
              <span class="s0">// \' \&quot;</span>
              <span class="s1">REX</span><span class="s2">.</span><span class="s1">EscOrQuote</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">p1</span><span class="s2">) ? </span><span class="s1">substring </span><span class="s2">:</span>
              <span class="s0">// \g \h \. \# etc</span>
              <span class="s1">p1</span><span class="s2">;</span>
          <span class="s2">}</span>
        <span class="s2">) : </span><span class="s1">str</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// convert escape sequence in a CSS string or identifier</span>
  <span class="s0">// to javascript string with characters representations</span>
  <span class="s1">unescapeIdentifier </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">str</span><span class="s2">) {</span>
      <span class="s3">return </span><span class="s1">REX</span><span class="s2">.</span><span class="s1">HasEscapes</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">str</span><span class="s2">) ?</span>
        <span class="s1">str</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">FixEscapes</span><span class="s2">,</span>
          <span class="s3">function</span><span class="s2">(</span><span class="s1">substring</span><span class="s2">, </span><span class="s1">p1</span><span class="s2">, </span><span class="s1">p2</span><span class="s2">) {</span>
            <span class="s0">// unescaped &quot; or '</span>
            <span class="s3">return </span><span class="s1">p2 </span><span class="s2">? </span><span class="s1">p2 </span><span class="s2">:</span>
              <span class="s0">// javascript strings are UTF-16 encoded</span>
              <span class="s1">REX</span><span class="s2">.</span><span class="s1">HexNumbers</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">p1</span><span class="s2">) ? </span><span class="s1">stringFromCodePoint</span><span class="s2">(</span><span class="s1">parseInt</span><span class="s2">(</span><span class="s1">p1</span><span class="s2">, </span><span class="s7">16</span><span class="s2">)) :</span>
              <span class="s0">// \' \&quot;</span>
              <span class="s1">REX</span><span class="s2">.</span><span class="s1">EscOrQuote</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">p1</span><span class="s2">) ? </span><span class="s1">substring </span><span class="s2">:</span>
              <span class="s0">// \g \h \. \# etc</span>
              <span class="s1">p1</span><span class="s2">;</span>
          <span class="s2">}</span>
        <span class="s2">) : </span><span class="s1">str</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s1">method </span><span class="s2">= {</span>
    <span class="s4">'#'</span><span class="s2">: </span><span class="s4">'getElementById'</span><span class="s2">,</span>
    <span class="s4">'*'</span><span class="s2">: </span><span class="s4">'getElementsByTagName'</span><span class="s2">,</span>
    <span class="s4">'|'</span><span class="s2">: </span><span class="s4">'getElementsByTagNameNS'</span><span class="s2">,</span>
    <span class="s4">'.'</span><span class="s2">: </span><span class="s4">'getElementsByClassName'</span>
    <span class="s2">},</span>

  <span class="s1">compat </span><span class="s2">= {</span>
    <span class="s4">'#'</span><span class="s2">: </span><span class="s3">function</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">n</span><span class="s2">) { </span><span class="s1">REX</span><span class="s2">.</span><span class="s1">HasEscapes</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &amp;&amp; (</span><span class="s1">n </span><span class="s2">= </span><span class="s1">unescapeIdentifier</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)); </span><span class="s3">return function</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">f</span><span class="s2">) { </span><span class="s3">return </span><span class="s1">byId</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">c</span><span class="s2">); }; },</span>
    <span class="s4">'*'</span><span class="s2">: </span><span class="s3">function</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">n</span><span class="s2">) { </span><span class="s1">REX</span><span class="s2">.</span><span class="s1">HasEscapes</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &amp;&amp; (</span><span class="s1">n </span><span class="s2">= </span><span class="s1">unescapeIdentifier</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)); </span><span class="s3">return function</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">f</span><span class="s2">) { </span><span class="s3">return </span><span class="s1">byTag</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">c</span><span class="s2">); }; },</span>
    <span class="s4">'|'</span><span class="s2">: </span><span class="s3">function</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">n</span><span class="s2">) { </span><span class="s1">REX</span><span class="s2">.</span><span class="s1">HasEscapes</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &amp;&amp; (</span><span class="s1">n </span><span class="s2">= </span><span class="s1">unescapeIdentifier</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)); </span><span class="s3">return function</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">f</span><span class="s2">) { </span><span class="s3">return </span><span class="s1">byTagNS</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">c</span><span class="s2">); }; },</span>
    <span class="s4">'.'</span><span class="s2">: </span><span class="s3">function</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">n</span><span class="s2">) { </span><span class="s1">REX</span><span class="s2">.</span><span class="s1">HasEscapes</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &amp;&amp; (</span><span class="s1">n </span><span class="s2">= </span><span class="s1">unescapeIdentifier</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)); </span><span class="s3">return function</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">f</span><span class="s2">) { </span><span class="s3">return </span><span class="s1">byClass</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">c</span><span class="s2">); }; }</span>
    <span class="s2">},</span>

  <span class="s0">// find duplicate ids using iterative walk</span>
  <span class="s1">byIdRaw </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">context</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">node </span><span class="s2">= </span><span class="s1">context</span><span class="s2">, </span><span class="s1">nodes </span><span class="s2">= [ ], </span><span class="s1">next </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">firstElementChild</span><span class="s2">;</span>
      <span class="s3">while </span><span class="s2">((</span><span class="s1">node </span><span class="s2">= </span><span class="s1">next</span><span class="s2">)) {</span>
        <span class="s1">node</span><span class="s2">.</span><span class="s1">id </span><span class="s2">== </span><span class="s1">id </span><span class="s2">&amp;&amp; (</span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length</span><span class="s2">] = </span><span class="s1">node</span><span class="s2">);</span>
        <span class="s3">if </span><span class="s2">((</span><span class="s1">next </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">firstElementChild </span><span class="s2">|| </span><span class="s1">node</span><span class="s2">.</span><span class="s1">nextElementSibling</span><span class="s2">)) </span><span class="s3">continue</span><span class="s2">;</span>
        <span class="s3">while </span><span class="s2">(!</span><span class="s1">next </span><span class="s2">&amp;&amp; (</span><span class="s1">node </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">parentElement</span><span class="s2">) &amp;&amp; </span><span class="s1">node </span><span class="s2">!== </span><span class="s1">context</span><span class="s2">) {</span>
          <span class="s1">next </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">nextElementSibling</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s1">nodes</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// context agnostic getElementById</span>
  <span class="s1">byId </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">context</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">e</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">api </span><span class="s2">= </span><span class="s1">method</span><span class="s2">[</span><span class="s4">'#'</span><span class="s2">];</span>

      <span class="s0">// duplicates id allowed</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">Config</span><span class="s2">.</span><span class="s1">IDS_DUPES </span><span class="s2">=== </span><span class="s3">false</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">api </span><span class="s3">in </span><span class="s1">context</span><span class="s2">) {</span>
          <span class="s3">return </span><span class="s2">(</span><span class="s1">e </span><span class="s2">= </span><span class="s1">context</span><span class="s2">[</span><span class="s1">api</span><span class="s2">](</span><span class="s1">id</span><span class="s2">)) ? [ </span><span class="s1">e </span><span class="s2">] : </span><span class="s1">none</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s4">'all' </span><span class="s3">in </span><span class="s1">context</span><span class="s2">) {</span>
          <span class="s3">if </span><span class="s2">((</span><span class="s1">e </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">all</span><span class="s2">[</span><span class="s1">id</span><span class="s2">])) {</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">nodeType </span><span class="s2">== </span><span class="s7">1</span><span class="s2">) </span><span class="s3">return </span><span class="s1">e</span><span class="s2">.</span><span class="s1">getAttribute</span><span class="s2">(</span><span class="s4">'id'</span><span class="s2">) != </span><span class="s1">id </span><span class="s2">? [ ] : [ </span><span class="s1">e </span><span class="s2">];</span>
            <span class="s3">else if </span><span class="s2">(</span><span class="s1">id </span><span class="s2">== </span><span class="s4">'length'</span><span class="s2">) </span><span class="s3">return </span><span class="s2">(</span><span class="s1">e </span><span class="s2">= </span><span class="s1">context</span><span class="s2">[</span><span class="s1">api</span><span class="s2">](</span><span class="s1">id</span><span class="s2">)) ? [ </span><span class="s1">e </span><span class="s2">] : </span><span class="s1">none</span><span class="s2">;</span>
            <span class="s3">for </span><span class="s2">(</span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">nodes </span><span class="s2">= [ ]; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">i</span><span class="s2">; ++</span><span class="s1">i</span><span class="s2">) {</span>
              <span class="s3">if </span><span class="s2">(</span><span class="s1">e</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">id </span><span class="s2">== </span><span class="s1">id</span><span class="s2">) </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length</span><span class="s2">] = </span><span class="s1">e</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>
            <span class="s2">}</span>
            <span class="s3">return </span><span class="s1">nodes </span><span class="s2">&amp;&amp; </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length </span><span class="s2">? </span><span class="s1">nodes </span><span class="s2">: [ </span><span class="s1">nodes </span><span class="s2">];</span>
          <span class="s2">} </span><span class="s3">else return </span><span class="s1">none</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>

      <span class="s3">return </span><span class="s1">byIdRaw</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">context</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// wrapped up namespaced TagName api calls</span>
  <span class="s1">byTagNS </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">tag</span><span class="s2">) {</span>
      <span class="s3">return </span><span class="s1">byTag</span><span class="s2">(</span><span class="s1">tag</span><span class="s2">, </span><span class="s1">context</span><span class="s2">);</span>
  <span class="s2">},</span>

  <span class="s0">// context agnostic getElementsByTagName</span>
  <span class="s1">byTag </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">tag</span><span class="s2">, </span><span class="s1">context</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">e</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">api </span><span class="s2">= </span><span class="s1">method</span><span class="s2">[</span><span class="s4">'*'</span><span class="s2">];</span>
      <span class="s0">// DOCUMENT_NODE (9) &amp; ELEMENT_NODE (1)</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">api </span><span class="s3">in </span><span class="s1">context</span><span class="s2">) {</span>
        <span class="s3">return </span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">context</span><span class="s2">[</span><span class="s1">api</span><span class="s2">](</span><span class="s1">tag</span><span class="s2">));</span>
      <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
        <span class="s1">tag </span><span class="s2">= </span><span class="s1">tag</span><span class="s2">.</span><span class="s1">toLowerCase</span><span class="s2">();</span>
        <span class="s0">// DOCUMENT_FRAGMENT_NODE (11)</span>
        <span class="s3">if </span><span class="s2">((</span><span class="s1">e </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">firstElementChild</span><span class="s2">)) {</span>
          <span class="s3">if </span><span class="s2">(!(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">nextElementSibling </span><span class="s2">|| </span><span class="s1">tag </span><span class="s2">== </span><span class="s4">'*' </span><span class="s2">|| </span><span class="s1">e</span><span class="s2">.</span><span class="s1">localName </span><span class="s2">== </span><span class="s1">tag</span><span class="s2">)) {</span>
            <span class="s3">return </span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">e</span><span class="s2">[</span><span class="s1">api</span><span class="s2">](</span><span class="s1">tag</span><span class="s2">));</span>
          <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
            <span class="s1">nodes </span><span class="s2">= [ ];</span>
            <span class="s3">do </span><span class="s2">{</span>
              <span class="s3">if </span><span class="s2">(</span><span class="s1">tag </span><span class="s2">== </span><span class="s4">'*' </span><span class="s2">|| </span><span class="s1">e</span><span class="s2">.</span><span class="s1">localName </span><span class="s2">== </span><span class="s1">tag</span><span class="s2">) </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length</span><span class="s2">] = </span><span class="s1">e</span><span class="s2">;</span>
              <span class="s1">concatList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">e</span><span class="s2">[</span><span class="s1">api</span><span class="s2">](</span><span class="s1">tag</span><span class="s2">));</span>
            <span class="s2">} </span><span class="s3">while </span><span class="s2">((</span><span class="s1">e </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">nextElementSibling</span><span class="s2">));</span>
          <span class="s2">}</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s1">nodes </span><span class="s2">= </span><span class="s1">none</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s2">!</span><span class="s1">Config</span><span class="s2">.</span><span class="s1">ANODELIST </span><span class="s2">? </span><span class="s1">nodes </span><span class="s2">: </span><span class="s1">nodes </span><span class="s3">instanceof </span><span class="s1">global</span><span class="s2">.</span><span class="s1">NodeList </span><span class="s2">? </span><span class="s1">nodes </span><span class="s2">: </span><span class="s1">toNodeList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// context agnostic getElementsByClassName</span>
  <span class="s1">byClass </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">context</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">e</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">api </span><span class="s2">= </span><span class="s1">method</span><span class="s2">[</span><span class="s4">'.'</span><span class="s2">], </span><span class="s1">reCls</span><span class="s2">;</span>
      <span class="s0">// DOCUMENT_NODE (9) &amp; ELEMENT_NODE (1)</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">api </span><span class="s3">in </span><span class="s1">context</span><span class="s2">) {</span>
        <span class="s3">return </span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">context</span><span class="s2">[</span><span class="s1">api</span><span class="s2">](</span><span class="s1">cls</span><span class="s2">));</span>
      <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
        <span class="s0">// DOCUMENT_FRAGMENT_NODE (11)</span>
        <span class="s3">if </span><span class="s2">((</span><span class="s1">e </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">firstElementChild</span><span class="s2">)) {</span>
          <span class="s1">reCls </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'(^|</span><span class="s3">\\</span><span class="s4">s)' </span><span class="s2">+ </span><span class="s1">cls </span><span class="s2">+ </span><span class="s4">'(</span><span class="s3">\\</span><span class="s4">s|$)'</span><span class="s2">, </span><span class="s1">QUIRKS_MODE </span><span class="s2">? </span><span class="s4">'i' </span><span class="s2">: </span><span class="s4">''</span><span class="s2">);</span>
          <span class="s3">if </span><span class="s2">(!(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">nextElementSibling </span><span class="s2">|| </span><span class="s1">reCls</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">className</span><span class="s2">))) {</span>
            <span class="s3">return </span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">e</span><span class="s2">[</span><span class="s1">api</span><span class="s2">](</span><span class="s1">cls</span><span class="s2">));</span>
          <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
            <span class="s1">nodes </span><span class="s2">= [ ];</span>
            <span class="s3">do </span><span class="s2">{</span>
              <span class="s3">if </span><span class="s2">(</span><span class="s1">reCls</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">className</span><span class="s2">)) </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length</span><span class="s2">] = </span><span class="s1">e</span><span class="s2">;</span>
              <span class="s1">concatList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">e</span><span class="s2">[</span><span class="s1">api</span><span class="s2">](</span><span class="s1">cls</span><span class="s2">));</span>
            <span class="s2">} </span><span class="s3">while </span><span class="s2">((</span><span class="s1">e </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">nextElementSibling</span><span class="s2">));</span>
          <span class="s2">}</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s1">nodes </span><span class="s2">= </span><span class="s1">none</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s2">!</span><span class="s1">Config</span><span class="s2">.</span><span class="s1">ANODELIST </span><span class="s2">? </span><span class="s1">nodes </span><span class="s2">: </span><span class="s1">nodes </span><span class="s3">instanceof </span><span class="s1">global</span><span class="s2">.</span><span class="s1">NodeList </span><span class="s2">? </span><span class="s1">nodes </span><span class="s2">: </span><span class="s1">toNodeList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// namespace aware hasAttribute</span>
  <span class="s0">// helper for XML/XHTML documents</span>
  <span class="s1">hasAttributeNS </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">i</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">attr </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">getAttributeNames</span><span class="s2">();</span>
      <span class="s1">name </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">':?' </span><span class="s2">+ </span><span class="s1">name </span><span class="s2">+ </span><span class="s4">'$'</span><span class="s2">, </span><span class="s1">HTML_DOCUMENT </span><span class="s2">? </span><span class="s4">'i' </span><span class="s2">: </span><span class="s4">''</span><span class="s2">);</span>
      <span class="s3">for </span><span class="s2">(</span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">attr</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">i</span><span class="s2">; ++</span><span class="s1">i</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">name</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])) </span><span class="s3">return true</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">return false</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// fast resolver for the :nth-child() and :nth-last-child() pseudo-classes</span>
  <span class="s1">nthElement </span><span class="s2">= (</span><span class="s3">function</span><span class="s2">() {</span>
    <span class="s3">var </span><span class="s1">idx </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">len </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">set </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">parent </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">, </span><span class="s1">parents </span><span class="s2">= </span><span class="s1">Array</span><span class="s2">(), </span><span class="s1">nodes </span><span class="s2">= </span><span class="s1">Array</span><span class="s2">();</span>
    <span class="s3">return function</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">dir</span><span class="s2">) {</span>
      <span class="s0">// ensure caches are emptied after each run, invoking with dir = 2</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">dir </span><span class="s2">== </span><span class="s7">2</span><span class="s2">) {</span>
        <span class="s1">idx </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">len </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">set </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s7">0</span><span class="s2">;</span>
        <span class="s1">parents</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">parent </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
        <span class="s3">return </span><span class="s2">-</span><span class="s7">1</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">var </span><span class="s1">e</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">l</span><span class="s2">;</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">parent </span><span class="s2">=== </span><span class="s1">element</span><span class="s2">.</span><span class="s1">parentElement</span><span class="s2">) {</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">set</span><span class="s2">; </span><span class="s1">j </span><span class="s2">= </span><span class="s1">idx</span><span class="s2">; </span><span class="s1">l </span><span class="s2">= </span><span class="s1">len</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
        <span class="s1">l </span><span class="s2">= </span><span class="s1">parents</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
        <span class="s1">parent </span><span class="s2">= </span><span class="s1">element</span><span class="s2">.</span><span class="s1">parentElement</span><span class="s2">;</span>
        <span class="s3">for </span><span class="s2">(</span><span class="s1">i </span><span class="s2">= -</span><span class="s7">1</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">l </span><span class="s2">- </span><span class="s7">1</span><span class="s2">; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">j</span><span class="s2">; ++</span><span class="s1">j</span><span class="s2">, --</span><span class="s1">k</span><span class="s2">) {</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">parents</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] === </span><span class="s1">parent</span><span class="s2">) { </span><span class="s1">i </span><span class="s2">= </span><span class="s1">j</span><span class="s2">; </span><span class="s3">break</span><span class="s2">; }</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">parents</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] === </span><span class="s1">parent</span><span class="s2">) { </span><span class="s1">i </span><span class="s2">= </span><span class="s1">k</span><span class="s2">; </span><span class="s3">break</span><span class="s2">; }</span>
        <span class="s2">}</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">i </span><span class="s2">&lt; </span><span class="s7">0</span><span class="s2">) {</span>
          <span class="s1">parents</span><span class="s2">[</span><span class="s1">i </span><span class="s2">= </span><span class="s1">l</span><span class="s2">] = </span><span class="s1">parent</span><span class="s2">;</span>
          <span class="s1">l </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">Array</span><span class="s2">();</span>
          <span class="s1">e </span><span class="s2">= </span><span class="s1">parent </span><span class="s2">&amp;&amp; </span><span class="s1">parent</span><span class="s2">.</span><span class="s1">firstElementChild </span><span class="s2">|| </span><span class="s1">element</span><span class="s2">;</span>
          <span class="s3">while </span><span class="s2">(</span><span class="s1">e</span><span class="s2">) { </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">l</span><span class="s2">] = </span><span class="s1">e</span><span class="s2">; </span><span class="s3">if </span><span class="s2">(</span><span class="s1">e </span><span class="s2">=== </span><span class="s1">element</span><span class="s2">) </span><span class="s1">j </span><span class="s2">= </span><span class="s1">l</span><span class="s2">; </span><span class="s1">e </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">nextElementSibling</span><span class="s2">; ++</span><span class="s1">l</span><span class="s2">; }</span>
          <span class="s1">set </span><span class="s2">= </span><span class="s1">i</span><span class="s2">; </span><span class="s1">idx </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">len </span><span class="s2">= </span><span class="s1">l</span><span class="s2">;</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">l </span><span class="s2">&lt; </span><span class="s7">2</span><span class="s2">) </span><span class="s3">return </span><span class="s1">l</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
          <span class="s1">l </span><span class="s2">= </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">length</span><span class="s2">;</span>
          <span class="s1">set </span><span class="s2">= </span><span class="s1">i</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">element </span><span class="s2">!== </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">j</span><span class="s2">] &amp;&amp; </span><span class="s1">element </span><span class="s2">!== </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">j </span><span class="s2">= </span><span class="s7">0</span><span class="s2">]) {</span>
        <span class="s3">for </span><span class="s2">(</span><span class="s1">j </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">e </span><span class="s2">= </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">k </span><span class="s2">= </span><span class="s1">l </span><span class="s2">- </span><span class="s7">1</span><span class="s2">; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">j</span><span class="s2">; ++</span><span class="s1">j</span><span class="s2">, --</span><span class="s1">k</span><span class="s2">) {</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">e</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] === </span><span class="s1">element</span><span class="s2">) { </span><span class="s3">break</span><span class="s2">; }</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">e</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] === </span><span class="s1">element</span><span class="s2">) { </span><span class="s1">j </span><span class="s2">= </span><span class="s1">k</span><span class="s2">; </span><span class="s3">break</span><span class="s2">; }</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
      <span class="s1">idx </span><span class="s2">= </span><span class="s1">j </span><span class="s2">+ </span><span class="s7">1</span><span class="s2">; </span><span class="s1">len </span><span class="s2">= </span><span class="s1">l</span><span class="s2">;</span>
      <span class="s3">return </span><span class="s1">dir </span><span class="s2">? </span><span class="s1">l </span><span class="s2">- </span><span class="s1">j </span><span class="s2">: </span><span class="s1">idx</span><span class="s2">;</span>
    <span class="s2">};</span>
  <span class="s2">})(),</span>

  <span class="s0">// fast resolver for the :nth-of-type() and :nth-last-of-type() pseudo-classes</span>
  <span class="s1">nthOfType </span><span class="s2">= (</span><span class="s3">function</span><span class="s2">() {</span>
    <span class="s3">var </span><span class="s1">idx </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">len </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">set </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">parent </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">, </span><span class="s1">parents </span><span class="s2">= </span><span class="s1">Array</span><span class="s2">(), </span><span class="s1">nodes </span><span class="s2">= </span><span class="s1">Array</span><span class="s2">();</span>
    <span class="s3">return function</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">dir</span><span class="s2">) {</span>
      <span class="s0">// ensure caches are emptied after each run, invoking with dir = 2</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">dir </span><span class="s2">== </span><span class="s7">2</span><span class="s2">) {</span>
        <span class="s1">idx </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">len </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">set </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s7">0</span><span class="s2">;</span>
        <span class="s1">parents</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">parent </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
        <span class="s3">return </span><span class="s2">-</span><span class="s7">1</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">var </span><span class="s1">e</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">name </span><span class="s2">= </span><span class="s1">element</span><span class="s2">.</span><span class="s1">localName</span><span class="s2">;</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">set</span><span class="s2">] &amp;&amp; </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">set</span><span class="s2">][</span><span class="s1">name</span><span class="s2">] &amp;&amp; </span><span class="s1">parent </span><span class="s2">=== </span><span class="s1">element</span><span class="s2">.</span><span class="s1">parentElement</span><span class="s2">) {</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">set</span><span class="s2">; </span><span class="s1">j </span><span class="s2">= </span><span class="s1">idx</span><span class="s2">; </span><span class="s1">l </span><span class="s2">= </span><span class="s1">len</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
        <span class="s1">l </span><span class="s2">= </span><span class="s1">parents</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
        <span class="s1">parent </span><span class="s2">= </span><span class="s1">element</span><span class="s2">.</span><span class="s1">parentElement</span><span class="s2">;</span>
        <span class="s3">for </span><span class="s2">(</span><span class="s1">i </span><span class="s2">= -</span><span class="s7">1</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">l </span><span class="s2">- </span><span class="s7">1</span><span class="s2">; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">j</span><span class="s2">; ++</span><span class="s1">j</span><span class="s2">, --</span><span class="s1">k</span><span class="s2">) {</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">parents</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] === </span><span class="s1">parent</span><span class="s2">) { </span><span class="s1">i </span><span class="s2">= </span><span class="s1">j</span><span class="s2">; </span><span class="s3">break</span><span class="s2">; }</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">parents</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] === </span><span class="s1">parent</span><span class="s2">) { </span><span class="s1">i </span><span class="s2">= </span><span class="s1">k</span><span class="s2">; </span><span class="s3">break</span><span class="s2">; }</span>
        <span class="s2">}</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">i </span><span class="s2">&lt; </span><span class="s7">0 </span><span class="s2">|| !</span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">name</span><span class="s2">]) {</span>
          <span class="s1">parents</span><span class="s2">[</span><span class="s1">i </span><span class="s2">= </span><span class="s1">l</span><span class="s2">] = </span><span class="s1">parent</span><span class="s2">;</span>
          <span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] || (</span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">Object</span><span class="s2">());</span>
          <span class="s1">l </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">Array</span><span class="s2">();</span>
          <span class="s1">e </span><span class="s2">= </span><span class="s1">parent </span><span class="s2">&amp;&amp; </span><span class="s1">parent</span><span class="s2">.</span><span class="s1">firstElementChild </span><span class="s2">|| </span><span class="s1">element</span><span class="s2">;</span>
          <span class="s3">while </span><span class="s2">(</span><span class="s1">e</span><span class="s2">) { </span><span class="s3">if </span><span class="s2">(</span><span class="s1">e </span><span class="s2">=== </span><span class="s1">element</span><span class="s2">) </span><span class="s1">j </span><span class="s2">= </span><span class="s1">l</span><span class="s2">; </span><span class="s3">if </span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">localName </span><span class="s2">== </span><span class="s1">name</span><span class="s2">) { </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">name</span><span class="s2">][</span><span class="s1">l</span><span class="s2">] = </span><span class="s1">e</span><span class="s2">; ++</span><span class="s1">l</span><span class="s2">; } </span><span class="s1">e </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">nextElementSibling</span><span class="s2">; }</span>
          <span class="s1">set </span><span class="s2">= </span><span class="s1">i</span><span class="s2">; </span><span class="s1">idx </span><span class="s2">= </span><span class="s1">j</span><span class="s2">; </span><span class="s1">len </span><span class="s2">= </span><span class="s1">l</span><span class="s2">;</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">l </span><span class="s2">&lt; </span><span class="s7">2</span><span class="s2">) </span><span class="s3">return </span><span class="s1">l</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
          <span class="s1">l </span><span class="s2">= </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">name</span><span class="s2">].</span><span class="s1">length</span><span class="s2">;</span>
          <span class="s1">set </span><span class="s2">= </span><span class="s1">i</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">element </span><span class="s2">!== </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">name</span><span class="s2">][</span><span class="s1">j</span><span class="s2">] &amp;&amp; </span><span class="s1">element </span><span class="s2">!== </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">name</span><span class="s2">][</span><span class="s1">j </span><span class="s2">= </span><span class="s7">0</span><span class="s2">]) {</span>
        <span class="s3">for </span><span class="s2">(</span><span class="s1">j </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">e </span><span class="s2">= </span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">name</span><span class="s2">], </span><span class="s1">k </span><span class="s2">= </span><span class="s1">l </span><span class="s2">- </span><span class="s7">1</span><span class="s2">; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">j</span><span class="s2">; ++</span><span class="s1">j</span><span class="s2">, --</span><span class="s1">k</span><span class="s2">) {</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">e</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] === </span><span class="s1">element</span><span class="s2">) { </span><span class="s3">break</span><span class="s2">; }</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">e</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] === </span><span class="s1">element</span><span class="s2">) { </span><span class="s1">j </span><span class="s2">= </span><span class="s1">k</span><span class="s2">; </span><span class="s3">break</span><span class="s2">; }</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
      <span class="s1">idx </span><span class="s2">= </span><span class="s1">j </span><span class="s2">+ </span><span class="s7">1</span><span class="s2">; </span><span class="s1">len </span><span class="s2">= </span><span class="s1">l</span><span class="s2">;</span>
      <span class="s3">return </span><span class="s1">dir </span><span class="s2">? </span><span class="s1">l </span><span class="s2">- </span><span class="s1">j </span><span class="s2">: </span><span class="s1">idx</span><span class="s2">;</span>
    <span class="s2">};</span>
  <span class="s2">})(),</span>

  <span class="s0">// check if the document type is HTML</span>
  <span class="s1">isHTML </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">node</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">doc </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">ownerDocument </span><span class="s2">|| </span><span class="s1">node</span><span class="s2">;</span>
      <span class="s3">return </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">nodeType </span><span class="s2">== </span><span class="s7">9 </span><span class="s2">&amp;&amp;</span>
        <span class="s0">// contentType not in IE &lt;= 11</span>
        <span class="s4">'contentType' </span><span class="s3">in </span><span class="s1">doc </span><span class="s2">?</span>
          <span class="s1">doc</span><span class="s2">.</span><span class="s1">contentType</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s4">'/html'</span><span class="s2">) &gt; </span><span class="s7">0 </span><span class="s2">:</span>
          <span class="s1">doc</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'DiV'</span><span class="s2">).</span><span class="s1">localName </span><span class="s2">== </span><span class="s4">'div'</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// return node if node is focusable</span>
  <span class="s0">// or false if node isn't focusable</span>
  <span class="s1">isFocusable </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">node</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">doc </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">ownerDocument</span><span class="s2">;</span>
       <span class="s3">if </span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">contentDocument</span><span class="s2">&amp;&amp;</span><span class="s1">node</span><span class="s2">.</span><span class="s1">localName</span><span class="s2">== </span><span class="s4">'iframe'</span><span class="s2">) { </span><span class="s3">return false</span><span class="s2">; }</span>
       <span class="s3">if </span><span class="s2">(</span><span class="s1">doc</span><span class="s2">.</span><span class="s1">hasFocus</span><span class="s2">() &amp;&amp; </span><span class="s1">node </span><span class="s2">=== </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">activeElement</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">type </span><span class="s2">|| </span><span class="s1">node</span><span class="s2">.</span><span class="s1">href </span><span class="s2">|| </span><span class="s3">typeof </span><span class="s1">node</span><span class="s2">.</span><span class="s1">tabIndex </span><span class="s2">== </span><span class="s4">'number'</span><span class="s2">) {</span>
          <span class="s3">return </span><span class="s1">node</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
      <span class="s3">return false</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// check if node content is editable</span>
  <span class="s1">isContentEditable </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">node</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">attrValue </span><span class="s2">= </span><span class="s4">'inherit'</span><span class="s2">;</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">hasAttribute</span><span class="s2">(</span><span class="s4">'contenteditable'</span><span class="s2">)) {</span>
        <span class="s1">attrValue </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">getAttribute</span><span class="s2">(</span><span class="s4">'contenteditable'</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s3">switch </span><span class="s2">(</span><span class="s1">attrValue</span><span class="s2">) {</span>
        <span class="s3">case </span><span class="s4">''</span><span class="s2">:</span>
        <span class="s3">case </span><span class="s4">'plaintext-only'</span><span class="s2">:</span>
        <span class="s3">case </span><span class="s4">'true'</span><span class="s2">:</span>
          <span class="s3">return true</span><span class="s2">;</span>
        <span class="s3">case </span><span class="s4">'false'</span><span class="s2">:</span>
          <span class="s3">return false</span><span class="s2">;</span>
        <span class="s3">default</span><span class="s2">:</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">parentNode </span><span class="s2">&amp;&amp; </span><span class="s1">node</span><span class="s2">.</span><span class="s1">parentNode</span><span class="s2">.</span><span class="s1">nodeType </span><span class="s2">=== </span><span class="s7">1</span><span class="s2">) {</span>
            <span class="s3">return </span><span class="s1">isContentEditable</span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">parentNode</span><span class="s2">);</span>
          <span class="s2">}</span>
          <span class="s3">return false</span><span class="s2">;</span>
      <span class="s2">}</span>
    <span class="s2">},</span>

  <span class="s0">// check media resources is playing</span>
  <span class="s1">isPlaying </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">media</span><span class="s2">) {</span>
      <span class="s0">// for &lt;audio&gt;, &lt;video&gt;, &lt;source&gt; and &lt;track&gt; elements</span>
      <span class="s3">var </span><span class="s1">parent </span><span class="s2">= </span><span class="s1">media </span><span class="s3">instanceof </span><span class="s1">HTMLMediaElement </span><span class="s2">? </span><span class="s3">null </span><span class="s2">: </span><span class="s1">media</span><span class="s2">.</span><span class="s1">parentElement</span><span class="s2">;</span>
      <span class="s3">return </span><span class="s2">(</span>
        <span class="s2">!!( </span><span class="s1">media </span><span class="s2">&amp;&amp;  </span><span class="s1">media</span><span class="s2">.</span><span class="s1">currentTime </span><span class="s2">&gt; </span><span class="s7">0 </span><span class="s2">&amp;&amp;  !</span><span class="s1">media</span><span class="s2">.</span><span class="s1">paused </span><span class="s2">&amp;&amp;  !</span><span class="s1">media</span><span class="s2">.</span><span class="s1">ended </span><span class="s2">&amp;&amp;  </span><span class="s1">media</span><span class="s2">.</span><span class="s1">readyState </span><span class="s2">&gt; </span><span class="s7">2</span><span class="s2">) ||</span>
        <span class="s2">!!(</span><span class="s1">parent </span><span class="s2">&amp;&amp; </span><span class="s1">parent</span><span class="s2">.</span><span class="s1">currentTime </span><span class="s2">&gt; </span><span class="s7">0 </span><span class="s2">&amp;&amp; !</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">paused </span><span class="s2">&amp;&amp; !</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">ended </span><span class="s2">&amp;&amp; </span><span class="s1">parent</span><span class="s2">.</span><span class="s1">readyState </span><span class="s2">&gt; </span><span class="s7">2</span><span class="s2">));</span>
    <span class="s2">},</span>

  <span class="s0">// configure the engine to use special handling</span>
  <span class="s1">configure </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">option</span><span class="s2">, </span><span class="s1">clear</span><span class="s2">) {</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">option </span><span class="s2">== </span><span class="s4">'string'</span><span class="s2">) { </span><span class="s3">return </span><span class="s2">!!</span><span class="s1">Config</span><span class="s2">[</span><span class="s1">option</span><span class="s2">]; }</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">option </span><span class="s2">!= </span><span class="s4">'object'</span><span class="s2">) { </span><span class="s3">return </span><span class="s1">Config</span><span class="s2">; }</span>
      <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s1">i </span><span class="s3">in </span><span class="s1">option</span><span class="s2">) {</span>
        <span class="s1">Config</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = !!</span><span class="s1">option</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>
      <span class="s2">}</span>
      <span class="s0">// clear lambda cache</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">clear</span><span class="s2">) {</span>
        <span class="s1">matchResolvers </span><span class="s2">= { };</span>
        <span class="s1">selectResolvers </span><span class="s2">= { };</span>
      <span class="s2">}</span>
      <span class="s1">setIdentifierSyntax</span><span class="s2">();</span>
      <span class="s3">return true</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// centralized error and exceptions handling</span>
  <span class="s1">emit </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s1">proto</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">err</span><span class="s2">;</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">Config</span><span class="s2">.</span><span class="s1">VERBOSITY</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">proto</span><span class="s2">) {</span>
          <span class="s1">err </span><span class="s2">= </span><span class="s3">new </span><span class="s1">proto</span><span class="s2">(</span><span class="s1">message</span><span class="s2">);</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
          <span class="s1">err </span><span class="s2">= </span><span class="s3">new </span><span class="s1">global</span><span class="s2">.</span><span class="s1">DOMException</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s4">'SyntaxError'</span><span class="s2">);</span>
        <span class="s2">}</span>
        <span class="s3">throw </span><span class="s1">err</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">Config</span><span class="s2">.</span><span class="s1">LOGERRORS </span><span class="s2">&amp;&amp; </span><span class="s1">console </span><span class="s2">&amp;&amp; </span><span class="s1">console</span><span class="s2">.</span><span class="s1">log</span><span class="s2">) {</span>
        <span class="s1">console</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">message</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">},</span>

  <span class="s0">// execute the engine initialization code</span>
  <span class="s1">initialize </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">doc</span><span class="s2">) {</span>
      <span class="s1">setIdentifierSyntax</span><span class="s2">();</span>
      <span class="s1">lastContext </span><span class="s2">= </span><span class="s1">switchContext</span><span class="s2">(</span><span class="s1">doc</span><span class="s2">, </span><span class="s3">true</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// build validation regexps used by the engine</span>
  <span class="s1">setIdentifierSyntax </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">() {</span>

      <span class="s0">//</span>
      <span class="s0">// NOTE: SPECIAL CASES IN CSS SYNTAX PARSING RULES</span>
      <span class="s0">//</span>
      <span class="s0">// The &lt;EOF-token&gt; https://drafts.csswg.org/css-syntax/#typedef-eof-token</span>
      <span class="s0">// allow mangled|unclosed selector syntax at the end of selectors strings</span>
      <span class="s0">//</span>
      <span class="s0">// Literal equivalent hex representations of the characters: &quot; ' ` ] )</span>
      <span class="s0">//</span>
      <span class="s0">//     \\x22 = &quot; - double quotes    \\x5b = [ - open square bracket</span>
      <span class="s0">//     \\x27 = ' - single quote     \\x5d = ] - closed square bracket</span>
      <span class="s0">//     \\x60 = ` - back tick        \\x28 = ( - open round parens</span>
      <span class="s0">//     \\x5c = \ - back slash       \\x29 = ) - closed round parens</span>
      <span class="s0">//</span>
      <span class="s0">// using hex format prevents false matches of opened/closed instances</span>
      <span class="s0">// pairs, coloring breakage and other editors highlightning problems.</span>
      <span class="s0">//</span>

      <span class="s3">var</span>

      <span class="s0">// non-ascii chars</span>
      <span class="s1">noascii </span><span class="s2">= </span><span class="s4">'[^</span><span class="s3">\\</span><span class="s4">x00-</span><span class="s3">\\</span><span class="s4">x9f]'</span><span class="s2">,</span>
      <span class="s0">// escaped chars</span>
      <span class="s1">escaped </span><span class="s2">= </span><span class="s4">'</span><span class="s3">\\\\</span><span class="s4">[^</span><span class="s3">\\</span><span class="s4">r</span><span class="s3">\\</span><span class="s4">n</span><span class="s3">\\</span><span class="s4">f0-9a-fA-F]'</span><span class="s2">,</span>
      <span class="s0">// unicode chars</span>
      <span class="s1">unicode </span><span class="s2">= </span><span class="s4">'</span><span class="s3">\\\\</span><span class="s4">[0-9a-fA-F]{1,6}(?:</span><span class="s3">\\</span><span class="s4">r</span><span class="s3">\\</span><span class="s4">n|</span><span class="s3">\\</span><span class="s4">s)?'</span><span class="s2">,</span>

      <span class="s0">// can start with single/double dash</span>
      <span class="s0">// but it can not start with a digit</span>
      <span class="s1">identifier </span><span class="s2">= </span><span class="s4">'-?(?:[a-zA-Z_-]|' </span><span class="s2">+ </span><span class="s1">noascii </span><span class="s2">+ </span><span class="s4">'|' </span><span class="s2">+ </span><span class="s1">escaped </span><span class="s2">+ </span><span class="s4">'|' </span><span class="s2">+ </span><span class="s1">unicode </span><span class="s2">+ </span><span class="s4">')' </span><span class="s2">+</span>
          <span class="s4">'(?:-{2}|[0-9]|[a-zA-Z_-]|' </span><span class="s2">+ </span><span class="s1">noascii </span><span class="s2">+ </span><span class="s4">'|' </span><span class="s2">+ </span><span class="s1">escaped </span><span class="s2">+ </span><span class="s4">'|' </span><span class="s2">+ </span><span class="s1">unicode </span><span class="s2">+ </span><span class="s4">')*'</span><span class="s2">,</span>

      <span class="s1">pseudonames </span><span class="s2">= </span><span class="s4">'[-</span><span class="s3">\\</span><span class="s4">w]+'</span><span class="s2">,</span>
      <span class="s1">pseudoparms </span><span class="s2">= </span><span class="s4">'(?:[-+]?</span><span class="s3">\\</span><span class="s4">d*)(?:n</span><span class="s3">\\</span><span class="s4">s?[-+]?</span><span class="s3">\\</span><span class="s4">s?</span><span class="s3">\\</span><span class="s4">d*)'</span><span class="s2">,</span>
      <span class="s1">doublequote </span><span class="s2">= </span><span class="s4">'&quot;[^&quot;</span><span class="s3">\\\\</span><span class="s4">]*(?:</span><span class="s3">\\\\</span><span class="s4">.[^&quot;</span><span class="s3">\\\\</span><span class="s4">]*)*(?:&quot;|$)'</span><span class="s2">,</span>
      <span class="s1">singlequote </span><span class="s2">= </span><span class="s4">&quot;'[^'</span><span class="s3">\\\\</span><span class="s4">]*(?:</span><span class="s3">\\\\</span><span class="s4">.[^'</span><span class="s3">\\\\</span><span class="s4">]*)*(?:'|$)&quot;</span><span class="s2">,</span>

      <span class="s1">attrparser </span><span class="s2">= </span><span class="s1">identifier </span><span class="s2">+ </span><span class="s4">'|' </span><span class="s2">+ </span><span class="s1">doublequote </span><span class="s2">+ </span><span class="s4">'|' </span><span class="s2">+ </span><span class="s1">singlequote</span><span class="s2">,</span>

      <span class="s1">attrvalues </span><span class="s2">= </span><span class="s4">'([</span><span class="s3">\\</span><span class="s4">x22</span><span class="s3">\\</span><span class="s4">x27]?)((?!</span><span class="s3">\\</span><span class="s4">3)*|(?:</span><span class="s3">\\\\</span><span class="s4">?.)*?)(?:</span><span class="s3">\\</span><span class="s4">3|$)'</span><span class="s2">,</span>

      <span class="s1">attributes </span><span class="s2">=</span>
        <span class="s4">'</span><span class="s3">\\</span><span class="s4">[' </span><span class="s2">+</span>
          <span class="s0">// attribute presence</span>
          <span class="s4">'(?:</span><span class="s3">\\</span><span class="s4">*</span><span class="s3">\\</span><span class="s4">|)?' </span><span class="s2">+</span>
          <span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?' </span><span class="s2">+</span>
          <span class="s4">'(' </span><span class="s2">+ </span><span class="s1">identifier </span><span class="s2">+ </span><span class="s4">'(?::' </span><span class="s2">+ </span><span class="s1">identifier </span><span class="s2">+ </span><span class="s4">')?)' </span><span class="s2">+</span>
          <span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+</span>
            <span class="s4">'(' </span><span class="s2">+ </span><span class="s1">CFG</span><span class="s2">.</span><span class="s1">operators </span><span class="s2">+ </span><span class="s4">')' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?' </span><span class="s2">+</span>
            <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">attrparser </span><span class="s2">+ </span><span class="s4">')' </span><span class="s2">+</span>
          <span class="s4">')?' </span><span class="s2">+</span>
          <span class="s0">// attribute case sensitivity</span>
          <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?</span><span class="s3">\\</span><span class="s4">b(i))?' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?' </span><span class="s2">+</span>
        <span class="s4">'(?:</span><span class="s3">\\</span><span class="s4">]|$)'</span><span class="s2">,</span>

      <span class="s1">attrmatcher </span><span class="s2">= </span><span class="s1">attributes</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">attrparser</span><span class="s2">, </span><span class="s1">attrvalues</span><span class="s2">),</span>

      <span class="s1">pseudoclass </span><span class="s2">=</span>
        <span class="s4">'(?:</span><span class="s3">\\</span><span class="s4">x28' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'*' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">pseudoparms </span><span class="s2">+ </span><span class="s4">'?)?|' </span><span class="s2">+</span>
          <span class="s0">// universal * &amp;</span>
          <span class="s0">// namespace *|*</span>
          <span class="s4">'(?:</span><span class="s3">\\</span><span class="s4">*|</span><span class="s3">\\</span><span class="s4">*</span><span class="s3">\\</span><span class="s4">|)|' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+</span>
            <span class="s4">'(?::' </span><span class="s2">+ </span><span class="s1">pseudonames </span><span class="s2">+</span>
              <span class="s4">'(?:</span><span class="s3">\\</span><span class="s4">x28' </span><span class="s2">+ </span><span class="s1">pseudoparms </span><span class="s2">+ </span><span class="s4">'?(?:</span><span class="s3">\\</span><span class="s4">x29|$))?|' </span><span class="s2">+</span>
            <span class="s4">')|' </span><span class="s2">+</span>
            <span class="s4">'(?:[.#]?' </span><span class="s2">+ </span><span class="s1">identifier </span><span class="s2">+ </span><span class="s4">')|' </span><span class="s2">+</span>
            <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">attributes </span><span class="s2">+ </span><span class="s4">')' </span><span class="s2">+</span>
          <span class="s4">')+|' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?[&gt;+~][^&gt;+~]' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?)|' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?,' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?)|' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?)|' </span><span class="s2">+</span>
          <span class="s4">'(?:</span><span class="s3">\\</span><span class="s4">x29|$)' </span><span class="s2">+</span>
        <span class="s4">')*'</span><span class="s2">,</span>

      <span class="s1">standardValidator </span><span class="s2">=</span>
        <span class="s4">'(?=' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?[^&gt;+~(){}&lt;&gt;])' </span><span class="s2">+</span>
        <span class="s4">'(?:' </span><span class="s2">+</span>
          <span class="s0">// universal * &amp;</span>
          <span class="s0">// namespace *|*</span>
          <span class="s4">'(?:</span><span class="s3">\\</span><span class="s4">*|</span><span class="s3">\\</span><span class="s4">*</span><span class="s3">\\</span><span class="s4">|)|' </span><span class="s2">+</span>
          <span class="s4">'(?:[.#]?' </span><span class="s2">+ </span><span class="s1">identifier </span><span class="s2">+ </span><span class="s4">')+|' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">attributes </span><span class="s2">+ </span><span class="s4">')+|' </span><span class="s2">+</span>
          <span class="s4">'(?:::?' </span><span class="s2">+ </span><span class="s1">pseudonames </span><span class="s2">+ </span><span class="s1">pseudoclass </span><span class="s2">+ </span><span class="s4">')|' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?' </span><span class="s2">+ </span><span class="s1">CFG</span><span class="s2">.</span><span class="s1">combinators </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?)|' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?,' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?)|' </span><span class="s2">+</span>
          <span class="s4">'(?:' </span><span class="s2">+ </span><span class="s1">WSP </span><span class="s2">+ </span><span class="s4">'?)' </span><span class="s2">+</span>
        <span class="s4">')+'</span><span class="s2">;</span>

      <span class="s0">// the following global RE is used to return the</span>
      <span class="s0">// deepest localName in selector strings and then</span>
      <span class="s0">// use it to retrieve all possible matching nodes</span>
      <span class="s0">// that will be filtered by compiled resolvers</span>
      <span class="s1">reOptimizer </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span>
        <span class="s4">'(?:([.:#*]?)' </span><span class="s2">+</span>
        <span class="s4">'(' </span><span class="s2">+ </span><span class="s1">identifier </span><span class="s2">+ </span><span class="s4">')' </span><span class="s2">+</span>
        <span class="s4">'(?:' </span><span class="s2">+</span>
          <span class="s4">':[-</span><span class="s3">\\</span><span class="s4">w]+|' </span><span class="s2">+</span>
          <span class="s4">'</span><span class="s3">\\</span><span class="s4">[[^</span><span class="s3">\\</span><span class="s4">]]+(?:</span><span class="s3">\\</span><span class="s4">]|$)|' </span><span class="s2">+</span>
          <span class="s4">'</span><span class="s3">\\</span><span class="s4">x28[^</span><span class="s3">\\</span><span class="s4">x29]+(?:</span><span class="s3">\\</span><span class="s4">x29|$)' </span><span class="s2">+</span>
        <span class="s4">')*)$'</span><span class="s2">);</span>

      <span class="s0">// global</span>
      <span class="s1">reValidator </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s1">standardValidator</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">);</span>

      <span class="s1">Patterns</span><span class="s2">.</span><span class="s1">id </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^#(' </span><span class="s2">+ </span><span class="s1">identifier </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">);</span>
      <span class="s1">Patterns</span><span class="s2">.</span><span class="s1">tagName </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^(' </span><span class="s2">+ </span><span class="s1">identifier </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">);</span>
      <span class="s1">Patterns</span><span class="s2">.</span><span class="s1">className </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^</span><span class="s3">\\</span><span class="s4">.(' </span><span class="s2">+ </span><span class="s1">identifier </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">);</span>
      <span class="s1">Patterns</span><span class="s2">.</span><span class="s1">attribute </span><span class="s2">= </span><span class="s1">RegExp</span><span class="s2">(</span><span class="s4">'^(?:' </span><span class="s2">+ </span><span class="s1">attrmatcher </span><span class="s2">+ </span><span class="s4">')(.*)'</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s1">F_INIT </span><span class="s2">= </span><span class="s4">'&quot;use strict&quot;;return function Resolver(c,f,x,r)'</span><span class="s2">,</span>

  <span class="s1">S_HEAD </span><span class="s2">= </span><span class="s4">'var e,n,o,j=r.length-1,k=-1'</span><span class="s2">,</span>
  <span class="s1">M_HEAD </span><span class="s2">= </span><span class="s4">'var e,n,o'</span><span class="s2">,</span>

  <span class="s1">S_LOOP </span><span class="s2">= </span><span class="s4">'main:while((e=c[++k]))'</span><span class="s2">,</span>
  <span class="s1">N_LOOP </span><span class="s2">= </span><span class="s4">'main:while((e=c.item(++k)))'</span><span class="s2">,</span>
  <span class="s1">M_LOOP </span><span class="s2">= </span><span class="s4">'e=c;'</span><span class="s2">,</span>

  <span class="s1">S_BODY </span><span class="s2">= </span><span class="s4">'r[++j]=c[k];'</span><span class="s2">,</span>
  <span class="s1">N_BODY </span><span class="s2">= </span><span class="s4">'r[++j]=c.item(k);'</span><span class="s2">,</span>
  <span class="s1">M_BODY </span><span class="s2">= </span><span class="s4">''</span><span class="s2">,</span>

  <span class="s1">S_TAIL </span><span class="s2">= </span><span class="s4">'continue main;'</span><span class="s2">,</span>
  <span class="s1">M_TAIL </span><span class="s2">= </span><span class="s4">'r=true;'</span><span class="s2">,</span>

  <span class="s1">S_TEST </span><span class="s2">= </span><span class="s4">'if(f(c[k])){break main;}'</span><span class="s2">,</span>
  <span class="s1">N_TEST </span><span class="s2">= </span><span class="s4">'if(f(c.item(k))){break main;}'</span><span class="s2">,</span>
  <span class="s1">M_TEST </span><span class="s2">= </span><span class="s4">'f(c);'</span><span class="s2">,</span>

  <span class="s1">S_VARS </span><span class="s2">= [ ],</span>
  <span class="s1">M_VARS </span><span class="s2">= [ ],</span>

  <span class="s0">// compile groups or single selector strings into</span>
  <span class="s0">// executable functions for matching or selecting</span>
  <span class="s1">compile </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">factory</span><span class="s2">, </span><span class="s1">token</span><span class="s2">, </span><span class="s1">head </span><span class="s2">= </span><span class="s4">''</span><span class="s2">, </span><span class="s1">loop </span><span class="s2">= </span><span class="s4">''</span><span class="s2">, </span><span class="s1">macro </span><span class="s2">= </span><span class="s4">''</span><span class="s2">, </span><span class="s1">source </span><span class="s2">= </span><span class="s4">''</span><span class="s2">, </span><span class="s1">vars </span><span class="s2">= </span><span class="s4">''</span><span class="s2">;</span>

      <span class="s0">// 'mode' can be boolean or null</span>
      <span class="s0">// true = select / false = match</span>
      <span class="s0">// null to use collection.item()</span>
      <span class="s3">switch </span><span class="s2">(</span><span class="s1">mode</span><span class="s2">) {</span>
        <span class="s3">case true</span><span class="s2">:</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">selectLambdas</span><span class="s2">[</span><span class="s1">selector</span><span class="s2">]) { </span><span class="s3">return </span><span class="s1">selectLambdas</span><span class="s2">[</span><span class="s1">selector</span><span class="s2">]; }</span>
          <span class="s1">macro </span><span class="s2">= </span><span class="s1">S_BODY </span><span class="s2">+ (</span><span class="s1">callback </span><span class="s2">? </span><span class="s1">S_TEST </span><span class="s2">: </span><span class="s4">''</span><span class="s2">) + </span><span class="s1">S_TAIL</span><span class="s2">;</span>
          <span class="s1">head </span><span class="s2">= </span><span class="s1">S_HEAD</span><span class="s2">;</span>
          <span class="s1">loop </span><span class="s2">= </span><span class="s1">S_LOOP</span><span class="s2">;</span>
          <span class="s3">break</span><span class="s2">;</span>
        <span class="s3">case false</span><span class="s2">:</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">matchLambdas</span><span class="s2">[</span><span class="s1">selector</span><span class="s2">]) { </span><span class="s3">return </span><span class="s1">matchLambdas</span><span class="s2">[</span><span class="s1">selector</span><span class="s2">]; }</span>
          <span class="s1">macro </span><span class="s2">= </span><span class="s1">M_BODY </span><span class="s2">+ (</span><span class="s1">callback </span><span class="s2">? </span><span class="s1">M_TEST </span><span class="s2">: </span><span class="s4">''</span><span class="s2">) + </span><span class="s1">M_TAIL</span><span class="s2">;</span>
          <span class="s1">head </span><span class="s2">= </span><span class="s1">M_HEAD</span><span class="s2">;</span>
          <span class="s1">loop </span><span class="s2">= </span><span class="s1">M_LOOP</span><span class="s2">;</span>
          <span class="s3">break</span><span class="s2">;</span>
        <span class="s3">case null</span><span class="s2">:</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">selectLambdas</span><span class="s2">[</span><span class="s1">selector</span><span class="s2">]) { </span><span class="s3">return </span><span class="s1">selectLambdas</span><span class="s2">[</span><span class="s1">selector</span><span class="s2">]; }</span>
          <span class="s1">macro </span><span class="s2">= </span><span class="s1">N_BODY </span><span class="s2">+ (</span><span class="s1">callback </span><span class="s2">? </span><span class="s1">N_TEST </span><span class="s2">: </span><span class="s4">''</span><span class="s2">) + </span><span class="s1">S_TAIL</span><span class="s2">;</span>
          <span class="s1">head </span><span class="s2">= </span><span class="s1">S_HEAD</span><span class="s2">;</span>
          <span class="s1">loop </span><span class="s2">= </span><span class="s1">N_LOOP</span><span class="s2">;</span>
          <span class="s3">break</span><span class="s2">;</span>
        <span class="s3">default</span><span class="s2">:</span>
          <span class="s3">break</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s1">source </span><span class="s2">= </span><span class="s1">compileSelector</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">, </span><span class="s1">macro</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>

      <span class="s1">loop </span><span class="s2">+= </span><span class="s1">mode </span><span class="s2">|| </span><span class="s1">mode </span><span class="s2">=== </span><span class="s3">null </span><span class="s2">? </span><span class="s4">'{' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}' </span><span class="s2">: </span><span class="s1">source</span><span class="s2">;</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s1">mode </span><span class="s2">|| </span><span class="s1">mode </span><span class="s2">=== </span><span class="s3">null </span><span class="s2">&amp;&amp; </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">includes</span><span class="s2">(</span><span class="s4">':nth'</span><span class="s2">)) {</span>
        <span class="s1">loop </span><span class="s2">+= </span><span class="s1">reNthElem</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">) ? </span><span class="s4">'s.nthElement(null, 2);' </span><span class="s2">: </span><span class="s4">''</span><span class="s2">;</span>
        <span class="s1">loop </span><span class="s2">+= </span><span class="s1">reNthType</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">) ? </span><span class="s4">'s.nthOfType(null, 2);' </span><span class="s2">: </span><span class="s4">''</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s1">S_VARS</span><span class="s2">[</span><span class="s7">0</span><span class="s2">] || </span><span class="s1">M_VARS</span><span class="s2">[</span><span class="s7">0</span><span class="s2">]) {</span>
        <span class="s1">vars </span><span class="s2">= </span><span class="s4">',' </span><span class="s2">+ (</span><span class="s1">S_VARS</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">','</span><span class="s2">) || </span><span class="s1">M_VARS</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">','</span><span class="s2">));</span>
        <span class="s1">S_VARS</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s7">0</span><span class="s2">;</span>
        <span class="s1">M_VARS</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s7">0</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s1">factory </span><span class="s2">= </span><span class="s1">Function</span><span class="s2">(</span><span class="s4">'s'</span><span class="s2">, </span><span class="s1">F_INIT </span><span class="s2">+ </span><span class="s4">'{' </span><span class="s2">+ </span><span class="s1">head </span><span class="s2">+ </span><span class="s1">vars </span><span class="s2">+ </span><span class="s4">';' </span><span class="s2">+ </span><span class="s1">loop </span><span class="s2">+ </span><span class="s4">'return r;}'</span><span class="s2">)(</span><span class="s1">Snapshot</span><span class="s2">);</span>

      <span class="s3">return </span><span class="s1">mode </span><span class="s2">|| </span><span class="s1">mode </span><span class="s2">=== </span><span class="s3">null </span><span class="s2">? (</span><span class="s1">selectLambdas</span><span class="s2">[</span><span class="s1">selector</span><span class="s2">] = </span><span class="s1">factory</span><span class="s2">) : (</span><span class="s1">matchLambdas</span><span class="s2">[</span><span class="s1">selector</span><span class="s2">] = </span><span class="s1">factory</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// build conditional code to check components of selector strings</span>
  <span class="s1">compileSelector </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">expression</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>

      <span class="s3">var </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">NS</span><span class="s2">, </span><span class="s1">referenceElement</span><span class="s2">,</span>
      <span class="s1">compat</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">match</span><span class="s2">, </span><span class="s1">result</span><span class="s2">, </span><span class="s1">status</span><span class="s2">, </span><span class="s1">symbol</span><span class="s2">, </span><span class="s1">test</span><span class="s2">,</span>
      <span class="s1">type</span><span class="s2">, </span><span class="s1">selector </span><span class="s2">= </span><span class="s1">expression</span><span class="s2">, </span><span class="s1">selector_string</span><span class="s2">, </span><span class="s1">vars</span><span class="s2">;</span>

      <span class="s0">// original 'select' or 'match' selector string before normalization</span>
      <span class="s1">selector_string </span><span class="s2">= </span><span class="s1">mode </span><span class="s2">? </span><span class="s1">lastSelected </span><span class="s2">: </span><span class="s1">lastMatched</span><span class="s2">;</span>

      <span class="s0">// isolate selector combinators/components and normalize whitespace</span>
      <span class="s1">selector </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">STD</span><span class="s2">.</span><span class="s1">combinator</span><span class="s2">, </span><span class="s4">'$1'</span><span class="s2">);</span><span class="s0">//.replace(STD.whitespace, ' ');</span>

      <span class="s0">// javascript needs a label to break</span>
      <span class="s0">// out of the while loops processing</span>
      <span class="s1">selector_recursion_label</span><span class="s2">:</span>

      <span class="s3">while </span><span class="s2">(</span><span class="s1">selector</span><span class="s2">) {</span>

        <span class="s2">++</span><span class="s1">k</span><span class="s2">;</span>

        <span class="s0">// get namespace prefix if present or get first char of selector</span>
        <span class="s1">symbol </span><span class="s2">= </span><span class="s1">STD</span><span class="s2">.</span><span class="s1">apimethods</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">) ? </span><span class="s4">'|' </span><span class="s2">: </span><span class="s1">selector</span><span class="s2">[</span><span class="s7">0</span><span class="s2">];</span>

        <span class="s3">switch </span><span class="s2">(</span><span class="s1">symbol</span><span class="s2">) {</span>

          <span class="s0">// universal resolver</span>
          <span class="s3">case </span><span class="s4">'*'</span><span class="s2">:</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">universal</span><span class="s2">);</span>
            <span class="s3">break</span><span class="s2">;</span>

          <span class="s0">// id resolver</span>
          <span class="s3">case </span><span class="s4">'#'</span><span class="s2">:</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">id</span><span class="s2">);</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((/^' </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] + </span><span class="s4">'$/.test(e.getAttribute(&quot;id&quot;)))){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
            <span class="s3">break</span><span class="s2">;</span>

          <span class="s0">// class name resolver</span>
          <span class="s3">case </span><span class="s4">'.'</span><span class="s2">:</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">className</span><span class="s2">);</span>
            <span class="s1">compat </span><span class="s2">= (</span><span class="s1">QUIRKS_MODE </span><span class="s2">? </span><span class="s4">'i' </span><span class="s2">: </span><span class="s4">''</span><span class="s2">) + </span><span class="s4">'.test(e.getAttribute(&quot;class&quot;))'</span><span class="s2">;</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((/(^|</span><span class="s3">\\</span><span class="s4">s)' </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] + </span><span class="s4">'(</span><span class="s3">\\</span><span class="s4">s|$)/' </span><span class="s2">+ </span><span class="s1">compat </span><span class="s2">+ </span><span class="s4">')){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
            <span class="s3">break</span><span class="s2">;</span>

          <span class="s0">// tag name resolver</span>
          <span class="s3">case </span><span class="s2">(</span><span class="s8">/[_a-z]/i</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">symbol</span><span class="s2">) ? </span><span class="s1">symbol </span><span class="s2">: </span><span class="s1">undefined</span><span class="s2">):</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">tagName</span><span class="s2">);</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((e.localName==&quot;' </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] + </span><span class="s4">'&quot;)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
            <span class="s3">break</span><span class="s2">;</span>

          <span class="s0">// namespace resolver</span>
          <span class="s3">case </span><span class="s4">'|'</span><span class="s2">:</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">namespace</span><span class="s2">);</span>
                   <span class="s3">if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] == </span><span class="s4">'*'</span><span class="s2">) {</span>
              <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(true){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
            <span class="s2">} </span><span class="s3">else if </span><span class="s2">(!</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
              <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((!e.namespaceURI)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
            <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] == </span><span class="s4">'string' </span><span class="s2">&amp;&amp; </span><span class="s1">root</span><span class="s2">.</span><span class="s1">prefix </span><span class="s2">== </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
              <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((e.namespaceURI==&quot;' </span><span class="s2">+ </span><span class="s1">NAMESPACE </span><span class="s2">+ </span><span class="s4">'&quot;)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
            <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
              <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
            <span class="s2">}</span>
            <span class="s3">break</span><span class="s2">;</span>

          <span class="s0">// attributes resolver</span>
          <span class="s3">case </span><span class="s4">'['</span><span class="s2">:</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">attribute</span><span class="s2">);</span>
            <span class="s1">NS </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s7">0</span><span class="s2">].</span><span class="s1">match</span><span class="s2">(</span><span class="s1">STD</span><span class="s2">.</span><span class="s1">namespaces</span><span class="s2">);</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">];</span>
            <span class="s1">expr </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">':'</span><span class="s2">);</span>
            <span class="s1">expr </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">length </span><span class="s2">== </span><span class="s7">2 </span><span class="s2">? </span><span class="s1">expr</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] : </span><span class="s1">expr</span><span class="s2">[</span><span class="s7">0</span><span class="s2">];</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] &amp;&amp; !(</span><span class="s1">test </span><span class="s2">= </span><span class="s1">Operators</span><span class="s2">[</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">]])) {</span>
              <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
              <span class="s3">return </span><span class="s4">''</span><span class="s2">;</span>
            <span class="s2">}</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">4</span><span class="s2">] === </span><span class="s4">''</span><span class="s2">) {</span>
              <span class="s1">test </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'~=' </span><span class="s2">?</span>
                <span class="s2">{ </span><span class="s1">p1</span><span class="s2">: </span><span class="s4">'^</span><span class="s3">\\</span><span class="s4">s'</span><span class="s2">, </span><span class="s1">p2</span><span class="s2">: </span><span class="s4">'+$'</span><span class="s2">, </span><span class="s1">p3</span><span class="s2">: </span><span class="s4">'true' </span><span class="s2">} :</span>
                  <span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] </span><span class="s3">in </span><span class="s1">ATTR_STD_OPS </span><span class="s2">&amp;&amp; </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] != </span><span class="s4">'~=' </span><span class="s2">?</span>
                <span class="s2">{ </span><span class="s1">p1</span><span class="s2">: </span><span class="s4">'^'</span><span class="s2">,    </span><span class="s1">p2</span><span class="s2">: </span><span class="s4">'$'</span><span class="s2">,  </span><span class="s1">p3</span><span class="s2">: </span><span class="s4">'true' </span><span class="s2">} : </span><span class="s1">test</span><span class="s2">;</span>
            <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'~=' </span><span class="s2">&amp;&amp; </span><span class="s1">match</span><span class="s2">[</span><span class="s7">4</span><span class="s2">].</span><span class="s1">includes</span><span class="s2">(</span><span class="s4">' '</span><span class="s2">)) {</span>
              <span class="s0">// whitespace separated list but value contains space</span>
              <span class="s3">break</span><span class="s2">;</span>
            <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">4</span><span class="s2">]) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">4</span><span class="s2">] = </span><span class="s1">convertEscapes</span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">4</span><span class="s2">]).</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">RegExpChar</span><span class="s2">, </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">$&amp;'</span><span class="s2">);</span>
            <span class="s2">}</span>
            <span class="s1">type </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s7">5</span><span class="s2">] == </span><span class="s4">'i' </span><span class="s2">|| (</span><span class="s1">HTML_DOCUMENT </span><span class="s2">&amp;&amp; </span><span class="s1">HTML_TABLE</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">toLowerCase</span><span class="s2">()]) ? </span><span class="s4">'i' </span><span class="s2">: </span><span class="s4">''</span><span class="s2">;</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((' </span><span class="s2">+</span>
              <span class="s2">(!</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] ? (</span><span class="s1">NS </span><span class="s2">? </span><span class="s4">'s.hasAttributeNS(e,&quot;' </span><span class="s2">+ </span><span class="s1">name </span><span class="s2">+ </span><span class="s4">'&quot;)' </span><span class="s2">: </span><span class="s4">'e.hasAttribute&amp;&amp;e.hasAttribute(&quot;' </span><span class="s2">+ </span><span class="s1">name </span><span class="s2">+ </span><span class="s4">'&quot;)'</span><span class="s2">) :</span>
              <span class="s2">!</span><span class="s1">match</span><span class="s2">[</span><span class="s7">4</span><span class="s2">] &amp;&amp; </span><span class="s1">ATTR_STD_OPS</span><span class="s2">[</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">]] &amp;&amp; </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] != </span><span class="s4">'~=' </span><span class="s2">? </span><span class="s4">'e.getAttribute&amp;&amp;e.getAttribute(&quot;' </span><span class="s2">+ </span><span class="s1">name </span><span class="s2">+ </span><span class="s4">'&quot;)==&quot;&quot;' </span><span class="s2">:</span>
              <span class="s4">'(/' </span><span class="s2">+ </span><span class="s1">test</span><span class="s2">.</span><span class="s1">p1 </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">[</span><span class="s7">4</span><span class="s2">] + </span><span class="s1">test</span><span class="s2">.</span><span class="s1">p2 </span><span class="s2">+ </span><span class="s4">'/' </span><span class="s2">+ </span><span class="s1">type </span><span class="s2">+ </span><span class="s4">').test(e.getAttribute&amp;&amp;e.getAttribute(&quot;' </span><span class="s2">+ </span><span class="s1">name </span><span class="s2">+ </span><span class="s4">'&quot;))==' </span><span class="s2">+ </span><span class="s1">test</span><span class="s2">.</span><span class="s1">p3</span><span class="s2">) +</span>
              <span class="s4">')){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
            <span class="s3">break</span><span class="s2">;</span>

          <span class="s0">// *** General sibling combinator</span>
          <span class="s0">// E ~ F (F relative sibling of E)</span>
          <span class="s3">case </span><span class="s4">'~'</span><span class="s2">:</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">relative</span><span class="s2">);</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s4">'var N' </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">'=e;while(e&amp;&amp;(e=e.previousElementSibling)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}e=N' </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">';'</span><span class="s2">;</span>
            <span class="s3">break</span><span class="s2">;</span>
          <span class="s0">// *** Adjacent sibling combinator</span>
          <span class="s0">// E + F (F adiacent sibling of E)</span>
          <span class="s3">case </span><span class="s4">'+'</span><span class="s2">:</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">adjacent</span><span class="s2">);</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s4">'var N' </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">'=e;if(e&amp;&amp;(e=e.previousElementSibling)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}e=N' </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">';'</span><span class="s2">;</span>
            <span class="s3">break</span><span class="s2">;</span>
          <span class="s0">// *** Descendant combinator</span>
          <span class="s0">// E F (E ancestor of F)</span>
          <span class="s3">case </span><span class="s4">'</span><span class="s3">\x09</span><span class="s4">'</span><span class="s2">:</span>
          <span class="s3">case </span><span class="s4">'</span><span class="s3">\x20</span><span class="s4">'</span><span class="s2">:</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">ancestor</span><span class="s2">);</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s4">'var N' </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">'=e;while(e&amp;&amp;(e=e.parentElement)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}e=N' </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">';'</span><span class="s2">;</span>
            <span class="s3">break</span><span class="s2">;</span>
          <span class="s0">// *** Child combinator</span>
          <span class="s0">// E &gt; F (F children of E)</span>
          <span class="s3">case </span><span class="s4">'&gt;'</span><span class="s2">:</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">children</span><span class="s2">);</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s4">'var N' </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">'=e;if(e&amp;&amp;(e=e.parentElement)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}e=N' </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">';'</span><span class="s2">;</span>
            <span class="s3">break</span><span class="s2">;</span>

          <span class="s0">// *** user supplied combinators extensions</span>
          <span class="s3">case </span><span class="s2">(</span><span class="s1">symbol </span><span class="s3">in </span><span class="s1">Combinators </span><span class="s2">? </span><span class="s1">symbol </span><span class="s2">: </span><span class="s1">undefined</span><span class="s2">):</span>
            <span class="s0">// for other registered combinators extensions</span>
            <span class="s1">match</span><span class="s2">[</span><span class="s1">match</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s7">1</span><span class="s2">] = </span><span class="s4">'*'</span><span class="s2">;</span>
            <span class="s1">source </span><span class="s2">= </span><span class="s1">Combinators</span><span class="s2">[</span><span class="s1">symbol</span><span class="s2">](</span><span class="s1">match</span><span class="s2">) + </span><span class="s1">source</span><span class="s2">;</span>
            <span class="s3">break</span><span class="s2">;</span>

          <span class="s0">// *** tree-structural pseudo-classes</span>
          <span class="s0">// :root, :empty, :first-child, :last-child, :only-child, :first-of-type, :last-of-type, :only-of-type</span>
          <span class="s3">case </span><span class="s4">':'</span><span class="s2">:</span>
            <span class="s3">if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">structural</span><span class="s2">))) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">();</span>
              <span class="s3">switch </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
               <span class="s3">case </span><span class="s4">'scope'</span><span class="s2">:</span>
                  <span class="s0">// use the root (documentElement) when comparing against a document</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(e===(s.from.nodeType===9?s.root:s.from)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'root'</span><span class="s2">:</span>
                  <span class="s0">// there can only be one :root element, so exit the loop once found</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((e===s.root)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ (</span><span class="s1">mode </span><span class="s2">? </span><span class="s4">'break main;' </span><span class="s2">: </span><span class="s4">''</span><span class="s2">) + </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'empty'</span><span class="s2">:</span>
                  <span class="s0">// matches elements that don't contain elements or text nodes</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'n=e.firstChild;while(n&amp;&amp;!(/1|3/).test(n.nodeType)){n=n.nextSibling}if(!n){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>

                <span class="s0">// *** child-indexed pseudo-classes</span>
                <span class="s0">// :first-child, :last-child, :only-child</span>
                <span class="s3">case </span><span class="s4">'only-child'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((!e.nextElementSibling&amp;&amp;!e.previousElementSibling)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'last-child'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((!e.nextElementSibling)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'first-child'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((!e.previousElementSibling)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>

                <span class="s0">// *** typed child-indexed pseudo-classes</span>
                <span class="s0">// :only-of-type, :last-of-type, :first-of-type</span>
                <span class="s3">case </span><span class="s4">'only-of-type'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'o=e.localName;' </span><span class="s2">+</span>
                    <span class="s4">'n=e;while((n=n.nextElementSibling)&amp;&amp;n.localName!=o);if(!n){' </span><span class="s2">+</span>
                    <span class="s4">'n=e;while((n=n.previousElementSibling)&amp;&amp;n.localName!=o);}if(!n){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'last-of-type'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'n=e;o=e.localName;while((n=n.nextElementSibling)&amp;&amp;n.localName!=o);if(!n){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'first-of-type'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'n=e;o=e.localName;while((n=n.previousElementSibling)&amp;&amp;n.localName!=o);if(!n){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">default</span><span class="s2">:</span>
                  <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
                  <span class="s3">break</span><span class="s2">;</span>
              <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">// *** child-indexed &amp; typed child-indexed pseudo-classes</span>
            <span class="s0">// :nth-child, :nth-of-type, :nth-last-child, :nth-last-of-type</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">treestruct</span><span class="s2">))) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">();</span>
              <span class="s3">switch </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
                <span class="s3">case </span><span class="s4">'nth-child'</span><span class="s2">:</span>
                <span class="s3">case </span><span class="s4">'nth-of-type'</span><span class="s2">:</span>
                <span class="s3">case </span><span class="s4">'nth-last-child'</span><span class="s2">:</span>
                <span class="s3">case </span><span class="s4">'nth-last-of-type'</span><span class="s2">:</span>
                  <span class="s1">expr </span><span class="s2">= </span><span class="s8">/-of-type/i</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]);</span>
                  <span class="s3">if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] &amp;&amp; </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">]) {</span>
                    <span class="s1">type </span><span class="s2">= </span><span class="s8">/last/i</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]);</span>
                    <span class="s3">if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'n'</span><span class="s2">) {</span>
                      <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(true){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                      <span class="s3">break</span><span class="s2">;</span>
                    <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'1'</span><span class="s2">) {</span>
                      <span class="s1">test </span><span class="s2">= </span><span class="s1">type </span><span class="s2">? </span><span class="s4">'next' </span><span class="s2">: </span><span class="s4">'previous'</span><span class="s2">;</span>
                      <span class="s1">source </span><span class="s2">= </span><span class="s1">expr </span><span class="s2">? </span><span class="s4">'n=e;o=e.localName;' </span><span class="s2">+</span>
                        <span class="s4">'while((n=n.' </span><span class="s2">+ </span><span class="s1">test </span><span class="s2">+ </span><span class="s4">'ElementSibling)&amp;&amp;n.localName!=o);if(!n){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}' </span><span class="s2">:</span>
                        <span class="s4">'if(!e.' </span><span class="s2">+ </span><span class="s1">test </span><span class="s2">+ </span><span class="s4">'ElementSibling){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                      <span class="s3">break</span><span class="s2">;</span>
                    <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'even' </span><span class="s2">|| </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'2n0' </span><span class="s2">|| </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'2n+0' </span><span class="s2">|| </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'2n'</span><span class="s2">) {</span>
                      <span class="s1">test </span><span class="s2">= </span><span class="s4">'n%2==0'</span><span class="s2">;</span>
                    <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'odd'  </span><span class="s2">|| </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'2n1' </span><span class="s2">|| </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'2n+1'</span><span class="s2">) {</span>
                      <span class="s1">test </span><span class="s2">= </span><span class="s4">'n%2==1'</span><span class="s2">;</span>
                    <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
                      <span class="s1">f </span><span class="s2">= </span><span class="s8">/n/i</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">]);</span>
                      <span class="s1">n </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s4">'n'</span><span class="s2">);</span>
                      <span class="s1">a </span><span class="s2">= </span><span class="s1">parseInt</span><span class="s2">(</span><span class="s1">n</span><span class="s2">[</span><span class="s7">0</span><span class="s2">], </span><span class="s7">10</span><span class="s2">) || </span><span class="s7">0</span><span class="s2">;</span>
                      <span class="s1">b </span><span class="s2">= </span><span class="s1">parseInt</span><span class="s2">(</span><span class="s1">n</span><span class="s2">[</span><span class="s7">1</span><span class="s2">], </span><span class="s7">10</span><span class="s2">) || </span><span class="s7">0</span><span class="s2">;</span>
                      <span class="s3">if </span><span class="s2">(</span><span class="s1">n</span><span class="s2">[</span><span class="s7">0</span><span class="s2">] == </span><span class="s4">'-'</span><span class="s2">) { </span><span class="s1">a </span><span class="s2">= -</span><span class="s7">1</span><span class="s2">; }</span>
                      <span class="s3">if </span><span class="s2">(</span><span class="s1">n</span><span class="s2">[</span><span class="s7">0</span><span class="s2">] == </span><span class="s4">'+'</span><span class="s2">) { </span><span class="s1">a </span><span class="s2">= +</span><span class="s7">1</span><span class="s2">; }</span>
                      <span class="s1">test </span><span class="s2">= (</span><span class="s1">b </span><span class="s2">? </span><span class="s4">'(n' </span><span class="s2">+ (</span><span class="s1">b </span><span class="s2">&gt; </span><span class="s7">0 </span><span class="s2">? </span><span class="s4">'-' </span><span class="s2">: </span><span class="s4">'+'</span><span class="s2">) + </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">b</span><span class="s2">) + </span><span class="s4">')' </span><span class="s2">: </span><span class="s4">'n'</span><span class="s2">) + </span><span class="s4">'%' </span><span class="s2">+ </span><span class="s1">a </span><span class="s2">+ </span><span class="s4">'==0' </span><span class="s2">;</span>
                      <span class="s1">test </span><span class="s2">=</span>
                        <span class="s1">a </span><span class="s2">&gt;= +</span><span class="s7">1 </span><span class="s2">? (</span><span class="s1">f </span><span class="s2">? </span><span class="s4">'n&gt;' </span><span class="s2">+ (</span><span class="s1">b </span><span class="s2">- </span><span class="s7">1</span><span class="s2">) + (</span><span class="s1">Math</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) != </span><span class="s7">1 </span><span class="s2">? </span><span class="s4">'&amp;&amp;' </span><span class="s2">+ </span><span class="s1">test </span><span class="s2">: </span><span class="s4">''</span><span class="s2">) : </span><span class="s4">'n==' </span><span class="s2">+ </span><span class="s1">a</span><span class="s2">) :</span>
                        <span class="s1">a </span><span class="s2">&lt;= -</span><span class="s7">1 </span><span class="s2">? (</span><span class="s1">f </span><span class="s2">? </span><span class="s4">'n&lt;' </span><span class="s2">+ (</span><span class="s1">b </span><span class="s2">+ </span><span class="s7">1</span><span class="s2">) + (</span><span class="s1">Math</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) != </span><span class="s7">1 </span><span class="s2">? </span><span class="s4">'&amp;&amp;' </span><span class="s2">+ </span><span class="s1">test </span><span class="s2">: </span><span class="s4">''</span><span class="s2">) : </span><span class="s4">'n==' </span><span class="s2">+ </span><span class="s1">a</span><span class="s2">) :</span>
                        <span class="s1">a </span><span class="s2">=== </span><span class="s7">0 </span><span class="s2">? (</span><span class="s1">n</span><span class="s2">[</span><span class="s7">0</span><span class="s2">] ? </span><span class="s4">'n==' </span><span class="s2">+ </span><span class="s1">b </span><span class="s2">: </span><span class="s4">'n&gt;' </span><span class="s2">+ (</span><span class="s1">b </span><span class="s2">- </span><span class="s7">1</span><span class="s2">)) : </span><span class="s4">'false'</span><span class="s2">;</span>
                    <span class="s2">}</span>
                    <span class="s1">expr </span><span class="s2">= </span><span class="s1">expr </span><span class="s2">? </span><span class="s4">'OfType' </span><span class="s2">: </span><span class="s4">'Element'</span><span class="s2">;</span>
                    <span class="s1">type </span><span class="s2">= </span><span class="s1">type </span><span class="s2">? </span><span class="s4">'true' </span><span class="s2">: </span><span class="s4">'false'</span><span class="s2">;</span>
                    <span class="s1">source </span><span class="s2">= </span><span class="s4">'n=s.nth' </span><span class="s2">+ </span><span class="s1">expr </span><span class="s2">+ </span><span class="s4">'(e,' </span><span class="s2">+ </span><span class="s1">type </span><span class="s2">+ </span><span class="s4">');if((' </span><span class="s2">+ </span><span class="s1">test </span><span class="s2">+ </span><span class="s4">')){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
                    <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
                  <span class="s2">}</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">default</span><span class="s2">:</span>
                  <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
                  <span class="s3">break</span><span class="s2">;</span>
              <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">// *** logical combination pseudo-classes</span>
            <span class="s0">// :is( s1, [ s2, ... ]), :not( s1, [ s2, ... ])</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">logicalsel</span><span class="s2">))) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">();</span>
              <span class="s1">expr </span><span class="s2">= </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">].</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">CommaGroup</span><span class="s2">, </span><span class="s4">','</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">TrimSpaces</span><span class="s2">, </span><span class="s4">''</span><span class="s2">);</span>
              <span class="s3">switch </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
                <span class="s3">case </span><span class="s4">'is'</span><span class="s2">:</span>
                <span class="s3">case </span><span class="s4">'where'</span><span class="s2">:</span>
                <span class="s3">case </span><span class="s4">'matches'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(s.match(&quot;' </span><span class="s2">+ </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s8">/\x22/g</span><span class="s2">, </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">&quot;'</span><span class="s2">) + </span><span class="s4">'&quot;,e)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'not'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(!s.match(&quot;' </span><span class="s2">+ </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s8">/\x22/g</span><span class="s2">, </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">&quot;'</span><span class="s2">) + </span><span class="s4">'&quot;,e)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'has'</span><span class="s2">:</span>
                         <span class="s3">if </span><span class="s2">(</span><span class="s8">/^\s*[+]/</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">])) {</span>
                    <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(e.parentElement &amp;&amp; [].slice.call(e.parentElement.querySelectorAll(&quot;*' </span><span class="s2">+ </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s8">/\x22/g</span><span class="s2">, </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">&quot;'</span><span class="s2">) + </span><span class="s4">'&quot;)).includes(e.nextElementSibling)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s8">/^\s*[~]/</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">])) {</span>
                    <span class="s1">source </span><span class="s2">= </span><span class="s4">'if([].slice.call(e.parentElement.children).includes(e.nextElementSibling)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
                    <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(e.querySelector(&quot;:scope ' </span><span class="s2">+ </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s8">/\x22/g</span><span class="s2">, </span><span class="s4">'</span><span class="s3">\\</span><span class="s4">&quot;'</span><span class="s2">) + </span><span class="s4">'&quot;)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s2">}</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">default</span><span class="s2">:</span>
                  <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
                  <span class="s3">break</span><span class="s2">;</span>
              <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">// *** linguistic pseudo-classes</span>
            <span class="s0">// :dir( ltr / rtl ), :lang( en )</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">linguistic</span><span class="s2">))) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">();</span>
              <span class="s3">switch </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
                <span class="s3">case </span><span class="s4">'dir'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'var p;if((' </span><span class="s2">+</span>
                    <span class="s4">'(/' </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] + </span><span class="s4">'/i.test(e.dir))||(p=s.ancestor(&quot;[dir]&quot;, e))&amp;&amp;' </span><span class="s2">+</span>
                    <span class="s4">'(/' </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] + </span><span class="s4">'/i.test(p.dir))||(e.dir==&quot;&quot;||e.dir==&quot;auto&quot;)&amp;&amp;' </span><span class="s2">+</span>
                    <span class="s4">'(' </span><span class="s2">+ (</span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] == </span><span class="s4">'ltr' </span><span class="s2">? </span><span class="s4">'!'</span><span class="s2">:</span><span class="s4">''</span><span class="s2">)+ </span><span class="s1">RTL </span><span class="s2">+</span><span class="s4">'.test(e.textContent)))' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'};'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'lang'</span><span class="s2">:</span>
                  <span class="s1">expr </span><span class="s2">= </span><span class="s4">'(?:^|-)' </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] + </span><span class="s4">'(?:-|$)'</span><span class="s2">;</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'var p;if((' </span><span class="s2">+</span>
                    <span class="s4">'(e.isConnected&amp;&amp;(e.lang==&quot;&quot;&amp;&amp;(p=s.ancestor(&quot;[lang]&quot;,e)))&amp;&amp;' </span><span class="s2">+</span>
                    <span class="s4">'(p.lang==&quot;' </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">[</span><span class="s7">2</span><span class="s2">] + </span><span class="s4">'&quot;)||/'</span><span class="s2">+ </span><span class="s1">expr </span><span class="s2">+</span><span class="s4">'/i.test(e.lang)))' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'};'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">default</span><span class="s2">:</span>
                  <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
                  <span class="s3">break</span><span class="s2">;</span>
              <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">// *** location pseudo-classes</span>
            <span class="s0">// :any-link, :link, :visited, :target</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">locationpc</span><span class="s2">))) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">();</span>
              <span class="s3">switch </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
                <span class="s3">case </span><span class="s4">'any-link'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((/^a|area$/i.test(e.localName)&amp;&amp;e.hasAttribute(&quot;href&quot;)||e.visited)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'link'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((/^a|area$/i.test(e.localName)&amp;&amp;e.hasAttribute(&quot;href&quot;))){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'visited'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((/^a|area$/i.test(e.localName)&amp;&amp;e.hasAttribute(&quot;href&quot;)&amp;&amp;e.visited)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'target'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(((s.doc.compareDocumentPosition(e)&amp;16)&amp;&amp;s.doc.location.hash&amp;&amp;e.id==s.doc.location.hash.slice(1))){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">default</span><span class="s2">:</span>
                  <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
                  <span class="s3">break</span><span class="s2">;</span>
              <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">// *** user actions pseudo-classes</span>
            <span class="s0">// :hover, :active, :focus, :focus-visible, :focus-within</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">useraction</span><span class="s2">))) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">();</span>
              <span class="s3">switch </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
                <span class="s3">case </span><span class="s4">'hover'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(e===s.HOVER){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'active'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(e===s.doc.activeElement){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'focus'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(s.isFocusable(e)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'focus-visible'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(n=s.isFocusable(e)){' </span><span class="s2">+</span>
                    <span class="s4">'if(e!==n){while(e){e=e.parentElement;if(e===n)break;}}}' </span><span class="s2">+</span>
                    <span class="s4">'if((e===n||e.autofocus)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'focus-within'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(n=s.isFocusable(e)){' </span><span class="s2">+</span>
                    <span class="s4">'if(n!==e){while(n){n=n.parentElement;if(n===e)break;}}}' </span><span class="s2">+</span>
                    <span class="s4">'if((n===e||n.autofocus)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">default</span><span class="s2">:</span>
                  <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
                  <span class="s3">break</span><span class="s2">;</span>
              <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">// *** user interface and form pseudo-classes</span>
            <span class="s0">// :enabled, :disabled, :read-only, :read-write, :placeholder-shown, :default</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">inputstate</span><span class="s2">))) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">();</span>
              <span class="s3">switch </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
                <span class="s3">case </span><span class="s4">'enabled'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(((&quot;form&quot; in e||/^optgroup$/i.test(e.localName))&amp;&amp;&quot;disabled&quot; in e &amp;&amp;e.disabled===false' </span><span class="s2">+</span>
                    <span class="s4">')){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'disabled'</span><span class="s2">:</span>
                  <span class="s0">// https://html.spec.whatwg.org/#enabling-and-disabling-form-controls:-the-disabled-attribute</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(((&quot;form&quot; in e||/^optgroup$/i.test(e.localName))&amp;&amp;&quot;disabled&quot; in e)){' </span><span class="s2">+</span>
                    <span class="s0">// F is true if any of the fieldset elements in the ancestry chain has the disabled attribute specified</span>
                    <span class="s0">// L is true if the first legend element of the fieldset contains the element</span>
                    <span class="s4">'var x=0,N=[],F=false,L=false;' </span><span class="s2">+</span>
                    <span class="s4">'if(!(/^(optgroup|option)$/i.test(e.localName))){' </span><span class="s2">+</span>
                      <span class="s4">'n=e.parentElement;' </span><span class="s2">+</span>
                      <span class="s4">'while(n){' </span><span class="s2">+</span>
                        <span class="s4">'if(n.localName==&quot;fieldset&quot;){' </span><span class="s2">+</span>
                          <span class="s4">'N[x++]=n;' </span><span class="s2">+</span>
                          <span class="s4">'if(n.disabled===true){' </span><span class="s2">+</span>
                            <span class="s4">'F=true;' </span><span class="s2">+</span>
                            <span class="s4">'break;' </span><span class="s2">+</span>
                          <span class="s4">'}' </span><span class="s2">+</span>
                        <span class="s4">'}' </span><span class="s2">+</span>
                        <span class="s4">'n=n.parentElement;' </span><span class="s2">+</span>
                      <span class="s4">'}' </span><span class="s2">+</span>
                      <span class="s4">'for(var x=0;x&lt;N.length;x++){' </span><span class="s2">+</span>
                        <span class="s4">'if((n=s.first(&quot;legend&quot;,N[x]))&amp;&amp;n.contains(e)){' </span><span class="s2">+</span>
                          <span class="s4">'L=true;' </span><span class="s2">+</span>
                          <span class="s4">'break;' </span><span class="s2">+</span>
                        <span class="s4">'}' </span><span class="s2">+</span>
                      <span class="s4">'}' </span><span class="s2">+</span>
                    <span class="s4">'}' </span><span class="s2">+</span>
                    <span class="s4">'if(e.disabled===true||(F&amp;&amp;!L)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'read-only'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if(' </span><span class="s2">+</span>
                      <span class="s4">'(/^textarea$/i.test(e.localName)&amp;&amp;(e.readOnly||e.disabled))||' </span><span class="s2">+</span>
                      <span class="s4">'(/^input$/i.test(e.localName)&amp;&amp;(&quot;|date|datetime-local|email|month|number|password|search|tel|text|time|url|week|&quot;.includes(&quot;|&quot;+e.type+&quot;|&quot;)?(e.readOnly||e.disabled):true))||' </span><span class="s2">+</span>
                      <span class="s4">'(!/^(?:input|textarea)$/i.test(e.localName) &amp;&amp; !s.isContentEditable(e))' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'read-write'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if(' </span><span class="s2">+</span>
                      <span class="s4">'(/^textarea$/i.test(e.localName)&amp;&amp;!e.readOnly&amp;&amp;!e.disabled)||' </span><span class="s2">+</span>
                      <span class="s4">'(/^input$/i.test(e.localName)&amp;&amp;&quot;|date|datetime-local|email|month|number|password|search|tel|text|time|url|week|&quot;.includes(&quot;|&quot;+e.type+&quot;|&quot;)&amp;&amp;!e.readOnly&amp;&amp;!e.disabled)||' </span><span class="s2">+</span>
                      <span class="s4">'(!/^(?:input|textarea)$/i.test(e.localName) &amp;&amp; s.isContentEditable(e))' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'placeholder-shown'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if((' </span><span class="s2">+</span>
                      <span class="s4">'(/^input|textarea$/i.test(e.localName))&amp;&amp;e.hasAttribute(&quot;placeholder&quot;)&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(&quot;|textarea|password|number|search|email|text|tel|url|&quot;.includes(&quot;|&quot;+e.type+&quot;|&quot;))&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(!s.match(&quot;:focus&quot;,e))' </span><span class="s2">+</span>
                    <span class="s4">')){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'default'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if((&quot;form&quot; in e &amp;&amp; e.form)){' </span><span class="s2">+</span>
                      <span class="s4">'var x=0;n=[];' </span><span class="s2">+</span>
                      <span class="s4">'if(e.type==&quot;image&quot;)n=e.form.getElementsByTagName(&quot;input&quot;);' </span><span class="s2">+</span>
                      <span class="s4">'if(e.type==&quot;submit&quot;)n=e.form.elements;' </span><span class="s2">+</span>
                      <span class="s4">'while(n[x]&amp;&amp;e!==n[x]){' </span><span class="s2">+</span>
                        <span class="s4">'if(n[x].type==&quot;image&quot;)break;' </span><span class="s2">+</span>
                        <span class="s4">'if(n[x].type==&quot;submit&quot;)break;' </span><span class="s2">+</span>
                        <span class="s4">'x++;' </span><span class="s2">+</span>
                      <span class="s4">'}' </span><span class="s2">+</span>
                    <span class="s4">'}' </span><span class="s2">+</span>
                    <span class="s4">'if((e.form&amp;&amp;(e===n[x]&amp;&amp;&quot;|image|submit|&quot;.includes(&quot;|&quot;+e.type+&quot;|&quot;))||' </span><span class="s2">+</span>
                      <span class="s4">'((/^option$/i.test(e.localName))&amp;&amp;e.defaultSelected)||' </span><span class="s2">+</span>
                      <span class="s4">'((&quot;|radio|checkbox|&quot;.includes(&quot;|&quot;+e.type+&quot;|&quot;))&amp;&amp;e.defaultChecked)' </span><span class="s2">+</span>
                    <span class="s4">')){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">default</span><span class="s2">:</span>
                  <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
                  <span class="s3">break</span><span class="s2">;</span>
              <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">// *** input pseudo-classes (for form validation)</span>
            <span class="s0">// :checked, :indeterminate, :valid, :invalid, :in-range, :out-of-range, :required, :optional</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">inputvalue</span><span class="s2">))) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">();</span>
              <span class="s3">switch </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
                <span class="s3">case </span><span class="s4">'checked'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if((/^input$/i.test(e.localName)&amp;&amp;' </span><span class="s2">+</span>
                    <span class="s4">'(&quot;|radio|checkbox|&quot;.includes(&quot;|&quot;+e.type+&quot;|&quot;)&amp;&amp;e.checked)||' </span><span class="s2">+</span>
                    <span class="s4">'(/^option$/i.test(e.localName)&amp;&amp;(e.selected||e.checked))' </span><span class="s2">+</span>
                    <span class="s4">')){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'indeterminate'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if((/^progress$/i.test(e.localName)&amp;&amp;!e.hasAttribute(&quot;value&quot;))||' </span><span class="s2">+</span>
                      <span class="s4">'(/^input$/i.test(e.localName)&amp;&amp;(&quot;checkbox&quot;==e.type&amp;&amp;e.indeterminate)||' </span><span class="s2">+</span>
                      <span class="s4">'(&quot;radio&quot;==e.type&amp;&amp;e.name&amp;&amp;!s.first(&quot;input[name=&quot;+e.name+&quot;]:checked&quot;,e.form))' </span><span class="s2">+</span>
                    <span class="s4">')){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'required'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if((/^input|select|textarea$/i.test(e.localName)&amp;&amp;e.required)' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'optional'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if((/^input|select|textarea$/i.test(e.localName)&amp;&amp;!e.required)' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'invalid'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if(((' </span><span class="s2">+</span>
                      <span class="s4">'(/^form$/i.test(e.localName)&amp;&amp;!e.noValidate)||' </span><span class="s2">+</span>
                      <span class="s4">'(e.willValidate&amp;&amp;!e.formNoValidate))&amp;&amp;!e.checkValidity())||' </span><span class="s2">+</span>
                      <span class="s4">'(/^fieldset$/i.test(e.localName)&amp;&amp;s.first(&quot;:invalid&quot;,e))' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'valid'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if(((' </span><span class="s2">+</span>
                      <span class="s4">'(/^form$/i.test(e.localName)&amp;&amp;!e.noValidate)||' </span><span class="s2">+</span>
                      <span class="s4">'(e.willValidate&amp;&amp;!e.formNoValidate))&amp;&amp;e.checkValidity())||' </span><span class="s2">+</span>
                      <span class="s4">'(/^fieldset$/i.test(e.localName)&amp;&amp;s.first(&quot;:valid&quot;,e))' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'in-range'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if((/^input$/i.test(e.localName))&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(e.willValidate&amp;&amp;!e.formNoValidate)&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(!e.validity.rangeUnderflow&amp;&amp;!e.validity.rangeOverflow)&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(&quot;|date|datetime-local|month|number|range|time|week|&quot;.includes(&quot;|&quot;+e.type+&quot;|&quot;))&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(&quot;range&quot;==e.type||e.getAttribute(&quot;min&quot;)||e.getAttribute(&quot;max&quot;))' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'out-of-range'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">=</span>
                    <span class="s4">'if((/^input$/i.test(e.localName))&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(e.willValidate&amp;&amp;!e.formNoValidate)&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(e.validity.rangeUnderflow||e.validity.rangeOverflow)&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(&quot;|date|datetime-local|month|number|range|time|week|&quot;.includes(&quot;|&quot;+e.type+&quot;|&quot;))&amp;&amp;' </span><span class="s2">+</span>
                      <span class="s4">'(&quot;range&quot;==e.type||e.getAttribute(&quot;min&quot;)||e.getAttribute(&quot;max&quot;))' </span><span class="s2">+</span>
                    <span class="s4">'){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">default</span><span class="s2">:</span>
                  <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
                  <span class="s3">break</span><span class="s2">;</span>
              <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">// resources state pseudo-classes (multimedia state)</span>
            <span class="s0">// :playing, :paused, :seeking, :buffering, :stalled, :muted, :volume-locked</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">rsrc_state</span><span class="s2">))) {</span>
              <span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">();</span>
              <span class="s3">switch </span><span class="s2">(</span><span class="s1">match</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]) {</span>
                <span class="s3">case </span><span class="s4">'playing'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(s.isPlaying(e)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'paused'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(!s.isPlaying(e)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'seeking'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(!s.isPlaying(e)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'buffering'</span><span class="s2">:</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'stalled'</span><span class="s2">:</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'muted'</span><span class="s2">:</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(e.localName==&quot;audio&quot;&amp;&amp;e.getAttribute(&quot;muted&quot;)){' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">case </span><span class="s4">'volume-locked'</span><span class="s2">:</span>
                  <span class="s3">break</span><span class="s2">;</span>
                <span class="s3">default</span><span class="s2">:</span>
                  <span class="s3">break</span><span class="s2">;</span>
              <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">// placeholder for parsed only no-op selectors</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">pseudo_nop</span><span class="s2">))) {</span>
              <span class="s3">break</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s0">// allow pseudo-elements starting with single colon (:)</span>
            <span class="s0">// :after, :before, :first-letter, :first-line</span>
            <span class="s0">// assert: e.type is in double-colon format, like ::after</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">pseudo_sng</span><span class="s2">))) {</span>
              <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(e.element&amp;&amp;e.type.toLowerCase()==&quot;' </span><span class="s2">+</span>
                <span class="s4">':' </span><span class="s2">+ </span><span class="s1">match</span><span class="s2">[</span><span class="s7">0</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">() + </span><span class="s4">'&quot;){e=e.element;' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s0">// allow pseudo-elements starting with double colon (::)</span>
            <span class="s0">// ::after, ::before, ::marker, ::placeholder, ::inactive-selection, ::selection, ::-webkit-&lt;foo-bar&gt;</span>
            <span class="s0">// assert: e.type is in double-colon format, like ::after</span>
            <span class="s3">else if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Patterns</span><span class="s2">.</span><span class="s1">pseudo_dbl</span><span class="s2">))) {</span>
              <span class="s1">source </span><span class="s2">= </span><span class="s4">'if(e.element&amp;&amp;e.type.toLowerCase()==&quot;' </span><span class="s2">+</span>
                <span class="s1">match</span><span class="s2">[</span><span class="s7">0</span><span class="s2">].</span><span class="s1">toLowerCase</span><span class="s2">() + </span><span class="s4">'&quot;){e=e.element;' </span><span class="s2">+ </span><span class="s1">source </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s3">else </span><span class="s2">{</span>

              <span class="s0">// reset</span>
              <span class="s1">expr </span><span class="s2">= </span><span class="s3">false</span><span class="s2">;</span>
              <span class="s1">status </span><span class="s2">= </span><span class="s3">false</span><span class="s2">;</span>

              <span class="s0">// process registered selector extensions</span>
              <span class="s3">for </span><span class="s2">(</span><span class="s1">expr </span><span class="s3">in </span><span class="s1">Selectors</span><span class="s2">) {</span>
                <span class="s3">if </span><span class="s2">((</span><span class="s1">match </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">Selectors</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">].</span><span class="s1">Expression</span><span class="s2">))) {</span>
                  <span class="s1">result </span><span class="s2">= </span><span class="s1">Selectors</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">].</span><span class="s1">Callback</span><span class="s2">(</span><span class="s1">match</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>
                  <span class="s3">if </span><span class="s2">(</span><span class="s4">'match' </span><span class="s3">in </span><span class="s1">result</span><span class="s2">) { </span><span class="s1">match </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">match</span><span class="s2">; }</span>
                  <span class="s1">vars </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">modvar</span><span class="s2">;</span>
                  <span class="s3">if </span><span class="s2">(</span><span class="s1">mode</span><span class="s2">) {</span>
                     <span class="s0">// add extra select() vars</span>
                     <span class="s1">vars </span><span class="s2">&amp;&amp; </span><span class="s1">S_VARS</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">vars</span><span class="s2">) &lt; </span><span class="s7">0 </span><span class="s2">&amp;&amp; (</span><span class="s1">S_VARS</span><span class="s2">[</span><span class="s1">S_VARS</span><span class="s2">.</span><span class="s1">length</span><span class="s2">] = </span><span class="s1">vars</span><span class="s2">);</span>
                  <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
                     <span class="s0">// add extra match() vars</span>
                     <span class="s1">vars </span><span class="s2">&amp;&amp; </span><span class="s1">M_VARS</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">vars</span><span class="s2">) &lt; </span><span class="s7">0 </span><span class="s2">&amp;&amp; (</span><span class="s1">M_VARS</span><span class="s2">[</span><span class="s1">M_VARS</span><span class="s2">.</span><span class="s1">length</span><span class="s2">] = </span><span class="s1">vars</span><span class="s2">);</span>
                  <span class="s2">}</span>
                  <span class="s0">// extension source code</span>
                  <span class="s1">source </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">source</span><span class="s2">;</span>
                  <span class="s0">// extension status code</span>
                  <span class="s1">status </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">status</span><span class="s2">;</span>
                  <span class="s0">// break on status error</span>
                  <span class="s3">if </span><span class="s2">(</span><span class="s1">status</span><span class="s2">) { </span><span class="s3">break</span><span class="s2">; }</span>
                <span class="s2">}</span>
              <span class="s2">}</span>

              <span class="s3">if </span><span class="s2">(!</span><span class="s1">status</span><span class="s2">) {</span>
                <span class="s1">emit</span><span class="s2">(</span><span class="s4">'unknown pseudo-class selector </span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">'</span><span class="s2">);</span>
                <span class="s3">return </span><span class="s4">''</span><span class="s2">;</span>
              <span class="s2">}</span>

              <span class="s3">if </span><span class="s2">(!</span><span class="s1">expr</span><span class="s2">) {</span>
                <span class="s1">emit</span><span class="s2">(</span><span class="s4">'unknown token in selector </span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">'</span><span class="s2">);</span>
                <span class="s3">return </span><span class="s4">''</span><span class="s2">;</span>
              <span class="s2">}</span>

            <span class="s2">}</span>
            <span class="s3">break</span><span class="s2">;</span>

        <span class="s3">default</span><span class="s2">:</span>
          <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
          <span class="s3">break </span><span class="s1">selector_recursion_label</span><span class="s2">;</span>

        <span class="s2">}</span>
        <span class="s0">// end of switch symbol</span>

        <span class="s3">if </span><span class="s2">(!</span><span class="s1">match</span><span class="s2">) {</span>
          <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selector_string </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
          <span class="s3">return </span><span class="s4">''</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">// pop last component</span>
        <span class="s1">selector </span><span class="s2">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s2">}</span>
      <span class="s0">// end of while selector</span>

      <span class="s3">return </span><span class="s1">source</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// equivalent of w3c 'closest' method</span>
  <span class="s1">ancestor </span><span class="s2">=</span>
    <span class="s3">function </span><span class="s1">_closest</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s1">element</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>
      <span class="s0">// replace DOCUMENT with first element (root)</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">element</span><span class="s2">.</span><span class="s1">nodeType </span><span class="s2">=== </span><span class="s7">9</span><span class="s2">) </span><span class="s1">element </span><span class="s2">= </span><span class="s1">root</span><span class="s2">;</span>
      <span class="s0">// replace :scope with element tag references</span>
      <span class="s1">selectors </span><span class="s2">= </span><span class="s1">selectors</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s8">/:scope/ig</span><span class="s2">, </span><span class="s1">element</span><span class="s2">.</span><span class="s1">localName</span><span class="s2">);</span>
      <span class="s3">while </span><span class="s2">(</span><span class="s1">element</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">match</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s1">element</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">)) </span><span class="s3">break</span><span class="s2">;</span>
        <span class="s1">element </span><span class="s2">= </span><span class="s1">element</span><span class="s2">.</span><span class="s1">parentElement</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s1">element</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s1">match_assert </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">element</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>
      <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s3">false</span><span class="s2">; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">i</span><span class="s2">; ++</span><span class="s1">i</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">[</span><span class="s1">i</span><span class="s2">](</span><span class="s1">element</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">, </span><span class="s3">null</span><span class="s2">, </span><span class="s3">false</span><span class="s2">) &amp;&amp; (</span><span class="s1">r </span><span class="s2">= </span><span class="s3">true</span><span class="s2">);</span>
      <span class="s3">return </span><span class="s1">r</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s1">match_collect </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>
      <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">selectors</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">f </span><span class="s2">= [ ]; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">i</span><span class="s2">; ++</span><span class="s1">i</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s3">false</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>
      <span class="s3">return </span><span class="s2">{ </span><span class="s1">factory</span><span class="s2">: </span><span class="s1">f </span><span class="s2">};</span>
    <span class="s2">},</span>

  <span class="s0">// unique parser type matching/selecting</span>
  <span class="s1">parse </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s1">type</span><span class="s2">) {</span>

      <span class="s3">var </span><span class="s1">expressions</span><span class="s2">, </span><span class="s1">parsed</span><span class="s2">;</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s1">type</span><span class="s2">) </span><span class="s1">lastSelected </span><span class="s2">= </span><span class="s1">selectors</span><span class="s2">;</span>
      <span class="s3">else </span><span class="s1">lastMatched </span><span class="s2">= </span><span class="s1">selectors</span><span class="s2">;</span>

      <span class="s0">// arguments validation</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s7">0</span><span class="s2">) {</span>
        <span class="s1">emit</span><span class="s2">(</span><span class="s1">qsNotArgs</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">);</span>
        <span class="s3">return </span><span class="s1">Config</span><span class="s2">.</span><span class="s1">VERBOSITY </span><span class="s2">? </span><span class="s1">undefined </span><span class="s2">: (</span><span class="s1">type </span><span class="s2">? </span><span class="s1">none </span><span class="s2">: </span><span class="s3">false</span><span class="s2">);</span>
      <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">[</span><span class="s7">0</span><span class="s2">] === </span><span class="s4">''</span><span class="s2">) {</span>
        <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
        <span class="s3">return </span><span class="s1">Config</span><span class="s2">.</span><span class="s1">VERBOSITY </span><span class="s2">? </span><span class="s1">undefined </span><span class="s2">: (</span><span class="s1">type </span><span class="s2">? </span><span class="s1">none </span><span class="s2">: </span><span class="s3">false</span><span class="s2">);</span>
      <span class="s2">}</span>

      <span class="s0">// input NULL or UNDEFINED</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">selectors </span><span class="s2">!= </span><span class="s4">'string'</span><span class="s2">) {</span>
        <span class="s1">selectors </span><span class="s2">= </span><span class="s4">'' </span><span class="s2">+ </span><span class="s1">selectors</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s0">// normalize input string</span>
      <span class="s1">parsed </span><span class="s2">= </span><span class="s1">selectors</span><span class="s2">.</span>
        <span class="s1">replace</span><span class="s2">(</span><span class="s8">/\x00|\\$/g</span><span class="s2">, </span><span class="s4">'</span><span class="s3">\ufffd</span><span class="s4">'</span><span class="s2">).</span>
        <span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">CombineWSP</span><span class="s2">, </span><span class="s4">'</span><span class="s3">\x20</span><span class="s4">'</span><span class="s2">).</span>
        <span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">PseudosWSP</span><span class="s2">, </span><span class="s4">'$1'</span><span class="s2">).</span>
        <span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">TabCharWSP</span><span class="s2">, </span><span class="s4">'</span><span class="s3">\t</span><span class="s4">'</span><span class="s2">).</span>
        <span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">CommaGroup</span><span class="s2">, </span><span class="s4">','</span><span class="s2">).</span>
        <span class="s1">replace</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">TrimSpaces</span><span class="s2">, </span><span class="s4">''</span><span class="s2">);</span>

      <span class="s0">// parse, validate and split possible compound selectors</span>
      <span class="s3">if </span><span class="s2">((</span><span class="s1">expressions </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">reValidator</span><span class="s2">)) &amp;&amp; </span><span class="s1">expressions</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">''</span><span class="s2">) == </span><span class="s1">parsed</span><span class="s2">) {</span>
        <span class="s1">expressions </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">REX</span><span class="s2">.</span><span class="s1">SplitGroup</span><span class="s2">);</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">[</span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s7">1</span><span class="s2">] == </span><span class="s4">','</span><span class="s2">) {</span>
          <span class="s1">emit</span><span class="s2">(</span><span class="s1">qsInvalid</span><span class="s2">);</span>
          <span class="s3">return </span><span class="s1">Config</span><span class="s2">.</span><span class="s1">VERBOSITY </span><span class="s2">? </span><span class="s1">undefined </span><span class="s2">: (</span><span class="s1">type </span><span class="s2">? </span><span class="s1">none </span><span class="s2">: </span><span class="s3">false</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
        <span class="s1">emit</span><span class="s2">(</span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">selectors </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">qsInvalid</span><span class="s2">);</span>
        <span class="s3">return </span><span class="s1">Config</span><span class="s2">.</span><span class="s1">VERBOSITY </span><span class="s2">? </span><span class="s1">undefined </span><span class="s2">: (</span><span class="s1">type </span><span class="s2">? </span><span class="s1">none </span><span class="s2">: </span><span class="s3">false</span><span class="s2">);</span>
      <span class="s2">}</span>

      <span class="s3">return </span><span class="s1">expressions</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// equivalent of w3c 'matches' method</span>
  <span class="s1">match </span><span class="s2">=</span>
    <span class="s3">function </span><span class="s1">_matches</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s1">element</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>

      <span class="s3">var </span><span class="s1">expressions</span><span class="s2">;</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s1">element </span><span class="s2">&amp;&amp; </span><span class="s1">matchResolvers</span><span class="s2">[</span><span class="s1">selectors</span><span class="s2">]) {</span>
        <span class="s3">return </span><span class="s1">match_assert</span><span class="s2">(</span><span class="s1">matchResolvers</span><span class="s2">[</span><span class="s1">selectors</span><span class="s2">].</span><span class="s1">factory</span><span class="s2">, </span><span class="s1">element</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>
      <span class="s2">}</span>

      <span class="s1">expressions </span><span class="s2">= </span><span class="s1">parse</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s3">false</span><span class="s2">);</span>

      <span class="s1">matchResolvers</span><span class="s2">[</span><span class="s1">selectors</span><span class="s2">] = </span><span class="s1">match_collect</span><span class="s2">(</span><span class="s1">expressions</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>

      <span class="s3">return </span><span class="s1">match_assert</span><span class="s2">(</span><span class="s1">matchResolvers</span><span class="s2">[</span><span class="s1">selectors</span><span class="s2">].</span><span class="s1">factory</span><span class="s2">, </span><span class="s1">element</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// equivalent of w3c 'querySelector' method</span>
  <span class="s1">first </span><span class="s2">=</span>
    <span class="s3">function </span><span class="s1">_querySelector</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s7">0</span><span class="s2">) {</span>
        <span class="s1">emit</span><span class="s2">(</span><span class="s1">qsNotArgs</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s1">select</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s1">context</span><span class="s2">,</span>
        <span class="s3">typeof </span><span class="s1">callback </span><span class="s2">== </span><span class="s4">'function' </span><span class="s2">?</span>
        <span class="s3">function </span><span class="s1">firstMatch</span><span class="s2">(</span><span class="s1">element</span><span class="s2">) {</span>
          <span class="s1">callback</span><span class="s2">(</span><span class="s1">element</span><span class="s2">);</span>
          <span class="s3">return false</span><span class="s2">;</span>
        <span class="s2">} :</span>
        <span class="s3">function </span><span class="s1">firstMatch</span><span class="s2">() {</span>
          <span class="s3">return false</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">)[</span><span class="s7">0</span><span class="s2">] || </span><span class="s3">null</span><span class="s2">;</span>
    <span class="s2">},</span>

  <span class="s0">// equivalent of w3c 'querySelectorAll' method</span>
  <span class="s1">select </span><span class="s2">=</span>
    <span class="s3">function </span><span class="s1">_querySelectorAll</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>

      <span class="s3">var </span><span class="s1">expressions</span><span class="s2">, </span><span class="s1">nodes </span><span class="s2">= [ ], </span><span class="s1">parsed</span><span class="s2">, </span><span class="s1">resolver</span><span class="s2">;</span>

      <span class="s1">context </span><span class="s2">|| (</span><span class="s1">context </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">);</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">((</span><span class="s1">resolver </span><span class="s2">= </span><span class="s1">selectResolvers</span><span class="s2">[</span><span class="s1">selectors</span><span class="s2">])) {</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">resolver</span><span class="s2">.</span><span class="s1">context </span><span class="s2">=== </span><span class="s1">context </span><span class="s2">&amp;&amp; </span><span class="s1">resolver</span><span class="s2">.</span><span class="s1">callback </span><span class="s2">=== </span><span class="s1">callback</span><span class="s2">) {</span>
            <span class="s3">var </span><span class="s1">f </span><span class="s2">= </span><span class="s1">resolver</span><span class="s2">.</span><span class="s1">factory</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">resolver</span><span class="s2">.</span><span class="s1">htmlset</span><span class="s2">, </span><span class="s1">n </span><span class="s2">= </span><span class="s1">resolver</span><span class="s2">.</span><span class="s1">nodeset</span><span class="s2">;</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">n</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s7">1</span><span class="s2">) {</span>
              <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">n</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">list</span><span class="s2">; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">i</span><span class="s2">; ++</span><span class="s1">i</span><span class="s2">) {</span>
                <span class="s1">list </span><span class="s2">= </span><span class="s1">compat</span><span class="s2">[</span><span class="s1">n</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s7">0</span><span class="s2">]](</span><span class="s1">context</span><span class="s2">, </span><span class="s1">n</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">slice</span><span class="s2">(</span><span class="s7">1</span><span class="s2">))();</span>
                <span class="s3">if </span><span class="s2">(</span><span class="s1">f</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] !== </span><span class="s3">null</span><span class="s2">) {</span>
                  <span class="s1">f</span><span class="s2">[</span><span class="s1">i</span><span class="s2">](</span><span class="s1">list</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">);</span>
                <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
                  <span class="s1">nodes </span><span class="s2">= </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">list</span><span class="s2">);</span>
                <span class="s2">}</span>
              <span class="s2">}</span>
              <span class="s3">if </span><span class="s2">(</span><span class="s1">l </span><span class="s2">&gt; </span><span class="s7">1 </span><span class="s2">&amp;&amp; </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s7">1</span><span class="s2">) {</span>
                <span class="s1">nodes</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">documentOrder</span><span class="s2">);</span>
                <span class="s1">hasDupes </span><span class="s2">&amp;&amp; (</span><span class="s1">nodes </span><span class="s2">= </span><span class="s1">unique</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">));</span>
              <span class="s2">}</span>
            <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
              <span class="s3">if </span><span class="s2">(</span><span class="s1">f</span><span class="s2">[</span><span class="s7">0</span><span class="s2">]) {</span>
                <span class="s1">nodes </span><span class="s2">= </span><span class="s1">f</span><span class="s2">[</span><span class="s7">0</span><span class="s2">](</span><span class="s1">h</span><span class="s2">[</span><span class="s7">0</span><span class="s2">](), </span><span class="s1">callback</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">);</span>
              <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
                <span class="s1">nodes </span><span class="s2">= </span><span class="s1">h</span><span class="s2">[</span><span class="s7">0</span><span class="s2">]();</span>
              <span class="s2">}</span>
            <span class="s2">}</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">callback </span><span class="s2">== </span><span class="s4">'function'</span><span class="s2">) {</span>
              <span class="s1">nodes </span><span class="s2">= </span><span class="s1">concatCall</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>
            <span class="s2">}</span>
            <span class="s3">return </span><span class="s2">!</span><span class="s1">Config</span><span class="s2">.</span><span class="s1">ANODELIST </span><span class="s2">? </span><span class="s1">nodes </span><span class="s2">: </span><span class="s1">nodes </span><span class="s3">instanceof </span><span class="s1">global</span><span class="s2">.</span><span class="s1">NodeList </span><span class="s2">? </span><span class="s1">nodes </span><span class="s2">: </span><span class="s1">toNodeList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">);</span>
          <span class="s2">}</span>
        <span class="s2">}</span>
      <span class="s2">}</span>

      <span class="s1">expressions </span><span class="s2">= </span><span class="s1">parse</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s3">true</span><span class="s2">);</span>

      <span class="s0">// arguments validation</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s7">0 </span><span class="s2">|| </span><span class="s1">arguments</span><span class="s2">[</span><span class="s7">0</span><span class="s2">] === </span><span class="s4">''</span><span class="s2">) {</span>
        <span class="s1">emit</span><span class="s2">(</span><span class="s1">qsInvalid</span><span class="s2">);</span>
        <span class="s3">return </span><span class="s1">Config</span><span class="s2">.</span><span class="s1">VERBOSITY </span><span class="s2">? </span><span class="s1">undefined </span><span class="s2">: (</span><span class="s1">type </span><span class="s2">? </span><span class="s3">false </span><span class="s2">: </span><span class="s1">none</span><span class="s2">);</span>
      <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s1">lastContext </span><span class="s2">!== </span><span class="s1">context</span><span class="s2">) {</span>
        <span class="s1">lastContext </span><span class="s2">= </span><span class="s1">switchContext</span><span class="s2">(</span><span class="s1">context</span><span class="s2">);</span>
      <span class="s2">}</span>

      <span class="s0">// save/reuse factory and closure collection</span>
      <span class="s1">selectResolvers</span><span class="s2">[</span><span class="s1">selectors</span><span class="s2">] = </span><span class="s1">collect</span><span class="s2">(</span><span class="s1">expressions</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>

      <span class="s1">nodes </span><span class="s2">= </span><span class="s1">selectResolvers</span><span class="s2">[</span><span class="s1">selectors</span><span class="s2">].</span><span class="s1">results</span><span class="s2">;</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">callback </span><span class="s2">== </span><span class="s4">'function'</span><span class="s2">) {</span>
        <span class="s1">nodes </span><span class="s2">= </span><span class="s1">concatCall</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s2">!</span><span class="s1">Config</span><span class="s2">.</span><span class="s1">ANODELIST </span><span class="s2">? </span><span class="s1">nodes </span><span class="s2">: </span><span class="s1">nodes </span><span class="s3">instanceof </span><span class="s1">global</span><span class="s2">.</span><span class="s1">NodeList </span><span class="s2">? </span><span class="s1">nodes </span><span class="s2">: </span><span class="s1">toNodeList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">);</span>
    <span class="s2">},</span>

  <span class="s0">// optimize selectors avoiding duplicated checks</span>
  <span class="s1">optimize </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">, </span><span class="s1">token</span><span class="s2">) {</span>
      <span class="s3">var </span><span class="s1">index </span><span class="s2">= </span><span class="s1">token</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
      <span class="s1">length </span><span class="s2">= </span><span class="s1">token</span><span class="s2">[</span><span class="s7">1</span><span class="s2">].</span><span class="s1">length </span><span class="s2">+ </span><span class="s1">token</span><span class="s2">[</span><span class="s7">2</span><span class="s2">].</span><span class="s1">length</span><span class="s2">;</span>
      <span class="s3">return </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s7">0</span><span class="s2">, </span><span class="s1">index</span><span class="s2">) +</span>
        <span class="s2">(</span><span class="s4">' &gt;+~'</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">charAt</span><span class="s2">(</span><span class="s1">index </span><span class="s2">- </span><span class="s7">1</span><span class="s2">)) &gt; -</span><span class="s7">1 </span><span class="s2">?</span>
          <span class="s2">(</span><span class="s4">':['</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">charAt</span><span class="s2">(</span><span class="s1">index </span><span class="s2">+ </span><span class="s1">length </span><span class="s2">+ </span><span class="s7">1</span><span class="s2">)) &gt; -</span><span class="s7">1 </span><span class="s2">?</span>
          <span class="s4">'*' </span><span class="s2">: </span><span class="s4">''</span><span class="s2">) : </span><span class="s4">''</span><span class="s2">) + </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">index </span><span class="s2">+ </span><span class="s1">length </span><span class="s2">- (</span><span class="s1">token</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] == </span><span class="s4">'*' </span><span class="s2">? </span><span class="s7">1 </span><span class="s2">: </span><span class="s7">0</span><span class="s2">));</span>
    <span class="s2">},</span>

  <span class="s0">// prepare factory resolvers and closure collections</span>
  <span class="s1">collect </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">selectors</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>

      <span class="s3">var </span><span class="s1">i</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">seen </span><span class="s2">= { }, </span><span class="s1">token </span><span class="s2">= [</span><span class="s4">''</span><span class="s2">, </span><span class="s4">'*'</span><span class="s2">, </span><span class="s4">'*'</span><span class="s2">], </span><span class="s1">optimized </span><span class="s2">= </span><span class="s1">selectors</span><span class="s2">,</span>
      <span class="s1">factory </span><span class="s2">= [ ], </span><span class="s1">htmlset </span><span class="s2">= [ ], </span><span class="s1">nodeset </span><span class="s2">= [ ], </span><span class="s1">results </span><span class="s2">= [ ], </span><span class="s1">type</span><span class="s2">;</span>

      <span class="s3">for </span><span class="s2">(</span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">selectors</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">i</span><span class="s2">; ++</span><span class="s1">i</span><span class="s2">) {</span>

        <span class="s3">if </span><span class="s2">(!</span><span class="s1">seen</span><span class="s2">[</span><span class="s1">selectors</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]] &amp;&amp; (</span><span class="s1">seen</span><span class="s2">[</span><span class="s1">selectors</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]] = </span><span class="s3">true</span><span class="s2">)) {</span>
          <span class="s1">type </span><span class="s2">= </span><span class="s1">selectors</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">match</span><span class="s2">(</span><span class="s1">reOptimizer</span><span class="s2">);</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">type </span><span class="s2">&amp;&amp; </span><span class="s1">type</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] != </span><span class="s4">':' </span><span class="s2">&amp;&amp; (</span><span class="s1">token </span><span class="s2">= </span><span class="s1">type</span><span class="s2">)) {</span>
            <span class="s1">token</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] || (</span><span class="s1">token</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] = </span><span class="s4">'*'</span><span class="s2">);</span>
            <span class="s1">optimized</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">optimize</span><span class="s2">(</span><span class="s1">optimized</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">token</span><span class="s2">);</span>
          <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
            <span class="s1">token </span><span class="s2">= [</span><span class="s4">''</span><span class="s2">, </span><span class="s4">'*'</span><span class="s2">, </span><span class="s4">'*'</span><span class="s2">];</span>
          <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s1">nodeset</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">token</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] + </span><span class="s1">token</span><span class="s2">[</span><span class="s7">2</span><span class="s2">];</span>
        <span class="s1">htmlset</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">compat</span><span class="s2">[</span><span class="s1">token</span><span class="s2">[</span><span class="s7">1</span><span class="s2">]](</span><span class="s1">context</span><span class="s2">, </span><span class="s1">token</span><span class="s2">[</span><span class="s7">2</span><span class="s2">]);</span>
        <span class="s1">factory</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">optimized</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s3">true</span><span class="s2">, </span><span class="s3">null</span><span class="s2">);</span>

        <span class="s1">factory</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] ?</span>
          <span class="s1">factory</span><span class="s2">[</span><span class="s1">i</span><span class="s2">](</span><span class="s1">htmlset</span><span class="s2">[</span><span class="s1">i</span><span class="s2">](), </span><span class="s1">callback</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">results</span><span class="s2">) :</span>
          <span class="s1">results</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">htmlset</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]());</span>
      <span class="s2">}</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s1">l </span><span class="s2">&gt; </span><span class="s7">1</span><span class="s2">) {</span>
        <span class="s1">results</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">documentOrder</span><span class="s2">);</span>
        <span class="s1">hasDupes </span><span class="s2">&amp;&amp; (</span><span class="s1">results </span><span class="s2">= </span><span class="s1">unique</span><span class="s2">(</span><span class="s1">results</span><span class="s2">));</span>
      <span class="s2">}</span>

      <span class="s3">return </span><span class="s2">{</span>
        <span class="s1">callback</span><span class="s2">: </span><span class="s1">callback</span><span class="s2">,</span>
        <span class="s1">context</span><span class="s2">: </span><span class="s1">context</span><span class="s2">,</span>
        <span class="s1">factory</span><span class="s2">: </span><span class="s1">factory</span><span class="s2">,</span>
        <span class="s1">htmlset</span><span class="s2">: </span><span class="s1">htmlset</span><span class="s2">,</span>
        <span class="s1">nodeset</span><span class="s2">: </span><span class="s1">nodeset</span><span class="s2">,</span>
        <span class="s1">results</span><span class="s2">: </span><span class="s1">results</span>
      <span class="s2">};</span>

    <span class="s2">},</span>

  <span class="s0">// handlers needed for the :hover pseudo-class</span>
  <span class="s0">// track state change in browsers and headless</span>
  <span class="s1">initEnv </span><span class="s2">=</span>
    <span class="s2">(</span><span class="s3">function</span><span class="s2">() {</span>
      <span class="s1">doc</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span><span class="s4">'mouseover'</span><span class="s2">, </span><span class="s3">function</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) { </span><span class="s1">Snapshot</span><span class="s2">.</span><span class="s1">HOVER </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">target</span><span class="s2">; }, </span><span class="s3">true</span><span class="s2">);</span>
      <span class="s1">doc</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span><span class="s4">'mouseout'</span><span class="s2">, </span><span class="s3">function</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) { </span><span class="s1">Snapshot</span><span class="s2">.</span><span class="s1">HOVER </span><span class="s2">= </span><span class="s3">null</span><span class="s2">; }, </span><span class="s3">true</span><span class="s2">);</span>
    <span class="s2">})(),</span>

  <span class="s0">// QSA placeholders to native references</span>
  <span class="s1">_closest</span><span class="s2">, </span><span class="s1">_matches</span><span class="s2">,</span>
  <span class="s1">_querySelector</span><span class="s2">, </span><span class="s1">_querySelectorAll</span><span class="s2">,</span>
  <span class="s1">_querySelectorDoc</span><span class="s2">, </span><span class="s1">_querySelectorAllDoc</span><span class="s2">,</span>

  <span class="s0">// overrides QSA methods (only for browsers)</span>
  <span class="s1">install </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">(</span><span class="s1">all</span><span class="s2">) {</span>
      <span class="s0">// save references</span>
      <span class="s1">_closest </span><span class="s2">= </span><span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">closest</span><span class="s2">;</span>
      <span class="s1">_matches </span><span class="s2">= </span><span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">matches</span><span class="s2">;</span>

      <span class="s1">_querySelector </span><span class="s2">= </span><span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector</span><span class="s2">;</span>
      <span class="s1">_querySelectorAll </span><span class="s2">= </span><span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll</span><span class="s2">;</span>

      <span class="s1">_querySelectorDoc </span><span class="s2">= </span><span class="s1">Document</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector</span><span class="s2">;</span>
      <span class="s1">_querySelectorAllDoc </span><span class="s2">= </span><span class="s1">Document</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll</span><span class="s2">;</span>

      <span class="s3">function </span><span class="s1">parseQSArgs</span><span class="s2">() {</span>
        <span class="s3">var </span><span class="s1">method </span><span class="s2">= </span><span class="s1">arguments</span><span class="s2">[</span><span class="s1">arguments</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s7">1</span><span class="s2">];</span>
        <span class="s3">return </span><span class="s2">(</span>
          <span class="s1">arguments</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&lt; </span><span class="s7">2 </span><span class="s2">?</span>
            <span class="s1">method</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, [ ]) :</span>
          <span class="s1">arguments</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&lt; </span><span class="s7">3 </span><span class="s2">?</span>
            <span class="s1">method</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, [ </span><span class="s1">arguments</span><span class="s2">[</span><span class="s7">0</span><span class="s2">], </span><span class="s3">this </span><span class="s2">]) :</span>
            <span class="s1">method</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, [ </span><span class="s1">arguments</span><span class="s2">[</span><span class="s7">0</span><span class="s2">], </span><span class="s3">this</span><span class="s2">,</span>
              <span class="s3">typeof </span><span class="s1">arguments</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] == </span><span class="s4">'function' </span><span class="s2">? </span><span class="s1">arguments</span><span class="s2">[</span><span class="s7">1</span><span class="s2">] : </span><span class="s1">undefined </span><span class="s2">]));</span>
      <span class="s2">}</span>

      <span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">closest </span><span class="s2">=</span>
      <span class="s1">HTMLElement</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">closest </span><span class="s2">=</span>
        <span class="s3">function </span><span class="s1">closest</span><span class="s2">() {</span>
          <span class="s3">return </span><span class="s1">parseQSArgs</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, [].</span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">).</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">ancestor</span><span class="s2">));</span>
        <span class="s2">};</span>

      <span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">matches </span><span class="s2">=</span>
      <span class="s1">HTMLElement</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">matches </span><span class="s2">=</span>
        <span class="s3">function </span><span class="s1">matches</span><span class="s2">() {</span>
          <span class="s3">return </span><span class="s1">parseQSArgs</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, [].</span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">).</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">match</span><span class="s2">));</span>
        <span class="s2">};</span>

      <span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector </span><span class="s2">=</span>
      <span class="s1">HTMLElement</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector </span><span class="s2">=</span>
        <span class="s3">function </span><span class="s1">querySelector</span><span class="s2">() {</span>
          <span class="s3">return </span><span class="s1">parseQSArgs</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, [].</span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">).</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">first</span><span class="s2">));</span>
        <span class="s2">};</span>

      <span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll </span><span class="s2">=</span>
      <span class="s1">HTMLElement</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll </span><span class="s2">=</span>
        <span class="s3">function </span><span class="s1">querySelectorAll</span><span class="s2">() {</span>
          <span class="s3">return </span><span class="s1">parseQSArgs</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, [].</span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">).</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">select</span><span class="s2">));</span>
        <span class="s2">};</span>

      <span class="s1">Document</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector </span><span class="s2">=</span>
      <span class="s1">DocumentFragment</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector </span><span class="s2">=</span>
        <span class="s3">function </span><span class="s1">querySelector</span><span class="s2">() {</span>
          <span class="s3">return </span><span class="s1">parseQSArgs</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, [].</span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">).</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">first</span><span class="s2">));</span>
        <span class="s2">};</span>

      <span class="s1">Document</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll </span><span class="s2">=</span>
      <span class="s1">DocumentFragment</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll </span><span class="s2">=</span>
        <span class="s3">function </span><span class="s1">querySelectorAll</span><span class="s2">() {</span>
          <span class="s3">return </span><span class="s1">parseQSArgs</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, [].</span><span class="s1">slice</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">).</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">select</span><span class="s2">));</span>
      <span class="s2">};</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s1">all</span><span class="s2">) {</span>
        <span class="s1">doc</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span><span class="s4">'load'</span><span class="s2">, </span><span class="s3">function</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) {</span>
          <span class="s3">var </span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">t </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">target</span><span class="s2">;</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s8">/iframe/i</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">t</span><span class="s2">.</span><span class="s1">localName</span><span class="s2">)) {</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s4">'(' </span><span class="s2">+ </span><span class="s1">Export </span><span class="s2">+ </span><span class="s4">')(this, ' </span><span class="s2">+ </span><span class="s1">Factory </span><span class="s2">+ </span><span class="s4">');'</span><span class="s2">; </span><span class="s1">d </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">ownerDocument</span><span class="s2">;</span>
            <span class="s1">s </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'script'</span><span class="s2">); </span><span class="s1">s</span><span class="s2">.</span><span class="s1">textContent </span><span class="s2">= </span><span class="s1">c </span><span class="s2">+ </span><span class="s4">'NW.Dom.install(true)'</span><span class="s2">;</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">documentElement</span><span class="s2">; </span><span class="s1">r</span><span class="s2">.</span><span class="s1">removeChild</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">insertBefore</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">firstChild</span><span class="s2">));</span>
          <span class="s2">}</span>
        <span class="s2">}, </span><span class="s3">true</span><span class="s2">);</span>
      <span class="s2">}</span>

    <span class="s2">},</span>

  <span class="s0">// restore QSA methods (only for browsers)</span>
  <span class="s1">uninstall </span><span class="s2">=</span>
    <span class="s3">function</span><span class="s2">() {</span>
      <span class="s0">// restore references</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">_closest</span><span class="s2">) {</span>
        <span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">closest </span><span class="s2">= </span><span class="s1">_closest</span><span class="s2">;</span>
        <span class="s1">HTMLElement</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">closest </span><span class="s2">= </span><span class="s1">_closest</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">_matches</span><span class="s2">) {</span>
        <span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">matches </span><span class="s2">= </span><span class="s1">_matches</span><span class="s2">;</span>
        <span class="s1">HTMLElement</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">matches </span><span class="s2">= </span><span class="s1">_matches</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">_querySelector</span><span class="s2">) {</span>
        <span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector </span><span class="s2">=</span>
        <span class="s1">HTMLElement</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector </span><span class="s2">= </span><span class="s1">_querySelector</span><span class="s2">;</span>
        <span class="s1">Element</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll </span><span class="s2">=</span>
        <span class="s1">HTMLElement</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll </span><span class="s2">= </span><span class="s1">_querySelector</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s1">_querySelectorAllDoc</span><span class="s2">) {</span>
        <span class="s1">Document</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector </span><span class="s2">=</span>
        <span class="s1">DocumentFragment</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelector </span><span class="s2">= </span><span class="s1">_querySelectorDoc</span><span class="s2">;</span>
        <span class="s1">Document</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll </span><span class="s2">=</span>
        <span class="s1">DocumentFragment</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">querySelectorAll </span><span class="s2">= </span><span class="s1">_querySelectorAllDoc</span><span class="s2">;</span>
      <span class="s2">}</span>
    <span class="s2">},</span>

  <span class="s0">// empty set</span>
  <span class="s1">none </span><span class="s2">= </span><span class="s1">Array</span><span class="s2">(),</span>

  <span class="s0">// context</span>
  <span class="s1">lastContext</span><span class="s2">,</span>

  <span class="s0">// selector</span>
  <span class="s1">lastMatched</span><span class="s2">,</span>
  <span class="s1">lastSelected</span><span class="s2">,</span>

  <span class="s0">// cached lambdas</span>
  <span class="s1">matchLambdas </span><span class="s2">= { },</span>
  <span class="s1">selectLambdas </span><span class="s2">= { },</span>

  <span class="s0">// cached resolvers</span>
  <span class="s1">matchResolvers </span><span class="s2">= { },</span>
  <span class="s1">selectResolvers </span><span class="s2">= { },</span>

  <span class="s0">// passed to resolvers</span>
  <span class="s1">Snapshot </span><span class="s2">= {</span>

    <span class="s1">doc</span><span class="s2">: </span><span class="s1">doc</span><span class="s2">,</span>
    <span class="s1">from</span><span class="s2">: </span><span class="s1">doc</span><span class="s2">,</span>
    <span class="s1">root</span><span class="s2">: </span><span class="s1">root</span><span class="s2">,</span>

    <span class="s1">byTag</span><span class="s2">: </span><span class="s1">byTag</span><span class="s2">,</span>

    <span class="s1">first</span><span class="s2">: </span><span class="s1">first</span><span class="s2">,</span>
    <span class="s1">match</span><span class="s2">: </span><span class="s1">match</span><span class="s2">,</span>

    <span class="s1">ancestor</span><span class="s2">: </span><span class="s1">ancestor</span><span class="s2">,</span>

    <span class="s1">nthOfType</span><span class="s2">: </span><span class="s1">nthOfType</span><span class="s2">,</span>
    <span class="s1">nthElement</span><span class="s2">: </span><span class="s1">nthElement</span><span class="s2">,</span>

    <span class="s1">isFocusable</span><span class="s2">: </span><span class="s1">isFocusable</span><span class="s2">,</span>
    <span class="s1">isContentEditable</span><span class="s2">: </span><span class="s1">isContentEditable</span><span class="s2">,</span>
    <span class="s1">hasAttributeNS</span><span class="s2">: </span><span class="s1">hasAttributeNS</span>
  <span class="s2">},</span>

  <span class="s0">// public exported methods/objects</span>
  <span class="s1">Dom </span><span class="s2">= {</span>

    <span class="s0">// exported cache objects</span>

    <span class="s1">lastMatched</span><span class="s2">: </span><span class="s1">lastMatched</span><span class="s2">,</span>
    <span class="s1">lastSelected</span><span class="s2">: </span><span class="s1">lastSelected</span><span class="s2">,</span>

    <span class="s1">matchLambdas</span><span class="s2">: </span><span class="s1">matchLambdas</span><span class="s2">,</span>
    <span class="s1">selectLambdas</span><span class="s2">: </span><span class="s1">selectLambdas</span><span class="s2">,</span>

    <span class="s1">matchResolvers</span><span class="s2">: </span><span class="s1">matchResolvers</span><span class="s2">,</span>
    <span class="s1">selectResolvers</span><span class="s2">: </span><span class="s1">selectResolvers</span><span class="s2">,</span>

    <span class="s0">// exported compiler macros</span>

    <span class="s1">CFG</span><span class="s2">: </span><span class="s1">CFG</span><span class="s2">,</span>

    <span class="s1">M_BODY</span><span class="s2">: </span><span class="s1">M_BODY</span><span class="s2">,</span>
    <span class="s1">S_BODY</span><span class="s2">: </span><span class="s1">S_BODY</span><span class="s2">,</span>
    <span class="s1">M_TEST</span><span class="s2">: </span><span class="s1">M_TEST</span><span class="s2">,</span>
    <span class="s1">S_TEST</span><span class="s2">: </span><span class="s1">S_TEST</span><span class="s2">,</span>

    <span class="s0">// exported engine methods</span>

    <span class="s1">byId</span><span class="s2">: </span><span class="s1">byId</span><span class="s2">,</span>
    <span class="s1">byTag</span><span class="s2">: </span><span class="s1">byTag</span><span class="s2">,</span>
    <span class="s1">byClass</span><span class="s2">: </span><span class="s1">byClass</span><span class="s2">,</span>

    <span class="s1">match</span><span class="s2">: </span><span class="s1">match</span><span class="s2">,</span>
    <span class="s1">first</span><span class="s2">: </span><span class="s1">first</span><span class="s2">,</span>
    <span class="s1">select</span><span class="s2">: </span><span class="s1">select</span><span class="s2">,</span>
    <span class="s1">closest</span><span class="s2">: </span><span class="s1">ancestor</span><span class="s2">,</span>

    <span class="s1">compile</span><span class="s2">: </span><span class="s1">compile</span><span class="s2">,</span>
    <span class="s1">configure</span><span class="s2">: </span><span class="s1">configure</span><span class="s2">,</span>

    <span class="s1">emit</span><span class="s2">: </span><span class="s1">emit</span><span class="s2">,</span>
    <span class="s1">Config</span><span class="s2">: </span><span class="s1">Config</span><span class="s2">,</span>
    <span class="s1">Snapshot</span><span class="s2">: </span><span class="s1">Snapshot</span><span class="s2">,</span>

    <span class="s1">Version</span><span class="s2">: </span><span class="s1">version</span><span class="s2">,</span>

    <span class="s1">install</span><span class="s2">: </span><span class="s1">install</span><span class="s2">,</span>
    <span class="s1">uninstall</span><span class="s2">: </span><span class="s1">uninstall</span><span class="s2">,</span>

    <span class="s1">Operators</span><span class="s2">: </span><span class="s1">Operators</span><span class="s2">,</span>
    <span class="s1">Selectors</span><span class="s2">: </span><span class="s1">Selectors</span><span class="s2">,</span>

    <span class="s0">// register a new selector combinator symbol and its related function resolver</span>
    <span class="s1">registerCombinator</span><span class="s2">:</span>
      <span class="s3">function</span><span class="s2">(</span><span class="s1">combinator</span><span class="s2">, </span><span class="s1">resolver</span><span class="s2">) {</span>
        <span class="s3">var </span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">combinator</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">symbol</span><span class="s2">;</span>
        <span class="s3">for </span><span class="s2">(; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">i</span><span class="s2">; ++</span><span class="s1">i</span><span class="s2">) {</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">combinator</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] != </span><span class="s4">'='</span><span class="s2">) {</span>
            <span class="s1">symbol </span><span class="s2">= </span><span class="s1">combinator</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>
            <span class="s3">break</span><span class="s2">;</span>
          <span class="s2">}</span>
        <span class="s2">}</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">CFG</span><span class="s2">.</span><span class="s1">combinators</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">symbol</span><span class="s2">) &lt; </span><span class="s7">0</span><span class="s2">) {</span>
          <span class="s1">CFG</span><span class="s2">.</span><span class="s1">combinators </span><span class="s2">= </span><span class="s1">CFG</span><span class="s2">.</span><span class="s1">combinators</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">']('</span><span class="s2">, </span><span class="s1">symbol </span><span class="s2">+ </span><span class="s4">']('</span><span class="s2">);</span>
          <span class="s1">CFG</span><span class="s2">.</span><span class="s1">combinators </span><span class="s2">= </span><span class="s1">CFG</span><span class="s2">.</span><span class="s1">combinators</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">'])'</span><span class="s2">, </span><span class="s1">symbol </span><span class="s2">+ </span><span class="s4">'])'</span><span class="s2">);</span>
          <span class="s1">Combinators</span><span class="s2">[</span><span class="s1">combinator</span><span class="s2">] = </span><span class="s1">resolver</span><span class="s2">;</span>
          <span class="s1">setIdentifierSyntax</span><span class="s2">();</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
          <span class="s1">console</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s4">'Warning: the </span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">combinator </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\' </span><span class="s4">combinator is already registered.'</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">},</span>

    <span class="s0">// register a new attribute operator symbol and its related function resolver</span>
    <span class="s1">registerOperator</span><span class="s2">:</span>
      <span class="s3">function</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">, </span><span class="s1">resolver</span><span class="s2">) {</span>
        <span class="s3">var </span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">symbol</span><span class="s2">;</span>
        <span class="s3">for </span><span class="s2">(; </span><span class="s1">l </span><span class="s2">&gt; </span><span class="s1">i</span><span class="s2">; ++</span><span class="s1">i</span><span class="s2">) {</span>
          <span class="s3">if </span><span class="s2">(</span><span class="s1">operator</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] != </span><span class="s4">'='</span><span class="s2">) {</span>
            <span class="s1">symbol </span><span class="s2">= </span><span class="s1">operator</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>
            <span class="s3">break</span><span class="s2">;</span>
          <span class="s2">}</span>
        <span class="s2">}</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">CFG</span><span class="s2">.</span><span class="s1">operators</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">symbol</span><span class="s2">) &lt; </span><span class="s7">0 </span><span class="s2">&amp;&amp; !</span><span class="s1">Operators</span><span class="s2">[</span><span class="s1">operator</span><span class="s2">]) {</span>
          <span class="s1">CFG</span><span class="s2">.</span><span class="s1">operators </span><span class="s2">= </span><span class="s1">CFG</span><span class="s2">.</span><span class="s1">operators</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">']='</span><span class="s2">, </span><span class="s1">symbol </span><span class="s2">+ </span><span class="s4">']='</span><span class="s2">);</span>
          <span class="s1">Operators</span><span class="s2">[</span><span class="s1">operator</span><span class="s2">] = </span><span class="s1">resolver</span><span class="s2">;</span>
          <span class="s1">setIdentifierSyntax</span><span class="s2">();</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
          <span class="s1">console</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s4">'Warning: the </span><span class="s3">\'</span><span class="s4">' </span><span class="s2">+ </span><span class="s1">operator </span><span class="s2">+ </span><span class="s4">'</span><span class="s3">\' </span><span class="s4">operator is already registered.'</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">},</span>

    <span class="s0">// register a new selector symbol and its related function resolver</span>
    <span class="s1">registerSelector</span><span class="s2">:</span>
      <span class="s3">function</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">rexp</span><span class="s2">, </span><span class="s1">func</span><span class="s2">) {</span>
        <span class="s1">Selectors</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] || (</span><span class="s1">Selectors</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = {</span>
          <span class="s1">Expression</span><span class="s2">: </span><span class="s1">rexp</span><span class="s2">,</span>
          <span class="s1">Callback</span><span class="s2">: </span><span class="s1">func</span>
        <span class="s2">});</span>
      <span class="s2">}</span>
  <span class="s2">};</span>

  <span class="s1">initialize</span><span class="s2">(</span><span class="s1">doc</span><span class="s2">);</span>

  <span class="s3">return </span><span class="s1">Dom</span><span class="s2">;</span>
<span class="s2">});</span>
</pre>
</body>
</html>