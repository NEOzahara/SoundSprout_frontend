<html>
<head>
<title>saxes.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #67a37c; font-style: italic;}
.s8 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
saxes.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">exports</span><span class="s1">, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, { </span><span class="s2">value</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>
<span class="s3">const </span><span class="s2">ed5 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;xmlchars/xml/1.0/ed5&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">ed2 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;xmlchars/xml/1.1/ed2&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">NSed3 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;xmlchars/xmlns/1.0/ed3&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">isS </span><span class="s1">= </span><span class="s2">ed5</span><span class="s1">.</span><span class="s2">isS</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">isChar10 </span><span class="s1">= </span><span class="s2">ed5</span><span class="s1">.</span><span class="s2">isChar</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">isNameStartChar </span><span class="s1">= </span><span class="s2">ed5</span><span class="s1">.</span><span class="s2">isNameStartChar</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">isNameChar </span><span class="s1">= </span><span class="s2">ed5</span><span class="s1">.</span><span class="s2">isNameChar</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">S_LIST </span><span class="s1">= </span><span class="s2">ed5</span><span class="s1">.</span><span class="s2">S_LIST</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">NAME_RE </span><span class="s1">= </span><span class="s2">ed5</span><span class="s1">.</span><span class="s2">NAME_RE</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">isChar11 </span><span class="s1">= </span><span class="s2">ed2</span><span class="s1">.</span><span class="s2">isChar</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">isNCNameStartChar </span><span class="s1">= </span><span class="s2">NSed3</span><span class="s1">.</span><span class="s2">isNCNameStartChar</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">isNCNameChar </span><span class="s1">= </span><span class="s2">NSed3</span><span class="s1">.</span><span class="s2">isNCNameChar</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">NC_NAME_RE </span><span class="s1">= </span><span class="s2">NSed3</span><span class="s1">.</span><span class="s2">NC_NAME_RE</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">XML_NAMESPACE </span><span class="s1">= </span><span class="s0">&quot;http://www.w3.org/XML/1998/namespace&quot;</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">XMLNS_NAMESPACE </span><span class="s1">= </span><span class="s0">&quot;http://www.w3.org/2000/xmlns/&quot;</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">rootNS </span><span class="s1">= {</span>
    <span class="s4">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span>
    <span class="s2">__proto__</span><span class="s1">: </span><span class="s3">null</span><span class="s1">,</span>
    <span class="s2">xml</span><span class="s1">: </span><span class="s2">XML_NAMESPACE</span><span class="s1">,</span>
    <span class="s2">xmlns</span><span class="s1">: </span><span class="s2">XMLNS_NAMESPACE</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s3">const </span><span class="s2">XML_ENTITIES </span><span class="s1">= {</span>
    <span class="s4">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span>
    <span class="s2">__proto__</span><span class="s1">: </span><span class="s3">null</span><span class="s1">,</span>
    <span class="s2">amp</span><span class="s1">: </span><span class="s0">&quot;&amp;&quot;</span><span class="s1">,</span>
    <span class="s2">gt</span><span class="s1">: </span><span class="s0">&quot;&gt;&quot;</span><span class="s1">,</span>
    <span class="s2">lt</span><span class="s1">: </span><span class="s0">&quot;&lt;&quot;</span><span class="s1">,</span>
    <span class="s2">quot</span><span class="s1">: </span><span class="s0">&quot;</span><span class="s3">\&quot;</span><span class="s0">&quot;</span><span class="s1">,</span>
    <span class="s2">apos</span><span class="s1">: </span><span class="s0">&quot;'&quot;</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s4">// EOC: end-of-chunk</span>
<span class="s3">const </span><span class="s2">EOC </span><span class="s1">= -</span><span class="s5">1</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">NL_LIKE </span><span class="s1">= -</span><span class="s5">2</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">S_BEGIN </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s4">// Initial state.</span>
<span class="s3">const </span><span class="s2">S_BEGIN_WHITESPACE </span><span class="s1">= </span><span class="s5">1</span><span class="s1">; </span><span class="s4">// leading whitespace</span>
<span class="s3">const </span><span class="s2">S_DOCTYPE </span><span class="s1">= </span><span class="s5">2</span><span class="s1">; </span><span class="s4">// &lt;!DOCTYPE</span>
<span class="s3">const </span><span class="s2">S_DOCTYPE_QUOTE </span><span class="s1">= </span><span class="s5">3</span><span class="s1">; </span><span class="s4">// &lt;!DOCTYPE &quot;//blah</span>
<span class="s3">const </span><span class="s2">S_DTD </span><span class="s1">= </span><span class="s5">4</span><span class="s1">; </span><span class="s4">// &lt;!DOCTYPE &quot;//blah&quot; [ ...</span>
<span class="s3">const </span><span class="s2">S_DTD_QUOTED </span><span class="s1">= </span><span class="s5">5</span><span class="s1">; </span><span class="s4">// &lt;!DOCTYPE &quot;//blah&quot; [ &quot;foo</span>
<span class="s3">const </span><span class="s2">S_DTD_OPEN_WAKA </span><span class="s1">= </span><span class="s5">6</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">S_DTD_OPEN_WAKA_BANG </span><span class="s1">= </span><span class="s5">7</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">S_DTD_COMMENT </span><span class="s1">= </span><span class="s5">8</span><span class="s1">; </span><span class="s4">// &lt;!--</span>
<span class="s3">const </span><span class="s2">S_DTD_COMMENT_ENDING </span><span class="s1">= </span><span class="s5">9</span><span class="s1">; </span><span class="s4">// &lt;!-- blah -</span>
<span class="s3">const </span><span class="s2">S_DTD_COMMENT_ENDED </span><span class="s1">= </span><span class="s5">10</span><span class="s1">; </span><span class="s4">// &lt;!-- blah --</span>
<span class="s3">const </span><span class="s2">S_DTD_PI </span><span class="s1">= </span><span class="s5">11</span><span class="s1">; </span><span class="s4">// &lt;?</span>
<span class="s3">const </span><span class="s2">S_DTD_PI_ENDING </span><span class="s1">= </span><span class="s5">12</span><span class="s1">; </span><span class="s4">// &lt;?hi &quot;there&quot; ?</span>
<span class="s3">const </span><span class="s2">S_TEXT </span><span class="s1">= </span><span class="s5">13</span><span class="s1">; </span><span class="s4">// general stuff</span>
<span class="s3">const </span><span class="s2">S_ENTITY </span><span class="s1">= </span><span class="s5">14</span><span class="s1">; </span><span class="s4">// &amp;amp and such</span>
<span class="s3">const </span><span class="s2">S_OPEN_WAKA </span><span class="s1">= </span><span class="s5">15</span><span class="s1">; </span><span class="s4">// &lt;</span>
<span class="s3">const </span><span class="s2">S_OPEN_WAKA_BANG </span><span class="s1">= </span><span class="s5">16</span><span class="s1">; </span><span class="s4">// &lt;!...</span>
<span class="s3">const </span><span class="s2">S_COMMENT </span><span class="s1">= </span><span class="s5">17</span><span class="s1">; </span><span class="s4">// &lt;!--</span>
<span class="s3">const </span><span class="s2">S_COMMENT_ENDING </span><span class="s1">= </span><span class="s5">18</span><span class="s1">; </span><span class="s4">// &lt;!-- blah -</span>
<span class="s3">const </span><span class="s2">S_COMMENT_ENDED </span><span class="s1">= </span><span class="s5">19</span><span class="s1">; </span><span class="s4">// &lt;!-- blah --</span>
<span class="s3">const </span><span class="s2">S_CDATA </span><span class="s1">= </span><span class="s5">20</span><span class="s1">; </span><span class="s4">// &lt;![CDATA[ something</span>
<span class="s3">const </span><span class="s2">S_CDATA_ENDING </span><span class="s1">= </span><span class="s5">21</span><span class="s1">; </span><span class="s4">// ]</span>
<span class="s3">const </span><span class="s2">S_CDATA_ENDING_2 </span><span class="s1">= </span><span class="s5">22</span><span class="s1">; </span><span class="s4">// ]]</span>
<span class="s3">const </span><span class="s2">S_PI_FIRST_CHAR </span><span class="s1">= </span><span class="s5">23</span><span class="s1">; </span><span class="s4">// &lt;?hi, first char</span>
<span class="s3">const </span><span class="s2">S_PI_REST </span><span class="s1">= </span><span class="s5">24</span><span class="s1">; </span><span class="s4">// &lt;?hi, rest of the name</span>
<span class="s3">const </span><span class="s2">S_PI_BODY </span><span class="s1">= </span><span class="s5">25</span><span class="s1">; </span><span class="s4">// &lt;?hi there</span>
<span class="s3">const </span><span class="s2">S_PI_ENDING </span><span class="s1">= </span><span class="s5">26</span><span class="s1">; </span><span class="s4">// &lt;?hi &quot;there&quot; ?</span>
<span class="s3">const </span><span class="s2">S_XML_DECL_NAME_START </span><span class="s1">= </span><span class="s5">27</span><span class="s1">; </span><span class="s4">// &lt;?xml</span>
<span class="s3">const </span><span class="s2">S_XML_DECL_NAME </span><span class="s1">= </span><span class="s5">28</span><span class="s1">; </span><span class="s4">// &lt;?xml foo</span>
<span class="s3">const </span><span class="s2">S_XML_DECL_EQ </span><span class="s1">= </span><span class="s5">29</span><span class="s1">; </span><span class="s4">// &lt;?xml foo=</span>
<span class="s3">const </span><span class="s2">S_XML_DECL_VALUE_START </span><span class="s1">= </span><span class="s5">30</span><span class="s1">; </span><span class="s4">// &lt;?xml foo=</span>
<span class="s3">const </span><span class="s2">S_XML_DECL_VALUE </span><span class="s1">= </span><span class="s5">31</span><span class="s1">; </span><span class="s4">// &lt;?xml foo=&quot;bar&quot;</span>
<span class="s3">const </span><span class="s2">S_XML_DECL_SEPARATOR </span><span class="s1">= </span><span class="s5">32</span><span class="s1">; </span><span class="s4">// &lt;?xml foo=&quot;bar&quot;</span>
<span class="s3">const </span><span class="s2">S_XML_DECL_ENDING </span><span class="s1">= </span><span class="s5">33</span><span class="s1">; </span><span class="s4">// &lt;?xml ... ?</span>
<span class="s3">const </span><span class="s2">S_OPEN_TAG </span><span class="s1">= </span><span class="s5">34</span><span class="s1">; </span><span class="s4">// &lt;strong</span>
<span class="s3">const </span><span class="s2">S_OPEN_TAG_SLASH </span><span class="s1">= </span><span class="s5">35</span><span class="s1">; </span><span class="s4">// &lt;strong /</span>
<span class="s3">const </span><span class="s2">S_ATTRIB </span><span class="s1">= </span><span class="s5">36</span><span class="s1">; </span><span class="s4">// &lt;a</span>
<span class="s3">const </span><span class="s2">S_ATTRIB_NAME </span><span class="s1">= </span><span class="s5">37</span><span class="s1">; </span><span class="s4">// &lt;a foo</span>
<span class="s3">const </span><span class="s2">S_ATTRIB_NAME_SAW_WHITE </span><span class="s1">= </span><span class="s5">38</span><span class="s1">; </span><span class="s4">// &lt;a foo _</span>
<span class="s3">const </span><span class="s2">S_ATTRIB_VALUE </span><span class="s1">= </span><span class="s5">39</span><span class="s1">; </span><span class="s4">// &lt;a foo=</span>
<span class="s3">const </span><span class="s2">S_ATTRIB_VALUE_QUOTED </span><span class="s1">= </span><span class="s5">40</span><span class="s1">; </span><span class="s4">// &lt;a foo=&quot;bar</span>
<span class="s3">const </span><span class="s2">S_ATTRIB_VALUE_CLOSED </span><span class="s1">= </span><span class="s5">41</span><span class="s1">; </span><span class="s4">// &lt;a foo=&quot;bar&quot;</span>
<span class="s3">const </span><span class="s2">S_ATTRIB_VALUE_UNQUOTED </span><span class="s1">= </span><span class="s5">42</span><span class="s1">; </span><span class="s4">// &lt;a foo=bar</span>
<span class="s3">const </span><span class="s2">S_CLOSE_TAG </span><span class="s1">= </span><span class="s5">43</span><span class="s1">; </span><span class="s4">// &lt;/a</span>
<span class="s3">const </span><span class="s2">S_CLOSE_TAG_SAW_WHITE </span><span class="s1">= </span><span class="s5">44</span><span class="s1">; </span><span class="s4">// &lt;/a   &gt;</span>
<span class="s3">const </span><span class="s2">TAB </span><span class="s1">= </span><span class="s5">9</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">NL </span><span class="s1">= </span><span class="s5">0xA</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">CR </span><span class="s1">= </span><span class="s5">0xD</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">SPACE </span><span class="s1">= </span><span class="s5">0x20</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">BANG </span><span class="s1">= </span><span class="s5">0x21</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">DQUOTE </span><span class="s1">= </span><span class="s5">0x22</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">AMP </span><span class="s1">= </span><span class="s5">0x26</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">SQUOTE </span><span class="s1">= </span><span class="s5">0x27</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">MINUS </span><span class="s1">= </span><span class="s5">0x2D</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">FORWARD_SLASH </span><span class="s1">= </span><span class="s5">0x2F</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">SEMICOLON </span><span class="s1">= </span><span class="s5">0x3B</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">LESS </span><span class="s1">= </span><span class="s5">0x3C</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">EQUAL </span><span class="s1">= </span><span class="s5">0x3D</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">GREATER </span><span class="s1">= </span><span class="s5">0x3E</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">QUESTION </span><span class="s1">= </span><span class="s5">0x3F</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">OPEN_BRACKET </span><span class="s1">= </span><span class="s5">0x5B</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">CLOSE_BRACKET </span><span class="s1">= </span><span class="s5">0x5D</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">NEL </span><span class="s1">= </span><span class="s5">0x85</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">LS </span><span class="s1">= </span><span class="s5">0x2028</span><span class="s1">; </span><span class="s4">// Line Separator</span>
<span class="s3">const </span><span class="s2">isQuote </span><span class="s1">= (</span><span class="s2">c</span><span class="s1">) =&gt; </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">DQUOTE </span><span class="s1">|| </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">SQUOTE</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">QUOTES </span><span class="s1">= [</span><span class="s2">DQUOTE</span><span class="s1">, </span><span class="s2">SQUOTE</span><span class="s1">];</span>
<span class="s3">const </span><span class="s2">DOCTYPE_TERMINATOR </span><span class="s1">= [</span><span class="s2">...QUOTES</span><span class="s1">, </span><span class="s2">OPEN_BRACKET</span><span class="s1">, </span><span class="s2">GREATER</span><span class="s1">];</span>
<span class="s3">const </span><span class="s2">DTD_TERMINATOR </span><span class="s1">= [</span><span class="s2">...QUOTES</span><span class="s1">, </span><span class="s2">LESS</span><span class="s1">, </span><span class="s2">CLOSE_BRACKET</span><span class="s1">];</span>
<span class="s3">const </span><span class="s2">XML_DECL_NAME_TERMINATOR </span><span class="s1">= [</span><span class="s2">EQUAL</span><span class="s1">, </span><span class="s2">QUESTION</span><span class="s1">, </span><span class="s2">...S_LIST</span><span class="s1">];</span>
<span class="s3">const </span><span class="s2">ATTRIB_VALUE_UNQUOTED_TERMINATOR </span><span class="s1">= [</span><span class="s2">...S_LIST</span><span class="s1">, </span><span class="s2">GREATER</span><span class="s1">, </span><span class="s2">AMP</span><span class="s1">, </span><span class="s2">LESS</span><span class="s1">];</span>
<span class="s3">function </span><span class="s2">nsPairCheck</span><span class="s1">(</span><span class="s2">parser</span><span class="s1">, </span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">uri</span><span class="s1">) {</span>
    <span class="s3">switch </span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">) {</span>
        <span class="s3">case </span><span class="s0">&quot;xml&quot;</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">uri </span><span class="s1">!== </span><span class="s2">XML_NAMESPACE</span><span class="s1">) {</span>
                <span class="s2">parser</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`xml prefix must be bound to </span><span class="s2">$</span><span class="s1">{</span><span class="s2">XML_NAMESPACE</span><span class="s1">}</span><span class="s0">.`</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">&quot;xmlns&quot;</span><span class="s1">:</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">uri </span><span class="s1">!== </span><span class="s2">XMLNS_NAMESPACE</span><span class="s1">) {</span>
                <span class="s2">parser</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`xmlns prefix must be bound to </span><span class="s2">$</span><span class="s1">{</span><span class="s2">XMLNS_NAMESPACE</span><span class="s1">}</span><span class="s0">.`</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">default</span><span class="s1">:</span>
    <span class="s1">}</span>
    <span class="s3">switch </span><span class="s1">(</span><span class="s2">uri</span><span class="s1">) {</span>
        <span class="s3">case </span><span class="s2">XMLNS_NAMESPACE</span><span class="s1">:</span>
            <span class="s2">parser</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s2">prefix </span><span class="s1">=== </span><span class="s0">&quot;&quot; </span><span class="s1">?</span>
                <span class="s0">`the default namespace may not be set to </span><span class="s2">$</span><span class="s1">{</span><span class="s2">uri</span><span class="s1">}</span><span class="s0">.` </span><span class="s1">:</span>
                <span class="s0">`may not assign a prefix (even &quot;xmlns&quot;) to the URI </span><span class="s3">\ 
</span><span class="s2">$</span><span class="s1">{</span><span class="s2">XMLNS_NAMESPACE</span><span class="s1">}</span><span class="s0">.`</span><span class="s1">);</span>
            <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s2">XML_NAMESPACE</span><span class="s1">:</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">) {</span>
                <span class="s3">case </span><span class="s0">&quot;xml&quot;</span><span class="s1">:</span>
                    <span class="s4">// Assinging the XML namespace to &quot;xml&quot; is fine.</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s0">&quot;&quot;</span><span class="s1">:</span>
                    <span class="s2">parser</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`the default namespace may not be set to </span><span class="s2">$</span><span class="s1">{</span><span class="s2">uri</span><span class="s1">}</span><span class="s0">.`</span><span class="s1">);</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
                    <span class="s2">parser</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;may not assign the xml namespace to another prefix.&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">default</span><span class="s1">:</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">nsMappingCheck</span><span class="s1">(</span><span class="s2">parser</span><span class="s1">, </span><span class="s2">mapping</span><span class="s1">) {</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">local of Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">mapping</span><span class="s1">)) {</span>
        <span class="s2">nsPairCheck</span><span class="s1">(</span><span class="s2">parser</span><span class="s1">, </span><span class="s2">local</span><span class="s1">, </span><span class="s2">mapping</span><span class="s1">[</span><span class="s2">local</span><span class="s1">]);</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s3">const </span><span class="s2">isNCName </span><span class="s1">= (</span><span class="s2">name</span><span class="s1">) =&gt; </span><span class="s2">NC_NAME_RE</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">name</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">isName </span><span class="s1">= (</span><span class="s2">name</span><span class="s1">) =&gt; </span><span class="s2">NAME_RE</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">name</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">FORBIDDEN_START </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">FORBIDDEN_BRACKET </span><span class="s1">= </span><span class="s5">1</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">FORBIDDEN_BRACKET_BRACKET </span><span class="s1">= </span><span class="s5">2</span><span class="s1">;</span>
<span class="s6">/**</span>
 <span class="s6">* The list of supported events.</span>
 <span class="s6">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">EVENTS </span><span class="s1">= [</span>
    <span class="s0">&quot;xmldecl&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;text&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;processinginstruction&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;doctype&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;comment&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;opentagstart&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;attribute&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;opentag&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;closetag&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;cdata&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;error&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;end&quot;</span><span class="s1">,</span>
    <span class="s0">&quot;ready&quot;</span><span class="s1">,</span>
<span class="s1">];</span>
<span class="s3">const </span><span class="s2">EVENT_NAME_TO_HANDLER_NAME </span><span class="s1">= {</span>
    <span class="s2">xmldecl</span><span class="s1">: </span><span class="s0">&quot;xmldeclHandler&quot;</span><span class="s1">,</span>
    <span class="s2">text</span><span class="s1">: </span><span class="s0">&quot;textHandler&quot;</span><span class="s1">,</span>
    <span class="s2">processinginstruction</span><span class="s1">: </span><span class="s0">&quot;piHandler&quot;</span><span class="s1">,</span>
    <span class="s2">doctype</span><span class="s1">: </span><span class="s0">&quot;doctypeHandler&quot;</span><span class="s1">,</span>
    <span class="s2">comment</span><span class="s1">: </span><span class="s0">&quot;commentHandler&quot;</span><span class="s1">,</span>
    <span class="s2">opentagstart</span><span class="s1">: </span><span class="s0">&quot;openTagStartHandler&quot;</span><span class="s1">,</span>
    <span class="s2">attribute</span><span class="s1">: </span><span class="s0">&quot;attributeHandler&quot;</span><span class="s1">,</span>
    <span class="s2">opentag</span><span class="s1">: </span><span class="s0">&quot;openTagHandler&quot;</span><span class="s1">,</span>
    <span class="s2">closetag</span><span class="s1">: </span><span class="s0">&quot;closeTagHandler&quot;</span><span class="s1">,</span>
    <span class="s2">cdata</span><span class="s1">: </span><span class="s0">&quot;cdataHandler&quot;</span><span class="s1">,</span>
    <span class="s2">error</span><span class="s1">: </span><span class="s0">&quot;errorHandler&quot;</span><span class="s1">,</span>
    <span class="s2">end</span><span class="s1">: </span><span class="s0">&quot;endHandler&quot;</span><span class="s1">,</span>
    <span class="s2">ready</span><span class="s1">: </span><span class="s0">&quot;readyHandler&quot;</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s3">class </span><span class="s2">SaxesParser </span><span class="s1">{</span>
    <span class="s6">/**</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">opt The parser options.</span>
     <span class="s6">*/</span>
    <span class="s2">constructor</span><span class="s1">(</span><span class="s2">opt</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">opt </span><span class="s1">= </span><span class="s2">opt </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">opt </span><span class="s1">!== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s2">opt </span><span class="s1">: {};</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fragmentOpt </span><span class="s1">= !!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">opt</span><span class="s1">.</span><span class="s2">fragment</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">xmlnsOpt </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">xmlnsOpt </span><span class="s1">= !!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">opt</span><span class="s1">.</span><span class="s2">xmlns</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">trackPosition </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">opt</span><span class="s1">.</span><span class="s2">position </span><span class="s1">!== </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fileName </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">opt</span><span class="s1">.</span><span class="s2">fileName</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">xmlnsOpt</span><span class="s1">) {</span>
            <span class="s4">// This is the function we use to perform name checks on PIs and entities.</span>
            <span class="s4">// When namespaces are used, colons are not allowed in PI target names or</span>
            <span class="s4">// entity names. So the check depends on whether namespaces are used. See:</span>
            <span class="s4">//</span>
            <span class="s4">// https://www.w3.org/XML/xml-names-19990114-errata.html</span>
            <span class="s4">// NE08</span>
            <span class="s4">//</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">nameStartCheck </span><span class="s1">= </span><span class="s2">isNCNameStartChar</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">nameCheck </span><span class="s1">= </span><span class="s2">isNCNameChar</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">isName </span><span class="s1">= </span><span class="s2">isNCName</span><span class="s1">;</span>
            <span class="s4">// eslint-disable-next-line @typescript-eslint/unbound-method</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">processAttribs </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">processAttribsNS</span><span class="s1">;</span>
            <span class="s4">// eslint-disable-next-line @typescript-eslint/unbound-method</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">pushAttrib </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">pushAttribNS</span><span class="s1">;</span>
            <span class="s4">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">ns </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({ </span><span class="s2">__proto__</span><span class="s1">: </span><span class="s3">null </span><span class="s1">}, </span><span class="s2">rootNS</span><span class="s1">);</span>
            <span class="s3">const </span><span class="s2">additional </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">opt</span><span class="s1">.</span><span class="s2">additionalNamespaces</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">additional </span><span class="s1">!= </span><span class="s3">null</span><span class="s1">) {</span>
                <span class="s2">nsMappingCheck</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">additional</span><span class="s1">);</span>
                <span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">ns</span><span class="s1">, </span><span class="s2">additional</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">nameStartCheck </span><span class="s1">= </span><span class="s2">isNameStartChar</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">nameCheck </span><span class="s1">= </span><span class="s2">isNameChar</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">isName </span><span class="s1">= </span><span class="s2">isName</span><span class="s1">;</span>
            <span class="s4">// eslint-disable-next-line @typescript-eslint/unbound-method</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">processAttribs </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">processAttribsPlain</span><span class="s1">;</span>
            <span class="s4">// eslint-disable-next-line @typescript-eslint/unbound-method</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">pushAttrib </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">pushAttribPlain</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s4">//</span>
        <span class="s4">// The order of the members in this table needs to correspond to the state</span>
        <span class="s4">// numbers given to the states that correspond to the methods being recorded</span>
        <span class="s4">// here.</span>
        <span class="s4">//</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">stateTable </span><span class="s1">= [</span>
            <span class="s4">/* eslint-disable @typescript-eslint/unbound-method */</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sBegin</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sBeginWhitespace</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDoctype</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDoctypeQuote</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDTD</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDTDQuoted</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDTDOpenWaka</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDTDOpenWakaBang</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDTDComment</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDTDCommentEnding</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDTDCommentEnded</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDTDPI</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sDTDPIEnding</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sText</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sEntity</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sOpenWaka</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sOpenWakaBang</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sComment</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sCommentEnding</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sCommentEnded</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sCData</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sCDataEnding</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sCDataEnding2</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sPIFirstChar</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sPIRest</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sPIBody</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sPIEnding</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sXMLDeclNameStart</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sXMLDeclName</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sXMLDeclEq</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sXMLDeclValueStart</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sXMLDeclValue</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sXMLDeclSeparator</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sXMLDeclEnding</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sOpenTag</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sOpenTagSlash</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sAttrib</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sAttribName</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sAttribNameSawWhite</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sAttribValue</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sAttribValueQuoted</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sAttribValueClosed</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sAttribValueUnquoted</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sCloseTag</span><span class="s1">,</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sCloseTagSawWhite</span><span class="s1">,</span>
        <span class="s1">];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_init</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Indicates whether or not the parser is closed. If ``true``, wait for</span>
     <span class="s6">* the ``ready`` event to write again.</span>
     <span class="s6">*/</span>
    <span class="s2">get closed</span><span class="s1">() {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">_closed</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">_init</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">entity </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">q </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tags </span><span class="s1">= [];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">tag </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">topNS </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">chunk </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">chunkPosition </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">prevI </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">carriedFromPrevious </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">forbiddenState </span><span class="s1">= </span><span class="s2">FORBIDDEN_START</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">attribList </span><span class="s1">= [];</span>
        <span class="s4">// The logic is organized so as to minimize the need to check</span>
        <span class="s4">// this.opt.fragment while parsing.</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">fragmentOpt </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">fragmentOpt </span><span class="s1">? </span><span class="s2">S_TEXT </span><span class="s1">: </span><span class="s2">S_BEGIN</span><span class="s1">;</span>
        <span class="s4">// We want these to be all true if we are dealing with a fragment.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextBeforeRoot </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextAfterRoot </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">closedRoot </span><span class="s1">=</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">sawRoot </span><span class="s1">= </span><span class="s2">fragmentOpt</span><span class="s1">;</span>
        <span class="s4">// An XML declaration is intially possible only when parsing whole</span>
        <span class="s4">// documents.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible </span><span class="s1">= !</span><span class="s2">fragmentOpt</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclExpects </span><span class="s1">= [</span><span class="s0">&quot;version&quot;</span><span class="s1">];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">entityReturnState </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s1">{ </span><span class="s2">defaultXMLVersion </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">opt</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">defaultXMLVersion </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">opt</span><span class="s1">.</span><span class="s2">forceXMLVersion </span><span class="s1">=== </span><span class="s3">true</span><span class="s1">) {</span>
                <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">&quot;forceXMLVersion set but defaultXMLVersion is not set&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s2">defaultXMLVersion </span><span class="s1">= </span><span class="s0">&quot;1.0&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">setXMLVersion</span><span class="s1">(</span><span class="s2">defaultXMLVersion</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">positionAtNewLine </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">doctype </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_closed </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDecl </span><span class="s1">= {</span>
            <span class="s2">version</span><span class="s1">: </span><span class="s2">undefined</span><span class="s1">,</span>
            <span class="s2">encoding</span><span class="s1">: </span><span class="s2">undefined</span><span class="s1">,</span>
            <span class="s2">standalone</span><span class="s1">: </span><span class="s2">undefined</span><span class="s1">,</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">line </span><span class="s1">= </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">column </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">ENTITIES </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">XML_ENTITIES</span><span class="s1">);</span>
        <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
        <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">readyHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* The stream position the parser is currently looking at. This field is</span>
     <span class="s6">* zero-based.</span>
     <span class="s6">*</span>
     <span class="s6">* This field is not based on counting Unicode characters but is to be</span>
     <span class="s6">* interpreted as a plain index into a JavaScript string.</span>
     <span class="s6">*/</span>
    <span class="s2">get position</span><span class="s1">() {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">chunkPosition </span><span class="s1">+ </span><span class="s3">this</span><span class="s1">.</span><span class="s2">i</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* The column number of the next character to be read by the parser.  *</span>
     <span class="s6">* This field is zero-based. (The first column in a line is 0.)</span>
     <span class="s6">*</span>
     <span class="s6">* This field reports the index at which the next character would be in the</span>
     <span class="s6">* line if the line were represented as a JavaScript string.  Note that this</span>
     <span class="s6">* *can* be different to a count based on the number of *Unicode characters*</span>
     <span class="s6">* due to how JavaScript handles astral plane characters.</span>
     <span class="s6">*</span>
     <span class="s6">* See [[column]] for a number that corresponds to a count of Unicode</span>
     <span class="s6">* characters.</span>
     <span class="s6">*/</span>
    <span class="s2">get columnIndex</span><span class="s1">() {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">position </span><span class="s1">- </span><span class="s3">this</span><span class="s1">.</span><span class="s2">positionAtNewLine</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Set an event listener on an event. The parser supports one handler per</span>
     <span class="s6">* event type. If you try to set an event handler over an existing handler,</span>
     <span class="s6">* the old handler is silently overwritten.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">name The event to listen to.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">handler The handler to set.</span>
     <span class="s6">*/</span>
    <span class="s2">on</span><span class="s1">(</span><span class="s2">name</span><span class="s1">, </span><span class="s2">handler</span><span class="s1">) {</span>
        <span class="s4">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span>
        <span class="s3">this</span><span class="s1">[</span><span class="s2">EVENT_NAME_TO_HANDLER_NAME</span><span class="s1">[</span><span class="s2">name</span><span class="s1">]] = </span><span class="s2">handler</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Unset an event handler.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@parma </span><span class="s6">name The event to stop listening to.</span>
     <span class="s6">*/</span>
    <span class="s2">off</span><span class="s1">(</span><span class="s2">name</span><span class="s1">) {</span>
        <span class="s4">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span>
        <span class="s3">this</span><span class="s1">[</span><span class="s2">EVENT_NAME_TO_HANDLER_NAME</span><span class="s1">[</span><span class="s2">name</span><span class="s1">]] = </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Make an error object. The error object will have a message that contains</span>
     <span class="s6">* the ``fileName`` option passed at the creation of the parser. If position</span>
     <span class="s6">* tracking was turned on, it will also have line and column number</span>
     <span class="s6">* information.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">message The message describing the error to report.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns </span><span class="s6">An error object with a properly formatted message.</span>
     <span class="s6">*/</span>
    <span class="s2">makeError</span><span class="s1">(</span><span class="s2">message</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">msg </span><span class="s1">= (</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">fileName</span><span class="s1">) !== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">_a </span><span class="s1">!== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s2">_a </span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">trackPosition</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">msg</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">) {</span>
                <span class="s2">msg </span><span class="s1">+= </span><span class="s0">&quot;:&quot;</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">msg </span><span class="s1">+= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">line</span><span class="s1">}</span><span class="s0">:</span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">column</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">msg</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s2">msg </span><span class="s1">+= </span><span class="s0">&quot;: &quot;</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return new </span><span class="s2">Error</span><span class="s1">(</span><span class="s2">msg </span><span class="s1">+ </span><span class="s2">message</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Report a parsing error. This method is made public so that client code may</span>
     <span class="s6">* check for issues that are outside the scope of this project and can report</span>
     <span class="s6">* errors.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">message The error to report.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns </span><span class="s6">this</span>
     <span class="s6">*/</span>
    <span class="s2">fail</span><span class="s1">(</span><span class="s2">message</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">err </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">makeError</span><span class="s1">(</span><span class="s2">message</span><span class="s1">);</span>
        <span class="s3">const </span><span class="s2">handler </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">errorHandler</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
            <span class="s3">throw </span><span class="s2">err</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s2">handler</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">return this</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Write a XML data to the parser.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">chunk The XML data to write.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns </span><span class="s6">this</span>
     <span class="s6">*/</span>
    <span class="s2">write</span><span class="s1">(</span><span class="s2">chunk</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">closed</span><span class="s1">) {</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;cannot write after close; assign an onready handler.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">let </span><span class="s2">end </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">chunk </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
            <span class="s4">// We cannot return immediately because carriedFromPrevious may need</span>
            <span class="s4">// processing.</span>
            <span class="s2">end </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
            <span class="s2">chunk </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">chunk </span><span class="s1">=== </span><span class="s0">&quot;object&quot;</span><span class="s1">) {</span>
            <span class="s2">chunk </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s4">// We checked if performing a pre-decomposition of the string into an array</span>
        <span class="s4">// of single complete characters (``Array.from(chunk)``) would be faster</span>
        <span class="s4">// than the current repeated calls to ``charCodeAt``. As of August 2018, it</span>
        <span class="s4">// isn't. (There may be Node-specific code that would perform faster than</span>
        <span class="s4">// ``Array.from`` but don't want to be dependent on Node.)</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">carriedFromPrevious </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
            <span class="s4">// The previous chunk had char we must carry over.</span>
            <span class="s2">chunk </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">carriedFromPrevious</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">chunk</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">carriedFromPrevious </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">let </span><span class="s2">limit </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">lastCode </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">limit </span><span class="s1">- </span><span class="s5">1</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">end </span><span class="s1">&amp;&amp;</span>
            <span class="s4">// A trailing CR or surrogate must be carried over to the next</span>
            <span class="s4">// chunk.</span>
            <span class="s1">(</span><span class="s2">lastCode </span><span class="s1">=== </span><span class="s2">CR </span><span class="s1">|| (</span><span class="s2">lastCode </span><span class="s1">&gt;= </span><span class="s5">0xD800 </span><span class="s1">&amp;&amp; </span><span class="s2">lastCode </span><span class="s1">&lt;= </span><span class="s5">0xDBFF</span><span class="s1">))) {</span>
            <span class="s4">// The chunk ends with a character that must be carried over. We cannot</span>
            <span class="s4">// know how to handle it until we get the next chunk or the end of the</span>
            <span class="s4">// stream. So save it for later.</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">carriedFromPrevious </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">[</span><span class="s2">limit </span><span class="s1">- </span><span class="s5">1</span><span class="s1">];</span>
            <span class="s2">limit</span><span class="s1">--;</span>
            <span class="s2">chunk </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">limit</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">stateTable </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">chunk </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">limit</span><span class="s1">) {</span>
            <span class="s4">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span>
            <span class="s2">stateTable</span><span class="s1">[</span><span class="s3">this</span><span class="s1">.</span><span class="s2">state</span><span class="s1">].</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">chunkPosition </span><span class="s1">+= </span><span class="s2">limit</span><span class="s1">;</span>
        <span class="s3">return </span><span class="s2">end </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">end</span><span class="s1">() : </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Close the current stream. Perform final well-formedness checks and reset</span>
     <span class="s6">* the parser tstate.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns </span><span class="s6">this</span>
     <span class="s6">*/</span>
    <span class="s2">close</span><span class="s1">() {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Get a single code point out of the current chunk. This updates the current</span>
     <span class="s6">* position if we do position tracking.</span>
     <span class="s6">*</span>
     <span class="s6">* This is the algorithm to use for XML 1.0.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns </span><span class="s6">The character read.</span>
     <span class="s6">*/</span>
    <span class="s2">getCode10</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">chunk</span><span class="s1">, </span><span class="s2">i </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">prevI </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
        <span class="s4">// Yes, we do this instead of doing this.i++. Doing it this way, we do not</span>
        <span class="s4">// read this.i again, which is a bit faster.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">EOC</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s4">// Using charCodeAt and handling the surrogates ourselves is faster</span>
        <span class="s4">// than using codePointAt.</span>
        <span class="s3">const </span><span class="s2">code </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">i</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">column</span><span class="s1">++;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">code </span><span class="s1">&lt; </span><span class="s5">0xD800</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">code </span><span class="s1">&gt;= </span><span class="s2">SPACE </span><span class="s1">|| </span><span class="s2">code </span><span class="s1">=== </span><span class="s2">TAB</span><span class="s1">) {</span>
                <span class="s3">return </span><span class="s2">code</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s2">code</span><span class="s1">) {</span>
                <span class="s3">case </span><span class="s2">NL</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">line</span><span class="s1">++;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">column </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">positionAtNewLine </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">position</span><span class="s1">;</span>
                    <span class="s3">return </span><span class="s2">NL</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">CR</span><span class="s1">:</span>
                    <span class="s4">// We may get NaN if we read past the end of the chunk, which is fine.</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">) === </span><span class="s2">NL</span><span class="s1">) {</span>
                        <span class="s4">// A \r\n sequence is converted to \n so we have to skip over the</span>
                        <span class="s4">// next character. We already know it has a size of 1 so ++ is fine</span>
                        <span class="s4">// here.</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s4">// Otherwise, a \r is just converted to \n, so we don't have to skip</span>
                    <span class="s4">// ahead.</span>
                    <span class="s4">// In either case, \r becomes \n.</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">line</span><span class="s1">++;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">column </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">positionAtNewLine </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">position</span><span class="s1">;</span>
                    <span class="s3">return </span><span class="s2">NL_LIKE</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
                    <span class="s4">// If we get here, then code &lt; SPACE and it is not NL CR or TAB.</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character.&quot;</span><span class="s1">);</span>
                    <span class="s3">return </span><span class="s2">code</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">code </span><span class="s1">&gt; </span><span class="s5">0xDBFF</span><span class="s1">) {</span>
            <span class="s4">// This is a specialized version of isChar10 that takes into account</span>
            <span class="s4">// that in this context code &gt; 0xDBFF and code &lt;= 0xFFFF. So it does not</span>
            <span class="s4">// test cases that don't need testing.</span>
            <span class="s3">if </span><span class="s1">(!(</span><span class="s2">code </span><span class="s1">&gt;= </span><span class="s5">0xE000 </span><span class="s1">&amp;&amp; </span><span class="s2">code </span><span class="s1">&lt;= </span><span class="s5">0xFFFD</span><span class="s1">)) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character.&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">return </span><span class="s2">code</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s2">final </span><span class="s1">= </span><span class="s5">0x10000 </span><span class="s1">+ ((</span><span class="s2">code </span><span class="s1">- </span><span class="s5">0xD800</span><span class="s1">) * </span><span class="s5">0x400</span><span class="s1">) +</span>
            <span class="s1">(</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">) - </span><span class="s5">0xDC00</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">;</span>
        <span class="s4">// This is a specialized version of isChar10 that takes into account that in</span>
        <span class="s4">// this context necessarily final &gt;= 0x10000.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">final </span><span class="s1">&gt; </span><span class="s5">0x10FFFF</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">final</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Get a single code point out of the current chunk. This updates the current</span>
     <span class="s6">* position if we do position tracking.</span>
     <span class="s6">*</span>
     <span class="s6">* This is the algorithm to use for XML 1.1.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns </span><span class="s6">{number} The character read.</span>
     <span class="s6">*/</span>
    <span class="s2">getCode11</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">chunk</span><span class="s1">, </span><span class="s2">i </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">prevI </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
        <span class="s4">// Yes, we do this instead of doing this.i++. Doing it this way, we do not</span>
        <span class="s4">// read this.i again, which is a bit faster.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">EOC</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s4">// Using charCodeAt and handling the surrogates ourselves is faster</span>
        <span class="s4">// than using codePointAt.</span>
        <span class="s3">const </span><span class="s2">code </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">i</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">column</span><span class="s1">++;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">code </span><span class="s1">&lt; </span><span class="s5">0xD800</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">((</span><span class="s2">code </span><span class="s1">&gt; </span><span class="s5">0x1F </span><span class="s1">&amp;&amp; </span><span class="s2">code </span><span class="s1">&lt; </span><span class="s5">0x7F</span><span class="s1">) || (</span><span class="s2">code </span><span class="s1">&gt; </span><span class="s5">0x9F </span><span class="s1">&amp;&amp; </span><span class="s2">code </span><span class="s1">!== </span><span class="s2">LS</span><span class="s1">) ||</span>
                <span class="s2">code </span><span class="s1">=== </span><span class="s2">TAB</span><span class="s1">) {</span>
                <span class="s3">return </span><span class="s2">code</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s2">code</span><span class="s1">) {</span>
                <span class="s3">case </span><span class="s2">NL</span><span class="s1">: </span><span class="s4">// 0xA</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">line</span><span class="s1">++;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">column </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">positionAtNewLine </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">position</span><span class="s1">;</span>
                    <span class="s3">return </span><span class="s2">NL</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">CR</span><span class="s1">: { </span><span class="s4">// 0xD</span>
                    <span class="s4">// We may get NaN if we read past the end of the chunk, which is</span>
                    <span class="s4">// fine.</span>
                    <span class="s3">const </span><span class="s2">next </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">=== </span><span class="s2">NL </span><span class="s1">|| </span><span class="s2">next </span><span class="s1">=== </span><span class="s2">NEL</span><span class="s1">) {</span>
                        <span class="s4">// A CR NL or CR NEL sequence is converted to NL so we have to skip</span>
                        <span class="s4">// over the next character. We already know it has a size of 1.</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s4">// Otherwise, a CR is just converted to NL, no skip.</span>
                <span class="s1">}</span>
                <span class="s4">/* yes, fall through */</span>
                <span class="s3">case </span><span class="s2">NEL</span><span class="s1">: </span><span class="s4">// 0x85</span>
                <span class="s3">case </span><span class="s2">LS</span><span class="s1">: </span><span class="s4">// Ox2028</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">line</span><span class="s1">++;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">column </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">positionAtNewLine </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">position</span><span class="s1">;</span>
                    <span class="s3">return </span><span class="s2">NL_LIKE</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character.&quot;</span><span class="s1">);</span>
                    <span class="s3">return </span><span class="s2">code</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">code </span><span class="s1">&gt; </span><span class="s5">0xDBFF</span><span class="s1">) {</span>
            <span class="s4">// This is a specialized version of isCharAndNotRestricted that takes into</span>
            <span class="s4">// account that in this context code &gt; 0xDBFF and code &lt;= 0xFFFF. So it</span>
            <span class="s4">// does not test cases that don't need testing.</span>
            <span class="s3">if </span><span class="s1">(!(</span><span class="s2">code </span><span class="s1">&gt;= </span><span class="s5">0xE000 </span><span class="s1">&amp;&amp; </span><span class="s2">code </span><span class="s1">&lt;= </span><span class="s5">0xFFFD</span><span class="s1">)) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character.&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">return </span><span class="s2">code</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s2">final </span><span class="s1">= </span><span class="s5">0x10000 </span><span class="s1">+ ((</span><span class="s2">code </span><span class="s1">- </span><span class="s5">0xD800</span><span class="s1">) * </span><span class="s5">0x400</span><span class="s1">) +</span>
            <span class="s1">(</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">) - </span><span class="s5">0xDC00</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">;</span>
        <span class="s4">// This is a specialized version of isCharAndNotRestricted that takes into</span>
        <span class="s4">// account that in this context necessarily final &gt;= 0x10000.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">final </span><span class="s1">&gt; </span><span class="s5">0x10FFFF</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">final</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Like ``getCode`` but with the return value normalized so that ``NL`` is</span>
     <span class="s6">* returned for ``NL_LIKE``.</span>
     <span class="s6">*/</span>
    <span class="s2">getCodeNorm</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">();</span>
        <span class="s3">return </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">NL_LIKE </span><span class="s1">? </span><span class="s2">NL </span><span class="s1">: </span><span class="s2">c</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">unget</span><span class="s1">() {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">i </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">column</span><span class="s1">--;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Capture characters into a buffer until encountering one of a set of</span>
     <span class="s6">* characters.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">chars An array of codepoints. Encountering a character in the array</span>
     <span class="s6">* ends the capture. (``chars`` may safely contain ``NL``.)</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@return </span><span class="s6">The character code that made the capture end, or ``EOC`` if we hit</span>
     <span class="s6">* the end of the chunk. The return value cannot be NL_LIKE: NL is returned</span>
     <span class="s6">* instead.</span>
     <span class="s6">*/</span>
    <span class="s2">captureTo</span><span class="s1">(</span><span class="s2">chars</span><span class="s1">) {</span>
        <span class="s3">let </span><span class="s1">{ </span><span class="s2">i</span><span class="s1">: </span><span class="s2">start </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">chunk </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line no-constant-condition</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">();</span>
            <span class="s3">const </span><span class="s2">isNLLike </span><span class="s1">= </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">NL_LIKE</span><span class="s1">;</span>
            <span class="s3">const </span><span class="s2">final </span><span class="s1">= </span><span class="s2">isNLLike </span><span class="s1">? </span><span class="s2">NL </span><span class="s1">: </span><span class="s2">c</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">final </span><span class="s1">=== </span><span class="s2">EOC </span><span class="s1">|| </span><span class="s2">chars</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s2">final</span><span class="s1">)) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                <span class="s3">return </span><span class="s2">final</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">isNLLike</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">`</span><span class="s1">;</span>
                <span class="s2">start </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">i</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Capture characters into a buffer until encountering a character.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">char The codepoint that ends the capture. **NOTE ``char`` MAY NOT</span>
     <span class="s6">* CONTAIN ``NL``.** Passing ``NL`` will result in buggy behavior.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@return </span><span class="s6">``true`` if we ran into the character. Otherwise, we ran into the</span>
     <span class="s6">* end of the current chunk.</span>
     <span class="s6">*/</span>
    <span class="s2">captureToChar</span><span class="s1">(</span><span class="s2">char</span><span class="s1">) {</span>
        <span class="s3">let </span><span class="s1">{ </span><span class="s2">i</span><span class="s1">: </span><span class="s2">start </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">chunk </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line no-constant-condition</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">let </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">();</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s2">c</span><span class="s1">) {</span>
                <span class="s3">case </span><span class="s2">NL_LIKE</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">`</span><span class="s1">;</span>
                    <span class="s2">start </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">i</span><span class="s1">;</span>
                    <span class="s2">c </span><span class="s1">= </span><span class="s2">NL</span><span class="s1">;</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">);</span>
                    <span class="s3">return false</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
            <span class="s1">}</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">char</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                <span class="s3">return true</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Capture characters that satisfy ``isNameChar`` into the ``name`` field of</span>
     <span class="s6">* this parser.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@return </span><span class="s6">The character code that made the test fail, or ``EOC`` if we hit</span>
     <span class="s6">* the end of the chunk. The return value cannot be NL_LIKE: NL is returned</span>
     <span class="s6">* instead.</span>
     <span class="s6">*/</span>
    <span class="s2">captureNameChars</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">chunk</span><span class="s1">, </span><span class="s2">i</span><span class="s1">: </span><span class="s2">start </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line no-constant-condition</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">();</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EOC</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">);</span>
                <span class="s3">return </span><span class="s2">EOC</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s4">// NL is not a name char so we don't have to test specifically for it.</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">isNameChar</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                <span class="s3">return </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">NL_LIKE </span><span class="s1">? </span><span class="s2">NL </span><span class="s1">: </span><span class="s2">c</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Skip white spaces.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@return </span><span class="s6">The character that ended the skip, or ``EOC`` if we hit</span>
     <span class="s6">* the end of the chunk. The return value cannot be NL_LIKE: NL is returned</span>
     <span class="s6">* instead.</span>
     <span class="s6">*/</span>
    <span class="s2">skipSpaces</span><span class="s1">() {</span>
        <span class="s4">// eslint-disable-next-line no-constant-condition</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EOC </span><span class="s1">|| !</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
                <span class="s3">return </span><span class="s2">c</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">setXMLVersion</span><span class="s1">(</span><span class="s2">version</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">currentXMLVersion </span><span class="s1">= </span><span class="s2">version</span><span class="s1">;</span>
        <span class="s4">/*  eslint-disable @typescript-eslint/unbound-method */</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">version </span><span class="s1">=== </span><span class="s0">&quot;1.0&quot;</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">isChar </span><span class="s1">= </span><span class="s2">isChar10</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">getCode </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode10</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">isChar </span><span class="s1">= </span><span class="s2">isChar11</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">getCode </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode11</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s4">/* eslint-enable @typescript-eslint/unbound-method */</span>
    <span class="s1">}</span>
    <span class="s4">// STATE ENGINE METHODS</span>
    <span class="s4">// This needs to be a state separate from S_BEGIN_WHITESPACE because we want</span>
    <span class="s4">// to be sure never to come back to this state later.</span>
    <span class="s2">sBegin</span><span class="s1">() {</span>
        <span class="s4">// We are essentially peeking at the first character of the chunk. Since</span>
        <span class="s4">// S_BEGIN can be in effect only when we start working on the first chunk,</span>
        <span class="s4">// the index at which we must look is necessarily 0. Note also that the</span>
        <span class="s4">// following test does not depend on decoding surrogates.</span>
        <span class="s4">// If the initial character is 0xFEFF, ignore it.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s5">0</span><span class="s1">) === </span><span class="s5">0xFEFF</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">i</span><span class="s1">++;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">column</span><span class="s1">++;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_BEGIN_WHITESPACE</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">sBeginWhitespace</span><span class="s1">() {</span>
        <span class="s4">// We need to know whether we've encountered spaces or not because as soon</span>
        <span class="s4">// as we run into a space, an XML declaration is no longer possible. Rather</span>
        <span class="s4">// than slow down skipSpaces even in places where we don't care whether it</span>
        <span class="s4">// skipped anything or not, we check whether prevI is equal to the value of</span>
        <span class="s4">// i from before we skip spaces.</span>
        <span class="s3">const </span><span class="s2">iBefore </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">i</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">skipSpaces</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI </span><span class="s1">!== </span><span class="s2">iBefore</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s2">c</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s2">LESS</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_OPEN_WAKA</span><span class="s1">;</span>
                <span class="s4">// We could naively call closeText but in this state, it is not normal</span>
                <span class="s4">// to have text be filled with any data.</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
                    <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">&quot;no-empty text at start&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">unget</span><span class="s1">();</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDoctype</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureTo</span><span class="s1">(</span><span class="s2">DOCTYPE_TERMINATOR</span><span class="s1">);</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s2">c</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s2">GREATER</span><span class="s1">: {</span>
                <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
                <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">doctypeHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">);</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">doctype </span><span class="s1">= </span><span class="s3">true</span><span class="s1">; </span><span class="s4">// just remember that we saw it.</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">OPEN_BRACKET</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">else if </span><span class="s1">(</span><span class="s2">isQuote</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DOCTYPE_QUOTE</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">q </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
                <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDoctypeQuote</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">q </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">q</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureToChar</span><span class="s1">(</span><span class="s2">q</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">q</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">q </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DOCTYPE</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDTD</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureTo</span><span class="s1">(</span><span class="s2">DTD_TERMINATOR</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EOC</span><span class="s1">) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">CLOSE_BRACKET</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DOCTYPE</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">LESS</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD_OPEN_WAKA</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">isQuote</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD_QUOTED</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">q </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDTDQuoted</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">q </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">q</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureToChar</span><span class="s1">(</span><span class="s2">q</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">q</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">q </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDTDOpenWaka</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s2">c</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s2">BANG</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD_OPEN_WAKA_BANG</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s2">QUESTION</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD_PI</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDTDOpenWakaBang</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">char </span><span class="s1">= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">());</span>
        <span class="s3">const </span><span class="s2">owb </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang </span><span class="s1">+= </span><span class="s2">char</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">char</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">owb </span><span class="s1">!== </span><span class="s0">&quot;-&quot;</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">owb </span><span class="s1">=== </span><span class="s0">&quot;--&quot; </span><span class="s1">? </span><span class="s2">S_DTD_COMMENT </span><span class="s1">: </span><span class="s2">S_DTD</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDTDComment</span><span class="s1">() {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureToChar</span><span class="s1">(</span><span class="s2">MINUS</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">&quot;-&quot;</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD_COMMENT_ENDING</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDTDCommentEnding</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">MINUS </span><span class="s1">? </span><span class="s2">S_DTD_COMMENT_ENDED </span><span class="s1">: </span><span class="s2">S_DTD_COMMENT</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">sDTDCommentEnded</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;malformed comment.&quot;</span><span class="s1">);</span>
            <span class="s4">// &lt;!-- blah -- bloo --&gt; will be recorded as</span>
            <span class="s4">// a comment of &quot; blah -- bloo &quot;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD_COMMENT</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDTDPI</span><span class="s1">() {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureToChar</span><span class="s1">(</span><span class="s2">QUESTION</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">&quot;?&quot;</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD_PI_ENDING</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sDTDPIEnding</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DTD</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sText</span><span class="s1">() {</span>
        <span class="s4">//</span>
        <span class="s4">// We did try a version of saxes where the S_TEXT state was split in two</span>
        <span class="s4">// states: one for text inside the root element, and one for text</span>
        <span class="s4">// outside. This was avoiding having to test this.tags.length to decide</span>
        <span class="s4">// what implementation to actually use.</span>
        <span class="s4">//</span>
        <span class="s4">// Peformance testing on gigabyte-size files did not show any advantage to</span>
        <span class="s4">// using the two states solution instead of the current one. Conversely, it</span>
        <span class="s4">// made the code a bit more complicated elsewhere. For instance, a comment</span>
        <span class="s4">// can appear before the root element so when a comment ended it was</span>
        <span class="s4">// necessary to determine whether to return to the S_TEXT state or to the</span>
        <span class="s4">// new text-outside-root state.</span>
        <span class="s4">//</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">tags</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">handleTextInRoot</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">handleTextOutsideRoot</span><span class="s1">();</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sEntity</span><span class="s1">() {</span>
        <span class="s4">// This is essentially a specialized version of captureToChar(SEMICOLON...)</span>
        <span class="s3">let </span><span class="s1">{ </span><span class="s2">i</span><span class="s1">: </span><span class="s2">start </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">chunk </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line no-labels, no-restricted-syntax</span>
        <span class="s2">loop</span><span class="s1">: </span>
        <span class="s4">// eslint-disable-next-line no-constant-condition</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">()) {</span>
                <span class="s3">case </span><span class="s2">NL_LIKE</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">entity </span><span class="s1">+= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">`</span><span class="s1">;</span>
                    <span class="s2">start </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">i</span><span class="s1">;</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">SEMICOLON</span><span class="s1">: {</span>
                    <span class="s3">const </span><span class="s1">{ </span><span class="s2">entityReturnState </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
                    <span class="s3">const </span><span class="s2">entity </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">entity </span><span class="s1">+ </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">entityReturnState</span><span class="s1">;</span>
                    <span class="s3">let </span><span class="s2">parsed</span><span class="s1">;</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">entity </span><span class="s1">=== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;empty entity name.&quot;</span><span class="s1">);</span>
                        <span class="s2">parsed </span><span class="s1">= </span><span class="s0">&quot;&amp;;&quot;</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s3">else </span><span class="s1">{</span>
                        <span class="s2">parsed </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">parseEntity</span><span class="s1">(</span><span class="s2">entity</span><span class="s1">);</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">entity </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">entityReturnState </span><span class="s1">!== </span><span class="s2">S_TEXT </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.</span><span class="s2">textHandler </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">parsed</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s4">// eslint-disable-next-line no-labels</span>
                    <span class="s3">break </span><span class="s2">loop</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">entity </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">);</span>
                    <span class="s4">// eslint-disable-next-line no-labels</span>
                    <span class="s3">break </span><span class="s2">loop</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sOpenWaka</span><span class="s1">() {</span>
        <span class="s4">// Reminder: a state handler is called with at least one character</span>
        <span class="s4">// available in the current chunk. So the first call to get code inside of</span>
        <span class="s4">// a state handler cannot return ``EOC``. That's why we don't test</span>
        <span class="s4">// for it.</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">();</span>
        <span class="s4">// either a /, ?, !, or text is coming next.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isNameStartChar</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_OPEN_TAG</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">unget</span><span class="s1">();</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s2">c</span><span class="s1">) {</span>
                <span class="s3">case </span><span class="s2">FORWARD_SLASH</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_CLOSE_TAG</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">BANG</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_OPEN_WAKA_BANG</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">QUESTION</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_PI_FIRST_CHAR</span><span class="s1">;</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in tag name&quot;</span><span class="s1">);</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sOpenWakaBang</span><span class="s1">() {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">());</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s0">&quot;[CDATA[&quot;</span><span class="s1">:</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">sawRoot </span><span class="s1">&amp;&amp; !</span><span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextBeforeRoot</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;text data outside of root node.&quot;</span><span class="s1">);</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextBeforeRoot </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">closedRoot </span><span class="s1">&amp;&amp; !</span><span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextAfterRoot</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;text data outside of root node.&quot;</span><span class="s1">);</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextAfterRoot </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_CDATA</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s0">&quot;--&quot;</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_COMMENT</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s0">&quot;DOCTYPE&quot;</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_DOCTYPE</span><span class="s1">;</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">doctype </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.</span><span class="s2">sawRoot</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;inappropriately located doctype declaration.&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s4">// 7 happens to be the maximum length of the string that can possibly</span>
                <span class="s4">// match one of the cases above.</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">openWakaBang</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt;= </span><span class="s5">7</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;incorrect syntax.&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sComment</span><span class="s1">() {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureToChar</span><span class="s1">(</span><span class="s2">MINUS</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_COMMENT_ENDING</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sCommentEnding</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">MINUS</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_COMMENT_ENDED</span><span class="s1">;</span>
            <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
            <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">commentHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`-</span><span class="s2">$</span><span class="s1">{</span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_COMMENT</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sCommentEnded</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">!== </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;malformed comment.&quot;</span><span class="s1">);</span>
            <span class="s4">// &lt;!-- blah -- bloo --&gt; will be recorded as</span>
            <span class="s4">// a comment of &quot; blah -- bloo &quot;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`--</span><span class="s2">$</span><span class="s1">{</span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_COMMENT</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sCData</span><span class="s1">() {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureToChar</span><span class="s1">(</span><span class="s2">CLOSE_BRACKET</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_CDATA_ENDING</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sCDataEnding</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">CLOSE_BRACKET</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_CDATA_ENDING_2</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`]</span><span class="s2">$</span><span class="s1">{</span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_CDATA</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sCDataEnding2</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s2">c</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s2">GREATER</span><span class="s1">: {</span>
                <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
                <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">cdataHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">);</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">case </span><span class="s2">CLOSE_BRACKET</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">&quot;]&quot;</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`]]</span><span class="s2">$</span><span class="s1">{</span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_CDATA</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">// We need this separate state to check the first character fo the pi target</span>
    <span class="s4">// with this.nameStartCheck which allows less characters than this.nameCheck.</span>
    <span class="s2">sPIFirstChar</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s4">// This is first because in the case where the file is well-formed this is</span>
        <span class="s4">// the branch taken. We optimize for well-formedness.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">nameStartCheck</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_PI_REST</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION </span><span class="s1">|| </span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;processing instruction without a target.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION </span><span class="s1">? </span><span class="s2">S_PI_ENDING </span><span class="s1">: </span><span class="s2">S_PI_BODY</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in processing instruction name.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_PI_REST</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sPIRest</span><span class="s1">() {</span>
        <span class="s4">// Capture characters into a piTarget while ``this.nameCheck`` run on the</span>
        <span class="s4">// character read returns true.</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">chunk</span><span class="s1">, </span><span class="s2">i</span><span class="s1">: </span><span class="s2">start </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line no-constant-condition</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EOC</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">);</span>
                <span class="s3">return</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s4">// NL cannot satisfy this.nameCheck so we don't have to test specifically</span>
            <span class="s4">// for it.</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">nameCheck</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                <span class="s3">const </span><span class="s2">isQuestion </span><span class="s1">= </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION</span><span class="s1">;</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">isQuestion </span><span class="s1">|| </span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">=== </span><span class="s0">&quot;xml&quot;</span><span class="s1">) {</span>
                        <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible</span><span class="s1">) {</span>
                            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;an XML declaration must be at the start of the document.&quot;</span><span class="s1">);</span>
                        <span class="s1">}</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">isQuestion </span><span class="s1">? </span><span class="s2">S_XML_DECL_ENDING </span><span class="s1">: </span><span class="s2">S_XML_DECL_NAME_START</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s3">else </span><span class="s1">{</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">isQuestion </span><span class="s1">? </span><span class="s2">S_PI_ENDING </span><span class="s1">: </span><span class="s2">S_PI_BODY</span><span class="s1">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
                <span class="s3">else </span><span class="s1">{</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in processing instruction name.&quot;</span><span class="s1">);</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">+= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sPIBody</span><span class="s1">() {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_PI_ENDING</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">else if </span><span class="s1">(!</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s4">// The question mark character is not valid inside any of the XML</span>
        <span class="s4">// declaration name/value pairs.</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureToChar</span><span class="s1">(</span><span class="s2">QUESTION</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_PI_ENDING</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sPIEnding</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s1">{ </span><span class="s2">piTarget </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">piTarget</span><span class="s1">.</span><span class="s2">toLowerCase</span><span class="s1">() === </span><span class="s0">&quot;xml&quot;</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;the XML declaration must appear at the start of the document.&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
            <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">piHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, {</span>
                <span class="s2">target</span><span class="s1">: </span><span class="s2">piTarget</span><span class="s1">,</span>
                <span class="s2">body</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">,</span>
            <span class="s1">});</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION</span><span class="s1">) {</span>
            <span class="s4">// We ran into ?? as part of a processing instruction. We initially took</span>
            <span class="s4">// the first ? as a sign that the PI was ending, but it is not. So we have</span>
            <span class="s4">// to add it to the body but we take the new ? as a sign that the PI is</span>
            <span class="s4">// ending.</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">&quot;?&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`?</span><span class="s2">$</span><span class="s1">{</span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_PI_BODY</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">sXMLDeclNameStart</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">skipSpaces</span><span class="s1">();</span>
        <span class="s4">// The question mark character is not valid inside any of the XML</span>
        <span class="s4">// declaration name/value pairs.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION</span><span class="s1">) {</span>
            <span class="s4">// It is valid to go to S_XML_DECL_ENDING from this state.</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_ENDING</span><span class="s1">;</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">!== </span><span class="s2">EOC</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_NAME</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">c</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sXMLDeclName</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureTo</span><span class="s1">(</span><span class="s2">XML_DECL_NAME_TERMINATOR</span><span class="s1">);</span>
        <span class="s4">// The question mark character is not valid inside any of the XML</span>
        <span class="s4">// declaration name/value pairs.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_ENDING</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;XML declaration is incomplete.&quot;</span><span class="s1">);</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(!(</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">) || </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EQUAL</span><span class="s1">)) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclExpects</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">name</span><span class="s1">)) {</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">name</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
                <span class="s3">case </span><span class="s5">0</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;did not expect any more name/value pairs.&quot;</span><span class="s1">);</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s5">1</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`expected the name </span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclExpects</span><span class="s1">[</span><span class="s5">0</span><span class="s1">]}</span><span class="s0">.`</span><span class="s1">);</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`expected one of </span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclExpects</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">&quot;, &quot;</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EQUAL </span><span class="s1">? </span><span class="s2">S_XML_DECL_VALUE_START </span><span class="s1">: </span><span class="s2">S_XML_DECL_EQ</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">sXMLDeclEq</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s4">// The question mark character is not valid inside any of the XML</span>
        <span class="s4">// declaration name/value pairs.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_ENDING</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;XML declaration is incomplete.&quot;</span><span class="s1">);</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">!== </span><span class="s2">EQUAL</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;value required.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_VALUE_START</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">sXMLDeclValueStart</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s4">// The question mark character is not valid inside any of the XML</span>
        <span class="s4">// declaration name/value pairs.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_ENDING</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;XML declaration is incomplete.&quot;</span><span class="s1">);</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">isQuote</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;value must be quoted.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">q </span><span class="s1">= </span><span class="s2">SPACE</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">q </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_VALUE</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">sXMLDeclValue</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureTo</span><span class="s1">([</span><span class="s3">this</span><span class="s1">.</span><span class="s2">q</span><span class="s1">, </span><span class="s2">QUESTION</span><span class="s1">]);</span>
        <span class="s4">// The question mark character is not valid inside any of the XML</span>
        <span class="s4">// declaration name/value pairs.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_ENDING</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;XML declaration is incomplete.&quot;</span><span class="s1">);</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EOC</span><span class="s1">) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s2">value </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">name</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s0">&quot;version&quot;</span><span class="s1">: {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclExpects </span><span class="s1">= [</span><span class="s0">&quot;encoding&quot;</span><span class="s1">, </span><span class="s0">&quot;standalone&quot;</span><span class="s1">];</span>
                <span class="s3">const </span><span class="s2">version </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDecl</span><span class="s1">.</span><span class="s2">version </span><span class="s1">= </span><span class="s2">version</span><span class="s1">;</span>
                <span class="s4">// This is the test specified by XML 1.0 but it is fine for XML 1.1.</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s8">/^1\.[0-9]+$/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">version</span><span class="s1">)) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;version number must match /^1</span><span class="s3">\\</span><span class="s0">.[0-9]+$/.&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s4">// When forceXMLVersion is set, the XML declaration is ignored.</span>
                <span class="s3">else if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">opt</span><span class="s1">.</span><span class="s2">forceXMLVersion</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">setXMLVersion</span><span class="s1">(</span><span class="s2">version</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">case </span><span class="s0">&quot;encoding&quot;</span><span class="s1">:</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s8">/^[A-Za-z][A-Za-z0-9._-]*$/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;encoding value must match </span><span class="s3">\ 
</span><span class="s0">/^[A-Za-z0-9][A-Za-z0-9._-]*$/.&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclExpects </span><span class="s1">= [</span><span class="s0">&quot;standalone&quot;</span><span class="s1">];</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDecl</span><span class="s1">.</span><span class="s2">encoding </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s0">&quot;standalone&quot;</span><span class="s1">:</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">value </span><span class="s1">!== </span><span class="s0">&quot;yes&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">value </span><span class="s1">!== </span><span class="s0">&quot;no&quot;</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;standalone value must match </span><span class="s3">\&quot;</span><span class="s0">yes</span><span class="s3">\&quot; </span><span class="s0">or </span><span class="s3">\&quot;</span><span class="s0">no</span><span class="s3">\&quot;</span><span class="s0">.&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclExpects </span><span class="s1">= [];</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDecl</span><span class="s1">.</span><span class="s2">standalone </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
            <span class="s4">// We don't need to raise an error here since we've already raised one</span>
            <span class="s4">// when checking what name was expected.</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_SEPARATOR</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">sXMLDeclSeparator</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s4">// The question mark character is not valid inside any of the XML</span>
        <span class="s4">// declaration name/value pairs.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">QUESTION</span><span class="s1">) {</span>
            <span class="s4">// It is valid to go to S_XML_DECL_ENDING from this state.</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_ENDING</span><span class="s1">;</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;whitespace required.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">unget</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_XML_DECL_NAME_START</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">sXMLDeclEnding</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">!== </span><span class="s0">&quot;xml&quot;</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;processing instructions are not allowed before root.&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">!== </span><span class="s0">&quot;version&quot; </span><span class="s1">&amp;&amp;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclExpects</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">&quot;version&quot;</span><span class="s1">)) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;XML declaration must contain a version.&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
            <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">xmldeclHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDecl</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">piTarget </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s4">// We got here because the previous character was a ?, but the question</span>
            <span class="s4">// mark character is not valid inside any of the XML declaration</span>
            <span class="s4">// name/value pairs.</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;The character ? is disallowed anywhere in XML declarations.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">xmlDeclPossible </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">sOpenTag</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureNameChars</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EOC</span><span class="s1">) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s2">tag </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tag </span><span class="s1">= {</span>
            <span class="s2">name</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">name</span><span class="s1">,</span>
            <span class="s2">attributes</span><span class="s1">: </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">),</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">xmlnsOpt</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">topNS </span><span class="s1">= </span><span class="s2">tag</span><span class="s1">.</span><span class="s2">ns </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
        <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openTagStartHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">tag</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">sawRoot </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fragmentOpt </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">closedRoot</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;documents may contain only one root.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s2">c</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s2">GREATER</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">openTag</span><span class="s1">();</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s2">FORWARD_SLASH</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_OPEN_TAG_SLASH</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in tag name.&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sOpenTagSlash</span><span class="s1">() {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">() === </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">openSelfClosingTag</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;forward-slash in opening tag not followed by &gt;.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sAttrib</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">skipSpaces</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EOC</span><span class="s1">) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isNameStartChar</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">unget</span><span class="s1">();</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB_NAME</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">openTag</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">FORWARD_SLASH</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_OPEN_TAG_SLASH</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in attribute name.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sAttribName</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureNameChars</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">EQUAL</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB_VALUE</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB_NAME_SAW_WHITE</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;attribute without value.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">pushAttrib</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">name</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">name</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">openTag</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">!== </span><span class="s2">EOC</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in attribute name.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sAttribNameSawWhite</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">skipSpaces</span><span class="s1">();</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s2">c</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                <span class="s3">return</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s2">EQUAL</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB_VALUE</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;attribute without value.&quot;</span><span class="s1">);</span>
                <span class="s4">// Should we do this???</span>
                <span class="s4">// this.tag.attributes[this.name] = &quot;&quot;;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">openTag</span><span class="s1">();</span>
                <span class="s1">}</span>
                <span class="s3">else if </span><span class="s1">(</span><span class="s2">isNameStartChar</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">unget</span><span class="s1">();</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB_NAME</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">else </span><span class="s1">{</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in attribute name.&quot;</span><span class="s1">);</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB</span><span class="s1">;</span>
                <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sAttribValue</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isQuote</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">q </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB_VALUE_QUOTED</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(!</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;unquoted attribute value.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB_VALUE_UNQUOTED</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">unget</span><span class="s1">();</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sAttribValueQuoted</span><span class="s1">() {</span>
        <span class="s4">// We deliberately do not use captureTo here. The specialized code we use</span>
        <span class="s4">// here is faster than using captureTo.</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">q</span><span class="s1">, </span><span class="s2">chunk </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s1">{ </span><span class="s2">i</span><span class="s1">: </span><span class="s2">start </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line no-constant-condition</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">()) {</span>
                <span class="s3">case </span><span class="s2">q</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">pushAttrib</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">name</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+ </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">));</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">q </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB_VALUE_CLOSED</span><span class="s1">;</span>
                    <span class="s3">return</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">AMP</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ENTITY</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">entityReturnState </span><span class="s1">= </span><span class="s2">S_ATTRIB_VALUE_QUOTED</span><span class="s1">;</span>
                    <span class="s3">return</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">NL</span><span class="s1">:</span>
                <span class="s3">case </span><span class="s2">NL_LIKE</span><span class="s1">:</span>
                <span class="s3">case </span><span class="s2">TAB</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">)} </span><span class="s0">`</span><span class="s1">;</span>
                    <span class="s2">start </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">i</span><span class="s1">;</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">LESS</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character.&quot;</span><span class="s1">);</span>
                    <span class="s3">return</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">);</span>
                    <span class="s3">return</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sAttribValueClosed</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCodeNorm</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">openTag</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">FORWARD_SLASH</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_OPEN_TAG_SLASH</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">isNameStartChar</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;no whitespace between attributes.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">unget</span><span class="s1">();</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB_NAME</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in attribute name.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sAttribValueUnquoted</span><span class="s1">() {</span>
        <span class="s4">// We don't do anything regarding EOL or space handling for unquoted</span>
        <span class="s4">// attributes. We already have failed by the time we get here, and the</span>
        <span class="s4">// contract that saxes upholds states that upon failure, it is not safe to</span>
        <span class="s4">// rely on the data passed to event handlers (other than</span>
        <span class="s4">// ``onerror``). Passing &quot;bad&quot; data is not a problem.</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureTo</span><span class="s1">(</span><span class="s2">ATTRIB_VALUE_UNQUOTED_TERMINATOR</span><span class="s1">);</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s2">c</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s2">AMP</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ENTITY</span><span class="s1">;</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">entityReturnState </span><span class="s1">= </span><span class="s2">S_ATTRIB_VALUE_UNQUOTED</span><span class="s1">;</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s2">LESS</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character.&quot;</span><span class="s1">);</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">&quot;]]&gt;&quot;</span><span class="s1">)) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;the string </span><span class="s3">\&quot;</span><span class="s0">]]&gt;</span><span class="s3">\&quot; </span><span class="s0">is disallowed in char data.&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">pushAttrib</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">name</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text</span><span class="s1">);</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">openTag</span><span class="s1">();</span>
                <span class="s1">}</span>
                <span class="s3">else </span><span class="s1">{</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ATTRIB</span><span class="s1">;</span>
                <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sCloseTag</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">captureNameChars</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">=== </span><span class="s2">GREATER</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">closeTag</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">c</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_CLOSE_TAG_SAW_WHITE</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">!== </span><span class="s2">EOC</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in closing tag.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">sCloseTagSawWhite</span><span class="s1">() {</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">skipSpaces</span><span class="s1">()) {</span>
            <span class="s3">case </span><span class="s2">GREATER</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">closeTag</span><span class="s1">();</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;disallowed character in closing tag.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">// END OF STATE ENGINE METHODS</span>
    <span class="s2">handleTextInRoot</span><span class="s1">() {</span>
        <span class="s4">// This is essentially a specialized version of captureTo which is optimized</span>
        <span class="s4">// for performing the ]]&gt; check. A previous version of this code, checked</span>
        <span class="s4">// ``this.text`` for the presence of ]]&gt;. It simplified the code but was</span>
        <span class="s4">// very costly when character data contained a lot of entities to be parsed.</span>
        <span class="s4">//</span>
        <span class="s4">// Since we are using a specialized loop, we also keep track of the presence</span>
        <span class="s4">// of ]]&gt; in text data. The sequence ]]&gt; is forbidden to appear as-is.</span>
        <span class="s4">//</span>
        <span class="s3">let </span><span class="s1">{ </span><span class="s2">i</span><span class="s1">: </span><span class="s2">start</span><span class="s1">, </span><span class="s2">forbiddenState </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">chunk</span><span class="s1">, </span><span class="s2">textHandler</span><span class="s1">: </span><span class="s2">handler </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line no-labels, no-restricted-syntax</span>
        <span class="s2">scanLoop</span><span class="s1">: </span>
        <span class="s4">// eslint-disable-next-line no-constant-condition</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">()) {</span>
                <span class="s3">case </span><span class="s2">LESS</span><span class="s1">: {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_OPEN_WAKA</span><span class="s1">;</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                        <span class="s3">const </span><span class="s1">{ </span><span class="s2">text </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
                        <span class="s3">const </span><span class="s2">slice </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                        <span class="s3">if </span><span class="s1">(</span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
                            <span class="s2">handler</span><span class="s1">(</span><span class="s2">text </span><span class="s1">+ </span><span class="s2">slice</span><span class="s1">);</span>
                            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                        <span class="s1">}</span>
                        <span class="s3">else if </span><span class="s1">(</span><span class="s2">slice</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
                            <span class="s2">handler</span><span class="s1">(</span><span class="s2">slice</span><span class="s1">);</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                    <span class="s2">forbiddenState </span><span class="s1">= </span><span class="s2">FORBIDDEN_START</span><span class="s1">;</span>
                    <span class="s4">// eslint-disable-next-line no-labels</span>
                    <span class="s3">break </span><span class="s2">scanLoop</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">case </span><span class="s2">AMP</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ENTITY</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">entityReturnState </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                    <span class="s1">}</span>
                    <span class="s2">forbiddenState </span><span class="s1">= </span><span class="s2">FORBIDDEN_START</span><span class="s1">;</span>
                    <span class="s4">// eslint-disable-next-line no-labels</span>
                    <span class="s3">break </span><span class="s2">scanLoop</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">CLOSE_BRACKET</span><span class="s1">:</span>
                    <span class="s3">switch </span><span class="s1">(</span><span class="s2">forbiddenState</span><span class="s1">) {</span>
                        <span class="s3">case </span><span class="s2">FORBIDDEN_START</span><span class="s1">:</span>
                            <span class="s2">forbiddenState </span><span class="s1">= </span><span class="s2">FORBIDDEN_BRACKET</span><span class="s1">;</span>
                            <span class="s3">break</span><span class="s1">;</span>
                        <span class="s3">case </span><span class="s2">FORBIDDEN_BRACKET</span><span class="s1">:</span>
                            <span class="s2">forbiddenState </span><span class="s1">= </span><span class="s2">FORBIDDEN_BRACKET_BRACKET</span><span class="s1">;</span>
                            <span class="s3">break</span><span class="s1">;</span>
                        <span class="s3">case </span><span class="s2">FORBIDDEN_BRACKET_BRACKET</span><span class="s1">:</span>
                            <span class="s3">break</span><span class="s1">;</span>
                        <span class="s3">default</span><span class="s1">:</span>
                            <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">&quot;impossible state&quot;</span><span class="s1">);</span>
                    <span class="s1">}</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">GREATER</span><span class="s1">:</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">forbiddenState </span><span class="s1">=== </span><span class="s2">FORBIDDEN_BRACKET_BRACKET</span><span class="s1">) {</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;the string </span><span class="s3">\&quot;</span><span class="s0">]]&gt;</span><span class="s3">\&quot; </span><span class="s0">is disallowed in char data.&quot;</span><span class="s1">);</span>
                    <span class="s1">}</span>
                    <span class="s2">forbiddenState </span><span class="s1">= </span><span class="s2">FORBIDDEN_START</span><span class="s1">;</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">NL_LIKE</span><span class="s1">:</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">`</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s2">start </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">i</span><span class="s1">;</span>
                    <span class="s2">forbiddenState </span><span class="s1">= </span><span class="s2">FORBIDDEN_START</span><span class="s1">;</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">);</span>
                    <span class="s1">}</span>
                    <span class="s4">// eslint-disable-next-line no-labels</span>
                    <span class="s3">break </span><span class="s2">scanLoop</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
                    <span class="s2">forbiddenState </span><span class="s1">= </span><span class="s2">FORBIDDEN_START</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">forbiddenState </span><span class="s1">= </span><span class="s2">forbiddenState</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">handleTextOutsideRoot</span><span class="s1">() {</span>
        <span class="s4">// This is essentially a specialized version of captureTo which is optimized</span>
        <span class="s4">// for a specialized task. We keep track of the presence of non-space</span>
        <span class="s4">// characters in the text since these are errors when appearing outside the</span>
        <span class="s4">// document root element.</span>
        <span class="s3">let </span><span class="s1">{ </span><span class="s2">i</span><span class="s1">: </span><span class="s2">start </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">chunk</span><span class="s1">, </span><span class="s2">textHandler</span><span class="s1">: </span><span class="s2">handler </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">nonSpace </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line no-labels, no-restricted-syntax</span>
        <span class="s2">outRootLoop</span><span class="s1">: </span>
        <span class="s4">// eslint-disable-next-line no-constant-condition</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">code </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCode</span><span class="s1">();</span>
            <span class="s3">switch </span><span class="s1">(</span><span class="s2">code</span><span class="s1">) {</span>
                <span class="s3">case </span><span class="s2">LESS</span><span class="s1">: {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_OPEN_WAKA</span><span class="s1">;</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                        <span class="s3">const </span><span class="s1">{ </span><span class="s2">text </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
                        <span class="s3">const </span><span class="s2">slice </span><span class="s1">= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                        <span class="s3">if </span><span class="s1">(</span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
                            <span class="s2">handler</span><span class="s1">(</span><span class="s2">text </span><span class="s1">+ </span><span class="s2">slice</span><span class="s1">);</span>
                            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                        <span class="s1">}</span>
                        <span class="s3">else if </span><span class="s1">(</span><span class="s2">slice</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
                            <span class="s2">handler</span><span class="s1">(</span><span class="s2">slice</span><span class="s1">);</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                    <span class="s4">// eslint-disable-next-line no-labels</span>
                    <span class="s3">break </span><span class="s2">outRootLoop</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">case </span><span class="s2">AMP</span><span class="s1">:</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_ENTITY</span><span class="s1">;</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">entityReturnState </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">);</span>
                    <span class="s1">}</span>
                    <span class="s2">nonSpace </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
                    <span class="s4">// eslint-disable-next-line no-labels</span>
                    <span class="s3">break </span><span class="s2">outRootLoop</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">NL_LIKE</span><span class="s1">:</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prevI</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">`</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s2">start </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">i</span><span class="s1">;</span>
                    <span class="s3">break</span><span class="s1">;</span>
                <span class="s3">case </span><span class="s2">EOC</span><span class="s1">:</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                        <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">);</span>
                    <span class="s1">}</span>
                    <span class="s4">// eslint-disable-next-line no-labels</span>
                    <span class="s3">break </span><span class="s2">outRootLoop</span><span class="s1">;</span>
                <span class="s3">default</span><span class="s1">:</span>
                    <span class="s3">if </span><span class="s1">(!</span><span class="s2">isS</span><span class="s1">(</span><span class="s2">code</span><span class="s1">)) {</span>
                        <span class="s2">nonSpace </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
                    <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">nonSpace</span><span class="s1">) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s4">// We use the reportedTextBeforeRoot and reportedTextAfterRoot flags</span>
        <span class="s4">// to avoid reporting errors for every single character that is out of</span>
        <span class="s4">// place.</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">sawRoot </span><span class="s1">&amp;&amp; !</span><span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextBeforeRoot</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;text data outside of root node.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextBeforeRoot </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">closedRoot </span><span class="s1">&amp;&amp; !</span><span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextAfterRoot</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;text data outside of root node.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">reportedTextAfterRoot </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">pushAttribNS</span><span class="s1">(</span><span class="s2">name</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">local </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">qname</span><span class="s1">(</span><span class="s2">name</span><span class="s1">);</span>
        <span class="s3">const </span><span class="s2">attr </span><span class="s1">= { </span><span class="s2">name</span><span class="s1">, </span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">local</span><span class="s1">, </span><span class="s2">value </span><span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">attribList</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">attr</span><span class="s1">);</span>
        <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
        <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">attributeHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">attr</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">prefix </span><span class="s1">=== </span><span class="s0">&quot;xmlns&quot;</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">trimmed </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">trim</span><span class="s1">();</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">currentXMLVersion </span><span class="s1">=== </span><span class="s0">&quot;1.0&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">trimmed </span><span class="s1">=== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;invalid attempt to undefine prefix in XML 1.0&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">topNS</span><span class="s1">[</span><span class="s2">local</span><span class="s1">] = </span><span class="s2">trimmed</span><span class="s1">;</span>
            <span class="s2">nsPairCheck</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">local</span><span class="s1">, </span><span class="s2">trimmed</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">name </span><span class="s1">=== </span><span class="s0">&quot;xmlns&quot;</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">trimmed </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">trim</span><span class="s1">();</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">topNS</span><span class="s1">[</span><span class="s0">&quot;&quot;</span><span class="s1">] = </span><span class="s2">trimmed</span><span class="s1">;</span>
            <span class="s2">nsPairCheck</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">&quot;&quot;</span><span class="s1">, </span><span class="s2">trimmed</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">pushAttribPlain</span><span class="s1">(</span><span class="s2">name</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">attr </span><span class="s1">= { </span><span class="s2">name</span><span class="s1">, </span><span class="s2">value </span><span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">attribList</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">attr</span><span class="s1">);</span>
        <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
        <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">attributeHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">attr</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* End parsing. This performs final well-formedness checks and resets the</span>
     <span class="s6">* parser to a clean state.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns </span><span class="s6">this</span>
     <span class="s6">*/</span>
    <span class="s2">end</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">, </span><span class="s2">_b</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">sawRoot</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;document must contain a root element.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">tags </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s2">tags</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">tag </span><span class="s1">= </span><span class="s2">tags</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`unclosed tag: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">tag</span><span class="s1">.</span><span class="s2">name</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">((</span><span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">!== </span><span class="s2">S_BEGIN</span><span class="s1">) &amp;&amp; (</span><span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">!== </span><span class="s2">S_TEXT</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;unexpected end.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">text </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
            <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">textHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">text</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_closed </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
        <span class="s1">(</span><span class="s2">_b </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">endHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_b </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_b</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_init</span><span class="s1">();</span>
        <span class="s3">return this</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Resolve a namespace prefix.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">prefix The prefix to resolve.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns </span><span class="s6">The namespace URI or ``undefined`` if the prefix is not defined.</span>
     <span class="s6">*/</span>
    <span class="s2">resolve</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">, </span><span class="s2">_b</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">uri </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">topNS</span><span class="s1">[</span><span class="s2">prefix</span><span class="s1">];</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">uri </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">uri</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">tags </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">index </span><span class="s1">= </span><span class="s2">tags</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">; </span><span class="s2">index </span><span class="s1">&gt;= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">index</span><span class="s1">--) {</span>
            <span class="s2">uri </span><span class="s1">= </span><span class="s2">tags</span><span class="s1">[</span><span class="s2">index</span><span class="s1">].</span><span class="s2">ns</span><span class="s1">[</span><span class="s2">prefix</span><span class="s1">];</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">uri </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                <span class="s3">return </span><span class="s2">uri</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s2">uri </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">ns</span><span class="s1">[</span><span class="s2">prefix</span><span class="s1">];</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">uri </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">uri</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s1">(</span><span class="s2">_b </span><span class="s1">= (</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">opt</span><span class="s1">).</span><span class="s2">resolvePrefix</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_b </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_b</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">_a</span><span class="s1">, </span><span class="s2">prefix</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Parse a qname into its prefix and local name parts.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">name The name to parse</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns</span>
     <span class="s6">*/</span>
    <span class="s2">qname</span><span class="s1">(</span><span class="s2">name</span><span class="s1">) {</span>
        <span class="s4">// This is faster than using name.split(&quot;:&quot;).</span>
        <span class="s3">const </span><span class="s2">colon </span><span class="s1">= </span><span class="s2">name</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">&quot;:&quot;</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">colon </span><span class="s1">=== -</span><span class="s5">1</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s1">{ </span><span class="s2">prefix</span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">, </span><span class="s2">local</span><span class="s1">: </span><span class="s2">name </span><span class="s1">};</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s2">local </span><span class="s1">= </span><span class="s2">name</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">colon </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
        <span class="s3">const </span><span class="s2">prefix </span><span class="s1">= </span><span class="s2">name</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">colon</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">prefix </span><span class="s1">=== </span><span class="s0">&quot;&quot; </span><span class="s1">|| </span><span class="s2">local </span><span class="s1">=== </span><span class="s0">&quot;&quot; </span><span class="s1">|| </span><span class="s2">local</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">&quot;:&quot;</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`malformed name: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">}</span><span class="s0">.`</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s1">{ </span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">local </span><span class="s1">};</span>
    <span class="s1">}</span>
    <span class="s2">processAttribsNS</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">attribList </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">tag </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">;</span>
        <span class="s1">{</span>
            <span class="s4">// add namespace info to tag</span>
            <span class="s3">const </span><span class="s1">{ </span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">local </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">qname</span><span class="s1">(</span><span class="s2">tag</span><span class="s1">.</span><span class="s2">name</span><span class="s1">);</span>
            <span class="s2">tag</span><span class="s1">.</span><span class="s2">prefix </span><span class="s1">= </span><span class="s2">prefix</span><span class="s1">;</span>
            <span class="s2">tag</span><span class="s1">.</span><span class="s2">local </span><span class="s1">= </span><span class="s2">local</span><span class="s1">;</span>
            <span class="s3">const </span><span class="s2">uri </span><span class="s1">= </span><span class="s2">tag</span><span class="s1">.</span><span class="s2">uri </span><span class="s1">= (</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">)) !== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">_a </span><span class="s1">!== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s2">_a </span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">prefix </span><span class="s1">!== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">prefix </span><span class="s1">=== </span><span class="s0">&quot;xmlns&quot;</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;tags may not have </span><span class="s3">\&quot;</span><span class="s0">xmlns</span><span class="s3">\&quot; </span><span class="s0">as prefix.&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">uri </span><span class="s1">=== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`unbound namespace prefix: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">)}</span><span class="s0">.`</span><span class="s1">);</span>
                    <span class="s2">tag</span><span class="s1">.</span><span class="s2">uri </span><span class="s1">= </span><span class="s2">prefix</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">attribList</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">attributes </span><span class="s1">} = </span><span class="s2">tag</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">seen </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Set</span><span class="s1">();</span>
        <span class="s4">// Note: do not apply default ns to attributes:</span>
        <span class="s4">//   http://www.w3.org/TR/REC-xml-names/#defaulting</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">attr of attribList</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s1">{ </span><span class="s2">name</span><span class="s1">, </span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">local </span><span class="s1">} = </span><span class="s2">attr</span><span class="s1">;</span>
            <span class="s3">let </span><span class="s2">uri</span><span class="s1">;</span>
            <span class="s3">let </span><span class="s2">eqname</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">prefix </span><span class="s1">=== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
                <span class="s2">uri </span><span class="s1">= </span><span class="s2">name </span><span class="s1">=== </span><span class="s0">&quot;xmlns&quot; </span><span class="s1">? </span><span class="s2">XMLNS_NAMESPACE </span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
                <span class="s2">eqname </span><span class="s1">= </span><span class="s2">name</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">else </span><span class="s1">{</span>
                <span class="s2">uri </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">);</span>
                <span class="s4">// if there's any attributes with an undefined namespace,</span>
                <span class="s4">// then fail on them now.</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">uri </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
                    <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`unbound namespace prefix: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">)}</span><span class="s0">.`</span><span class="s1">);</span>
                    <span class="s2">uri </span><span class="s1">= </span><span class="s2">prefix</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s2">eqname </span><span class="s1">= </span><span class="s0">`{</span><span class="s2">$</span><span class="s1">{</span><span class="s2">uri</span><span class="s1">}</span><span class="s0">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">local</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">seen</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">eqname</span><span class="s1">)) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`duplicate attribute: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">eqname</span><span class="s1">}</span><span class="s0">.`</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s2">seen</span><span class="s1">.</span><span class="s2">add</span><span class="s1">(</span><span class="s2">eqname</span><span class="s1">);</span>
            <span class="s2">attr</span><span class="s1">.</span><span class="s2">uri </span><span class="s1">= </span><span class="s2">uri</span><span class="s1">;</span>
            <span class="s2">attributes</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] = </span><span class="s2">attr</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">attribList </span><span class="s1">= [];</span>
    <span class="s1">}</span>
    <span class="s2">processAttribsPlain</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">attribList </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s4">// eslint-disable-next-line prefer-destructuring</span>
        <span class="s3">const </span><span class="s2">attributes </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">.</span><span class="s2">attributes</span><span class="s1">;</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">{ </span><span class="s2">name</span><span class="s1">, </span><span class="s2">value </span><span class="s1">} </span><span class="s2">of attribList</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">attributes</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] !== </span><span class="s2">undefined</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`duplicate attribute: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">}</span><span class="s0">.`</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s2">attributes</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] = </span><span class="s2">value</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">attribList </span><span class="s1">= [];</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Handle a complete open tag. This parser code calls this once it has seen</span>
     <span class="s6">* the whole tag. This method checks for well-formeness and then emits</span>
     <span class="s6">* ``onopentag``.</span>
     <span class="s6">*/</span>
    <span class="s2">openTag</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">processAttribs</span><span class="s1">();</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">tags </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">tag </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">;</span>
        <span class="s2">tag</span><span class="s1">.</span><span class="s2">isSelfClosing </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s4">// There cannot be any pending text here due to the onopentagstart that was</span>
        <span class="s4">// necessarily emitted before we get here. So we do not check text.</span>
        <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
        <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openTagHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">tag</span><span class="s1">);</span>
        <span class="s2">tags</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">tag</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Handle a complete self-closing tag. This parser code calls this once it has</span>
     <span class="s6">* seen the whole tag. This method checks for well-formeness and then emits</span>
     <span class="s6">* ``onopentag`` and ``onclosetag``.</span>
     <span class="s6">*/</span>
    <span class="s2">openSelfClosingTag</span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">, </span><span class="s2">_b</span><span class="s1">, </span><span class="s2">_c</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">processAttribs</span><span class="s1">();</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">tags </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">tag </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">;</span>
        <span class="s2">tag</span><span class="s1">.</span><span class="s2">isSelfClosing </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s4">// There cannot be any pending text here due to the onopentagstart that was</span>
        <span class="s4">// necessarily emitted before we get here. So we do not check text.</span>
        <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
        <span class="s1">(</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openTagHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">tag</span><span class="s1">);</span>
        <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
        <span class="s1">(</span><span class="s2">_b </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">closeTagHandler</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_b </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">_b</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">tag</span><span class="s1">);</span>
        <span class="s3">const </span><span class="s2">top </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tag </span><span class="s1">= (</span><span class="s2">_c </span><span class="s1">= </span><span class="s2">tags</span><span class="s1">[</span><span class="s2">tags</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">]) !== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">_c </span><span class="s1">!== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s2">_c </span><span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">top </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">closedRoot </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Handle a complete close tag. This parser code calls this once it has seen</span>
     <span class="s6">* the whole tag. This method checks for well-formeness and then emits</span>
     <span class="s6">* ``onclosetag``.</span>
     <span class="s6">*/</span>
    <span class="s2">closeTag</span><span class="s1">() {</span>
        <span class="s3">const </span><span class="s1">{ </span><span class="s2">tags</span><span class="s1">, </span><span class="s2">name </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s4">// Our state after this will be S_TEXT, no matter what, and we can clear</span>
        <span class="s4">// tagName now.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">state </span><span class="s1">= </span><span class="s2">S_TEXT</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">name </span><span class="s1">=== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;weird empty close tag.&quot;</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">&quot;&lt;/&gt;&quot;</span><span class="s1">;</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">const </span><span class="s2">handler </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">closeTagHandler</span><span class="s1">;</span>
        <span class="s3">let </span><span class="s2">l </span><span class="s1">= </span><span class="s2">tags</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s2">l</span><span class="s1">-- &gt; </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">tag </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tag </span><span class="s1">= </span><span class="s2">tags</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">topNS </span><span class="s1">= </span><span class="s2">tag</span><span class="s1">.</span><span class="s2">ns</span><span class="s1">;</span>
            <span class="s4">// eslint-disable-next-line no-unused-expressions</span>
            <span class="s2">handler </span><span class="s1">=== </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">handler </span><span class="s1">=== </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s5">0 </span><span class="s1">: </span><span class="s2">handler</span><span class="s1">(</span><span class="s2">tag</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">tag</span><span class="s1">.</span><span class="s2">name </span><span class="s1">=== </span><span class="s2">name</span><span class="s1">) {</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;unexpected close tag.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">l </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">closedRoot </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">l </span><span class="s1">&lt; </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">`unmatched closing tag: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">}</span><span class="s0">.`</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">text </span><span class="s1">+= </span><span class="s0">`&lt;/</span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">}</span><span class="s0">&gt;`</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s6">/**</span>
     <span class="s6">* Resolves an entity. Makes any necessary well-formedness checks.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">entity The entity to resolve.</span>
     <span class="s6">*</span>
     <span class="s6">* </span><span class="s7">@returns </span><span class="s6">The parsed entity.</span>
     <span class="s6">*/</span>
    <span class="s2">parseEntity</span><span class="s1">(</span><span class="s2">entity</span><span class="s1">) {</span>
        <span class="s4">// startsWith would be significantly slower for this test.</span>
        <span class="s4">// eslint-disable-next-line @typescript-eslint/prefer-string-starts-ends-with</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">entity</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] !== </span><span class="s0">&quot;#&quot;</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">defined </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">ENTITIES</span><span class="s1">[</span><span class="s2">entity</span><span class="s1">];</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">defined </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
                <span class="s3">return </span><span class="s2">defined</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">isName</span><span class="s1">(</span><span class="s2">entity</span><span class="s1">) ? </span><span class="s0">&quot;undefined entity.&quot; </span><span class="s1">:</span>
                <span class="s0">&quot;disallowed character in entity name.&quot;</span><span class="s1">);</span>
            <span class="s3">return </span><span class="s0">`&amp;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">entity</span><span class="s1">}</span><span class="s0">;`</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">let </span><span class="s2">num </span><span class="s1">= </span><span class="s2">NaN</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">entity</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] === </span><span class="s0">&quot;x&quot; </span><span class="s1">&amp;&amp; </span><span class="s8">/^#x[0-9a-f]+$/i</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">entity</span><span class="s1">)) {</span>
            <span class="s2">num </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">entity</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s5">2</span><span class="s1">), </span><span class="s5">16</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s8">/^#[0-9]+$/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">entity</span><span class="s1">)) {</span>
            <span class="s2">num </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">entity</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s5">1</span><span class="s1">), </span><span class="s5">10</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s4">// The character reference is required to match the CHAR production.</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">isChar</span><span class="s1">(</span><span class="s2">num</span><span class="s1">)) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fail</span><span class="s1">(</span><span class="s0">&quot;malformed character entity.&quot;</span><span class="s1">);</span>
            <span class="s3">return </span><span class="s0">`&amp;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">entity</span><span class="s1">}</span><span class="s0">;`</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCodePoint</span><span class="s1">(</span><span class="s2">num</span><span class="s1">);</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">SaxesParser </span><span class="s1">= </span><span class="s2">SaxesParser</span><span class="s1">;</span>
<span class="s4">//# sourceMappingURL=saxes.js.map</span></pre>
</body>
</html>