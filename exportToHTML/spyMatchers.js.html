<html>
<head>
<title>spyMatchers.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
.s7 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
spyMatchers.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>

<span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">exports</span><span class="s1">, </span><span class="s0">'__esModule'</span><span class="s1">, {</span>
  <span class="s2">value</span><span class="s1">: </span><span class="s3">true</span>
<span class="s1">});</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">default </span><span class="s1">= </span><span class="s3">void </span><span class="s4">0</span><span class="s1">;</span>

<span class="s3">var </span><span class="s2">_jestGetType </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jest-get-type'</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">_jestMatcherUtils </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jest-matcher-utils'</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">_jasmineUtils </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./jasmineUtils'</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">_utils </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./utils'</span><span class="s1">);</span>

<span class="s5">/**</span>
 <span class="s5">* Copyright (c) Facebook, Inc. and its affiliates. All Rights Reserved.</span>
 <span class="s5">*</span>
 <span class="s5">* This source code is licensed under the MIT license found in the</span>
 <span class="s5">* LICENSE file in the root directory of this source tree.</span>
 <span class="s5">*/</span>
<span class="s6">// The optional property of matcher context is true if undefined.</span>
<span class="s3">const </span><span class="s2">isExpand </span><span class="s1">= </span><span class="s2">expand </span><span class="s1">=&gt; </span><span class="s2">expand </span><span class="s1">!== </span><span class="s3">false</span><span class="s1">;</span>

<span class="s3">const </span><span class="s2">PRINT_LIMIT </span><span class="s1">= </span><span class="s4">3</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">NO_ARGUMENTS </span><span class="s1">= </span><span class="s0">'called with 0 arguments'</span><span class="s1">;</span>

<span class="s3">const </span><span class="s2">printExpectedArgs </span><span class="s1">= </span><span class="s2">expected </span><span class="s1">=&gt;</span>
  <span class="s2">expected</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">0</span>
    <span class="s1">? </span><span class="s2">NO_ARGUMENTS</span>
    <span class="s1">: </span><span class="s2">expected</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">arg </span><span class="s1">=&gt; (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span><span class="s2">arg</span><span class="s1">)).</span><span class="s2">join</span><span class="s1">(</span><span class="s0">', '</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">printReceivedArgs </span><span class="s1">= (</span><span class="s2">received</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) =&gt;</span>
  <span class="s2">received</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">0</span>
    <span class="s1">? </span><span class="s2">NO_ARGUMENTS</span>
    <span class="s1">: </span><span class="s2">received</span>
        <span class="s1">.</span><span class="s2">map</span><span class="s1">((</span><span class="s2">arg</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt;</span>
          <span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">) &amp;&amp;</span>
          <span class="s2">i </span><span class="s1">&lt; </span><span class="s2">expected</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp;</span>
          <span class="s2">isEqualValue</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">arg</span><span class="s1">)</span>
            <span class="s1">? </span><span class="s2">printCommon</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">)</span>
            <span class="s1">: (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">arg</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">', '</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">printCommon </span><span class="s1">= </span><span class="s2">val </span><span class="s1">=&gt;</span>
  <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">DIM_COLOR</span><span class="s1">)((</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">val</span><span class="s1">));</span>

<span class="s3">const </span><span class="s2">isEqualValue </span><span class="s1">= (</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">) =&gt;</span>
  <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jasmineUtils</span><span class="s1">.</span><span class="s2">equals</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">, [</span><span class="s2">_utils</span><span class="s1">.</span><span class="s2">iterableEquality</span><span class="s1">]);</span>

<span class="s3">const </span><span class="s2">isEqualCall </span><span class="s1">= (</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">) =&gt; </span><span class="s2">isEqualValue</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">isEqualReturn </span><span class="s1">= (</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">result</span><span class="s1">) =&gt;</span>
  <span class="s2">result</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'return' </span><span class="s1">&amp;&amp; </span><span class="s2">isEqualValue</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">result</span><span class="s1">.</span><span class="s2">value</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">countReturns </span><span class="s1">= </span><span class="s2">results </span><span class="s1">=&gt;</span>
  <span class="s2">results</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">n</span><span class="s1">, </span><span class="s2">result</span><span class="s1">) =&gt; (</span><span class="s2">result</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'return' </span><span class="s1">? </span><span class="s2">n </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">: </span><span class="s2">n</span><span class="s1">), </span><span class="s4">0</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">printNumberOfReturns </span><span class="s1">= (</span><span class="s2">countReturns</span><span class="s1">, </span><span class="s2">countCalls</span><span class="s1">) =&gt;</span>
  <span class="s0">`</span><span class="s3">\n</span><span class="s0">Number of returns: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">countReturns</span><span class="s1">)}</span><span class="s0">` </span><span class="s1">+</span>
  <span class="s1">(</span><span class="s2">countCalls </span><span class="s1">!== </span><span class="s2">countReturns</span>
    <span class="s1">? </span><span class="s0">`</span><span class="s3">\n</span><span class="s0">Number of calls:   </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">countCalls</span><span class="s1">)}</span><span class="s0">`</span>
    <span class="s1">: </span><span class="s0">''</span><span class="s1">);</span>

<span class="s6">// Given a label, return a function which given a string,</span>
<span class="s6">// right-aligns it preceding the colon in the label.</span>
<span class="s3">const </span><span class="s2">getRightAlignedPrinter </span><span class="s1">= </span><span class="s2">label </span><span class="s1">=&gt; {</span>
  <span class="s6">// Assume that the label contains a colon.</span>
  <span class="s3">const </span><span class="s2">index </span><span class="s1">= </span><span class="s2">label</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">':'</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">suffix </span><span class="s1">= </span><span class="s2">label</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">index</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s1">(</span><span class="s2">string</span><span class="s1">, </span><span class="s2">isExpectedCall</span><span class="s1">) =&gt;</span>
    <span class="s1">(</span><span class="s2">isExpectedCall</span>
      <span class="s1">? </span><span class="s0">'-&gt;' </span><span class="s1">+ </span><span class="s0">' '</span><span class="s1">.</span><span class="s2">repeat</span><span class="s1">(</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">index </span><span class="s1">- </span><span class="s4">2 </span><span class="s1">- </span><span class="s2">string</span><span class="s1">.</span><span class="s2">length</span><span class="s1">))</span>
      <span class="s1">: </span><span class="s0">' '</span><span class="s1">.</span><span class="s2">repeat</span><span class="s1">(</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s2">index </span><span class="s1">- </span><span class="s2">string</span><span class="s1">.</span><span class="s2">length</span><span class="s1">))) +</span>
    <span class="s2">string </span><span class="s1">+</span>
    <span class="s2">suffix</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">printReceivedCallsNegative </span><span class="s1">= (</span>
  <span class="s2">expected</span><span class="s1">,</span>
  <span class="s2">indexedCalls</span><span class="s1">,</span>
  <span class="s2">isOnlyCall</span><span class="s1">,</span>
  <span class="s2">iExpectedCall</span>
<span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">0</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">label </span><span class="s1">= </span><span class="s0">'Received:     '</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">isOnlyCall</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">label </span><span class="s1">+ </span><span class="s2">printReceivedArgs</span><span class="s1">(</span><span class="s2">indexedCalls</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">expected</span><span class="s1">) + </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">printAligned </span><span class="s1">= </span><span class="s2">getRightAlignedPrinter</span><span class="s1">(</span><span class="s2">label</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s1">(</span>
    <span class="s0">'Received</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+</span>
    <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">(</span>
      <span class="s1">(</span><span class="s2">printed</span><span class="s1">, [</span><span class="s2">i</span><span class="s1">, </span><span class="s2">args</span><span class="s1">]) =&gt;</span>
        <span class="s2">printed </span><span class="s1">+</span>
        <span class="s2">printAligned</span><span class="s1">(</span><span class="s2">String</span><span class="s1">(</span><span class="s2">i </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">), </span><span class="s2">i </span><span class="s1">=== </span><span class="s2">iExpectedCall</span><span class="s1">) +</span>
        <span class="s2">printReceivedArgs</span><span class="s1">(</span><span class="s2">args</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) +</span>
        <span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">,</span>
      <span class="s0">''</span>
    <span class="s1">)</span>
  <span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">printExpectedReceivedCallsPositive </span><span class="s1">= (</span>
  <span class="s2">expected</span><span class="s1">,</span>
  <span class="s2">indexedCalls</span><span class="s1">,</span>
  <span class="s2">expand</span><span class="s1">,</span>
  <span class="s2">isOnlyCall</span><span class="s1">,</span>
  <span class="s2">iExpectedCall</span>
<span class="s1">) =&gt; {</span>
  <span class="s3">const </span><span class="s2">expectedLine </span><span class="s1">= </span><span class="s0">`Expected: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printExpectedArgs</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">`</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">0</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">expectedLine</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">label </span><span class="s1">= </span><span class="s0">'Received: '</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">isOnlyCall </span><span class="s1">&amp;&amp; (</span><span class="s2">iExpectedCall </span><span class="s1">=== </span><span class="s4">0 </span><span class="s1">|| </span><span class="s2">iExpectedCall </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">)) {</span>
    <span class="s3">const </span><span class="s2">received </span><span class="s1">= </span><span class="s2">indexedCalls</span><span class="s1">[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">1</span><span class="s1">];</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">isLineDiffableCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">)) {</span>
      <span class="s6">// Display diff without indentation.</span>
      <span class="s3">const </span><span class="s2">lines </span><span class="s1">= [</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">EXPECTED_COLOR</span><span class="s1">)(</span><span class="s0">'- Expected'</span><span class="s1">),</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">RECEIVED_COLOR</span><span class="s1">)(</span><span class="s0">'+ Received'</span><span class="s1">),</span>
        <span class="s0">''</span>
      <span class="s1">];</span>
      <span class="s3">const </span><span class="s2">length </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">.</span><span class="s2">length</span><span class="s1">, </span><span class="s2">received</span><span class="s1">.</span><span class="s2">length</span><span class="s1">);</span>

      <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">; </span><span class="s2">i </span><span class="s1">+= </span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">expected</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">received</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">isEqualValue</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">received</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
            <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s0">`  </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printCommon</span><span class="s1">(</span><span class="s2">received</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])}</span><span class="s0">,`</span><span class="s1">);</span>
            <span class="s3">continue</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">isLineDiffableArg</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">received</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
            <span class="s3">const </span><span class="s2">difference </span><span class="s1">= (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">diff</span><span class="s1">)(</span>
              <span class="s2">expected</span><span class="s1">[</span><span class="s2">i</span><span class="s1">],</span>
              <span class="s2">received</span><span class="s1">[</span><span class="s2">i</span><span class="s1">],</span>
              <span class="s1">{</span>
                <span class="s2">expand</span>
              <span class="s1">}</span>
            <span class="s1">);</span>

            <span class="s3">if </span><span class="s1">(</span>
              <span class="s3">typeof </span><span class="s2">difference </span><span class="s1">=== </span><span class="s0">'string' </span><span class="s1">&amp;&amp;</span>
              <span class="s2">difference</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'- Expected'</span><span class="s1">) &amp;&amp;</span>
              <span class="s2">difference</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'+ Received'</span><span class="s1">)</span>
            <span class="s1">) {</span>
              <span class="s6">// Omit annotation in case multiple args have diff.</span>
              <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">difference</span><span class="s1">.</span><span class="s2">split</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">).</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">3</span><span class="s1">).</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) + </span><span class="s0">','</span><span class="s1">);</span>
              <span class="s3">continue</span><span class="s1">;</span>
            <span class="s1">}</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">expected</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
          <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">EXPECTED_COLOR</span><span class="s1">)(</span>
              <span class="s0">'- ' </span><span class="s1">+ (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])</span>
            <span class="s1">) + </span><span class="s0">','</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">received</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
          <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">RECEIVED_COLOR</span><span class="s1">)(</span>
              <span class="s0">'+ ' </span><span class="s1">+ (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">received</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])</span>
            <span class="s1">) + </span><span class="s0">','</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s3">return </span><span class="s2">lines</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) + </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">expectedLine </span><span class="s1">+ </span><span class="s2">label </span><span class="s1">+ </span><span class="s2">printReceivedArgs</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) + </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">printAligned </span><span class="s1">= </span><span class="s2">getRightAlignedPrinter</span><span class="s1">(</span><span class="s2">label</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s1">(</span>
    <span class="s2">expectedLine </span><span class="s1">+</span>
    <span class="s0">'Received</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+</span>
    <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">printed</span><span class="s1">, [</span><span class="s2">i</span><span class="s1">, </span><span class="s2">received</span><span class="s1">]) =&gt; {</span>
      <span class="s3">const </span><span class="s2">aligned </span><span class="s1">= </span><span class="s2">printAligned</span><span class="s1">(</span><span class="s2">String</span><span class="s1">(</span><span class="s2">i </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">), </span><span class="s2">i </span><span class="s1">=== </span><span class="s2">iExpectedCall</span><span class="s1">);</span>
      <span class="s3">return </span><span class="s1">(</span>
        <span class="s2">printed </span><span class="s1">+</span>
        <span class="s1">((</span><span class="s2">i </span><span class="s1">=== </span><span class="s2">iExpectedCall </span><span class="s1">|| </span><span class="s2">iExpectedCall </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) &amp;&amp;</span>
        <span class="s2">isLineDiffableCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">)</span>
          <span class="s1">? </span><span class="s2">aligned</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s0">': '</span><span class="s1">, </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) +</span>
            <span class="s2">printDiffCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">, </span><span class="s2">expand</span><span class="s1">)</span>
          <span class="s1">: </span><span class="s2">aligned </span><span class="s1">+ </span><span class="s2">printReceivedArgs</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">)) +</span>
        <span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span>
      <span class="s1">);</span>
    <span class="s1">}, </span><span class="s0">''</span><span class="s1">)</span>
  <span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">indentation </span><span class="s1">= </span><span class="s0">'Received'</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/\w/g</span><span class="s1">, </span><span class="s0">' '</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">printDiffCall </span><span class="s1">= (</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">, </span><span class="s2">expand</span><span class="s1">) =&gt;</span>
  <span class="s2">received</span>
    <span class="s1">.</span><span class="s2">map</span><span class="s1">((</span><span class="s2">arg</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt; {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">expected</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isEqualValue</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">arg</span><span class="s1">)) {</span>
          <span class="s3">return </span><span class="s2">indentation </span><span class="s1">+ </span><span class="s0">'  ' </span><span class="s1">+ </span><span class="s2">printCommon</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">) + </span><span class="s0">','</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">isLineDiffableArg</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">arg</span><span class="s1">)) {</span>
          <span class="s3">const </span><span class="s2">difference </span><span class="s1">= (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">diff</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">arg</span><span class="s1">, {</span>
            <span class="s2">expand</span>
          <span class="s1">});</span>

          <span class="s3">if </span><span class="s1">(</span>
            <span class="s3">typeof </span><span class="s2">difference </span><span class="s1">=== </span><span class="s0">'string' </span><span class="s1">&amp;&amp;</span>
            <span class="s2">difference</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'- Expected'</span><span class="s1">) &amp;&amp;</span>
            <span class="s2">difference</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'+ Received'</span><span class="s1">)</span>
          <span class="s1">) {</span>
            <span class="s6">// Display diff with indentation.</span>
            <span class="s6">// Omit annotation in case multiple args have diff.</span>
            <span class="s3">return </span><span class="s1">(</span>
              <span class="s2">difference</span>
                <span class="s1">.</span><span class="s2">split</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">)</span>
                <span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">3</span><span class="s1">)</span>
                <span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">line </span><span class="s1">=&gt; </span><span class="s2">indentation </span><span class="s1">+ </span><span class="s2">line</span><span class="s1">)</span>
                <span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) + </span><span class="s0">','</span>
            <span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s6">// Display + only if received arg has no corresponding expected arg.</span>

      <span class="s3">return </span><span class="s1">(</span>
        <span class="s2">indentation </span><span class="s1">+</span>
        <span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">expected</span><span class="s1">.</span><span class="s2">length</span>
          <span class="s1">? </span><span class="s0">'  ' </span><span class="s1">+ (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">arg</span><span class="s1">)</span>
          <span class="s1">: (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">RECEIVED_COLOR</span><span class="s1">)(</span>
              <span class="s0">'+ ' </span><span class="s1">+ (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">arg</span><span class="s1">)</span>
            <span class="s1">)) +</span>
        <span class="s0">','</span>
      <span class="s1">);</span>
    <span class="s1">})</span>
    <span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">isLineDiffableCall </span><span class="s1">= (</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">) =&gt;</span>
  <span class="s2">expected</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span>
    <span class="s1">(</span><span class="s2">arg</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">received</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">isLineDiffableArg</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">, </span><span class="s2">received</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])</span>
  <span class="s1">); </span><span class="s6">// Almost redundant with function in jest-matcher-utils,</span>
<span class="s6">// except no line diff for any strings.</span>

<span class="s3">const </span><span class="s2">isLineDiffableArg </span><span class="s1">= (</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">received</span><span class="s1">) =&gt; {</span>
  <span class="s3">const </span><span class="s2">expectedType </span><span class="s1">= (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestGetType</span><span class="s1">.</span><span class="s2">getType</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">receivedType </span><span class="s1">= (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestGetType</span><span class="s1">.</span><span class="s2">getType</span><span class="s1">)(</span><span class="s2">received</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">expectedType </span><span class="s1">!== </span><span class="s2">receivedType</span><span class="s1">) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">((</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestGetType</span><span class="s1">.</span><span class="s2">isPrimitive</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span>
    <span class="s2">expectedType </span><span class="s1">=== </span><span class="s0">'date' </span><span class="s1">||</span>
    <span class="s2">expectedType </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
    <span class="s2">expectedType </span><span class="s1">=== </span><span class="s0">'regexp'</span>
  <span class="s1">) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">expected </span><span class="s3">instanceof </span><span class="s2">Error </span><span class="s1">&amp;&amp; </span><span class="s2">received </span><span class="s3">instanceof </span><span class="s2">Error</span><span class="s1">) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span>
    <span class="s2">expectedType </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp;</span>
    <span class="s3">typeof </span><span class="s2">expected</span><span class="s1">.</span><span class="s2">asymmetricMatch </span><span class="s1">=== </span><span class="s0">'function'</span>
  <span class="s1">) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span>
    <span class="s2">receivedType </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp;</span>
    <span class="s3">typeof </span><span class="s2">received</span><span class="s1">.</span><span class="s2">asymmetricMatch </span><span class="s1">=== </span><span class="s0">'function'</span>
  <span class="s1">) {</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">printResult </span><span class="s1">= (</span><span class="s2">result</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) =&gt;</span>
  <span class="s2">result</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'throw'</span>
    <span class="s1">? </span><span class="s0">'function call threw an error'</span>
    <span class="s1">: </span><span class="s2">result</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'incomplete'</span>
    <span class="s1">? </span><span class="s0">'function call has not returned yet'</span>
    <span class="s1">: </span><span class="s2">isEqualValue</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">result</span><span class="s1">.</span><span class="s2">value</span><span class="s1">)</span>
    <span class="s1">? </span><span class="s2">printCommon</span><span class="s1">(</span><span class="s2">result</span><span class="s1">.</span><span class="s2">value</span><span class="s1">)</span>
    <span class="s1">: (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">result</span><span class="s1">.</span><span class="s2">value</span><span class="s1">);</span>

<span class="s6">// Return either empty string or one line per indexed result,</span>
<span class="s6">// so additional empty line can separate from `Number of returns` which follows.</span>
<span class="s3">const </span><span class="s2">printReceivedResults </span><span class="s1">= (</span>
  <span class="s2">label</span><span class="s1">,</span>
  <span class="s2">expected</span><span class="s1">,</span>
  <span class="s2">indexedResults</span><span class="s1">,</span>
  <span class="s2">isOnlyCall</span><span class="s1">,</span>
  <span class="s2">iExpectedCall</span>
<span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">0</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">isOnlyCall </span><span class="s1">&amp;&amp; (</span><span class="s2">iExpectedCall </span><span class="s1">=== </span><span class="s4">0 </span><span class="s1">|| </span><span class="s2">iExpectedCall </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">)) {</span>
    <span class="s3">return </span><span class="s2">label </span><span class="s1">+ </span><span class="s2">printResult</span><span class="s1">(</span><span class="s2">indexedResults</span><span class="s1">[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">1</span><span class="s1">], </span><span class="s2">expected</span><span class="s1">) + </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">printAligned </span><span class="s1">= </span><span class="s2">getRightAlignedPrinter</span><span class="s1">(</span><span class="s2">label</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s1">(</span>
    <span class="s2">label</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s0">':'</span><span class="s1">, </span><span class="s0">''</span><span class="s1">).</span><span class="s2">trim</span><span class="s1">() +</span>
    <span class="s0">'</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+</span>
    <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">(</span>
      <span class="s1">(</span><span class="s2">printed</span><span class="s1">, [</span><span class="s2">i</span><span class="s1">, </span><span class="s2">result</span><span class="s1">]) =&gt;</span>
        <span class="s2">printed </span><span class="s1">+</span>
        <span class="s2">printAligned</span><span class="s1">(</span><span class="s2">String</span><span class="s1">(</span><span class="s2">i </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">), </span><span class="s2">i </span><span class="s1">=== </span><span class="s2">iExpectedCall</span><span class="s1">) +</span>
        <span class="s2">printResult</span><span class="s1">(</span><span class="s2">result</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) +</span>
        <span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">,</span>
      <span class="s0">''</span>
    <span class="s1">)</span>
  <span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">createToBeCalledMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span>
    <span class="s1">};</span>
    <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">ensureNoExpected</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s2">ensureMockOrSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedIsSpy </span><span class="s1">= </span><span class="s2">isSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">receivedIsSpy </span><span class="s1">? </span><span class="s0">'spy' </span><span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s2">count </span><span class="s1">= </span><span class="s2">receivedIsSpy</span>
      <span class="s1">? </span><span class="s2">received</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">count</span><span class="s1">()</span>
      <span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">calls </span><span class="s1">= </span><span class="s2">receivedIsSpy</span>
      <span class="s1">? </span><span class="s2">received</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">all</span><span class="s1">().</span><span class="s2">map</span><span class="s1">(</span><span class="s2">x </span><span class="s1">=&gt; </span><span class="s2">x</span><span class="s1">.</span><span class="s2">args</span><span class="s1">)</span>
      <span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">count </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt;</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">receivedName</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">) +</span>
          <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
          <span class="s0">`Expected number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span>
            <span class="s4">0</span>
          <span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s0">`Received number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
            <span class="s2">count</span>
          <span class="s1">)}</span><span class="s3">\n\n</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s2">calls</span>
            <span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">lines</span><span class="s1">, </span><span class="s2">args</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt; {</span>
              <span class="s3">if </span><span class="s1">(</span><span class="s2">lines</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s2">PRINT_LIMIT</span><span class="s1">) {</span>
                <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">i </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">}</span><span class="s0">: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printReceivedArgs</span><span class="s1">(</span><span class="s2">args</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">);</span>
              <span class="s1">}</span>

              <span class="s3">return </span><span class="s2">lines</span><span class="s1">;</span>
            <span class="s1">}, [])</span>
            <span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">)</span>
      <span class="s1">: () =&gt;</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">receivedName</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">) +</span>
          <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
          <span class="s0">`Expected number of calls: &gt;= </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span>
            <span class="s4">1</span>
          <span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s0">`Received number of calls:    </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
            <span class="s2">count</span>
          <span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">createToReturnMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span>
    <span class="s1">};</span>
    <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">ensureNoExpected</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s2">ensureMock</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">(); </span><span class="s6">// Count return values that correspond only to calls that returned</span>

    <span class="s3">const </span><span class="s2">count </span><span class="s1">= </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">results</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">(</span>
      <span class="s1">(</span><span class="s2">n</span><span class="s1">, </span><span class="s2">result</span><span class="s1">) =&gt; (</span><span class="s2">result</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'return' </span><span class="s1">? </span><span class="s2">n </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">: </span><span class="s2">n</span><span class="s1">),</span>
      <span class="s4">0</span>
    <span class="s1">);</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">count </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt;</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">receivedName</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">) +</span>
          <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
          <span class="s0">`Expected number of returns: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span>
            <span class="s4">0</span>
          <span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s0">`Received number of returns: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
            <span class="s2">count</span>
          <span class="s1">)}</span><span class="s3">\n\n</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">results</span>
            <span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">lines</span><span class="s1">, </span><span class="s2">result</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt; {</span>
              <span class="s3">if </span><span class="s1">(</span><span class="s2">result</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'return' </span><span class="s1">&amp;&amp; </span><span class="s2">lines</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s2">PRINT_LIMIT</span><span class="s1">) {</span>
                <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span>
                  <span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">i </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">}</span><span class="s0">: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
                    <span class="s2">result</span><span class="s1">.</span><span class="s2">value</span>
                  <span class="s1">)}</span><span class="s0">`</span>
                <span class="s1">);</span>
              <span class="s1">}</span>

              <span class="s3">return </span><span class="s2">lines</span><span class="s1">;</span>
            <span class="s1">}, [])</span>
            <span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) +</span>
          <span class="s1">(</span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s2">count</span>
            <span class="s1">? </span><span class="s0">`</span><span class="s3">\n\n</span><span class="s0">Received number of calls:   </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">,</span>
              <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)}</span><span class="s0">`</span>
            <span class="s1">: </span><span class="s0">''</span><span class="s1">)</span>
      <span class="s1">: () =&gt;</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">receivedName</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">) +</span>
          <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
          <span class="s0">`Expected number of returns: &gt;= </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">,</span>
          <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span><span class="s4">1</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s0">`Received number of returns:    </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">,</span>
          <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">count</span><span class="s1">)}</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s1">(</span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s2">count</span>
            <span class="s1">? </span><span class="s0">`</span><span class="s3">\n</span><span class="s0">Received number of calls:      </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">,</span>
              <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)}</span><span class="s0">`</span>
            <span class="s1">: </span><span class="s0">''</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">createToBeCalledTimesMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">'expected'</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span>
    <span class="s1">};</span>
    <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">ensureExpectedIsNonNegativeInteger</span><span class="s1">)(</span>
      <span class="s2">expected</span><span class="s1">,</span>
      <span class="s2">matcherName</span><span class="s1">,</span>
      <span class="s2">options</span>
    <span class="s1">);</span>
    <span class="s2">ensureMockOrSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedIsSpy </span><span class="s1">= </span><span class="s2">isSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">receivedIsSpy </span><span class="s1">? </span><span class="s0">'spy' </span><span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s2">count </span><span class="s1">= </span><span class="s2">receivedIsSpy</span>
      <span class="s1">? </span><span class="s2">received</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">count</span><span class="s1">()</span>
      <span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">count </span><span class="s1">=== </span><span class="s2">expected</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt;</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">receivedName</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">) +</span>
          <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
          <span class="s0">`Expected number of calls: not </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span>
            <span class="s2">expected</span>
          <span class="s1">)}</span><span class="s0">`</span>
      <span class="s1">: () =&gt;</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">receivedName</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">) +</span>
          <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
          <span class="s0">`Expected number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span>
            <span class="s2">expected</span>
          <span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s0">`Received number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
            <span class="s2">count</span>
          <span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">createToReturnTimesMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">'expected'</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span>
    <span class="s1">};</span>
    <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">ensureExpectedIsNonNegativeInteger</span><span class="s1">)(</span>
      <span class="s2">expected</span><span class="s1">,</span>
      <span class="s2">matcherName</span><span class="s1">,</span>
      <span class="s2">options</span>
    <span class="s1">);</span>
    <span class="s2">ensureMock</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">(); </span><span class="s6">// Count return values that correspond only to calls that returned</span>

    <span class="s3">const </span><span class="s2">count </span><span class="s1">= </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">results</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">(</span>
      <span class="s1">(</span><span class="s2">n</span><span class="s1">, </span><span class="s2">result</span><span class="s1">) =&gt; (</span><span class="s2">result</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'return' </span><span class="s1">? </span><span class="s2">n </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">: </span><span class="s2">n</span><span class="s1">),</span>
      <span class="s4">0</span>
    <span class="s1">);</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">count </span><span class="s1">=== </span><span class="s2">expected</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt;</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">receivedName</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">) +</span>
          <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
          <span class="s0">`Expected number of returns: not </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">,</span>
          <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)}</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s1">(</span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s2">count</span>
            <span class="s1">? </span><span class="s0">`</span><span class="s3">\n\n</span><span class="s0">Received number of calls:       </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">,</span>
              <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)}</span><span class="s0">`</span>
            <span class="s1">: </span><span class="s0">''</span><span class="s1">)</span>
      <span class="s1">: () =&gt;</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">receivedName</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">) +</span>
          <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
          <span class="s0">`Expected number of returns: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span>
            <span class="s2">expected</span>
          <span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s0">`Received number of returns: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
            <span class="s2">count</span>
          <span class="s1">)}</span><span class="s0">` </span><span class="s1">+</span>
          <span class="s1">(</span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s2">count</span>
            <span class="s1">? </span><span class="s0">`</span><span class="s3">\n</span><span class="s0">Received number of calls:   </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">,</span>
              <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)}</span><span class="s0">`</span>
            <span class="s1">: </span><span class="s0">''</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">createToBeCalledWithMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">...expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">'...expected'</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span>
    <span class="s1">};</span>
    <span class="s2">ensureMockOrSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedIsSpy </span><span class="s1">= </span><span class="s2">isSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">receivedIsSpy </span><span class="s1">? </span><span class="s0">'spy' </span><span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s2">calls </span><span class="s1">= </span><span class="s2">receivedIsSpy</span>
      <span class="s1">? </span><span class="s2">received</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">all</span><span class="s1">().</span><span class="s2">map</span><span class="s1">(</span><span class="s2">x </span><span class="s1">=&gt; </span><span class="s2">x</span><span class="s1">.</span><span class="s2">args</span><span class="s1">)</span>
      <span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span><span class="s2">call </span><span class="s1">=&gt; </span><span class="s2">isEqualCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">call</span><span class="s1">));</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt; {</span>
          <span class="s6">// Some examples of calls that are equal to expected value.</span>
          <span class="s3">const </span><span class="s2">indexedCalls </span><span class="s1">= [];</span>
          <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>

          <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s2">PRINT_LIMIT</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">isEqualCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
              <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s1">}</span>

            <span class="s2">i </span><span class="s1">+= </span><span class="s4">1</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`Expected: not </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printExpectedArgs</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s1">(</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1 </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">calls</span><span class="s1">[</span><span class="s4">0</span><span class="s1">]) ===</span>
              <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)</span>
              <span class="s1">? </span><span class="s0">''</span>
              <span class="s1">: </span><span class="s2">printReceivedCallsNegative</span><span class="s1">(</span>
                  <span class="s2">expected</span><span class="s1">,</span>
                  <span class="s2">indexedCalls</span><span class="s1">,</span>
                  <span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span>
                <span class="s1">)) +</span>
            <span class="s0">`</span><span class="s3">\n</span><span class="s0">Number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
              <span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span>
            <span class="s1">)}</span><span class="s0">`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">: () =&gt; {</span>
          <span class="s6">// Some examples of calls that are not equal to expected value.</span>
          <span class="s3">const </span><span class="s2">indexedCalls </span><span class="s1">= [];</span>
          <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>

          <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s2">PRINT_LIMIT</span><span class="s1">) {</span>
            <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s2">i </span><span class="s1">+= </span><span class="s4">1</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s2">printExpectedReceivedCallsPositive</span><span class="s1">(</span>
              <span class="s2">expected</span><span class="s1">,</span>
              <span class="s2">indexedCalls</span><span class="s1">,</span>
              <span class="s2">isExpand</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">expand</span><span class="s1">),</span>
              <span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span>
            <span class="s1">) +</span>
            <span class="s0">`</span><span class="s3">\n</span><span class="s0">Number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
              <span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span>
            <span class="s1">)}</span><span class="s0">`</span>
          <span class="s1">);</span>
        <span class="s1">};</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">createToReturnWithMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">'expected'</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span>
    <span class="s1">};</span>
    <span class="s2">ensureMock</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s1">{</span><span class="s2">calls</span><span class="s1">, </span><span class="s2">results</span><span class="s1">} = </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">results</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span><span class="s2">result </span><span class="s1">=&gt; </span><span class="s2">isEqualReturn</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">result</span><span class="s1">));</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt; {</span>
          <span class="s6">// Some examples of results that are equal to expected value.</span>
          <span class="s3">const </span><span class="s2">indexedResults </span><span class="s1">= [];</span>
          <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>

          <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s2">PRINT_LIMIT</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">isEqualReturn</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
              <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s1">}</span>

            <span class="s2">i </span><span class="s1">+= </span><span class="s4">1</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`Expected: not </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span>
              <span class="s2">expected</span>
            <span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s1">(</span><span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1 </span><span class="s1">&amp;&amp;</span>
            <span class="s2">results</span><span class="s1">[</span><span class="s4">0</span><span class="s1">].</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'return' </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">results</span><span class="s1">[</span><span class="s4">0</span><span class="s1">].</span><span class="s2">value</span><span class="s1">) ===</span>
              <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)</span>
              <span class="s1">? </span><span class="s0">''</span>
              <span class="s1">: </span><span class="s2">printReceivedResults</span><span class="s1">(</span>
                  <span class="s0">'Received:     '</span><span class="s1">,</span>
                  <span class="s2">expected</span><span class="s1">,</span>
                  <span class="s2">indexedResults</span><span class="s1">,</span>
                  <span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span>
                <span class="s1">)) +</span>
            <span class="s2">printNumberOfReturns</span><span class="s1">(</span><span class="s2">countReturns</span><span class="s1">(</span><span class="s2">results</span><span class="s1">), </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">: () =&gt; {</span>
          <span class="s6">// Some examples of results that are not equal to expected value.</span>
          <span class="s3">const </span><span class="s2">indexedResults </span><span class="s1">= [];</span>
          <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>

          <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s2">PRINT_LIMIT</span><span class="s1">) {</span>
            <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s2">i </span><span class="s1">+= </span><span class="s4">1</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`Expected: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s2">printReceivedResults</span><span class="s1">(</span>
              <span class="s0">'Received: '</span><span class="s1">,</span>
              <span class="s2">expected</span><span class="s1">,</span>
              <span class="s2">indexedResults</span><span class="s1">,</span>
              <span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span>
            <span class="s1">) +</span>
            <span class="s2">printNumberOfReturns</span><span class="s1">(</span><span class="s2">countReturns</span><span class="s1">(</span><span class="s2">results</span><span class="s1">), </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)</span>
          <span class="s1">);</span>
        <span class="s1">};</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">createLastCalledWithMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">...expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">'...expected'</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span>
    <span class="s1">};</span>
    <span class="s2">ensureMockOrSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedIsSpy </span><span class="s1">= </span><span class="s2">isSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">receivedIsSpy </span><span class="s1">? </span><span class="s0">'spy' </span><span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s2">calls </span><span class="s1">= </span><span class="s2">receivedIsSpy</span>
      <span class="s1">? </span><span class="s2">received</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">all</span><span class="s1">().</span><span class="s2">map</span><span class="s1">(</span><span class="s2">x </span><span class="s1">=&gt; </span><span class="s2">x</span><span class="s1">.</span><span class="s2">args</span><span class="s1">)</span>
      <span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">iLast </span><span class="s1">= </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">iLast </span><span class="s1">&gt;= </span><span class="s4">0 </span><span class="s1">&amp;&amp; </span><span class="s2">isEqualCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">iLast</span><span class="s1">]);</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt; {</span>
          <span class="s3">const </span><span class="s2">indexedCalls </span><span class="s1">= [];</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iLast </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s6">// Display preceding call as context.</span>
            <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iLast </span><span class="s1">- </span><span class="s4">1</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">iLast </span><span class="s1">- </span><span class="s4">1</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iLast</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">iLast</span><span class="s1">]]);</span>
          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`Expected: not </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printExpectedArgs</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s1">(</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1 </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">calls</span><span class="s1">[</span><span class="s4">0</span><span class="s1">]) ===</span>
              <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)</span>
              <span class="s1">? </span><span class="s0">''</span>
              <span class="s1">: </span><span class="s2">printReceivedCallsNegative</span><span class="s1">(</span>
                  <span class="s2">expected</span><span class="s1">,</span>
                  <span class="s2">indexedCalls</span><span class="s1">,</span>
                  <span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span><span class="s1">,</span>
                  <span class="s2">iLast</span>
                <span class="s1">)) +</span>
            <span class="s0">`</span><span class="s3">\n</span><span class="s0">Number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
              <span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span>
            <span class="s1">)}</span><span class="s0">`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">: () =&gt; {</span>
          <span class="s3">const </span><span class="s2">indexedCalls </span><span class="s1">= [];</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iLast </span><span class="s1">&gt;= </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">iLast </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
              <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">iLast </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// Is there a preceding call that is equal to expected args?</span>

              <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s4">0 </span><span class="s1">&amp;&amp; !</span><span class="s2">isEqualCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
                <span class="s2">i </span><span class="s1">-= </span><span class="s4">1</span><span class="s1">;</span>
              <span class="s1">}</span>

              <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s2">i </span><span class="s1">= </span><span class="s2">iLast </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// otherwise, preceding call</span>
              <span class="s1">}</span>

              <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s1">}</span>

            <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iLast</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">iLast</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s2">printExpectedReceivedCallsPositive</span><span class="s1">(</span>
              <span class="s2">expected</span><span class="s1">,</span>
              <span class="s2">indexedCalls</span><span class="s1">,</span>
              <span class="s2">isExpand</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">expand</span><span class="s1">),</span>
              <span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span><span class="s1">,</span>
              <span class="s2">iLast</span>
            <span class="s1">) +</span>
            <span class="s0">`</span><span class="s3">\n</span><span class="s0">Number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
              <span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span>
            <span class="s1">)}</span><span class="s0">`</span>
          <span class="s1">);</span>
        <span class="s1">};</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">createLastReturnedMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">'expected'</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span>
    <span class="s1">};</span>
    <span class="s2">ensureMock</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s1">{</span><span class="s2">calls</span><span class="s1">, </span><span class="s2">results</span><span class="s1">} = </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">iLast </span><span class="s1">= </span><span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">iLast </span><span class="s1">&gt;= </span><span class="s4">0 </span><span class="s1">&amp;&amp; </span><span class="s2">isEqualReturn</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">iLast</span><span class="s1">]);</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt; {</span>
          <span class="s3">const </span><span class="s2">indexedResults </span><span class="s1">= [];</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iLast </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s6">// Display preceding result as context.</span>
            <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iLast </span><span class="s1">- </span><span class="s4">1</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">iLast </span><span class="s1">- </span><span class="s4">1</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iLast</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">iLast</span><span class="s1">]]);</span>
          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`Expected: not </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span>
              <span class="s2">expected</span>
            <span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s1">(</span><span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1 </span><span class="s1">&amp;&amp;</span>
            <span class="s2">results</span><span class="s1">[</span><span class="s4">0</span><span class="s1">].</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'return' </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">results</span><span class="s1">[</span><span class="s4">0</span><span class="s1">].</span><span class="s2">value</span><span class="s1">) ===</span>
              <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)</span>
              <span class="s1">? </span><span class="s0">''</span>
              <span class="s1">: </span><span class="s2">printReceivedResults</span><span class="s1">(</span>
                  <span class="s0">'Received:     '</span><span class="s1">,</span>
                  <span class="s2">expected</span><span class="s1">,</span>
                  <span class="s2">indexedResults</span><span class="s1">,</span>
                  <span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span><span class="s1">,</span>
                  <span class="s2">iLast</span>
                <span class="s1">)) +</span>
            <span class="s2">printNumberOfReturns</span><span class="s1">(</span><span class="s2">countReturns</span><span class="s1">(</span><span class="s2">results</span><span class="s1">), </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">: () =&gt; {</span>
          <span class="s3">const </span><span class="s2">indexedResults </span><span class="s1">= [];</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iLast </span><span class="s1">&gt;= </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">iLast </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
              <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">iLast </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// Is there a preceding result that is equal to expected value?</span>

              <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s4">0 </span><span class="s1">&amp;&amp; !</span><span class="s2">isEqualReturn</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
                <span class="s2">i </span><span class="s1">-= </span><span class="s4">1</span><span class="s1">;</span>
              <span class="s1">}</span>

              <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s2">i </span><span class="s1">= </span><span class="s2">iLast </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// otherwise, preceding result</span>
              <span class="s1">}</span>

              <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s1">}</span>

            <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iLast</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">iLast</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`Expected: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s2">printReceivedResults</span><span class="s1">(</span>
              <span class="s0">'Received: '</span><span class="s1">,</span>
              <span class="s2">expected</span><span class="s1">,</span>
              <span class="s2">indexedResults</span><span class="s1">,</span>
              <span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span><span class="s1">,</span>
              <span class="s2">iLast</span>
            <span class="s1">) +</span>
            <span class="s2">printNumberOfReturns</span><span class="s1">(</span><span class="s2">countReturns</span><span class="s1">(</span><span class="s2">results</span><span class="s1">), </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)</span>
          <span class="s1">);</span>
        <span class="s1">};</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">createNthCalledWithMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">nth</span><span class="s1">, </span><span class="s2">...expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">'n'</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">expectedColor</span><span class="s1">: </span><span class="s2">arg </span><span class="s1">=&gt; </span><span class="s2">arg</span><span class="s1">,</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span><span class="s1">,</span>
      <span class="s2">secondArgument</span><span class="s1">: </span><span class="s0">'...expected'</span>
    <span class="s1">};</span>
    <span class="s2">ensureMockOrSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">Number</span><span class="s1">.</span><span class="s2">isSafeInteger</span><span class="s1">(</span><span class="s2">nth</span><span class="s1">) || </span><span class="s2">nth </span><span class="s1">&lt; </span><span class="s4">1</span><span class="s1">) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherErrorMessage</span><span class="s1">)(</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">undefined</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">),</span>
          <span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">expectedArgument</span><span class="s1">} </span><span class="s0">must be a positive integer`</span><span class="s1">,</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printWithType</span><span class="s1">)(</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">nth</span><span class="s1">,</span>
            <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span>
          <span class="s1">)</span>
        <span class="s1">)</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">receivedIsSpy </span><span class="s1">= </span><span class="s2">isSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">receivedIsSpy </span><span class="s1">? </span><span class="s0">'spy' </span><span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s2">calls </span><span class="s1">= </span><span class="s2">receivedIsSpy</span>
      <span class="s1">? </span><span class="s2">received</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">all</span><span class="s1">().</span><span class="s2">map</span><span class="s1">(</span><span class="s2">x </span><span class="s1">=&gt; </span><span class="s2">x</span><span class="s1">.</span><span class="s2">args</span><span class="s1">)</span>
      <span class="s1">: </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">length </span><span class="s1">= </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">iNth </span><span class="s1">= </span><span class="s2">nth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">&lt; </span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">isEqualCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">iNth</span><span class="s1">]);</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt; {</span>
          <span class="s6">// Display preceding and following calls,</span>
          <span class="s6">// in case assertions fails because index is off by one.</span>
          <span class="s3">const </span><span class="s2">indexedCalls </span><span class="s1">= [];</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1 </span><span class="s1">&gt;= </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iNth</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">iNth</span><span class="s1">]]);</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`n: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">nth</span><span class="s1">}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s0">`Expected: not </span><span class="s2">$</span><span class="s1">{</span><span class="s2">printExpectedArgs</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s1">(</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1 </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">calls</span><span class="s1">[</span><span class="s4">0</span><span class="s1">]) ===</span>
              <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)</span>
              <span class="s1">? </span><span class="s0">''</span>
              <span class="s1">: </span><span class="s2">printReceivedCallsNegative</span><span class="s1">(</span>
                  <span class="s2">expected</span><span class="s1">,</span>
                  <span class="s2">indexedCalls</span><span class="s1">,</span>
                  <span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span><span class="s1">,</span>
                  <span class="s2">iNth</span>
                <span class="s1">)) +</span>
            <span class="s0">`</span><span class="s3">\n</span><span class="s0">Number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
              <span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span>
            <span class="s1">)}</span><span class="s0">`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">: () =&gt; {</span>
          <span class="s6">// Display preceding and following calls:</span>
          <span class="s6">// * nearest call that is equal to expected args</span>
          <span class="s6">// * otherwise, adjacent call</span>
          <span class="s6">// in case assertions fails because of index, especially off by one.</span>
          <span class="s3">const </span><span class="s2">indexedCalls </span><span class="s1">= [];</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1 </span><span class="s1">&gt;= </span><span class="s4">0</span><span class="s1">) {</span>
              <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// Is there a preceding call that is equal to expected args?</span>

              <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s4">0 </span><span class="s1">&amp;&amp; !</span><span class="s2">isEqualCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
                <span class="s2">i </span><span class="s1">-= </span><span class="s4">1</span><span class="s1">;</span>
              <span class="s1">}</span>

              <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s2">i </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// otherwise, adjacent call</span>
              <span class="s1">}</span>

              <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s1">}</span>

            <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iNth</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">iNth</span><span class="s1">]]);</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">) {</span>
              <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// Is there a following call that is equal to expected args?</span>

              <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">length </span><span class="s1">&amp;&amp; !</span><span class="s2">isEqualCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
                <span class="s2">i </span><span class="s1">+= </span><span class="s4">1</span><span class="s1">;</span>
              <span class="s1">}</span>

              <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s2">length</span><span class="s1">) {</span>
                <span class="s2">i </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// otherwise, adjacent call</span>
              <span class="s1">}</span>

              <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s1">}</span>
          <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s6">// The number of received calls is fewer than the expected number.</span>
            <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// Is there a call that is equal to expected args?</span>

            <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s4">0 </span><span class="s1">&amp;&amp; !</span><span class="s2">isEqualCall</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
              <span class="s2">i </span><span class="s1">-= </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s4">0</span><span class="s1">) {</span>
              <span class="s2">i </span><span class="s1">= </span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// otherwise, last call</span>
            <span class="s1">}</span>

            <span class="s2">indexedCalls</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">calls</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`n: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">nth</span><span class="s1">}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s2">printExpectedReceivedCallsPositive</span><span class="s1">(</span>
              <span class="s2">expected</span><span class="s1">,</span>
              <span class="s2">indexedCalls</span><span class="s1">,</span>
              <span class="s2">isExpand</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">expand</span><span class="s1">),</span>
              <span class="s2">calls</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span><span class="s1">,</span>
              <span class="s2">iNth</span>
            <span class="s1">) +</span>
            <span class="s0">`</span><span class="s3">\n</span><span class="s0">Number of calls: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span><span class="s1">)(</span>
              <span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span>
            <span class="s1">)}</span><span class="s0">`</span>
          <span class="s1">);</span>
        <span class="s1">};</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">createNthReturnedWithMatcher </span><span class="s1">= </span><span class="s2">matcherName </span><span class="s1">=&gt;</span>
  <span class="s3">function </span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">nth</span><span class="s1">, </span><span class="s2">expected</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">expectedArgument </span><span class="s1">= </span><span class="s0">'n'</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">options </span><span class="s1">= {</span>
      <span class="s2">expectedColor</span><span class="s1">: </span><span class="s2">arg </span><span class="s1">=&gt; </span><span class="s2">arg</span><span class="s1">,</span>
      <span class="s2">isNot</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">isNot</span><span class="s1">,</span>
      <span class="s2">promise</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">promise</span><span class="s1">,</span>
      <span class="s2">secondArgument</span><span class="s1">: </span><span class="s0">'expected'</span>
    <span class="s1">};</span>
    <span class="s2">ensureMock</span><span class="s1">(</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">Number</span><span class="s1">.</span><span class="s2">isSafeInteger</span><span class="s1">(</span><span class="s2">nth</span><span class="s1">) || </span><span class="s2">nth </span><span class="s1">&lt; </span><span class="s4">1</span><span class="s1">) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherErrorMessage</span><span class="s1">)(</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
            <span class="s2">matcherName</span><span class="s1">,</span>
            <span class="s2">undefined</span><span class="s1">,</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">options</span>
          <span class="s1">),</span>
          <span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">expectedArgument</span><span class="s1">} </span><span class="s0">must be a positive integer`</span><span class="s1">,</span>
          <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printWithType</span><span class="s1">)(</span>
            <span class="s2">expectedArgument</span><span class="s1">,</span>
            <span class="s2">nth</span><span class="s1">,</span>
            <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span>
          <span class="s1">)</span>
        <span class="s1">)</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">receivedName </span><span class="s1">= </span><span class="s2">received</span><span class="s1">.</span><span class="s2">getMockName</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s1">{</span><span class="s2">calls</span><span class="s1">, </span><span class="s2">results</span><span class="s1">} = </span><span class="s2">received</span><span class="s1">.</span><span class="s2">mock</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">length </span><span class="s1">= </span><span class="s2">results</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">iNth </span><span class="s1">= </span><span class="s2">nth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">pass </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">&lt; </span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">isEqualReturn</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">iNth</span><span class="s1">]);</span>
    <span class="s3">const </span><span class="s2">message </span><span class="s1">= </span><span class="s2">pass</span>
      <span class="s1">? () =&gt; {</span>
          <span class="s6">// Display preceding and following results,</span>
          <span class="s6">// in case assertions fails because index is off by one.</span>
          <span class="s3">const </span><span class="s2">indexedResults </span><span class="s1">= [];</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1 </span><span class="s1">&gt;= </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iNth</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">iNth</span><span class="s1">]]);</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`n: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">nth</span><span class="s1">}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s0">`Expected: not </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span>
              <span class="s2">expected</span>
            <span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s1">(</span><span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1 </span><span class="s1">&amp;&amp;</span>
            <span class="s2">results</span><span class="s1">[</span><span class="s4">0</span><span class="s1">].</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'return' </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">results</span><span class="s1">[</span><span class="s4">0</span><span class="s1">].</span><span class="s2">value</span><span class="s1">) ===</span>
              <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)</span>
              <span class="s1">? </span><span class="s0">''</span>
              <span class="s1">: </span><span class="s2">printReceivedResults</span><span class="s1">(</span>
                  <span class="s0">'Received:     '</span><span class="s1">,</span>
                  <span class="s2">expected</span><span class="s1">,</span>
                  <span class="s2">indexedResults</span><span class="s1">,</span>
                  <span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span><span class="s1">,</span>
                  <span class="s2">iNth</span>
                <span class="s1">)) +</span>
            <span class="s2">printNumberOfReturns</span><span class="s1">(</span><span class="s2">countReturns</span><span class="s1">(</span><span class="s2">results</span><span class="s1">), </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">: () =&gt; {</span>
          <span class="s6">// Display preceding and following results:</span>
          <span class="s6">// * nearest result that is equal to expected value</span>
          <span class="s6">// * otherwise, adjacent result</span>
          <span class="s6">// in case assertions fails because of index, especially off by one.</span>
          <span class="s3">const </span><span class="s2">indexedResults </span><span class="s1">= [];</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1 </span><span class="s1">&gt;= </span><span class="s4">0</span><span class="s1">) {</span>
              <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// Is there a preceding result that is equal to expected value?</span>

              <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s4">0 </span><span class="s1">&amp;&amp; !</span><span class="s2">isEqualReturn</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
                <span class="s2">i </span><span class="s1">-= </span><span class="s4">1</span><span class="s1">;</span>
              <span class="s1">}</span>

              <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s2">i </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// otherwise, adjacent result</span>
              <span class="s1">}</span>

              <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s1">}</span>

            <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">iNth</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">iNth</span><span class="s1">]]);</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">) {</span>
              <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// Is there a following result that is equal to expected value?</span>

              <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">length </span><span class="s1">&amp;&amp; !</span><span class="s2">isEqualReturn</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
                <span class="s2">i </span><span class="s1">+= </span><span class="s4">1</span><span class="s1">;</span>
              <span class="s1">}</span>

              <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s2">length</span><span class="s1">) {</span>
                <span class="s2">i </span><span class="s1">= </span><span class="s2">iNth </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// otherwise, adjacent result</span>
              <span class="s1">}</span>

              <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
            <span class="s1">}</span>
          <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s6">// The number of received calls is fewer than the expected number.</span>
            <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// Is there a result that is equal to expected value?</span>

            <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s4">0 </span><span class="s1">&amp;&amp; !</span><span class="s2">isEqualReturn</span><span class="s1">(</span><span class="s2">expected</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">])) {</span>
              <span class="s2">i </span><span class="s1">-= </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s4">0</span><span class="s1">) {</span>
              <span class="s2">i </span><span class="s1">= </span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">; </span><span class="s6">// otherwise, last result</span>
            <span class="s1">}</span>

            <span class="s2">indexedResults</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">i</span><span class="s1">, </span><span class="s2">results</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
              <span class="s2">matcherName</span><span class="s1">,</span>
              <span class="s2">receivedName</span><span class="s1">,</span>
              <span class="s2">expectedArgument</span><span class="s1">,</span>
              <span class="s2">options</span>
            <span class="s1">) +</span>
            <span class="s0">'</span><span class="s3">\n\n</span><span class="s0">' </span><span class="s1">+</span>
            <span class="s0">`n: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">nth</span><span class="s1">}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s0">`Expected: </span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printExpected</span><span class="s1">)(</span><span class="s2">expected</span><span class="s1">)}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+</span>
            <span class="s2">printReceivedResults</span><span class="s1">(</span>
              <span class="s0">'Received: '</span><span class="s1">,</span>
              <span class="s2">expected</span><span class="s1">,</span>
              <span class="s2">indexedResults</span><span class="s1">,</span>
              <span class="s2">results</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">1</span><span class="s1">,</span>
              <span class="s2">iNth</span>
            <span class="s1">) +</span>
            <span class="s2">printNumberOfReturns</span><span class="s1">(</span><span class="s2">countReturns</span><span class="s1">(</span><span class="s2">results</span><span class="s1">), </span><span class="s2">calls</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)</span>
          <span class="s1">);</span>
        <span class="s1">};</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">message</span><span class="s1">,</span>
      <span class="s2">pass</span>
    <span class="s1">};</span>
  <span class="s1">};</span>

<span class="s3">const </span><span class="s2">spyMatchers </span><span class="s1">= {</span>
  <span class="s2">lastCalledWith</span><span class="s1">: </span><span class="s2">createLastCalledWithMatcher</span><span class="s1">(</span><span class="s0">'lastCalledWith'</span><span class="s1">),</span>
  <span class="s2">lastReturnedWith</span><span class="s1">: </span><span class="s2">createLastReturnedMatcher</span><span class="s1">(</span><span class="s0">'lastReturnedWith'</span><span class="s1">),</span>
  <span class="s2">nthCalledWith</span><span class="s1">: </span><span class="s2">createNthCalledWithMatcher</span><span class="s1">(</span><span class="s0">'nthCalledWith'</span><span class="s1">),</span>
  <span class="s2">nthReturnedWith</span><span class="s1">: </span><span class="s2">createNthReturnedWithMatcher</span><span class="s1">(</span><span class="s0">'nthReturnedWith'</span><span class="s1">),</span>
  <span class="s2">toBeCalled</span><span class="s1">: </span><span class="s2">createToBeCalledMatcher</span><span class="s1">(</span><span class="s0">'toBeCalled'</span><span class="s1">),</span>
  <span class="s2">toBeCalledTimes</span><span class="s1">: </span><span class="s2">createToBeCalledTimesMatcher</span><span class="s1">(</span><span class="s0">'toBeCalledTimes'</span><span class="s1">),</span>
  <span class="s2">toBeCalledWith</span><span class="s1">: </span><span class="s2">createToBeCalledWithMatcher</span><span class="s1">(</span><span class="s0">'toBeCalledWith'</span><span class="s1">),</span>
  <span class="s2">toHaveBeenCalled</span><span class="s1">: </span><span class="s2">createToBeCalledMatcher</span><span class="s1">(</span><span class="s0">'toHaveBeenCalled'</span><span class="s1">),</span>
  <span class="s2">toHaveBeenCalledTimes</span><span class="s1">: </span><span class="s2">createToBeCalledTimesMatcher</span><span class="s1">(</span><span class="s0">'toHaveBeenCalledTimes'</span><span class="s1">),</span>
  <span class="s2">toHaveBeenCalledWith</span><span class="s1">: </span><span class="s2">createToBeCalledWithMatcher</span><span class="s1">(</span><span class="s0">'toHaveBeenCalledWith'</span><span class="s1">),</span>
  <span class="s2">toHaveBeenLastCalledWith</span><span class="s1">: </span><span class="s2">createLastCalledWithMatcher</span><span class="s1">(</span>
    <span class="s0">'toHaveBeenLastCalledWith'</span>
  <span class="s1">),</span>
  <span class="s2">toHaveBeenNthCalledWith</span><span class="s1">: </span><span class="s2">createNthCalledWithMatcher</span><span class="s1">(</span>
    <span class="s0">'toHaveBeenNthCalledWith'</span>
  <span class="s1">),</span>
  <span class="s2">toHaveLastReturnedWith</span><span class="s1">: </span><span class="s2">createLastReturnedMatcher</span><span class="s1">(</span><span class="s0">'toHaveLastReturnedWith'</span><span class="s1">),</span>
  <span class="s2">toHaveNthReturnedWith</span><span class="s1">: </span><span class="s2">createNthReturnedWithMatcher</span><span class="s1">(</span><span class="s0">'toHaveNthReturnedWith'</span><span class="s1">),</span>
  <span class="s2">toHaveReturned</span><span class="s1">: </span><span class="s2">createToReturnMatcher</span><span class="s1">(</span><span class="s0">'toHaveReturned'</span><span class="s1">),</span>
  <span class="s2">toHaveReturnedTimes</span><span class="s1">: </span><span class="s2">createToReturnTimesMatcher</span><span class="s1">(</span><span class="s0">'toHaveReturnedTimes'</span><span class="s1">),</span>
  <span class="s2">toHaveReturnedWith</span><span class="s1">: </span><span class="s2">createToReturnWithMatcher</span><span class="s1">(</span><span class="s0">'toHaveReturnedWith'</span><span class="s1">),</span>
  <span class="s2">toReturn</span><span class="s1">: </span><span class="s2">createToReturnMatcher</span><span class="s1">(</span><span class="s0">'toReturn'</span><span class="s1">),</span>
  <span class="s2">toReturnTimes</span><span class="s1">: </span><span class="s2">createToReturnTimesMatcher</span><span class="s1">(</span><span class="s0">'toReturnTimes'</span><span class="s1">),</span>
  <span class="s2">toReturnWith</span><span class="s1">: </span><span class="s2">createToReturnWithMatcher</span><span class="s1">(</span><span class="s0">'toReturnWith'</span><span class="s1">)</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">isMock </span><span class="s1">= </span><span class="s2">received </span><span class="s1">=&gt;</span>
  <span class="s2">received </span><span class="s1">!= </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">received</span><span class="s1">.</span><span class="s2">_isMockFunction </span><span class="s1">=== </span><span class="s3">true</span><span class="s1">;</span>

<span class="s3">const </span><span class="s2">isSpy </span><span class="s1">= </span><span class="s2">received </span><span class="s1">=&gt;</span>
  <span class="s2">received </span><span class="s1">!= </span><span class="s3">null </span><span class="s1">&amp;&amp;</span>
  <span class="s2">received</span><span class="s1">.</span><span class="s2">calls </span><span class="s1">!= </span><span class="s3">null </span><span class="s1">&amp;&amp;</span>
  <span class="s3">typeof </span><span class="s2">received</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">all </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">&amp;&amp;</span>
  <span class="s3">typeof </span><span class="s2">received</span><span class="s1">.</span><span class="s2">calls</span><span class="s1">.</span><span class="s2">count </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">;</span>

<span class="s3">const </span><span class="s2">ensureMockOrSpy </span><span class="s1">= (</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">isMock</span><span class="s1">(</span><span class="s2">received</span><span class="s1">) &amp;&amp; !</span><span class="s2">isSpy</span><span class="s1">(</span><span class="s2">received</span><span class="s1">)) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span>
      <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherErrorMessage</span><span class="s1">)(</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
          <span class="s2">matcherName</span><span class="s1">,</span>
          <span class="s2">undefined</span><span class="s1">,</span>
          <span class="s2">expectedArgument</span><span class="s1">,</span>
          <span class="s2">options</span>
        <span class="s1">),</span>
        <span class="s0">`</span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">RECEIVED_COLOR</span><span class="s1">)(</span>
          <span class="s0">'received'</span>
        <span class="s1">)} </span><span class="s0">value must be a mock or spy function`</span><span class="s1">,</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printWithType</span><span class="s1">)(</span>
          <span class="s0">'Received'</span><span class="s1">,</span>
          <span class="s2">received</span><span class="s1">,</span>
          <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span>
        <span class="s1">)</span>
      <span class="s1">)</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">ensureMock </span><span class="s1">= (</span><span class="s2">received</span><span class="s1">, </span><span class="s2">matcherName</span><span class="s1">, </span><span class="s2">expectedArgument</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">isMock</span><span class="s1">(</span><span class="s2">received</span><span class="s1">)) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span>
      <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherErrorMessage</span><span class="s1">)(</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">matcherHint</span><span class="s1">)(</span>
          <span class="s2">matcherName</span><span class="s1">,</span>
          <span class="s2">undefined</span><span class="s1">,</span>
          <span class="s2">expectedArgument</span><span class="s1">,</span>
          <span class="s2">options</span>
        <span class="s1">),</span>
        <span class="s0">`</span><span class="s2">$</span><span class="s1">{(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">RECEIVED_COLOR</span><span class="s1">)(</span>
          <span class="s0">'received'</span>
        <span class="s1">)} </span><span class="s0">value must be a mock function`</span><span class="s1">,</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printWithType</span><span class="s1">)(</span>
          <span class="s0">'Received'</span><span class="s1">,</span>
          <span class="s2">received</span><span class="s1">,</span>
          <span class="s2">_jestMatcherUtils</span><span class="s1">.</span><span class="s2">printReceived</span>
        <span class="s1">)</span>
      <span class="s1">)</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">_default </span><span class="s1">= </span><span class="s2">spyMatchers</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">default </span><span class="s1">= </span><span class="s2">_default</span><span class="s1">;</span>
</pre>
</body>
</html>