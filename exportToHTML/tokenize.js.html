<html>
<head>
<title>tokenize.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #42c3d4;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
tokenize.js</font>
</center></td></tr></table>
<pre><span class="s0">var </span><span class="s1">Marker </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./marker'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">Token </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./token'</span><span class="s2">);</span>

<span class="s0">var </span><span class="s1">formatPosition </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../utils/format-position'</span><span class="s2">);</span>

<span class="s0">var </span><span class="s1">Level </span><span class="s2">= {</span>
  <span class="s1">BLOCK</span><span class="s2">: </span><span class="s3">'block'</span><span class="s2">,</span>
  <span class="s1">COMMENT</span><span class="s2">: </span><span class="s3">'comment'</span><span class="s2">,</span>
  <span class="s1">DOUBLE_QUOTE</span><span class="s2">: </span><span class="s3">'double-quote'</span><span class="s2">,</span>
  <span class="s1">RULE</span><span class="s2">: </span><span class="s3">'rule'</span><span class="s2">,</span>
  <span class="s1">SINGLE_QUOTE</span><span class="s2">: </span><span class="s3">'single-quote'</span>
<span class="s2">};</span>

<span class="s0">var </span><span class="s1">AT_RULES </span><span class="s2">= [</span>
  <span class="s3">'@charset'</span><span class="s2">,</span>
  <span class="s3">'@import'</span>
<span class="s2">];</span>

<span class="s0">var </span><span class="s1">BLOCK_RULES </span><span class="s2">= [</span>
  <span class="s3">'@-moz-document'</span><span class="s2">,</span>
  <span class="s3">'@document'</span><span class="s2">,</span>
  <span class="s3">'@-moz-keyframes'</span><span class="s2">,</span>
  <span class="s3">'@-ms-keyframes'</span><span class="s2">,</span>
  <span class="s3">'@-o-keyframes'</span><span class="s2">,</span>
  <span class="s3">'@-webkit-keyframes'</span><span class="s2">,</span>
  <span class="s3">'@keyframes'</span><span class="s2">,</span>
  <span class="s3">'@media'</span><span class="s2">,</span>
  <span class="s3">'@supports'</span><span class="s2">,</span>
  <span class="s3">'@container'</span><span class="s2">,</span>
  <span class="s3">'@layer'</span>
<span class="s2">];</span>

<span class="s0">var </span><span class="s1">IGNORE_END_COMMENT_PATTERN </span><span class="s2">= </span><span class="s4">/\/\* clean-css ignore:end \*\/$/</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">IGNORE_START_COMMENT_PATTERN </span><span class="s2">= </span><span class="s4">/^\/\* clean-css ignore:start \*\//</span><span class="s2">;</span>

<span class="s0">var </span><span class="s1">PAGE_MARGIN_BOXES </span><span class="s2">= [</span>
  <span class="s3">'@bottom-center'</span><span class="s2">,</span>
  <span class="s3">'@bottom-left'</span><span class="s2">,</span>
  <span class="s3">'@bottom-left-corner'</span><span class="s2">,</span>
  <span class="s3">'@bottom-right'</span><span class="s2">,</span>
  <span class="s3">'@bottom-right-corner'</span><span class="s2">,</span>
  <span class="s3">'@left-bottom'</span><span class="s2">,</span>
  <span class="s3">'@left-middle'</span><span class="s2">,</span>
  <span class="s3">'@left-top'</span><span class="s2">,</span>
  <span class="s3">'@right-bottom'</span><span class="s2">,</span>
  <span class="s3">'@right-middle'</span><span class="s2">,</span>
  <span class="s3">'@right-top'</span><span class="s2">,</span>
  <span class="s3">'@top-center'</span><span class="s2">,</span>
  <span class="s3">'@top-left'</span><span class="s2">,</span>
  <span class="s3">'@top-left-corner'</span><span class="s2">,</span>
  <span class="s3">'@top-right'</span><span class="s2">,</span>
  <span class="s3">'@top-right-corner'</span>
<span class="s2">];</span>

<span class="s0">var </span><span class="s1">EXTRA_PAGE_BOXES </span><span class="s2">= [</span>
  <span class="s3">'@footnote'</span><span class="s2">,</span>
  <span class="s3">'@footnotes'</span><span class="s2">,</span>
  <span class="s3">'@left'</span><span class="s2">,</span>
  <span class="s3">'@page-float-bottom'</span><span class="s2">,</span>
  <span class="s3">'@page-float-top'</span><span class="s2">,</span>
  <span class="s3">'@right'</span>
<span class="s2">];</span>

<span class="s0">var </span><span class="s1">REPEAT_PATTERN </span><span class="s2">= </span><span class="s4">/^\[\s{0,31}\d+\s{0,31}\]$/</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">TAIL_BROKEN_VALUE_PATTERN </span><span class="s2">= </span><span class="s4">/([^}])\}*$/</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">RULE_WORD_SEPARATOR_PATTERN </span><span class="s2">= </span><span class="s4">/[\s(]/</span><span class="s2">;</span>

<span class="s0">function </span><span class="s1">tokenize</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">internalContext </span><span class="s2">= {</span>
    <span class="s1">level</span><span class="s2">: </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK</span><span class="s2">,</span>
    <span class="s1">position</span><span class="s2">: {</span>
      <span class="s1">source</span><span class="s2">: </span><span class="s1">externalContext</span><span class="s2">.</span><span class="s1">source </span><span class="s2">|| </span><span class="s1">undefined</span><span class="s2">,</span>
      <span class="s1">line</span><span class="s2">: </span><span class="s5">1</span><span class="s2">,</span>
      <span class="s1">column</span><span class="s2">: </span><span class="s5">0</span><span class="s2">,</span>
      <span class="s1">index</span><span class="s2">: </span><span class="s5">0</span>
    <span class="s2">}</span>
  <span class="s2">};</span>

  <span class="s0">return </span><span class="s1">intoTokens</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">, </span><span class="s1">internalContext</span><span class="s2">, </span><span class="s0">false</span><span class="s2">);</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">intoTokens</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">, </span><span class="s1">internalContext</span><span class="s2">, </span><span class="s1">isNested</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">allTokens </span><span class="s2">= [];</span>
  <span class="s0">var </span><span class="s1">newTokens </span><span class="s2">= </span><span class="s1">allTokens</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">lastToken</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">ruleToken</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">ruleTokens </span><span class="s2">= [];</span>
  <span class="s0">var </span><span class="s1">propertyToken</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">metadata</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">metadatas </span><span class="s2">= [];</span>
  <span class="s0">var </span><span class="s1">level </span><span class="s2">= </span><span class="s1">internalContext</span><span class="s2">.</span><span class="s1">level</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">levels </span><span class="s2">= [];</span>
  <span class="s0">var </span><span class="s1">buffer </span><span class="s2">= [];</span>
  <span class="s0">var </span><span class="s1">buffers </span><span class="s2">= [];</span>
  <span class="s0">var </span><span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">serializedBuffer</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">serializedBufferPart</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">roundBracketLevel </span><span class="s2">= </span><span class="s5">0</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isQuoted</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isSpace</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isNewLineNix</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isNewLineWin</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isCarriageReturn</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isCommentStart</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">wasCommentStart </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isCommentEnd</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">wasCommentEnd </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isCommentEndMarker</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isEscaped</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">wasEscaped </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">characterWithNoSpecialMeaning</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isPreviousDash </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isVariable </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">isRaw </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">seekingPropertyBlockClosing </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">position </span><span class="s2">= </span><span class="s1">internalContext</span><span class="s2">.</span><span class="s1">position</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">lastCommentStartAt</span><span class="s2">;</span>

  <span class="s0">for </span><span class="s2">(; </span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">source</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">position</span><span class="s2">.</span><span class="s1">index</span><span class="s2">++) {</span>
    <span class="s0">var </span><span class="s1">character </span><span class="s2">= </span><span class="s1">source</span><span class="s2">[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">index</span><span class="s2">];</span>

    <span class="s1">isQuoted </span><span class="s2">= </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">SINGLE_QUOTE </span><span class="s2">|| </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">DOUBLE_QUOTE</span><span class="s2">;</span>
    <span class="s1">isSpace </span><span class="s2">= </span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SPACE </span><span class="s2">|| </span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">TAB</span><span class="s2">;</span>
    <span class="s1">isNewLineNix </span><span class="s2">= </span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">NEW_LINE_NIX</span><span class="s2">;</span>
    <span class="s1">isNewLineWin </span><span class="s2">= </span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">NEW_LINE_NIX</span>
      <span class="s2">&amp;&amp; </span><span class="s1">source</span><span class="s2">[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">- </span><span class="s5">1</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CARRIAGE_RETURN</span><span class="s2">;</span>
    <span class="s1">isCarriageReturn </span><span class="s2">= </span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CARRIAGE_RETURN</span>
      <span class="s2">&amp;&amp; </span><span class="s1">source</span><span class="s2">[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">] &amp;&amp; </span><span class="s1">source</span><span class="s2">[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">] != </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">NEW_LINE_NIX</span><span class="s2">;</span>
    <span class="s1">isCommentStart </span><span class="s2">= !</span><span class="s1">wasCommentEnd</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">!= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT </span><span class="s2">&amp;&amp; !</span><span class="s1">isQuoted</span>
      <span class="s2">&amp;&amp; </span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">ASTERISK </span><span class="s2">&amp;&amp; </span><span class="s1">source</span><span class="s2">[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">- </span><span class="s5">1</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">FORWARD_SLASH</span><span class="s2">;</span>
    <span class="s1">isCommentEndMarker </span><span class="s2">= !</span><span class="s1">wasCommentStart</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isQuoted </span><span class="s2">&amp;&amp; </span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">FORWARD_SLASH</span>
      <span class="s2">&amp;&amp; </span><span class="s1">source</span><span class="s2">[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">- </span><span class="s5">1</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">ASTERISK</span><span class="s2">;</span>
    <span class="s1">isCommentEnd </span><span class="s2">= </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT </span><span class="s2">&amp;&amp; </span><span class="s1">isCommentEndMarker</span><span class="s2">;</span>
    <span class="s1">characterWithNoSpecialMeaning </span><span class="s2">= !</span><span class="s1">isSpace </span><span class="s2">&amp;&amp; !</span><span class="s1">isCarriageReturn </span><span class="s2">&amp;&amp; (</span><span class="s1">character </span><span class="s2">&gt;= </span><span class="s3">'A' </span><span class="s2">&amp;&amp; </span><span class="s1">character </span><span class="s2">&lt;= </span><span class="s3">'Z' </span><span class="s2">|| </span><span class="s1">character </span><span class="s2">&gt;= </span><span class="s3">'a' </span><span class="s2">&amp;&amp; </span><span class="s1">character </span><span class="s2">&lt;= </span><span class="s3">'z' </span><span class="s2">|| </span><span class="s1">character </span><span class="s2">&gt;= </span><span class="s3">'0' </span><span class="s2">&amp;&amp; </span><span class="s1">character </span><span class="s2">&lt;= </span><span class="s3">'9' </span><span class="s2">|| </span><span class="s1">character </span><span class="s2">== </span><span class="s3">'-'</span><span class="s2">);</span>
    <span class="s1">isVariable </span><span class="s2">= </span><span class="s1">isVariable </span><span class="s2">|| (</span><span class="s1">level </span><span class="s2">!= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT </span><span class="s2">&amp;&amp; !</span><span class="s1">seekingValue </span><span class="s2">&amp;&amp; </span><span class="s1">isPreviousDash </span><span class="s2">&amp;&amp; </span><span class="s1">character </span><span class="s2">=== </span><span class="s3">'-' </span><span class="s2">&amp;&amp; </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s5">1</span><span class="s2">);</span>
    <span class="s1">isPreviousDash </span><span class="s2">= </span><span class="s1">character </span><span class="s2">=== </span><span class="s3">'-'</span><span class="s2">;</span>
    <span class="s1">roundBracketLevel </span><span class="s2">= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">roundBracketLevel</span><span class="s2">, </span><span class="s5">0</span><span class="s2">);</span>

    <span class="s1">metadata </span><span class="s2">= </span><span class="s1">isBufferEmpty</span>
      <span class="s2">? [</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">]</span>
      <span class="s2">: </span><span class="s1">metadata</span><span class="s2">;</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">isEscaped</span><span class="s2">) {</span>
      <span class="s6">// previous character was a backslash</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">characterWithNoSpecialMeaning</span><span class="s2">) {</span>
      <span class="s6">// it's just an alphanumeric character or a hyphen (part of any rule or property name) so let's end it quickly</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">((</span><span class="s1">isSpace </span><span class="s2">|| </span><span class="s1">isNewLineNix </span><span class="s2">&amp;&amp; !</span><span class="s1">isNewLineWin</span><span class="s2">) &amp;&amp; (</span><span class="s1">isQuoted </span><span class="s2">|| </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT</span><span class="s2">)) {</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">((</span><span class="s1">isSpace </span><span class="s2">|| </span><span class="s1">isNewLineNix </span><span class="s2">&amp;&amp; !</span><span class="s1">isNewLineWin</span><span class="s2">) &amp;&amp; </span><span class="s1">isBufferEmpty</span><span class="s2">) {</span>
      <span class="s6">// noop</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(!</span><span class="s1">isCommentEnd </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT</span><span class="s2">) {</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(!</span><span class="s1">isCommentStart </span><span class="s2">&amp;&amp; !</span><span class="s1">isCommentEnd </span><span class="s2">&amp;&amp; </span><span class="s1">isRaw</span><span class="s2">) {</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isCommentStart</span>
        <span class="s2">&amp;&amp; </span><span class="s1">isVariable</span>
        <span class="s2">&amp;&amp; (</span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK </span><span class="s2">|| </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span><span class="s2">) &amp;&amp; </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">) {</span>
      <span class="s6">// comment start within a variable, e.g. var(/*&lt;--</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>

      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isCommentStart </span><span class="s2">&amp;&amp; (</span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK </span><span class="s2">|| </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span><span class="s2">) &amp;&amp; </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">) {</span>
      <span class="s6">// comment start within block preceded by some content, e.g. div/*&lt;--</span>
      <span class="s1">metadatas</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">);</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">buffers</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">));</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>

      <span class="s1">buffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(-</span><span class="s5">2</span><span class="s2">);</span>
      <span class="s1">metadata </span><span class="s2">= [</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column </span><span class="s2">- </span><span class="s5">1</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">];</span>

      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isCommentStart</span><span class="s2">) {</span>
      <span class="s6">// comment start, e.g. /*&lt;--</span>
      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT</span><span class="s2">;</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isCommentEnd </span><span class="s2">&amp;&amp; </span><span class="s1">isVariable</span><span class="s2">) {</span>
      <span class="s6">// comment end within a variable, e.g. var(/*!*/&lt;--</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isCommentEnd </span><span class="s2">&amp;&amp; </span><span class="s1">isIgnoreStartComment</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)) {</span>
      <span class="s6">// ignore:start comment end, e.g. /* clean-css ignore:start */&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">() + </span><span class="s1">character</span><span class="s2">;</span>
      <span class="s1">lastToken </span><span class="s2">= [</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">COMMENT</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">];</span>
      <span class="s1">newTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">lastToken</span><span class="s2">);</span>

      <span class="s1">isRaw </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s1">metadata </span><span class="s2">= </span><span class="s1">metadatas</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">() || </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= </span><span class="s1">buffers</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">() || [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s5">0</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isCommentEnd </span><span class="s2">&amp;&amp; </span><span class="s1">isIgnoreEndComment</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)) {</span>
      <span class="s6">// ignore:start comment end, e.g. /* clean-css ignore:end */&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">) + </span><span class="s1">character</span><span class="s2">;</span>
      <span class="s1">lastCommentStartAt </span><span class="s2">= </span><span class="s1">serializedBuffer</span><span class="s2">.</span><span class="s1">lastIndexOf</span><span class="s2">(</span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">FORWARD_SLASH </span><span class="s2">+ </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">ASTERISK</span><span class="s2">);</span>

      <span class="s1">serializedBufferPart </span><span class="s2">= </span><span class="s1">serializedBuffer</span><span class="s2">.</span><span class="s1">substring</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">lastCommentStartAt</span><span class="s2">);</span>
      <span class="s1">lastToken </span><span class="s2">= [</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">RAW</span><span class="s2">,</span>
        <span class="s1">serializedBufferPart</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBufferPart</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">];</span>
      <span class="s1">newTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">lastToken</span><span class="s2">);</span>

      <span class="s1">serializedBufferPart </span><span class="s2">= </span><span class="s1">serializedBuffer</span><span class="s2">.</span><span class="s1">substring</span><span class="s2">(</span><span class="s1">lastCommentStartAt</span><span class="s2">);</span>
      <span class="s1">metadata </span><span class="s2">= [</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column </span><span class="s2">- </span><span class="s1">serializedBufferPart</span><span class="s2">.</span><span class="s1">length </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">];</span>
      <span class="s1">lastToken </span><span class="s2">= [</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">COMMENT</span><span class="s2">,</span>
        <span class="s1">serializedBufferPart</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBufferPart</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">];</span>
      <span class="s1">newTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">lastToken</span><span class="s2">);</span>

      <span class="s1">isRaw </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">metadata </span><span class="s2">= </span><span class="s1">metadatas</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">() || </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= </span><span class="s1">buffers</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">() || [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s5">0</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isCommentEnd</span><span class="s2">) {</span>
      <span class="s6">// comment end, e.g. /* comment */&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">() + </span><span class="s1">character</span><span class="s2">;</span>
      <span class="s1">lastToken </span><span class="s2">= [</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">COMMENT</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">];</span>
      <span class="s1">newTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">lastToken</span><span class="s2">);</span>

      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">metadata </span><span class="s2">= </span><span class="s1">metadatas</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">() || </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= </span><span class="s1">buffers</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">() || [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s5">0</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isCommentEndMarker </span><span class="s2">&amp;&amp; </span><span class="s1">source</span><span class="s2">[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">] != </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">ASTERISK</span><span class="s2">) {</span>
      <span class="s1">externalContext</span><span class="s2">.</span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s3">'Unexpected </span><span class="s0">\'</span><span class="s3">*/</span><span class="s0">\' </span><span class="s3">at ' </span><span class="s2">+ </span><span class="s1">formatPosition</span><span class="s2">([</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">]) + </span><span class="s3">'.'</span><span class="s2">);</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SINGLE_QUOTE </span><span class="s2">&amp;&amp; !</span><span class="s1">isQuoted</span><span class="s2">) {</span>
      <span class="s6">// single quotation start, e.g. a[href^='https&lt;--</span>
      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">SINGLE_QUOTE</span><span class="s2">;</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SINGLE_QUOTE </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">SINGLE_QUOTE</span><span class="s2">) {</span>
      <span class="s6">// single quotation end, e.g. a[href^='https'&lt;--</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">DOUBLE_QUOTE </span><span class="s2">&amp;&amp; !</span><span class="s1">isQuoted</span><span class="s2">) {</span>
      <span class="s6">// double quotation start, e.g. a[href^=&quot;&lt;--</span>
      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">DOUBLE_QUOTE</span><span class="s2">;</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">DOUBLE_QUOTE </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">DOUBLE_QUOTE</span><span class="s2">) {</span>
      <span class="s6">// double quotation end, e.g. a[href^=&quot;https&quot;&lt;--</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">!= </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_ROUND_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">character </span><span class="s2">!= </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">OPEN_ROUND_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">!= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT </span><span class="s2">&amp;&amp; !</span><span class="s1">isQuoted </span><span class="s2">&amp;&amp; </span><span class="s1">roundBracketLevel </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">) {</span>
      <span class="s6">// character inside any function, e.g. hsla(.&lt;--</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">OPEN_ROUND_BRACKET</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isQuoted </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">!= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">seekingValue</span><span class="s2">) {</span>
      <span class="s6">// round open bracket, e.g. @import url(&lt;--</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>

      <span class="s1">roundBracketLevel</span><span class="s2">++;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_ROUND_BRACKET</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isQuoted</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">!= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">COMMENT</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">seekingValue</span><span class="s2">) {</span>
      <span class="s6">// round open bracket, e.g. @import url(test.css)&lt;--</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>

      <span class="s1">roundBracketLevel</span><span class="s2">--;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SEMICOLON </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK </span><span class="s2">&amp;&amp; </span><span class="s1">buffer</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">AT</span><span class="s2">) {</span>
      <span class="s6">// semicolon ending rule at block level, e.g. @import '...';&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">allTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COMMA </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK </span><span class="s2">&amp;&amp; </span><span class="s1">ruleToken</span><span class="s2">) {</span>
      <span class="s6">// comma separator at block level, e.g. a,div,&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">tokenScopeFrom</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">, </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">length</span><span class="s2">)]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COMMA </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK </span><span class="s2">&amp;&amp; </span><span class="s1">tokenTypeFrom</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">) == </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE</span><span class="s2">) {</span>
      <span class="s6">// comma separator at block level, e.g. @import url(...) screen,&lt;--</span>
      <span class="s6">// keep iterating as end semicolon will create the token</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COMMA </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK</span><span class="s2">) {</span>
      <span class="s6">// comma separator at block level, e.g. a,&lt;--</span>
      <span class="s1">ruleToken </span><span class="s2">= [</span><span class="s1">tokenTypeFrom</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">), [], []];</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">tokenScopeFrom</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">OPEN_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK</span>
      <span class="s2">&amp;&amp; </span><span class="s1">ruleToken</span>
      <span class="s2">&amp;&amp; </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">NESTED_BLOCK</span><span class="s2">) {</span>
      <span class="s6">// open brace opening at-rule at block level, e.g. @media{&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">NESTED_BLOCK_SCOPE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">allTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">);</span>

      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">++;</span>
      <span class="s1">position</span><span class="s2">.</span><span class="s1">index</span><span class="s2">++;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>

      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] = </span><span class="s1">intoTokens</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">, </span><span class="s1">internalContext</span><span class="s2">, </span><span class="s0">true</span><span class="s2">);</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">OPEN_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK</span>
      <span class="s2">&amp;&amp; </span><span class="s1">tokenTypeFrom</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">) == </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">NESTED_BLOCK</span><span class="s2">) {</span>
      <span class="s6">// open brace opening at-rule at block level, e.g. @media{&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s1">ruleToken </span><span class="s2">|| [</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">NESTED_BLOCK</span><span class="s2">, [], []];</span>
      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">NESTED_BLOCK_SCOPE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">allTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">);</span>

      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">++;</span>
      <span class="s1">position</span><span class="s2">.</span><span class="s1">index</span><span class="s2">++;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s1">isVariable </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>

      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] = </span><span class="s1">intoTokens</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">, </span><span class="s1">internalContext</span><span class="s2">, </span><span class="s0">true</span><span class="s2">);</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">OPEN_CURLY_BRACKET </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK</span><span class="s2">) {</span>
      <span class="s6">// open brace opening rule at block level, e.g. div{&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s1">ruleToken </span><span class="s2">|| [</span><span class="s1">tokenTypeFrom</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">), [], []];</span>
      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">tokenScopeFrom</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">, </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">length</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">];</span>
      <span class="s1">allTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">);</span>

      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">OPEN_CURLY_BRACKET </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span><span class="s2">) {</span>
      <span class="s6">// open brace opening rule at rule level, e.g. div{--variable:{&lt;--</span>
      <span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">);</span>
      <span class="s1">ruleToken </span><span class="s2">= [</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_BLOCK</span><span class="s2">, []];</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">);</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">];</span>

      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span><span class="s2">;</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">OPEN_CURLY_BRACKET </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">isPageMarginBox</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)) {</span>
      <span class="s6">// open brace opening page-margin box at rule level, e.g. @page{@top-center{&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">);</span>
      <span class="s1">ruleToken </span><span class="s2">= [</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE_BLOCK</span><span class="s2">, [], []];</span>
      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE_BLOCK_SCOPE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">newTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">ruleToken</span><span class="s2">);</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">];</span>

      <span class="s1">levels</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">level</span><span class="s2">);</span>
      <span class="s1">level </span><span class="s2">= </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COLON </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; !</span><span class="s1">seekingValue</span><span class="s2">) {</span>
      <span class="s6">// colon at rule level, e.g. a{color:&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">propertyToken </span><span class="s2">= [</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY</span><span class="s2">,</span>
        <span class="s2">[</span>
          <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_NAME</span><span class="s2">,</span>
          <span class="s1">serializedBuffer</span><span class="s2">,</span>
          <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
        <span class="s2">]</span>
      <span class="s2">];</span>
      <span class="s1">newTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">propertyToken</span><span class="s2">);</span>

      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SEMICOLON</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span>
      <span class="s2">&amp;&amp; </span><span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">0</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span>
      <span class="s2">&amp;&amp; </span><span class="s1">buffer</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">AT</span><span class="s2">) {</span>
      <span class="s6">// semicolon at rule level for at-rule, e.g. a{--color:{@apply(--other-color);&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SEMICOLON </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">propertyToken </span><span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span><span class="s2">) {</span>
      <span class="s6">// semicolon at rule level, e.g. a{color:red;&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>

      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s1">isVariable </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SEMICOLON</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span>
      <span class="s2">&amp;&amp; </span><span class="s1">isBufferEmpty</span>
      <span class="s2">&amp;&amp; </span><span class="s1">isVariable</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">propertyToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]) {</span>
      <span class="s6">// semicolon after empty variable value at rule level, e.g. a{--color: ;&lt;--</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">, </span><span class="s3">' '</span><span class="s2">, [</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s3">' '</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]]);</span>
      <span class="s1">isVariable </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SEMICOLON </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">propertyToken </span><span class="s2">&amp;&amp; </span><span class="s1">isBufferEmpty</span><span class="s2">) {</span>
      <span class="s6">// semicolon after bracketed value at rule level, e.g. a{color:rgb(...);&lt;--</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SEMICOLON</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span>
      <span class="s2">&amp;&amp; </span><span class="s1">buffer</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">AT</span><span class="s2">) {</span>
      <span class="s6">// semicolon for at-rule at rule level, e.g. a{@apply(--variable);&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">);</span>
      <span class="s1">newTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>

      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SEMICOLON </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">seekingPropertyBlockClosing</span><span class="s2">) {</span>
      <span class="s6">// close brace after a property block at rule level, e.g. a{--custom:{color:red;};&lt;--</span>
      <span class="s1">seekingPropertyBlockClosing </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">SEMICOLON </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">isBufferEmpty</span><span class="s2">) {</span>
      <span class="s6">// stray semicolon at rule level, e.g. a{;&lt;--</span>
      <span class="s6">// noop</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span>
      <span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty </span><span class="s2">&amp;&amp; </span><span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">) {</span>
      <span class="s6">// close brace at rule level, e.g. a{--color:{color:red}&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">);</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">];</span>

      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span>
      <span class="s2">&amp;&amp; </span><span class="s1">buffer</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">AT</span>
      <span class="s2">&amp;&amp; </span><span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">) {</span>
      <span class="s6">// close brace at rule level for at-rule, e.g. a{--color:{@apply(--other-color)}&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">);</span>
      <span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">];</span>

      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span>
      <span class="s2">&amp;&amp; </span><span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">) {</span>
      <span class="s6">// close brace at rule level after space, e.g. a{--color:{color:red }&lt;--</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">];</span>

      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span><span class="s2">) {</span>
      <span class="s6">// close brace at rule level, e.g. a{color:red}&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">);</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">allTokens</span><span class="s2">;</span>

      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span>
      <span class="s2">&amp;&amp; </span><span class="s1">buffer</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">AT</span><span class="s2">) {</span>
      <span class="s6">// close brace after at-rule at rule level, e.g. a{@apply(--variable)}&lt;--</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">newTokens</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">allTokens</span><span class="s2">;</span>

      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">levels</span><span class="s2">[</span><span class="s1">levels</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s5">1</span><span class="s2">] == </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span><span class="s2">) {</span>
      <span class="s6">// close brace after a property block at rule level, e.g. a{--custom:{color:red;}&lt;--</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s1">ruleTokens</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">ruleToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">];</span>

      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">seekingPropertyBlockClosing </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">isVariable</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">propertyToken</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]) {</span>
      <span class="s6">// close brace after an empty variable declaration inside a rule, e.g. a{--color: }&lt;--</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">, </span><span class="s3">' '</span><span class="s2">, [</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s3">' '</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]]);</span>
      <span class="s1">isVariable </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">allTokens</span><span class="s2">;</span>

      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">isVariable </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span><span class="s2">) {</span>
      <span class="s6">// close brace after a rule, e.g. a{color:red;}&lt;--</span>
      <span class="s1">propertyToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">ruleToken </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
      <span class="s1">newTokens </span><span class="s2">= </span><span class="s1">allTokens</span><span class="s2">;</span>

      <span class="s1">level </span><span class="s2">= </span><span class="s1">levels</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">seekingValue </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">isVariable </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isNested</span>
      <span class="s2">&amp;&amp; </span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt;= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s5">1</span><span class="s2">) {</span>
      <span class="s6">// stray close brace at block level, e.g. a{color:red}color:blue}&lt;--</span>
      <span class="s1">externalContext</span><span class="s2">.</span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s3">'Unexpected </span><span class="s0">\'</span><span class="s3">}</span><span class="s0">\' </span><span class="s3">at ' </span><span class="s2">+ </span><span class="s1">formatPosition</span><span class="s2">([</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">]) + </span><span class="s3">'.'</span><span class="s2">);</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_CURLY_BRACKET </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">BLOCK</span><span class="s2">) {</span>
      <span class="s6">// close brace at block level, e.g. @media screen {...}&lt;--</span>
      <span class="s0">break</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">OPEN_ROUND_BRACKET </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span><span class="s2">) {</span>
      <span class="s6">// round open bracket, e.g. a{color:hsla(&lt;--</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">roundBracketLevel</span><span class="s2">++;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_ROUND_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span>
      <span class="s2">&amp;&amp; </span><span class="s1">roundBracketLevel </span><span class="s2">== </span><span class="s5">1</span><span class="s2">) {</span>
      <span class="s6">// round close bracket, e.g. a{color:hsla(0,0%,0%)&lt;--</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>

      <span class="s1">roundBracketLevel</span><span class="s2">--;</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s1">isVariable </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_ROUND_BRACKET </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span><span class="s2">) {</span>
      <span class="s6">// round close bracket within other brackets, e.g. a{width:calc((10rem / 2)&lt;--</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">isVariable </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
      <span class="s1">roundBracketLevel</span><span class="s2">--;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">FORWARD_SLASH</span>
      <span class="s2">&amp;&amp; </span><span class="s1">source</span><span class="s2">[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">] != </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">ASTERISK</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span><span class="s2">) {</span>
      <span class="s6">// forward slash within a property, e.g. a{background:url(image.png) 0 0/&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">character</span><span class="s2">,</span>
        <span class="s2">[[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">]]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">FORWARD_SLASH</span>
      <span class="s2">&amp;&amp; </span><span class="s1">source</span><span class="s2">[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">] != </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">ASTERISK</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span><span class="s2">) {</span>
      <span class="s6">// forward slash within a property after space, e.g. a{background:url(image.png) 0 0 /&lt;--</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">character</span><span class="s2">,</span>
        <span class="s2">[[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">]]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COMMA </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">seekingValue </span><span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span><span class="s2">) {</span>
      <span class="s6">// comma within a property, e.g. a{background:url(image.png),&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">character</span><span class="s2">,</span>
        <span class="s2">[[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">]]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COMMA </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span><span class="s2">) {</span>
      <span class="s6">// comma within a property after space, e.g. a{background:url(image.png) ,&lt;--</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">character</span><span class="s2">,</span>
        <span class="s2">[[</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">]]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_SQUARE_BRACKET</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">1</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span>
      <span class="s2">&amp;&amp; </span><span class="s1">isRepeatToken</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)) {</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">propertyToken</span><span class="s2">[</span><span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s5">1</span><span class="s2">][</span><span class="s5">1</span><span class="s2">] += </span><span class="s1">serializedBuffer</span><span class="s2">;</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">((</span><span class="s1">isSpace </span><span class="s2">|| (</span><span class="s1">isNewLineNix </span><span class="s2">&amp;&amp; !</span><span class="s1">isNewLineWin</span><span class="s2">))</span>
      <span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE</span>
      <span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span>
      <span class="s2">&amp;&amp; </span><span class="s1">propertyToken</span>
      <span class="s2">&amp;&amp; !</span><span class="s1">isBufferEmpty</span><span class="s2">) {</span>
      <span class="s6">// space or *nix newline within property, e.g. a{margin:0 &lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isNewLineWin </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">seekingValue </span><span class="s2">&amp;&amp; </span><span class="s1">propertyToken </span><span class="s2">&amp;&amp; </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">) {</span>
      <span class="s6">// win newline within property, e.g. a{margin:0\r\n&lt;--</span>
      <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>
      <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
        <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
        <span class="s1">serializedBuffer</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
      <span class="s2">]);</span>

      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isNewLineWin </span><span class="s2">&amp;&amp; </span><span class="s1">level </span><span class="s2">== </span><span class="s1">Level</span><span class="s2">.</span><span class="s1">RULE </span><span class="s2">&amp;&amp; </span><span class="s1">seekingValue</span><span class="s2">) {</span>
      <span class="s6">// win newline</span>
      <span class="s1">buffer </span><span class="s2">= [];</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">isNewLineWin </span><span class="s2">&amp;&amp; </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">== </span><span class="s5">1</span><span class="s2">) {</span>
      <span class="s6">// ignore windows newline which is composed of two characters</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s5">0</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s0">else if </span><span class="s2">(!</span><span class="s1">isBufferEmpty </span><span class="s2">|| !</span><span class="s1">isSpace </span><span class="s2">&amp;&amp; !</span><span class="s1">isNewLineNix </span><span class="s2">&amp;&amp; !</span><span class="s1">isNewLineWin </span><span class="s2">&amp;&amp; !</span><span class="s1">isCarriageReturn</span><span class="s2">) {</span>
      <span class="s6">// any character</span>
      <span class="s1">buffer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">character</span><span class="s2">);</span>
      <span class="s1">isBufferEmpty </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s1">wasEscaped </span><span class="s2">= </span><span class="s1">isEscaped</span><span class="s2">;</span>
    <span class="s1">isEscaped </span><span class="s2">= !</span><span class="s1">wasEscaped </span><span class="s2">&amp;&amp; </span><span class="s1">character </span><span class="s2">== </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">BACK_SLASH</span><span class="s2">;</span>
    <span class="s1">wasCommentStart </span><span class="s2">= </span><span class="s1">isCommentStart</span><span class="s2">;</span>
    <span class="s1">wasCommentEnd </span><span class="s2">= </span><span class="s1">isCommentEnd</span><span class="s2">;</span>

    <span class="s1">position</span><span class="s2">.</span><span class="s1">line </span><span class="s2">= (</span><span class="s1">isNewLineWin </span><span class="s2">|| </span><span class="s1">isNewLineNix </span><span class="s2">|| </span><span class="s1">isCarriageReturn</span><span class="s2">) ? </span><span class="s1">position</span><span class="s2">.</span><span class="s1">line </span><span class="s2">+ </span><span class="s5">1 </span><span class="s2">: </span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">;</span>
    <span class="s1">position</span><span class="s2">.</span><span class="s1">column </span><span class="s2">= (</span><span class="s1">isNewLineWin </span><span class="s2">|| </span><span class="s1">isNewLineNix </span><span class="s2">|| </span><span class="s1">isCarriageReturn</span><span class="s2">) ? </span><span class="s5">0 </span><span class="s2">: </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s1">seekingValue</span><span class="s2">) {</span>
    <span class="s1">externalContext</span><span class="s2">.</span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s3">'Missing </span><span class="s0">\'</span><span class="s3">}</span><span class="s0">\' </span><span class="s3">at ' </span><span class="s2">+ </span><span class="s1">formatPosition</span><span class="s2">([</span><span class="s1">position</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">column</span><span class="s2">, </span><span class="s1">position</span><span class="s2">.</span><span class="s1">source</span><span class="s2">]) + </span><span class="s3">'.'</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s1">seekingValue </span><span class="s2">&amp;&amp; </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">) {</span>
    <span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trimRight</span><span class="s2">().</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">TAIL_BROKEN_VALUE_PATTERN</span><span class="s2">, </span><span class="s3">'$1'</span><span class="s2">).</span><span class="s1">trimRight</span><span class="s2">();</span>
    <span class="s1">propertyToken</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span>
      <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">,</span>
      <span class="s1">serializedBuffer</span><span class="s2">,</span>
      <span class="s2">[</span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">serializedBuffer</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">)]</span>
    <span class="s2">]);</span>

    <span class="s1">buffer </span><span class="s2">= [];</span>
  <span class="s2">}</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">) {</span>
    <span class="s1">externalContext</span><span class="s2">.</span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s3">'Invalid character(s) </span><span class="s0">\'</span><span class="s3">' </span><span class="s2">+ </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">) + </span><span class="s3">'</span><span class="s0">\' </span><span class="s3">at ' </span><span class="s2">+ </span><span class="s1">formatPosition</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">) + </span><span class="s3">'. Ignoring.'</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s0">return </span><span class="s1">allTokens</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">isIgnoreStartComment</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">) {</span>
  <span class="s0">return </span><span class="s1">IGNORE_START_COMMENT_PATTERN</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">) + </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">FORWARD_SLASH</span><span class="s2">);</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">isIgnoreEndComment</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">) {</span>
  <span class="s0">return </span><span class="s1">IGNORE_END_COMMENT_PATTERN</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">) + </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">FORWARD_SLASH</span><span class="s2">);</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">originalMetadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">externalContext</span><span class="s2">, </span><span class="s1">selectorFallbacks</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">source </span><span class="s2">= </span><span class="s1">metadata</span><span class="s2">[</span><span class="s5">2</span><span class="s2">];</span>

  <span class="s0">return </span><span class="s1">externalContext</span><span class="s2">.</span><span class="s1">inputSourceMapTracker</span><span class="s2">.</span><span class="s1">isTracking</span><span class="s2">(</span><span class="s1">source</span><span class="s2">)</span>
    <span class="s2">? </span><span class="s1">externalContext</span><span class="s2">.</span><span class="s1">inputSourceMapTracker</span><span class="s2">.</span><span class="s1">originalPositionFor</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">selectorFallbacks</span><span class="s2">)</span>
    <span class="s2">: </span><span class="s1">metadata</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">tokenTypeFrom</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">isAtRule </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">AT </span><span class="s2">|| </span><span class="s1">buffer</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">UNDERSCORE</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">ruleWord </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s1">RULE_WORD_SEPARATOR_PATTERN</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">];</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s1">isAtRule </span><span class="s2">&amp;&amp; </span><span class="s1">BLOCK_RULES</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">ruleWord</span><span class="s2">) &gt; -</span><span class="s5">1</span><span class="s2">) {</span>
    <span class="s0">return </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">NESTED_BLOCK</span><span class="s2">;</span>
  <span class="s2">} </span><span class="s0">if </span><span class="s2">(</span><span class="s1">isAtRule </span><span class="s2">&amp;&amp; </span><span class="s1">AT_RULES</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">ruleWord</span><span class="s2">) &gt; -</span><span class="s5">1</span><span class="s2">) {</span>
    <span class="s0">return </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE</span><span class="s2">;</span>
  <span class="s2">} </span><span class="s0">if </span><span class="s2">(</span><span class="s1">isAtRule</span><span class="s2">) {</span>
    <span class="s0">return </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE_BLOCK</span><span class="s2">;</span>
  <span class="s2">}</span>
  <span class="s0">return </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">RULE</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">tokenScopeFrom</span><span class="s2">(</span><span class="s1">tokenType</span><span class="s2">) {</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">tokenType </span><span class="s2">== </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">RULE</span><span class="s2">) {</span>
    <span class="s0">return </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">RULE_SCOPE</span><span class="s2">;</span>
  <span class="s2">} </span><span class="s0">if </span><span class="s2">(</span><span class="s1">tokenType </span><span class="s2">== </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">NESTED_BLOCK</span><span class="s2">) {</span>
    <span class="s0">return </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">NESTED_BLOCK_SCOPE</span><span class="s2">;</span>
  <span class="s2">} </span><span class="s0">if </span><span class="s2">(</span><span class="s1">tokenType </span><span class="s2">== </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE_BLOCK</span><span class="s2">) {</span>
    <span class="s0">return </span><span class="s1">Token</span><span class="s2">.</span><span class="s1">AT_RULE_BLOCK_SCOPE</span><span class="s2">;</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">isPageMarginBox</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">serializedBuffer </span><span class="s2">= </span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">();</span>

  <span class="s0">return </span><span class="s1">PAGE_MARGIN_BOXES</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">serializedBuffer</span><span class="s2">) &gt; -</span><span class="s5">1 </span><span class="s2">|| </span><span class="s1">EXTRA_PAGE_BOXES</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s1">serializedBuffer</span><span class="s2">) &gt; -</span><span class="s5">1</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">isRepeatToken</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">) {</span>
  <span class="s0">return </span><span class="s1">REPEAT_PATTERN</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">''</span><span class="s2">) + </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">CLOSE_SQUARE_BRACKET</span><span class="s2">);</span>
<span class="s2">}</span>

<span class="s1">module</span><span class="s2">.</span><span class="s1">exports </span><span class="s2">= </span><span class="s1">tokenize</span><span class="s2">;</span>
</pre>
</body>
</html>