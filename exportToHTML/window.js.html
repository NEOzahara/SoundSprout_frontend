<html>
<head>
<title>Window.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Window.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">vm </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;vm&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">webIDLConversions </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;webidl-conversions&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">CSSStyleDeclaration </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;cssstyle&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">Performance</span><span class="s1">: </span><span class="s2">RawPerformance </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;w3c-hr-time&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">notImplemented </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./not-implemented&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">installInterfaces </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/interfaces&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">define</span><span class="s1">, </span><span class="s2">mixin </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../utils&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Element </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/Element&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">EventTarget </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/EventTarget&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">EventHandlerNonNull </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/EventHandlerNonNull&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">OnBeforeUnloadEventHandlerNonNull </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/OnBeforeUnloadEventHandlerNonNull&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">OnErrorEventHandlerNonNull </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/OnErrorEventHandlerNonNull&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">PageTransitionEvent </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/PageTransitionEvent&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">namedPropertiesWindow </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/named-properties-window&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">postMessage </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/post-message&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">DOMException </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;domexception/webidl2js-wrapper&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">btoa</span><span class="s1">, </span><span class="s2">atob </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;abab&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">idlUtils </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/utils&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">WebSocketImpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/websockets/WebSocket-impl&quot;</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">BarProp </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/BarProp&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">documents </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/documents.js&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">External </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/External&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Navigator </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/Navigator&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Performance </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/Performance&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Screen </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/Screen&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Storage </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/Storage&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">Selection </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/Selection&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">reportException </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/helpers/runtime-script-errors&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">getCurrentEventHandlerValue </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/helpers/create-event-accessor.js&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">fireAnEvent </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/helpers/events&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">SessionHistory </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/window/SessionHistory&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">forEachMatchingSheetRuleOfElement</span><span class="s1">, </span><span class="s2">getResolvedValue</span><span class="s1">, </span><span class="s2">propertiesWithResolvedValueImplemented</span><span class="s1">,</span>
  <span class="s2">SHADOW_DOM_PSEUDO_REGEXP </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/helpers/style-rules.js&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">CustomElementRegistry </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/generated/CustomElementRegistry&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">jsGlobals </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./js-globals.json&quot;</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">GlobalEventHandlersImpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/nodes/GlobalEventHandlers-impl&quot;</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">WindowEventHandlersImpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../living/nodes/WindowEventHandlers-impl&quot;</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">;</span>

<span class="s3">const </span><span class="s2">events </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Set</span><span class="s1">([</span>
  <span class="s4">// GlobalEventHandlers</span>
  <span class="s0">&quot;abort&quot;</span><span class="s1">, </span><span class="s0">&quot;autocomplete&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;autocompleteerror&quot;</span><span class="s1">, </span><span class="s0">&quot;blur&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;cancel&quot;</span><span class="s1">, </span><span class="s0">&quot;canplay&quot;</span><span class="s1">, </span><span class="s0">&quot;canplaythrough&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;change&quot;</span><span class="s1">, </span><span class="s0">&quot;click&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;close&quot;</span><span class="s1">, </span><span class="s0">&quot;contextmenu&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;cuechange&quot;</span><span class="s1">, </span><span class="s0">&quot;dblclick&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;drag&quot;</span><span class="s1">, </span><span class="s0">&quot;dragend&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;dragenter&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;dragleave&quot;</span><span class="s1">, </span><span class="s0">&quot;dragover&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;dragstart&quot;</span><span class="s1">, </span><span class="s0">&quot;drop&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;durationchange&quot;</span><span class="s1">, </span><span class="s0">&quot;emptied&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;ended&quot;</span><span class="s1">, </span><span class="s0">&quot;focus&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;input&quot;</span><span class="s1">, </span><span class="s0">&quot;invalid&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;keydown&quot;</span><span class="s1">, </span><span class="s0">&quot;keypress&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;keyup&quot;</span><span class="s1">, </span><span class="s0">&quot;load&quot;</span><span class="s1">, </span><span class="s0">&quot;loadeddata&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;loadedmetadata&quot;</span><span class="s1">, </span><span class="s0">&quot;loadstart&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;mousedown&quot;</span><span class="s1">, </span><span class="s0">&quot;mouseenter&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;mouseleave&quot;</span><span class="s1">, </span><span class="s0">&quot;mousemove&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;mouseout&quot;</span><span class="s1">, </span><span class="s0">&quot;mouseover&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;mouseup&quot;</span><span class="s1">, </span><span class="s0">&quot;wheel&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;pause&quot;</span><span class="s1">, </span><span class="s0">&quot;play&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;playing&quot;</span><span class="s1">, </span><span class="s0">&quot;progress&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;ratechange&quot;</span><span class="s1">, </span><span class="s0">&quot;reset&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;resize&quot;</span><span class="s1">, </span><span class="s0">&quot;scroll&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;securitypolicyviolation&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;seeked&quot;</span><span class="s1">, </span><span class="s0">&quot;seeking&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;select&quot;</span><span class="s1">, </span><span class="s0">&quot;sort&quot;</span><span class="s1">, </span><span class="s0">&quot;stalled&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;submit&quot;</span><span class="s1">, </span><span class="s0">&quot;suspend&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;timeupdate&quot;</span><span class="s1">, </span><span class="s0">&quot;toggle&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;volumechange&quot;</span><span class="s1">, </span><span class="s0">&quot;waiting&quot;</span><span class="s1">,</span>

  <span class="s4">// WindowEventHandlers</span>
  <span class="s0">&quot;afterprint&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;beforeprint&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;hashchange&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;languagechange&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;message&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;messageerror&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;offline&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;online&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;pagehide&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;pageshow&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;popstate&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;rejectionhandled&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;storage&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;unhandledrejection&quot;</span><span class="s1">,</span>
  <span class="s0">&quot;unload&quot;</span>

  <span class="s4">// &quot;error&quot; and &quot;beforeunload&quot; are added separately</span>
<span class="s1">]);</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">createWindow </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
  <span class="s3">return new </span><span class="s2">Window</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">jsGlobalEntriesToInstall </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">entries</span><span class="s1">(</span><span class="s2">jsGlobals</span><span class="s1">).</span><span class="s2">filter</span><span class="s1">(([</span><span class="s2">name</span><span class="s1">]) =&gt; </span><span class="s2">name </span><span class="s3">in </span><span class="s2">global</span><span class="s1">);</span>

<span class="s4">// TODO remove when we drop Node v10 support.</span>
<span class="s3">const </span><span class="s2">anyNodeVersionQueueMicrotask </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">queueMicrotask </span><span class="s1">=== </span><span class="s0">&quot;function&quot; </span><span class="s1">? </span><span class="s2">queueMicrotask </span><span class="s1">: </span><span class="s2">process</span><span class="s1">.</span><span class="s2">nextTick</span><span class="s1">;</span>

<span class="s4">// https://html.spec.whatwg.org/#the-window-object</span>
<span class="s3">function </span><span class="s2">setupWindow</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, { </span><span class="s2">runScripts </span><span class="s1">}) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">runScripts </span><span class="s1">=== </span><span class="s0">&quot;outside-only&quot; </span><span class="s1">|| </span><span class="s2">runScripts </span><span class="s1">=== </span><span class="s0">&quot;dangerously&quot;</span><span class="s1">) {</span>
    <span class="s2">contextifyWindow</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">);</span>

    <span class="s4">// Without this, these globals will only appear to scripts running inside the context using vm.runScript; they will</span>
    <span class="s4">// not appear to scripts running from the outside, including to JSDOM implementation code.</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">[</span><span class="s2">globalName</span><span class="s1">, </span><span class="s2">globalPropDesc</span><span class="s1">] </span><span class="s2">of jsGlobalEntriesToInstall</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">propDesc </span><span class="s1">= { </span><span class="s2">...globalPropDesc</span><span class="s1">, </span><span class="s2">value</span><span class="s1">: </span><span class="s2">vm</span><span class="s1">.</span><span class="s2">runInContext</span><span class="s1">(</span><span class="s2">globalName</span><span class="s1">, </span><span class="s2">windowInstance</span><span class="s1">) };</span>
      <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s2">globalName</span><span class="s1">, </span><span class="s2">propDesc</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s4">// Without contextifying the window, none of the globals will exist. So, let's at least alias them from the Node.js</span>
    <span class="s4">// context. See https://github.com/jsdom/jsdom/issues/2727 for more background and discussion.</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">[</span><span class="s2">globalName</span><span class="s1">, </span><span class="s2">globalPropDesc</span><span class="s1">] </span><span class="s2">of jsGlobalEntriesToInstall</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">propDesc </span><span class="s1">= { </span><span class="s2">...globalPropDesc</span><span class="s1">, </span><span class="s2">value</span><span class="s1">: </span><span class="s2">global</span><span class="s1">[</span><span class="s2">globalName</span><span class="s1">] };</span>
      <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s2">globalName</span><span class="s1">, </span><span class="s2">propDesc</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">installInterfaces</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, [</span><span class="s0">&quot;Window&quot;</span><span class="s1">]);</span>

  <span class="s3">const </span><span class="s2">EventTargetConstructor </span><span class="s1">= </span><span class="s2">windowInstance</span><span class="s1">.</span><span class="s2">EventTarget</span><span class="s1">;</span>

  <span class="s4">// eslint-disable-next-line func-name-matching, func-style, no-shadow</span>
  <span class="s3">const </span><span class="s2">windowConstructor </span><span class="s1">= </span><span class="s3">function </span><span class="s2">Window</span><span class="s1">() {</span>
    <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">&quot;Illegal constructor&quot;</span><span class="s1">);</span>
  <span class="s1">};</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">setPrototypeOf</span><span class="s1">(</span><span class="s2">windowConstructor</span><span class="s1">, </span><span class="s2">EventTargetConstructor</span><span class="s1">);</span>

  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s0">&quot;Window&quot;</span><span class="s1">, {</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">value</span><span class="s1">: </span><span class="s2">windowConstructor</span>
  <span class="s1">});</span>

  <span class="s3">const </span><span class="s2">windowPrototype </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">EventTargetConstructor</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">);</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperties</span><span class="s1">(</span><span class="s2">windowPrototype</span><span class="s1">, {</span>
    <span class="s2">constructor</span><span class="s1">: {</span>
      <span class="s2">value</span><span class="s1">: </span><span class="s2">windowConstructor</span><span class="s1">,</span>
      <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
      <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span>
    <span class="s1">},</span>
    <span class="s1">[</span><span class="s2">Symbol</span><span class="s1">.</span><span class="s2">toStringTag</span><span class="s1">]: {</span>
      <span class="s2">value</span><span class="s1">: </span><span class="s0">&quot;Window&quot;</span><span class="s1">,</span>
      <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span>
    <span class="s1">}</span>
  <span class="s1">});</span>

  <span class="s2">windowConstructor</span><span class="s1">.</span><span class="s2">prototype </span><span class="s1">= </span><span class="s2">windowPrototype</span><span class="s1">;</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">setPrototypeOf</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s2">windowPrototype</span><span class="s1">);</span>

  <span class="s2">EventTarget</span><span class="s1">.</span><span class="s2">setup</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s2">windowInstance</span><span class="s1">);</span>
  <span class="s2">mixin</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s2">WindowEventHandlersImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">);</span>
  <span class="s2">mixin</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s2">GlobalEventHandlersImpl</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">);</span>
  <span class="s2">windowInstance</span><span class="s1">.</span><span class="s2">_initGlobalEvents</span><span class="s1">();</span>

  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s0">&quot;onbeforeunload&quot;</span><span class="s1">, {</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">get</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">tryWrapperForImpl</span><span class="s1">(</span><span class="s2">getCurrentEventHandlerValue</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">&quot;beforeunload&quot;</span><span class="s1">));</span>
    <span class="s1">},</span>
    <span class="s2">set</span><span class="s1">(</span><span class="s2">V</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">V</span><span class="s1">)) {</span>
        <span class="s2">V </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">V </span><span class="s1">= </span><span class="s2">OnBeforeUnloadEventHandlerNonNull</span><span class="s1">.</span><span class="s2">convert</span><span class="s1">(</span><span class="s2">V</span><span class="s1">, {</span>
          <span class="s2">context</span><span class="s1">: </span><span class="s0">&quot;Failed to set the 'onbeforeunload' property on 'Window': The provided value&quot;</span>
        <span class="s1">});</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_setEventHandlerFor</span><span class="s1">(</span><span class="s0">&quot;beforeunload&quot;</span><span class="s1">, </span><span class="s2">V</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>

  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s0">&quot;onerror&quot;</span><span class="s1">, {</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">get</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">tryWrapperForImpl</span><span class="s1">(</span><span class="s2">getCurrentEventHandlerValue</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">&quot;error&quot;</span><span class="s1">));</span>
    <span class="s1">},</span>
    <span class="s2">set</span><span class="s1">(</span><span class="s2">V</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">V</span><span class="s1">)) {</span>
        <span class="s2">V </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">V </span><span class="s1">= </span><span class="s2">OnErrorEventHandlerNonNull</span><span class="s1">.</span><span class="s2">convert</span><span class="s1">(</span><span class="s2">V</span><span class="s1">, {</span>
          <span class="s2">context</span><span class="s1">: </span><span class="s0">&quot;Failed to set the 'onerror' property on 'Window': The provided value&quot;</span>
        <span class="s1">});</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">_setEventHandlerFor</span><span class="s1">(</span><span class="s0">&quot;error&quot;</span><span class="s1">, </span><span class="s2">V</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">event of events</span><span class="s1">) {</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">windowInstance</span><span class="s1">, </span><span class="s0">`on</span><span class="s2">$</span><span class="s1">{</span><span class="s2">event</span><span class="s1">}</span><span class="s0">`</span><span class="s1">, {</span>
      <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
      <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
      <span class="s2">get</span><span class="s1">() {</span>
        <span class="s3">return </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">tryWrapperForImpl</span><span class="s1">(</span><span class="s2">getCurrentEventHandlerValue</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">event</span><span class="s1">));</span>
      <span class="s1">},</span>
      <span class="s2">set</span><span class="s1">(</span><span class="s2">V</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">V</span><span class="s1">)) {</span>
          <span class="s2">V </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">V </span><span class="s1">= </span><span class="s2">EventHandlerNonNull</span><span class="s1">.</span><span class="s2">convert</span><span class="s1">(</span><span class="s2">V</span><span class="s1">, {</span>
            <span class="s2">context</span><span class="s1">: </span><span class="s0">`Failed to set the 'on</span><span class="s2">$</span><span class="s1">{</span><span class="s2">event</span><span class="s1">}</span><span class="s0">' property on 'Window': The provided value`</span>
          <span class="s1">});</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_setEventHandlerFor</span><span class="s1">(</span><span class="s2">event</span><span class="s1">, </span><span class="s2">V</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">windowInstance</span><span class="s1">.</span><span class="s2">_globalObject </span><span class="s1">= </span><span class="s2">windowInstance</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s4">// NOTE: per https://heycam.github.io/webidl/#Global, all properties on the Window object must be own-properties.</span>
<span class="s4">// That is why we assign everything inside of the constructor, instead of using a shared prototype.</span>
<span class="s4">// You can verify this in e.g. Firefox or Internet Explorer, which do a good job with Web IDL compliance.</span>
<span class="s3">function </span><span class="s2">Window</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
  <span class="s2">setupWindow</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, { </span><span class="s2">runScripts</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">runScripts </span><span class="s1">});</span>

  <span class="s3">const </span><span class="s2">rawPerformance </span><span class="s1">= </span><span class="s3">new </span><span class="s2">RawPerformance</span><span class="s1">();</span>
  <span class="s3">const </span><span class="s2">windowInitialized </span><span class="s1">= </span><span class="s2">rawPerformance</span><span class="s1">.</span><span class="s2">now</span><span class="s1">();</span>

  <span class="s3">const </span><span class="s2">window </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>

  <span class="s4">// ### PRIVATE DATA PROPERTIES</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">_resourceLoader </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">resourceLoader</span><span class="s1">;</span>

  <span class="s4">// vm initialization is deferred until script processing is activated</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_globalProxy </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">), </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">wrapperSymbol</span><span class="s1">, { </span><span class="s2">get</span><span class="s1">: () =&gt; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalProxy </span><span class="s1">});</span>

  <span class="s4">// List options explicitly to be clear which are passed through</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_document </span><span class="s1">= </span><span class="s2">documents</span><span class="s1">.</span><span class="s2">createWrapper</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, {</span>
    <span class="s2">parsingMode</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">parsingMode</span><span class="s1">,</span>
    <span class="s2">contentType</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">contentType</span><span class="s1">,</span>
    <span class="s2">encoding</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">,</span>
    <span class="s2">cookieJar</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cookieJar</span><span class="s1">,</span>
    <span class="s2">url</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">url</span><span class="s1">,</span>
    <span class="s2">lastModified</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">lastModified</span><span class="s1">,</span>
    <span class="s2">referrer</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">referrer</span><span class="s1">,</span>
    <span class="s2">parseOptions</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">parseOptions</span><span class="s1">,</span>
    <span class="s2">defaultView</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalProxy</span><span class="s1">,</span>
    <span class="s2">global</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
    <span class="s2">parentOrigin</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">parentOrigin</span>
  <span class="s1">}, { </span><span class="s2">alwaysUseDocumentClass</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">vm</span><span class="s1">.</span><span class="s2">isContext</span><span class="s1">(</span><span class="s2">window</span><span class="s1">)) {</span>
    <span class="s3">const </span><span class="s2">documentImpl </span><span class="s1">= </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s2">window</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">);</span>
    <span class="s2">documentImpl</span><span class="s1">.</span><span class="s2">_defaultView </span><span class="s1">= </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_globalProxy </span><span class="s1">= </span><span class="s2">vm</span><span class="s1">.</span><span class="s2">runInContext</span><span class="s1">(</span><span class="s0">&quot;this&quot;</span><span class="s1">, </span><span class="s2">window</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">documentOrigin </span><span class="s1">= </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">).</span><span class="s2">_origin</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_origin </span><span class="s1">= </span><span class="s2">documentOrigin</span><span class="s1">;</span>

  <span class="s4">// https://html.spec.whatwg.org/#session-history</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_sessionHistory </span><span class="s1">= </span><span class="s3">new </span><span class="s2">SessionHistory</span><span class="s1">({</span>
    <span class="s2">document</span><span class="s1">: </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">),</span>
    <span class="s2">url</span><span class="s1">: </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">).</span><span class="s2">_URL</span><span class="s1">,</span>
    <span class="s2">stateObject</span><span class="s1">: </span><span class="s3">null</span>
  <span class="s1">}, </span><span class="s3">this</span><span class="s1">);</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">_virtualConsole </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">virtualConsole</span><span class="s1">;</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">_runScripts </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">runScripts</span><span class="s1">;</span>

  <span class="s4">// Set up the window as if it's a top level window.</span>
  <span class="s4">// If it's not, then references will be corrected by frame/iframe code.</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_parent </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_top </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalProxy</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_frameElement </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

  <span class="s4">// This implements window.frames.length, since window.frames returns a</span>
  <span class="s4">// self reference to the window object.  This value is incremented in the</span>
  <span class="s4">// HTMLFrameElement implementation.</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_length </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

  <span class="s4">// https://dom.spec.whatwg.org/#window-current-event</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_currentEvent </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">_pretendToBeVisual </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">pretendToBeVisual</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_storageQuota </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">storageQuota</span><span class="s1">;</span>

  <span class="s4">// Some properties (such as localStorage and sessionStorage) share data</span>
  <span class="s4">// between windows in the same origin. This object is intended</span>
  <span class="s4">// to contain such data.</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">commonForOrigin </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">commonForOrigin</span><span class="s1">[</span><span class="s2">documentOrigin</span><span class="s1">]) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_commonForOrigin </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">commonForOrigin</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_commonForOrigin </span><span class="s1">= {</span>
      <span class="s1">[</span><span class="s2">documentOrigin</span><span class="s1">]: {</span>
        <span class="s2">localStorageArea</span><span class="s1">: </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">(),</span>
        <span class="s2">sessionStorageArea</span><span class="s1">: </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">(),</span>
        <span class="s2">windowsInSameOrigin</span><span class="s1">: [</span><span class="s3">this</span><span class="s1">]</span>
      <span class="s1">}</span>
    <span class="s1">};</span>
  <span class="s1">}</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">_currentOriginData </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_commonForOrigin</span><span class="s1">[</span><span class="s2">documentOrigin</span><span class="s1">];</span>

  <span class="s4">// ### WEB STORAGE</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">_localStorage </span><span class="s1">= </span><span class="s2">Storage</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, [], {</span>
    <span class="s2">associatedWindow</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
    <span class="s2">storageArea</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_currentOriginData</span><span class="s1">.</span><span class="s2">localStorageArea</span><span class="s1">,</span>
    <span class="s2">type</span><span class="s1">: </span><span class="s0">&quot;localStorage&quot;</span><span class="s1">,</span>
    <span class="s2">url</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">documentURI</span><span class="s1">,</span>
    <span class="s2">storageQuota</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_storageQuota</span>
  <span class="s1">});</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_sessionStorage </span><span class="s1">= </span><span class="s2">Storage</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, [], {</span>
    <span class="s2">associatedWindow</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
    <span class="s2">storageArea</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_currentOriginData</span><span class="s1">.</span><span class="s2">sessionStorageArea</span><span class="s1">,</span>
    <span class="s2">type</span><span class="s1">: </span><span class="s0">&quot;sessionStorage&quot;</span><span class="s1">,</span>
    <span class="s2">url</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">documentURI</span><span class="s1">,</span>
    <span class="s2">storageQuota</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_storageQuota</span>
  <span class="s1">});</span>

  <span class="s4">// ### SELECTION</span>

  <span class="s4">// https://w3c.github.io/selection-api/#dfn-selection</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">_selection </span><span class="s1">= </span><span class="s2">Selection</span><span class="s1">.</span><span class="s2">createImpl</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>

  <span class="s4">// https://w3c.github.io/selection-api/#dom-window</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">getSelection </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_selection</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s4">// ### GETTERS</span>

  <span class="s3">const </span><span class="s2">locationbar </span><span class="s1">= </span><span class="s2">BarProp</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">menubar </span><span class="s1">= </span><span class="s2">BarProp</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">personalbar </span><span class="s1">= </span><span class="s2">BarProp</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">scrollbars </span><span class="s1">= </span><span class="s2">BarProp</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">statusbar </span><span class="s1">= </span><span class="s2">BarProp</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">toolbar </span><span class="s1">= </span><span class="s2">BarProp</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">external </span><span class="s1">= </span><span class="s2">External</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">navigator </span><span class="s1">= </span><span class="s2">Navigator</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, [], { </span><span class="s2">userAgent</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_resourceLoader</span><span class="s1">.</span><span class="s2">_userAgent </span><span class="s1">});</span>
  <span class="s3">const </span><span class="s2">performance </span><span class="s1">= </span><span class="s2">Performance</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, [], { </span><span class="s2">rawPerformance </span><span class="s1">});</span>
  <span class="s3">const </span><span class="s2">screen </span><span class="s1">= </span><span class="s2">Screen</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">customElementRegistry </span><span class="s1">= </span><span class="s2">CustomElementRegistry</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>

  <span class="s2">define</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, {</span>
    <span class="s2">get length</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_length</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get window</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_globalProxy</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get frameElement</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">wrapperForImpl</span><span class="s1">(</span><span class="s2">window</span><span class="s1">.</span><span class="s2">_frameElement</span><span class="s1">);</span>
    <span class="s1">},</span>
    <span class="s2">get frames</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_globalProxy</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get self</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_globalProxy</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get parent</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_parent</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get top</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_top</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get document</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get external</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">external</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get location</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">wrapperForImpl</span><span class="s1">(</span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s2">window</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">).</span><span class="s2">_location</span><span class="s1">);</span>
    <span class="s1">},</span>
    <span class="s2">get history</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">wrapperForImpl</span><span class="s1">(</span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s2">window</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">).</span><span class="s2">_history</span><span class="s1">);</span>
    <span class="s1">},</span>
    <span class="s2">get navigator</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">navigator</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get locationbar</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">locationbar</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get menubar</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">menubar</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get personalbar</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">personalbar</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get scrollbars</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">scrollbars</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get statusbar</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">statusbar</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get toolbar</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">toolbar</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get performance</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">performance</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get screen</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">screen</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get origin</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_origin</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s4">// The origin IDL attribute is defined with [Replaceable].</span>
    <span class="s2">set origin</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
      <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">&quot;origin&quot;</span><span class="s1">, {</span>
        <span class="s2">value</span><span class="s1">,</span>
        <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span>
      <span class="s1">});</span>
    <span class="s1">},</span>
    <span class="s2">get localStorage</span><span class="s1">() {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">).</span><span class="s2">_origin </span><span class="s1">=== </span><span class="s0">&quot;null&quot;</span><span class="s1">) {</span>
        <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, [</span>
          <span class="s0">&quot;localStorage is not available for opaque origins&quot;</span><span class="s1">,</span>
          <span class="s0">&quot;SecurityError&quot;</span>
        <span class="s1">]);</span>
      <span class="s1">}</span>

      <span class="s3">return this</span><span class="s1">.</span><span class="s2">_localStorage</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get sessionStorage</span><span class="s1">() {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">).</span><span class="s2">_origin </span><span class="s1">=== </span><span class="s0">&quot;null&quot;</span><span class="s1">) {</span>
        <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, [</span>
          <span class="s0">&quot;sessionStorage is not available for opaque origins&quot;</span><span class="s1">,</span>
          <span class="s0">&quot;SecurityError&quot;</span>
        <span class="s1">]);</span>
      <span class="s1">}</span>

      <span class="s3">return this</span><span class="s1">.</span><span class="s2">_sessionStorage</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get customElements</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">customElementRegistry</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">get event</span><span class="s1">() {</span>
      <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_currentEvent </span><span class="s1">? </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">wrapperForImpl</span><span class="s1">(</span><span class="s2">window</span><span class="s1">.</span><span class="s2">_currentEvent</span><span class="s1">) : </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s2">set event</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
      <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, </span><span class="s0">&quot;event&quot;</span><span class="s1">, { </span><span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">, </span><span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">, </span><span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">, </span><span class="s2">value </span><span class="s1">});</span>
    <span class="s1">}</span>
  <span class="s1">});</span>

  <span class="s2">namedPropertiesWindow</span><span class="s1">.</span><span class="s2">initializeWindow</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_globalProxy</span><span class="s1">);</span>

  <span class="s4">// ### METHODS</span>

  <span class="s4">// https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers</span>

  <span class="s4">// In the spec the list of active timers is a set of IDs. We make it a map of IDs to Node.js timer objects, so that</span>
  <span class="s4">// we can call Node.js-side clearTimeout() when clearing, and thus allow process shutdown faster.</span>
  <span class="s3">const </span><span class="s2">listOfActiveTimers </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">();</span>
  <span class="s3">let </span><span class="s2">latestTimerId </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">setTimeout </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">timeout </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s2">...args</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">handler </span><span class="s1">!== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
      <span class="s2">handler </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">DOMString</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">timeout </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">long</span><span class="s1">(</span><span class="s2">timeout</span><span class="s1">);</span>

    <span class="s3">return </span><span class="s2">timerInitializationSteps</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">timeout</span><span class="s1">, </span><span class="s2">args</span><span class="s1">, { </span><span class="s2">methodContext</span><span class="s1">: </span><span class="s2">window</span><span class="s1">, </span><span class="s2">repeat</span><span class="s1">: </span><span class="s3">false </span><span class="s1">});</span>
  <span class="s1">};</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">setInterval </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">timeout </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s2">...args</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">handler </span><span class="s1">!== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
      <span class="s2">handler </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">DOMString</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">timeout </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">long</span><span class="s1">(</span><span class="s2">timeout</span><span class="s1">);</span>

    <span class="s3">return </span><span class="s2">timerInitializationSteps</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">timeout</span><span class="s1">, </span><span class="s2">args</span><span class="s1">, { </span><span class="s2">methodContext</span><span class="s1">: </span><span class="s2">window</span><span class="s1">, </span><span class="s2">repeat</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>
  <span class="s1">};</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">clearTimeout </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">handle </span><span class="s1">= </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s2">handle </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">long</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>

    <span class="s3">const </span><span class="s2">nodejsTimer </span><span class="s1">= </span><span class="s2">listOfActiveTimers</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">nodejsTimer</span><span class="s1">) {</span>
      <span class="s2">clearTimeout</span><span class="s1">(</span><span class="s2">nodejsTimer</span><span class="s1">);</span>
      <span class="s2">listOfActiveTimers</span><span class="s1">.</span><span class="s2">delete</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">};</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">clearInterval </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">handle </span><span class="s1">= </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s2">handle </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">long</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>

    <span class="s3">const </span><span class="s2">nodejsTimer </span><span class="s1">= </span><span class="s2">listOfActiveTimers</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">nodejsTimer</span><span class="s1">) {</span>
      <span class="s4">// We use setTimeout() in timerInitializationSteps even for this.setInterval().</span>
      <span class="s2">clearTimeout</span><span class="s1">(</span><span class="s2">nodejsTimer</span><span class="s1">);</span>
      <span class="s2">listOfActiveTimers</span><span class="s1">.</span><span class="s2">delete</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">};</span>

  <span class="s3">function </span><span class="s2">timerInitializationSteps</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">timeout</span><span class="s1">, </span><span class="s2">args</span><span class="s1">, { </span><span class="s2">methodContext</span><span class="s1">, </span><span class="s2">repeat</span><span class="s1">, </span><span class="s2">previousHandle </span><span class="s1">}) {</span>
    <span class="s4">// This appears to be unspecced, but matches browser behavior for close()ed windows.</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">methodContext</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s5">0</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s4">// TODO: implement timer nesting level behavior.</span>

    <span class="s3">const </span><span class="s2">methodContextProxy </span><span class="s1">= </span><span class="s2">methodContext</span><span class="s1">.</span><span class="s2">_globalProxy</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">handle </span><span class="s1">= </span><span class="s2">previousHandle </span><span class="s1">!== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s2">previousHandle </span><span class="s1">: ++</span><span class="s2">latestTimerId</span><span class="s1">;</span>

    <span class="s3">function </span><span class="s2">task</span><span class="s1">() {</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">listOfActiveTimers</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">)) {</span>
        <span class="s3">return</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">try </span><span class="s1">{</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">handler </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
          <span class="s2">handler</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s2">methodContextProxy</span><span class="s1">, </span><span class="s2">args</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">window</span><span class="s1">.</span><span class="s2">_runScripts </span><span class="s1">=== </span><span class="s0">&quot;dangerously&quot;</span><span class="s1">) {</span>
          <span class="s2">vm</span><span class="s1">.</span><span class="s2">runInContext</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">window</span><span class="s1">, { </span><span class="s2">filename</span><span class="s1">: </span><span class="s2">window</span><span class="s1">.</span><span class="s2">location</span><span class="s1">.</span><span class="s2">href</span><span class="s1">, </span><span class="s2">displayErrors</span><span class="s1">: </span><span class="s3">false </span><span class="s1">});</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
        <span class="s2">reportException</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, </span><span class="s2">e</span><span class="s1">, </span><span class="s2">window</span><span class="s1">.</span><span class="s2">location</span><span class="s1">.</span><span class="s2">href</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">listOfActiveTimers</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">)) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">repeat</span><span class="s1">) {</span>
          <span class="s2">timerInitializationSteps</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">timeout</span><span class="s1">, </span><span class="s2">args</span><span class="s1">, { </span><span class="s2">methodContext</span><span class="s1">, </span><span class="s2">repeat</span><span class="s1">: </span><span class="s3">true</span><span class="s1">, </span><span class="s2">previousHandle</span><span class="s1">: </span><span class="s2">handle </span><span class="s1">});</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">listOfActiveTimers</span><span class="s1">.</span><span class="s2">delete</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">timeout </span><span class="s1">&lt; </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s2">timeout </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">nodejsTimer </span><span class="s1">= </span><span class="s2">setTimeout</span><span class="s1">(</span><span class="s2">task</span><span class="s1">, </span><span class="s2">timeout</span><span class="s1">);</span>
    <span class="s2">listOfActiveTimers</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">, </span><span class="s2">nodejsTimer</span><span class="s1">);</span>

    <span class="s3">return </span><span class="s2">handle</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">// https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#microtask-queuing</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">queueMicrotask </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">callback</span><span class="s1">) {</span>
    <span class="s2">callback </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">Function</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>

    <span class="s2">anyNodeVersionQueueMicrotask</span><span class="s1">(() =&gt; {</span>
      <span class="s3">try </span><span class="s1">{</span>
        <span class="s2">callback</span><span class="s1">();</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
        <span class="s2">reportException</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, </span><span class="s2">e</span><span class="s1">, </span><span class="s2">window</span><span class="s1">.</span><span class="s2">location</span><span class="s1">.</span><span class="s2">href</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">};</span>

  <span class="s4">// https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#animation-frames</span>

  <span class="s3">let </span><span class="s2">animationFrameCallbackId </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">mapOfAnimationFrameCallbacks </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">();</span>
  <span class="s3">let </span><span class="s2">animationFrameNodejsInterval </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

  <span class="s4">// Unlike the spec, where an animation frame happens every 60 Hz regardless, we optimize so that if there are no</span>
  <span class="s4">// requestAnimationFrame() calls outstanding, we don't fire the timer. This helps us track that.</span>
  <span class="s3">let </span><span class="s2">numberOfOngoingAnimationFrameCallbacks </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_pretendToBeVisual</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">requestAnimationFrame </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">callback</span><span class="s1">) {</span>
      <span class="s2">callback </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">Function</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>

      <span class="s3">const </span><span class="s2">handle </span><span class="s1">= ++</span><span class="s2">animationFrameCallbackId</span><span class="s1">;</span>
      <span class="s2">mapOfAnimationFrameCallbacks</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">);</span>

      <span class="s1">++</span><span class="s2">numberOfOngoingAnimationFrameCallbacks</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">numberOfOngoingAnimationFrameCallbacks </span><span class="s1">=== </span><span class="s5">1</span><span class="s1">) {</span>
        <span class="s2">animationFrameNodejsInterval </span><span class="s1">= </span><span class="s2">setInterval</span><span class="s1">(() =&gt; {</span>
          <span class="s2">runAnimationFrameCallbacks</span><span class="s1">(</span><span class="s2">rawPerformance</span><span class="s1">.</span><span class="s2">now</span><span class="s1">() - </span><span class="s2">windowInitialized</span><span class="s1">);</span>
        <span class="s1">}, </span><span class="s5">1000 </span><span class="s1">/ </span><span class="s5">60</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">return </span><span class="s2">handle</span><span class="s1">;</span>
    <span class="s1">};</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">cancelAnimationFrame </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">handle</span><span class="s1">) {</span>
      <span class="s2">handle </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">[</span><span class="s0">&quot;unsigned long&quot;</span><span class="s1">](</span><span class="s2">handle</span><span class="s1">);</span>

      <span class="s2">removeAnimationFrameCallback</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>
    <span class="s1">};</span>

    <span class="s3">function </span><span class="s2">runAnimationFrameCallbacks</span><span class="s1">(</span><span class="s2">now</span><span class="s1">) {</span>
      <span class="s4">// Converting to an array is important to get a sync snapshot and thus match spec semantics.</span>
      <span class="s3">const </span><span class="s2">callbackHandles </span><span class="s1">= [</span><span class="s2">...mapOfAnimationFrameCallbacks</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">()];</span>
      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">handle of callbackHandles</span><span class="s1">) {</span>
        <span class="s4">// This has() can be false if a callback calls cancelAnimationFrame().</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">mapOfAnimationFrameCallbacks</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">)) {</span>
          <span class="s3">const </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">mapOfAnimationFrameCallbacks</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>
          <span class="s2">removeAnimationFrameCallback</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>
          <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">callback</span><span class="s1">(</span><span class="s2">now</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
            <span class="s2">reportException</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, </span><span class="s2">e</span><span class="s1">, </span><span class="s2">window</span><span class="s1">.</span><span class="s2">location</span><span class="s1">.</span><span class="s2">href</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">function </span><span class="s2">removeAnimationFrameCallback</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">mapOfAnimationFrameCallbacks</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">)) {</span>
        <span class="s1">--</span><span class="s2">numberOfOngoingAnimationFrameCallbacks</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">numberOfOngoingAnimationFrameCallbacks </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
          <span class="s2">clearInterval</span><span class="s1">(</span><span class="s2">animationFrameNodejsInterval</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s2">mapOfAnimationFrameCallbacks</span><span class="s1">.</span><span class="s2">delete</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">function </span><span class="s2">stopAllTimers</span><span class="s1">() {</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">nodejsTimer of listOfActiveTimers</span><span class="s1">.</span><span class="s2">values</span><span class="s1">()) {</span>
      <span class="s2">clearTimeout</span><span class="s1">(</span><span class="s2">nodejsTimer</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">listOfActiveTimers</span><span class="s1">.</span><span class="s2">clear</span><span class="s1">();</span>

    <span class="s2">clearInterval</span><span class="s1">(</span><span class="s2">animationFrameNodejsInterval</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">function </span><span class="s2">Option</span><span class="s1">(</span><span class="s2">text</span><span class="s1">, </span><span class="s2">value</span><span class="s1">, </span><span class="s2">defaultSelected</span><span class="s1">, </span><span class="s2">selected</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">text </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s2">text </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">text </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">DOMString</span><span class="s1">(</span><span class="s2">text</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">value </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s2">value </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">DOMString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">defaultSelected </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">boolean</span><span class="s1">(</span><span class="s2">defaultSelected</span><span class="s1">);</span>
    <span class="s2">selected </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">boolean</span><span class="s1">(</span><span class="s2">selected</span><span class="s1">);</span>

    <span class="s3">const </span><span class="s2">option </span><span class="s1">= </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">createElement</span><span class="s1">(</span><span class="s0">&quot;option&quot;</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">impl </span><span class="s1">= </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s2">option</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">text </span><span class="s1">!== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
      <span class="s2">impl</span><span class="s1">.</span><span class="s2">text </span><span class="s1">= </span><span class="s2">text</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">value </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s2">impl</span><span class="s1">.</span><span class="s2">setAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;value&quot;</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">defaultSelected</span><span class="s1">) {</span>
      <span class="s2">impl</span><span class="s1">.</span><span class="s2">setAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;selected&quot;</span><span class="s1">, </span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">impl</span><span class="s1">.</span><span class="s2">_selectedness </span><span class="s1">= </span><span class="s2">selected</span><span class="s1">;</span>

    <span class="s3">return </span><span class="s2">option</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">Option</span><span class="s1">, </span><span class="s0">&quot;prototype&quot;</span><span class="s1">, {</span>
    <span class="s2">value</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">HTMLOptionElement</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">,</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">writable</span><span class="s1">: </span><span class="s3">false</span>
  <span class="s1">});</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, </span><span class="s0">&quot;Option&quot;</span><span class="s1">, {</span>
    <span class="s2">value</span><span class="s1">: </span><span class="s2">Option</span><span class="s1">,</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span>
  <span class="s1">});</span>

  <span class="s3">function </span><span class="s2">Image</span><span class="s1">(</span><span class="s2">...args</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">img </span><span class="s1">= </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">createElement</span><span class="s1">(</span><span class="s0">&quot;img&quot;</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">impl </span><span class="s1">= </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s2">img</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">args</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s2">impl</span><span class="s1">.</span><span class="s2">setAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;width&quot;</span><span class="s1">, </span><span class="s2">String</span><span class="s1">(</span><span class="s2">args</span><span class="s1">[</span><span class="s5">0</span><span class="s1">]));</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">args</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s2">impl</span><span class="s1">.</span><span class="s2">setAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;height&quot;</span><span class="s1">, </span><span class="s2">String</span><span class="s1">(</span><span class="s2">args</span><span class="s1">[</span><span class="s5">1</span><span class="s1">]));</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">img</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">Image</span><span class="s1">, </span><span class="s0">&quot;prototype&quot;</span><span class="s1">, {</span>
    <span class="s2">value</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">HTMLImageElement</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">,</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">writable</span><span class="s1">: </span><span class="s3">false</span>
  <span class="s1">});</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, </span><span class="s0">&quot;Image&quot;</span><span class="s1">, {</span>
    <span class="s2">value</span><span class="s1">: </span><span class="s2">Image</span><span class="s1">,</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span>
  <span class="s1">});</span>

  <span class="s3">function </span><span class="s2">Audio</span><span class="s1">(</span><span class="s2">src</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">audio </span><span class="s1">= </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">createElement</span><span class="s1">(</span><span class="s0">&quot;audio&quot;</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">impl </span><span class="s1">= </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s2">audio</span><span class="s1">);</span>
    <span class="s2">impl</span><span class="s1">.</span><span class="s2">setAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;preload&quot;</span><span class="s1">, </span><span class="s0">&quot;auto&quot;</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">src </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s2">impl</span><span class="s1">.</span><span class="s2">setAttributeNS</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s0">&quot;src&quot;</span><span class="s1">, </span><span class="s2">String</span><span class="s1">(</span><span class="s2">src</span><span class="s1">));</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">audio</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">Audio</span><span class="s1">, </span><span class="s0">&quot;prototype&quot;</span><span class="s1">, {</span>
    <span class="s2">value</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">HTMLAudioElement</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">,</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">writable</span><span class="s1">: </span><span class="s3">false</span>
  <span class="s1">});</span>
  <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, </span><span class="s0">&quot;Audio&quot;</span><span class="s1">, {</span>
    <span class="s2">value</span><span class="s1">: </span><span class="s2">Audio</span><span class="s1">,</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span>
  <span class="s1">});</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">postMessage </span><span class="s1">= </span><span class="s2">postMessage</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">atob </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">str</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">result </span><span class="s1">= </span><span class="s2">atob</span><span class="s1">(</span><span class="s2">str</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">result </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, [</span>
        <span class="s0">&quot;The string to be decoded contains invalid characters.&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;InvalidCharacterError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>
    <span class="s3">return </span><span class="s2">result</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">btoa </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">str</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">result </span><span class="s1">= </span><span class="s2">btoa</span><span class="s1">(</span><span class="s2">str</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">result </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
      <span class="s3">throw </span><span class="s2">DOMException</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">window</span><span class="s1">, [</span>
        <span class="s0">&quot;The string to be encoded contains invalid characters.&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;InvalidCharacterError&quot;</span>
      <span class="s1">]);</span>
    <span class="s1">}</span>
    <span class="s3">return </span><span class="s2">result</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">stop </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s2">manager </span><span class="s1">= </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">).</span><span class="s2">_requestManager</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">manager</span><span class="s1">) {</span>
      <span class="s2">manager</span><span class="s1">.</span><span class="s2">close</span><span class="s1">();</span>
    <span class="s1">}</span>
  <span class="s1">};</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">close </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s4">// Recursively close child frame windows, then ourselves (depth-first).</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">close</span><span class="s1">();</span>
    <span class="s1">}</span>

    <span class="s4">// Clear out all listeners. Any in-flight or upcoming events should not get delivered.</span>
    <span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">).</span><span class="s2">_eventListeners </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">body</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">body</span><span class="s1">.</span><span class="s2">innerHTML </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">close</span><span class="s1">) {</span>
        <span class="s4">// It's especially important to clear out the listeners here because document.close() causes a &quot;load&quot; event to</span>
        <span class="s4">// fire.</span>
        <span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">).</span><span class="s2">_eventListeners </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">close</span><span class="s1">();</span>
      <span class="s1">}</span>
      <span class="s3">const </span><span class="s2">doc </span><span class="s1">= </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">_requestManager</span><span class="s1">) {</span>
        <span class="s2">doc</span><span class="s1">.</span><span class="s2">_requestManager</span><span class="s1">.</span><span class="s2">close</span><span class="s1">();</span>
      <span class="s1">}</span>
      <span class="s3">delete this</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">stopAllTimers</span><span class="s1">();</span>
    <span class="s2">WebSocketImpl</span><span class="s1">.</span><span class="s2">cleanUpWindow</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
  <span class="s1">};</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">getComputedStyle </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">elt</span><span class="s1">, </span><span class="s2">pseudoElt </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">) {</span>
    <span class="s2">elt </span><span class="s1">= </span><span class="s2">Element</span><span class="s1">.</span><span class="s2">convert</span><span class="s1">(</span><span class="s2">elt</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">pseudoElt </span><span class="s1">!== </span><span class="s2">undefined </span><span class="s1">&amp;&amp; </span><span class="s2">pseudoElt </span><span class="s1">!== </span><span class="s3">null</span><span class="s1">) {</span>
      <span class="s2">pseudoElt </span><span class="s1">= </span><span class="s2">webIDLConversions</span><span class="s1">.</span><span class="s2">DOMString</span><span class="s1">(</span><span class="s2">pseudoElt</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">pseudoElt </span><span class="s1">!== </span><span class="s2">undefined </span><span class="s1">&amp;&amp; </span><span class="s2">pseudoElt </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">pseudoElt </span><span class="s1">!== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
      <span class="s4">// TODO: Parse pseudoElt</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">SHADOW_DOM_PSEUDO_REGEXP</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">pseudoElt</span><span class="s1">)) {</span>
        <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">&quot;Tried to get the computed style of a Shadow DOM pseudo-element.&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">notImplemented</span><span class="s1">(</span><span class="s0">&quot;window.computedStyle(elt, pseudoElt)&quot;</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">declaration </span><span class="s1">= </span><span class="s3">new </span><span class="s2">CSSStyleDeclaration</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">forEach </span><span class="s1">} = </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">style </span><span class="s1">} = </span><span class="s2">elt</span><span class="s1">;</span>

    <span class="s2">forEachMatchingSheetRuleOfElement</span><span class="s1">(</span><span class="s2">elt</span><span class="s1">, </span><span class="s2">rule </span><span class="s1">=&gt; {</span>
      <span class="s2">forEach</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">rule</span><span class="s1">.</span><span class="s2">style</span><span class="s1">, </span><span class="s2">property </span><span class="s1">=&gt; {</span>
        <span class="s2">declaration</span><span class="s1">.</span><span class="s2">setProperty</span><span class="s1">(</span>
          <span class="s2">property</span><span class="s1">,</span>
          <span class="s2">rule</span><span class="s1">.</span><span class="s2">style</span><span class="s1">.</span><span class="s2">getPropertyValue</span><span class="s1">(</span><span class="s2">property</span><span class="s1">),</span>
          <span class="s2">rule</span><span class="s1">.</span><span class="s2">style</span><span class="s1">.</span><span class="s2">getPropertyPriority</span><span class="s1">(</span><span class="s2">property</span><span class="s1">)</span>
        <span class="s1">);</span>
      <span class="s1">});</span>
    <span class="s1">});</span>

    <span class="s4">// https://drafts.csswg.org/cssom/#dom-window-getcomputedstyle</span>
    <span class="s3">const </span><span class="s2">declarations </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">propertiesWithResolvedValueImplemented</span><span class="s1">);</span>
    <span class="s2">forEach</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">declarations</span><span class="s1">, </span><span class="s2">property </span><span class="s1">=&gt; {</span>
      <span class="s2">declaration</span><span class="s1">.</span><span class="s2">setProperty</span><span class="s1">(</span><span class="s2">property</span><span class="s1">, </span><span class="s2">getResolvedValue</span><span class="s1">(</span><span class="s2">elt</span><span class="s1">, </span><span class="s2">property</span><span class="s1">));</span>
    <span class="s1">});</span>

    <span class="s2">forEach</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">style</span><span class="s1">, </span><span class="s2">property </span><span class="s1">=&gt; {</span>
      <span class="s2">declaration</span><span class="s1">.</span><span class="s2">setProperty</span><span class="s1">(</span><span class="s2">property</span><span class="s1">, </span><span class="s2">style</span><span class="s1">.</span><span class="s2">getPropertyValue</span><span class="s1">(</span><span class="s2">property</span><span class="s1">), </span><span class="s2">style</span><span class="s1">.</span><span class="s2">getPropertyPriority</span><span class="s1">(</span><span class="s2">property</span><span class="s1">));</span>
    <span class="s1">});</span>

    <span class="s3">return </span><span class="s2">declaration</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">getSelection </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">window</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">.</span><span class="s2">getSelection</span><span class="s1">();</span>
  <span class="s1">};</span>

  <span class="s4">// The captureEvents() and releaseEvents() methods must do nothing</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s2">captureEvents </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {};</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">releaseEvents </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {};</span>

  <span class="s4">// ### PUBLIC DATA PROPERTIES (TODO: should be getters)</span>

  <span class="s3">function </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s2">method</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">(</span><span class="s2">...args</span><span class="s1">) =&gt; {</span>
      <span class="s2">window</span><span class="s1">.</span><span class="s2">_virtualConsole</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s2">method</span><span class="s1">, </span><span class="s2">...args</span><span class="s1">);</span>
    <span class="s1">};</span>
  <span class="s1">}</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s2">console </span><span class="s1">= {</span>
    <span class="s2">assert</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;assert&quot;</span><span class="s1">),</span>
    <span class="s2">clear</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;clear&quot;</span><span class="s1">),</span>
    <span class="s2">count</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;count&quot;</span><span class="s1">),</span>
    <span class="s2">countReset</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;countReset&quot;</span><span class="s1">),</span>
    <span class="s2">debug</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;debug&quot;</span><span class="s1">),</span>
    <span class="s2">dir</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;dir&quot;</span><span class="s1">),</span>
    <span class="s2">dirxml</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;dirxml&quot;</span><span class="s1">),</span>
    <span class="s2">error</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;error&quot;</span><span class="s1">),</span>
    <span class="s2">group</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;group&quot;</span><span class="s1">),</span>
    <span class="s2">groupCollapsed</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;groupCollapsed&quot;</span><span class="s1">),</span>
    <span class="s2">groupEnd</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;groupEnd&quot;</span><span class="s1">),</span>
    <span class="s2">info</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;info&quot;</span><span class="s1">),</span>
    <span class="s2">log</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;log&quot;</span><span class="s1">),</span>
    <span class="s2">table</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;table&quot;</span><span class="s1">),</span>
    <span class="s2">time</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;time&quot;</span><span class="s1">),</span>
    <span class="s2">timeLog</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;timeLog&quot;</span><span class="s1">),</span>
    <span class="s2">timeEnd</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;timeEnd&quot;</span><span class="s1">),</span>
    <span class="s2">trace</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;trace&quot;</span><span class="s1">),</span>
    <span class="s2">warn</span><span class="s1">: </span><span class="s2">wrapConsoleMethod</span><span class="s1">(</span><span class="s0">&quot;warn&quot;</span><span class="s1">)</span>
  <span class="s1">};</span>

  <span class="s3">function </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s2">name</span><span class="s1">) {</span>
    <span class="s3">return function </span><span class="s1">() {</span>
      <span class="s2">notImplemented</span><span class="s1">(</span><span class="s2">name</span><span class="s1">, </span><span class="s2">window</span><span class="s1">);</span>
    <span class="s1">};</span>
  <span class="s1">}</span>

  <span class="s2">define</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, {</span>
    <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">,</span>
    <span class="s2">status</span><span class="s1">: </span><span class="s0">&quot;&quot;</span><span class="s1">,</span>
    <span class="s2">devicePixelRatio</span><span class="s1">: </span><span class="s5">1</span><span class="s1">,</span>
    <span class="s2">innerWidth</span><span class="s1">: </span><span class="s5">1024</span><span class="s1">,</span>
    <span class="s2">innerHeight</span><span class="s1">: </span><span class="s5">768</span><span class="s1">,</span>
    <span class="s2">outerWidth</span><span class="s1">: </span><span class="s5">1024</span><span class="s1">,</span>
    <span class="s2">outerHeight</span><span class="s1">: </span><span class="s5">768</span><span class="s1">,</span>
    <span class="s2">pageXOffset</span><span class="s1">: </span><span class="s5">0</span><span class="s1">,</span>
    <span class="s2">pageYOffset</span><span class="s1">: </span><span class="s5">0</span><span class="s1">,</span>
    <span class="s2">screenX</span><span class="s1">: </span><span class="s5">0</span><span class="s1">,</span>
    <span class="s2">screenLeft</span><span class="s1">: </span><span class="s5">0</span><span class="s1">,</span>
    <span class="s2">screenY</span><span class="s1">: </span><span class="s5">0</span><span class="s1">,</span>
    <span class="s2">screenTop</span><span class="s1">: </span><span class="s5">0</span><span class="s1">,</span>
    <span class="s2">scrollX</span><span class="s1">: </span><span class="s5">0</span><span class="s1">,</span>
    <span class="s2">scrollY</span><span class="s1">: </span><span class="s5">0</span><span class="s1">,</span>

    <span class="s2">alert</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.alert&quot;</span><span class="s1">),</span>
    <span class="s2">blur</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.blur&quot;</span><span class="s1">),</span>
    <span class="s2">confirm</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.confirm&quot;</span><span class="s1">),</span>
    <span class="s2">focus</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.focus&quot;</span><span class="s1">),</span>
    <span class="s2">moveBy</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.moveBy&quot;</span><span class="s1">),</span>
    <span class="s2">moveTo</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.moveTo&quot;</span><span class="s1">),</span>
    <span class="s2">open</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.open&quot;</span><span class="s1">),</span>
    <span class="s2">print</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.print&quot;</span><span class="s1">),</span>
    <span class="s2">prompt</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.prompt&quot;</span><span class="s1">),</span>
    <span class="s2">resizeBy</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.resizeBy&quot;</span><span class="s1">),</span>
    <span class="s2">resizeTo</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.resizeTo&quot;</span><span class="s1">),</span>
    <span class="s2">scroll</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.scroll&quot;</span><span class="s1">),</span>
    <span class="s2">scrollBy</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.scrollBy&quot;</span><span class="s1">),</span>
    <span class="s2">scrollTo</span><span class="s1">: </span><span class="s2">notImplementedMethod</span><span class="s1">(</span><span class="s0">&quot;window.scrollTo&quot;</span><span class="s1">)</span>
  <span class="s1">});</span>

  <span class="s4">// ### INITIALIZATION</span>

  <span class="s2">process</span><span class="s1">.</span><span class="s2">nextTick</span><span class="s1">(() =&gt; {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">window</span><span class="s1">.</span><span class="s2">document</span><span class="s1">) {</span>
      <span class="s3">return</span><span class="s1">; </span><span class="s4">// window might've been closed already</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">documentImpl </span><span class="s1">= </span><span class="s2">idlUtils</span><span class="s1">.</span><span class="s2">implForWrapper</span><span class="s1">(</span><span class="s2">window</span><span class="s1">.</span><span class="s2">_document</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">window</span><span class="s1">.</span><span class="s2">document</span><span class="s1">.</span><span class="s2">readyState </span><span class="s1">=== </span><span class="s0">&quot;complete&quot;</span><span class="s1">) {</span>
      <span class="s2">fireAnEvent</span><span class="s1">(</span><span class="s0">&quot;load&quot;</span><span class="s1">, </span><span class="s2">window</span><span class="s1">, </span><span class="s2">undefined</span><span class="s1">, {}, </span><span class="s2">documentImpl</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">window</span><span class="s1">.</span><span class="s2">document</span><span class="s1">.</span><span class="s2">addEventListener</span><span class="s1">(</span><span class="s0">&quot;load&quot;</span><span class="s1">, () =&gt; {</span>
        <span class="s2">fireAnEvent</span><span class="s1">(</span><span class="s0">&quot;load&quot;</span><span class="s1">, </span><span class="s2">window</span><span class="s1">, </span><span class="s2">undefined</span><span class="s1">, {}, </span><span class="s2">documentImpl</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(!</span><span class="s2">documentImpl</span><span class="s1">.</span><span class="s2">_pageShowingFlag</span><span class="s1">) {</span>
          <span class="s2">documentImpl</span><span class="s1">.</span><span class="s2">_pageShowingFlag </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
          <span class="s2">fireAnEvent</span><span class="s1">(</span><span class="s0">&quot;pageshow&quot;</span><span class="s1">, </span><span class="s2">window</span><span class="s1">, </span><span class="s2">PageTransitionEvent</span><span class="s1">, { </span><span class="s2">persisted</span><span class="s1">: </span><span class="s3">false </span><span class="s1">}, </span><span class="s2">documentImpl</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">});</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">contextifyWindow</span><span class="s1">(</span><span class="s2">window</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">vm</span><span class="s1">.</span><span class="s2">isContext</span><span class="s1">(</span><span class="s2">window</span><span class="s1">)) {</span>
    <span class="s3">return</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">vm</span><span class="s1">.</span><span class="s2">createContext</span><span class="s1">(</span><span class="s2">window</span><span class="s1">);</span>
<span class="s1">}</span>
</pre>
</body>
</html>